"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[71],{71:function(t,e,o){o.d(e,{Od:function(){return A},Mo:function(){return C},E_:function(){return N},zn:function(){return w}});var n=o(2265),i=o(1562),a=o(6541),r=o(4337);class s{async connect(){var t;if((null===(t=this.socket)||void 0===t||!t.connected)&&!this.isConnecting){this.isConnecting=!0;try{let t=a.O.getToken();if(!t){console.warn("No auth token available for socket connection"),this.isConnecting=!1;return}this.socket=(0,r.io)("http://localhost:3001/api",{auth:{token:t},transports:["websocket","polling"],timeout:2e4,reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:this.reconnectDelay}),this.setupEventListeners()}catch(t){console.error("Socket connection failed:",t),this.isConnecting=!1}}}setupEventListeners(){this.socket&&(this.socket.on("connect",()=>{var t;console.log("Socket connected:",null===(t=this.socket)||void 0===t?void 0:t.id),this.isConnecting=!1,this.reconnectAttempts=0,this.joinUserRoom().catch(t=>{console.error("Failed to join user room:",t)})}),this.socket.on("connect_error",t=>{console.error("Socket connection error:",t),this.isConnecting=!1,this.handleReconnect()}),this.socket.on("disconnect",t=>{console.log("Socket disconnected:",t),this.isConnecting=!1,"io server disconnect"===t&&this.handleReconnect()}),this.socket.on(i.CF.NOTIFICATION,t=>{var e;console.log("Received notification:",t),this.handleNotification(t),null===(e=this.socket)||void 0===e||e.emit(i.CF.NOTIFICATION_DELIVERED,{notificationId:t.id})}),this.socket.on(i.CF.PET_STATUS_UPDATE,t=>{console.log("Pet status update:",t),this.emit("petStatusUpdate",t)}),this.socket.on(i.CF.PET_MATCH_FOUND,t=>{console.log("Pet match found:",t),this.emit("petMatchFound",t)}),this.socket.on(i.CF.SYSTEM_ANNOUNCEMENT,t=>{console.log("System announcement:",t),this.emit("systemAnnouncement",t)}))}async joinUserRoom(){try{let t=await a.O.getCurrentUser();t&&this.socket&&this.socket.emit(i.CF.JOIN_ROOM,{room:"user:".concat(t._id)})}catch(t){console.error("Failed to join user room:",t)}}handleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached");return}this.reconnectAttempts++;let t=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log("Attempting to reconnect in ".concat(t,"ms (attempt ").concat(this.reconnectAttempts,")")),setTimeout(()=>{this.connect()},t)}handleNotification(t){switch(this.emit("notification",t),t.type){case i.k$.MATCH_FOUND:this.emit("matchFound",t);break;case i.k$.PET_STATUS_UPDATE:this.emit("petStatusUpdate",t);break;case i.k$.GEOFENCE_ALERT:this.emit("geofenceAlert",t);break;case i.k$.REMINDER:this.emit("reminder",t)}}markNotificationAsRead(t){var e;(null===(e=this.socket)||void 0===e?void 0:e.connected)&&this.socket.emit(i.CF.NOTIFICATION_READ,{notificationId:t})}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.isConnecting=!1,this.reconnectAttempts=0}isConnected(){var t;return(null===(t=this.socket)||void 0===t?void 0:t.connected)||!1}on(t,e){var o;this.listeners.has(t)||this.listeners.set(t,[]),null===(o=this.listeners.get(t))||void 0===o||o.push(e)}off(t,e){if(!e){this.listeners.delete(t);return}let o=this.listeners.get(t);if(o){let t=o.indexOf(e);t>-1&&o.splice(t,1)}}emit(t,e){let o=this.listeners.get(t);o&&o.forEach(o=>{try{o(e)}catch(e){console.error("Error in ".concat(t," callback:"),e)}})}send(t,e){var o;(null===(o=this.socket)||void 0===o?void 0:o.connected)?this.socket.emit(t,e):console.warn("Socket not connected, cannot send event:",t)}constructor(){this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isConnecting=!1,this.listeners=new Map}}let c=new s;var l=o(994),h=o(8095),d=o(2657);let f=(0,l.C6)().length?(0,l.C6)()[0]:(0,l.ZF)({apiKey:"AIzaSyAeDAcAvq_bWMCzEOb4ZKYN1FfyA2SWkqY",authDomain:"pet-find-4ce00.firebaseapp.com",projectId:"pet-find-4ce00",storageBucket:"pet-find-4ce00.firebasestorage.app",messagingSenderId:"1002054218017",appId:"1:1002054218017:web:2a0e988b59a191371c4e60",measurementId:"G-0BJ5CFRM3L"}),u=null;if("serviceWorker"in navigator)try{u=(0,h.KL)(f)}catch(t){console.error("Firebase messaging initialization failed:",t)}try{(0,d.IH)(f)}catch(t){console.error("Firebase analytics initialization failed:",t)}let g=async()=>{if(!u)return console.warn("Firebase messaging not initialized"),null;try{let t="BJ6NLL0yveEK_SvqelRnNlC61AWRZKkbzj4ytXQ7h69f_-yDi_9lAUEd_ZAU1CLme6QFSDuFBBdbn66ce1X3Kc0";if(!t)return console.error("VAPID key not configured"),null;let e=await (0,h.LP)(u,{vapidKey:t});if(e)return console.log("FCM Token generated:",e),e;return console.log("No registration token available."),null}catch(t){return console.error("An error occurred while retrieving token:",t),null}},p=t=>{if(!u){console.warn("Firebase messaging not initialized");return}return(0,h.ps)(u,e=>{console.log("Foreground message received:",e),t(e)})},k=async()=>"Notification"in window?"granted"===Notification.permission?"granted":"denied"===Notification.permission?"denied":await Notification.requestPermission():(console.warn("This browser does not support notifications"),"denied"),m=(t,e)=>{if(!("Notification"in window)){console.warn("This browser does not support notifications");return}"granted"===Notification.permission&&new Notification(t,{icon:"/icons/icon-192x192.png",badge:"/icons/badge-72x72.png",...e})};class E{async initialize(){if(!this.isInitialized)try{let t=await k();if("granted"!==t){console.warn("Notification permission not granted");return}this.fcmToken=await g(),this.fcmToken&&await this.registerFCMToken(this.fcmToken),p(t=>{this.handleForegroundMessage(t)}),await c.connect(),this.setupSocketListeners(),this.isInitialized=!0,console.log("Notification service initialized successfully")}catch(t){console.error("Failed to initialize notification service:",t)}}setupSocketListeners(){c.on("notification",t=>{this.handleRealtimeNotification(t)}),c.on("matchFound",t=>{this.showNotificationToUser(t.title,{body:t.message,icon:t.imageUrl||"/icons/icon-192x192.png",tag:"match-".concat(t.id),data:t.data})}),c.on("geofenceAlert",t=>{this.showNotificationToUser(t.title,{body:t.message,icon:"/icons/location-alert.png",tag:"geofence-".concat(t.id),data:t.data})})}handleForegroundMessage(t){console.log("Foreground FCM message:",t);let{notification:e,data:o}=t;e&&this.showNotificationToUser(e.title,{body:e.body,icon:e.icon||"/icons/icon-192x192.png",data:o})}handleRealtimeNotification(t){console.log("Realtime notification received:",t),this.showNotificationToUser(t.title,{body:t.message,icon:t.imageUrl||"/icons/icon-192x192.png",tag:t.id,data:t.data}),window.dispatchEvent(new CustomEvent("realtimeNotification",{detail:t}))}showNotificationToUser(t,e){m(t,{...e,requireInteraction:!0})}async registerFCMToken(t){try{let e=a.O.getToken();if(!e){console.warn("No auth token available for FCM registration");return}if("undefined"==typeof navigator){console.warn("Cannot register FCM token on server side");return}if(!(await fetch("".concat(this.baseUrl,"/notifications/fcm-token"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({token:t,deviceInfo:{userAgent:navigator.userAgent,platform:navigator.platform}})})).ok)throw Error("Failed to register FCM token");console.log("FCM token registered successfully")}catch(t){console.error("Failed to register FCM token:",t)}}async getNotifications(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let e=a.O.getToken();if(!e)throw Error("No authentication token");let o=new URLSearchParams;Object.entries(t).forEach(t=>{let[e,n]=t;void 0!==n&&o.append(e,n.toString())});let n=await fetch("".concat(this.baseUrl,"/notifications?").concat(o),{headers:{Authorization:"Bearer ".concat(e)}});if(!n.ok)throw Error("Failed to fetch notifications");return await n.json()}catch(t){throw console.error("Failed to get notifications:",t),t}}async markAsRead(t){try{let e=a.O.getToken();if(!e)throw Error("No authentication token");if(!(await fetch("".concat(this.baseUrl,"/notifications/").concat(t,"/read"),{method:"PUT",headers:{Authorization:"Bearer ".concat(e)}})).ok)throw Error("Failed to mark notification as read");c.markNotificationAsRead(t)}catch(t){throw console.error("Failed to mark notification as read:",t),t}}async markAllAsRead(){try{let t=a.O.getToken();if(!t)throw Error("No authentication token");if(!(await fetch("".concat(this.baseUrl,"/notifications/mark-all-read"),{method:"PUT",headers:{Authorization:"Bearer ".concat(t)}})).ok)throw Error("Failed to mark all notifications as read")}catch(t){throw console.error("Failed to mark all notifications as read:",t),t}}async getStats(){try{let t=a.O.getToken();if(!t)throw Error("No authentication token");let e=await fetch("".concat(this.baseUrl,"/notifications/stats"),{headers:{Authorization:"Bearer ".concat(t)}});if(!e.ok)throw Error("Failed to fetch notification stats");return await e.json()}catch(t){throw console.error("Failed to get notification stats:",t),t}}async getPreferences(){try{let t=a.O.getToken();if(!t)throw Error("No authentication token");let e=await fetch("".concat(this.baseUrl,"/notifications/preferences"),{headers:{Authorization:"Bearer ".concat(t)}});if(!e.ok)throw Error("Failed to fetch notification preferences");return await e.json()}catch(t){throw console.error("Failed to get notification preferences:",t),t}}async updatePreferences(t){try{let e=a.O.getToken();if(!e)throw Error("No authentication token");if(!(await fetch("".concat(this.baseUrl,"/notifications/preferences"),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify(t)})).ok)throw Error("Failed to update notification preferences")}catch(t){throw console.error("Failed to update notification preferences:",t),t}}cleanup(){c.disconnect(),this.isInitialized=!1,this.fcmToken=null}getInitializationStatus(){return this.isInitialized}getFCMToken(){return this.fcmToken}constructor(){this.baseUrl="http://localhost:3001/api",this.fcmToken=null,this.isInitialized=!1}}let y=new E;var T=o(6862);let w=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},[e,o]=(0,n.useState)([]),[a,r]=(0,n.useState)(!0),[s,c]=(0,n.useState)(null),[l,h]=(0,n.useState)({page:1,limit:20,total:0,totalPages:0}),d=(0,n.useCallback)(async()=>{try{r(!0),c(null);let e=await y.getNotifications({page:l.page,limit:l.limit,...t});e.success&&e.data&&(o(Array.isArray(e.data)?e.data:[e.data]),e.pagination&&h(e.pagination))}catch(t){c(t instanceof Error?t.message:"獲取通知失敗")}finally{r(!1)}},[t,l.page,l.limit]);(0,n.useEffect)(()=>{d()},[d]);let f=(0,n.useCallback)(async t=>{try{await y.markAsRead(t),o(e=>e.map(e=>e.id===t?{...e,status:i.Ez.READ}:e))}catch(t){console.error("Failed to mark notification as read:",t)}},[]),u=(0,n.useCallback)(async()=>{try{await y.markAllAsRead(),o(t=>t.map(t=>({...t,status:i.Ez.READ})))}catch(t){console.error("Failed to mark all notifications as read:",t)}},[]),g=(0,n.useCallback)(()=>{d()},[d]),p=(0,n.useCallback)(()=>{l.page<l.totalPages&&h(t=>({...t,page:t.page+1}))},[l.page,l.totalPages]);return{notifications:e,loading:a,error:s,pagination:l,markAsRead:f,markAllAsRead:u,refresh:g,loadMore:p,hasMore:l.page<l.totalPages}},N=()=>{let[t,e]=(0,n.useState)(null),[o,i]=(0,n.useState)(!0),[a,r]=(0,n.useState)(null),s=(0,n.useCallback)(async()=>{try{i(!0),r(null);let t=await y.getStats();e(t)}catch(t){r(t instanceof Error?t.message:"獲取統計失敗")}finally{i(!1)}},[]);return(0,n.useEffect)(()=>{s()},[s]),{stats:t,loading:o,error:a,refresh:(0,n.useCallback)(()=>{s()},[s])}},A=()=>{let[t,e]=(0,n.useState)(null),[o,i]=(0,n.useState)(!0),[a,r]=(0,n.useState)(null),[s,c]=(0,n.useState)(!1),{toast:l}=(0,T.pm)(),h=(0,n.useCallback)(async()=>{try{i(!0),r(null);let t=await y.getPreferences();e(t)}catch(t){r(t instanceof Error?t.message:"獲取偏好設定失敗")}finally{i(!1)}},[]);return(0,n.useEffect)(()=>{h()},[h]),{preferences:t,loading:o,error:a,updating:s,updatePreferences:(0,n.useCallback)(async t=>{try{c(!0),await y.updatePreferences(t),e(e=>e?{...e,...t}:null),l({title:"設定已更新",description:"通知偏好設定已成功更新"})}catch(t){l({title:"更新失敗",description:t instanceof Error?t.message:"更新偏好設定失敗",variant:"destructive"})}finally{c(!1)}},[l]),refresh:h}},C=()=>{let[t,e]=(0,n.useState)(!1),[o,i]=(0,n.useState)(null);return(0,n.useEffect)(()=>((async()=>{try{await y.initialize(),e(!0)}catch(t){i(t instanceof Error?t.message:"初始化通知服務失敗")}})(),()=>{y.cleanup()}),[]),{isInitialized:t,initError:o}}},6541:function(t,e,o){o.d(e,{O:function(){return i}});class n{async login(t){let e=await fetch("".concat(this.baseUrl,"/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw Error("Login failed");let o=await e.json();return this.setToken(o.token),o}async register(t){let e=await fetch("".concat(this.baseUrl,"/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw Error("Registration failed");let o=await e.json();return this.setToken(o.token),o}async logout(){try{await fetch("".concat(this.baseUrl,"/auth/logout"),{method:"POST",headers:{Authorization:"Bearer ".concat(this.getToken())}})}finally{this.removeToken()}}async getCurrentUser(){let t=await fetch("".concat(this.baseUrl,"/auth/me"),{headers:{Authorization:"Bearer ".concat(this.getToken())}});if(!t.ok)throw Error("Failed to get current user");return t.json()}async forgotPassword(t){if(!(await fetch("".concat(this.baseUrl,"/auth/forgot-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok)throw Error("Failed to send reset password email")}async resetPassword(t){if(!(await fetch("".concat(this.baseUrl,"/auth/reset-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok)throw Error("Failed to reset password")}async verifyEmail(t){if(!(await fetch("".concat(this.baseUrl,"/auth/verify-email"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})})).ok)throw Error("Failed to verify email")}async updateProfile(t){let e=await fetch("".concat(this.baseUrl,"/auth/profile"),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.getToken())},body:JSON.stringify(t)});if(!e.ok)throw Error("Failed to update profile");return e.json()}async changePassword(t){if(!(await fetch("".concat(this.baseUrl,"/auth/change-password"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.getToken())},body:JSON.stringify(t)})).ok)throw Error("Failed to change password")}getToken(){return localStorage.getItem(this.tokenKey)}setToken(t){localStorage.setItem(this.tokenKey,t)}removeToken(){localStorage.removeItem(this.tokenKey)}isAuthenticated(){return!!this.getToken()}constructor(){this.baseUrl="http://localhost:3001/api",this.tokenKey="auth_token"}}let i=new n},1562:function(t,e,o){var n,i,a,r,s,c,l,h;o.d(e,{CF:function(){return r},Ez:function(){return a},RX:function(){return i},k$:function(){return n}}),(s=n||(n={})).MATCH_FOUND="MATCH_FOUND",s.PET_STATUS_UPDATE="PET_STATUS_UPDATE",s.GEOFENCE_ALERT="GEOFENCE_ALERT",s.REMINDER="REMINDER",s.SYSTEM_ANNOUNCEMENT="SYSTEM_ANNOUNCEMENT",s.MESSAGE="MESSAGE",s.COMMENT="COMMENT",(c=i||(i={})).LOW="LOW",c.MEDIUM="MEDIUM",c.HIGH="HIGH",c.URGENT="URGENT",(l=a||(a={})).UNREAD="UNREAD",l.READ="READ",l.ARCHIVED="ARCHIVED",(h=r||(r={})).CONNECTION="connection",h.DISCONNECT="disconnect",h.JOIN_ROOM="join_room",h.LEAVE_ROOM="leave_room",h.NOTIFICATION="notification",h.NOTIFICATION_READ="notification_read",h.NOTIFICATION_DELIVERED="notification_delivered",h.PET_STATUS_UPDATE="pet:status_update",h.PET_MATCH_FOUND="pet:match_found",h.SYSTEM_ANNOUNCEMENT="system:announcement"}}]);