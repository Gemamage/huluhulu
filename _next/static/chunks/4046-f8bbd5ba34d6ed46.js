"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4046],{6210:function(t,e,a){a.d(e,{H:function(){return c},a:function(){return h}});var r=a(7437),s=a(2265),o=a(8793),i=a(6862);let n=(0,s.createContext)(void 0);function c(t){let{children:e}=t,[a,c]=(0,s.useState)(null),[h,l]=(0,s.useState)(!0),{toast:u}=(0,i.pm)(),d=async()=>{try{if(o.O.isAuthenticated()){let t=await o.O.getCurrentUser();c(t)}else c(null)}catch(t){console.error("檢查認證狀態失敗:",t),c(null)}finally{l(!1)}},f=async(t,e)=>{try{l(!0);let a=await o.O.login({email:t,password:e});c(a.user),u({title:"登入成功",description:"歡迎回來，".concat(a.user.name,"！")})}catch(t){throw u({title:"登入失敗",description:t instanceof Error?t.message:"登入失敗",variant:"destructive"}),t}finally{l(!1)}},E=async(t,e,a,r)=>{try{l(!0);let s=await o.O.register({name:a,email:t,password:e,...r?{phone:r}:{}});c(s.user),u({title:"註冊成功",description:"歡迎加入呼嚕寵物協尋！請檢查您的電子郵件以驗證帳號。"})}catch(t){throw u({title:"註冊失敗",description:t instanceof Error?t.message:"註冊失敗",variant:"destructive"}),t}finally{l(!1)}},w=async()=>{try{await o.O.logout(),c(null),u({title:"已登出",description:"您已成功登出。"})}catch(t){console.error("登出失敗:",t),c(null)}},y=async()=>{try{if(o.O.isAuthenticated()){let t=await o.O.getCurrentUser();c(t)}}catch(t){console.error("刷新用戶資訊失敗:",t),c(null)}},S=async t=>{try{await o.O.forgotPassword(t),u({title:"郵件已發送",description:"請檢查您的電子郵件以重設密碼。"})}catch(t){throw u({title:"發送失敗",description:t instanceof Error?t.message:"發送重設密碼郵件失敗",variant:"destructive"}),t}},g=async(t,e)=>{try{await o.O.resetPassword({token:t,newPassword:e}),u({title:"密碼重設成功",description:"您的密碼已成功重設，請使用新密碼登入。"})}catch(t){throw u({title:"重設失敗",description:t instanceof Error?t.message:"重設密碼失敗",variant:"destructive"}),t}},p=async t=>{try{await o.O.verifyEmail(t),await y(),u({title:"電子郵件驗證成功",description:"您的電子郵件已成功驗證。"})}catch(t){throw u({title:"驗證失敗",description:t instanceof Error?t.message:"電子郵件驗證失敗",variant:"destructive"}),t}},A=async()=>{try{await o.O.resendVerificationEmail(),u({title:"驗證郵件已發送",description:"請檢查您的電子郵件以驗證帳號。"})}catch(t){throw u({title:"發送失敗",description:t instanceof Error?t.message:"發送驗證郵件失敗",variant:"destructive"}),t}},T=async t=>{try{let e=await o.O.updateProfile(t);c(e),u({title:"個人資料更新成功",description:"您的個人資料已成功更新。"})}catch(t){throw u({title:"更新失敗",description:t instanceof Error?t.message:"更新個人資料失敗",variant:"destructive"}),t}},m=async(t,e)=>{try{await o.O.changePassword(t,e),u({title:"密碼更改成功",description:"您的密碼已成功更改。"})}catch(t){throw u({title:"更改失敗",description:t instanceof Error?t.message:"更改密碼失敗",variant:"destructive"}),t}},_=async t=>{try{let e=await o.O.uploadAvatar(t);c(e),u({title:"頭像上傳成功",description:"您的頭像已成功更新。"})}catch(t){throw u({title:"上傳失敗",description:t instanceof Error?t.message:"上傳頭像失敗",variant:"destructive"}),t}};(0,s.useEffect)(()=>{let t=setInterval(()=>{o.O.isAuthenticated()&&o.O.autoRefreshToken().catch(console.error)},3e5);return()=>clearInterval(t)},[]),(0,s.useEffect)(()=>{d()},[]);let O={user:a,isLoading:h,isAuthenticated:!!a&&o.O.isAuthenticated(),login:f,register:E,logout:w,refreshUser:y,forgotPassword:S,resetPassword:g,verifyEmail:p,resendVerificationEmail:A,updateProfile:T,changePassword:m,uploadAvatar:_};return(0,r.jsx)(n.Provider,{value:O,children:e})}function h(){let t=(0,s.useContext)(n);if(void 0===t)throw Error("useAuth must be used within an AuthProvider");return t}},6862:function(t,e,a){a.d(e,{Am:function(){return u},pm:function(){return d}});var r=a(2265);let s=0,o=new Map,i=t=>{if(o.has(t))return;let e=setTimeout(()=>{o.delete(t),l({type:"REMOVE_TOAST",toastId:t})},1e6);o.set(t,e)},n=(t,e)=>{switch(e.type){case"ADD_TOAST":return{...t,toasts:[e.toast,...t.toasts].slice(0,1)};case"UPDATE_TOAST":return{...t,toasts:t.toasts.map(t=>t.id===e.toast.id?{...t,...e.toast}:t)};case"DISMISS_TOAST":{let{toastId:a}=e;return a?i(a):t.toasts.forEach(t=>{i(t.id)}),{...t,toasts:t.toasts.map(t=>t.id===a||void 0===a?{...t,open:!1}:t)}}case"REMOVE_TOAST":if(void 0===e.toastId)return{...t,toasts:[]};return{...t,toasts:t.toasts.filter(t=>t.id!==e.toastId)}}},c=[],h={toasts:[]};function l(t){h=n(h,t),c.forEach(t=>{t(h)})}function u(t){let{...e}=t,a=(s=(s+1)%Number.MAX_SAFE_INTEGER).toString(),r=()=>l({type:"DISMISS_TOAST",toastId:a});return l({type:"ADD_TOAST",toast:{...e,id:a,open:!0,onOpenChange:t=>{t||r()}}}),{id:a,dismiss:r,update:t=>l({type:"UPDATE_TOAST",toast:{...t,id:a}})}}function d(){let[t,e]=r.useState(h);return r.useEffect(()=>(c.push(e),()=>{let t=c.indexOf(e);t>-1&&c.splice(t,1)}),[t]),{...t,toast:u,dismiss:t=>l({type:"DISMISS_TOAST",toastId:t||void 0})}}},8793:function(t,e,a){a.d(e,{O:function(){return o}});var r=a(3771);class s{async register(t){let e=await fetch("".concat(this.API_BASE_URL,"/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();if(!e.ok)throw Error(a.message||"註冊失敗");return this.setTokens(a.data.tokens),this.setUser(a.data.user),a.data}async login(t){let e=await fetch("".concat(this.API_BASE_URL,"/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();if(!e.ok)throw Error(a.message||"登入失敗");return this.setTokens(a.data.tokens),this.setUser(a.data.user),a.data}async logout(){let t=this.getRefreshToken();if(t)try{await fetch("".concat(this.API_BASE_URL,"/auth/logout"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.getAccessToken())},body:JSON.stringify({refreshToken:t})})}catch(t){console.error("登出請求失敗:",t)}this.clearAuth()}async refreshToken(){let t=this.getRefreshToken();if(!t)throw Error("沒有刷新令牌");let e=await fetch("".concat(this.API_BASE_URL,"/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:t})}),a=await e.json();if(!e.ok)throw this.clearAuth(),Error(a.message||"令牌刷新失敗");return this.setTokens(a.data.tokens),a.data.tokens}async forgotPassword(t){let e=await fetch("".concat(this.API_BASE_URL,"/auth/forgot-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})}),a=await e.json();if(!e.ok)throw Error(a.message||"發送重設密碼郵件失敗")}async resetPassword(t){let e=await fetch("".concat(this.API_BASE_URL,"/auth/reset-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();if(!e.ok)throw Error(a.message||"重設密碼失敗")}async getCurrentUser(){let t=await fetch("".concat(this.API_BASE_URL,"/auth/me"),{method:"GET",headers:{Authorization:"Bearer ".concat(this.getAccessToken())}}),e=await t.json();if(!t.ok)throw Error(e.message||"獲取用戶資訊失敗");return this.setUser(e.data.user),e.data.user}async verifyEmail(t){let e=await fetch("".concat(this.API_BASE_URL,"/auth/verify-email/").concat(t),{method:"GET"}),a=await e.json();if(!e.ok)throw Error(a.message||"電子郵件驗證失敗")}async resendVerificationEmail(){let t=await fetch("".concat(this.API_BASE_URL,"/auth/resend-verification"),{method:"POST",headers:{Authorization:"Bearer ".concat(this.getAccessToken())}}),e=await t.json();if(!t.ok)throw Error(e.message||"發送驗證郵件失敗")}async resendVerificationEmailByEmail(t){let e=await fetch("".concat(this.API_BASE_URL,"/auth/resend-verification-email"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})}),a=await e.json();if(!e.ok)throw Error(a.message||"發送驗證郵件失敗")}async checkVerificationStatus(t){let e=await fetch("".concat(this.API_BASE_URL,"/auth/verification-status?email=").concat(encodeURIComponent(t)),{method:"GET"}),a=await e.json();if(!e.ok)throw Error(a.message||"檢查驗證狀態失敗");return a.data}async updateProfile(t){let e=await fetch("".concat(this.API_BASE_URL,"/users/me"),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.getAccessToken())},body:JSON.stringify(t)}),a=await e.json();if(!e.ok)throw Error(a.message||"更新個人資料失敗");return this.setUser(a.data.user),a.data.user}async changePassword(t,e){let a=this.getUser();if(!a)throw Error("未找到用戶資訊");let r=await fetch("".concat(this.API_BASE_URL,"/users/").concat(a.id,"/change-password"),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.getAccessToken())},body:JSON.stringify({currentPassword:t,newPassword:e})}),s=await r.json();if(!r.ok)throw Error(s.message||"更改密碼失敗")}async uploadAvatar(t){let e=this.getUser();if(!e)throw Error("未找到用戶資訊");let a=new FormData;a.append("avatar",t);let r=await fetch("".concat(this.API_BASE_URL,"/users/").concat(e.id,"/avatar"),{method:"POST",headers:{Authorization:"Bearer ".concat(this.getAccessToken())},body:a}),s=await r.json();if(!r.ok)throw Error(s.message||"上傳頭像失敗");return this.setUser(s.data.user),s.data.user}setTokens(t){localStorage.setItem(this.ACCESS_TOKEN_KEY,t.accessToken),localStorage.setItem(this.REFRESH_TOKEN_KEY,t.refreshToken)}getAccessToken(){return localStorage.getItem(this.ACCESS_TOKEN_KEY)}getRefreshToken(){return localStorage.getItem(this.REFRESH_TOKEN_KEY)}setUser(t){localStorage.setItem(this.USER_KEY,JSON.stringify(t))}getUser(){{let t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}}isAuthenticated(){let t=this.getAccessToken();if(!t)return!1;try{let e=(0,r.o)(t),a=Date.now()/1e3;return!!e.exp&&e.exp>a}catch(t){return!1}}clearAuth(){localStorage.removeItem(this.ACCESS_TOKEN_KEY),localStorage.removeItem(this.REFRESH_TOKEN_KEY),localStorage.removeItem(this.USER_KEY)}async autoRefreshToken(){let t=this.getAccessToken();if(t)try{let e=(0,r.o)(t),a=Date.now()/1e3;(e.exp||0)-a<300&&await this.refreshToken()}catch(t){console.error("自動刷新令牌失敗:",t),this.clearAuth()}}constructor(){this.API_BASE_URL="http://localhost:3001/api",this.ACCESS_TOKEN_KEY="accessToken",this.REFRESH_TOKEN_KEY="refreshToken",this.USER_KEY="user"}}let o=new s},2169:function(t,e,a){a.d(e,{SY:function(){return i},cn:function(){return o}});var r=a(7042),s=a(4769);function o(){for(var t=arguments.length,e=Array(t),a=0;a<t;a++)e[a]=arguments[a];return(0,s.m6)((0,r.W)(e))}function i(t){let e="string"==typeof t?new Date(t):t,a=Math.floor((new Date().getTime()-e.getTime())/1e3);if(a<60)return"剛剛";let r=Math.floor(a/60);if(r<60)return"".concat(r,"分鐘前");let s=Math.floor(r/60);if(s<24)return"".concat(s,"小時前");let o=Math.floor(s/24);if(o<30)return"".concat(o,"天前");let i=Math.floor(o/30);return i<12?"".concat(i,"個月前"):"".concat(Math.floor(i/12),"年前")}}}]);