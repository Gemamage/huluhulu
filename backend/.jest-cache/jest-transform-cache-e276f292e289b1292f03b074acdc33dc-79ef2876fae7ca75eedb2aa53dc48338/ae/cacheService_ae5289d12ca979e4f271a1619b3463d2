863a7216381f44ea79c4857642e6e0ed
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cacheService = exports.CacheService = void 0;
// 快取服務 - 提供請求快取和去重功能
const logger_1 = require("../utils/logger");
class CacheService {
    constructor(config) {
        this.cache = new Map();
        this.pendingRequests = new Map();
        this.cleanupTimer = null;
        this.config = {
            defaultTTL: 5 * 60 * 1000, // 5分鐘
            maxSize: 1000, // 最多1000個快取項目
            cleanupInterval: 60 * 1000, // 每分鐘清理一次
            ...config
        };
        // 啟動定期清理
        this.startCleanup();
    }
    /**
     * 獲取快取服務實例（單例模式）
     */
    static getInstance(config) {
        // 在測試環境中，允許創建新實例
        if (process.env.NODE_ENV === 'test' && config) {
            return new CacheService(config);
        }
        if (!CacheService.instance) {
            CacheService.instance = new CacheService(config);
        }
        return CacheService.instance;
    }
    /**
     * 重置單例實例（僅用於測試）
     */
    static resetInstance() {
        if (process.env.NODE_ENV === 'test') {
            if (CacheService.instance) {
                CacheService.instance.stopCleanup();
            }
            CacheService.instance = null;
        }
    }
    /**
     * 生成快取鍵
     */
    generateKey(prefix, params) {
        const paramStr = params.map(p => typeof p === 'object' ? JSON.stringify(p) : String(p)).join('|');
        return `${prefix}:${paramStr}`;
    }
    /**
     * 檢查快取項目是否過期
     */
    isExpired(item) {
        return Date.now() - item.timestamp > item.ttl;
    }
    /**
     * 獲取快取資料
     */
    get(key) {
        const item = this.cache.get(key);
        if (!item) {
            return null;
        }
        if (this.isExpired(item)) {
            this.cache.delete(key);
            return null;
        }
        logger_1.logger.debug(`快取命中: ${key}`);
        return item.data;
    }
    /**
     * 設置快取資料
     */
    set(key, data, ttl) {
        // 檢查快取大小限制
        if (this.cache.size >= this.config.maxSize && !this.cache.has(key)) {
            this.evictOldest();
        }
        const item = {
            data,
            timestamp: Date.now(),
            ttl: ttl || this.config.defaultTTL
        };
        this.cache.set(key, item);
        logger_1.logger.debug(`快取設置: ${key}`);
    }
    /**
     * 刪除快取項目
     */
    delete(key) {
        const deleted = this.cache.delete(key);
        if (deleted) {
            logger_1.logger.debug(`快取刪除: ${key}`);
        }
        return deleted;
    }
    /**
     * 清空所有快取
     */
    clear() {
        this.cache.clear();
        this.pendingRequests.clear();
        logger_1.logger.info('所有快取已清空');
    }
    /**
     * 帶快取的函數執行（包含請求去重）
     */
    async withCache(cacheKey, asyncFunction, ttl) {
        // 檢查快取
        const cached = this.get(cacheKey);
        if (cached !== null) {
            return cached;
        }
        // 檢查是否有相同的請求正在進行（請求去重）
        const pending = this.pendingRequests.get(cacheKey);
        if (pending) {
            logger_1.logger.debug(`請求去重: ${cacheKey}`);
            return pending.promise;
        }
        // 執行新請求
        const promise = asyncFunction();
        this.pendingRequests.set(cacheKey, {
            promise,
            timestamp: Date.now()
        });
        try {
            const result = await promise;
            // 將結果存入快取
            this.set(cacheKey, result, ttl);
            return result;
        }
        catch (error) {
            logger_1.logger.error(`快取函數執行失敗: ${cacheKey}`, error);
            throw error;
        }
        finally {
            // 清除進行中的請求記錄
            this.pendingRequests.delete(cacheKey);
        }
    }
    /**
     * 批量刪除快取（支援模式匹配）
     */
    deletePattern(pattern) {
        let deletedCount = 0;
        const regex = new RegExp(pattern);
        for (const key of this.cache.keys()) {
            if (regex.test(key)) {
                this.cache.delete(key);
                deletedCount++;
            }
        }
        if (deletedCount > 0) {
            logger_1.logger.debug(`批量刪除快取: ${deletedCount} 個項目`);
        }
        return deletedCount;
    }
    /**
     * 移除最舊的快取項目
     */
    evictOldest() {
        let oldestKey = null;
        let oldestTime = Date.now();
        for (const [key, item] of this.cache.entries()) {
            if (item.timestamp < oldestTime) {
                oldestTime = item.timestamp;
                oldestKey = key;
            }
        }
        if (oldestKey) {
            this.cache.delete(oldestKey);
            logger_1.logger.debug(`移除最舊快取: ${oldestKey}`);
        }
    }
    /**
     * 清理過期的快取項目
     */
    cleanup() {
        let cleanedCount = 0;
        const now = Date.now();
        // 清理過期快取
        for (const [key, item] of this.cache.entries()) {
            if (this.isExpired(item)) {
                this.cache.delete(key);
                cleanedCount++;
            }
        }
        // 清理過期的進行中請求（超過5分鐘）
        for (const [key, pending] of this.pendingRequests.entries()) {
            if (now - pending.timestamp > 5 * 60 * 1000) {
                this.pendingRequests.delete(key);
            }
        }
        if (cleanedCount > 0) {
            logger_1.logger.debug(`清理過期快取: ${cleanedCount} 個項目`);
        }
    }
    /**
     * 啟動定期清理
     */
    startCleanup() {
        this.cleanupTimer = setInterval(() => {
            this.cleanup();
        }, this.config.cleanupInterval);
    }
    /**
     * 停止定期清理
     */
    stopCleanup() {
        if (this.cleanupTimer) {
            clearInterval(this.cleanupTimer);
            this.cleanupTimer = null;
        }
    }
    /**
     * 獲取快取統計資訊
     */
    getStats() {
        return {
            cacheSize: this.cache.size,
            pendingRequests: this.pendingRequests.size,
            maxSize: this.config.maxSize,
            defaultTTL: this.config.defaultTTL
        };
    }
}
exports.CacheService = CacheService;
// 預設快取實例
exports.cacheService = CacheService.getInstance();
console.log('✅ CacheService 已載入');
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxjYWNoZVNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUJBQXFCO0FBQ3JCLDRDQUF5QztBQXNCekMsTUFBYSxZQUFZO0lBT3ZCLFlBQW9CLE1BQTZCO1FBTHpDLFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztRQUMxQyxvQkFBZSxHQUFHLElBQUksR0FBRyxFQUErQixDQUFDO1FBRXpELGlCQUFZLEdBQTBCLElBQUksQ0FBQztRQUdqRCxJQUFJLENBQUMsTUFBTSxHQUFHO1lBQ1osVUFBVSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLE1BQU07WUFDakMsT0FBTyxFQUFFLElBQUksRUFBRSxjQUFjO1lBQzdCLGVBQWUsRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLFVBQVU7WUFDdEMsR0FBRyxNQUFNO1NBQ1YsQ0FBQztRQUVGLFNBQVM7UUFDVCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUE2QjtRQUM5QyxpQkFBaUI7UUFDakIsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLElBQUksTUFBTSxFQUFFLENBQUM7WUFDOUMsT0FBTyxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsQyxDQUFDO1FBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMzQixZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25ELENBQUM7UUFDRCxPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGFBQWE7UUFDbEIsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFB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LFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN0QixhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQzNCLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxRQUFRO1FBTU4sT0FBTztZQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUk7WUFDMUIsZUFBZSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSTtZQUMxQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPO1lBQzVCLFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7U0FDbkMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXhRRCxvQ0F3UUM7QUFFRCxTQUFTO0FBQ0ksUUFBQSxZQUFZLEdBQUcsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBRXZELE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xcc2VydmljZXNcXGNhY2hlU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDlv6vlj5bmnI3li5kgLSDmj5Dkvpvoq4vmsYLlv6vlj5blkozljrvph43lip/og71cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5cbi8vIOW/q+WPlumgheebruS7i+mdolxuaW50ZXJmYWNlIENhY2hlSXRlbTxUPiB7XG4gIGRhdGE6IFQ7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xuICB0dGw6IG51bWJlcjsgLy8g5a2Y5rS75pmC6ZaT77yI5q+r56eS77yJXG59XG5cbi8vIOmAsuihjOS4reeahOiri+axgui/vei5pFxuaW50ZXJmYWNlIFBlbmRpbmdSZXF1ZXN0PFQ+IHtcbiAgcHJvbWlzZTogUHJvbWlzZTxUPjtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG59XG5cbi8vIOW/q+WPlumFjee9rlxuaW50ZXJmYWNlIENhY2hlQ29uZmlnIHtcbiAgZGVmYXVsdFRUTDogbnVtYmVyOyAvLyDpoJDoqK3lv6vlj5bmmYLplpPvvIjmr6vnp5LvvIlcbiAgbWF4U2l6ZTogbnVtYmVyOyAvLyDmnIDlpKflv6vlj5bpoIXnm67mlbjph49cbiAgY2xlYW51cEludGVydmFsOiBudW1iZXI7IC8vIOa4heeQhumWk+malO+8iOavq+enku+8iVxufVxuXG5leHBvcnQgY2xhc3MgQ2FjaGVTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IENhY2hlU2VydmljZTtcbiAgcHJpdmF0ZSBjYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBDYWNoZUl0ZW08YW55Pj4oKTtcbiAgcHJpdmF0ZSBwZW5kaW5nUmVxdWVzdHMgPSBuZXcgTWFwPHN0cmluZywgUGVuZGluZ1JlcXVlc3Q8YW55Pj4oKTtcbiAgcHJpdmF0ZSBjb25maWc6IENhY2hlQ29uZmlnO1xuICBwcml2YXRlIGNsZWFudXBUaW1lcjogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKGNvbmZpZz86IFBhcnRpYWw8Q2FjaGVDb25maWc+KSB7XG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICBkZWZhdWx0VFRMOiA1ICogNjAgKiAxMDAwLCAvLyA15YiG6ZCYXG4gICAgICBtYXhTaXplOiAxMDAwLCAvLyDmnIDlpJoxMDAw5YCL5b+r5Y+W6aCF55uuXG4gICAgICBjbGVhbnVwSW50ZXJ2YWw6IDYwICogMTAwMCwgLy8g5q+P5YiG6ZCY5riF55CG5LiA5qyhXG4gICAgICAuLi5jb25maWdcbiAgICB9O1xuXG4gICAgLy8g5ZWf5YuV5a6a5pyf5riF55CGXG4gICAgdGhpcy5zdGFydENsZWFudXAoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnjbLlj5blv6vlj5bmnI3li5nlr6bkvovvvIjllq7kvovmqKHlvI/vvIlcbiAgICovXG4gIHN0YXRpYyBnZXRJbnN0YW5jZShjb25maWc/OiBQYXJ0aWFsPENhY2hlQ29uZmlnPik6IENhY2hlU2VydmljZSB7XG4gICAgLy8g5Zyo5ris6Kmm55Kw5aKD5Lit77yM5YWB6Kix5Ym15bu65paw5a+m5L6LXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcgJiYgY29uZmlnKSB7XG4gICAgICByZXR1cm4gbmV3IENhY2hlU2VydmljZShjb25maWcpO1xuICAgIH1cbiAgICBcbiAgICBpZiAoIUNhY2hlU2VydmljZS5pbnN0YW5jZSkge1xuICAgICAgQ2FjaGVTZXJ2aWNlLmluc3RhbmNlID0gbmV3IENhY2hlU2VydmljZShjb25maWcpO1xuICAgIH1cbiAgICByZXR1cm4gQ2FjaGVTZXJ2aWNlLmluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIOmHjee9ruWWruS+i+WvpuS+i++8iOWDheeUqOaWvOa4rOippu+8iVxuICAgKi9cbiAgc3RhdGljIHJlc2V0SW5zdGFuY2UoKTogdm9pZCB7XG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcpIHtcbiAgICAgIGlmIChDYWNoZVNlcnZpY2UuaW5zdGFuY2UpIHtcbiAgICAgICAgQ2FjaGVTZXJ2aWNlLmluc3RhbmNlLnN0b3BDbGVhbnVwKCk7XG4gICAgICB9XG4gICAgICBDYWNoZVNlcnZpY2UuaW5zdGFuY2UgPSBudWxsIGFzIGFueTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog55Sf5oiQ5b+r5Y+W6Y21XG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlS2V5KHByZWZpeDogc3RyaW5nLCBwYXJhbXM6IGFueVtdKTogc3RyaW5nIHtcbiAgICBjb25zdCBwYXJhbVN0ciA9IHBhcmFtcy5tYXAocCA9PiBcbiAgICAgIHR5cGVvZiBwID09PSAnb2JqZWN0JyA/IEpTT04uc3RyaW5naWZ5KHApIDogU3RyaW5nKHApXG4gICAgKS5qb2luKCd8Jyk7XG4gICAgcmV0dXJuIGAke3ByZWZpeH06JHtwYXJhbVN0cn1gO1xuICB9XG5cbiAgLyoqXG4gICAqIOaqouafpeW/q+WPlumgheebruaYr+WQpumBjuacn1xuICAgKi9cbiAgcHJpdmF0ZSBpc0V4cGlyZWQoaXRlbTogQ2FjaGVJdGVtPGFueT4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gRGF0ZS5ub3coKSAtIGl0ZW0udGltZXN0YW1wID4gaXRlbS50dGw7XG4gIH1cblxuICAvKipcbiAgICog542y5Y+W5b+r5Y+W6LOH5paZXG4gICAqL1xuICBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBUIHwgbnVsbCB7XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgaWYgKCFpdGVtKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0V4cGlyZWQoaXRlbSkpIHtcbiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBsb2dnZXIuZGVidWcoYOW/q+WPluWRveS4rTogJHtrZXl9YCk7XG4gICAgcmV0dXJuIGl0ZW0uZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiDoqK3nva7lv6vlj5bos4fmlplcbiAgICovXG4gIHNldDxUPihrZXk6IHN0cmluZywgZGF0YTogVCwgdHRsPzogbnVtYmVyKTogdm9pZCB7XG4gICAgLy8g5qqi5p+l5b+r5Y+W5aSn5bCP6ZmQ5Yi2XG4gICAgaWYgKHRoaXMuY2FjaGUuc2l6ZSA+PSB0aGlzLmNvbmZpZy5tYXhTaXplICYmICF0aGlzLmNhY2hlLmhhcyhrZXkpKSB7XG4gICAgICB0aGlzLmV2aWN0T2xkZXN0KCk7XG4gICAgfVxuXG4gICAgY29uc3QgaXRlbTogQ2FjaGVJdGVtPFQ+ID0ge1xuICAgICAgZGF0YSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHR0bDogdHRsIHx8IHRoaXMuY29uZmlnLmRlZmF1bHRUVExcbiAgICB9O1xuXG4gICAgdGhpcy5jYWNoZS5zZXQoa2V5LCBpdGVtKTtcbiAgICBsb2dnZXIuZGVidWcoYOW/q+WPluioree9rjogJHtrZXl9YCk7XG4gIH1cblxuICAvKipcbiAgICog5Yiq6Zmk5b+r5Y+W6aCF55uuXG4gICAqL1xuICBkZWxldGUoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBkZWxldGVkID0gdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICBpZiAoZGVsZXRlZCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGDlv6vlj5bliKrpmaQ6ICR7a2V5fWApO1xuICAgIH1cbiAgICByZXR1cm4gZGVsZXRlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnqbrmiYDmnInlv6vlj5ZcbiAgICovXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cy5jbGVhcigpO1xuICAgIGxvZ2dlci5pbmZvKCfmiYDmnInlv6vlj5blt7LmuIXnqbonKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDluLblv6vlj5bnmoTlh73mlbjln7fooYzvvIjljIXlkKvoq4vmsYLljrvph43vvIlcbiAgICovXG4gIGFzeW5jIHdpdGhDYWNoZTxUPihcbiAgICBjYWNoZUtleTogc3RyaW5nLFxuICAgIGFzeW5jRnVuY3Rpb246ICgpID0+IFByb21pc2U8VD4sXG4gICAgdHRsPzogbnVtYmVyXG4gICk6IFByb21pc2U8VD4ge1xuICAgIC8vIOaqouafpeW/q+WPllxuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuZ2V0PFQ+KGNhY2hlS2V5KTtcbiAgICBpZiAoY2FjaGVkICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FjaGVkO1xuICAgIH1cblxuICAgIC8vIOaqouafpeaYr+WQpuacieebuOWQjOeahOiri+axguato+WcqOmAsuihjO+8iOiri+axguWOu+mHje+8iVxuICAgIGNvbnN0IHBlbmRpbmcgPSB0aGlzLnBlbmRpbmdSZXF1ZXN0cy5nZXQoY2FjaGVLZXkpO1xuICAgIGlmIChwZW5kaW5nKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYOiri+axguWOu+mHjTogJHtjYWNoZUtleX1gKTtcbiAgICAgIHJldHVybiBwZW5kaW5nLnByb21pc2U7XG4gICAgfVxuXG4gICAgLy8g5Z+36KGM5paw6KuL5rGCXG4gICAgY29uc3QgcHJvbWlzZSA9IGFzeW5jRnVuY3Rpb24oKTtcbiAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cy5zZXQoY2FjaGVLZXksIHtcbiAgICAgIHByb21pc2UsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwcm9taXNlO1xuICAgICAgLy8g5bCH57WQ5p6c5a2Y5YWl5b+r5Y+WXG4gICAgICB0aGlzLnNldChjYWNoZUtleSwgcmVzdWx0LCB0dGwpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKGDlv6vlj5blh73mlbjln7fooYzlpLHmlZc6ICR7Y2FjaGVLZXl9YCwgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIOa4hemZpOmAsuihjOS4reeahOiri+axguiomOmMhFxuICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMuZGVsZXRlKGNhY2hlS2V5KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5om56YeP5Yiq6Zmk5b+r5Y+W77yI5pSv5o+05qih5byP5Yy56YWN77yJXG4gICAqL1xuICBkZWxldGVQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IG51bWJlciB7XG4gICAgbGV0IGRlbGV0ZWRDb3VudCA9IDA7XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHBhdHRlcm4pO1xuICAgIFxuICAgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMuY2FjaGUua2V5cygpKSB7XG4gICAgICBpZiAocmVnZXgudGVzdChrZXkpKSB7XG4gICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgICAgIGRlbGV0ZWRDb3VudCsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChkZWxldGVkQ291bnQgPiAwKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYOaJuemHj+WIqumZpOW/q+WPljogJHtkZWxldGVkQ291bnR9IOWAi+mgheebrmApO1xuICAgIH1cbiAgICByZXR1cm4gZGVsZXRlZENvdW50O1xuICB9XG5cbiAgLyoqXG4gICAqIOenu+mZpOacgOiIiueahOW/q+WPlumgheebrlxuICAgKi9cbiAgcHJpdmF0ZSBldmljdE9sZGVzdCgpOiB2b2lkIHtcbiAgICBsZXQgb2xkZXN0S2V5OiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgICBsZXQgb2xkZXN0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIGl0ZW1dIG9mIHRoaXMuY2FjaGUuZW50cmllcygpKSB7XG4gICAgICBpZiAoaXRlbS50aW1lc3RhbXAgPCBvbGRlc3RUaW1lKSB7XG4gICAgICAgIG9sZGVzdFRpbWUgPSBpdGVtLnRpbWVzdGFtcDtcbiAgICAgICAgb2xkZXN0S2V5ID0ga2V5O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChvbGRlc3RLZXkpIHtcbiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKG9sZGVzdEtleSk7XG4gICAgICBsb2dnZXIuZGVidWcoYOenu+mZpOacgOiIiuW/q+WPljogJHtvbGRlc3RLZXl9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOa4heeQhumBjuacn+eahOW/q+WPlumgheebrlxuICAgKi9cbiAgcHJpdmF0ZSBjbGVhbnVwKCk6IHZvaWQge1xuICAgIGxldCBjbGVhbmVkQ291bnQgPSAwO1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG5cbiAgICAvLyDmuIXnkIbpgY7mnJ/lv6vlj5ZcbiAgICBmb3IgKGNvbnN0IFtrZXksIGl0ZW1dIG9mIHRoaXMuY2FjaGUuZW50cmllcygpKSB7XG4gICAgICBpZiAodGhpcy5pc0V4cGlyZWQoaXRlbSkpIHtcbiAgICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgICAgY2xlYW5lZENvdW50Kys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g5riF55CG6YGO5pyf55qE6YCy6KGM5Lit6KuL5rGC77yI6LaF6YGONeWIhumQmO+8iVxuICAgIGZvciAoY29uc3QgW2tleSwgcGVuZGluZ10gb2YgdGhpcy5wZW5kaW5nUmVxdWVzdHMuZW50cmllcygpKSB7XG4gICAgICBpZiAobm93IC0gcGVuZGluZy50aW1lc3RhbXAgPiA1ICogNjAgKiAxMDAwKSB7XG4gICAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzLmRlbGV0ZShrZXkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjbGVhbmVkQ291bnQgPiAwKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYOa4heeQhumBjuacn+W/q+WPljogJHtjbGVhbmVkQ291bnR9IOWAi+mgheebrmApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDllZ/li5XlrprmnJ/muIXnkIZcbiAgICovXG4gIHByaXZhdGUgc3RhcnRDbGVhbnVwKCk6IHZvaWQge1xuICAgIHRoaXMuY2xlYW51cFRpbWVyID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgdGhpcy5jbGVhbnVwKCk7XG4gICAgfSwgdGhpcy5jb25maWcuY2xlYW51cEludGVydmFsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlgZzmraLlrprmnJ/muIXnkIZcbiAgICovXG4gIHN0b3BDbGVhbnVwKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNsZWFudXBUaW1lcikge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmNsZWFudXBUaW1lcik7XG4gICAgICB0aGlzLmNsZWFudXBUaW1lciA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPluW/q+WPlue1seioiOizh+ioilxuICAgKi9cbiAgZ2V0U3RhdHMoKToge1xuICAgIGNhY2hlU2l6ZTogbnVtYmVyO1xuICAgIHBlbmRpbmdSZXF1ZXN0czogbnVtYmVyO1xuICAgIG1heFNpemU6IG51bWJlcjtcbiAgICBkZWZhdWx0VFRMOiBudW1iZXI7XG4gIH0ge1xuICAgIHJldHVybiB7XG4gICAgICBjYWNoZVNpemU6IHRoaXMuY2FjaGUuc2l6ZSxcbiAgICAgIHBlbmRpbmdSZXF1ZXN0czogdGhpcy5wZW5kaW5nUmVxdWVzdHMuc2l6ZSxcbiAgICAgIG1heFNpemU6IHRoaXMuY29uZmlnLm1heFNpemUsXG4gICAgICBkZWZhdWx0VFRMOiB0aGlzLmNvbmZpZy5kZWZhdWx0VFRMXG4gICAgfTtcbiAgfVxufVxuXG4vLyDpoJDoqK3lv6vlj5blr6bkvotcbmV4cG9ydCBjb25zdCBjYWNoZVNlcnZpY2UgPSBDYWNoZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcblxuY29uc29sZS5sb2coJ+KchSBDYWNoZVNlcnZpY2Ug5bey6LyJ5YWlJyk7Il0sInZlcnNpb24iOjN9