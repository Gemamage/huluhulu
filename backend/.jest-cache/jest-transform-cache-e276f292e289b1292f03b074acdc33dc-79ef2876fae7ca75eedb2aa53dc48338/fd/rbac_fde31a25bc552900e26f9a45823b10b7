56dceaa731ce9ccf69e6ef54c99dedb4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ROLE_PERMISSIONS = exports.Permission = void 0;
exports.hasPermission = hasPermission;
exports.hasAnyPermission = hasAnyPermission;
exports.hasAllPermissions = hasAllPermissions;
exports.requirePermission = requirePermission;
exports.requireAnyPermission = requireAnyPermission;
exports.requireAllPermissions = requireAllPermissions;
exports.requireOwnershipOrPermission = requireOwnershipOrPermission;
exports.requireRole = requireRole;
exports.requireActiveAccount = requireActiveAccount;
exports.requireEmailVerification = requireEmailVerification;
exports.requireAuthAndPermission = requireAuthAndPermission;
exports.getUserPermissions = getUserPermissions;
exports.canAccessResource = canAccessResource;
const errors_1 = require("../utils/errors");
// 定義權限枚舉
var Permission;
(function (Permission) {
    // 用戶管理
    Permission["USER_READ"] = "user:read";
    Permission["USER_WRITE"] = "user:write";
    Permission["USER_DELETE"] = "user:delete";
    Permission["USER_ADMIN"] = "user:admin";
    // 寵物管理
    Permission["PET_READ"] = "pet:read";
    Permission["PET_WRITE"] = "pet:write";
    Permission["PET_DELETE"] = "pet:delete";
    Permission["PET_MODERATE"] = "pet:moderate";
    // 案件管理
    Permission["CASE_READ"] = "case:read";
    Permission["CASE_WRITE"] = "case:write";
    Permission["CASE_DELETE"] = "case:delete";
    Permission["CASE_MODERATE"] = "case:moderate";
    // 系統管理
    Permission["SYSTEM_CONFIG"] = "system:config";
    Permission["SYSTEM_LOGS"] = "system:logs";
    Permission["SYSTEM_BACKUP"] = "system:backup";
    // 內容管理
    Permission["CONTENT_MODERATE"] = "content:moderate";
    Permission["CONTENT_DELETE"] = "content:delete";
    // 報告和分析
    Permission["ANALYTICS_READ"] = "analytics:read";
    Permission["REPORTS_GENERATE"] = "reports:generate";
})(Permission || (exports.Permission = Permission = {}));
// 定義角色和對應權限
exports.ROLE_PERMISSIONS = {
    user: [
        Permission.USER_READ,
        Permission.PET_READ,
        Permission.CASE_READ,
        Permission.CASE_WRITE,
    ],
    moderator: [
        Permission.USER_READ,
        Permission.PET_READ,
        Permission.PET_WRITE,
        Permission.PET_MODERATE,
        Permission.CASE_READ,
        Permission.CASE_WRITE,
        Permission.CASE_MODERATE,
        Permission.CONTENT_MODERATE,
    ],
    admin: [
        Permission.USER_READ,
        Permission.USER_WRITE,
        Permission.USER_DELETE,
        Permission.USER_ADMIN,
        Permission.PET_READ,
        Permission.PET_WRITE,
        Permission.PET_DELETE,
        Permission.PET_MODERATE,
        Permission.CASE_READ,
        Permission.CASE_WRITE,
        Permission.CASE_DELETE,
        Permission.CASE_MODERATE,
        Permission.SYSTEM_CONFIG,
        Permission.SYSTEM_LOGS,
        Permission.SYSTEM_BACKUP,
        Permission.CONTENT_MODERATE,
        Permission.CONTENT_DELETE,
        Permission.ANALYTICS_READ,
        Permission.REPORTS_GENERATE,
    ],
};
// 檢查用戶是否有特定權限
function hasPermission(user, permission) {
    const userPermissions = exports.ROLE_PERMISSIONS[user.role] || [];
    return userPermissions.includes(permission);
}
// 檢查用戶是否有任一權限
function hasAnyPermission(user, permissions) {
    return permissions.some(permission => hasPermission(user, permission));
}
// 檢查用戶是否有所有權限
function hasAllPermissions(user, permissions) {
    return permissions.every(permission => hasPermission(user, permission));
}
// 權限檢查中介軟體
function requirePermission(permission) {
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError('未授權訪問', 401);
        }
        if (!hasPermission(user, permission)) {
            throw new errors_1.AppError('權限不足', 403);
        }
        next();
    };
}
// 多權限檢查中介軟體（需要任一權限）
function requireAnyPermission(permissions) {
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError('未授權訪問', 401);
        }
        if (!hasAnyPermission(user, permissions)) {
            throw new errors_1.AppError('權限不足', 403);
        }
        next();
    };
}
// 多權限檢查中介軟體（需要所有權限）
function requireAllPermissions(permissions) {
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError('未授權訪問', 401);
        }
        if (!hasAllPermissions(user, permissions)) {
            throw new errors_1.AppError('權限不足', 403);
        }
        next();
    };
}
// 資源擁有者或管理員檢查
function requireOwnershipOrPermission(permission) {
    return (req, res, next) => {
        const user = req.user;
        const resourceUserId = req.params.userId || req.params.id;
        if (!user) {
            throw new errors_1.AppError('未授權訪問', 401);
        }
        // 檢查是否為資源擁有者
        const isOwner = user._id.toString() === resourceUserId;
        // 檢查是否有管理權限
        const hasAdminPermission = hasPermission(user, permission);
        if (!isOwner && !hasAdminPermission) {
            throw new errors_1.AppError('權限不足', 403);
        }
        next();
    };
}
// 角色檢查中介軟體
function requireRole(roles) {
    const allowedRoles = Array.isArray(roles) ? roles : [roles];
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError('未授權訪問', 401);
        }
        if (!allowedRoles.includes(user.role)) {
            throw new errors_1.AppError('角色權限不足', 403);
        }
        next();
    };
}
// 帳號狀態檢查中介軟體
function requireActiveAccount(req, res, next) {
    const user = req.user;
    if (!user) {
        throw new errors_1.AppError('未授權訪問', 401);
    }
    if (!user.isActive) {
        throw new errors_1.AppError('帳號已被停用', 403);
    }
    next();
}
// 郵箱驗證檢查中介軟體
function requireEmailVerification(req, res, next) {
    const user = req.user;
    if (!user) {
        throw new errors_1.AppError('未授權訪問', 401);
    }
    if (!user.isEmailVerified) {
        throw new errors_1.AppError('請先驗證您的電子郵件', 403);
    }
    next();
}
// 組合中介軟體：檢查認證、帳號狀態和權限
function requireAuthAndPermission(permission) {
    return [
        requireActiveAccount,
        requireEmailVerification,
        requirePermission(permission)
    ];
}
// 獲取用戶權限列表
function getUserPermissions(user) {
    return exports.ROLE_PERMISSIONS[user.role] || [];
}
// 檢查用戶是否可以訪問資源
function canAccessResource(user, resourceOwnerId, requiredPermission) {
    // 檢查是否為資源擁有者
    if (user._id.toString() === resourceOwnerId) {
        return true;
    }
    // 檢查是否有管理權限
    if (requiredPermission && hasPermission(user, requiredPermission)) {
        return true;
    }
    return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXG1pZGRsZXdhcmVcXHJiYWMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBZ0ZBLHNDQUdDO0FBR0QsNENBRUM7QUFHRCw4Q0FFQztBQUdELDhDQWNDO0FBR0Qsb0RBY0M7QUFHRCxzREFjQztBQUdELG9FQXFCQztBQUdELGtDQWdCQztBQUdELG9EQVlDO0FBR0QsNERBWUM7QUFHRCw0REFNQztBQUdELGdEQUVDO0FBR0QsOENBZ0JDO0FBeFBELDRDQUEyQztBQUUzQyxTQUFTO0FBQ1QsSUFBWSxVQStCWDtBQS9CRCxXQUFZLFVBQVU7SUFDcEIsT0FBTztJQUNQLHFDQUF1QixDQUFBO0lBQ3ZCLHVDQUF5QixDQUFBO0lBQ3pCLHlDQUEyQixDQUFBO0lBQzNCLHVDQUF5QixDQUFBO0lBRXpCLE9BQU87SUFDUCxtQ0FBcUIsQ0FBQTtJQUNyQixxQ0FBdUIsQ0FBQTtJQUN2Qix1Q0FBeUIsQ0FBQTtJQUN6QiwyQ0FBNkIsQ0FBQTtJQUU3QixPQUFPO0lBQ1AscUNBQXVCLENBQUE7SUFDdkIsdUNBQXlCLENBQUE7SUFDekIseUNBQTJCLENBQUE7SUFDM0IsNkNBQStCLENBQUE7SUFFL0IsT0FBTztJQUNQLDZDQUErQixDQUFBO0lBQy9CLHlDQUEyQixDQUFBO0lBQzNCLDZDQUErQixDQUFBO0lBRS9CLE9BQU87SUFDUCxtREFBcUMsQ0FBQTtJQUNyQywrQ0FBaUMsQ0FBQTtJQUVqQyxRQUFRO0lBQ1IsK0NBQWlDLENBQUE7SUFDakMsbURBQXFDLENBQUE7QUFDdkMsQ0FBQyxFQS9CVyxVQUFVLDBCQUFWLFVBQVUsUUErQnJCO0FBRUQsWUFBWTtBQUNDLFFBQUEsZ0JBQWdCLEdBQWlDO0lBQzVELElBQUksRUFBRTtRQUNKLFVBQVUsQ0FBQyxTQUFTO1FBQ3BCLFVBQVUsQ0FBQyxRQUFRO1FBQ25CLFVBQVUsQ0FBQyxTQUFTO1FBQ3BCLFVBQVUsQ0FBQyxVQUFVO0tB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RSxDQUFDO1FBQ2xFLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xcbWlkZGxld2FyZVxccmJhYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBJVXNlciB9IGZyb20gJy4uL21vZGVscy9Vc2VyJztcbmltcG9ydCB7IEFwcEVycm9yIH0gZnJvbSAnLi4vdXRpbHMvZXJyb3JzJztcblxuLy8g5a6a576p5qyK6ZmQ5p6a6IiJXG5leHBvcnQgZW51bSBQZXJtaXNzaW9uIHtcbiAgLy8g55So5oi2566h55CGXG4gIFVTRVJfUkVBRCA9ICd1c2VyOnJlYWQnLFxuICBVU0VSX1dSSVRFID0gJ3VzZXI6d3JpdGUnLFxuICBVU0VSX0RFTEVURSA9ICd1c2VyOmRlbGV0ZScsXG4gIFVTRVJfQURNSU4gPSAndXNlcjphZG1pbicsXG4gIFxuICAvLyDlr7XniannrqHnkIZcbiAgUEVUX1JFQUQgPSAncGV0OnJlYWQnLFxuICBQRVRfV1JJVEUgPSAncGV0OndyaXRlJyxcbiAgUEVUX0RFTEVURSA9ICdwZXQ6ZGVsZXRlJyxcbiAgUEVUX01PREVSQVRFID0gJ3BldDptb2RlcmF0ZScsXG4gIFxuICAvLyDmoYjku7bnrqHnkIZcbiAgQ0FTRV9SRUFEID0gJ2Nhc2U6cmVhZCcsXG4gIENBU0VfV1JJVEUgPSAnY2FzZTp3cml0ZScsXG4gIENBU0VfREVMRVRFID0gJ2Nhc2U6ZGVsZXRlJyxcbiAgQ0FTRV9NT0RFUkFURSA9ICdjYXNlOm1vZGVyYXRlJyxcbiAgXG4gIC8vIOezu+e1seeuoeeQhlxuICBTWVNURU1fQ09ORklHID0gJ3N5c3RlbTpjb25maWcnLFxuICBTWVNURU1fTE9HUyA9ICdzeXN0ZW06bG9ncycsXG4gIFNZU1RFTV9CQUNLVVAgPSAnc3lzdGVtOmJhY2t1cCcsXG4gIFxuICAvLyDlhaflrrnnrqHnkIZcbiAgQ09OVEVOVF9NT0RFUkFURSA9ICdjb250ZW50Om1vZGVyYXRlJyxcbiAgQ09OVEVOVF9ERUxFVEUgPSAnY29udGVudDpkZWxldGUnLFxuICBcbiAgLy8g5aCx5ZGK5ZKM5YiG5p6QXG4gIEFOQUxZVElDU19SRUFEID0gJ2FuYWx5dGljczpyZWFkJyxcbiAgUkVQT1JUU19HRU5FUkFURSA9ICdyZXBvcnRzOmdlbmVyYXRlJyxcbn1cblxuLy8g5a6a576p6KeS6Imy5ZKM5bCN5oeJ5qyK6ZmQXG5leHBvcnQgY29uc3QgUk9MRV9QRVJNSVNTSU9OUzogUmVjb3JkPHN0cmluZywgUGVybWlzc2lvbltdPiA9IHtcbiAgdXNlcjogW1xuICAgIFBlcm1pc3Npb24uVVNFUl9SRUFELFxuICAgIFBlcm1pc3Npb24uUEVUX1JFQUQsXG4gICAgUGVybWlzc2lvbi5DQVNFX1JFQUQsXG4gICAgUGVybWlzc2lvbi5DQVNFX1dSSVRFLFxuICBdLFxuICBtb2RlcmF0b3I6IFtcbiAgICBQZXJtaXNzaW9uLlVTRVJfUkVBRCxcbiAgICBQZXJtaXNzaW9uLlBFVF9SRUFELFxuICAgIFBlcm1pc3Npb24uUEVUX1dSSVRFLFxuICAgIFBlcm1pc3Npb24uUEVUX01PREVSQVRFLFxuICAgIFBlcm1pc3Npb24uQ0FTRV9SRUFELFxuICAgIFBlcm1pc3Npb24uQ0FTRV9XUklURSxcbiAgICBQZXJtaXNzaW9uLkNBU0VfTU9ERVJBVEUsXG4gICAgUGVybWlzc2lvbi5DT05URU5UX01PREVSQVRFLFxuICBdLFxuICBhZG1pbjogW1xuICAgIFBlcm1pc3Npb24uVVNFUl9SRUFELFxuICAgIFBlcm1pc3Npb24uVVNFUl9XUklURSxcbiAgICBQZXJtaXNzaW9uLlVTRVJfREVMRVRFLFxuICAgIFBlcm1pc3Npb24uVVNFUl9BRE1JTixcbiAgICBQZXJtaXNzaW9uLlBFVF9SRUFELFxuICAgIFBlcm1pc3Npb24uUEVUX1dSSVRFLFxuICAgIFBlcm1pc3Npb24uUEVUX0RFTEVURSxcbiAgICBQZXJtaXNzaW9uLlBFVF9NT0RFUkFURSxcbiAgICBQZXJtaXNzaW9uLkNBU0VfUkVBRCxcbiAgICBQZXJtaXNzaW9uLkNBU0VfV1JJVEUsXG4gICAgUGVybWlzc2lvbi5DQVNFX0RFTEVURSxcbiAgICBQZXJtaXNzaW9uLkNBU0VfTU9ERVJBVEUsXG4gICAgUGVybWlzc2lvbi5TWVNURU1fQ09ORklHLFxuICAgIFBlcm1pc3Npb24uU1lTVEVNX0xPR1MsXG4gICAgUGVybWlzc2lvbi5TWVNURU1fQkFDS1VQLFxuICAgIFBlcm1pc3Npb24uQ09OVEVOVF9NT0RFUkFURSxcbiAgICBQZXJtaXNzaW9uLkNPTlRFTlRfREVMRVRFLFxuICAgIFBlcm1pc3Npb24uQU5BTFlUSUNTX1JFQUQsXG4gICAgUGVybWlzc2lvbi5SRVBPUlRTX0dFTkVSQVRFLFxuICBdLFxufTtcblxuLy8g5qqi5p+l55So5oi25piv5ZCm5pyJ54m55a6a5qyK6ZmQXG5leHBvcnQgZnVuY3Rpb24gaGFzUGVybWlzc2lvbih1c2VyOiBJVXNlciwgcGVybWlzc2lvbjogUGVybWlzc2lvbik6IGJvb2xlYW4ge1xuICBjb25zdCB1c2VyUGVybWlzc2lvbnMgPSBST0xFX1BFUk1JU1NJT05TW3VzZXIucm9sZV0gfHwgW107XG4gIHJldHVybiB1c2VyUGVybWlzc2lvbnMuaW5jbHVkZXMocGVybWlzc2lvbik7XG59XG5cbi8vIOaqouafpeeUqOaItuaYr+WQpuacieS7u+S4gOasiumZkFxuZXhwb3J0IGZ1bmN0aW9uIGhhc0FueVBlcm1pc3Npb24odXNlcjogSVVzZXIsIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uW10pOiBib29sZWFuIHtcbiAgcmV0dXJuIHBlcm1pc3Npb25zLnNvbWUocGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uKHVzZXIsIHBlcm1pc3Npb24pKTtcbn1cblxuLy8g5qqi5p+l55So5oi25piv5ZCm5pyJ5omA5pyJ5qyK6ZmQXG5leHBvcnQgZnVuY3Rpb24gaGFzQWxsUGVybWlzc2lvbnModXNlcjogSVVzZXIsIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uW10pOiBib29sZWFuIHtcbiAgcmV0dXJuIHBlcm1pc3Npb25zLmV2ZXJ5KHBlcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbih1c2VyLCBwZXJtaXNzaW9uKSk7XG59XG5cbi8vIOasiumZkOaqouafpeS4reS7i+i7n+mrlFxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVQZXJtaXNzaW9uKHBlcm1pc3Npb246IFBlcm1pc3Npb24pIHtcbiAgcmV0dXJuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHVzZXIgPSAocmVxLnVzZXIgYXMgSVVzZXIpO1xuICAgIFxuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IEFwcEVycm9yKCfmnKrmjojmrIroqKrllY8nLCA0MDEpO1xuICAgIH1cbiAgICBcbiAgICBpZiAoIWhhc1Blcm1pc3Npb24odXNlciwgcGVybWlzc2lvbikpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcign5qyK6ZmQ5LiN6LazJywgNDAzKTtcbiAgICB9XG4gICAgXG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vLyDlpJrmrIrpmZDmqqLmn6XkuK3ku4vou5/pq5TvvIjpnIDopoHku7vkuIDmrIrpmZDvvIlcbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQW55UGVybWlzc2lvbihwZXJtaXNzaW9uczogUGVybWlzc2lvbltdKSB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkID0+IHtcbiAgICBjb25zdCB1c2VyID0gKHJlcS51c2VyIGFzIElVc2VyKTtcbiAgICBcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcign5pyq5o6I5qyK6Kiq5ZWPJywgNDAxKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKCFoYXNBbnlQZXJtaXNzaW9uKHVzZXIsIHBlcm1pc3Npb25zKSkge1xuICAgICAgdGhyb3cgbmV3IEFwcEVycm9yKCfmrIrpmZDkuI3otrMnLCA0MDMpO1xuICAgIH1cbiAgICBcbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIOWkmuasiumZkOaqouafpeS4reS7i+i7n+mrlO+8iOmcgOimgeaJgOacieasiumZkO+8iVxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVBbGxQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbltdKSB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkID0+IHtcbiAgICBjb25zdCB1c2VyID0gKHJlcS51c2VyIGFzIElVc2VyKTtcbiAgICBcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcign5pyq5o6I5qyK6Kiq5ZWPJywgNDAxKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKCFoYXNBbGxQZXJtaXNzaW9ucyh1c2VyLCBwZXJtaXNzaW9ucykpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcign5qyK6ZmQ5LiN6LazJywgNDAzKTtcbiAgICB9XG4gICAgXG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vLyDos4fmupDmk4HmnInogIXmiJbnrqHnkIblk6HmqqLmn6VcbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlT3duZXJzaGlwT3JQZXJtaXNzaW9uKHBlcm1pc3Npb246IFBlcm1pc3Npb24pIHtcbiAgcmV0dXJuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHVzZXIgPSAocmVxLnVzZXIgYXMgSVVzZXIpO1xuICAgIGNvbnN0IHJlc291cmNlVXNlcklkID0gcmVxLnBhcmFtcy51c2VySWQgfHwgcmVxLnBhcmFtcy5pZDtcbiAgICBcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcign5pyq5o6I5qyK6Kiq5ZWPJywgNDAxKTtcbiAgICB9XG4gICAgXG4gICAgLy8g5qqi5p+l5piv5ZCm54K66LOH5rqQ5pOB5pyJ6ICFXG4gICAgY29uc3QgaXNPd25lciA9IHVzZXIuX2lkLnRvU3RyaW5nKCkgPT09IHJlc291cmNlVXNlcklkO1xuICAgIFxuICAgIC8vIOaqouafpeaYr+WQpuacieeuoeeQhuasiumZkFxuICAgIGNvbnN0IGhhc0FkbWluUGVybWlzc2lvbiA9IGhhc1Blcm1pc3Npb24odXNlciwgcGVybWlzc2lvbik7XG4gICAgXG4gICAgaWYgKCFpc093bmVyICYmICFoYXNBZG1pblBlcm1pc3Npb24pIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcign5qyK6ZmQ5LiN6LazJywgNDAzKTtcbiAgICB9XG4gICAgXG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vLyDop5LoibLmqqLmn6XkuK3ku4vou5/pq5RcbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlUm9sZShyb2xlczogc3RyaW5nIHwgc3RyaW5nW10pIHtcbiAgY29uc3QgYWxsb3dlZFJvbGVzID0gQXJyYXkuaXNBcnJheShyb2xlcykgPyByb2xlcyA6IFtyb2xlc107XG4gIFxuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgY29uc3QgdXNlciA9IChyZXEudXNlciBhcyBJVXNlcik7XG4gICAgXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoJ+acquaOiOasiuioquWVjycsIDQwMSk7XG4gICAgfVxuICAgIFxuICAgIGlmICghYWxsb3dlZFJvbGVzLmluY2x1ZGVzKHVzZXIucm9sZSkpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcign6KeS6Imy5qyK6ZmQ5LiN6LazJywgNDAzKTtcbiAgICB9XG4gICAgXG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vLyDluLPomZ/ni4DmhYvmqqLmn6XkuK3ku4vou5/pq5RcbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQWN0aXZlQWNjb3VudChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICBjb25zdCB1c2VyID0gKHJlcS51c2VyIGFzIElVc2VyKTtcbiAgXG4gIGlmICghdXNlcikge1xuICAgIHRocm93IG5ldyBBcHBFcnJvcign5pyq5o6I5qyK6Kiq5ZWPJywgNDAxKTtcbiAgfVxuICBcbiAgaWYgKCF1c2VyLmlzQWN0aXZlKSB7XG4gICAgdGhyb3cgbmV3IEFwcEVycm9yKCfluLPomZ/lt7LooqvlgZznlKgnLCA0MDMpO1xuICB9XG4gIFxuICBuZXh0KCk7XG59XG5cbi8vIOmDteeusempl+itieaqouafpeS4reS7i+i7n+mrlFxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVFbWFpbFZlcmlmaWNhdGlvbihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQge1xuICBjb25zdCB1c2VyID0gKHJlcS51c2VyIGFzIElVc2VyKTtcbiAgXG4gIGlmICghdXNlcikge1xuICAgIHRocm93IG5ldyBBcHBFcnJvcign5pyq5o6I5qyK6Kiq5ZWPJywgNDAxKTtcbiAgfVxuICBcbiAgaWYgKCF1c2VyLmlzRW1haWxWZXJpZmllZCkge1xuICAgIHRocm93IG5ldyBBcHBFcnJvcign6KuL5YWI6amX6K2J5oKo55qE6Zu75a2Q6YO15Lu2JywgNDAzKTtcbiAgfVxuICBcbiAgbmV4dCgpO1xufVxuXG4vLyDntYTlkIjkuK3ku4vou5/pq5TvvJrmqqLmn6Xoqo3orYnjgIHluLPomZ/ni4DmhYvlkozmrIrpmZBcbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQXV0aEFuZFBlcm1pc3Npb24ocGVybWlzc2lvbjogUGVybWlzc2lvbikge1xuICByZXR1cm4gW1xuICAgIHJlcXVpcmVBY3RpdmVBY2NvdW50LFxuICAgIHJlcXVpcmVFbWFpbFZlcmlmaWNhdGlvbixcbiAgICByZXF1aXJlUGVybWlzc2lvbihwZXJtaXNzaW9uKVxuICBdO1xufVxuXG4vLyDnjbLlj5bnlKjmiLbmrIrpmZDliJfooahcbmV4cG9ydCBmdW5jdGlvbiBnZXRVc2VyUGVybWlzc2lvbnModXNlcjogSVVzZXIpOiBQZXJtaXNzaW9uW10ge1xuICByZXR1cm4gUk9MRV9QRVJNSVNTSU9OU1t1c2VyLnJvbGVdIHx8IFtdO1xufVxuXG4vLyDmqqLmn6XnlKjmiLbmmK/lkKblj6/ku6XoqKrllY/os4fmupBcbmV4cG9ydCBmdW5jdGlvbiBjYW5BY2Nlc3NSZXNvdXJjZShcbiAgdXNlcjogSVVzZXIsIFxuICByZXNvdXJjZU93bmVySWQ6IHN0cmluZywgXG4gIHJlcXVpcmVkUGVybWlzc2lvbj86IFBlcm1pc3Npb25cbik6IGJvb2xlYW4ge1xuICAvLyDmqqLmn6XmmK/lkKbngrros4fmupDmk4HmnInogIVcbiAgaWYgKHVzZXIuX2lkLnRvU3RyaW5nKCkgPT09IHJlc291cmNlT3duZXJJZCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIFxuICAvLyDmqqLmn6XmmK/lkKbmnInnrqHnkIbmrIrpmZBcbiAgaWYgKHJlcXVpcmVkUGVybWlzc2lvbiAmJiBoYXNQZXJtaXNzaW9uKHVzZXIsIHJlcXVpcmVkUGVybWlzc2lvbikpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBcbiAgcmV0dXJuIGZhbHNlO1xufSJdLCJ2ZXJzaW9uIjozfQ==