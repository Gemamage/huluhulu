{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\middleware\\rbac.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\middleware\\rbac.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { IUser } from '../models/User';\nimport { AppError } from '../utils/errors';\n\n// 定義權限枚舉\nexport enum Permission {\n  // 用戶管理\n  USER_READ = 'user:read',\n  USER_WRITE = 'user:write',\n  USER_DELETE = 'user:delete',\n  USER_ADMIN = 'user:admin',\n  \n  // 寵物管理\n  PET_READ = 'pet:read',\n  PET_WRITE = 'pet:write',\n  PET_DELETE = 'pet:delete',\n  PET_MODERATE = 'pet:moderate',\n  \n  // 案件管理\n  CASE_READ = 'case:read',\n  CASE_WRITE = 'case:write',\n  CASE_DELETE = 'case:delete',\n  CASE_MODERATE = 'case:moderate',\n  \n  // 系統管理\n  SYSTEM_CONFIG = 'system:config',\n  SYSTEM_LOGS = 'system:logs',\n  SYSTEM_BACKUP = 'system:backup',\n  \n  // 內容管理\n  CONTENT_MODERATE = 'content:moderate',\n  CONTENT_DELETE = 'content:delete',\n  \n  // 報告和分析\n  ANALYTICS_READ = 'analytics:read',\n  REPORTS_GENERATE = 'reports:generate',\n}\n\n// 定義角色和對應權限\nexport const ROLE_PERMISSIONS: Record<string, Permission[]> = {\n  user: [\n    Permission.USER_READ,\n    Permission.PET_READ,\n    Permission.CASE_READ,\n    Permission.CASE_WRITE,\n  ],\n  moderator: [\n    Permission.USER_READ,\n    Permission.PET_READ,\n    Permission.PET_WRITE,\n    Permission.PET_MODERATE,\n    Permission.CASE_READ,\n    Permission.CASE_WRITE,\n    Permission.CASE_MODERATE,\n    Permission.CONTENT_MODERATE,\n  ],\n  admin: [\n    Permission.USER_READ,\n    Permission.USER_WRITE,\n    Permission.USER_DELETE,\n    Permission.USER_ADMIN,\n    Permission.PET_READ,\n    Permission.PET_WRITE,\n    Permission.PET_DELETE,\n    Permission.PET_MODERATE,\n    Permission.CASE_READ,\n    Permission.CASE_WRITE,\n    Permission.CASE_DELETE,\n    Permission.CASE_MODERATE,\n    Permission.SYSTEM_CONFIG,\n    Permission.SYSTEM_LOGS,\n    Permission.SYSTEM_BACKUP,\n    Permission.CONTENT_MODERATE,\n    Permission.CONTENT_DELETE,\n    Permission.ANALYTICS_READ,\n    Permission.REPORTS_GENERATE,\n  ],\n};\n\n// 檢查用戶是否有特定權限\nexport function hasPermission(user: IUser, permission: Permission): boolean {\n  const userPermissions = ROLE_PERMISSIONS[user.role] || [];\n  return userPermissions.includes(permission);\n}\n\n// 檢查用戶是否有任一權限\nexport function hasAnyPermission(user: IUser, permissions: Permission[]): boolean {\n  return permissions.some(permission => hasPermission(user, permission));\n}\n\n// 檢查用戶是否有所有權限\nexport function hasAllPermissions(user: IUser, permissions: Permission[]): boolean {\n  return permissions.every(permission => hasPermission(user, permission));\n}\n\n// 權限檢查中介軟體\nexport function requirePermission(permission: Permission) {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    const user = (req.user as IUser);\n    \n    if (!user) {\n      throw new AppError('未授權訪問', 401);\n    }\n    \n    if (!hasPermission(user, permission)) {\n      throw new AppError('權限不足', 403);\n    }\n    \n    next();\n  };\n}\n\n// 多權限檢查中介軟體（需要任一權限）\nexport function requireAnyPermission(permissions: Permission[]) {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    const user = (req.user as IUser);\n    \n    if (!user) {\n      throw new AppError('未授權訪問', 401);\n    }\n    \n    if (!hasAnyPermission(user, permissions)) {\n      throw new AppError('權限不足', 403);\n    }\n    \n    next();\n  };\n}\n\n// 多權限檢查中介軟體（需要所有權限）\nexport function requireAllPermissions(permissions: Permission[]) {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    const user = (req.user as IUser);\n    \n    if (!user) {\n      throw new AppError('未授權訪問', 401);\n    }\n    \n    if (!hasAllPermissions(user, permissions)) {\n      throw new AppError('權限不足', 403);\n    }\n    \n    next();\n  };\n}\n\n// 資源擁有者或管理員檢查\nexport function requireOwnershipOrPermission(permission: Permission) {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    const user = (req.user as IUser);\n    const resourceUserId = req.params.userId || req.params.id;\n    \n    if (!user) {\n      throw new AppError('未授權訪問', 401);\n    }\n    \n    // 檢查是否為資源擁有者\n    const isOwner = user._id.toString() === resourceUserId;\n    \n    // 檢查是否有管理權限\n    const hasAdminPermission = hasPermission(user, permission);\n    \n    if (!isOwner && !hasAdminPermission) {\n      throw new AppError('權限不足', 403);\n    }\n    \n    next();\n  };\n}\n\n// 角色檢查中介軟體\nexport function requireRole(roles: string | string[]) {\n  const allowedRoles = Array.isArray(roles) ? roles : [roles];\n  \n  return (req: Request, res: Response, next: NextFunction): void => {\n    const user = (req.user as IUser);\n    \n    if (!user) {\n      throw new AppError('未授權訪問', 401);\n    }\n    \n    if (!allowedRoles.includes(user.role)) {\n      throw new AppError('角色權限不足', 403);\n    }\n    \n    next();\n  };\n}\n\n// 帳號狀態檢查中介軟體\nexport function requireActiveAccount(req: Request, res: Response, next: NextFunction): void {\n  const user = (req.user as IUser);\n  \n  if (!user) {\n    throw new AppError('未授權訪問', 401);\n  }\n  \n  if (!user.isActive) {\n    throw new AppError('帳號已被停用', 403);\n  }\n  \n  next();\n}\n\n// 郵箱驗證檢查中介軟體\nexport function requireEmailVerification(req: Request, res: Response, next: NextFunction): void {\n  const user = (req.user as IUser);\n  \n  if (!user) {\n    throw new AppError('未授權訪問', 401);\n  }\n  \n  if (!user.isEmailVerified) {\n    throw new AppError('請先驗證您的電子郵件', 403);\n  }\n  \n  next();\n}\n\n// 組合中介軟體：檢查認證、帳號狀態和權限\nexport function requireAuthAndPermission(permission: Permission) {\n  return [\n    requireActiveAccount,\n    requireEmailVerification,\n    requirePermission(permission)\n  ];\n}\n\n// 獲取用戶權限列表\nexport function getUserPermissions(user: IUser): Permission[] {\n  return ROLE_PERMISSIONS[user.role] || [];\n}\n\n// 檢查用戶是否可以訪問資源\nexport function canAccessResource(\n  user: IUser, \n  resourceOwnerId: string, \n  requiredPermission?: Permission\n): boolean {\n  // 檢查是否為資源擁有者\n  if (user._id.toString() === resourceOwnerId) {\n    return true;\n  }\n  \n  // 檢查是否有管理權限\n  if (requiredPermission && hasPermission(user, requiredPermission)) {\n    return true;\n  }\n  \n  return false;\n}"],"version":3}