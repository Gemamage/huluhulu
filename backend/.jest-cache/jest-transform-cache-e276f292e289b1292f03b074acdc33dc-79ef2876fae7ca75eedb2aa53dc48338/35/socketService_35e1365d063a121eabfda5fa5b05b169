cd1d83b08c181c4b282a2ca86cd5b98c
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SocketService = exports.SocketEvents = void 0;
const socket_io_1 = require("socket.io");
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const environment_1 = require("../config/environment");
const logger_1 = require("../utils/logger");
/**
 * Socket 事件類型
 */
var SocketEvents;
(function (SocketEvents) {
    // 連接相關
    SocketEvents["CONNECTION"] = "connection";
    SocketEvents["DISCONNECT"] = "disconnect";
    SocketEvents["JOIN_ROOM"] = "join_room";
    SocketEvents["LEAVE_ROOM"] = "leave_room";
    // 通知相關
    SocketEvents["NOTIFICATION"] = "notification";
    SocketEvents["NOTIFICATION_READ"] = "notification_read";
    SocketEvents["NOTIFICATION_DELIVERED"] = "notification_delivered";
    // 聊天相關
    SocketEvents["MESSAGE"] = "message";
    SocketEvents["MESSAGE_DELIVERED"] = "message_delivered";
    SocketEvents["MESSAGE_READ"] = "message_read";
    SocketEvents["TYPING_START"] = "typing_start";
    SocketEvents["TYPING_STOP"] = "typing_stop";
    // 寵物協尋相關
    SocketEvents["PET_STATUS_UPDATE"] = "pet_status_update";
    SocketEvents["MATCH_FOUND"] = "match_found";
    // 系統相關
    SocketEvents["SYSTEM_ANNOUNCEMENT"] = "system_announcement";
    SocketEvents["USER_ONLINE"] = "user_online";
    SocketEvents["USER_OFFLINE"] = "user_offline";
})(SocketEvents || (exports.SocketEvents = SocketEvents = {}));
/**
 * Socket 服務類別
 */
class SocketService {
    /**
     * 初始化 Socket.IO 服務
     */
    static initialize(httpServer) {
        this.io = new socket_io_1.Server(httpServer, {
            cors: {
                origin: environment_1.config.cors.allowedOrigins,
                methods: ['GET', 'POST'],
                credentials: true,
            },
            transports: ['websocket', 'polling'],
        });
        // 中介軟體：驗證 JWT Token
        this.io.use(async (socket, next) => {
            try {
                const token = socket.handshake.auth.token || socket.handshake.headers.authorization?.replace('Bearer ', '');
                if (!token) {
                    return next(new Error('未提供認證 token'));
                }
                const decoded = jsonwebtoken_1.default.verify(token, environment_1.config.jwt.secret);
                socket.data.userId = decoded.userId;
                socket.data.user = decoded;
                next();
            }
            catch (error) {
                logger_1.logger.error('Socket 認證失敗', { error });
                next(new Error('認證失敗'));
            }
        });
        // 處理連接事件
        this.io.on(SocketEvents.CONNECTION, (socket) => {
            this.handleConnection(socket);
        });
        logger_1.logger.info('Socket.IO 服務初始化成功');
        return this.io;
    }
    /**
     * 處理用戶連接
     */
    static handleConnection(socket) {
        const userId = socket.data.userId;
        const socketInfo = {
            userId,
            socketId: socket.id,
            connectedAt: new Date(),
            lastActivity: new Date(),
        };
        // 記錄用戶 socket 連接
        if (!this.userSockets.has(userId)) {
            this.userSockets.set(userId, []);
        }
        this.userSockets.get(userId).push(socketInfo);
        this.socketUsers.set(socket.id, userId);
        // 加入用戶個人房間
        socket.join(`user:${userId}`);
        logger_1.logger.info('用戶連接成功', {
            userId,
            socketId: socket.id,
            totalConnections: this.userSockets.get(userId).length,
        });
        // 通知其他用戶該用戶上線
        socket.broadcast.emit(SocketEvents.USER_ONLINE, {
            userId,
            timestamp: new Date(),
        });
        // 處理加入房間
        socket.on(SocketEvents.JOIN_ROOM, (roomId) => {
            socket.join(roomId);
            logger_1.logger.debug('用戶加入房間', { userId, socketId: socket.id, roomId });
        });
        // 處理離開房間
        socket.on(SocketEvents.LEAVE_ROOM, (roomId) => {
            socket.leave(roomId);
            logger_1.logger.debug('用戶離開房間', { userId, socketId: socket.id, roomId });
        });
        // 處理通知已讀
        socket.on(SocketEvents.NOTIFICATION_READ, (notificationId) => {
            this.handleNotificationRead(userId, notificationId);
        });
        // 處理通知送達確認
        socket.on(SocketEvents.NOTIFICATION_DELIVERED, (notificationId) => {
            this.handleNotificationDelivered(userId, notificationId);
        });
        // 處理訊息相關事件
        socket.on(SocketEvents.MESSAGE, (data) => {
            this.handleMessage(socket, data);
        });
        socket.on(SocketEvents.MESSAGE_READ, (data) => {
            this.handleMessageRead(socket, data);
        });
        socket.on(SocketEvents.TYPING_START, (data) => {
            this.handleTyping(socket, data, true);
        });
        socket.on(SocketEvents.TYPING_STOP, (data) => {
            this.handleTyping(socket, data, false);
        });
        // 處理斷線
        socket.on(SocketEvents.DISCONNECT, (reason) => {
            this.handleDisconnection(socket, reason);
        });
        // 更新最後活動時間
        socket.onAny(() => {
            this.updateLastActivity(userId, socket.id);
        });
    }
    /**
     * 處理用戶斷線
     */
    static handleDisconnection(socket, reason) {
        const userId = this.socketUsers.get(socket.id);
        if (userId) {
            // 移除 socket 記錄
            const userSocketList = this.userSockets.get(userId);
            if (userSocketList) {
                const index = userSocketList.findIndex(info => info.socketId === socket.id);
                if (index !== -1) {
                    userSocketList.splice(index, 1);
                }
                // 如果用戶沒有其他連接，則清理記錄並通知下線
                if (userSocketList.length === 0) {
                    this.userSockets.delete(userId);
                    socket.broadcast.emit(SocketEvents.USER_OFFLINE, {
                        userId,
                        timestamp: new Date(),
                    });
                }
            }
            this.socketUsers.delete(socket.id);
            logger_1.logger.info('用戶斷線', {
                userId,
                socketId: socket.id,
                reason,
                remainingConnections: this.userSockets.get(userId)?.length || 0,
            });
        }
    }
    /**
     * 發送即時通知給特定用戶
     */
    static async sendNotificationToUser(userId, notification) {
        try {
            if (!this.io) {
                logger_1.logger.warn('Socket.IO 尚未初始化');
                return false;
            }
            const room = `user:${userId}`;
            this.io.to(room).emit(SocketEvents.NOTIFICATION, notification);
            logger_1.logger.debug('即時通知已發送', {
                userId,
                notificationId: notification.id,
                type: notification.type,
                title: notification.title,
            });
            return true;
        }
        catch (error) {
            logger_1.logger.error('發送即時通知失敗', { error, userId, notificationId: notification.id });
            return false;
        }
    }
    /**
     * 發送即時通知給多個用戶
     */
    static async sendNotificationToUsers(userIds, notification) {
        let successCount = 0;
        let failureCount = 0;
        for (const userId of userIds) {
            const success = await this.sendNotificationToUser(userId, notification);
            if (success) {
                successCount++;
            }
            else {
                failureCount++;
            }
        }
        return { successCount, failureCount };
    }
    /**
     * 廣播系統公告
     */
    static broadcastSystemAnnouncement(announcement) {
        if (!this.io) {
            logger_1.logger.warn('Socket.IO 尚未初始化');
            return;
        }
        this.io.emit(SocketEvents.SYSTEM_ANNOUNCEMENT, {
            ...announcement,
            timestamp: new Date(),
        });
        logger_1.logger.info('系統公告已廣播', { title: announcement.title });
    }
    /**
     * 發送寵物狀態更新
     */
    static sendPetStatusUpdate(userId, petId, status, message) {
        if (!this.io) {
            logger_1.logger.warn('Socket.IO 尚未初始化');
            return;
        }
        const room = `user:${userId}`;
        this.io.to(room).emit(SocketEvents.PET_STATUS_UPDATE, {
            petId,
            status,
            message,
            timestamp: new Date(),
        });
        logger_1.logger.debug('寵物狀態更新已發送', { userId, petId, status });
    }
    /**
     * 檢查用戶是否在線
     */
    static isUserOnline(userId) {
        return this.userSockets.has(userId) && this.userSockets.get(userId).length > 0;
    }
    /**
     * 取得在線用戶列表
     */
    static getOnlineUsers() {
        return Array.from(this.userSockets.keys());
    }
    /**
     * 取得用戶連接數
     */
    static getUserConnectionCount(userId) {
        return this.userSockets.get(userId)?.length || 0;
    }
    /**
     * 處理通知已讀
     */
    static handleNotificationRead(userId, notificationId) {
        logger_1.logger.debug('通知已讀', { userId, notificationId });
        // 這裡可以更新資料庫中的通知狀態
    }
    /**
     * 處理通知送達確認
     */
    static handleNotificationDelivered(userId, notificationId) {
        logger_1.logger.debug('通知送達確認', { userId, notificationId });
        // 這裡可以更新資料庫中的通知送達狀態
    }
    /**
     * 處理訊息
     */
    static handleMessage(socket, data) {
        const userId = socket.data.userId;
        logger_1.logger.debug('收到訊息', { userId, messageData: data });
        // 轉發訊息給目標用戶
        if (data.targetUserId) {
            const targetRoom = `user:${data.targetUserId}`;
            socket.to(targetRoom).emit(SocketEvents.MESSAGE, {
                ...data,
                fromUserId: userId,
                timestamp: new Date(),
            });
        }
    }
    /**
     * 處理訊息已讀
     */
    static handleMessageRead(socket, data) {
        const userId = socket.data.userId;
        logger_1.logger.debug('訊息已讀', { userId, messageData: data });
        // 通知發送者訊息已被讀取
        if (data.fromUserId) {
            const senderRoom = `user:${data.fromUserId}`;
            socket.to(senderRoom).emit(SocketEvents.MESSAGE_READ, {
                messageId: data.messageId,
                readBy: userId,
                timestamp: new Date(),
            });
        }
    }
    /**
     * 處理輸入狀態
     */
    static handleTyping(socket, data, isTyping) {
        const userId = socket.data.userId;
        if (data.targetUserId) {
            const targetRoom = `user:${data.targetUserId}`;
            const event = isTyping ? SocketEvents.TYPING_START : SocketEvents.TYPING_STOP;
            socket.to(targetRoom).emit(event, {
                fromUserId: userId,
                timestamp: new Date(),
            });
        }
    }
    /**
     * 更新最後活動時間
     */
    static updateLastActivity(userId, socketId) {
        const userSocketList = this.userSockets.get(userId);
        if (userSocketList) {
            const socketInfo = userSocketList.find(info => info.socketId === socketId);
            if (socketInfo) {
                socketInfo.lastActivity = new Date();
            }
        }
    }
    /**
     * 清理非活躍連接
     */
    static cleanupInactiveConnections(inactiveThresholdMinutes = 30) {
        const threshold = new Date(Date.now() - inactiveThresholdMinutes * 60 * 1000);
        let cleanedCount = 0;
        for (const [userId, socketList] of this.userSockets.entries()) {
            const activeConnections = socketList.filter(info => info.lastActivity > threshold);
            if (activeConnections.length !== socketList.length) {
                const inactiveConnections = socketList.filter(info => info.lastActivity <= threshold);
                // 斷開非活躍連接
                inactiveConnections.forEach(info => {
                    const socket = this.io?.sockets.sockets.get(info.socketId);
                    if (socket) {
                        socket.disconnect(true);
                        cleanedCount++;
                    }
                });
                // 更新記錄
                if (activeConnections.length > 0) {
                    this.userSockets.set(userId, activeConnections);
                }
                else {
                    this.userSockets.delete(userId);
                }
            }
        }
        if (cleanedCount > 0) {
            logger_1.logger.info('清理非活躍連接完成', { cleanedCount, thresholdMinutes: inactiveThresholdMinutes });
        }
    }
    /**
     * 取得服務統計資訊
     */
    static getStats() {
        const totalConnections = Array.from(this.userSockets.values())
            .reduce((sum, connections) => sum + connections.length, 0);
        const onlineUsers = this.userSockets.size;
        const averageConnectionsPerUser = onlineUsers > 0 ? totalConnections / onlineUsers : 0;
        return {
            totalConnections,
            onlineUsers,
            averageConnectionsPerUser: Math.round(averageConnectionsPerUser * 100) / 100,
        };
    }
}
exports.SocketService = SocketService;
SocketService.io = null;
SocketService.userSockets = new Map(); // userId -> socket info array
SocketService.socketUsers = new Map(); // socketId -> userId
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxzb2NrZXRTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHlDQUE2RDtBQUU3RCxnRUFBK0I7QUFDL0IsdURBQStDO0FBQy9DLDRDQUF5QztBQUd6Qzs7R0FFRztBQUNILElBQVksWUEyQlg7QUEzQkQsV0FBWSxZQUFZO0lBQ3RCLE9BQU87SUFDUCx5Q0FBeUIsQ0FBQTtJQUN6Qix5Q0FBeUIsQ0FBQTtJQUN6Qix1Q0FBdUIsQ0FBQTtJQUN2Qix5Q0FBeUIsQ0FBQTtJQUV6QixPQUFPO0lBQ1AsNkNBQTZCLENBQUE7SUFDN0IsdURBQXVDLENBQUE7SUFDdkMsaUVBQWlELENBQUE7SUFFakQsT0FBTztJQUNQLG1DQUFtQixDQUFBO0lBQ25CLHVEQUF1QyxDQUFBO0lBQ3ZDLDZDQUE2QixDQUFBO0lBQzdCLDZDQUE2QixDQUFBO0lBQzdCLDJDQUEyQixDQUFBO0lBRTNCLFNBQVM7SUFDVCx1REFBdUMsQ0FBQTtJQUN2QywyQ0FBMkIsQ0FBQTtJQUUzQixPQUFPO0lBQ1AsMkRBQTJDLENBQUE7SUFDM0MsMkNBQTJCLENBQUE7SUFDM0IsNkNBQTZCLENBQUE7QUFDL0IsQ0FBQyxFQTNCVyxZQUFZLDRCQUFaLFlBQVksUUEyQnZCO0FBMkJEOztHQUVHO0FBQ0gsTUFBYSxhQUFhO0lBS3hCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFzQjtRQUN0QyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksa0JBQWMsQ0FBQyxVQUFVLEVBQUU7WUFDdkMsSUFBSSxFQUFFO2dCQUNKLE1BQU0sRUFBRSxvQkFBTSxDQUFDLElBQUksQ0FBQyxjQUFjO2dCQUNsQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDO2dCQUN4QixXQUFXLEVBQUUsSUFBSTthQUNsQjtZQUNELFVBQVUsRUFBRSxDQUFDLFdBQVcsRUFB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QUNyQixlQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSx3QkFBd0IsRUFBRSxDQUFDLENBQUM7UUFDekYsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxRQUFRO1FBS2IsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDM0QsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLFdBQVcsRUFBRSxFQUFFLENBQUMsR0FBRyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDN0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7UUFDMUMsTUFBTSx5QkFBeUIsR0FBRyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV2RixPQUFPO1lBQ0wsZ0JBQWdCO1lBQ2hCLFdBQVc7WUFDWCx5QkFBeUIsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLHlCQUF5QixHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUc7U0FDN0UsQ0FBQztJQUNKLENBQUM7O0FBdmFILHNDQXdhQztBQXZhZ0IsZ0JBQUUsR0FBMEIsSUFBSSxDQUFDO0FBQ2pDLHlCQUFXLEdBQUcsSUFBSSxHQUFHLEVBQTRCLENBQUMsQ0FBQyw4QkFBOEI7QUFDakYseUJBQVcsR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQyxDQUFDLHFCQUFxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xcc2VydmljZXNcXHNvY2tldFNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VydmVyIGFzIFNvY2tldElPU2VydmVyLCBTb2NrZXQgfSBmcm9tICdzb2NrZXQuaW8nO1xuaW1wb3J0IHsgU2VydmVyIGFzIEhUVFBTZXJ2ZXIgfSBmcm9tICdodHRwJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9lbnZpcm9ubWVudCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uVHlwZSwgTm90aWZpY2F0aW9uUHJpb3JpdHkgfSBmcm9tICcuLi9tb2RlbHMvTm90aWZpY2F0aW9uJztcblxuLyoqXG4gKiBTb2NrZXQg5LqL5Lu26aGe5Z6LXG4gKi9cbmV4cG9ydCBlbnVtIFNvY2tldEV2ZW50cyB7XG4gIC8vIOmAo+aOpeebuOmXnFxuICBDT05ORUNUSU9OID0gJ2Nvbm5lY3Rpb24nLFxuICBESVNDT05ORUNUID0gJ2Rpc2Nvbm5lY3QnLFxuICBKT0lOX1JPT00gPSAnam9pbl9yb29tJyxcbiAgTEVBVkVfUk9PTSA9ICdsZWF2ZV9yb29tJyxcbiAgXG4gIC8vIOmAmuefpeebuOmXnFxuICBOT1RJRklDQVRJT04gPSAnbm90aWZpY2F0aW9uJyxcbiAgTk9USUZJQ0FUSU9OX1JFQUQgPSAnbm90aWZpY2F0aW9uX3JlYWQnLFxuICBOT1RJRklDQVRJT05fREVMSVZFUkVEID0gJ25vdGlmaWNhdGlvbl9kZWxpdmVyZWQnLFxuICBcbiAgLy8g6IGK5aSp55u46ZecXG4gIE1FU1NBR0UgPSAnbWVzc2FnZScsXG4gIE1FU1NBR0VfREVMSVZFUkVEID0gJ21lc3NhZ2VfZGVsaXZlcmVkJyxcbiAgTUVTU0FHRV9SRUFEID0gJ21lc3NhZ2VfcmVhZCcsXG4gIFRZUElOR19TVEFSVCA9ICd0eXBpbmdfc3RhcnQnLFxuICBUWVBJTkdfU1RPUCA9ICd0eXBpbmdfc3RvcCcsXG4gIFxuICAvLyDlr7XnianljZTlsIvnm7jpl5xcbiAgUEVUX1NUQVRVU19VUERBVEUgPSAncGV0X3N0YXR1c191cGRhdGUnLFxuICBNQVRDSF9GT1VORCA9ICdtYXRjaF9mb3VuZCcsXG4gIFxuICAvLyDns7vntbHnm7jpl5xcbiAgU1lTVEVNX0FOTk9VTkNFTUVOVCA9ICdzeXN0ZW1fYW5ub3VuY2VtZW50JyxcbiAgVVNFUl9PTkxJTkUgPSAndXNlcl9vbmxpbmUnLFxuICBVU0VSX09GRkxJTkUgPSAndXNlcl9vZmZsaW5lJyxcbn1cblxuLyoqXG4gKiDljbPmmYLpgJrnn6Xos4fmlpnku4vpnaJcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFsdGltZU5vdGlmaWNhdGlvbkRhdGEge1xuICBpZDogc3RyaW5nO1xuICB0eXBlOiBOb3RpZmljYXRpb25UeXBlO1xuICB0aXRsZTogc3RyaW5nO1xuICBtZXNzYWdlOiBzdHJpbmc7XG4gIHByaW9yaXR5OiBOb3RpZmljYXRpb25Qcmlvcml0eTtcbiAgZGF0YT86IGFueTtcbiAgdGltZXN0YW1wOiBEYXRlO1xuICBhY3Rpb25Vcmw/OiBzdHJpbmc7XG4gIGltYWdlVXJsPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIOS9v+eUqOiAhSBTb2NrZXQg6LOH6KiKXG4gKi9cbmludGVyZmFjZSBVc2VyU29ja2V0SW5mbyB7XG4gIHVzZXJJZDogc3RyaW5nO1xuICBzb2NrZXRJZDogc3RyaW5nO1xuICBjb25uZWN0ZWRBdDogRGF0ZTtcbiAgbGFzdEFjdGl2aXR5OiBEYXRlO1xufVxuXG4vKipcbiAqIFNvY2tldCDmnI3li5npoZ7liKVcbiAqL1xuZXhwb3J0IGNsYXNzIFNvY2tldFNlcnZpY2Uge1xuICBwcml2YXRlIHN0YXRpYyBpbzogU29ja2V0SU9TZXJ2ZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBzdGF0aWMgdXNlclNvY2tldHMgPSBuZXcgTWFwPHN0cmluZywgVXNlclNvY2tldEluZm9bXT4oKTsgLy8gdXNlcklkIC0+IHNvY2tldCBpbmZvIGFycmF5XG4gIHByaXZhdGUgc3RhdGljIHNvY2tldFVzZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTsgLy8gc29ja2V0SWQgLT4gdXNlcklkXG5cbiAgLyoqXG4gICAqIOWIneWni+WMliBTb2NrZXQuSU8g5pyN5YuZXG4gICAqL1xuICBzdGF0aWMgaW5pdGlhbGl6ZShodHRwU2VydmVyOiBIVFRQU2VydmVyKTogU29ja2V0SU9TZXJ2ZXIge1xuICAgIHRoaXMuaW8gPSBuZXcgU29ja2V0SU9TZXJ2ZXIoaHR0cFNlcnZlciwge1xuICAgICAgY29yczoge1xuICAgICAgICBvcmlnaW46IGNvbmZpZy5jb3JzLmFsbG93ZWRPcmlnaW5zLFxuICAgICAgICBtZXRob2RzOiBbJ0dFVCcsICdQT1NUJ10sXG4gICAgICAgIGNyZWRlbnRpYWxzOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIHRyYW5zcG9ydHM6IFsnd2Vic29ja2V0JywgJ3BvbGxpbmcnXSxcbiAgICB9KTtcblxuICAgIC8vIOS4reS7i+i7n+mrlO+8mumpl+itiSBKV1QgVG9rZW5cbiAgICB0aGlzLmlvLnVzZShhc3luYyAoc29ja2V0LCBuZXh0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB0b2tlbiA9IHNvY2tldC5oYW5kc2hha2UuYXV0aC50b2tlbiB8fCBzb2NrZXQuaGFuZHNoYWtlLmhlYWRlcnMuYXV0aG9yaXphdGlvbj8ucmVwbGFjZSgnQmVhcmVyICcsICcnKTtcbiAgICAgICAgXG4gICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICByZXR1cm4gbmV4dChuZXcgRXJyb3IoJ+acquaPkOS+m+iqjeitiSB0b2tlbicpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCBjb25maWcuand0LnNlY3JldCkgYXMgYW55O1xuICAgICAgICBzb2NrZXQuZGF0YS51c2VySWQgPSBkZWNvZGVkLnVzZXJJZDtcbiAgICAgICAgc29ja2V0LmRhdGEudXNlciA9IGRlY29kZWQ7XG4gICAgICAgIFxuICAgICAgICBuZXh0KCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ1NvY2tldCDoqo3orYnlpLHmlZcnLCB7IGVycm9yIH0pO1xuICAgICAgICBuZXh0KG5ldyBFcnJvcign6KqN6K2J5aSx5pWXJykpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8g6JmV55CG6YCj5o6l5LqL5Lu2XG4gICAgdGhpcy5pby5vbihTb2NrZXRFdmVudHMuQ09OTkVDVElPTiwgKHNvY2tldDogU29ja2V0KSA9PiB7XG4gICAgICB0aGlzLmhhbmRsZUNvbm5lY3Rpb24oc29ja2V0KTtcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKCdTb2NrZXQuSU8g5pyN5YuZ5Yid5aeL5YyW5oiQ5YqfJyk7XG4gICAgcmV0dXJuIHRoaXMuaW87XG4gIH1cblxuICAvKipcbiAgICog6JmV55CG55So5oi26YCj5o6lXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBoYW5kbGVDb25uZWN0aW9uKHNvY2tldDogU29ja2V0KTogdm9pZCB7XG4gICAgY29uc3QgdXNlcklkID0gc29ja2V0LmRhdGEudXNlcklkO1xuICAgIGNvbnN0IHNvY2tldEluZm86IFVzZXJTb2NrZXRJbmZvID0ge1xuICAgICAgdXNlcklkLFxuICAgICAgc29ja2V0SWQ6IHNvY2tldC5pZCxcbiAgICAgIGNvbm5lY3RlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgbGFzdEFjdGl2aXR5OiBuZXcgRGF0ZSgpLFxuICAgIH07XG5cbiAgICAvLyDoqJjpjITnlKjmiLYgc29ja2V0IOmAo+aOpVxuICAgIGlmICghdGhpcy51c2VyU29ja2V0cy5oYXModXNlcklkKSkge1xuICAgICAgdGhpcy51c2VyU29ja2V0cy5zZXQodXNlcklkLCBbXSk7XG4gICAgfVxuICAgIHRoaXMudXNlclNvY2tldHMuZ2V0KHVzZXJJZCkhLnB1c2goc29ja2V0SW5mbyk7XG4gICAgdGhpcy5zb2NrZXRVc2Vycy5zZXQoc29ja2V0LmlkLCB1c2VySWQpO1xuXG4gICAgLy8g5Yqg5YWl55So5oi25YCL5Lq65oi/6ZaTXG4gICAgc29ja2V0LmpvaW4oYHVzZXI6JHt1c2VySWR9YCk7XG5cbiAgICBsb2dnZXIuaW5mbygn55So5oi26YCj5o6l5oiQ5YqfJywge1xuICAgICAgdXNlcklkLFxuICAgICAgc29ja2V0SWQ6IHNvY2tldC5pZCxcbiAgICAgIHRvdGFsQ29ubmVjdGlvbnM6IHRoaXMudXNlclNvY2tldHMuZ2V0KHVzZXJJZCkhLmxlbmd0aCxcbiAgICB9KTtcblxuICAgIC8vIOmAmuefpeWFtuS7lueUqOaItuipsueUqOaItuS4iue3mlxuICAgIHNvY2tldC5icm9hZGNhc3QuZW1pdChTb2NrZXRFdmVudHMuVVNFUl9PTkxJTkUsIHtcbiAgICAgIHVzZXJJZCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICB9KTtcblxuICAgIC8vIOiZleeQhuWKoOWFpeaIv+mWk1xuICAgIHNvY2tldC5vbihTb2NrZXRFdmVudHMuSk9JTl9ST09NLCAocm9vbUlkOiBzdHJpbmcpID0+IHtcbiAgICAgIHNvY2tldC5qb2luKHJvb21JZCk7XG4gICAgICBsb2dnZXIuZGVidWcoJ+eUqOaItuWKoOWFpeaIv+mWkycsIHsgdXNlcklkLCBzb2NrZXRJZDogc29ja2V0LmlkLCByb29tSWQgfSk7XG4gICAgfSk7XG5cbiAgICAvLyDomZXnkIbpm6LplovmiL/plpNcbiAgICBzb2NrZXQub24oU29ja2V0RXZlbnRzLkxFQVZFX1JPT00sIChyb29tSWQ6IHN0cmluZykgPT4ge1xuICAgICAgc29ja2V0LmxlYXZlKHJvb21JZCk7XG4gICAgICBsb2dnZXIuZGVidWcoJ+eUqOaItumboumWi+aIv+mWkycsIHsgdXNlcklkLCBzb2NrZXRJZDogc29ja2V0LmlkLCByb29tSWQgfSk7XG4gICAgfSk7XG5cbiAgICAvLyDomZXnkIbpgJrnn6Xlt7LoroBcbiAgICBzb2NrZXQub24oU29ja2V0RXZlbnRzLk5PVElGSUNBVElPTl9SRUFELCAobm90aWZpY2F0aW9uSWQ6IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5oYW5kbGVOb3RpZmljYXRpb25SZWFkKHVzZXJJZCwgbm90aWZpY2F0aW9uSWQpO1xuICAgIH0pO1xuXG4gICAgLy8g6JmV55CG6YCa55+l6YCB6YGU56K66KqNXG4gICAgc29ja2V0Lm9uKFNvY2tldEV2ZW50cy5OT1RJRklDQVRJT05fREVMSVZFUkVELCAobm90aWZpY2F0aW9uSWQ6IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5oYW5kbGVOb3RpZmljYXRpb25EZWxpdmVyZWQodXNlcklkLCBub3RpZmljYXRpb25JZCk7XG4gICAgfSk7XG5cbiAgICAvLyDomZXnkIboqIrmga/nm7jpl5zkuovku7ZcbiAgICBzb2NrZXQub24oU29ja2V0RXZlbnRzLk1FU1NBR0UsIChkYXRhOiBhbnkpID0+IHtcbiAgICAgIHRoaXMuaGFuZGxlTWVzc2FnZShzb2NrZXQsIGRhdGEpO1xuICAgIH0pO1xuXG4gICAgc29ja2V0Lm9uKFNvY2tldEV2ZW50cy5NRVNTQUdFX1JFQUQsIChkYXRhOiBhbnkpID0+IHtcbiAgICAgIHRoaXMuaGFuZGxlTWVzc2FnZVJlYWQoc29ja2V0LCBkYXRhKTtcbiAgICB9KTtcblxuICAgIHNvY2tldC5vbihTb2NrZXRFdmVudHMuVFlQSU5HX1NUQVJULCAoZGF0YTogYW55KSA9PiB7XG4gICAgICB0aGlzLmhhbmRsZVR5cGluZyhzb2NrZXQsIGRhdGEsIHRydWUpO1xuICAgIH0pO1xuXG4gICAgc29ja2V0Lm9uKFNvY2tldEV2ZW50cy5UWVBJTkdfU1RPUCwgKGRhdGE6IGFueSkgPT4ge1xuICAgICAgdGhpcy5oYW5kbGVUeXBpbmcoc29ja2V0LCBkYXRhLCBmYWxzZSk7XG4gICAgfSk7XG5cbiAgICAvLyDomZXnkIbmlrfnt5pcbiAgICBzb2NrZXQub24oU29ja2V0RXZlbnRzLkRJU0NPTk5FQ1QsIChyZWFzb246IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5oYW5kbGVEaXNjb25uZWN0aW9uKHNvY2tldCwgcmVhc29uKTtcbiAgICB9KTtcblxuICAgIC8vIOabtOaWsOacgOW+jOa0u+WLleaZgumWk1xuICAgIHNvY2tldC5vbkFueSgoKSA9PiB7XG4gICAgICB0aGlzLnVwZGF0ZUxhc3RBY3Rpdml0eSh1c2VySWQsIHNvY2tldC5pZCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog6JmV55CG55So5oi25pa357eaXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBoYW5kbGVEaXNjb25uZWN0aW9uKHNvY2tldDogU29ja2V0LCByZWFzb246IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHVzZXJJZCA9IHRoaXMuc29ja2V0VXNlcnMuZ2V0KHNvY2tldC5pZCk7XG4gICAgXG4gICAgaWYgKHVzZXJJZCkge1xuICAgICAgLy8g56e76ZmkIHNvY2tldCDoqJjpjIRcbiAgICAgIGNvbnN0IHVzZXJTb2NrZXRMaXN0ID0gdGhpcy51c2VyU29ja2V0cy5nZXQodXNlcklkKTtcbiAgICAgIGlmICh1c2VyU29ja2V0TGlzdCkge1xuICAgICAgICBjb25zdCBpbmRleCA9IHVzZXJTb2NrZXRMaXN0LmZpbmRJbmRleChpbmZvID0+IGluZm8uc29ja2V0SWQgPT09IHNvY2tldC5pZCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICB1c2VyU29ja2V0TGlzdC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyDlpoLmnpznlKjmiLbmspLmnInlhbbku5bpgKPmjqXvvIzliYfmuIXnkIboqJjpjITkuKbpgJrnn6XkuIvnt5pcbiAgICAgICAgaWYgKHVzZXJTb2NrZXRMaXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMudXNlclNvY2tldHMuZGVsZXRlKHVzZXJJZCk7XG4gICAgICAgICAgc29ja2V0LmJyb2FkY2FzdC5lbWl0KFNvY2tldEV2ZW50cy5VU0VSX09GRkxJTkUsIHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICB0aGlzLnNvY2tldFVzZXJzLmRlbGV0ZShzb2NrZXQuaWQpO1xuICAgICAgXG4gICAgICBsb2dnZXIuaW5mbygn55So5oi25pa357eaJywge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHNvY2tldElkOiBzb2NrZXQuaWQsXG4gICAgICAgIHJlYXNvbixcbiAgICAgICAgcmVtYWluaW5nQ29ubmVjdGlvbnM6IHRoaXMudXNlclNvY2tldHMuZ2V0KHVzZXJJZCk/Lmxlbmd0aCB8fCAwLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOeZvOmAgeWNs+aZgumAmuefpee1pueJueWumueUqOaItlxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHNlbmROb3RpZmljYXRpb25Ub1VzZXIoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgbm90aWZpY2F0aW9uOiBSZWFsdGltZU5vdGlmaWNhdGlvbkRhdGFcbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghdGhpcy5pbykge1xuICAgICAgICBsb2dnZXIud2FybignU29ja2V0LklPIOWwmuacquWIneWni+WMlicpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJvb20gPSBgdXNlcjoke3VzZXJJZH1gO1xuICAgICAgdGhpcy5pby50byhyb29tKS5lbWl0KFNvY2tldEV2ZW50cy5OT1RJRklDQVRJT04sIG5vdGlmaWNhdGlvbik7XG4gICAgICBcbiAgICAgIGxvZ2dlci5kZWJ1Zygn5Y2z5pmC6YCa55+l5bey55m86YCBJywge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIG5vdGlmaWNhdGlvbklkOiBub3RpZmljYXRpb24uaWQsXG4gICAgICAgIHR5cGU6IG5vdGlmaWNhdGlvbi50eXBlLFxuICAgICAgICB0aXRsZTogbm90aWZpY2F0aW9uLnRpdGxlLFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ+eZvOmAgeWNs+aZgumAmuefpeWkseaVlycsIHsgZXJyb3IsIHVzZXJJZCwgbm90aWZpY2F0aW9uSWQ6IG5vdGlmaWNhdGlvbi5pZCB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog55m86YCB5Y2z5pmC6YCa55+l57Wm5aSa5YCL55So5oi2XG4gICAqL1xuICBzdGF0aWMgYXN5bmMgc2VuZE5vdGlmaWNhdGlvblRvVXNlcnMoXG4gICAgdXNlcklkczogc3RyaW5nW10sXG4gICAgbm90aWZpY2F0aW9uOiBSZWFsdGltZU5vdGlmaWNhdGlvbkRhdGFcbiAgKTogUHJvbWlzZTx7IHN1Y2Nlc3NDb3VudDogbnVtYmVyOyBmYWlsdXJlQ291bnQ6IG51bWJlciB9PiB7XG4gICAgbGV0IHN1Y2Nlc3NDb3VudCA9IDA7XG4gICAgbGV0IGZhaWx1cmVDb3VudCA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IHVzZXJJZCBvZiB1c2VySWRzKSB7XG4gICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgdGhpcy5zZW5kTm90aWZpY2F0aW9uVG9Vc2VyKHVzZXJJZCwgbm90aWZpY2F0aW9uKTtcbiAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgIHN1Y2Nlc3NDb3VudCsrO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmFpbHVyZUNvdW50Kys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3VjY2Vzc0NvdW50LCBmYWlsdXJlQ291bnQgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlu6Pmkq3ns7vntbHlhazlkYpcbiAgICovXG4gIHN0YXRpYyBicm9hZGNhc3RTeXN0ZW1Bbm5vdW5jZW1lbnQoYW5ub3VuY2VtZW50OiB7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICBtZXNzYWdlOiBzdHJpbmc7XG4gICAgcHJpb3JpdHk6IE5vdGlmaWNhdGlvblByaW9yaXR5O1xuICAgIGFjdGlvblVybD86IHN0cmluZztcbiAgfSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pbykge1xuICAgICAgbG9nZ2VyLndhcm4oJ1NvY2tldC5JTyDlsJrmnKrliJ3lp4vljJYnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmlvLmVtaXQoU29ja2V0RXZlbnRzLlNZU1RFTV9BTk5PVU5DRU1FTlQsIHtcbiAgICAgIC4uLmFubm91bmNlbWVudCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKCfns7vntbHlhazlkYrlt7Llu6Pmkq0nLCB7IHRpdGxlOiBhbm5vdW5jZW1lbnQudGl0bGUgfSk7XG4gIH1cblxuICAvKipcbiAgICog55m86YCB5a+154mp54uA5oWL5pu05pawXG4gICAqL1xuICBzdGF0aWMgc2VuZFBldFN0YXR1c1VwZGF0ZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBwZXRJZDogc3RyaW5nLFxuICAgIHN0YXR1czogc3RyaW5nLFxuICAgIG1lc3NhZ2U6IHN0cmluZ1xuICApOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaW8pIHtcbiAgICAgIGxvZ2dlci53YXJuKCdTb2NrZXQuSU8g5bCa5pyq5Yid5aeL5YyWJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgcm9vbSA9IGB1c2VyOiR7dXNlcklkfWA7XG4gICAgdGhpcy5pby50byhyb29tKS5lbWl0KFNvY2tldEV2ZW50cy5QRVRfU1RBVFVTX1VQREFURSwge1xuICAgICAgcGV0SWQsXG4gICAgICBzdGF0dXMsXG4gICAgICBtZXNzYWdlLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmRlYnVnKCflr7Xnianni4DmhYvmm7TmlrDlt7LnmbzpgIEnLCB7IHVzZXJJZCwgcGV0SWQsIHN0YXR1cyB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmqqLmn6XnlKjmiLbmmK/lkKblnKjnt5pcbiAgICovXG4gIHN0YXRpYyBpc1VzZXJPbmxpbmUodXNlcklkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy51c2VyU29ja2V0cy5oYXModXNlcklkKSAmJiB0aGlzLnVzZXJTb2NrZXRzLmdldCh1c2VySWQpIS5sZW5ndGggPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIOWPluW+l+WcqOe3mueUqOaItuWIl+ihqFxuICAgKi9cbiAgc3RhdGljIGdldE9ubGluZVVzZXJzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnVzZXJTb2NrZXRzLmtleXMoKSk7XG4gIH1cblxuICAvKipcbiAgICog5Y+W5b6X55So5oi26YCj5o6l5pW4XG4gICAqL1xuICBzdGF0aWMgZ2V0VXNlckNvbm5lY3Rpb25Db3VudCh1c2VySWQ6IHN0cmluZyk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMudXNlclNvY2tldHMuZ2V0KHVzZXJJZCk/Lmxlbmd0aCB8fCAwO1xuICB9XG5cbiAgLyoqXG4gICAqIOiZleeQhumAmuefpeW3suiugFxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgaGFuZGxlTm90aWZpY2F0aW9uUmVhZCh1c2VySWQ6IHN0cmluZywgbm90aWZpY2F0aW9uSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGxvZ2dlci5kZWJ1Zygn6YCa55+l5bey6K6AJywgeyB1c2VySWQsIG5vdGlmaWNhdGlvbklkIH0pO1xuICAgIC8vIOmAmeijoeWPr+S7peabtOaWsOizh+aWmeW6q+S4reeahOmAmuefpeeLgOaFi1xuICB9XG5cbiAgLyoqXG4gICAqIOiZleeQhumAmuefpemAgemBlOeiuuiqjVxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgaGFuZGxlTm90aWZpY2F0aW9uRGVsaXZlcmVkKHVzZXJJZDogc3RyaW5nLCBub3RpZmljYXRpb25JZDogc3RyaW5nKTogdm9pZCB7XG4gICAgbG9nZ2VyLmRlYnVnKCfpgJrnn6XpgIHpgZTnorroqo0nLCB7IHVzZXJJZCwgbm90aWZpY2F0aW9uSWQgfSk7XG4gICAgLy8g6YCZ6KOh5Y+v5Lul5pu05paw6LOH5paZ5bqr5Lit55qE6YCa55+l6YCB6YGU54uA5oWLXG4gIH1cblxuICAvKipcbiAgICog6JmV55CG6KiK5oGvXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBoYW5kbGVNZXNzYWdlKHNvY2tldDogU29ja2V0LCBkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCB1c2VySWQgPSBzb2NrZXQuZGF0YS51c2VySWQ7XG4gICAgbG9nZ2VyLmRlYnVnKCfmlLbliLDoqIrmga8nLCB7IHVzZXJJZCwgbWVzc2FnZURhdGE6IGRhdGEgfSk7XG4gICAgXG4gICAgLy8g6L2J55m86KiK5oGv57Wm55uu5qiZ55So5oi2XG4gICAgaWYgKGRhdGEudGFyZ2V0VXNlcklkKSB7XG4gICAgICBjb25zdCB0YXJnZXRSb29tID0gYHVzZXI6JHtkYXRhLnRhcmdldFVzZXJJZH1gO1xuICAgICAgc29ja2V0LnRvKHRhcmdldFJvb20pLmVtaXQoU29ja2V0RXZlbnRzLk1FU1NBR0UsIHtcbiAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgZnJvbVVzZXJJZDogdXNlcklkLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6JmV55CG6KiK5oGv5bey6K6AXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBoYW5kbGVNZXNzYWdlUmVhZChzb2NrZXQ6IFNvY2tldCwgZGF0YTogYW55KTogdm9pZCB7XG4gICAgY29uc3QgdXNlcklkID0gc29ja2V0LmRhdGEudXNlcklkO1xuICAgIGxvZ2dlci5kZWJ1Zygn6KiK5oGv5bey6K6AJywgeyB1c2VySWQsIG1lc3NhZ2VEYXRhOiBkYXRhIH0pO1xuICAgIFxuICAgIC8vIOmAmuefpeeZvOmAgeiAheioiuaBr+W3suiiq+iugOWPllxuICAgIGlmIChkYXRhLmZyb21Vc2VySWQpIHtcbiAgICAgIGNvbnN0IHNlbmRlclJvb20gPSBgdXNlcjoke2RhdGEuZnJvbVVzZXJJZH1gO1xuICAgICAgc29ja2V0LnRvKHNlbmRlclJvb20pLmVtaXQoU29ja2V0RXZlbnRzLk1FU1NBR0VfUkVBRCwge1xuICAgICAgICBtZXNzYWdlSWQ6IGRhdGEubWVzc2FnZUlkLFxuICAgICAgICByZWFkQnk6IHVzZXJJZCxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOiZleeQhui8uOWFpeeLgOaFi1xuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgaGFuZGxlVHlwaW5nKHNvY2tldDogU29ja2V0LCBkYXRhOiBhbnksIGlzVHlwaW5nOiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3QgdXNlcklkID0gc29ja2V0LmRhdGEudXNlcklkO1xuICAgIFxuICAgIGlmIChkYXRhLnRhcmdldFVzZXJJZCkge1xuICAgICAgY29uc3QgdGFyZ2V0Um9vbSA9IGB1c2VyOiR7ZGF0YS50YXJnZXRVc2VySWR9YDtcbiAgICAgIGNvbnN0IGV2ZW50ID0gaXNUeXBpbmcgPyBTb2NrZXRFdmVudHMuVFlQSU5HX1NUQVJUIDogU29ja2V0RXZlbnRzLlRZUElOR19TVE9QO1xuICAgICAgXG4gICAgICBzb2NrZXQudG8odGFyZ2V0Um9vbSkuZW1pdChldmVudCwge1xuICAgICAgICBmcm9tVXNlcklkOiB1c2VySWQsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDmnIDlvozmtLvli5XmmYLplpNcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIHVwZGF0ZUxhc3RBY3Rpdml0eSh1c2VySWQ6IHN0cmluZywgc29ja2V0SWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHVzZXJTb2NrZXRMaXN0ID0gdGhpcy51c2VyU29ja2V0cy5nZXQodXNlcklkKTtcbiAgICBpZiAodXNlclNvY2tldExpc3QpIHtcbiAgICAgIGNvbnN0IHNvY2tldEluZm8gPSB1c2VyU29ja2V0TGlzdC5maW5kKGluZm8gPT4gaW5mby5zb2NrZXRJZCA9PT0gc29ja2V0SWQpO1xuICAgICAgaWYgKHNvY2tldEluZm8pIHtcbiAgICAgICAgc29ja2V0SW5mby5sYXN0QWN0aXZpdHkgPSBuZXcgRGF0ZSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnkIbpnZ7mtLvouo3pgKPmjqVcbiAgICovXG4gIHN0YXRpYyBjbGVhbnVwSW5hY3RpdmVDb25uZWN0aW9ucyhpbmFjdGl2ZVRocmVzaG9sZE1pbnV0ZXM6IG51bWJlciA9IDMwKTogdm9pZCB7XG4gICAgY29uc3QgdGhyZXNob2xkID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIGluYWN0aXZlVGhyZXNob2xkTWludXRlcyAqIDYwICogMTAwMCk7XG4gICAgbGV0IGNsZWFuZWRDb3VudCA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IFt1c2VySWQsIHNvY2tldExpc3RdIG9mIHRoaXMudXNlclNvY2tldHMuZW50cmllcygpKSB7XG4gICAgICBjb25zdCBhY3RpdmVDb25uZWN0aW9ucyA9IHNvY2tldExpc3QuZmlsdGVyKGluZm8gPT4gaW5mby5sYXN0QWN0aXZpdHkgPiB0aHJlc2hvbGQpO1xuICAgICAgXG4gICAgICBpZiAoYWN0aXZlQ29ubmVjdGlvbnMubGVuZ3RoICE9PSBzb2NrZXRMaXN0Lmxlbmd0aCkge1xuICAgICAgICBjb25zdCBpbmFjdGl2ZUNvbm5lY3Rpb25zID0gc29ja2V0TGlzdC5maWx0ZXIoaW5mbyA9PiBpbmZvLmxhc3RBY3Rpdml0eSA8PSB0aHJlc2hvbGQpO1xuICAgICAgICBcbiAgICAgICAgLy8g5pa36ZaL6Z2e5rS76LqN6YCj5o6lXG4gICAgICAgIGluYWN0aXZlQ29ubmVjdGlvbnMuZm9yRWFjaChpbmZvID0+IHtcbiAgICAgICAgICBjb25zdCBzb2NrZXQgPSB0aGlzLmlvPy5zb2NrZXRzLnNvY2tldHMuZ2V0KGluZm8uc29ja2V0SWQpO1xuICAgICAgICAgIGlmIChzb2NrZXQpIHtcbiAgICAgICAgICAgIHNvY2tldC5kaXNjb25uZWN0KHRydWUpO1xuICAgICAgICAgICAgY2xlYW5lZENvdW50Kys7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIOabtOaWsOiomOmMhFxuICAgICAgICBpZiAoYWN0aXZlQ29ubmVjdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRoaXMudXNlclNvY2tldHMuc2V0KHVzZXJJZCwgYWN0aXZlQ29ubmVjdGlvbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudXNlclNvY2tldHMuZGVsZXRlKHVzZXJJZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY2xlYW5lZENvdW50ID4gMCkge1xuICAgICAgbG9nZ2VyLmluZm8oJ+a4heeQhumdnua0u+i6jemAo+aOpeWujOaIkCcsIHsgY2xlYW5lZENvdW50LCB0aHJlc2hvbGRNaW51dGVzOiBpbmFjdGl2ZVRocmVzaG9sZE1pbnV0ZXMgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOWPluW+l+acjeWLmee1seioiOizh+ioilxuICAgKi9cbiAgc3RhdGljIGdldFN0YXRzKCk6IHtcbiAgICB0b3RhbENvbm5lY3Rpb25zOiBudW1iZXI7XG4gICAgb25saW5lVXNlcnM6IG51bWJlcjtcbiAgICBhdmVyYWdlQ29ubmVjdGlvbnNQZXJVc2VyOiBudW1iZXI7XG4gIH0ge1xuICAgIGNvbnN0IHRvdGFsQ29ubmVjdGlvbnMgPSBBcnJheS5mcm9tKHRoaXMudXNlclNvY2tldHMudmFsdWVzKCkpXG4gICAgICAucmVkdWNlKChzdW0sIGNvbm5lY3Rpb25zKSA9PiBzdW0gKyBjb25uZWN0aW9ucy5sZW5ndGgsIDApO1xuICAgIGNvbnN0IG9ubGluZVVzZXJzID0gdGhpcy51c2VyU29ja2V0cy5zaXplO1xuICAgIGNvbnN0IGF2ZXJhZ2VDb25uZWN0aW9uc1BlclVzZXIgPSBvbmxpbmVVc2VycyA+IDAgPyB0b3RhbENvbm5lY3Rpb25zIC8gb25saW5lVXNlcnMgOiAwO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsQ29ubmVjdGlvbnMsXG4gICAgICBvbmxpbmVVc2VycyxcbiAgICAgIGF2ZXJhZ2VDb25uZWN0aW9uc1BlclVzZXI6IE1hdGgucm91bmQoYXZlcmFnZUNvbm5lY3Rpb25zUGVyVXNlciAqIDEwMCkgLyAxMDAsXG4gICAgfTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==