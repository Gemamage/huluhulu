{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\models\\Review.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\models\\Review.ts"],"sourcesContent":["import mongoose, { Document, Schema } from 'mongoose';\n\n// 評價介面定義\nexport interface IReview extends Document {\n  _id: mongoose.Types.ObjectId;\n  reviewerId: mongoose.Types.ObjectId; // 評價者\n  revieweeId: mongoose.Types.ObjectId; // 被評價者\n  petId?: mongoose.Types.ObjectId; // 相關寵物\n  conversationId?: mongoose.Types.ObjectId; // 相關對話\n  rating: number; // 1-5 星評價\n  content?: string;\n  tags: string[]; // 評價標籤 (如: 友善, 準時, 負責任等)\n  isAnonymous: boolean;\n  isDeleted: boolean;\n  deletedAt?: Date;\n  deletedBy?: mongoose.Types.ObjectId;\n  reportCount: number;\n  isHidden: boolean;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\n// 評價統計介面定義\nexport interface IReviewStats extends Document {\n  _id: mongoose.Types.ObjectId;\n  userId: mongoose.Types.ObjectId;\n  totalReviews: number;\n  averageRating: number;\n  ratingDistribution: {\n    1: number;\n    2: number;\n    3: number;\n    4: number;\n    5: number;\n  };\n  commonTags: Array<{\n    tag: string;\n    count: number;\n  }>;\n  lastUpdated: Date;\n}\n\n// 評價 Schema\nconst reviewSchema = new Schema<IReview>({\n  reviewerId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    required: [true, '評價者ID為必填項目'],\n    index: true,\n  },\n  revieweeId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    required: [true, '被評價者ID為必填項目'],\n    index: true,\n  },\n  petId: {\n    type: Schema.Types.ObjectId,\n    ref: 'Pet',\n    default: null,\n    index: true,\n  },\n  conversationId: {\n    type: Schema.Types.ObjectId,\n    ref: 'Conversation',\n    default: null,\n  },\n  rating: {\n    type: Number,\n    required: [true, '評價分數為必填項目'],\n    min: [1, '評價分數最低為 1'],\n    max: [5, '評價分數最高為 5'],\n    validate: {\n      validator: Number.isInteger,\n      message: '評價分數必須為整數',\n    },\n  },\n  content: {\n    type: String,\n    trim: true,\n    maxlength: [500, '評價內容不能超過 500 個字符'],\n    default: '',\n  },\n  tags: [{\n    type: String,\n    trim: true,\n    maxlength: [20, '標籤長度不能超過 20 個字符'],\n  }],\n  isAnonymous: {\n    type: Boolean,\n    default: false,\n  },\n  isDeleted: {\n    type: Boolean,\n    default: false,\n    index: true,\n  },\n  deletedAt: {\n    type: Date,\n    default: null,\n  },\n  deletedBy: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    default: null,\n  },\n  reportCount: {\n    type: Number,\n    default: 0,\n    min: 0,\n  },\n  isHidden: {\n    type: Boolean,\n    default: false,\n    index: true,\n  },\n}, {\n  timestamps: true,\n  toJSON: {\n    transform: function(doc, ret) {\n      ret.id = ret._id;\n      delete (ret as any)._id;\n      delete (ret as any).__v;\n      return ret;\n    },\n  },\n});\n\n// 評價統計 Schema\nconst reviewStatsSchema = new Schema<IReviewStats>({\n  userId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    required: true,\n    unique: true,\n    index: true,\n  },\n  totalReviews: {\n    type: Number,\n    default: 0,\n    min: 0,\n  },\n  averageRating: {\n    type: Number,\n    default: 0,\n    min: 0,\n    max: 5,\n  },\n  ratingDistribution: {\n    1: { type: Number, default: 0, min: 0 },\n    2: { type: Number, default: 0, min: 0 },\n    3: { type: Number, default: 0, min: 0 },\n    4: { type: Number, default: 0, min: 0 },\n    5: { type: Number, default: 0, min: 0 },\n  },\n  commonTags: [{\n    tag: {\n      type: String,\n      required: true,\n      trim: true,\n    },\n    count: {\n      type: Number,\n      required: true,\n      min: 1,\n    },\n  }],\n  lastUpdated: {\n    type: Date,\n    default: Date.now,\n  },\n}, {\n  timestamps: true,\n  toJSON: {\n    transform: function(doc, ret) {\n      ret.id = ret._id;\n      delete (ret as any)._id;\n      delete (ret as any).__v;\n      return ret;\n    },\n  },\n});\n\n// 複合索引\nreviewSchema.index({ reviewerId: 1, revieweeId: 1 }, { unique: true }); // 防止重複評價\nreviewSchema.index({ revieweeId: 1, createdAt: -1 });\nreviewSchema.index({ petId: 1, createdAt: -1 });\nreviewSchema.index({ rating: 1, createdAt: -1 });\nreviewSchema.index({ isDeleted: 1, isHidden: 1 });\n\n// 注意：查詢時需要手動添加 { isDeleted: false, isHidden: false } 條件\n\n// 評價後更新統計的中介軟體\nreviewSchema.post('save', async function() {\n  if (this.isNew && !this.isDeleted && !this.isHidden) {\n    await updateReviewStats(this.revieweeId);\n  }\n});\n\nreviewSchema.post('findOneAndUpdate', async function(doc) {\n  if (doc) {\n    await updateReviewStats(doc.revieweeId);\n  }\n});\n\n// 更新評價統計的輔助函數\nasync function updateReviewStats(userId: mongoose.Types.ObjectId) {\n  const Review = mongoose.model<IReview>('Review');\n  const ReviewStats = mongoose.model<IReviewStats>('ReviewStats');\n  \n  const reviews = await Review.find({ \n    revieweeId: userId, \n    isDeleted: false, \n    isHidden: false \n  });\n  \n  const totalReviews = reviews.length;\n  const averageRating = totalReviews > 0 \n    ? reviews.reduce((sum, review) => sum + review.rating, 0) / totalReviews \n    : 0;\n  \n  const ratingDistribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };\n  const tagCounts: { [key: string]: number } = {};\n  \n  reviews.forEach(review => {\n    ratingDistribution[review.rating as keyof typeof ratingDistribution]++;\n    review.tags.forEach(tag => {\n      tagCounts[tag] = (tagCounts[tag] || 0) + 1;\n    });\n  });\n  \n  const commonTags = Object.entries(tagCounts)\n    .map(([tag, count]) => ({ tag, count }))\n    .sort((a, b) => b.count - a.count)\n    .slice(0, 10); // 取前10個最常見的標籤\n  \n  await ReviewStats.findOneAndUpdate(\n    { userId },\n    {\n      totalReviews,\n      averageRating: Math.round(averageRating * 10) / 10, // 保留一位小數\n      ratingDistribution,\n      commonTags,\n      lastUpdated: new Date(),\n    },\n    { upsert: true, new: true }\n  );\n}\n\nexport const Review = mongoose.model<IReview>('Review', reviewSchema);\nexport const ReviewStats = mongoose.model<IReviewStats>('ReviewStats', reviewStatsSchema);"],"version":3}