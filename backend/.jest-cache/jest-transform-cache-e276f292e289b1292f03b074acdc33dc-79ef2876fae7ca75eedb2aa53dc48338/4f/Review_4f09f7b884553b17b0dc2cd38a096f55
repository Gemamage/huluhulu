de1e9e61edf66404401fe78b6d3e8940
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReviewStats = exports.Review = void 0;
const mongoose_1 = __importStar(require("mongoose"));
// 評價 Schema
const reviewSchema = new mongoose_1.Schema({
    reviewerId: {
        type: mongoose_1.Schema.Types.ObjectId,
        ref: 'User',
        required: [true, '評價者ID為必填項目'],
        index: true,
    },
    revieweeId: {
        type: mongoose_1.Schema.Types.ObjectId,
        ref: 'User',
        required: [true, '被評價者ID為必填項目'],
        index: true,
    },
    petId: {
        type: mongoose_1.Schema.Types.ObjectId,
        ref: 'Pet',
        default: null,
        index: true,
    },
    conversationId: {
        type: mongoose_1.Schema.Types.ObjectId,
        ref: 'Conversation',
        default: null,
    },
    rating: {
        type: Number,
        required: [true, '評價分數為必填項目'],
        min: [1, '評價分數最低為 1'],
        max: [5, '評價分數最高為 5'],
        validate: {
            validator: Number.isInteger,
            message: '評價分數必須為整數',
        },
    },
    content: {
        type: String,
        trim: true,
        maxlength: [500, '評價內容不能超過 500 個字符'],
        default: '',
    },
    tags: [{
            type: String,
            trim: true,
            maxlength: [20, '標籤長度不能超過 20 個字符'],
        }],
    isAnonymous: {
        type: Boolean,
        default: false,
    },
    isDeleted: {
        type: Boolean,
        default: false,
        index: true,
    },
    deletedAt: {
        type: Date,
        default: null,
    },
    deletedBy: {
        type: mongoose_1.Schema.Types.ObjectId,
        ref: 'User',
        default: null,
    },
    reportCount: {
        type: Number,
        default: 0,
        min: 0,
    },
    isHidden: {
        type: Boolean,
        default: false,
        index: true,
    },
}, {
    timestamps: true,
    toJSON: {
        transform: function (doc, ret) {
            ret.id = ret._id;
            delete ret._id;
            delete ret.__v;
            return ret;
        },
    },
});
// 評價統計 Schema
const reviewStatsSchema = new mongoose_1.Schema({
    userId: {
        type: mongoose_1.Schema.Types.ObjectId,
        ref: 'User',
        required: true,
        unique: true,
        index: true,
    },
    totalReviews: {
        type: Number,
        default: 0,
        min: 0,
    },
    averageRating: {
        type: Number,
        default: 0,
        min: 0,
        max: 5,
    },
    ratingDistribution: {
        1: { type: Number, default: 0, min: 0 },
        2: { type: Number, default: 0, min: 0 },
        3: { type: Number, default: 0, min: 0 },
        4: { type: Number, default: 0, min: 0 },
        5: { type: Number, default: 0, min: 0 },
    },
    commonTags: [{
            tag: {
                type: String,
                required: true,
                trim: true,
            },
            count: {
                type: Number,
                required: true,
                min: 1,
            },
        }],
    lastUpdated: {
        type: Date,
        default: Date.now,
    },
}, {
    timestamps: true,
    toJSON: {
        transform: function (doc, ret) {
            ret.id = ret._id;
            delete ret._id;
            delete ret.__v;
            return ret;
        },
    },
});
// 複合索引
reviewSchema.index({ reviewerId: 1, revieweeId: 1 }, { unique: true }); // 防止重複評價
reviewSchema.index({ revieweeId: 1, createdAt: -1 });
reviewSchema.index({ petId: 1, createdAt: -1 });
reviewSchema.index({ rating: 1, createdAt: -1 });
reviewSchema.index({ isDeleted: 1, isHidden: 1 });
// 注意：查詢時需要手動添加 { isDeleted: false, isHidden: false } 條件
// 評價後更新統計的中介軟體
reviewSchema.post('save', async function () {
    if (this.isNew && !this.isDeleted && !this.isHidden) {
        await updateReviewStats(this.revieweeId);
    }
});
reviewSchema.post('findOneAndUpdate', async function (doc) {
    if (doc) {
        await updateReviewStats(doc.revieweeId);
    }
});
// 更新評價統計的輔助函數
async function updateReviewStats(userId) {
    const Review = mongoose_1.default.model('Review');
    const ReviewStats = mongoose_1.default.model('ReviewStats');
    const reviews = await Review.find({
        revieweeId: userId,
        isDeleted: false,
        isHidden: false
    });
    const totalReviews = reviews.length;
    const averageRating = totalReviews > 0
        ? reviews.reduce((sum, review) => sum + review.rating, 0) / totalReviews
        : 0;
    const ratingDistribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    const tagCounts = {};
    reviews.forEach(review => {
        ratingDistribution[review.rating]++;
        review.tags.forEach(tag => {
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
        });
    });
    const commonTags = Object.entries(tagCounts)
        .map(([tag, count]) => ({ tag, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10); // 取前10個最常見的標籤
    await ReviewStats.findOneAndUpdate({ userId }, {
        totalReviews,
        averageRating: Math.round(averageRating * 10) / 10, // 保留一位小數
        ratingDistribution,
        commonTags,
        lastUpdated: new Date(),
    }, { upsert: true, new: true });
}
exports.Review = mongoose_1.default.model('Review', reviewSchema);
exports.ReviewStats = mongoose_1.default.model('ReviewStats', reviewStatsSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXG1vZGVsc1xcUmV2aWV3LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHFEQUFzRDtBQTBDdEQsWUFBWTtBQUNaLE1BQU0sWUFBWSxHQUFHLElBQUksaUJBQU0sQ0FBVTtJQUN2QyxVQUFVLEVBQUU7UUFDVixJQUFJLEVBQUUsaUJBQU0sQ0FBQyxLQUFLLENBQUMsUUFBUTtRQUMzQixHQUFHLEVBQUUsTUFBTTtRQUNYLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxZQUFZLENBQUM7UUFDOUIsS0FBSyxFQUFFLElBQUk7S0FDWjtJQUNELFVBQVUsRUFBRTtRQUNWLElBQUksRUFBRSxpQkFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRO1FBQzNCLEdBQUcsRUFBRSxNQUFNO1FBQ1gsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQztRQUMvQixLQUFLLEVBQUUsSUFBSTtLQUNaO0lBQ0QsS0FBSyxFQUFFO1FBQ0wsSUFBSSxFQUFFLGlCQUFNLENBQUMsS0FBSyxDQUFDLFFBQVE7UUFDM0IsR0FBRyxFQUFFLEtBQUs7UUFDVixPQUFPLEVBQUUsSUFBSTtRQUNiLEtBQUssRUFBRSxJQUFJO0tBQ1o7SUFDRCxjQUFjLEVBQUU7UUFDZCxJQUFJLEVBQUUsaUJBQU0sQ0FBQyxLQUFLLENBQUMsUUFBUTtRQUMzQixHQUFHLEVBQUUsY0FBYztRQUNuQixPQUFPLEVBQUUsSUFBSTtLQUNkO0lBQ0QsTUFBTSxFQUFFO1FBQ04sSUFBSSxFQUFFLE1BQU07UUFDWixRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDO1FBQzdCLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUM7UUFDckIsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQztRQUNyQixRQUFRLEVBQUU7WUFDUixTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7WUFDM0IsT0FBTyxFQUFFLFdBQVc7U0FDckI7S0FDRjtJQUNELE9BQU8sRUFBRTtRQUNQLElBQUksRUFBRSxNQUFNO1FBQ1osSUFBSSxFQUFFLElBQUk7UUFDVixTQUFTLEVBQUUsQ0FBQyxHQUFHLEVBQUUsa0JBQWtCLENBQUM7UUFDcEMsT0FBTyxFQUFFLEVBQUU7S0FDWjtJQUNELElBQUksRUFBRSxDQUFDO1lBQ0wsSUFBSSxFQUFFLE1BQU07WUFDWixJQUFJLEVBQUUsSUFBSTtZQUNWLFNBQVMsRUFBRSxDQUFDLEVBQUUsRUFBRSxpQkFBaUIsQ0FBQztTQUNuQyxDQUFDO0lBQ0YsV0FBVyxFQUFFO1FBQ1gsSUFBSSxFQUFFLE9BQU87UUFDYixPQUFPLEVBQUUsS0FBSztLQUNmO0lBQ0QsU0FBUyxFQUFFO1FBQ1QsSUFBSSxFQUFFLE9BQU87UUFDYixPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUssRUFBRSxJQUFJO0tBQ1o7SUFDRCxTQUFTLEVBQUU7UUFDVCxJQUFJLEVBQUUsSUFBSTtRQUNWLE9BQU8sRUFBRSxJQUFJO0tBQ2Q7SUFDRCxTQUFTLEVBQUU7UUFDVCxJQUFJLEVBQUUsaUJBQU0sQ0FBQyxLQUFLLENBQUMsUUFBUTtRQUMzQixHQUFHLEVBQUUsTUFBTTtRQUNYLE9BQU8sRUFBRSxJQUFJO0tBQ2Q7SUFDRCxXQUFXLEVBQUU7UUFDWCxJQUFJLEVBQUUsTUFBTTtRQUNaLE9BQU8sRUFBRSxDQUFDO1FBQ1YsR0FBRyxFQUFFLENBQUM7S0FDUDtJQUNELFFBQVEsRUFBRTtRQUNSLElBQUksRUFBRSxPQUFPO1FBQ2IsT0FBTyxFQUFFLEtBQUs7UUFDZCxLQUFLLEVBQUUsSUFBSTtLQUNaO0NBQ0YsRUFBRTtJQUNELFVBQVUsRUFBRSxJQUFJO0lBQ2hCLE1BQU0sRUFBRTtRQUNOLFNBQVMsRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHO1lBQzFCLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUNqQixPQUFRLEdBQVcsQ0FBQyxHQUFHLENBQUM7WUFDeEIsT0FBUSxHQUFXLENBQUMsR0FBRyxDQUFDO1lBQ3hCLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQztLQUNGO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsY0FBYztBQUNkLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxpQkFBTSxDQUFlO0lBQ2pELE1BQU0sRUFBRTtRQUNOLElBQUksRUFBRSxpQkFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRO1FBQzNCLEdBQUcsRUFBRSxNQUFNO1FBQ1gsUUFBUSxFQUFFLElBQUk7UUFDZCxNQUFNLEVBQUUsSUFBSTtRQUNaLEtBQUssRUFBRSxJQUFJO0tBQ1o7SUFDRCxZQUFZLEVBQUU7UUFDWixJQUFJLEVBQUUsTUFBTTtRQUNaLE9BQU8sRUFBRSxDQUFDO1FBQ1YsR0FBRyxFQUFFLENBQUM7S0FDUDtJQUNELGFBQWEsRUFBRTtRQUNiLElBQUksRUFBRSxNQUFNO1FBQ1osT0FBTyxFQUFFLENBQUM7UUFDVixHQUFHLEVBQUUsQ0FBQztRQUNOLEdBQUcsRUFBRSxDQUFDO0tBQ1A7SUFDRCxrQkFBa0IsRUFBRTtRQUNsQixDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtRQUN2QyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtRQUN2QyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtRQUN2QyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtRQUN2QyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtLQUN4QztJQUNELFVBQVUsRUFBRSxDQUFDO1lBQ1gsR0FBRyxFQUFFO2dCQUNILElBQUksRUFBRSxNQUFNO2dCQUNaLFFBQVEsRUFBRSxJQUFJO2dCQUNkLElBQUksRUFBRSxJQUFJO2FBQ1g7WUFDRCxLQUFLLEVBQUU7Z0JBQ0wsSUFBSSxFQUFFLE1BQU07Z0JBQ1osUUFBUSxFQUFFLElBQUk7Z0JBQ2QsR0FBRyxFQUFFLENBQUM7YUFDUDtTQUNGLENBQUM7SUFDRixXQUFXLEVBQUU7UUFDWCxJQUFJLEVBQUUsSUFBSTtRQUNWLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRztLQUNsQjtDQUNGLEVBQUU7SUFDRCxVQUFVLEVBQUUsSUFBSTtJQUNoQixNQUFNLEVBQUU7UUFDTixTQUFTLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztZQUMxQixHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFDakIsT0FBUSxHQUFXLENBQUMsR0FBRyxDQUFDO1lBQ3hCLE9BQVEsR0FBVyxDQUFDLEdBQUcsQ0FBQztZQUN4QixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUM7S0FDRjtDQUNGLENBQUMsQ0FBQztBQUVILE9BQU87QUFDUCxZQUFZLENBQUMsS0FBSyxDQUFDLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVM7QUFDakYsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNyRCxZQUFZLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2hELFlBQVksQ0FBQyxLQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDakQsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFbEQsd0RBQXdEO0FBRXhELGVBQWU7QUFDZixZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLO0lBQzdCLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDcEQsTUFBTSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDM0MsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsWUFBWSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLFdBQVUsR0FBRztJQUN0RCxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ1IsTUFBTSxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDMUMsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsY0FBYztBQUNkLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxNQUErQjtJQUM5RCxNQUFNLE1BQU0sR0FBRyxrQkFBUSxDQUFDLEtBQUssQ0FBVSxRQUFRLENBQUMsQ0FBQztJQUNqRCxNQUFNLFdBQVcsR0FBRyxrQkFBUSxDQUFDLEtBQUssQ0FBZSxhQUFhLENBQUMsQ0FBQztJQUVoRSxNQUFNLE9BQU8sR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDaEMsVUFBVSxFQUFFLE1BQU07UUFDbEIsU0FBUyxFQUFFLEtBQUs7UUFDaEIsUUFBUSxFQUFFLEtBQUs7S0FDaEIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUNwQyxNQUFNLGFBQWEsR0FBRyxZQUFZLEdBQUcsQ0FBQztRQUNwQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxHQUFHLFlBQVk7UUFDeEUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVOLE1BQU0sa0JBQWtCLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztJQUM1RCxNQUFNLFNBQVMsR0FBOEIsRUFBRSxDQUFDO0lBRWhELE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDdkIsa0JBQWtCLENBQUMsTUFBTSxDQUFDLE1BQXlDLENBQUMsRUFBRSxDQUFDO1FBQ3ZFLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3hCLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDO1NBQ3pDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDdkMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1NBQ2pDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFjO0lBRS9CLE1BQU0sV0FBVyxDQUFDLGdCQUFnQixDQUNoQyxFQUFFLE1BQU0sRUFBRSxFQUNWO1FBQ0UsWUFBWTtRQUNaLGFBQWEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsU0FBUztRQUM3RCxrQkFBa0I7UUFDbEIsVUFBVTtRQUNWLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRTtLQUN4QixFQUNELEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQzVCLENBQUM7QUFDSixDQUFDO0FBRVksUUFBQSxNQUFNLEdBQUcsa0JBQVEsQ0FBQyxLQUFLLENBQVUsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ3pELFFBQUEsV0FBVyxHQUFHLGtCQUFRLENBQUMsS0FBSyxDQUFlLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVXNlclxcRGVza3RvcFxcdHJhZXByb2plY3RcXHRlc3QyXFxwZXQtZmluZGVyLWFwcFxcYmFja2VuZFxcc3JjXFxtb2RlbHNcXFJldmlldy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9uZ29vc2UsIHsgRG9jdW1lbnQsIFNjaGVtYSB9IGZyb20gJ21vbmdvb3NlJztcblxuLy8g6KmV5YO55LuL6Z2i5a6a576pXG5leHBvcnQgaW50ZXJmYWNlIElSZXZpZXcgZXh0ZW5kcyBEb2N1bWVudCB7XG4gIF9pZDogbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQ7XG4gIHJldmlld2VySWQ6IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkOyAvLyDoqZXlg7nogIVcbiAgcmV2aWV3ZWVJZDogbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQ7IC8vIOiiq+ipleWDueiAhVxuICBwZXRJZD86IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkOyAvLyDnm7jpl5zlr7XnialcbiAgY29udmVyc2F0aW9uSWQ/OiBtb25nb29zZS5UeXBlcy5PYmplY3RJZDsgLy8g55u46Zec5bCN6KmxXG4gIHJhdGluZzogbnVtYmVyOyAvLyAxLTUg5pif6KmV5YO5XG4gIGNvbnRlbnQ/OiBzdHJpbmc7XG4gIHRhZ3M6IHN0cmluZ1tdOyAvLyDoqZXlg7nmqJnnsaQgKOWmgjog5Y+L5ZaELCDmupbmmYIsIOiyoOiyrOS7u+etiSlcbiAgaXNBbm9ueW1vdXM6IGJvb2xlYW47XG4gIGlzRGVsZXRlZDogYm9vbGVhbjtcbiAgZGVsZXRlZEF0PzogRGF0ZTtcbiAgZGVsZXRlZEJ5PzogbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQ7XG4gIHJlcG9ydENvdW50OiBudW1iZXI7XG4gIGlzSGlkZGVuOiBib29sZWFuO1xuICBjcmVhdGVkQXQ6IERhdGU7XG4gIHVwZGF0ZWRBdDogRGF0ZTtcbn1cblxuLy8g6KmV5YO557Wx6KiI5LuL6Z2i5a6a576pXG5leHBvcnQgaW50ZXJmYWNlIElSZXZpZXdTdGF0cyBleHRlbmRzIERvY3VtZW50IHtcbiAgX2lkOiBtb25nb29zZS5UeXBlcy5PYmplY3RJZDtcbiAgdXNlcklkOiBtb25nb29zZS5UeXBlcy5PYmplY3RJZDtcbiAgdG90YWxSZXZpZXdzOiBudW1iZXI7XG4gIGF2ZXJhZ2VSYXRpbmc6IG51bWJlcjtcbiAgcmF0aW5nRGlzdHJpYnV0aW9uOiB7XG4gICAgMTogbnVtYmVyO1xuICAgIDI6IG51bWJlcjtcbiAgICAzOiBudW1iZXI7XG4gICAgNDogbnVtYmVyO1xuICAgIDU6IG51bWJlcjtcbiAgfTtcbiAgY29tbW9uVGFnczogQXJyYXk8e1xuICAgIHRhZzogc3RyaW5nO1xuICAgIGNvdW50OiBudW1iZXI7XG4gIH0+O1xuICBsYXN0VXBkYXRlZDogRGF0ZTtcbn1cblxuLy8g6KmV5YO5IFNjaGVtYVxuY29uc3QgcmV2aWV3U2NoZW1hID0gbmV3IFNjaGVtYTxJUmV2aWV3Pih7XG4gIHJldmlld2VySWQ6IHtcbiAgICB0eXBlOiBTY2hlbWEuVHlwZXMuT2JqZWN0SWQsXG4gICAgcmVmOiAnVXNlcicsXG4gICAgcmVxdWlyZWQ6IFt0cnVlLCAn6KmV5YO56ICFSUTngrrlv4XloavpoIXnm64nXSxcbiAgICBpbmRleDogdHJ1ZSxcbiAgfSxcbiAgcmV2aWV3ZWVJZDoge1xuICAgIHR5cGU6IFNjaGVtYS5UeXBlcy5PYmplY3RJZCxcbiAgICByZWY6ICdVc2VyJyxcbiAgICByZXF1aXJlZDogW3RydWUsICfooqvoqZXlg7nogIVJROeCuuW/heWhq+mgheebriddLFxuICAgIGluZGV4OiB0cnVlLFxuICB9LFxuICBwZXRJZDoge1xuICAgIHR5cGU6IFNjaGVtYS5UeXBlcy5PYmplY3RJZCxcbiAgICByZWY6ICdQZXQnLFxuICAgIGRlZmF1bHQ6IG51bGwsXG4gICAgaW5kZXg6IHRydWUsXG4gIH0sXG4gIGNvbnZlcnNhdGlvbklkOiB7XG4gICAgdHlwZTogU2NoZW1hLlR5cGVzLk9iamVjdElkLFxuICAgIHJlZjogJ0NvbnZlcnNhdGlvbicsXG4gICAgZGVmYXVsdDogbnVsbCxcbiAgfSxcbiAgcmF0aW5nOiB7XG4gICAgdHlwZTogTnVtYmVyLFxuICAgIHJlcXVpcmVkOiBbdHJ1ZSwgJ+ipleWDueWIhuaVuOeCuuW/heWhq+mgheebriddLFxuICAgIG1pbjogWzEsICfoqZXlg7nliIbmlbjmnIDkvY7ngrogMSddLFxuICAgIG1heDogWzUsICfoqZXlg7nliIbmlbjmnIDpq5jngrogNSddLFxuICAgIHZhbGlkYXRlOiB7XG4gICAgICB2YWxpZGF0b3I6IE51bWJlci5pc0ludGVnZXIsXG4gICAgICBtZXNzYWdlOiAn6KmV5YO55YiG5pW45b+F6aCI54K65pW05pW4JyxcbiAgICB9LFxuICB9LFxuICBjb250ZW50OiB7XG4gICAgdHlwZTogU3RyaW5nLFxuICAgIHRyaW06IHRydWUsXG4gICAgbWF4bGVuZ3RoOiBbNTAwLCAn6KmV5YO55YWn5a655LiN6IO96LaF6YGOIDUwMCDlgIvlrZfnrKYnXSxcbiAgICBkZWZhdWx0OiAnJyxcbiAgfSxcbiAgdGFnczogW3tcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgdHJpbTogdHJ1ZSxcbiAgICBtYXhsZW5ndGg6IFsyMCwgJ+aomeexpOmVt+W6puS4jeiDvei2hemBjiAyMCDlgIvlrZfnrKYnXSxcbiAgfV0sXG4gIGlzQW5vbnltb3VzOiB7XG4gICAgdHlwZTogQm9vbGVhbixcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgfSxcbiAgaXNEZWxldGVkOiB7XG4gICAgdHlwZTogQm9vbGVhbixcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICBpbmRleDogdHJ1ZSxcbiAgfSxcbiAgZGVsZXRlZEF0OiB7XG4gICAgdHlwZTogRGF0ZSxcbiAgICBkZWZhdWx0OiBudWxsLFxuICB9LFxuICBkZWxldGVkQnk6IHtcbiAgICB0eXBlOiBTY2hlbWEuVHlwZXMuT2JqZWN0SWQsXG4gICAgcmVmOiAnVXNlcicsXG4gICAgZGVmYXVsdDogbnVsbCxcbiAgfSxcbiAgcmVwb3J0Q291bnQ6IHtcbiAgICB0eXBlOiBOdW1iZXIsXG4gICAgZGVmYXVsdDogMCxcbiAgICBtaW46IDAsXG4gIH0sXG4gIGlzSGlkZGVuOiB7XG4gICAgdHlwZTogQm9vbGVhbixcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICBpbmRleDogdHJ1ZSxcbiAgfSxcbn0sIHtcbiAgdGltZXN0YW1wczogdHJ1ZSxcbiAgdG9KU09OOiB7XG4gICAgdHJhbnNmb3JtOiBmdW5jdGlvbihkb2MsIHJldCkge1xuICAgICAgcmV0LmlkID0gcmV0Ll9pZDtcbiAgICAgIGRlbGV0ZSAocmV0IGFzIGFueSkuX2lkO1xuICAgICAgZGVsZXRlIChyZXQgYXMgYW55KS5fX3Y7XG4gICAgICByZXR1cm4gcmV0O1xuICAgIH0sXG4gIH0sXG59KTtcblxuLy8g6KmV5YO557Wx6KiIIFNjaGVtYVxuY29uc3QgcmV2aWV3U3RhdHNTY2hlbWEgPSBuZXcgU2NoZW1hPElSZXZpZXdTdGF0cz4oe1xuICB1c2VySWQ6IHtcbiAgICB0eXBlOiBTY2hlbWEuVHlwZXMuT2JqZWN0SWQsXG4gICAgcmVmOiAnVXNlcicsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgdW5pcXVlOiB0cnVlLFxuICAgIGluZGV4OiB0cnVlLFxuICB9LFxuICB0b3RhbFJldmlld3M6IHtcbiAgICB0eXBlOiBOdW1iZXIsXG4gICAgZGVmYXVsdDogMCxcbiAgICBtaW46IDAsXG4gIH0sXG4gIGF2ZXJhZ2VSYXRpbmc6IHtcbiAgICB0eXBlOiBOdW1iZXIsXG4gICAgZGVmYXVsdDogMCxcbiAgICBtaW46IDAsXG4gICAgbWF4OiA1LFxuICB9LFxuICByYXRpbmdEaXN0cmlidXRpb246IHtcbiAgICAxOiB7IHR5cGU6IE51bWJlciwgZGVmYXVsdDogMCwgbWluOiAwIH0sXG4gICAgMjogeyB0eXBlOiBOdW1iZXIsIGRlZmF1bHQ6IDAsIG1pbjogMCB9LFxuICAgIDM6IHsgdHlwZTogTnVtYmVyLCBkZWZhdWx0OiAwLCBtaW46IDAgfSxcbiAgICA0OiB7IHR5cGU6IE51bWJlciwgZGVmYXVsdDogMCwgbWluOiAwIH0sXG4gICAgNTogeyB0eXBlOiBOdW1iZXIsIGRlZmF1bHQ6IDAsIG1pbjogMCB9LFxuICB9LFxuICBjb21tb25UYWdzOiBbe1xuICAgIHRhZzoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICB0cmltOiB0cnVlLFxuICAgIH0sXG4gICAgY291bnQ6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgbWluOiAxLFxuICAgIH0sXG4gIH1dLFxuICBsYXN0VXBkYXRlZDoge1xuICAgIHR5cGU6IERhdGUsXG4gICAgZGVmYXVsdDogRGF0ZS5ub3csXG4gIH0sXG59LCB7XG4gIHRpbWVzdGFtcHM6IHRydWUsXG4gIHRvSlNPTjoge1xuICAgIHRyYW5zZm9ybTogZnVuY3Rpb24oZG9jLCByZXQpIHtcbiAgICAgIHJldC5pZCA9IHJldC5faWQ7XG4gICAgICBkZWxldGUgKHJldCBhcyBhbnkpLl9pZDtcbiAgICAgIGRlbGV0ZSAocmV0IGFzIGFueSkuX192O1xuICAgICAgcmV0dXJuIHJldDtcbiAgICB9LFxuICB9LFxufSk7XG5cbi8vIOikh+WQiOe0ouW8lVxucmV2aWV3U2NoZW1hLmluZGV4KHsgcmV2aWV3ZXJJZDogMSwgcmV2aWV3ZWVJZDogMSB9LCB7IHVuaXF1ZTogdHJ1ZSB9KTsgLy8g6Ziy5q2i6YeN6KSH6KmV5YO5XG5yZXZpZXdTY2hlbWEuaW5kZXgoeyByZXZpZXdlZUlkOiAxLCBjcmVhdGVkQXQ6IC0xIH0pO1xucmV2aWV3U2NoZW1hLmluZGV4KHsgcGV0SWQ6IDEsIGNyZWF0ZWRBdDogLTEgfSk7XG5yZXZpZXdTY2hlbWEuaW5kZXgoeyByYXRpbmc6IDEsIGNyZWF0ZWRBdDogLTEgfSk7XG5yZXZpZXdTY2hlbWEuaW5kZXgoeyBpc0RlbGV0ZWQ6IDEsIGlzSGlkZGVuOiAxIH0pO1xuXG4vLyDms6jmhI/vvJrmn6XoqaLmmYLpnIDopoHmiYvli5Xmt7vliqAgeyBpc0RlbGV0ZWQ6IGZhbHNlLCBpc0hpZGRlbjogZmFsc2UgfSDmop3ku7ZcblxuLy8g6KmV5YO55b6M5pu05paw57Wx6KiI55qE5Lit5LuL6Luf6auUXG5yZXZpZXdTY2hlbWEucG9zdCgnc2F2ZScsIGFzeW5jIGZ1bmN0aW9uKCkge1xuICBpZiAodGhpcy5pc05ldyAmJiAhdGhpcy5pc0RlbGV0ZWQgJiYgIXRoaXMuaXNIaWRkZW4pIHtcbiAgICBhd2FpdCB1cGRhdGVSZXZpZXdTdGF0cyh0aGlzLnJldmlld2VlSWQpO1xuICB9XG59KTtcblxucmV2aWV3U2NoZW1hLnBvc3QoJ2ZpbmRPbmVBbmRVcGRhdGUnLCBhc3luYyBmdW5jdGlvbihkb2MpIHtcbiAgaWYgKGRvYykge1xuICAgIGF3YWl0IHVwZGF0ZVJldmlld1N0YXRzKGRvYy5yZXZpZXdlZUlkKTtcbiAgfVxufSk7XG5cbi8vIOabtOaWsOipleWDuee1seioiOeahOi8lOWKqeWHveaVuFxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlUmV2aWV3U3RhdHModXNlcklkOiBtb25nb29zZS5UeXBlcy5PYmplY3RJZCkge1xuICBjb25zdCBSZXZpZXcgPSBtb25nb29zZS5tb2RlbDxJUmV2aWV3PignUmV2aWV3Jyk7XG4gIGNvbnN0IFJldmlld1N0YXRzID0gbW9uZ29vc2UubW9kZWw8SVJldmlld1N0YXRzPignUmV2aWV3U3RhdHMnKTtcbiAgXG4gIGNvbnN0IHJldmlld3MgPSBhd2FpdCBSZXZpZXcuZmluZCh7IFxuICAgIHJldmlld2VlSWQ6IHVzZXJJZCwgXG4gICAgaXNEZWxldGVkOiBmYWxzZSwgXG4gICAgaXNIaWRkZW46IGZhbHNlIFxuICB9KTtcbiAgXG4gIGNvbnN0IHRvdGFsUmV2aWV3cyA9IHJldmlld3MubGVuZ3RoO1xuICBjb25zdCBhdmVyYWdlUmF0aW5nID0gdG90YWxSZXZpZXdzID4gMCBcbiAgICA/IHJldmlld3MucmVkdWNlKChzdW0sIHJldmlldykgPT4gc3VtICsgcmV2aWV3LnJhdGluZywgMCkgLyB0b3RhbFJldmlld3MgXG4gICAgOiAwO1xuICBcbiAgY29uc3QgcmF0aW5nRGlzdHJpYnV0aW9uID0geyAxOiAwLCAyOiAwLCAzOiAwLCA0OiAwLCA1OiAwIH07XG4gIGNvbnN0IHRhZ0NvdW50czogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSA9IHt9O1xuICBcbiAgcmV2aWV3cy5mb3JFYWNoKHJldmlldyA9PiB7XG4gICAgcmF0aW5nRGlzdHJpYnV0aW9uW3Jldmlldy5yYXRpbmcgYXMga2V5b2YgdHlwZW9mIHJhdGluZ0Rpc3RyaWJ1dGlvbl0rKztcbiAgICByZXZpZXcudGFncy5mb3JFYWNoKHRhZyA9PiB7XG4gICAgICB0YWdDb3VudHNbdGFnXSA9ICh0YWdDb3VudHNbdGFnXSB8fCAwKSArIDE7XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgY29uc3QgY29tbW9uVGFncyA9IE9iamVjdC5lbnRyaWVzKHRhZ0NvdW50cylcbiAgICAubWFwKChbdGFnLCBjb3VudF0pID0+ICh7IHRhZywgY291bnQgfSkpXG4gICAgLnNvcnQoKGEsIGIpID0+IGIuY291bnQgLSBhLmNvdW50KVxuICAgIC5zbGljZSgwLCAxMCk7IC8vIOWPluWJjTEw5YCL5pyA5bi46KaL55qE5qiZ57GkXG4gIFxuICBhd2FpdCBSZXZpZXdTdGF0cy5maW5kT25lQW5kVXBkYXRlKFxuICAgIHsgdXNlcklkIH0sXG4gICAge1xuICAgICAgdG90YWxSZXZpZXdzLFxuICAgICAgYXZlcmFnZVJhdGluZzogTWF0aC5yb3VuZChhdmVyYWdlUmF0aW5nICogMTApIC8gMTAsIC8vIOS/neeVmeS4gOS9jeWwj+aVuFxuICAgICAgcmF0aW5nRGlzdHJpYnV0aW9uLFxuICAgICAgY29tbW9uVGFncyxcbiAgICAgIGxhc3RVcGRhdGVkOiBuZXcgRGF0ZSgpLFxuICAgIH0sXG4gICAgeyB1cHNlcnQ6IHRydWUsIG5ldzogdHJ1ZSB9XG4gICk7XG59XG5cbmV4cG9ydCBjb25zdCBSZXZpZXcgPSBtb25nb29zZS5tb2RlbDxJUmV2aWV3PignUmV2aWV3JywgcmV2aWV3U2NoZW1hKTtcbmV4cG9ydCBjb25zdCBSZXZpZXdTdGF0cyA9IG1vbmdvb3NlLm1vZGVsPElSZXZpZXdTdGF0cz4oJ1Jldmlld1N0YXRzJywgcmV2aWV3U3RhdHNTY2hlbWEpOyJdLCJ2ZXJzaW9uIjozfQ==