0c463249c0ba52a9a7a5c77728a1243e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.adminRoutes = void 0;
const express_1 = require("express");
const express_validator_1 = require("express-validator");
const logger_1 = require("../utils/logger");
const errors_1 = require("../utils/errors");
const userService_1 = require("../services/userService");
const auth_1 = require("../middleware/auth");
const rbac_1 = require("../middleware/rbac");
const router = (0, express_1.Router)();
exports.adminRoutes = router;
const userService = new userService_1.UserService();
// 通用中介軟體 - 所有管理員路由都需要認證和活躍帳號
router.use(auth_1.authenticate);
router.use(rbac_1.requireActiveAccount);
// 獲取用戶列表（需要用戶讀取權限）
router.get("/users", (0, rbac_1.requirePermission)(rbac_1.Permission.USER_READ), [
    (0, express_validator_1.query)("page").optional().isInt({ min: 1 }),
    (0, express_validator_1.query)("limit").optional().isInt({ min: 1, max: 100 }),
    (0, express_validator_1.query)("search").optional().isString(),
    (0, express_validator_1.query)("role").optional().isIn(["user", "moderator", "admin"]),
    (0, express_validator_1.query)("isActive").optional().isBoolean(),
    (0, express_validator_1.query)("isEmailVerified").optional().isBoolean(),
], async (req, res) => {
    try {
        const errors = (0, express_validator_1.validationResult)(req);
        if (!errors.isEmpty()) {
            res.status(400).json({
                success: false,
                message: "查詢參數驗證失敗",
                errors: errors.array(),
            });
            return;
        }
        const { page = 1, limit = 20, search, role, isActive, isEmailVerified, } = req.query;
        // 使用 UserService 獲取用戶列表
        const result = await userService.getAdminUserList({
            page: Number(page),
            limit: Number(limit),
            search: search,
            role: role,
            isActive: isActive === "true",
            isEmailVerified: isEmailVerified === "true",
        });
        const { users, total, totalPages } = result;
        logger_1.logger.info("獲取用戶列表成功", {
            adminId: req.user._id,
            page,
            limit,
            total,
        });
        res.json({
            success: true,
            data: {
                users,
                pagination: {
                    current: Number(page),
                    total: totalPages,
                    count: users.length,
                    totalCount: total,
                },
            },
        });
    }
    catch (error) {
        logger_1.logger.error("獲取用戶列表失敗", { error });
        res.status(500).json({
            success: false,
            message: "獲取用戶列表失敗，請稍後再試",
        });
    }
});
// 獲取單個用戶詳情（需要用戶讀取權限）
router.get("/users/:userId", (0, rbac_1.requirePermission)(rbac_1.Permission.USER_READ), async (req, res) => {
    try {
        const { userId } = req.params;
        if (!userId) {
            res.status(400).json({
                success: false,
                message: "用戶 ID 為必填項目",
            });
            return;
        }
        const user = await userService.getAdminUserById(userId);
        logger_1.logger.info("獲取用戶詳情成功", {
            adminId: req.user._id,
            targetUserId: userId,
        });
        res.json({
            success: true,
            data: { user },
        });
    }
    catch (error) {
        logger_1.logger.error("獲取用戶詳情失敗", { error });
        res.status(500).json({
            success: false,
            message: "獲取用戶詳情失敗，請稍後再試",
        });
    }
});
// 更新用戶資料（需要用戶寫入權限）
router.put("/users/:userId", (0, rbac_1.requirePermission)(rbac_1.Permission.USER_WRITE), [
    (0, express_validator_1.body)("name").optional().trim().isLength({ min: 1, max: 50 }),
    (0, express_validator_1.body)("phone").optional().isMobilePhone("zh-TW"),
    (0, express_validator_1.body)("role").optional().isIn(["user", "moderator", "admin"]),
    (0, express_validator_1.body)("isActive").optional().isBoolean(),
], async (req, res) => {
    try {
        const errors = (0, express_validator_1.validationResult)(req);
        if (!errors.isEmpty()) {
            res.status(400).json({
                success: false,
                message: "輸入資料驗證失敗",
                errors: errors.array(),
            });
            return;
        }
        const { userId } = req.params;
        const { name, phone, role, isActive } = req.body;
        const adminUser = req.user;
        if (!userId) {
            res.status(400).json({
                success: false,
                message: "用戶 ID 為必填項目",
            });
            return;
        }
        // 使用 UserService 更新用戶資料
        const updatedUser = await userService.adminUpdateUser(userId, { name, phone, role, isActive }, adminUser);
        res.json({
            success: true,
            message: "用戶資料更新成功",
            data: { user: updatedUser },
        });
    }
    catch (error) {
        logger_1.logger.error("管理員更新用戶資料失敗", { error });
        if (error instanceof errors_1.AppError) {
            res.status(error.statusCode).json({
                success: false,
                message: error.message,
            });
            return;
        }
        res.status(500).json({
            success: false,
            message: "更新用戶資料失敗，請稍後再試",
        });
    }
});
// 刪除用戶（需要用戶刪除權限）
router.delete("/users/:userId", (0, rbac_1.requirePermission)(rbac_1.Permission.USER_DELETE), async (req, res) => {
    try {
        const { userId } = req.params;
        const adminUser = req.user;
        if (!userId) {
            res.status(400).json({
                success: false,
                message: "用戶 ID 為必填項目",
            });
            return;
        }
        // 使用 UserService 刪除用戶
        await userService.adminDeleteUser(userId, adminUser);
        res.json({
            success: true,
            message: "用戶已被刪除",
        });
    }
    catch (error) {
        logger_1.logger.error("管理員刪除用戶失敗", { error });
        res.status(500).json({
            success: false,
            message: "刪除用戶失敗，請稍後再試",
        });
    }
});
// 重設用戶密碼（需要用戶管理權限）
router.post("/users/:userId/reset-password", (0, rbac_1.requirePermission)(rbac_1.Permission.USER_ADMIN), async (req, res) => {
    try {
        const { userId } = req.params;
        const adminUser = req.user;
        if (!userId) {
            res.status(400).json({
                success: false,
                message: "用戶 ID 為必填項目",
            });
            return;
        }
        // 使用 UserService 重設用戶密碼
        const tempPassword = await userService.adminResetUserPassword(userId, adminUser);
        // 發送新密碼郵件（這裡簡化處理，實際應該發送重設連結）
        // await EmailService.sendPasswordResetEmail(targetUser.email, resetToken, targetUser.name);
        res.json({
            success: true,
            message: "密碼重設成功，臨時密碼已發送到用戶郵箱",
            data: {
                tempPassword, // 實際環境中不應該返回密碼
            },
        });
    }
    catch (error) {
        logger_1.logger.error("管理員重設用戶密碼失敗", { error });
        res.status(500).json({
            success: false,
            message: "重設密碼失敗，請稍後再試",
        });
    }
});
// 系統統計（需要分析讀取權限）
router.get("/stats", (0, rbac_1.requirePermission)(rbac_1.Permission.ANALYTICS_READ), async (req, res) => {
    try {
        // 使用 UserService 獲取系統統計
        const stats = await userService.getSystemStatistics();
        logger_1.logger.info("獲取系統統計成功", {
            adminId: req.user._id,
        });
        res.json({
            success: true,
            data: stats,
        });
    }
    catch (error) {
        logger_1.logger.error("獲取系統統計失敗", { error });
        res.status(500).json({
            success: false,
            message: "獲取統計數據失敗，請稍後再試",
        });
    }
});
// 清理過期驗證令牌（需要系統配置權限）
router.post("/cleanup/expired-tokens", (0, rbac_1.requirePermission)(rbac_1.Permission.SYSTEM_CONFIG), async (req, res) => {
    try {
        // 使用 UserService 清理過期驗證令牌
        const result = await userService.cleanupExpiredTokens();
        logger_1.logger.info("清理過期令牌成功", {
            adminId: req.user._id,
            cleanedCount: result.deletedCount,
        });
        res.json({
            success: true,
            message: `已清理 ${result.deletedCount} 個過期驗證令牌`,
            data: { cleanedCount: result.deletedCount },
        });
    }
    catch (error) {
        logger_1.logger.error("清理過期令牌失敗", { error });
        res.status(500).json({
            success: false,
            message: "清理失敗，請稍後再試",
        });
    }
});
// 獲取當前管理員權限
router.get("/permissions", async (req, res) => {
    try {
        const user = req.user;
        const permissions = (0, rbac_1.getUserPermissions)(user);
        res.json({
            success: true,
            data: {
                role: user.role,
                permissions,
            },
        });
    }
    catch (error) {
        logger_1.logger.error("獲取管理員權限失敗", { error });
        res.status(500).json({
            success: false,
            message: "獲取權限失敗，請稍後再試",
        });
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcYWRtaW4udHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQW9EO0FBQ3BELHlEQUFrRTtBQUNsRSw0Q0FBeUM7QUFDekMsNENBQTJDO0FBQzNDLHlEQUFzRDtBQUV0RCw2Q0FBa0Q7QUFDbEQsNkNBTTRCO0FBRzVCLE1BQU0sTUFBTSxHQUFHLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBcVZMLDZCQUFXO0FBcFY5QixNQUFNLFdBQVcsR0FBRyxJQUFJLHlCQUFXLEVBQUUsQ0FBQztBQUV0Qyw2QkFBNkI7QUFDN0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBWSxDQUFDLENBQUM7QUFDekIsTUFBTSxDQUFDLEdBQUcsQ0FBQywyQkFBb0IsQ0FBQyxDQUFDO0FBRWpDLG1CQUFtQjtBQUNuQixNQUFNLENBQUMsR0FBRyxDQUNSLFFBQVEsRUFDUixJQUFBLHdCQUFpQixFQUFDLGlCQUFVLENBQUMsU0FBUyxDQUFDLEVBQ3ZDO0lBQ0UsSUFBQSx5QkFBSyxFQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQztJQUMxQyxJQUFBLHlCQUFLLEVBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7SUFDckQsSUFBQSx5QkFBSyxFQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNyQyxJQUFBLHlCQUFLLEVBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM3RCxJQUFBLHlCQUFLLEVBQUMsVUFBVSxDQUFDLENBQUMs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QUMsSUFBYSxDQUFDO1FBQy9CLE1BQU0sV0FBVyxHQUFHLElBQUEseUJBQWtCLEVBQUMsSUFBSSxDQUFDLENBQUM7UUFFN0MsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNQLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFO2dCQUNKLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtnQkFDZixXQUFXO2FBQ1o7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLGVBQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUNyQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixPQUFPLEVBQUUsS0FBSztZQUNkLE9BQU8sRUFBRSxjQUFjO1NBQ3hCLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQ0YsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccm91dGVzXFxhZG1pbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIsIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7IGJvZHksIHF1ZXJ5LCB2YWxpZGF0aW9uUmVzdWx0IH0gZnJvbSBcImV4cHJlc3MtdmFsaWRhdG9yXCI7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwiLi4vdXRpbHMvbG9nZ2VyXCI7XG5pbXBvcnQgeyBBcHBFcnJvciB9IGZyb20gXCIuLi91dGlscy9lcnJvcnNcIjtcbmltcG9ydCB7IFVzZXJTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3VzZXJTZXJ2aWNlXCI7XG5pbXBvcnQgeyBWZXJpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3ZlcmlmaWNhdGlvblNlcnZpY2VcIjtcbmltcG9ydCB7IGF1dGhlbnRpY2F0ZSB9IGZyb20gXCIuLi9taWRkbGV3YXJlL2F1dGhcIjtcbmltcG9ydCB7XG4gIHJlcXVpcmVQZXJtaXNzaW9uLFxuICByZXF1aXJlUm9sZSxcbiAgcmVxdWlyZUFjdGl2ZUFjY291bnQsXG4gIFBlcm1pc3Npb24sXG4gIGdldFVzZXJQZXJtaXNzaW9ucyxcbn0gZnJvbSBcIi4uL21pZGRsZXdhcmUvcmJhY1wiO1xuaW1wb3J0IHsgSVVzZXIgfSBmcm9tIFwiLi4vbW9kZWxzL1VzZXJcIjtcblxuY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5jb25zdCB1c2VyU2VydmljZSA9IG5ldyBVc2VyU2VydmljZSgpO1xuXG4vLyDpgJrnlKjkuK3ku4vou5/pq5QgLSDmiYDmnInnrqHnkIblk6Hot6/nlLHpg73pnIDopoHoqo3orYnlkozmtLvouo3luLPomZ9cbnJvdXRlci51c2UoYXV0aGVudGljYXRlKTtcbnJvdXRlci51c2UocmVxdWlyZUFjdGl2ZUFjY291bnQpO1xuXG4vLyDnjbLlj5bnlKjmiLbliJfooajvvIjpnIDopoHnlKjmiLboroDlj5bmrIrpmZDvvIlcbnJvdXRlci5nZXQoXG4gIFwiL3VzZXJzXCIsXG4gIHJlcXVpcmVQZXJtaXNzaW9uKFBlcm1pc3Npb24uVVNFUl9SRUFEKSxcbiAgW1xuICAgIHF1ZXJ5KFwicGFnZVwiKS5vcHRpb25hbCgpLmlzSW50KHsgbWluOiAxIH0pLFxuICAgIHF1ZXJ5KFwibGltaXRcIikub3B0aW9uYWwoKS5pc0ludCh7IG1pbjogMSwgbWF4OiAxMDAgfSksXG4gICAgcXVlcnkoXCJzZWFyY2hcIikub3B0aW9uYWwoKS5pc1N0cmluZygpLFxuICAgIHF1ZXJ5KFwicm9sZVwiKS5vcHRpb25hbCgpLmlzSW4oW1widXNlclwiLCBcIm1vZGVyYXRvclwiLCBcImFkbWluXCJdKSxcbiAgICBxdWVyeShcImlzQWN0aXZlXCIpLm9wdGlvbmFsKCkuaXNCb29sZWFuKCksXG4gICAgcXVlcnkoXCJpc0VtYWlsVmVyaWZpZWRcIikub3B0aW9uYWwoKS5pc0Jvb2xlYW4oKSxcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XG4gICAgICBpZiAoIWVycm9ycy5pc0VtcHR5KCkpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6IFwi5p+l6Kmi5Y+D5pW46amX6K2J5aSx5pWXXCIsXG4gICAgICAgICAgZXJyb3JzOiBlcnJvcnMuYXJyYXkoKSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3Qge1xuICAgICAgICBwYWdlID0gMSxcbiAgICAgICAgbGltaXQgPSAyMCxcbiAgICAgICAgc2VhcmNoLFxuICAgICAgICByb2xlLFxuICAgICAgICBpc0FjdGl2ZSxcbiAgICAgICAgaXNFbWFpbFZlcmlmaWVkLFxuICAgICAgfSA9IHJlcS5xdWVyeTtcblxuICAgICAgLy8g5L2/55SoIFVzZXJTZXJ2aWNlIOeNsuWPlueUqOaItuWIl+ihqFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0QWRtaW5Vc2VyTGlzdCh7XG4gICAgICAgIHBhZ2U6IE51bWJlcihwYWdlKSxcbiAgICAgICAgbGltaXQ6IE51bWJlcihsaW1pdCksXG4gICAgICAgIHNlYXJjaDogc2VhcmNoIGFzIHN0cmluZyxcbiAgICAgICAgcm9sZTogcm9sZSBhcyBcInVzZXJcIiB8IFwibW9kZXJhdG9yXCIgfCBcImFkbWluXCIsXG4gICAgICAgIGlzQWN0aXZlOiBpc0FjdGl2ZSA9PT0gXCJ0cnVlXCIsXG4gICAgICAgIGlzRW1haWxWZXJpZmllZDogaXNFbWFpbFZlcmlmaWVkID09PSBcInRydWVcIixcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB7IHVzZXJzLCB0b3RhbCwgdG90YWxQYWdlcyB9ID0gcmVzdWx0O1xuXG4gICAgICBsb2dnZXIuaW5mbyhcIueNsuWPlueUqOaItuWIl+ihqOaIkOWKn1wiLCB7XG4gICAgICAgIGFkbWluSWQ6IChyZXEudXNlciBhcyBJVXNlcikuX2lkLFxuICAgICAgICBwYWdlLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgdG90YWwsXG4gICAgICB9KTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdXNlcnMsXG4gICAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgICAgY3VycmVudDogTnVtYmVyKHBhZ2UpLFxuICAgICAgICAgICAgdG90YWw6IHRvdGFsUGFnZXMsXG4gICAgICAgICAgICBjb3VudDogdXNlcnMubGVuZ3RoLFxuICAgICAgICAgICAgdG90YWxDb3VudDogdG90YWwsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCLnjbLlj5bnlKjmiLbliJfooajlpLHmlZdcIiwgeyBlcnJvciB9KTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IFwi542y5Y+W55So5oi25YiX6KGo5aSx5pWX77yM6KuL56iN5b6M5YaN6KmmXCIsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG4pO1xuXG4vLyDnjbLlj5bllq7lgIvnlKjmiLboqbPmg4XvvIjpnIDopoHnlKjmiLboroDlj5bmrIrpmZDvvIlcbnJvdXRlci5nZXQoXG4gIFwiL3VzZXJzLzp1c2VySWRcIixcbiAgcmVxdWlyZVBlcm1pc3Npb24oUGVybWlzc2lvbi5VU0VSX1JFQUQpLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSByZXEucGFyYW1zO1xuXG4gICAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogXCLnlKjmiLYgSUQg54K65b+F5aGr6aCF55uuXCIsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB1c2VyU2VydmljZS5nZXRBZG1pblVzZXJCeUlkKHVzZXJJZCk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKFwi542y5Y+W55So5oi26Kmz5oOF5oiQ5YqfXCIsIHtcbiAgICAgICAgYWRtaW5JZDogKHJlcS51c2VyIGFzIElVc2VyKS5faWQsXG4gICAgICAgIHRhcmdldFVzZXJJZDogdXNlcklkLFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogeyB1c2VyIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi542y5Y+W55So5oi26Kmz5oOF5aSx5pWXXCIsIHsgZXJyb3IgfSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBcIueNsuWPlueUqOaItuips+aDheWkseaVl++8jOiri+eojeW+jOWGjeipplwiLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuKTtcblxuLy8g5pu05paw55So5oi26LOH5paZ77yI6ZyA6KaB55So5oi25a+r5YWl5qyK6ZmQ77yJXG5yb3V0ZXIucHV0KFxuICBcIi91c2Vycy86dXNlcklkXCIsXG4gIHJlcXVpcmVQZXJtaXNzaW9uKFBlcm1pc3Npb24uVVNFUl9XUklURSksXG4gIFtcbiAgICBib2R5KFwibmFtZVwiKS5vcHRpb25hbCgpLnRyaW0oKS5pc0xlbmd0aCh7IG1pbjogMSwgbWF4OiA1MCB9KSxcbiAgICBib2R5KFwicGhvbmVcIikub3B0aW9uYWwoKS5pc01vYmlsZVBob25lKFwiemgtVFdcIiksXG4gICAgYm9keShcInJvbGVcIikub3B0aW9uYWwoKS5pc0luKFtcInVzZXJcIiwgXCJtb2RlcmF0b3JcIiwgXCJhZG1pblwiXSksXG4gICAgYm9keShcImlzQWN0aXZlXCIpLm9wdGlvbmFsKCkuaXNCb29sZWFuKCksXG4gIF0sXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xuICAgICAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiBcIui8uOWFpeizh+aWmempl+itieWkseaVl1wiLFxuICAgICAgICAgIGVycm9yczogZXJyb3JzLmFycmF5KCksXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgeyBuYW1lLCBwaG9uZSwgcm9sZSwgaXNBY3RpdmUgfSA9IHJlcS5ib2R5O1xuICAgICAgY29uc3QgYWRtaW5Vc2VyID0gcmVxLnVzZXIgYXMgSVVzZXI7XG5cbiAgICAgIGlmICghdXNlcklkKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiBcIueUqOaItiBJRCDngrrlv4XloavpoIXnm65cIixcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8g5L2/55SoIFVzZXJTZXJ2aWNlIOabtOaWsOeUqOaItuizh+aWmVxuICAgICAgY29uc3QgdXBkYXRlZFVzZXIgPSBhd2FpdCB1c2VyU2VydmljZS5hZG1pblVwZGF0ZVVzZXIoXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgeyBuYW1lLCBwaG9uZSwgcm9sZSwgaXNBY3RpdmUgfSxcbiAgICAgICAgYWRtaW5Vc2VyLFxuICAgICAgKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiBcIueUqOaItuizh+aWmeabtOaWsOaIkOWKn1wiLFxuICAgICAgICBkYXRhOiB7IHVzZXI6IHVwZGF0ZWRVc2VyIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi566h55CG5ZOh5pu05paw55So5oi26LOH5paZ5aSx5pWXXCIsIHsgZXJyb3IgfSk7XG5cbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEFwcEVycm9yKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoZXJyb3Iuc3RhdHVzQ29kZSkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogXCLmm7TmlrDnlKjmiLbos4fmlpnlpLHmlZfvvIzoq4vnqI3lvozlho3oqaZcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcbik7XG5cbi8vIOWIqumZpOeUqOaItu+8iOmcgOimgeeUqOaItuWIqumZpOasiumZkO+8iVxucm91dGVyLmRlbGV0ZShcbiAgXCIvdXNlcnMvOnVzZXJJZFwiLFxuICByZXF1aXJlUGVybWlzc2lvbihQZXJtaXNzaW9uLlVTRVJfREVMRVRFKSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHVzZXJJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGFkbWluVXNlciA9IHJlcS51c2VyIGFzIElVc2VyO1xuXG4gICAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogXCLnlKjmiLYgSUQg54K65b+F5aGr6aCF55uuXCIsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIOS9v+eUqCBVc2VyU2VydmljZSDliKrpmaTnlKjmiLZcbiAgICAgIGF3YWl0IHVzZXJTZXJ2aWNlLmFkbWluRGVsZXRlVXNlcih1c2VySWQsIGFkbWluVXNlcik7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgbWVzc2FnZTogXCLnlKjmiLblt7LooqvliKrpmaRcIixcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCLnrqHnkIblk6HliKrpmaTnlKjmiLblpLHmlZdcIiwgeyBlcnJvciB9KTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IFwi5Yiq6Zmk55So5oi25aSx5pWX77yM6KuL56iN5b6M5YaN6KmmXCIsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG4pO1xuXG4vLyDph43oqK3nlKjmiLblr4bnorzvvIjpnIDopoHnlKjmiLbnrqHnkIbmrIrpmZDvvIlcbnJvdXRlci5wb3N0KFxuICBcIi91c2Vycy86dXNlcklkL3Jlc2V0LXBhc3N3b3JkXCIsXG4gIHJlcXVpcmVQZXJtaXNzaW9uKFBlcm1pc3Npb24uVVNFUl9BRE1JTiksXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyB1c2VySWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCBhZG1pblVzZXIgPSByZXEudXNlciBhcyBJVXNlcjtcblxuICAgICAgaWYgKCF1c2VySWQpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6IFwi55So5oi2IElEIOeCuuW/heWhq+mgheebrlwiLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyDkvb/nlKggVXNlclNlcnZpY2Ug6YeN6Kit55So5oi25a+G56K8XG4gICAgICBjb25zdCB0ZW1wUGFzc3dvcmQgPSBhd2FpdCB1c2VyU2VydmljZS5hZG1pblJlc2V0VXNlclBhc3N3b3JkKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGFkbWluVXNlcixcbiAgICAgICk7XG5cbiAgICAgIC8vIOeZvOmAgeaWsOWvhueivOmDteS7tu+8iOmAmeijoeewoeWMluiZleeQhu+8jOWvpumam+aHieipsueZvOmAgemHjeioremAo+e1kO+8iVxuICAgICAgLy8gYXdhaXQgRW1haWxTZXJ2aWNlLnNlbmRQYXNzd29yZFJlc2V0RW1haWwodGFyZ2V0VXNlci5lbWFpbCwgcmVzZXRUb2tlbiwgdGFyZ2V0VXNlci5uYW1lKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiBcIuWvhueivOmHjeioreaIkOWKn++8jOiHqOaZguWvhueivOW3sueZvOmAgeWIsOeUqOaItumDteeusVwiLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdGVtcFBhc3N3b3JkLCAvLyDlr6bpmpvnkrDlooPkuK3kuI3mh4noqbLov5Tlm57lr4bnorxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCLnrqHnkIblk6Hph43oqK3nlKjmiLblr4bnorzlpLHmlZdcIiwgeyBlcnJvciB9KTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IFwi6YeN6Kit5a+G56K85aSx5pWX77yM6KuL56iN5b6M5YaN6KmmXCIsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG4pO1xuXG4vLyDns7vntbHntbHoqIjvvIjpnIDopoHliIbmnpDoroDlj5bmrIrpmZDvvIlcbnJvdXRlci5nZXQoXG4gIFwiL3N0YXRzXCIsXG4gIHJlcXVpcmVQZXJtaXNzaW9uKFBlcm1pc3Npb24uQU5BTFlUSUNTX1JFQUQpLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIOS9v+eUqCBVc2VyU2VydmljZSDnjbLlj5bns7vntbHntbHoqIhcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0U3lzdGVtU3RhdGlzdGljcygpO1xuXG4gICAgICBsb2dnZXIuaW5mbyhcIueNsuWPluezu+e1see1seioiOaIkOWKn1wiLCB7XG4gICAgICAgIGFkbWluSWQ6IChyZXEudXNlciBhcyBJVXNlcikuX2lkLFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogc3RhdHMsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi542y5Y+W57O757Wx57Wx6KiI5aSx5pWXXCIsIHsgZXJyb3IgfSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBcIueNsuWPlue1seioiOaVuOaTmuWkseaVl++8jOiri+eojeW+jOWGjeipplwiLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuKTtcblxuLy8g5riF55CG6YGO5pyf6amX6K2J5Luk54mM77yI6ZyA6KaB57O757Wx6YWN572u5qyK6ZmQ77yJXG5yb3V0ZXIucG9zdChcbiAgXCIvY2xlYW51cC9leHBpcmVkLXRva2Vuc1wiLFxuICByZXF1aXJlUGVybWlzc2lvbihQZXJtaXNzaW9uLlNZU1RFTV9DT05GSUcpLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIOS9v+eUqCBVc2VyU2VydmljZSDmuIXnkIbpgY7mnJ/pqZforYnku6TniYxcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVzZXJTZXJ2aWNlLmNsZWFudXBFeHBpcmVkVG9rZW5zKCk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKFwi5riF55CG6YGO5pyf5Luk54mM5oiQ5YqfXCIsIHtcbiAgICAgICAgYWRtaW5JZDogKHJlcS51c2VyIGFzIElVc2VyKS5faWQsXG4gICAgICAgIGNsZWFuZWRDb3VudDogcmVzdWx0LmRlbGV0ZWRDb3VudCxcbiAgICAgIH0pO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6IGDlt7LmuIXnkIYgJHtyZXN1bHQuZGVsZXRlZENvdW50fSDlgIvpgY7mnJ/pqZforYnku6TniYxgLFxuICAgICAgICBkYXRhOiB7IGNsZWFuZWRDb3VudDogcmVzdWx0LmRlbGV0ZWRDb3VudCB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIua4heeQhumBjuacn+S7pOeJjOWkseaVl1wiLCB7IGVycm9yIH0pO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogXCLmuIXnkIblpLHmlZfvvIzoq4vnqI3lvozlho3oqaZcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcbik7XG5cbi8vIOeNsuWPlueVtuWJjeeuoeeQhuWToeasiumZkFxucm91dGVyLmdldChcbiAgXCIvcGVybWlzc2lvbnNcIixcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXIgYXMgSVVzZXI7XG4gICAgICBjb25zdCBwZXJtaXNzaW9ucyA9IGdldFVzZXJQZXJtaXNzaW9ucyh1c2VyKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICAgIHBlcm1pc3Npb25zLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIueNsuWPlueuoeeQhuWToeasiumZkOWkseaVl1wiLCB7IGVycm9yIH0pO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogXCLnjbLlj5bmrIrpmZDlpLHmlZfvvIzoq4vnqI3lvozlho3oqaZcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcbik7XG5cbmV4cG9ydCB7IHJvdXRlciBhcyBhZG1pblJvdXRlcyB9O1xuIl0sInZlcnNpb24iOjN9