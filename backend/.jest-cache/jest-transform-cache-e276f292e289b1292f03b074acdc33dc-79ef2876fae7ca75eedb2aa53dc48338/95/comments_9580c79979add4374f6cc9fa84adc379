9a7d5ee97400b95fecfc79deaede67bd
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const commentService_1 = require("../services/commentService");
const auth_1 = require("../middleware/auth");
const express_validator_1 = require("express-validator");
const router = express_1.default.Router();
/**
 * 創建留言
 */
router.post('/', auth_1.authenticate, [
    (0, express_validator_1.body)('petId').isMongoId().withMessage('無效的寵物ID'),
    (0, express_validator_1.body)('content').trim().isLength({ min: 1, max: 1000 }).withMessage('留言內容長度必須在1-1000字之間'),
    (0, express_validator_1.body)('parentId').optional().isMongoId().withMessage('無效的父留言ID')
], async (req, res) => {
    try {
        const { petId, content, parentId } = req.body;
        const userId = req.user.id;
        const comment = await commentService_1.commentService.createComment({
            petId,
            userId,
            content,
            parentId
        });
        res.status(201).json({
            success: true,
            data: comment,
            message: '留言創建成功'
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '創建留言失敗'
        });
    }
});
/**
 * 獲取寵物留言列表
 */
router.get('/pets/:petId', [
    (0, express_validator_1.param)('petId').isMongoId().withMessage('無效的寵物ID'),
    (0, express_validator_1.query)('page').optional().isInt({ min: 1 }).withMessage('頁碼必須是正整數'),
    (0, express_validator_1.query)('limit').optional().isInt({ min: 1, max: 50 }).withMessage('每頁數量必須在1-50之間'),
    (0, express_validator_1.query)('sortBy').optional().isIn(['createdAt', 'likes']).withMessage('排序字段無效'),
    (0, express_validator_1.query)('sortOrder').optional().isIn(['asc', 'desc']).withMessage('排序順序無效')
], async (req, res) => {
    try {
        const { petId } = req.params;
        const { page = 1, limit = 20, sortBy = 'createdAt', sortOrder = 'desc' } = req.query;
        if (!petId) {
            return res.status(400).json({
                success: false,
                message: '缺少寵物ID參數'
            });
        }
        const result = await commentService_1.commentService.getCommentsByPet(petId, {
            page: Number(page),
            limit: Number(limit),
            sortBy: sortBy,
            sortOrder: sortOrder
        });
        return res.json({
            success: true,
            data: result
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '獲取留言列表失敗'
        });
    }
});
/**
 * 獲取留言樹狀結構
 */
router.get('/pets/:petId/tree', [
    (0, express_validator_1.param)('petId').isMongoId().withMessage('無效的寵物ID')
], async (req, res) => {
    try {
        const { petId } = req.params;
        if (!petId) {
            return res.status(400).json({
                success: false,
                message: '缺少寵物ID參數'
            });
        }
        const commentTree = await commentService_1.commentService.getCommentTree(petId);
        return res.json({
            success: true,
            data: commentTree
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '獲取留言樹失敗'
        });
    }
});
/**
 * 更新留言
 */
router.put('/:commentId', auth_1.authenticate, [
    (0, express_validator_1.param)('commentId').isMongoId().withMessage('無效的留言ID'),
    (0, express_validator_1.body)('content').trim().isLength({ min: 1, max: 1000 }).withMessage('留言內容長度必須在1-1000字之間')
], async (req, res) => {
    try {
        const { commentId } = req.params;
        const { content } = req.body;
        const userId = req.user.id;
        if (!commentId) {
            return res.status(400).json({
                success: false,
                message: '缺少留言ID參數'
            });
        }
        const comment = await commentService_1.commentService.updateComment(commentId, userId, { content });
        if (!comment) {
            return res.status(404).json({
                success: false,
                message: '留言不存在或無權限修改'
            });
        }
        return res.json({
            success: true,
            data: comment,
            message: '留言更新成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '更新留言失敗'
        });
    }
});
/**
 * 刪除留言
 */
router.delete('/:commentId', auth_1.authenticate, [
    (0, express_validator_1.param)('commentId').isMongoId().withMessage('無效的留言ID')
], async (req, res) => {
    try {
        const { commentId } = req.params;
        const userId = req.user.id;
        if (!commentId) {
            return res.status(400).json({
                success: false,
                message: '缺少留言ID參數'
            });
        }
        const success = await commentService_1.commentService.deleteComment(commentId, userId);
        if (!success) {
            return res.status(404).json({
                success: false,
                message: '留言不存在或無權限刪除'
            });
        }
        return res.json({
            success: true,
            message: '留言刪除成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '刪除留言失敗'
        });
    }
});
/**
 * 舉報留言
 */
router.post('/:commentId/report', auth_1.authenticate, [
    (0, express_validator_1.param)('commentId').isMongoId().withMessage('無效的留言ID'),
    (0, express_validator_1.body)('reason').trim().isLength({ min: 1, max: 200 }).withMessage('舉報原因長度必須在1-200字之間')
], async (req, res) => {
    try {
        const { commentId } = req.params;
        const userId = req.user.id;
        if (!commentId) {
            return res.status(400).json({
                success: false,
                message: '缺少留言ID參數'
            });
        }
        await commentService_1.commentService.reportComment(commentId, userId);
        return res.json({
            success: true,
            message: '檢舉成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '檢舉失敗'
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcY29tbWVudHMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxzREFBOEI7QUFFOUIsK0RBQTREO0FBQzVELDZDQUFrRDtBQUNsRCx5REFBdUQ7QUFFdkQsTUFBTSxNQUFNLEdBQUcsaUJBQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVoQzs7R0FFRztBQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUNiLG1CQUFZLEVBQ1o7SUFDRSxJQUFBLHdCQUFJLEVBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQztJQUNoRCxJQUFBLHdCQUFJLEVBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUM7SUFDeEYsSUFBQSx3QkFBSSxFQUFDLFVBQVUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUM7Q0FDaEUsRUFDRCxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDOUMsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUssQ0FBQyxFQUFFLENBQUM7UUFFNUIsTUFBTSxPQUFPLEdBQUcsTUFBTSwrQkFBYyxDQUFDLGFBQWEsQ0FBQztZQUNqRCxLQUFLO1lBQ0wsTUFBTTtZQUNOLE9BQU87WUFDUCxRQUFRO1NBQ1QsQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FB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QUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLElBQUksTUFBTTtTQUNqQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUNGLENBQUM7QUFFRixrQkFBZSxNQUFNLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcY29tbWVudHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgY29tbWVudFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jb21tZW50U2VydmljZSc7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tICcuLi9taWRkbGV3YXJlL2F1dGgnO1xuaW1wb3J0IHsgYm9keSwgcGFyYW0sIHF1ZXJ5IH0gZnJvbSAnZXhwcmVzcy12YWxpZGF0b3InO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4vKipcbiAqIOWJteW7uueVmeiogFxuICovXG5yb3V0ZXIucG9zdCgnLycsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIGJvZHkoJ3BldElkJykuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOWvteeJqUlEJyksXG4gICAgYm9keSgnY29udGVudCcpLnRyaW0oKS5pc0xlbmd0aCh7IG1pbjogMSwgbWF4OiAxMDAwIH0pLndpdGhNZXNzYWdlKCfnlZnoqIDlhaflrrnplbfluqblv4XpoIjlnKgxLTEwMDDlrZfkuYvplpMnKSxcbiAgICBib2R5KCdwYXJlbnRJZCcpLm9wdGlvbmFsKCkuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOeItueVmeiogElEJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHBldElkLCBjb250ZW50LCBwYXJlbnRJZCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICAgIGNvbnN0IGNvbW1lbnQgPSBhd2FpdCBjb21tZW50U2VydmljZS5jcmVhdGVDb21tZW50KHtcbiAgICAgICAgcGV0SWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgY29udGVudCxcbiAgICAgICAgcGFyZW50SWRcbiAgICAgIH0pO1xuXG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IGNvbW1lbnQsXG4gICAgICAgIG1lc3NhZ2U6ICfnlZnoqIDlibXlu7rmiJDlip8nXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIHx8ICflibXlu7rnlZnoqIDlpLHmlZcnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8qKlxuICog542y5Y+W5a+154mp55WZ6KiA5YiX6KGoXG4gKi9cbnJvdXRlci5nZXQoJy9wZXRzLzpwZXRJZCcsXG4gIFtcbiAgICBwYXJhbSgncGV0SWQnKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE5a+154mpSUQnKSxcbiAgICBxdWVyeSgncGFnZScpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEgfSkud2l0aE1lc3NhZ2UoJ+mggeeivOW/hemgiOaYr+ato+aVtOaVuCcpLFxuICAgIHF1ZXJ5KCdsaW1pdCcpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEsIG1heDogNTAgfSkud2l0aE1lc3NhZ2UoJ+avj+mggeaVuOmHj+W/hemgiOWcqDEtNTDkuYvplpMnKSxcbiAgICBxdWVyeSgnc29ydEJ5Jykub3B0aW9uYWwoKS5pc0luKFsnY3JlYXRlZEF0JywgJ2xpa2VzJ10pLndpdGhNZXNzYWdlKCfmjpLluo/lrZfmrrXnhKHmlYgnKSxcbiAgICBxdWVyeSgnc29ydE9yZGVyJykub3B0aW9uYWwoKS5pc0luKFsnYXNjJywgJ2Rlc2MnXSkud2l0aE1lc3NhZ2UoJ+aOkuW6j+mghuW6j+eEoeaViCcpXG4gIF0sXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBwZXRJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgcGFnZSA9IDEsXG4gICAgICAgIGxpbWl0ID0gMjAsXG4gICAgICAgIHNvcnRCeSA9ICdjcmVhdGVkQXQnLFxuICAgICAgICBzb3J0T3JkZXIgPSAnZGVzYydcbiAgICAgIH0gPSByZXEucXVlcnk7XG5cbiAgICAgIGlmICghcGV0SWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR5a+154mpSUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb21tZW50U2VydmljZS5nZXRDb21tZW50c0J5UGV0KHBldElkLCB7XG4gICAgICAgIHBhZ2U6IE51bWJlcihwYWdlKSxcbiAgICAgICAgbGltaXQ6IE51bWJlcihsaW1pdCksXG4gICAgICAgIHNvcnRCeTogc29ydEJ5IGFzICdjcmVhdGVkQXQnIHwgJ3VwZGF0ZWRBdCcsXG4gICAgICAgIHNvcnRPcmRlcjogc29ydE9yZGVyIGFzICdhc2MnIHwgJ2Rlc2MnXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmVzdWx0XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAn542y5Y+W55WZ6KiA5YiX6KGo5aSx5pWXJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG4vKipcbiAqIOeNsuWPlueVmeiogOaoueeLgOe1kOani1xuICovXG5yb3V0ZXIuZ2V0KCcvcGV0cy86cGV0SWQvdHJlZScsXG4gIFtcbiAgICBwYXJhbSgncGV0SWQnKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE5a+154mpSUQnKVxuICBdLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgcGV0SWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBcbiAgICAgIGlmICghcGV0SWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR5a+154mpSUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgXG4gICAgICBjb25zdCBjb21tZW50VHJlZSA9IGF3YWl0IGNvbW1lbnRTZXJ2aWNlLmdldENvbW1lbnRUcmVlKHBldElkKTtcblxuICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogY29tbWVudFRyZWVcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIHx8ICfnjbLlj5bnlZnoqIDmqLnlpLHmlZcnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8qKlxuICog5pu05paw55WZ6KiAXG4gKi9cbnJvdXRlci5wdXQoJy86Y29tbWVudElkJyxcbiAgYXV0aGVudGljYXRlLFxuICBbXG4gICAgcGFyYW0oJ2NvbW1lbnRJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTnlZnoqIBJRCcpLFxuICAgIGJvZHkoJ2NvbnRlbnQnKS50cmltKCkuaXNMZW5ndGgoeyBtaW46IDEsIG1heDogMTAwMCB9KS53aXRoTWVzc2FnZSgn55WZ6KiA5YWn5a656ZW35bqm5b+F6aCI5ZyoMS0xMDAw5a2X5LmL6ZaTJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGNvbW1lbnRJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHsgY29udGVudCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICAgIGlmICghY29tbWVudElkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogJ+e8uuWwkeeVmeiogElE5Y+D5pW4J1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29tbWVudCA9IGF3YWl0IGNvbW1lbnRTZXJ2aWNlLnVwZGF0ZUNvbW1lbnQoY29tbWVudElkLCB1c2VySWQsIHsgY29udGVudCB9KTtcbiAgICAgIGlmICghY29tbWVudCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgbWVzc2FnZTogJ+eVmeiogOS4jeWtmOWcqOaIlueEoeasiumZkOS/ruaUuSdcbiAgICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBjb21tZW50LFxuICAgICAgICBtZXNzYWdlOiAn55WZ6KiA5pu05paw5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+abtOaWsOeVmeiogOWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDliKrpmaTnlZnoqIBcbiAqL1xucm91dGVyLmRlbGV0ZSgnLzpjb21tZW50SWQnLFxuICBhdXRoZW50aWNhdGUsXG4gIFtcbiAgICBwYXJhbSgnY29tbWVudElkJykuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOeVmeiogElEJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGNvbW1lbnRJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgICAgaWYgKCFjb21tZW50SWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR55WZ6KiASUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgY29tbWVudFNlcnZpY2UuZGVsZXRlQ29tbWVudChjb21tZW50SWQsIHVzZXJJZCk7XG4gICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgIG1lc3NhZ2U6ICfnlZnoqIDkuI3lrZjlnKjmiJbnhKHmrIrpmZDliKrpmaQnXG4gICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgbWVzc2FnZTogJ+eVmeiogOWIqumZpOaIkOWKnydcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIHx8ICfliKrpmaTnlZnoqIDlpLHmlZcnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8qKlxuICog6IiJ5aCx55WZ6KiAXG4gKi9cbnJvdXRlci5wb3N0KCcvOmNvbW1lbnRJZC9yZXBvcnQnLFxuICBhdXRoZW50aWNhdGUsXG4gIFtcbiAgICBwYXJhbSgnY29tbWVudElkJykuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOeVmeiogElEJyksXG4gICAgYm9keSgncmVhc29uJykudHJpbSgpLmlzTGVuZ3RoKHsgbWluOiAxLCBtYXg6IDIwMCB9KS53aXRoTWVzc2FnZSgn6IiJ5aCx5Y6f5Zug6ZW35bqm5b+F6aCI5ZyoMS0yMDDlrZfkuYvplpMnKVxuICBdLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgY29tbWVudElkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgICBpZiAoIWNvbW1lbnRJZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6ICfnvLrlsJHnlZnoqIBJROWPg+aVuCdcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IGNvbW1lbnRTZXJ2aWNlLnJlcG9ydENvbW1lbnQoY29tbWVudElkLCB1c2VySWQpO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAn5qqi6IiJ5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+aqouiIieWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyOyJdLCJ2ZXJzaW9uIjozfQ==