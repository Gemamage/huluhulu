{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\middleware\\auth.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\middleware\\auth.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport jwt from 'jsonwebtoken';\nimport { User, IUser } from '../models/User';\nimport { config } from '../config/environment';\nimport { AuthenticationError, ValidationError } from '../utils/errors';\nimport { logger } from '../utils/logger';\n\n// 擴展 Request 介面以包含用戶資訊\ndeclare global {\n  namespace Express {\n    interface User extends IUser {}\n  }\n}\n\n// JWT 令牌載荷介面\ninterface JwtPayload {\n  id: string;\n  email: string;\n  role: string;\n  iat: number;\n  exp: number;\n}\n\n/**\n * 認證中介軟體 - 驗證 JWT 令牌\n */\nexport const authenticate = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  try {\n    // 從請求標頭中獲取令牌\n    const authHeader = req.header('Authorization');\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      throw new AuthenticationError('請提供有效的認證令牌');\n    }\n    \n    const token = authHeader.substring(7); // 移除 'Bearer ' 前綴\n    \n    if (!token) {\n      throw new AuthenticationError('認證令牌不能為空');\n    }\n    \n    // 驗證令牌\n    const decoded = jwt.verify(token, config.jwt.secret) as JwtPayload;\n    \n    // 查找用戶\n    const user = await User.findById(decoded.id).select('+password');\n    \n    if (!user) {\n      throw new AuthenticationError('用戶不存在');\n    }\n    \n    if (!user.isActive) {\n      throw new AuthenticationError('用戶帳號已被停用');\n    }\n    \n    // 將用戶資訊附加到請求物件\n    req.user = user as IUser;\n    \n    logger.debug('用戶認證成功', { userId: user._id, email: user.email });\n    \n    next();\n  } catch (error) {\n    if (error instanceof jwt.JsonWebTokenError) {\n      logger.warn('無效的 JWT 令牌', { error: error.message });\n      next(new AuthenticationError('無效的認證令牌'));\n    } else if (error instanceof jwt.TokenExpiredError) {\n      logger.warn('JWT 令牌已過期', { error: error.message });\n      next(new AuthenticationError('認證令牌已過期'));\n    } else {\n      logger.error('認證中介軟體錯誤', { error });\n      next(error);\n    }\n  }\n};\n\n/**\n * 可選認證中介軟體 - 如果有令牌則驗證，沒有則繼續\n */\nexport const optionalAuthenticate = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  try {\n    const authHeader = req.header('Authorization');\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return next(); // 沒有令牌，繼續執行\n    }\n    \n    const token = authHeader.substring(7);\n    \n    if (!token) {\n      return next(); // 空令牌，繼續執行\n    }\n    \n    // 驗證令牌\n    const decoded = jwt.verify(token, config.jwt.secret) as JwtPayload;\n    \n    // 查找用戶\n    const user = await User.findById(decoded.id);\n    \n    if (user && user.isActive) {\n      req.user = user as IUser;\n      logger.debug('可選認證成功', { userId: user._id, email: user.email });\n    }\n    \n    next();\n  } catch (error) {\n    // 可選認證失敗時不拋出錯誤，只記錄日誌\n    logger.debug('可選認證失敗', { error: error instanceof Error ? error.message : error });\n    next();\n  }\n};\n\n/**\n * 角色授權中介軟體\n */\nexport const authorize = (...roles: string[]) => {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    if (!req.user) {\n      next(new AuthenticationError('請先登入'));\n      return;\n    }\n    \n    if (!roles.includes((req.user as IUser).role)) {\n      logger.warn('用戶權限不足', {\n        userId: (req.user as IUser)._id,\n        userRole: (req.user as IUser).role,\n        requiredRoles: roles,\n      });\n      next(new AuthenticationError('權限不足'));\n      return;\n    }\n    \n    logger.debug('用戶授權成功', {\n      userId: (req.user as IUser)._id,\n      userRole: (req.user as IUser).role,\n      requiredRoles: roles,\n    });\n    \n    next();\n  };\n};\n\n/**\n * 驗證用戶是否為資源擁有者或管理員\n */\nexport const authorizeOwnerOrAdmin = (getUserId: (req: Request) => string) => {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    if (!req.user) {\n      next(new AuthenticationError('請先登入'));\n      return;\n    }\n    \n    const resourceUserId = getUserId(req);\n    const currentUserId = (req.user as IUser)._id.toString();\n    \n    // 檢查是否為資源擁有者或管理員\n    if (currentUserId !== resourceUserId && (req.user as IUser).role !== 'admin') {\n      logger.warn('用戶嘗試存取非自己的資源', {\n        currentUserId,\n        resourceUserId,\n        userRole: (req.user as IUser).role,\n      });\n      next(new AuthenticationError('只能存取自己的資源'));\n      return;\n    }\n    \n    logger.debug('資源存取授權成功', {\n      currentUserId,\n      resourceUserId,\n      userRole: (req.user as IUser).role,\n    });\n    \n    next();\n  };\n};\n\n/**\n * 驗證電子郵件是否已驗證\n */\nexport const requireEmailVerification = (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void => {\n  if (!req.user) {\n    next(new AuthenticationError('請先登入'));\n    return;\n  }\n  \n  if (!(req.user as IUser).isEmailVerified) {\n    logger.warn('用戶嘗試存取需要電子郵件驗證的資源', {\n      userId: (req.user as IUser)._id,\n      email: (req.user as IUser).email,\n    });\n    next(new ValidationError('請先驗證您的電子郵件地址'));\n    return;\n  }\n  \n  next();\n};"],"version":3}