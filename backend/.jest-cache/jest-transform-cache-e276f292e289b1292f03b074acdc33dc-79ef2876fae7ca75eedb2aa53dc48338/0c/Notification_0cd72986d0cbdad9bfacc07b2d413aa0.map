{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\models\\Notification.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\models\\Notification.ts"],"sourcesContent":["import mongoose, { Document, Schema } from \"mongoose\";\n\n/**\n * 通知類型枚舉\n */\nexport enum NotificationType {\n  PET_FOUND = \"pet_found\", // 寵物被找到\n  PET_MISSING = \"pet_missing\", // 新的走失寵物\n  MATCH_FOUND = \"match_found\", // 找到可能的匹配\n  MESSAGE_RECEIVED = \"message_received\", // 收到訊息\n  MESSAGE = \"message\", // 訊息通知\n  COMMENT = \"comment\", // 評論通知\n  REPLY = \"reply\", // 回覆通知\n  REVIEW = \"review\", // 評價通知\n  REPORT = \"report\", // 舉報通知\n  REPORT_RESOLVED = \"report_resolved\", // 舉報處理完成\n  SYSTEM_UPDATE = \"system_update\", // 系統更新\n  ACCOUNT_SECURITY = \"account_security\", // 帳號安全\n}\n\n/**\n * 通知優先級\n */\nexport enum NotificationPriority {\n  LOW = \"low\",\n  NORMAL = \"normal\",\n  HIGH = \"high\",\n  URGENT = \"urgent\",\n}\n\n/**\n * 通知狀態\n */\nexport enum NotificationStatus {\n  PENDING = \"pending\", // 待發送\n  SCHEDULED = \"scheduled\", // 已排程\n  SENT = \"sent\", // 已發送\n  DELIVERED = \"delivered\", // 已送達\n  READ = \"read\", // 已讀\n  FAILED = \"failed\", // 發送失敗\n}\n\n/**\n * 通知介面\n */\nexport interface INotification extends Document {\n  userId: mongoose.Types.ObjectId;\n  type: NotificationType;\n  title: string;\n  message: string;\n  priority: NotificationPriority;\n  status: NotificationStatus;\n  channels: {\n    push: {\n      enabled: boolean;\n      sent: boolean;\n      sentAt?: Date;\n    };\n    email: {\n      enabled: boolean;\n      sent: boolean;\n      sentAt?: Date;\n    };\n    inApp: {\n      enabled: boolean;\n      sent: boolean;\n      sentAt?: Date;\n    };\n  };\n  data?: { [key: string]: any };\n  actionUrl?: string;\n  imageUrl?: string;\n  metadata?: {\n    petId?: mongoose.Types.ObjectId;\n    matchId?: mongoose.Types.ObjectId;\n    [key: string]: any;\n  };\n  scheduledAt?: Date; // 排程發送時間\n  sentAt?: Date; // 實際發送時間\n  readAt?: Date; // 讀取時間\n  expiresAt?: Date; // 過期時間\n  createdAt: Date;\n  updatedAt: Date;\n}\n\n/**\n * 通知 Schema\n */\nconst notificationSchema = new Schema<INotification>(\n  {\n    userId: {\n      type: Schema.Types.ObjectId,\n      ref: \"User\",\n      required: true,\n      index: true,\n    },\n    type: {\n      type: String,\n      enum: Object.values(NotificationType),\n      required: true,\n      index: true,\n    },\n    title: {\n      type: String,\n      required: true,\n      maxlength: 100,\n    },\n    message: {\n      type: String,\n      required: true,\n      maxlength: 500,\n    },\n    priority: {\n      type: String,\n      enum: Object.values(NotificationPriority),\n      default: NotificationPriority.NORMAL,\n      index: true,\n    },\n    status: {\n      type: String,\n      enum: Object.values(NotificationStatus),\n      default: NotificationStatus.PENDING,\n      index: true,\n    },\n    channels: {\n      push: {\n        enabled: {\n          type: Boolean,\n          default: true,\n        },\n        sent: {\n          type: Boolean,\n          default: false,\n        },\n        sentAt: {\n          type: Date,\n        },\n      },\n      email: {\n        enabled: {\n          type: Boolean,\n          default: false,\n        },\n        sent: {\n          type: Boolean,\n          default: false,\n        },\n        sentAt: {\n          type: Date,\n        },\n      },\n      inApp: {\n        enabled: {\n          type: Boolean,\n          default: true,\n        },\n        sent: {\n          type: Boolean,\n          default: false,\n        },\n        sentAt: {\n          type: Date,\n        },\n      },\n    },\n    data: {\n      type: Schema.Types.Mixed,\n      default: {},\n    },\n    actionUrl: {\n      type: String,\n    },\n    imageUrl: {\n      type: String,\n    },\n    metadata: {\n      type: Schema.Types.Mixed,\n      default: {},\n    },\n    scheduledAt: {\n      type: Date,\n      index: true,\n    },\n    sentAt: {\n      type: Date,\n      index: true,\n    },\n    readAt: {\n      type: Date,\n      index: true,\n    },\n    expiresAt: {\n      type: Date,\n    },\n  },\n  {\n    timestamps: true,\n    collection: \"notifications\",\n  },\n);\n\n// 複合索引\nnotificationSchema.index({ userId: 1, status: 1, createdAt: -1 });\nnotificationSchema.index({ userId: 1, type: 1, createdAt: -1 });\nnotificationSchema.index({ status: 1, scheduledAt: 1 });\nnotificationSchema.index({ expiresAt: 1 }, { expireAfterSeconds: 0 });\n\n// 虛擬欄位\nnotificationSchema.virtual(\"isRead\").get(function () {\n  return this.status === NotificationStatus.READ;\n});\n\nnotificationSchema.virtual(\"isExpired\").get(function () {\n  return this.expiresAt && this.expiresAt < new Date();\n});\n\n// 實例方法\nnotificationSchema.methods.markAsRead = function () {\n  this.status = NotificationStatus.READ;\n  this.readAt = new Date();\n  return this.save();\n};\n\nnotificationSchema.methods.markAsSent = function () {\n  this.status = NotificationStatus.SENT;\n  this.sentAt = new Date();\n  return this.save();\n};\n\nnotificationSchema.methods.markAsDelivered = function () {\n  this.status = NotificationStatus.DELIVERED;\n  return this.save();\n};\n\nnotificationSchema.methods.markAsFailed = function () {\n  this.status = NotificationStatus.FAILED;\n  return this.save();\n};\n\n// 靜態方法\nnotificationSchema.statics.findUnreadByUser = function (\n  userId: mongoose.Types.ObjectId,\n) {\n  return this.find({\n    userId,\n    status: { $ne: NotificationStatus.READ },\n    $or: [\n      { expiresAt: { $exists: false } },\n      { expiresAt: { $gt: new Date() } },\n    ],\n  }).sort({ createdAt: -1 });\n};\n\nnotificationSchema.statics.findByUserAndType = function (\n  userId: mongoose.Types.ObjectId,\n  type: NotificationType,\n) {\n  return this.find({ userId, type }).sort({ createdAt: -1 });\n};\n\nnotificationSchema.statics.findPendingNotifications = function () {\n  return this.find({\n    status: NotificationStatus.PENDING,\n    $and: [\n      {\n        $or: [\n          { scheduledAt: { $exists: false } },\n          { scheduledAt: { $lte: new Date() } },\n        ],\n      },\n      {\n        $or: [\n          { expiresAt: { $exists: false } },\n          { expiresAt: { $gt: new Date() } },\n        ],\n      },\n    ],\n  }).sort({ priority: -1, createdAt: 1 });\n};\n\nexport const Notification = mongoose.model<INotification>(\n  \"Notification\",\n  notificationSchema,\n);\nexport default Notification;\n"],"version":3}