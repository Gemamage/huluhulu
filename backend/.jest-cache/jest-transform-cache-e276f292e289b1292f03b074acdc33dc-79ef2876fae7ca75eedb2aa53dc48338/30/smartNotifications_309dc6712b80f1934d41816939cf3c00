a61b25ce2f2bf8ab2c87ac9d4e0e6c6f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.smartNotificationRoutes = void 0;
const express_1 = require("express");
const smartNotificationService_1 = require("../services/smartNotificationService");
const auth_1 = require("../middleware/auth");
const validation_1 = require("../utils/validation");
const express_validator_1 = require("express-validator");
const logger_1 = require("../utils/logger");
const router = (0, express_1.Router)();
exports.smartNotificationRoutes = router;
// 獲取智能通知統計
router.get("/statistics", auth_1.authenticate, [
    (0, express_validator_1.query)("startDate").optional().isISO8601().withMessage("開始日期格式無效"),
    (0, express_validator_1.query)("endDate").optional().isISO8601().withMessage("結束日期格式無效"),
], validation_1.validateRequest, async (req, res) => {
    try {
        const { startDate, endDate } = req.query;
        const userId = req.user._id.toString();
        const statistics = await smartNotificationService_1.SmartNotificationService.getSmartNotificationStatistics({
            userId,
            startDate: startDate ? new Date(startDate) : undefined,
            endDate: endDate ? new Date(endDate) : undefined,
        });
        res.json({
            success: true,
            data: statistics,
        });
    }
    catch (error) {
        logger_1.logger.error("獲取智能通知統計失敗:", error);
        res.status(500).json({
            success: false,
            message: "獲取統計資料失敗",
        });
    }
});
// 獲取智能通知配置
router.get("/config", auth_1.authenticate, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const config = await smartNotificationService_1.SmartNotificationService.getConfig(userId);
        res.json({
            success: true,
            data: config,
        });
    }
    catch (error) {
        logger_1.logger.error("獲取智能通知配置失敗:", error);
        res.status(500).json({
            success: false,
            message: "獲取配置失敗",
        });
    }
});
// 更新智能通知配置
router.put("/config", auth_1.authenticate, [
    (0, express_validator_1.body)("aiMatching")
        .optional()
        .isObject()
        .withMessage("AI 配對設定必須是物件"),
    (0, express_validator_1.body)("aiMatching.enabled")
        .optional()
        .isBoolean()
        .withMessage("AI 配對啟用狀態必須是布林值"),
    (0, express_validator_1.body)("aiMatching.minSimilarity")
        .optional()
        .isFloat({ min: 0, max: 1 })
        .withMessage("最小相似度必須在 0-1 之間"),
    (0, express_validator_1.body)("aiMatching.checkInterval")
        .optional()
        .isInt({ min: 1 })
        .withMessage("檢查間隔必須是正整數"),
    (0, express_validator_1.body)("aiMatching.maxNotificationsPerDay")
        .optional()
        .isInt({ min: 1 })
        .withMessage("每日最大通知數必須是正整數"),
    (0, express_validator_1.body)("geofencing")
        .optional()
        .isObject()
        .withMessage("地理圍欄設定必須是物件"),
    (0, express_validator_1.body)("geofencing.enabled")
        .optional()
        .isBoolean()
        .withMessage("地理圍欄啟用狀態必須是布林值"),
    (0, express_validator_1.body)("geofencing.radius")
        .optional()
        .isFloat({ min: 0.1 })
        .withMessage("半徑必須大於 0.1"),
    (0, express_validator_1.body)("geofencing.checkInterval")
        .optional()
        .isInt({ min: 1 })
        .withMessage("檢查間隔必須是正整數"),
    (0, express_validator_1.body)("reminders").optional().isObject().withMessage("提醒設定必須是物件"),
    (0, express_validator_1.body)("reminders.enabled")
        .optional()
        .isBoolean()
        .withMessage("提醒啟用狀態必須是布林值"),
    (0, express_validator_1.body)("reminders.updateReminder")
        .optional()
        .isInt({ min: 1 })
        .withMessage("更新提醒間隔必須是正整數"),
    (0, express_validator_1.body)("reminders.searchReminder")
        .optional()
        .isInt({ min: 1 })
        .withMessage("搜尋提醒間隔必須是正整數"),
], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const configUpdate = req.body;
        const updatedConfig = await smartNotificationService_1.SmartNotificationService.updateConfig(userId, configUpdate);
        res.json({
            success: true,
            data: updatedConfig,
            message: "配置更新成功",
        });
    }
    catch (error) {
        logger_1.logger.error("更新智能通知配置失敗:", error);
        res.status(500).json({
            success: false,
            message: "更新配置失敗",
        });
    }
});
// 創建地理圍欄
router.post("/geofence", auth_1.authenticate, [
    (0, express_validator_1.body)("petId").isMongoId().withMessage("寵物 ID 格式無效"),
    (0, express_validator_1.body)("latitude")
        .isFloat({ min: -90, max: 90 })
        .withMessage("緯度必須在 -90 到 90 之間"),
    (0, express_validator_1.body)("longitude")
        .isFloat({ min: -180, max: 180 })
        .withMessage("經度必須在 -180 到 180 之間"),
    (0, express_validator_1.body)("radius")
        .isFloat({ min: 0.1, max: 50 })
        .withMessage("半徑必須在 0.1 到 50 公里之間"),
    (0, express_validator_1.body)("name")
        .optional()
        .isString()
        .isLength({ max: 100 })
        .withMessage("名稱長度不能超過 100 字元"),
], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const { petId, latitude, longitude, radius, name } = req.body;
        const geofence = await smartNotificationService_1.SmartNotificationService.createGeofence({
            userId,
            petId,
            latitude,
            longitude,
            radius,
            name,
        });
        return res.status(201).json({
            success: true,
            data: geofence,
            message: "地理圍欄創建成功",
        });
    }
    catch (error) {
        logger_1.logger.error("創建地理圍欄失敗:", error);
        return res.status(500).json({
            success: false,
            message: "創建地理圍欄失敗",
        });
    }
});
// 移除地理圍欄
router.delete("/geofence/:geofenceId", auth_1.authenticate, [(0, express_validator_1.param)("geofenceId").isMongoId().withMessage("地理圍欄 ID 格式無效")], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const { geofenceId } = req.params;
        if (!geofenceId) {
            return res.status(400).json({
                success: false,
                message: "地理圍欄 ID 為必填項目",
            });
        }
        await smartNotificationService_1.SmartNotificationService.removeGeofence(userId, geofenceId);
        return res.json({
            success: true,
            message: "地理圍欄移除成功",
        });
    }
    catch (error) {
        logger_1.logger.error("移除地理圍欄失敗:", error);
        return res.status(500).json({
            success: false,
            message: "移除地理圍欄失敗",
        });
    }
});
// 獲取用戶的地理圍欄列表
router.get("/geofences", auth_1.authenticate, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const geofences = await smartNotificationService_1.SmartNotificationService.getUserGeofences(userId);
        return res.json({
            success: true,
            data: geofences,
        });
    }
    catch (error) {
        logger_1.logger.error("獲取地理圍欄列表失敗:", error);
        return res.status(500).json({
            success: false,
            message: "獲取地理圍欄列表失敗",
        });
    }
});
// 手動觸發 AI 配對檢查
router.post("/trigger-ai-matching", auth_1.authenticate, [(0, express_validator_1.body)("petId").optional().isMongoId().withMessage("寵物 ID 格式無效")], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const { petId } = req.body;
        const result = await smartNotificationService_1.SmartNotificationService.triggerAIMatching(userId, petId);
        return res.json({
            success: true,
            data: result,
            message: "AI 配對檢查已觸發",
        });
    }
    catch (error) {
        logger_1.logger.error("觸發 AI 配對檢查失敗:", error);
        return res.status(500).json({
            success: false,
            message: "觸發 AI 配對檢查失敗",
        });
    }
});
// 測試智能通知（僅開發環境）
router.post("/test", auth_1.authenticate, [
    (0, express_validator_1.body)("type")
        .isIn(["ai_matching", "geofencing", "reminder"])
        .withMessage("通知類型無效"),
    (0, express_validator_1.body)("petId").optional().isMongoId().withMessage("寵物 ID 格式無效"),
], validation_1.validateRequest, async (req, res) => {
    try {
        // 僅在非生產環境允許測試
        if (process.env.NODE_ENV === "production") {
            return res.status(403).json({
                success: false,
                message: "生產環境不允許測試功能",
            });
        }
        const userId = req.user._id.toString();
        const { type, petId } = req.body;
        let result;
        switch (type) {
            case "ai_matching":
                result = await smartNotificationService_1.SmartNotificationService.triggerAIMatching(userId, petId);
                break;
            case "geofencing":
                // 模擬地理圍欄觸發
                result = { message: "地理圍欄測試通知已發送" };
                break;
            case "reminder":
                // 模擬提醒通知
                result = { message: "提醒測試通知已發送" };
                break;
            default:
                return res.status(400).json({
                    success: false,
                    message: "不支援的測試類型",
                });
        }
        return res.json({
            success: true,
            data: result,
            message: `${type} 測試通知已發送`,
        });
    }
    catch (error) {
        logger_1.logger.error("發送測試通知失敗:", error);
        return res.status(500).json({
            success: false,
            message: "發送測試通知失敗",
        });
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcc21hcnROb3RpZmljYXRpb25zLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFpQztBQUVqQyxtRkFBZ0Y7QUFDaEYsNkNBQTBEO0FBQzFELG9EQUFzRDtBQUN0RCx5REFBdUQ7QUFDdkQsNENBQXlDO0FBRXpDLE1BQU0sTUFBTSxHQUFHLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBZ1ZMLHlDQUF1QjtBQTlVMUMsV0FBVztBQUNYLE1BQU0sQ0FBQyxHQUFHLENBQ1IsYUFBYSxFQUNiLG1CQUFJLEVBQ0o7SUFDRSxJQUFBLHlCQUFLLEVBQUMsV0FBVyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQztJQUNqRSxJQUFBLHlCQUFLLEVBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQztDQUNoRSxFQUNELDRCQUFlLEVBQ2YsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUM7UUFDekMsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFeEMsTUFBTSxVQUFVLEdBQ2QsTUFBTSxtREFBd0IsQ0FBQyw4QkFBOEIsQ0FBQztZQUM1RCxNQUFNO1lBQ04sU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ2hFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLE9BQWlCLENBQUMsQ0FB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RixNQUFNO1lBQ1IsS0FBSyxZQUFZO2dCQUNmLFdBQVc7Z0JBQ1gsTUFBTSxHQUFHLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxDQUFDO2dCQUNwQyxNQUFNO1lBQ1IsS0FBSyxVQUFVO2dCQUNiLFNBQVM7Z0JBQ1QsTUFBTSxHQUFHLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxDQUFDO2dCQUNsQyxNQUFNO1lBQ1I7Z0JBQ0UsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsT0FBTyxFQUFFLFVBQVU7aUJBQ3BCLENBQUMsQ0FBQztRQUNQLENBQUM7UUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDZCxPQUFPLEVBQUUsSUFBSTtZQUNiLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLEdBQUcsSUFBSSxVQUFVO1NBQzNCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsZUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsS0FBSztZQUNkLE9BQU8sRUFBRSxVQUFVO1NBQ3BCLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQ0YsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccm91dGVzXFxzbWFydE5vdGlmaWNhdGlvbnMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7IFNtYXJ0Tm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zbWFydE5vdGlmaWNhdGlvblNlcnZpY2VcIjtcbmltcG9ydCB7IGF1dGhlbnRpY2F0ZSBhcyBhdXRoIH0gZnJvbSBcIi4uL21pZGRsZXdhcmUvYXV0aFwiO1xuaW1wb3J0IHsgdmFsaWRhdGVSZXF1ZXN0IH0gZnJvbSBcIi4uL3V0aWxzL3ZhbGlkYXRpb25cIjtcbmltcG9ydCB7IGJvZHksIHF1ZXJ5LCBwYXJhbSB9IGZyb20gXCJleHByZXNzLXZhbGlkYXRvclwiO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIi4uL3V0aWxzL2xvZ2dlclwiO1xuXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxuLy8g542y5Y+W5pm66IO96YCa55+l57Wx6KiIXG5yb3V0ZXIuZ2V0KFxuICBcIi9zdGF0aXN0aWNzXCIsXG4gIGF1dGgsXG4gIFtcbiAgICBxdWVyeShcInN0YXJ0RGF0ZVwiKS5vcHRpb25hbCgpLmlzSVNPODYwMSgpLndpdGhNZXNzYWdlKFwi6ZaL5aeL5pel5pyf5qC85byP54Sh5pWIXCIpLFxuICAgIHF1ZXJ5KFwiZW5kRGF0ZVwiKS5vcHRpb25hbCgpLmlzSVNPODYwMSgpLndpdGhNZXNzYWdlKFwi57WQ5p2f5pel5pyf5qC85byP54Sh5pWIXCIpLFxuICBdLFxuICB2YWxpZGF0ZVJlcXVlc3QsXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBzdGFydERhdGUsIGVuZERhdGUgfSA9IHJlcS5xdWVyeTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5faWQudG9TdHJpbmcoKTtcblxuICAgICAgY29uc3Qgc3RhdGlzdGljcyA9XG4gICAgICAgIGF3YWl0IFNtYXJ0Tm90aWZpY2F0aW9uU2VydmljZS5nZXRTbWFydE5vdGlmaWNhdGlvblN0YXRpc3RpY3Moe1xuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBzdGFydERhdGU6IHN0YXJ0RGF0ZSA/IG5ldyBEYXRlKHN0YXJ0RGF0ZSBhcyBzdHJpbmcpIDogdW5kZWZpbmVkLFxuICAgICAgICAgIGVuZERhdGU6IGVuZERhdGUgPyBuZXcgRGF0ZShlbmREYXRlIGFzIHN0cmluZykgOiB1bmRlZmluZWQsXG4gICAgICAgIH0pO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHN0YXRpc3RpY3MsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi542y5Y+W5pm66IO96YCa55+l57Wx6KiI5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBcIueNsuWPlue1seioiOizh+aWmeWkseaVl1wiLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuKTtcblxuLy8g542y5Y+W5pm66IO96YCa55+l6YWN572uXG5yb3V0ZXIuZ2V0KFwiL2NvbmZpZ1wiLCBhdXRoLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLl9pZC50b1N0cmluZygpO1xuICAgIGNvbnN0IGNvbmZpZyA9IGF3YWl0IFNtYXJ0Tm90aWZpY2F0aW9uU2VydmljZS5nZXRDb25maWcodXNlcklkKTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiBjb25maWcsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKFwi542y5Y+W5pm66IO96YCa55+l6YWN572u5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBtZXNzYWdlOiBcIueNsuWPlumFjee9ruWkseaVl1wiLFxuICAgIH0pO1xuICB9XG59KTtcblxuLy8g5pu05paw5pm66IO96YCa55+l6YWN572uXG5yb3V0ZXIucHV0KFxuICBcIi9jb25maWdcIixcbiAgYXV0aCxcbiAgW1xuICAgIGJvZHkoXCJhaU1hdGNoaW5nXCIpXG4gICAgICAub3B0aW9uYWwoKVxuICAgICAgLmlzT2JqZWN0KClcbiAgICAgIC53aXRoTWVzc2FnZShcIkFJIOmFjeWwjeioreWumuW/hemgiOaYr+eJqeS7tlwiKSxcbiAgICBib2R5KFwiYWlNYXRjaGluZy5lbmFibGVkXCIpXG4gICAgICAub3B0aW9uYWwoKVxuICAgICAgLmlzQm9vbGVhbigpXG4gICAgICAud2l0aE1lc3NhZ2UoXCJBSSDphY3lsI3llZ/nlKjni4DmhYvlv4XpoIjmmK/luIPmnpflgLxcIiksXG4gICAgYm9keShcImFpTWF0Y2hpbmcubWluU2ltaWxhcml0eVwiKVxuICAgICAgLm9wdGlvbmFsKClcbiAgICAgIC5pc0Zsb2F0KHsgbWluOiAwLCBtYXg6IDEgfSlcbiAgICAgIC53aXRoTWVzc2FnZShcIuacgOWwj+ebuOS8vOW6puW/hemgiOWcqCAwLTEg5LmL6ZaTXCIpLFxuICAgIGJvZHkoXCJhaU1hdGNoaW5nLmNoZWNrSW50ZXJ2YWxcIilcbiAgICAgIC5vcHRpb25hbCgpXG4gICAgICAuaXNJbnQoeyBtaW46IDEgfSlcbiAgICAgIC53aXRoTWVzc2FnZShcIuaqouafpemWk+malOW/hemgiOaYr+ato+aVtOaVuFwiKSxcbiAgICBib2R5KFwiYWlNYXRjaGluZy5tYXhOb3RpZmljYXRpb25zUGVyRGF5XCIpXG4gICAgICAub3B0aW9uYWwoKVxuICAgICAgLmlzSW50KHsgbWluOiAxIH0pXG4gICAgICAud2l0aE1lc3NhZ2UoXCLmr4/ml6XmnIDlpKfpgJrnn6Xmlbjlv4XpoIjmmK/mraPmlbTmlbhcIiksXG5cbiAgICBib2R5KFwiZ2VvZmVuY2luZ1wiKVxuICAgICAgLm9wdGlvbmFsKClcbiAgICAgIC5pc09iamVjdCgpXG4gICAgICAud2l0aE1lc3NhZ2UoXCLlnLDnkIblnI3mrIToqK3lrprlv4XpoIjmmK/nianku7ZcIiksXG4gICAgYm9keShcImdlb2ZlbmNpbmcuZW5hYmxlZFwiKVxuICAgICAgLm9wdGlvbmFsKClcbiAgICAgIC5pc0Jvb2xlYW4oKVxuICAgICAgLndpdGhNZXNzYWdlKFwi5Zyw55CG5ZyN5qyE5ZWf55So54uA5oWL5b+F6aCI5piv5biD5p6X5YC8XCIpLFxuICAgIGJvZHkoXCJnZW9mZW5jaW5nLnJhZGl1c1wiKVxuICAgICAgLm9wdGlvbmFsKClcbiAgICAgIC5pc0Zsb2F0KHsgbWluOiAwLjEgfSlcbiAgICAgIC53aXRoTWVzc2FnZShcIuWNiuW+keW/hemgiOWkp+aWvCAwLjFcIiksXG4gICAgYm9keShcImdlb2ZlbmNpbmcuY2hlY2tJbnRlcnZhbFwiKVxuICAgICAgLm9wdGlvbmFsKClcbiAgICAgIC5pc0ludCh7IG1pbjogMSB9KVxuICAgICAgLndpdGhNZXNzYWdlKFwi5qqi5p+l6ZaT6ZqU5b+F6aCI5piv5q2j5pW05pW4XCIpLFxuXG4gICAgYm9keShcInJlbWluZGVyc1wiKS5vcHRpb25hbCgpLmlzT2JqZWN0KCkud2l0aE1lc3NhZ2UoXCLmj5DphpLoqK3lrprlv4XpoIjmmK/nianku7ZcIiksXG4gICAgYm9keShcInJlbWluZGVycy5lbmFibGVkXCIpXG4gICAgICAub3B0aW9uYWwoKVxuICAgICAgLmlzQm9vbGVhbigpXG4gICAgICAud2l0aE1lc3NhZ2UoXCLmj5DphpLllZ/nlKjni4DmhYvlv4XpoIjmmK/luIPmnpflgLxcIiksXG4gICAgYm9keShcInJlbWluZGVycy51cGRhdGVSZW1pbmRlclwiKVxuICAgICAgLm9wdGlvbmFsKClcbiAgICAgIC5pc0ludCh7IG1pbjogMSB9KVxuICAgICAgLndpdGhNZXNzYWdlKFwi5pu05paw5o+Q6YaS6ZaT6ZqU5b+F6aCI5piv5q2j5pW05pW4XCIpLFxuICAgIGJvZHkoXCJyZW1pbmRlcnMuc2VhcmNoUmVtaW5kZXJcIilcbiAgICAgIC5vcHRpb25hbCgpXG4gICAgICAuaXNJbnQoeyBtaW46IDEgfSlcbiAgICAgIC53aXRoTWVzc2FnZShcIuaQnOWwi+aPkOmGkumWk+malOW/hemgiOaYr+ato+aVtOaVuFwiKSxcbiAgXSxcbiAgdmFsaWRhdGVSZXF1ZXN0LFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5faWQudG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IGNvbmZpZ1VwZGF0ZSA9IHJlcS5ib2R5O1xuXG4gICAgICBjb25zdCB1cGRhdGVkQ29uZmlnID0gYXdhaXQgU21hcnROb3RpZmljYXRpb25TZXJ2aWNlLnVwZGF0ZUNvbmZpZyhcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBjb25maWdVcGRhdGUsXG4gICAgICApO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHVwZGF0ZWRDb25maWcsXG4gICAgICAgIG1lc3NhZ2U6IFwi6YWN572u5pu05paw5oiQ5YqfXCIsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi5pu05paw5pm66IO96YCa55+l6YWN572u5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBcIuabtOaWsOmFjee9ruWkseaVl1wiLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuKTtcblxuLy8g5Ym15bu65Zyw55CG5ZyN5qyEXG5yb3V0ZXIucG9zdChcbiAgXCIvZ2VvZmVuY2VcIixcbiAgYXV0aCxcbiAgW1xuICAgIGJvZHkoXCJwZXRJZFwiKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZShcIuWvteeJqSBJRCDmoLzlvI/nhKHmlYhcIiksXG4gICAgYm9keShcImxhdGl0dWRlXCIpXG4gICAgICAuaXNGbG9hdCh7IG1pbjogLTkwLCBtYXg6IDkwIH0pXG4gICAgICAud2l0aE1lc3NhZ2UoXCLnt6/luqblv4XpoIjlnKggLTkwIOWIsCA5MCDkuYvplpNcIiksXG4gICAgYm9keShcImxvbmdpdHVkZVwiKVxuICAgICAgLmlzRmxvYXQoeyBtaW46IC0xODAsIG1heDogMTgwIH0pXG4gICAgICAud2l0aE1lc3NhZ2UoXCLntpPluqblv4XpoIjlnKggLTE4MCDliLAgMTgwIOS5i+mWk1wiKSxcbiAgICBib2R5KFwicmFkaXVzXCIpXG4gICAgICAuaXNGbG9hdCh7IG1pbjogMC4xLCBtYXg6IDUwIH0pXG4gICAgICAud2l0aE1lc3NhZ2UoXCLljYrlvpHlv4XpoIjlnKggMC4xIOWIsCA1MCDlhazph4zkuYvplpNcIiksXG4gICAgYm9keShcIm5hbWVcIilcbiAgICAgIC5vcHRpb25hbCgpXG4gICAgICAuaXNTdHJpbmcoKVxuICAgICAgLmlzTGVuZ3RoKHsgbWF4OiAxMDAgfSlcbiAgICAgIC53aXRoTWVzc2FnZShcIuWQjeeosemVt+W6puS4jeiDvei2hemBjiAxMDAg5a2X5YWDXCIpLFxuICBdLFxuICB2YWxpZGF0ZVJlcXVlc3QsXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLl9pZC50b1N0cmluZygpO1xuICAgICAgY29uc3QgeyBwZXRJZCwgbGF0aXR1ZGUsIGxvbmdpdHVkZSwgcmFkaXVzLCBuYW1lIH0gPSByZXEuYm9keTtcblxuICAgICAgY29uc3QgZ2VvZmVuY2UgPSBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UuY3JlYXRlR2VvZmVuY2Uoe1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBldElkLFxuICAgICAgICBsYXRpdHVkZSxcbiAgICAgICAgbG9uZ2l0dWRlLFxuICAgICAgICByYWRpdXMsXG4gICAgICAgIG5hbWUsXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogZ2VvZmVuY2UsXG4gICAgICAgIG1lc3NhZ2U6IFwi5Zyw55CG5ZyN5qyE5Ym15bu65oiQ5YqfXCIsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi5Ym15bu65Zyw55CG5ZyN5qyE5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogXCLlibXlu7rlnLDnkIblnI3mrITlpLHmlZdcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcbik7XG5cbi8vIOenu+mZpOWcsOeQhuWcjeashFxucm91dGVyLmRlbGV0ZShcbiAgXCIvZ2VvZmVuY2UvOmdlb2ZlbmNlSWRcIixcbiAgYXV0aCxcbiAgW3BhcmFtKFwiZ2VvZmVuY2VJZFwiKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZShcIuWcsOeQhuWcjeashCBJRCDmoLzlvI/nhKHmlYhcIildLFxuICB2YWxpZGF0ZVJlcXVlc3QsXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLl9pZC50b1N0cmluZygpO1xuICAgICAgY29uc3QgeyBnZW9mZW5jZUlkIH0gPSByZXEucGFyYW1zO1xuXG4gICAgICBpZiAoIWdlb2ZlbmNlSWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiBcIuWcsOeQhuWcjeashCBJRCDngrrlv4XloavpoIXnm65cIixcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IFNtYXJ0Tm90aWZpY2F0aW9uU2VydmljZS5yZW1vdmVHZW9mZW5jZSh1c2VySWQsIGdlb2ZlbmNlSWQpO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiBcIuWcsOeQhuWcjeashOenu+mZpOaIkOWKn1wiLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIuenu+mZpOWcsOeQhuWcjeashOWkseaVlzpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IFwi56e76Zmk5Zyw55CG5ZyN5qyE5aSx5pWXXCIsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG4pO1xuXG4vLyDnjbLlj5bnlKjmiLbnmoTlnLDnkIblnI3mrITliJfooahcbnJvdXRlci5nZXQoXCIvZ2VvZmVuY2VzXCIsIGF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuX2lkLnRvU3RyaW5nKCk7XG4gICAgY29uc3QgZ2VvZmVuY2VzID0gYXdhaXQgU21hcnROb3RpZmljYXRpb25TZXJ2aWNlLmdldFVzZXJHZW9mZW5jZXModXNlcklkKTtcblxuICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogZ2VvZmVuY2VzLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcihcIueNsuWPluWcsOeQhuWcjeashOWIl+ihqOWkseaVlzpcIiwgZXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIG1lc3NhZ2U6IFwi542y5Y+W5Zyw55CG5ZyN5qyE5YiX6KGo5aSx5pWXXCIsXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vLyDmiYvli5Xop7jnmbwgQUkg6YWN5bCN5qqi5p+lXG5yb3V0ZXIucG9zdChcbiAgXCIvdHJpZ2dlci1haS1tYXRjaGluZ1wiLFxuICBhdXRoLFxuICBbYm9keShcInBldElkXCIpLm9wdGlvbmFsKCkuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoXCLlr7XniakgSUQg5qC85byP54Sh5pWIXCIpXSxcbiAgdmFsaWRhdGVSZXF1ZXN0LFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5faWQudG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IHsgcGV0SWQgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UudHJpZ2dlckFJTWF0Y2hpbmcoXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgcGV0SWQsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiByZXN1bHQsXG4gICAgICAgIG1lc3NhZ2U6IFwiQUkg6YWN5bCN5qqi5p+l5bey6Ke455m8XCIsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi6Ke455m8IEFJIOmFjeWwjeaqouafpeWkseaVlzpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IFwi6Ke455m8IEFJIOmFjeWwjeaqouafpeWkseaVl1wiLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuKTtcblxuLy8g5ris6Kmm5pm66IO96YCa55+l77yI5YOF6ZaL55m855Kw5aKD77yJXG5yb3V0ZXIucG9zdChcbiAgXCIvdGVzdFwiLFxuICBhdXRoLFxuICBbXG4gICAgYm9keShcInR5cGVcIilcbiAgICAgIC5pc0luKFtcImFpX21hdGNoaW5nXCIsIFwiZ2VvZmVuY2luZ1wiLCBcInJlbWluZGVyXCJdKVxuICAgICAgLndpdGhNZXNzYWdlKFwi6YCa55+l6aGe5Z6L54Sh5pWIXCIpLFxuICAgIGJvZHkoXCJwZXRJZFwiKS5vcHRpb25hbCgpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKFwi5a+154mpIElEIOagvOW8j+eEoeaViFwiKSxcbiAgXSxcbiAgdmFsaWRhdGVSZXF1ZXN0LFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIOWDheWcqOmdnueUn+eUoueSsOWig+WFgeiosea4rOipplxuICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSBcInByb2R1Y3Rpb25cIikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6IFwi55Sf55Si55Kw5aKD5LiN5YWB6Kix5ris6Kmm5Yqf6IO9XCIsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuX2lkLnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCB7IHR5cGUsIHBldElkIH0gPSByZXEuYm9keTtcblxuICAgICAgbGV0IHJlc3VsdDtcbiAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICBjYXNlIFwiYWlfbWF0Y2hpbmdcIjpcbiAgICAgICAgICByZXN1bHQgPSBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UudHJpZ2dlckFJTWF0Y2hpbmcoXG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBwZXRJZCxcbiAgICAgICAgICApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwiZ2VvZmVuY2luZ1wiOlxuICAgICAgICAgIC8vIOaooeaTrOWcsOeQhuWcjeashOinuOeZvFxuICAgICAgICAgIHJlc3VsdCA9IHsgbWVzc2FnZTogXCLlnLDnkIblnI3mrITmuKzoqabpgJrnn6Xlt7LnmbzpgIFcIiB9O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwicmVtaW5kZXJcIjpcbiAgICAgICAgICAvLyDmqKHmk6zmj5DphpLpgJrnn6VcbiAgICAgICAgICByZXN1bHQgPSB7IG1lc3NhZ2U6IFwi5o+Q6YaS5ris6Kmm6YCa55+l5bey55m86YCBXCIgfTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBtZXNzYWdlOiBcIuS4jeaUr+aPtOeahOa4rOippumhnuWei1wiLFxuICAgICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiByZXN1bHQsXG4gICAgICAgIG1lc3NhZ2U6IGAke3R5cGV9IOa4rOippumAmuefpeW3sueZvOmAgWAsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwi55m86YCB5ris6Kmm6YCa55+l5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogXCLnmbzpgIHmuKzoqabpgJrnn6XlpLHmlZdcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcbik7XG5cbmV4cG9ydCB7IHJvdXRlciBhcyBzbWFydE5vdGlmaWNhdGlvblJvdXRlcyB9O1xuIl0sInZlcnNpb24iOjN9