645ddf7e2ba48c65656988b6cc9ba95b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const User_1 = require("../../src/models/User");
const testData_1 = require("../utils/testData");
describe('User Model', () => {
    afterEach(async () => {
        await User_1.User.deleteMany({});
    });
    describe('User Creation', () => {
        it('should create a valid user', async () => {
            const user = new User_1.User(testData_1.validUserData);
            const savedUser = await user.save();
            expect(savedUser._id).toBeDefined();
            expect(savedUser.email).toBe(testData_1.validUserData.email);
            expect(savedUser.name).toBe(testData_1.validUserData.name);
            expect(savedUser.phone).toBe(testData_1.validUserData.phone);
            expect(savedUser.isActive).toBe(true);
            expect(savedUser.role).toBe('user');
            expect(savedUser.isEmailVerified).toBe(false);
        });
        it('should hash password before saving', async () => {
            const user = new User_1.User(testData_1.validUserData);
            const savedUser = await user.save();
            expect(savedUser.password).not.toBe(testData_1.validUserData.password);
            expect(savedUser.password.length).toBeGreaterThan(50);
        });
        it('should not save user without required fields', async () => {
            const user = new User_1.User({});
            await expect(user.save()).rejects.toThrow();
        });
        it('should not save user with invalid email', async () => {
            const user = new User_1.User({
                ...testData_1.validUserData,
                email: 'invalid-email'
            });
            await expect(user.save()).rejects.toThrow();
        });
        it('should not save user with duplicate email', async () => {
            await new User_1.User(testData_1.validUserData).save();
            const duplicateUser = new User_1.User(testData_1.validUserData);
            await expect(duplicateUser.save()).rejects.toThrow();
        });
        it('should validate phone number format', async () => {
            const user = new User_1.User({
                ...testData_1.validUserData,
                phone: 'invalid-phone'
            });
            await expect(user.save()).rejects.toThrow();
        });
    });
    describe('User Methods', () => {
        let user;
        beforeEach(async () => {
            user = await new User_1.User(testData_1.validUserData).save();
        });
        describe('comparePassword', () => {
            it('should return true for correct password', async () => {
                const isMatch = await user.comparePassword('password123');
                expect(isMatch).toBe(true);
            });
            it('should return false for incorrect password', async () => {
                const isMatch = await user.comparePassword('wrongpassword');
                expect(isMatch).toBe(false);
            });
        });
        describe('generateAuthToken', () => {
            it('should generate a valid JWT token', () => {
                const token = user.generateAuthToken();
                expect(token).toBeDefined();
                expect(typeof token).toBe('string');
                expect(token.split('.')).toHaveLength(3); // JWT has 3 parts
            });
        });
        describe('generatePasswordResetToken', () => {
            it('should generate password reset token and expiry', () => {
                user.generatePasswordResetToken();
                expect(user.passwordResetToken).toBeDefined();
                expect(user.passwordResetExpires).toBeDefined();
                expect(user.passwordResetExpires.getTime()).toBeGreaterThan(Date.now());
            });
        });
        describe('generateEmailVerificationToken', () => {
            it('should generate email verification token and expiry', () => {
                user.generateEmailVerificationToken();
                expect(user.emailVerificationToken).toBeDefined();
                expect(user.emailVerificationExpires).toBeDefined();
                expect(user.emailVerificationExpires.getTime()).toBeGreaterThan(Date.now());
            });
        });
    });
    describe('User Privacy Settings', () => {
        it('should have default privacy settings', async () => {
            const user = await new User_1.User(testData_1.validUserData).save();
            expect(user.privacySettings).toBeDefined();
            expect(user.privacySettings.showEmail).toBe(false);
            expect(user.privacySettings.showPhone).toBe(true);
            expect(user.privacySettings.allowDirectContact).toBe(true);
        });
        it('should allow updating privacy settings', async () => {
            const user = await new User_1.User(testData_1.validUserData).save();
            user.privacySettings.showEmail = true;
            user.privacySettings.showPhone = true;
            user.privacySettings.allowMessages = false;
            const updatedUser = await user.save();
            expect(updatedUser.privacySettings.showEmail).toBe(true);
            expect(updatedUser.privacySettings.showPhone).toBe(true);
            expect(updatedUser.privacySettings.allowMessages).toBe(false);
        });
    });
    describe('User Timestamps', () => {
        it('should set createdAt and updatedAt on creation', async () => {
            const user = await new User_1.User(testData_1.validUserData).save();
            expect(user.createdAt).toBeDefined();
            expect(user.updatedAt).toBeDefined();
            expect(user.createdAt).toEqual(user.updatedAt);
        });
        it('should update updatedAt on modification', async () => {
            const user = await new User_1.User(testData_1.validUserData).save();
            const originalUpdatedAt = user.updatedAt;
            // 等待一毫秒確保時間戳不同
            await new Promise(resolve => setTimeout(resolve, 1));
            user.name = 'Updated Name';
            const updatedUser = await user.save();
            expect(updatedUser.updatedAt.getTime()).toBeGreaterThan(originalUpdatedAt.getTime());
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFx0ZXN0XFxtb2RlbHNcXFVzZXIudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGdEQUFvRDtBQUVwRCxnREFBa0Q7QUFFbEQsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7SUFFMUIsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLE1BQU0sV0FBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO1FBQzdCLEVBQUUsQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMxQyxNQUFNLElBQUksR0FBRyxJQUFJLFdBQUksQ0FBQyx3QkFBYSxDQUFDLENBQUM7WUFDckMsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFcEMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNwQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyx3QkFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xELE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsd0JBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsRCxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsU0FB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QUFJLENBQUMsd0JBQWEsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2xELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUV6QyxlQUFlO1lBQ2YsTUFBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVyRCxJQUFJLENBQUMsSUFBSSxHQUFHLGNBQWMsQ0FBQztZQUMzQixNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUV0QyxNQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZGLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHRlc3RcXG1vZGVsc1xcVXNlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzZXIsIElVc2VyIH0gZnJvbSAnLi4vLi4vc3JjL21vZGVscy9Vc2VyJztcbmltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5pbXBvcnQgeyB2YWxpZFVzZXJEYXRhIH0gZnJvbSAnLi4vdXRpbHMvdGVzdERhdGEnO1xuXG5kZXNjcmliZSgnVXNlciBNb2RlbCcsICgpID0+IHtcblxuICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IFVzZXIuZGVsZXRlTWFueSh7fSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdVc2VyIENyZWF0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgdmFsaWQgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBuZXcgVXNlcih2YWxpZFVzZXJEYXRhKTtcbiAgICAgIGNvbnN0IHNhdmVkVXNlciA9IGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgXG4gICAgICBleHBlY3Qoc2F2ZWRVc2VyLl9pZCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChzYXZlZFVzZXIuZW1haWwpLnRvQmUodmFsaWRVc2VyRGF0YS5lbWFpbCk7XG4gICAgICBleHBlY3Qoc2F2ZWRVc2VyLm5hbWUpLnRvQmUodmFsaWRVc2VyRGF0YS5uYW1lKTtcbiAgICAgIGV4cGVjdChzYXZlZFVzZXIucGhvbmUpLnRvQmUodmFsaWRVc2VyRGF0YS5waG9uZSk7XG4gICAgICBleHBlY3Qoc2F2ZWRVc2VyLmlzQWN0aXZlKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHNhdmVkVXNlci5yb2xlKS50b0JlKCd1c2VyJyk7XG4gICAgICBleHBlY3Qoc2F2ZWRVc2VyLmlzRW1haWxWZXJpZmllZCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhc2ggcGFzc3dvcmQgYmVmb3JlIHNhdmluZycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBuZXcgVXNlcih2YWxpZFVzZXJEYXRhKTtcbiAgICAgIGNvbnN0IHNhdmVkVXNlciA9IGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgXG4gICAgICBleHBlY3Qoc2F2ZWRVc2VyLnBhc3N3b3JkKS5ub3QudG9CZSh2YWxpZFVzZXJEYXRhLnBhc3N3b3JkKTtcbiAgICAgIGV4cGVjdChzYXZlZFVzZXIucGFzc3dvcmQubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oNTApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBub3Qgc2F2ZSB1c2VyIHdpdGhvdXQgcmVxdWlyZWQgZmllbGRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlciA9IG5ldyBVc2VyKHt9KTtcbiAgICAgIFxuICAgICAgYXdhaXQgZXhwZWN0KHVzZXIuc2F2ZSgpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbm90IHNhdmUgdXNlciB3aXRoIGludmFsaWQgZW1haWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0gbmV3IFVzZXIoe1xuICAgICAgICAuLi52YWxpZFVzZXJEYXRhLFxuICAgICAgICBlbWFpbDogJ2ludmFsaWQtZW1haWwnXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgYXdhaXQgZXhwZWN0KHVzZXIuc2F2ZSgpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbm90IHNhdmUgdXNlciB3aXRoIGR1cGxpY2F0ZSBlbWFpbCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IG5ldyBVc2VyKHZhbGlkVXNlckRhdGEpLnNhdmUoKTtcbiAgICAgIGNvbnN0IGR1cGxpY2F0ZVVzZXIgPSBuZXcgVXNlcih2YWxpZFVzZXJEYXRhKTtcbiAgICAgIFxuICAgICAgYXdhaXQgZXhwZWN0KGR1cGxpY2F0ZVVzZXIuc2F2ZSgpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgcGhvbmUgbnVtYmVyIGZvcm1hdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBuZXcgVXNlcih7XG4gICAgICAgIC4uLnZhbGlkVXNlckRhdGEsXG4gICAgICAgIHBob25lOiAnaW52YWxpZC1waG9uZSdcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBhd2FpdCBleHBlY3QodXNlci5zYXZlKCkpLnJlamVjdHMudG9UaHJvdygpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnVXNlciBNZXRob2RzJywgKCkgPT4ge1xuICAgIGxldCB1c2VyOiBJVXNlcjtcblxuICAgIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgICAgdXNlciA9IGF3YWl0IG5ldyBVc2VyKHZhbGlkVXNlckRhdGEpLnNhdmUoKTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdjb21wYXJlUGFzc3dvcmQnLCAoKSA9PiB7XG4gICAgICBpdCgnc2hvdWxkIHJldHVybiB0cnVlIGZvciBjb3JyZWN0IHBhc3N3b3JkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBpc01hdGNoID0gYXdhaXQgdXNlci5jb21wYXJlUGFzc3dvcmQoJ3Bhc3N3b3JkMTIzJyk7XG4gICAgICAgIGV4cGVjdChpc01hdGNoKS50b0JlKHRydWUpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciBpbmNvcnJlY3QgcGFzc3dvcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGlzTWF0Y2ggPSBhd2FpdCB1c2VyLmNvbXBhcmVQYXNzd29yZCgnd3JvbmdwYXNzd29yZCcpO1xuICAgICAgICBleHBlY3QoaXNNYXRjaCkudG9CZShmYWxzZSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdnZW5lcmF0ZUF1dGhUb2tlbicsICgpID0+IHtcbiAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgYSB2YWxpZCBKV1QgdG9rZW4nLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gdXNlci5nZW5lcmF0ZUF1dGhUb2tlbigpO1xuICAgICAgICBleHBlY3QodG9rZW4pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgIGV4cGVjdCh0eXBlb2YgdG9rZW4pLnRvQmUoJ3N0cmluZycpO1xuICAgICAgICBleHBlY3QodG9rZW4uc3BsaXQoJy4nKSkudG9IYXZlTGVuZ3RoKDMpOyAvLyBKV1QgaGFzIDMgcGFydHNcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dlbmVyYXRlUGFzc3dvcmRSZXNldFRva2VuJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBwYXNzd29yZCByZXNldCB0b2tlbiBhbmQgZXhwaXJ5JywgKCkgPT4ge1xuICAgICAgICB1c2VyLmdlbmVyYXRlUGFzc3dvcmRSZXNldFRva2VuKCk7XG4gICAgICAgIFxuICAgICAgICBleHBlY3QodXNlci5wYXNzd29yZFJlc2V0VG9rZW4pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgIGV4cGVjdCh1c2VyLnBhc3N3b3JkUmVzZXRFeHBpcmVzKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICBleHBlY3QodXNlci5wYXNzd29yZFJlc2V0RXhwaXJlcyEuZ2V0VGltZSgpKS50b0JlR3JlYXRlclRoYW4oRGF0ZS5ub3coKSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdnZW5lcmF0ZUVtYWlsVmVyaWZpY2F0aW9uVG9rZW4nLCAoKSA9PiB7XG4gICAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGVtYWlsIHZlcmlmaWNhdGlvbiB0b2tlbiBhbmQgZXhwaXJ5JywgKCkgPT4ge1xuICAgICAgICB1c2VyLmdlbmVyYXRlRW1haWxWZXJpZmljYXRpb25Ub2tlbigpO1xuICAgICAgICBcbiAgICAgICAgZXhwZWN0KHVzZXIuZW1haWxWZXJpZmljYXRpb25Ub2tlbikudG9CZURlZmluZWQoKTtcbiAgICAgICAgZXhwZWN0KHVzZXIuZW1haWxWZXJpZmljYXRpb25FeHBpcmVzKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICBleHBlY3QodXNlci5lbWFpbFZlcmlmaWNhdGlvbkV4cGlyZXMhLmdldFRpbWUoKSkudG9CZUdyZWF0ZXJUaGFuKERhdGUubm93KCkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdVc2VyIFByaXZhY3kgU2V0dGluZ3MnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYXZlIGRlZmF1bHQgcHJpdmFjeSBzZXR0aW5ncycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBuZXcgVXNlcih2YWxpZFVzZXJEYXRhKS5zYXZlKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdCh1c2VyLnByaXZhY3lTZXR0aW5ncykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1c2VyLnByaXZhY3lTZXR0aW5ncy5zaG93RW1haWwpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHVzZXIucHJpdmFjeVNldHRpbmdzLnNob3dQaG9uZSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdCh1c2VyLnByaXZhY3lTZXR0aW5ncy5hbGxvd0RpcmVjdENvbnRhY3QpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGFsbG93IHVwZGF0aW5nIHByaXZhY3kgc2V0dGluZ3MnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgbmV3IFVzZXIodmFsaWRVc2VyRGF0YSkuc2F2ZSgpO1xuICAgICAgXG4gICAgICB1c2VyLnByaXZhY3lTZXR0aW5ncy5zaG93RW1haWwgPSB0cnVlO1xuICAgICAgdXNlci5wcml2YWN5U2V0dGluZ3Muc2hvd1Bob25lID0gdHJ1ZTtcbiAgICAgIHVzZXIucHJpdmFjeVNldHRpbmdzLmFsbG93TWVzc2FnZXMgPSBmYWxzZTtcbiAgICAgIFxuICAgICAgY29uc3QgdXBkYXRlZFVzZXIgPSBhd2FpdCB1c2VyLnNhdmUoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHVwZGF0ZWRVc2VyLnByaXZhY3lTZXR0aW5ncy5zaG93RW1haWwpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QodXBkYXRlZFVzZXIucHJpdmFjeVNldHRpbmdzLnNob3dQaG9uZSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkVXNlci5wcml2YWN5U2V0dGluZ3MuYWxsb3dNZXNzYWdlcykudG9CZShmYWxzZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdVc2VyIFRpbWVzdGFtcHMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzZXQgY3JlYXRlZEF0IGFuZCB1cGRhdGVkQXQgb24gY3JlYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgbmV3IFVzZXIodmFsaWRVc2VyRGF0YSkuc2F2ZSgpO1xuICAgICAgXG4gICAgICBleHBlY3QodXNlci5jcmVhdGVkQXQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QodXNlci51cGRhdGVkQXQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QodXNlci5jcmVhdGVkQXQpLnRvRXF1YWwodXNlci51cGRhdGVkQXQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgdXBkYXRlZEF0IG9uIG1vZGlmaWNhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBuZXcgVXNlcih2YWxpZFVzZXJEYXRhKS5zYXZlKCk7XG4gICAgICBjb25zdCBvcmlnaW5hbFVwZGF0ZWRBdCA9IHVzZXIudXBkYXRlZEF0O1xuICAgICAgXG4gICAgICAvLyDnrYnlvoXkuIDmr6vnp5Lnorrkv53mmYLplpPmiLPkuI3lkIxcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxKSk7XG4gICAgICBcbiAgICAgIHVzZXIubmFtZSA9ICdVcGRhdGVkIE5hbWUnO1xuICAgICAgY29uc3QgdXBkYXRlZFVzZXIgPSBhd2FpdCB1c2VyLnNhdmUoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHVwZGF0ZWRVc2VyLnVwZGF0ZWRBdC5nZXRUaW1lKCkpLnRvQmVHcmVhdGVyVGhhbihvcmlnaW5hbFVwZGF0ZWRBdC5nZXRUaW1lKCkpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==