5cfc42dc853fe1682424ad49ddda94cb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.UserRepository = void 0;
const User_1 = require("../models/User");
class UserRepository {
    async findById(id) {
        return User_1.User.findById(id).exec();
    }
    async findByEmail(email) {
        return User_1.User.findOne({ email }).exec();
    }
    async create(userData) {
        const user = new User_1.User(userData);
        return user.save();
    }
    async update(id, userData) {
        return User_1.User.findByIdAndUpdate(id, userData, { new: true }).exec();
    }
    async delete(id) {
        return User_1.User.findByIdAndDelete(id).exec();
    }
    async findAll() {
        return User_1.User.find().exec();
    }
    async findByEmailVerificationToken(token) {
        return User_1.User.findOne({ emailVerificationToken: token }).exec();
    }
    async findByPasswordResetToken(token) {
        return User_1.User.findOne({ passwordResetToken: token }).exec();
    }
    async verifyEmail(id) {
        return User_1.User.findByIdAndUpdate(id, {
            isEmailVerified: true,
            emailVerificationToken: undefined,
        }, { new: true }).exec();
    }
    async deactivate(id) {
        return User_1.User.findByIdAndUpdate(id, { isActive: false }, { new: true }).exec();
    }
    async findWithPagination(query, options) {
        const { page, limit, sortBy, sortOrder } = options;
        const skip = (page - 1) * limit;
        const sort = {};
        sort[sortBy] = sortOrder === "asc" ? 1 : -1;
        const [users, total] = await Promise.all([
            User_1.User.find(query).sort(sort).skip(skip).limit(limit).exec(),
            User_1.User.countDocuments(query),
        ]);
        return { users, total };
    }
    async findByPasswordResetTokenWithExpiry(token) {
        return User_1.User.findOne({
            passwordResetToken: token,
            passwordResetExpires: { $gt: new Date() },
        })
            .select("+passwordResetToken +passwordResetExpires")
            .exec();
    }
    // 管理員功能相關方法
    async countDocuments(filter = {}) {
        return User_1.User.countDocuments(filter).exec();
    }
    async findWithSelect(filter, select, options) {
        let query = User_1.User.find(filter).select(select);
        if (options?.sort) {
            query = query.sort(options.sort);
        }
        if (options?.skip) {
            query = query.skip(options.skip);
        }
        if (options?.limit) {
            query = query.limit(options.limit);
        }
        return query.exec();
    }
    async findByIdWithSelect(id, select) {
        return User_1.User.findById(id).select(select).exec();
    }
    async updateWithValidation(id, updateData) {
        return User_1.User.findByIdAndUpdate(id, updateData, {
            new: true,
            runValidators: true,
        })
            .select("-password -passwordResetToken -passwordResetExpires -emailVerificationToken -emailVerificationExpires")
            .exec();
    }
    async softDelete(id, email) {
        return User_1.User.findByIdAndUpdate(id, {
            isActive: false,
            email: `deleted_${Date.now()}_${email}`,
        }).exec();
    }
    async updatePassword(id, password) {
        const user = await User_1.User.findById(id);
        if (user) {
            user.password = password;
            await user.save();
            return user;
        }
        return null;
    }
    async getStatistics() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const [total, active, verified, admins, recent] = await Promise.all([
            User_1.User.countDocuments(),
            User_1.User.countDocuments({ isActive: true }),
            User_1.User.countDocuments({ isEmailVerified: true }),
            User_1.User.countDocuments({ role: { $in: ["admin", "moderator"] } }),
            User_1.User.countDocuments({ createdAt: { $gte: thirtyDaysAgo } }),
        ]);
        return { total, active, verified, admins, recent };
    }
    // 清理過期驗證令牌
    async cleanupExpiredTokens() {
        const now = new Date();
        const result = await User_1.User.updateMany({
            $or: [
                {
                    emailVerificationExpires: { $lt: now },
                    emailVerificationToken: { $exists: true, $ne: null },
                },
                {
                    passwordResetExpires: { $lt: now },
                    passwordResetToken: { $exists: true, $ne: null },
                },
            ],
        }, {
            $unset: {
                emailVerificationToken: 1,
                emailVerificationExpires: 1,
                passwordResetToken: 1,
                passwordResetExpires: 1,
            },
        });
        return { deletedCount: result.modifiedCount };
    }
}
exports.UserRepository = UserRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJlcG9zaXRvcmllc1xcdXNlclJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUNBQTZDO0FBRTdDLE1BQWEsY0FBYztJQUN6QixLQUFLLENBQUMsUUFBUSxDQUFDLEVBQVU7UUFDdkIsT0FBTyxXQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQWE7UUFDN0IsT0FBTyxXQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUF3QjtRQUNuQyxNQUFNLElBQUksR0FBRyxJQUFJLFdBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoQyxPQUFPLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFVLEVBQUUsUUFBd0I7UUFDL0MsT0FBTyxXQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3BFLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQVU7UUFDckIsT0FBTyxXQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDM0MsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPO1FBQ1gsT0FBTyxXQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxLQUFhO1FBQzlDLE9BQU8sV0FBSSxDQUFDLE9B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QixFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFO2lCQUNyRDtnQkFDRDtvQkFDRSxvQkFBb0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7b0JBQ2xDLGtCQUFrQixFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFO2lCQUNqRDthQUNGO1NBQ0YsRUFDRDtZQUNFLE1BQU0sRUFBRTtnQkFDTixzQkFBc0IsRUFBRSxDQUFDO2dCQUN6Qix3QkFBd0IsRUFBRSxDQUFDO2dCQUMzQixrQkFBa0IsRUFBRSxDQUFDO2dCQUNyQixvQkFBb0IsRUFBRSxDQUFDO2FBQ3hCO1NBQ0YsQ0FDRixDQUFDO1FBRUYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDaEQsQ0FBQztDQUNGO0FBdE1ELHdDQXNNQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccmVwb3NpdG9yaWVzXFx1c2VyUmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBVc2VyLCBJVXNlciB9IGZyb20gXCIuLi9tb2RlbHMvVXNlclwiO1xuXG5leHBvcnQgY2xhc3MgVXNlclJlcG9zaXRvcnkge1xuICBhc3luYyBmaW5kQnlJZChpZDogc3RyaW5nKTogUHJvbWlzZTxJVXNlciB8IG51bGw+IHtcbiAgICByZXR1cm4gVXNlci5maW5kQnlJZChpZCkuZXhlYygpO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5RW1haWwoZW1haWw6IHN0cmluZyk6IFByb21pc2U8SVVzZXIgfCBudWxsPiB7XG4gICAgcmV0dXJuIFVzZXIuZmluZE9uZSh7IGVtYWlsIH0pLmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZSh1c2VyRGF0YTogUGFydGlhbDxJVXNlcj4pOiBQcm9taXNlPElVc2VyPiB7XG4gICAgY29uc3QgdXNlciA9IG5ldyBVc2VyKHVzZXJEYXRhKTtcbiAgICByZXR1cm4gdXNlci5zYXZlKCk7XG4gIH1cblxuICBhc3luYyB1cGRhdGUoaWQ6IHN0cmluZywgdXNlckRhdGE6IFBhcnRpYWw8SVVzZXI+KTogUHJvbWlzZTxJVXNlciB8IG51bGw+IHtcbiAgICByZXR1cm4gVXNlci5maW5kQnlJZEFuZFVwZGF0ZShpZCwgdXNlckRhdGEsIHsgbmV3OiB0cnVlIH0pLmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZShpZDogc3RyaW5nKTogUHJvbWlzZTxJVXNlciB8IG51bGw+IHtcbiAgICByZXR1cm4gVXNlci5maW5kQnlJZEFuZERlbGV0ZShpZCkuZXhlYygpO1xuICB9XG5cbiAgYXN5bmMgZmluZEFsbCgpOiBQcm9taXNlPElVc2VyW10+IHtcbiAgICByZXR1cm4gVXNlci5maW5kKCkuZXhlYygpO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5RW1haWxWZXJpZmljYXRpb25Ub2tlbih0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxJVXNlciB8IG51bGw+IHtcbiAgICByZXR1cm4gVXNlci5maW5kT25lKHsgZW1haWxWZXJpZmljYXRpb25Ub2tlbjogdG9rZW4gfSkuZXhlYygpO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5UGFzc3dvcmRSZXNldFRva2VuKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPElVc2VyIHwgbnVsbD4ge1xuICAgIHJldHVybiBVc2VyLmZpbmRPbmUoeyBwYXNzd29yZFJlc2V0VG9rZW46IHRva2VuIH0pLmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIHZlcmlmeUVtYWlsKGlkOiBzdHJpbmcpOiBQcm9taXNlPElVc2VyIHwgbnVsbD4ge1xuICAgIHJldHVybiBVc2VyLmZpbmRCeUlkQW5kVXBkYXRlKFxuICAgICAgaWQsXG4gICAgICB7XG4gICAgICAgIGlzRW1haWxWZXJpZmllZDogdHJ1ZSxcbiAgICAgICAgZW1haWxWZXJpZmljYXRpb25Ub2tlbjogdW5kZWZpbmVkLFxuICAgICAgfSxcbiAgICAgIHsgbmV3OiB0cnVlIH0sXG4gICAgKS5leGVjKCk7XG4gIH1cblxuICBhc3luYyBkZWFjdGl2YXRlKGlkOiBzdHJpbmcpOiBQcm9taXNlPElVc2VyIHwgbnVsbD4ge1xuICAgIHJldHVybiBVc2VyLmZpbmRCeUlkQW5kVXBkYXRlKFxuICAgICAgaWQsXG4gICAgICB7IGlzQWN0aXZlOiBmYWxzZSB9LFxuICAgICAgeyBuZXc6IHRydWUgfSxcbiAgICApLmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRXaXRoUGFnaW5hdGlvbihcbiAgICBxdWVyeTogYW55LFxuICAgIG9wdGlvbnM6IHtcbiAgICAgIHBhZ2U6IG51bWJlcjtcbiAgICAgIGxpbWl0OiBudW1iZXI7XG4gICAgICBzb3J0Qnk6IHN0cmluZztcbiAgICAgIHNvcnRPcmRlcjogXCJhc2NcIiB8IFwiZGVzY1wiO1xuICAgIH0sXG4gICk6IFByb21pc2U8eyB1c2VyczogSVVzZXJbXTsgdG90YWw6IG51bWJlciB9PiB7XG4gICAgY29uc3QgeyBwYWdlLCBsaW1pdCwgc29ydEJ5LCBzb3J0T3JkZXIgfSA9IG9wdGlvbnM7XG4gICAgY29uc3Qgc2tpcCA9IChwYWdlIC0gMSkgKiBsaW1pdDtcblxuICAgIGNvbnN0IHNvcnQ6IGFueSA9IHt9O1xuICAgIHNvcnRbc29ydEJ5XSA9IHNvcnRPcmRlciA9PT0gXCJhc2NcIiA/IDEgOiAtMTtcblxuICAgIGNvbnN0IFt1c2VycywgdG90YWxdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgVXNlci5maW5kKHF1ZXJ5KS5zb3J0KHNvcnQpLnNraXAoc2tpcCkubGltaXQobGltaXQpLmV4ZWMoKSxcbiAgICAgIFVzZXIuY291bnREb2N1bWVudHMocXVlcnkpLFxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHsgdXNlcnMsIHRvdGFsIH07XG4gIH1cblxuICBhc3luYyBmaW5kQnlQYXNzd29yZFJlc2V0VG9rZW5XaXRoRXhwaXJ5KFxuICAgIHRva2VuOiBzdHJpbmcsXG4gICk6IFByb21pc2U8SVVzZXIgfCBudWxsPiB7XG4gICAgcmV0dXJuIFVzZXIuZmluZE9uZSh7XG4gICAgICBwYXNzd29yZFJlc2V0VG9rZW46IHRva2VuLFxuICAgICAgcGFzc3dvcmRSZXNldEV4cGlyZXM6IHsgJGd0OiBuZXcgRGF0ZSgpIH0sXG4gICAgfSlcbiAgICAgIC5zZWxlY3QoXCIrcGFzc3dvcmRSZXNldFRva2VuICtwYXNzd29yZFJlc2V0RXhwaXJlc1wiKVxuICAgICAgLmV4ZWMoKTtcbiAgfVxuXG4gIC8vIOeuoeeQhuWToeWKn+iDveebuOmXnOaWueazlVxuICBhc3luYyBjb3VudERvY3VtZW50cyhmaWx0ZXI6IGFueSA9IHt9KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gVXNlci5jb3VudERvY3VtZW50cyhmaWx0ZXIpLmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRXaXRoU2VsZWN0KFxuICAgIGZpbHRlcjogYW55LFxuICAgIHNlbGVjdDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBhbnksXG4gICk6IFByb21pc2U8SVVzZXJbXT4ge1xuICAgIGxldCBxdWVyeSA9IFVzZXIuZmluZChmaWx0ZXIpLnNlbGVjdChzZWxlY3QpO1xuXG4gICAgaWYgKG9wdGlvbnM/LnNvcnQpIHtcbiAgICAgIHF1ZXJ5ID0gcXVlcnkuc29ydChvcHRpb25zLnNvcnQpO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zPy5za2lwKSB7XG4gICAgICBxdWVyeSA9IHF1ZXJ5LnNraXAob3B0aW9ucy5za2lwKTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucz8ubGltaXQpIHtcbiAgICAgIHF1ZXJ5ID0gcXVlcnkubGltaXQob3B0aW9ucy5saW1pdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHF1ZXJ5LmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRCeUlkV2l0aFNlbGVjdChpZDogc3RyaW5nLCBzZWxlY3Q6IHN0cmluZyk6IFByb21pc2U8SVVzZXIgfCBudWxsPiB7XG4gICAgcmV0dXJuIFVzZXIuZmluZEJ5SWQoaWQpLnNlbGVjdChzZWxlY3QpLmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVdpdGhWYWxpZGF0aW9uKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdXBkYXRlRGF0YTogYW55LFxuICApOiBQcm9taXNlPElVc2VyIHwgbnVsbD4ge1xuICAgIHJldHVybiBVc2VyLmZpbmRCeUlkQW5kVXBkYXRlKGlkLCB1cGRhdGVEYXRhLCB7XG4gICAgICBuZXc6IHRydWUsXG4gICAgICBydW5WYWxpZGF0b3JzOiB0cnVlLFxuICAgIH0pXG4gICAgICAuc2VsZWN0KFxuICAgICAgICBcIi1wYXNzd29yZCAtcGFzc3dvcmRSZXNldFRva2VuIC1wYXNzd29yZFJlc2V0RXhwaXJlcyAtZW1haWxWZXJpZmljYXRpb25Ub2tlbiAtZW1haWxWZXJpZmljYXRpb25FeHBpcmVzXCIsXG4gICAgICApXG4gICAgICAuZXhlYygpO1xuICB9XG5cbiAgYXN5bmMgc29mdERlbGV0ZShpZDogc3RyaW5nLCBlbWFpbDogc3RyaW5nKTogUHJvbWlzZTxJVXNlciB8IG51bGw+IHtcbiAgICByZXR1cm4gVXNlci5maW5kQnlJZEFuZFVwZGF0ZShpZCwge1xuICAgICAgaXNBY3RpdmU6IGZhbHNlLFxuICAgICAgZW1haWw6IGBkZWxldGVkXyR7RGF0ZS5ub3coKX1fJHtlbWFpbH1gLFxuICAgIH0pLmV4ZWMoKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVBhc3N3b3JkKGlkOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPElVc2VyIHwgbnVsbD4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKGlkKTtcbiAgICBpZiAodXNlcikge1xuICAgICAgdXNlci5wYXNzd29yZCA9IHBhc3N3b3JkO1xuICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgICByZXR1cm4gdXNlcjtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBhc3luYyBnZXRTdGF0aXN0aWNzKCk6IFByb21pc2U8e1xuICAgIHRvdGFsOiBudW1iZXI7XG4gICAgYWN0aXZlOiBudW1iZXI7XG4gICAgdmVyaWZpZWQ6IG51bWJlcjtcbiAgICBhZG1pbnM6IG51bWJlcjtcbiAgICByZWNlbnQ6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IHRoaXJ0eURheXNBZ28gPSBuZXcgRGF0ZSgpO1xuICAgIHRoaXJ0eURheXNBZ28uc2V0RGF0ZSh0aGlydHlEYXlzQWdvLmdldERhdGUoKSAtIDMwKTtcblxuICAgIGNvbnN0IFt0b3RhbCwgYWN0aXZlLCB2ZXJpZmllZCwgYWRtaW5zLCByZWNlbnRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgVXNlci5jb3VudERvY3VtZW50cygpLFxuICAgICAgVXNlci5jb3VudERvY3VtZW50cyh7IGlzQWN0aXZlOiB0cnVlIH0pLFxuICAgICAgVXNlci5jb3VudERvY3VtZW50cyh7IGlzRW1haWxWZXJpZmllZDogdHJ1ZSB9KSxcbiAgICAgIFVzZXIuY291bnREb2N1bWVudHMoeyByb2xlOiB7ICRpbjogW1wiYWRtaW5cIiwgXCJtb2RlcmF0b3JcIl0gfSB9KSxcbiAgICAgIFVzZXIuY291bnREb2N1bWVudHMoeyBjcmVhdGVkQXQ6IHsgJGd0ZTogdGhpcnR5RGF5c0FnbyB9IH0pLFxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHsgdG90YWwsIGFjdGl2ZSwgdmVyaWZpZWQsIGFkbWlucywgcmVjZW50IH07XG4gIH1cblxuICAvLyDmuIXnkIbpgY7mnJ/pqZforYnku6TniYxcbiAgYXN5bmMgY2xlYW51cEV4cGlyZWRUb2tlbnMoKTogUHJvbWlzZTx7IGRlbGV0ZWRDb3VudDogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFVzZXIudXBkYXRlTWFueShcbiAgICAgIHtcbiAgICAgICAgJG9yOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgZW1haWxWZXJpZmljYXRpb25FeHBpcmVzOiB7ICRsdDogbm93IH0sXG4gICAgICAgICAgICBlbWFpbFZlcmlmaWNhdGlvblRva2VuOiB7ICRleGlzdHM6IHRydWUsICRuZTogbnVsbCB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgcGFzc3dvcmRSZXNldEV4cGlyZXM6IHsgJGx0OiBub3cgfSxcbiAgICAgICAgICAgIHBhc3N3b3JkUmVzZXRUb2tlbjogeyAkZXhpc3RzOiB0cnVlLCAkbmU6IG51bGwgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgJHVuc2V0OiB7XG4gICAgICAgICAgZW1haWxWZXJpZmljYXRpb25Ub2tlbjogMSxcbiAgICAgICAgICBlbWFpbFZlcmlmaWNhdGlvbkV4cGlyZXM6IDEsXG4gICAgICAgICAgcGFzc3dvcmRSZXNldFRva2VuOiAxLFxuICAgICAgICAgIHBhc3N3b3JkUmVzZXRFeHBpcmVzOiAxLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHsgZGVsZXRlZENvdW50OiByZXN1bHQubW9kaWZpZWRDb3VudCB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=