{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\test\\setup-optimized.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\test\\setup-optimized.ts"],"sourcesContent":["import { MongoMemoryServer } from 'mongodb-memory-server';\nimport mongoose from 'mongoose';\nimport { config } from '../src/config/environment';\n\n// å…¨å±€å…±äº«çš„ MongoDB å¯¦ä¾‹\nlet mongod: MongoMemoryServer;\nlet isSetup = false;\n\n// å„ªåŒ–çš„ MongoDB Memory Server è¨­ç½®\nbeforeAll(async () => {\n  if (!isSetup) {\n    try {\n      // ä½¿ç”¨æ›´å°çš„å…§å­˜é…ç½®å’Œå„ªåŒ–é¸é …\n      mongod = await MongoMemoryServer.create({\n        instance: {\n          dbSize: 1, // 1MB æ•¸æ“šåº«å¤§å°\n          storageEngine: 'ephemeralForTest', // ä½¿ç”¨å…§å­˜å­˜å„²å¼•æ“Ž\n          port: undefined, // è®“ç³»çµ±è‡ªå‹•åˆ†é…ç«¯å£\n        },\n        binary: {\n          version: '6.0.0', // ä½¿ç”¨è¼ƒæ–°ä½†ç©©å®šçš„ç‰ˆæœ¬\n          skipMD5: true, // è·³éŽ MD5 æª¢æŸ¥ä»¥æå‡å•Ÿå‹•é€Ÿåº¦\n        }\n      });\n      \n      const uri = mongod.getUri();\n      \n      // å„ªåŒ–çš„é€£æŽ¥é…ç½®\n      await mongoose.connect(uri, {\n        maxPoolSize: 5, // é™åˆ¶é€£æŽ¥æ± å¤§å°\n        serverSelectionTimeoutMS: 5000, // 5ç§’æœå‹™å™¨é¸æ“‡è¶…æ™‚\n        socketTimeoutMS: 10000, // 10ç§’å¥—æŽ¥å­—è¶…æ™‚\n        connectTimeoutMS: 5000, // 5ç§’é€£æŽ¥è¶…æ™‚\n        maxIdleTimeMS: 30000, // 30ç§’æœ€å¤§ç©ºé–’æ™‚é–“\n        bufferMaxEntries: 0, // ç¦ç”¨ç·©è¡\n      });\n      \n      isSetup = true;\n      console.log('âœ… å„ªåŒ–çš„æ¸¬è©¦æ•¸æ“šåº«å·²å•Ÿå‹•');\n    } catch (error) {\n      console.error('âŒ æ¸¬è©¦æ•¸æ“šåº«å•Ÿå‹•å¤±æ•—:', error);\n      throw error;\n    }\n  }\n}, 30000); // å¢žåŠ è¶…æ™‚æ™‚é–“ä»¥æ‡‰å°æ…¢é€Ÿå•Ÿå‹•\n\n// å„ªåŒ–çš„æ•¸æ“šæ¸…ç†ç­–ç•¥\nafterEach(async () => {\n  try {\n    // åªæ¸…ç†å¿…è¦çš„é›†åˆï¼Œè€Œä¸æ˜¯æ‰€æœ‰é›†åˆ\n    const collectionsToClean = ['users', 'pets', 'sessions'];\n    \n    // ä¸¦è¡Œæ¸…ç†é›†åˆä»¥æå‡é€Ÿåº¦\n    const cleanupPromises = collectionsToClean.map(async (collectionName) => {\n      try {\n        const collection = mongoose.connection.collection(collectionName);\n        await collection.deleteMany({});\n      } catch (error) {\n        // å¿½ç•¥ä¸å­˜åœ¨çš„é›†åˆéŒ¯èª¤\n        if (!error.message.includes('ns not found')) {\n          console.warn(`æ¸…ç†é›†åˆ ${collectionName} æ™‚å‡ºç¾è­¦å‘Š:`, error.message);\n        }\n      }\n    });\n    \n    await Promise.all(cleanupPromises);\n  } catch (error) {\n    console.warn('æ•¸æ“šæ¸…ç†æ™‚å‡ºç¾è­¦å‘Š:', error.message);\n  }\n});\n\n// å„ªåŒ–çš„æ¸¬è©¦å¾Œæ¸…ç†\nafterAll(async () => {\n  try {\n    if (mongoose.connection.readyState !== 0) {\n      await mongoose.connection.dropDatabase();\n      await mongoose.connection.close();\n    }\n    \n    if (mongod) {\n      await mongod.stop();\n    }\n    \n    console.log('âœ… æ¸¬è©¦æ•¸æ“šåº«å·²æ¸…ç†å®Œæˆ');\n  } catch (error) {\n    console.warn('æ¸¬è©¦æ¸…ç†æ™‚å‡ºç¾è­¦å‘Š:', error.message);\n  }\n}, 10000);\n\n// å„ªåŒ–çš„ç’°å¢ƒè®Šæ•¸è¨­ç½®\nprocess.env.NODE_ENV = 'test';\nprocess.env.MONGODB_URI = 'mongodb://localhost:27017/pet-finder-test';\nprocess.env.JWT_SECRET = 'test-jwt-secret-key-with-minimum-32-characters-length';\nprocess.env.EMAIL_FROM = 'test@example.com';\nprocess.env.FRONTEND_URL = 'http://localhost:3000';\nprocess.env.AWS_ACCESS_KEY_ID = 'test-access-key';\nprocess.env.AWS_SECRET_ACCESS_KEY = 'test-secret-key';\nprocess.env.AWS_REGION = 'us-east-1';\nprocess.env.S3_BUCKET_NAME = 'test-bucket';\nprocess.env.SMTP_HOST = 'smtp.test.com';\nprocess.env.SMTP_PORT = '587';\nprocess.env.SMTP_USER = 'test@example.com';\nprocess.env.SMTP_PASS = 'test-password';\nprocess.env.OPENAI_API_KEY = 'test-openai-key';\n\n// å„ªåŒ–çš„å¤–éƒ¨æœå‹™æ¨¡æ“¬\njest.mock('../src/services/emailService', () => ({\n  EmailService: {\n    sendVerificationEmail: jest.fn().mockResolvedValue(true),\n    sendPasswordResetEmail: jest.fn().mockResolvedValue(true),\n    sendWelcomeEmail: jest.fn().mockResolvedValue(true),\n    sendNotificationEmail: jest.fn().mockResolvedValue(true)\n  }\n}));\n\n// å„ªåŒ–çš„ AI æœå‹™æ¨¡æ“¬ - ä½¿ç”¨æ›´å¿«çš„éŸ¿æ‡‰\njest.mock('../src/services/aiService', () => ({\n  analyzeImage: jest.fn().mockResolvedValue({\n    breed: 'Golden Retriever',\n    confidence: 0.95,\n    features: {\n      color: 'golden',\n      size: 'large',\n      age: 'adult'\n    }\n  }),\n  findSimilarPets: jest.fn().mockResolvedValue([]),\n  generateSearchSuggestions: jest.fn().mockResolvedValue(['golden retriever', 'labrador'])\n}));\n\n// å…¨å±€éŒ¯èª¤è™•ç†\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.warn('æ¸¬è©¦ä¸­å‡ºç¾æœªè™•ç†çš„ Promise æ‹’çµ•:', reason);\n});\n\nprocess.on('uncaughtException', (error) => {\n  console.warn('æ¸¬è©¦ä¸­å‡ºç¾æœªæ•ç²çš„ç•°å¸¸:', error.message);\n});\n\n// å°Žå‡ºå·¥å…·å‡½æ•¸ä¾›æ¸¬è©¦ä½¿ç”¨\nexport const getTestDbUri = () => mongod?.getUri();\nexport const isTestDbReady = () => isSetup && mongoose.connection.readyState === 1;\n\n// æ¸¬è©¦æ€§èƒ½ç›£æŽ§\nconst testStartTime = Date.now();\n\nafterAll(() => {\n  const testDuration = Date.now() - testStartTime;\n  console.log(`ðŸ“Š æ¸¬è©¦ç¸½è€—æ™‚: ${testDuration}ms`);\n});"],"version":3}