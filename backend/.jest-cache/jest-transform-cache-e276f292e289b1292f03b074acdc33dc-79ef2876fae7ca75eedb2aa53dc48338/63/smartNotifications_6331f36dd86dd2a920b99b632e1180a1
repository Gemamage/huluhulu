e8df9c6fcc817f1d4a153d34c5d8a1b6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.smartNotificationRoutes = void 0;
const express_1 = require("express");
const smartNotificationService_1 = require("../services/smartNotificationService");
const auth_1 = require("../middleware/auth");
const validation_1 = require("../utils/validation");
const express_validator_1 = require("express-validator");
const logger_1 = require("../utils/logger");
const router = (0, express_1.Router)();
exports.smartNotificationRoutes = router;
// 獲取智能通知統計
router.get('/statistics', auth_1.authenticate, [
    (0, express_validator_1.query)('startDate').optional().isISO8601().withMessage('開始日期格式無效'),
    (0, express_validator_1.query)('endDate').optional().isISO8601().withMessage('結束日期格式無效'),
], validation_1.validateRequest, async (req, res) => {
    try {
        const { startDate, endDate } = req.query;
        const userId = req.user._id.toString();
        const statistics = await smartNotificationService_1.SmartNotificationService.getSmartNotificationStatistics({
            userId,
            startDate: startDate ? new Date(startDate) : undefined,
            endDate: endDate ? new Date(endDate) : undefined,
        });
        res.json({
            success: true,
            data: statistics,
        });
    }
    catch (error) {
        logger_1.logger.error('獲取智能通知統計失敗:', error);
        res.status(500).json({
            success: false,
            message: '獲取統計資料失敗',
        });
    }
});
// 獲取智能通知配置
router.get('/config', auth_1.authenticate, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const config = await smartNotificationService_1.SmartNotificationService.getConfig(userId);
        res.json({
            success: true,
            data: config,
        });
    }
    catch (error) {
        logger_1.logger.error('獲取智能通知配置失敗:', error);
        res.status(500).json({
            success: false,
            message: '獲取配置失敗',
        });
    }
});
// 更新智能通知配置
router.put('/config', auth_1.authenticate, [
    (0, express_validator_1.body)('aiMatching').optional().isObject().withMessage('AI 配對設定必須是物件'),
    (0, express_validator_1.body)('aiMatching.enabled').optional().isBoolean().withMessage('AI 配對啟用狀態必須是布林值'),
    (0, express_validator_1.body)('aiMatching.minSimilarity').optional().isFloat({ min: 0, max: 1 }).withMessage('最小相似度必須在 0-1 之間'),
    (0, express_validator_1.body)('aiMatching.checkInterval').optional().isInt({ min: 1 }).withMessage('檢查間隔必須是正整數'),
    (0, express_validator_1.body)('aiMatching.maxNotificationsPerDay').optional().isInt({ min: 1 }).withMessage('每日最大通知數必須是正整數'),
    (0, express_validator_1.body)('geofencing').optional().isObject().withMessage('地理圍欄設定必須是物件'),
    (0, express_validator_1.body)('geofencing.enabled').optional().isBoolean().withMessage('地理圍欄啟用狀態必須是布林值'),
    (0, express_validator_1.body)('geofencing.radius').optional().isFloat({ min: 0.1 }).withMessage('半徑必須大於 0.1'),
    (0, express_validator_1.body)('geofencing.checkInterval').optional().isInt({ min: 1 }).withMessage('檢查間隔必須是正整數'),
    (0, express_validator_1.body)('reminders').optional().isObject().withMessage('提醒設定必須是物件'),
    (0, express_validator_1.body)('reminders.enabled').optional().isBoolean().withMessage('提醒啟用狀態必須是布林值'),
    (0, express_validator_1.body)('reminders.updateReminder').optional().isInt({ min: 1 }).withMessage('更新提醒間隔必須是正整數'),
    (0, express_validator_1.body)('reminders.searchReminder').optional().isInt({ min: 1 }).withMessage('搜尋提醒間隔必須是正整數'),
], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const configUpdate = req.body;
        const updatedConfig = await smartNotificationService_1.SmartNotificationService.updateConfig(userId, configUpdate);
        res.json({
            success: true,
            data: updatedConfig,
            message: '配置更新成功',
        });
    }
    catch (error) {
        logger_1.logger.error('更新智能通知配置失敗:', error);
        res.status(500).json({
            success: false,
            message: '更新配置失敗',
        });
    }
});
// 創建地理圍欄
router.post('/geofence', auth_1.authenticate, [
    (0, express_validator_1.body)('petId').isMongoId().withMessage('寵物 ID 格式無效'),
    (0, express_validator_1.body)('latitude').isFloat({ min: -90, max: 90 }).withMessage('緯度必須在 -90 到 90 之間'),
    (0, express_validator_1.body)('longitude').isFloat({ min: -180, max: 180 }).withMessage('經度必須在 -180 到 180 之間'),
    (0, express_validator_1.body)('radius').isFloat({ min: 0.1, max: 50 }).withMessage('半徑必須在 0.1 到 50 公里之間'),
    (0, express_validator_1.body)('name').optional().isString().isLength({ max: 100 }).withMessage('名稱長度不能超過 100 字元'),
], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const { petId, latitude, longitude, radius, name } = req.body;
        const geofence = await smartNotificationService_1.SmartNotificationService.createGeofence({
            userId,
            petId,
            latitude,
            longitude,
            radius,
            name,
        });
        return res.status(201).json({
            success: true,
            data: geofence,
            message: '地理圍欄創建成功',
        });
    }
    catch (error) {
        logger_1.logger.error('創建地理圍欄失敗:', error);
        return res.status(500).json({
            success: false,
            message: '創建地理圍欄失敗',
        });
    }
});
// 移除地理圍欄
router.delete('/geofence/:geofenceId', auth_1.authenticate, [
    (0, express_validator_1.param)('geofenceId').isMongoId().withMessage('地理圍欄 ID 格式無效'),
], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const { geofenceId } = req.params;
        if (!geofenceId) {
            return res.status(400).json({
                success: false,
                message: '地理圍欄 ID 為必填項目',
            });
        }
        await smartNotificationService_1.SmartNotificationService.removeGeofence(userId, geofenceId);
        return res.json({
            success: true,
            message: '地理圍欄移除成功',
        });
    }
    catch (error) {
        logger_1.logger.error('移除地理圍欄失敗:', error);
        return res.status(500).json({
            success: false,
            message: '移除地理圍欄失敗',
        });
    }
});
// 獲取用戶的地理圍欄列表
router.get('/geofences', auth_1.authenticate, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const geofences = await smartNotificationService_1.SmartNotificationService.getUserGeofences(userId);
        return res.json({
            success: true,
            data: geofences,
        });
    }
    catch (error) {
        logger_1.logger.error('獲取地理圍欄列表失敗:', error);
        return res.status(500).json({
            success: false,
            message: '獲取地理圍欄列表失敗',
        });
    }
});
// 手動觸發 AI 配對檢查
router.post('/trigger-ai-matching', auth_1.authenticate, [
    (0, express_validator_1.body)('petId').optional().isMongoId().withMessage('寵物 ID 格式無效'),
], validation_1.validateRequest, async (req, res) => {
    try {
        const userId = req.user._id.toString();
        const { petId } = req.body;
        const result = await smartNotificationService_1.SmartNotificationService.triggerAIMatching(userId, petId);
        return res.json({
            success: true,
            data: result,
            message: 'AI 配對檢查已觸發',
        });
    }
    catch (error) {
        logger_1.logger.error('觸發 AI 配對檢查失敗:', error);
        return res.status(500).json({
            success: false,
            message: '觸發 AI 配對檢查失敗',
        });
    }
});
// 測試智能通知（僅開發環境）
router.post('/test', auth_1.authenticate, [
    (0, express_validator_1.body)('type').isIn(['ai_matching', 'geofencing', 'reminder']).withMessage('通知類型無效'),
    (0, express_validator_1.body)('petId').optional().isMongoId().withMessage('寵物 ID 格式無效'),
], validation_1.validateRequest, async (req, res) => {
    try {
        // 僅在非生產環境允許測試
        if (process.env.NODE_ENV === 'production') {
            return res.status(403).json({
                success: false,
                message: '生產環境不允許測試功能',
            });
        }
        const userId = req.user._id.toString();
        const { type, petId } = req.body;
        let result;
        switch (type) {
            case 'ai_matching':
                result = await smartNotificationService_1.SmartNotificationService.triggerAIMatching(userId, petId);
                break;
            case 'geofencing':
                // 模擬地理圍欄觸發
                result = { message: '地理圍欄測試通知已發送' };
                break;
            case 'reminder':
                // 模擬提醒通知
                result = { message: '提醒測試通知已發送' };
                break;
            default:
                return res.status(400).json({
                    success: false,
                    message: '不支援的測試類型',
                });
        }
        return res.json({
            success: true,
            data: result,
            message: `${type} 測試通知已發送`,
        });
    }
    catch (error) {
        logger_1.logger.error('發送測試通知失敗:', error);
        return res.status(500).json({
            success: false,
            message: '發送測試通知失敗',
        });
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcc21hcnROb3RpZmljYXRpb25zLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFpQztBQUVqQyxtRkFBZ0Y7QUFDaEYsNkNBQTBEO0FBQzFELG9EQUFzRDtBQUN0RCx5REFBdUQ7QUFDdkQsNENBQXlDO0FBRXpDLE1BQU0sTUFBTSxHQUFHLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBMFJMLHlDQUF1QjtBQXhSMUMsV0FBVztBQUNYLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUN0QixtQkFBSSxFQUNKO0lBQ0UsSUFBQSx5QkFBSyxFQUFDLFdBQVcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUM7SUFDakUsSUFBQSx5QkFBSyxFQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUM7Q0FDaEUsRUFDRCw0QkFBZSxFQUNmLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1FBQ3pDLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxJQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXhDLE1BQU0sVUFBVSxHQUFHLE1BQU0sbURBQXdCLENBQUMsOEJBQThCLENBQUM7WUFDL0UsTUFBTTtZQUNOLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFNBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNoRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFpQixDQUFDLENB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LFlBQVk7Z0JBQ2YsV0FBVztnQkFDWCxNQUFNLEdBQUcsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLENBQUM7Z0JBQ3BDLE1BQU07WUFDUixLQUFLLFVBQVU7Z0JBQ2IsU0FBUztnQkFDVCxNQUFNLEdBQUcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLENBQUM7Z0JBQ2xDLE1BQU07WUFDUjtnQkFDRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsS0FBSztvQkFDZCxPQUFPLEVBQUUsVUFBVTtpQkFDcEIsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUVELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztZQUNkLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsR0FBRyxJQUFJLFVBQVU7U0FDM0IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixlQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqQyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLFVBQVU7U0FDcEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FDRixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVXNlclxcRGVza3RvcFxcdHJhZXByb2plY3RcXHRlc3QyXFxwZXQtZmluZGVyLWFwcFxcYmFja2VuZFxcc3JjXFxyb3V0ZXNcXHNtYXJ0Tm90aWZpY2F0aW9ucy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zbWFydE5vdGlmaWNhdGlvblNlcnZpY2UnO1xuaW1wb3J0IHsgYXV0aGVudGljYXRlIGFzIGF1dGggfSBmcm9tICcuLi9taWRkbGV3YXJlL2F1dGgnO1xuaW1wb3J0IHsgdmFsaWRhdGVSZXF1ZXN0IH0gZnJvbSAnLi4vdXRpbHMvdmFsaWRhdGlvbic7XG5pbXBvcnQgeyBib2R5LCBxdWVyeSwgcGFyYW0gfSBmcm9tICdleHByZXNzLXZhbGlkYXRvcic7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxuLy8g542y5Y+W5pm66IO96YCa55+l57Wx6KiIXG5yb3V0ZXIuZ2V0KCcvc3RhdGlzdGljcycsXG4gIGF1dGgsXG4gIFtcbiAgICBxdWVyeSgnc3RhcnREYXRlJykub3B0aW9uYWwoKS5pc0lTTzg2MDEoKS53aXRoTWVzc2FnZSgn6ZaL5aeL5pel5pyf5qC85byP54Sh5pWIJyksXG4gICAgcXVlcnkoJ2VuZERhdGUnKS5vcHRpb25hbCgpLmlzSVNPODYwMSgpLndpdGhNZXNzYWdlKCfntZDmnZ/ml6XmnJ/moLzlvI/nhKHmlYgnKSxcbiAgXSxcbiAgdmFsaWRhdGVSZXF1ZXN0LFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgc3RhcnREYXRlLCBlbmREYXRlIH0gPSByZXEucXVlcnk7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuX2lkLnRvU3RyaW5nKCk7XG5cbiAgICAgIGNvbnN0IHN0YXRpc3RpY3MgPSBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UuZ2V0U21hcnROb3RpZmljYXRpb25TdGF0aXN0aWNzKHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBzdGFydERhdGU6IHN0YXJ0RGF0ZSA/IG5ldyBEYXRlKHN0YXJ0RGF0ZSBhcyBzdHJpbmcpIDogdW5kZWZpbmVkLFxuICAgICAgICBlbmREYXRlOiBlbmREYXRlID8gbmV3IERhdGUoZW5kRGF0ZSBhcyBzdHJpbmcpIDogdW5kZWZpbmVkLFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogc3RhdGlzdGljcyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ+eNsuWPluaZuuiDvemAmuefpee1seioiOWkseaVlzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiAn542y5Y+W57Wx6KiI6LOH5paZ5aSx5pWXJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLy8g542y5Y+W5pm66IO96YCa55+l6YWN572uXG5yb3V0ZXIuZ2V0KCcvY29uZmlnJyxcbiAgYXV0aCxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuX2lkLnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCBjb25maWcgPSBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UuZ2V0Q29uZmlnKHVzZXJJZCk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogY29uZmlnLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcign542y5Y+W5pm66IO96YCa55+l6YWN572u5aSx5pWXOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6ICfnjbLlj5bphY3nva7lpLHmlZcnLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG4vLyDmm7TmlrDmmbrog73pgJrnn6XphY3nva5cbnJvdXRlci5wdXQoJy9jb25maWcnLFxuICBhdXRoLFxuICBbXG4gICAgYm9keSgnYWlNYXRjaGluZycpLm9wdGlvbmFsKCkuaXNPYmplY3QoKS53aXRoTWVzc2FnZSgnQUkg6YWN5bCN6Kit5a6a5b+F6aCI5piv54mp5Lu2JyksXG4gICAgYm9keSgnYWlNYXRjaGluZy5lbmFibGVkJykub3B0aW9uYWwoKS5pc0Jvb2xlYW4oKS53aXRoTWVzc2FnZSgnQUkg6YWN5bCN5ZWf55So54uA5oWL5b+F6aCI5piv5biD5p6X5YC8JyksXG4gICAgYm9keSgnYWlNYXRjaGluZy5taW5TaW1pbGFyaXR5Jykub3B0aW9uYWwoKS5pc0Zsb2F0KHsgbWluOiAwLCBtYXg6IDEgfSkud2l0aE1lc3NhZ2UoJ+acgOWwj+ebuOS8vOW6puW/hemgiOWcqCAwLTEg5LmL6ZaTJyksXG4gICAgYm9keSgnYWlNYXRjaGluZy5jaGVja0ludGVydmFsJykub3B0aW9uYWwoKS5pc0ludCh7IG1pbjogMSB9KS53aXRoTWVzc2FnZSgn5qqi5p+l6ZaT6ZqU5b+F6aCI5piv5q2j5pW05pW4JyksXG4gICAgYm9keSgnYWlNYXRjaGluZy5tYXhOb3RpZmljYXRpb25zUGVyRGF5Jykub3B0aW9uYWwoKS5pc0ludCh7IG1pbjogMSB9KS53aXRoTWVzc2FnZSgn5q+P5pel5pyA5aSn6YCa55+l5pW45b+F6aCI5piv5q2j5pW05pW4JyksXG4gICAgXG4gICAgYm9keSgnZ2VvZmVuY2luZycpLm9wdGlvbmFsKCkuaXNPYmplY3QoKS53aXRoTWVzc2FnZSgn5Zyw55CG5ZyN5qyE6Kit5a6a5b+F6aCI5piv54mp5Lu2JyksXG4gICAgYm9keSgnZ2VvZmVuY2luZy5lbmFibGVkJykub3B0aW9uYWwoKS5pc0Jvb2xlYW4oKS53aXRoTWVzc2FnZSgn5Zyw55CG5ZyN5qyE5ZWf55So54uA5oWL5b+F6aCI5piv5biD5p6X5YC8JyksXG4gICAgYm9keSgnZ2VvZmVuY2luZy5yYWRpdXMnKS5vcHRpb25hbCgpLmlzRmxvYXQoeyBtaW46IDAuMSB9KS53aXRoTWVzc2FnZSgn5Y2K5b6R5b+F6aCI5aSn5pa8IDAuMScpLFxuICAgIGJvZHkoJ2dlb2ZlbmNpbmcuY2hlY2tJbnRlcnZhbCcpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEgfSkud2l0aE1lc3NhZ2UoJ+aqouafpemWk+malOW/hemgiOaYr+ato+aVtOaVuCcpLFxuICAgIFxuICAgIGJvZHkoJ3JlbWluZGVycycpLm9wdGlvbmFsKCkuaXNPYmplY3QoKS53aXRoTWVzc2FnZSgn5o+Q6YaS6Kit5a6a5b+F6aCI5piv54mp5Lu2JyksXG4gICAgYm9keSgncmVtaW5kZXJzLmVuYWJsZWQnKS5vcHRpb25hbCgpLmlzQm9vbGVhbigpLndpdGhNZXNzYWdlKCfmj5DphpLllZ/nlKjni4DmhYvlv4XpoIjmmK/luIPmnpflgLwnKSxcbiAgICBib2R5KCdyZW1pbmRlcnMudXBkYXRlUmVtaW5kZXInKS5vcHRpb25hbCgpLmlzSW50KHsgbWluOiAxIH0pLndpdGhNZXNzYWdlKCfmm7TmlrDmj5DphpLplpPpmpTlv4XpoIjmmK/mraPmlbTmlbgnKSxcbiAgICBib2R5KCdyZW1pbmRlcnMuc2VhcmNoUmVtaW5kZXInKS5vcHRpb25hbCgpLmlzSW50KHsgbWluOiAxIH0pLndpdGhNZXNzYWdlKCfmkJzlsIvmj5DphpLplpPpmpTlv4XpoIjmmK/mraPmlbTmlbgnKSxcbiAgXSxcbiAgdmFsaWRhdGVSZXF1ZXN0LFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5faWQudG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IGNvbmZpZ1VwZGF0ZSA9IHJlcS5ib2R5O1xuXG4gICAgICBjb25zdCB1cGRhdGVkQ29uZmlnID0gYXdhaXQgU21hcnROb3RpZmljYXRpb25TZXJ2aWNlLnVwZGF0ZUNvbmZpZyh1c2VySWQsIGNvbmZpZ1VwZGF0ZSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogdXBkYXRlZENvbmZpZyxcbiAgICAgICAgbWVzc2FnZTogJ+mFjee9ruabtOaWsOaIkOWKnycsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCfmm7TmlrDmmbrog73pgJrnn6XphY3nva7lpLHmlZc6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ+abtOaWsOmFjee9ruWkseaVlycsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8vIOWJteW7uuWcsOeQhuWcjeashFxucm91dGVyLnBvc3QoJy9nZW9mZW5jZScsXG4gIGF1dGgsXG4gIFtcbiAgICBib2R5KCdwZXRJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCflr7XniakgSUQg5qC85byP54Sh5pWIJyksXG4gICAgYm9keSgnbGF0aXR1ZGUnKS5pc0Zsb2F0KHsgbWluOiAtOTAsIG1heDogOTAgfSkud2l0aE1lc3NhZ2UoJ+e3r+W6puW/hemgiOWcqCAtOTAg5YiwIDkwIOS5i+mWkycpLFxuICAgIGJvZHkoJ2xvbmdpdHVkZScpLmlzRmxvYXQoeyBtaW46IC0xODAsIG1heDogMTgwIH0pLndpdGhNZXNzYWdlKCfntpPluqblv4XpoIjlnKggLTE4MCDliLAgMTgwIOS5i+mWkycpLFxuICAgIGJvZHkoJ3JhZGl1cycpLmlzRmxvYXQoeyBtaW46IDAuMSwgbWF4OiA1MCB9KS53aXRoTWVzc2FnZSgn5Y2K5b6R5b+F6aCI5ZyoIDAuMSDliLAgNTAg5YWs6YeM5LmL6ZaTJyksXG4gICAgYm9keSgnbmFtZScpLm9wdGlvbmFsKCkuaXNTdHJpbmcoKS5pc0xlbmd0aCh7IG1heDogMTAwIH0pLndpdGhNZXNzYWdlKCflkI3nqLHplbfluqbkuI3og73otoXpgY4gMTAwIOWtl+WFgycpLFxuICBdLFxuICB2YWxpZGF0ZVJlcXVlc3QsXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLl9pZC50b1N0cmluZygpO1xuICAgICAgY29uc3QgeyBwZXRJZCwgbGF0aXR1ZGUsIGxvbmdpdHVkZSwgcmFkaXVzLCBuYW1lIH0gPSByZXEuYm9keTtcblxuICAgICAgY29uc3QgZ2VvZmVuY2UgPSBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UuY3JlYXRlR2VvZmVuY2Uoe1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBldElkLFxuICAgICAgICBsYXRpdHVkZSxcbiAgICAgICAgbG9uZ2l0dWRlLFxuICAgICAgICByYWRpdXMsXG4gICAgICAgIG5hbWUsXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogZ2VvZmVuY2UsXG4gICAgICAgIG1lc3NhZ2U6ICflnLDnkIblnI3mrITlibXlu7rmiJDlip8nLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcign5Ym15bu65Zyw55CG5ZyN5qyE5aSx5pWXOicsIGVycm9yKTtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiAn5Ym15bu65Zyw55CG5ZyN5qyE5aSx5pWXJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLy8g56e76Zmk5Zyw55CG5ZyN5qyEXG5yb3V0ZXIuZGVsZXRlKCcvZ2VvZmVuY2UvOmdlb2ZlbmNlSWQnLFxuICBhdXRoLFxuICBbXG4gICAgcGFyYW0oJ2dlb2ZlbmNlSWQnKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZSgn5Zyw55CG5ZyN5qyEIElEIOagvOW8j+eEoeaViCcpLFxuICBdLFxuICB2YWxpZGF0ZVJlcXVlc3QsXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLl9pZC50b1N0cmluZygpO1xuICAgICAgY29uc3QgeyBnZW9mZW5jZUlkIH0gPSByZXEucGFyYW1zO1xuXG4gICAgICBpZiAoIWdlb2ZlbmNlSWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn5Zyw55CG5ZyN5qyEIElEIOeCuuW/heWhq+mgheebricsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UucmVtb3ZlR2VvZmVuY2UodXNlcklkLCBnZW9mZW5jZUlkKTtcblxuICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgbWVzc2FnZTogJ+WcsOeQhuWcjeashOenu+mZpOaIkOWKnycsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCfnp7vpmaTlnLDnkIblnI3mrITlpLHmlZc6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6ICfnp7vpmaTlnLDnkIblnI3mrITlpLHmlZcnLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG4vLyDnjbLlj5bnlKjmiLbnmoTlnLDnkIblnI3mrITliJfooahcbnJvdXRlci5nZXQoJy9nZW9mZW5jZXMnLFxuICBhdXRoLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5faWQudG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IGdlb2ZlbmNlcyA9IGF3YWl0IFNtYXJ0Tm90aWZpY2F0aW9uU2VydmljZS5nZXRVc2VyR2VvZmVuY2VzKHVzZXJJZCk7XG5cbiAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IGdlb2ZlbmNlcyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ+eNsuWPluWcsOeQhuWcjeashOWIl+ihqOWkseaVlzonLCBlcnJvcik7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ+eNsuWPluWcsOeQhuWcjeashOWIl+ihqOWkseaVlycsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8vIOaJi+WLleinuOeZvCBBSSDphY3lsI3mqqLmn6VcbnJvdXRlci5wb3N0KCcvdHJpZ2dlci1haS1tYXRjaGluZycsXG4gIGF1dGgsXG4gIFtcbiAgICBib2R5KCdwZXRJZCcpLm9wdGlvbmFsKCkuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+WvteeJqSBJRCDmoLzlvI/nhKHmlYgnKSxcbiAgXSxcbiAgdmFsaWRhdGVSZXF1ZXN0LFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5faWQudG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IHsgcGV0SWQgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBTbWFydE5vdGlmaWNhdGlvblNlcnZpY2UudHJpZ2dlckFJTWF0Y2hpbmcodXNlcklkLCBwZXRJZCk7XG5cbiAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHJlc3VsdCxcbiAgICAgICAgbWVzc2FnZTogJ0FJIOmFjeWwjeaqouafpeW3suinuOeZvCcsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCfop7jnmbwgQUkg6YWN5bCN5qqi5p+l5aSx5pWXOicsIGVycm9yKTtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiAn6Ke455m8IEFJIOmFjeWwjeaqouafpeWkseaVlycsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8vIOa4rOippuaZuuiDvemAmuefpe+8iOWDhemWi+eZvOeSsOWig++8iVxucm91dGVyLnBvc3QoJy90ZXN0JyxcbiAgYXV0aCxcbiAgW1xuICAgIGJvZHkoJ3R5cGUnKS5pc0luKFsnYWlfbWF0Y2hpbmcnLCAnZ2VvZmVuY2luZycsICdyZW1pbmRlciddKS53aXRoTWVzc2FnZSgn6YCa55+l6aGe5Z6L54Sh5pWIJyksXG4gICAgYm9keSgncGV0SWQnKS5vcHRpb25hbCgpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCflr7XniakgSUQg5qC85byP54Sh5pWIJyksXG4gIF0sXG4gIHZhbGlkYXRlUmVxdWVzdCxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyDlg4XlnKjpnZ7nlJ/nlKLnkrDlooPlhYHoqLHmuKzoqaZcbiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogJ+eUn+eUoueSsOWig+S4jeWFgeiosea4rOippuWKn+iDvScsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuX2lkLnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCB7IHR5cGUsIHBldElkIH0gPSByZXEuYm9keTtcblxuICAgICAgbGV0IHJlc3VsdDtcbiAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICBjYXNlICdhaV9tYXRjaGluZyc6XG4gICAgICAgICAgcmVzdWx0ID0gYXdhaXQgU21hcnROb3RpZmljYXRpb25TZXJ2aWNlLnRyaWdnZXJBSU1hdGNoaW5nKHVzZXJJZCwgcGV0SWQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdnZW9mZW5jaW5nJzpcbiAgICAgICAgICAvLyDmqKHmk6zlnLDnkIblnI3mrITop7jnmbxcbiAgICAgICAgICByZXN1bHQgPSB7IG1lc3NhZ2U6ICflnLDnkIblnI3mrITmuKzoqabpgJrnn6Xlt7LnmbzpgIEnIH07XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3JlbWluZGVyJzpcbiAgICAgICAgICAvLyDmqKHmk6zmj5DphpLpgJrnn6VcbiAgICAgICAgICByZXN1bHQgPSB7IG1lc3NhZ2U6ICfmj5DphpLmuKzoqabpgJrnn6Xlt7LnmbzpgIEnIH07XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgbWVzc2FnZTogJ+S4jeaUr+aPtOeahOa4rOippumhnuWeiycsXG4gICAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHJlc3VsdCxcbiAgICAgICAgbWVzc2FnZTogYCR7dHlwZX0g5ris6Kmm6YCa55+l5bey55m86YCBYCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ+eZvOmAgea4rOippumAmuefpeWkseaVlzonLCBlcnJvcik7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ+eZvOmAgea4rOippumAmuefpeWkseaVlycsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbmV4cG9ydCB7IHJvdXRlciBhcyBzbWFydE5vdGlmaWNhdGlvblJvdXRlcyB9OyJdLCJ2ZXJzaW9uIjozfQ==