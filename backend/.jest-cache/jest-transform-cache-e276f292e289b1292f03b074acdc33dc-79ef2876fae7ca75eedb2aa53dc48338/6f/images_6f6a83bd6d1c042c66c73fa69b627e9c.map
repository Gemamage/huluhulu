{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\images.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\images.ts"],"sourcesContent":["import { Router } from 'express';\nimport { asyncHandler } from '../../middleware/error-handler';\nimport { ValidationError, NotFoundError, ForbiddenError } from '../../utils/errors';\nimport { logger } from '../../utils/logger';\nimport { \n  createCacheInvalidationMiddleware\n} from '../../middleware/cacheMiddleware';\nimport { Pet } from '../../models/Pet';\nimport { authenticate } from '../../middleware/auth';\nimport { requireActiveAccount, hasPermission, Permission } from '../../middleware/rbac';\nimport mongoose from 'mongoose';\n\nconst router = Router();\n\n/**\n * @route   POST /api/pets/:id/images\n * @desc    上傳寵物圖片\n * @access  Private\n */\nrouter.post('/:id/images', \n  authenticate, \n  requireActiveAccount,\n  createCacheInvalidationMiddleware({\n    patterns: ['pets:*'] // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n  const { id } = req.params;\n  const userId = req.user!.id;\n\n  if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n    throw new ValidationError('請提供有效的寵物 ID');\n  }\n\n  logger.info('上傳寵物圖片請求', { petId: id, userId });\n\n  // 查找寵物並檢查權限\n  const pet = await Pet.findById(id);\n  if (!pet) {\n    throw new NotFoundError('找不到指定的寵物資訊');\n  }\n\n  // 檢查是否為寵物擁有者或管理員\n  if (pet.userId.toString() !== userId && !hasPermission(req.user!, Permission.PET_WRITE)) {\n    throw new ForbiddenError('您沒有權限上傳此寵物的圖片');\n  }\n\n  // TODO: 實作圖片上傳邏輯\n  // 1. 驗證圖片格式和大小\n  // 2. 上傳到雲端儲存服務（如 AWS S3、Cloudinary 等）\n  // 3. 更新寵物資料中的圖片 URL\n  // 4. 可能需要生成縮圖\n  \n  res.json({\n    success: true,\n    message: '圖片上傳功能尚未實作',\n    data: {\n      petId: id,\n      // imageUrls: [] // 上傳成功後的圖片 URL 陣列\n    },\n  });\n}));\n\n/**\n * @route   DELETE /api/pets/:id/images/:imageId\n * @desc    刪除寵物圖片\n * @access  Private\n */\nrouter.delete('/:id/images/:imageId', \n  authenticate, \n  requireActiveAccount,\n  createCacheInvalidationMiddleware({\n    patterns: ['pets:*'] // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n  const { id, imageId } = req.params;\n  const userId = req.user!.id;\n\n  if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n    throw new ValidationError('請提供有效的寵物 ID');\n  }\n\n  logger.info('刪除寵物圖片請求', { petId: id, imageId, userId });\n\n  // 查找寵物並檢查權限\n  const pet = await Pet.findById(id);\n  if (!pet) {\n    throw new NotFoundError('找不到指定的寵物資訊');\n  }\n\n  // 檢查是否為寵物擁有者或管理員\n  if (pet.userId.toString() !== userId && !hasPermission(req.user!, Permission.PET_WRITE)) {\n    throw new ForbiddenError('您沒有權限刪除此寵物的圖片');\n  }\n\n  // TODO: 實作圖片刪除邏輯\n  // 1. 從雲端儲存服務刪除圖片\n  // 2. 從寵物資料中移除圖片 URL\n  \n  res.json({\n    success: true,\n    message: '圖片刪除功能尚未實作',\n    data: {\n      petId: id,\n      imageId\n    },\n  });\n}));\n\nexport default router;"],"version":3}