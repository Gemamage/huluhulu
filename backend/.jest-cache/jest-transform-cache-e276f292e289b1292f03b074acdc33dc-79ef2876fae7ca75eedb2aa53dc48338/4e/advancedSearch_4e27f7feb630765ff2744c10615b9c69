a30f3f889463f4a08693396b69ad2453
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const petSearchService_1 = require("../services/petSearchService");
const elasticsearchService_1 = require("../services/elasticsearchService");
const mockElasticsearchService_1 = require("../services/mockElasticsearchService");
const auth_1 = require("../middleware/auth");
const logger_1 = require("../utils/logger");
const express_rate_limit_1 = __importDefault(require("express-rate-limit"));
const router = express_1.default.Router();
// 檢測是否使用模擬服務
const USE_MOCK_ELASTICSEARCH = process.env.NODE_ENV === "development" && !process.env.ELASTICSEARCH_URL;
// 搜尋頻率限制
const searchLimiter = (0, express_rate_limit_1.default)({
    windowMs: 1 * 60 * 1000, // 1分鐘
    max: 30, // 每分鐘最多30次搜尋
    message: {
        error: "搜尋頻率過高，請稍後再試",
        code: "RATE_LIMIT_EXCEEDED",
    },
    standardHeaders: true,
    legacyHeaders: false,
});
// 建議搜尋頻率限制
const suggestionLimiter = (0, express_rate_limit_1.default)({
    windowMs: 1 * 60 * 1000, // 1分鐘
    max: 60, // 每分鐘最多60次建議請求
    message: {
        error: "建議請求頻率過高，請稍後再試",
        code: "RATE_LIMIT_EXCEEDED",
    },
    standardHeaders: true,
    legacyHeaders: false,
});
/**
 * @route POST /api/advanced-search/pets
 * @desc 進階寵物搜尋
 * @access Public
 */
router.post("/pets", searchLimiter, async (req, res) => {
    try {
        const { query = "", type, status, breed, location, size, gender, color, page = 1, limit = 12, sortBy = "createdAt", sortOrder = "desc", fuzzy = false, radius = 10, coordinates, } = req.body;
        // 驗證參數
        if (page < 1 || limit < 1 || limit > 50) {
            return res.status(400).json({
                error: "無效的分頁參數",
                code: "INVALID_PAGINATION",
            });
        }
        if (radius && (radius < 1 || radius > 100)) {
            return res.status(400).json({
                error: "搜尋半徑必須在 1-100 公里之間",
                code: "INVALID_RADIUS",
            });
        }
        const searchQuery = {
            query: query.trim(),
            type,
            status,
            breed,
            location,
            size,
            gender,
            color,
            page,
            limit,
            sortBy,
            sortOrder,
            fuzzy,
            radius,
            coordinates,
        };
        let searchResult;
        let searchTime;
        const startTime = Date.now();
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            searchResult = await mockElasticsearchService_1.mockElasticsearchService.searchPets(searchQuery);
            searchTime = Date.now() - startTime;
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                logger_1.logger.warn("Elasticsearch 未連接，使用基礎搜尋");
                return res.status(503).json({
                    error: "搜尋服務暫時不可用，請稍後再試",
                    code: "SEARCH_SERVICE_UNAVAILABLE",
                });
            }
            // 執行搜尋
            searchResult = await petSearchService_1.petSearchService.searchPets(searchQuery);
            searchTime = Date.now() - startTime;
            // 記錄搜尋分析
            const userId = req.user?.id;
            const sessionId = req.sessionID;
            const userAgent = req.get("User-Agent");
            const ipAddress = req.ip;
            await petSearchService_1.petSearchService.recordSearchAnalytics(query, { type, status, breed, location, size, gender, color }, userId, searchResult.total, sessionId, userAgent, ipAddress);
        }
        // 回傳結果
        res.json({
            success: true,
            data: {
                pets: searchResult.hits.map((hit) => ({
                    id: hit.id,
                    ...hit.source,
                    highlights: hit.highlights,
                    relevanceScore: hit.score,
                })),
                pagination: {
                    page,
                    limit,
                    total: searchResult.total,
                    totalPages: Math.ceil(searchResult.total / limit),
                    hasNext: page * limit < searchResult.total,
                    hasPrev: page > 1,
                },
                searchInfo: {
                    query: query.trim(),
                    filters: { type, status, breed, location, size, gender, color },
                    fuzzy,
                    searchTime,
                    maxScore: searchResult.maxScore,
                },
            },
            mock: USE_MOCK_ELASTICSEARCH,
        });
    }
    catch (error) {
        logger_1.logger.error("進階搜尋失敗:", error);
        res.status(500).json({
            error: "搜尋失敗，請稍後再試",
            code: "SEARCH_ERROR",
        });
    }
});
/**
 * @route GET /api/advanced-search/suggestions
 * @desc 獲取搜尋建議
 * @access Public
 */
router.get("/suggestions", suggestionLimiter, async (req, res) => {
    try {
        const { q: query, limit = 5 } = req.query;
        if (!query || typeof query !== "string") {
            return res.status(400).json({
                error: "請提供搜尋關鍵字",
                code: "MISSING_QUERY",
            });
        }
        if (query.length < 1) {
            return res.json({
                success: true,
                data: {
                    suggestions: [],
                },
            });
        }
        const limitNum = Math.min(parseInt(limit) || 5, 10);
        let suggestions;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            suggestions = await mockElasticsearchService_1.mockElasticsearchService.getSearchSuggestions(query, limitNum);
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                return res.json({
                    success: true,
                    data: {
                        suggestions: [],
                    },
                });
            }
            suggestions = await petSearchService_1.petSearchService.getSearchSuggestions(query, limitNum);
        }
        res.json({
            success: true,
            data: {
                suggestions: suggestions.map((suggestion) => ({
                    text: suggestion.text,
                    type: suggestion.type,
                    score: suggestion.score,
                })),
            },
            mock: USE_MOCK_ELASTICSEARCH,
        });
    }
    catch (error) {
        logger_1.logger.error("獲取搜尋建議失敗:", error);
        res.status(500).json({
            error: "獲取建議失敗",
            code: "SUGGESTION_ERROR",
        });
    }
});
/**
 * @route GET /api/advanced-search/analytics
 * @desc 獲取搜尋分析數據
 * @access Private (Admin)
 */
router.get("/analytics", auth_1.auth, async (req, res) => {
    try {
        // 檢查管理員權限
        if (req.user?.role !== "admin") {
            return res.status(403).json({
                error: "權限不足",
                code: "INSUFFICIENT_PERMISSIONS",
            });
        }
        const { days = 30 } = req.query;
        const daysNum = Math.min(parseInt(days) || 30, 365);
        let analytics;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            analytics = await mockElasticsearchService_1.mockElasticsearchService.getSearchAnalytics(daysNum);
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                return res.status(503).json({
                    error: "分析服務暫時不可用",
                    code: "ANALYTICS_SERVICE_UNAVAILABLE",
                });
            }
            analytics = await petSearchService_1.petSearchService.getSearchAnalytics(daysNum);
        }
        res.json({
            success: true,
            data: {
                analytics,
                period: {
                    days: daysNum,
                    from: new Date(Date.now() - daysNum * 24 * 60 * 60 * 1000).toISOString(),
                    to: new Date().toISOString(),
                },
            },
            mock: USE_MOCK_ELASTICSEARCH,
        });
    }
    catch (error) {
        logger_1.logger.error("獲取搜尋分析失敗:", error);
        res.status(500).json({
            error: "獲取分析數據失敗",
            code: "ANALYTICS_ERROR",
        });
    }
});
/**
 * @route GET /api/advanced-search/health
 * @desc 檢查搜尋服務健康狀態
 * @access Public
 */
router.get("/health", async (req, res) => {
    try {
        let isConnected, metrics;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            isConnected = await mockElasticsearchService_1.mockElasticsearchService.checkConnection();
            metrics = mockElasticsearchService_1.mockElasticsearchService.getPerformanceMetrics();
        }
        else {
            // 使用真實 Elasticsearch 服務
            isConnected = await elasticsearchService_1.elasticsearchService.checkConnection();
            metrics = elasticsearchService_1.elasticsearchService.getPerformanceMetrics();
        }
        res.json({
            success: true,
            data: {
                elasticsearch: {
                    connected: isConnected,
                    status: isConnected ? "healthy" : "disconnected",
                    mock: USE_MOCK_ELASTICSEARCH,
                },
                performance: {
                    totalQueries: metrics.totalQueries,
                    averageResponseTime: Math.round(metrics.averageResponseTime),
                    slowQueries: metrics.slowQueries,
                    errorRate: Math.round(metrics.errorRate * 100) / 100,
                    lastUpdated: metrics.lastUpdated,
                },
                features: {
                    advancedSearch: isConnected,
                    fuzzySearch: isConnected,
                    suggestions: isConnected,
                    analytics: isConnected,
                    geoSearch: isConnected,
                },
            },
        });
    }
    catch (error) {
        logger_1.logger.error("檢查搜尋服務健康狀態失敗:", error);
        res.status(500).json({
            error: "健康檢查失敗",
            code: "HEALTH_CHECK_ERROR",
        });
    }
});
/**
 * @route POST /api/advanced-search/reindex
 * @desc 重新索引所有寵物數據
 * @access Private (Admin)
 */
router.post("/reindex", auth_1.auth, async (req, res) => {
    try {
        // 檢查管理員權限
        if (req.user?.role !== "admin") {
            return res.status(403).json({
                error: "權限不足",
                code: "INSUFFICIENT_PERMISSIONS",
            });
        }
        let result;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            result = await mockElasticsearchService_1.mockElasticsearchService.reindexAllPets();
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                return res.status(503).json({
                    error: "搜尋服務暫時不可用",
                    code: "SEARCH_SERVICE_UNAVAILABLE",
                });
            }
            // 使用真實 Elasticsearch 服務
            result = await petSearchService_1.petSearchService.reindexAllPets();
        }
        logger_1.logger.info("重新索引寵物數據完成");
        res.json({
            success: true,
            message: "重新索引任務已完成",
            data: {
                ...result,
                mock: USE_MOCK_ELASTICSEARCH,
            },
        });
    }
    catch (error) {
        logger_1.logger.error("重新索引失敗:", error);
        res.status(500).json({
            error: "重新索引失敗",
            code: "REINDEX_ERROR",
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcYWR2YW5jZWRTZWFyY2gudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxzREFBOEI7QUFFOUIsbUVBQWdGO0FBQ2hGLDJFQUF3RTtBQUN4RSxtRkFBZ0Y7QUFDaEYsNkNBQTBDO0FBQzFDLDRDQUF5QztBQUN6Qyw0RUFBMkM7QUFFM0MsTUFBTSxNQUFNLEdBQUcsaUJBQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVoQyxhQUFhO0FBQ2IsTUFBTSxzQkFBc0IsR0FDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQztBQUUzRSxTQUFTO0FBQ1QsTUFBTSxhQUFhLEdBQUcsSUFBQSw0QkFBUyxFQUFDO0lBQzlCLFFBQVEsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxNQUFNO0lBQy9CLEdBQUcsRUFBRSxFQUFFLEVBQUUsYUFBYTtJQUN0QixPQUFPLEVBQUU7UUFDUCxLQUFLLEVBQUUsY0FBYztRQUNyQixJQUFJLEVBQUUscUJBQXFCO0tBQzVCO0lBQ0QsZUFBZSxFQUFFLElBQUk7SUFDckIsYUFBYSxFQUFFLEtBQUs7Q0FDckIsQ0FBQyxDQUFDO0FBRUgsV0FBVztBQUNYLE1BQU0saUJBQWlCLEdBQUcsSUFBQSw0QkFBUyxFQUFDO0lBQ2xDLFFBQVEsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxNQUFNO0lBQy9CLEdBQUcsRUFBRSxFQUFFLEVBQUUsZUFBZTtJQUN4QixPQUFPLEVBQUU7UUFDUCxLQUFLLEVBQUUsZ0JBQWdCO1FBQ3ZCLElBQUksRUFBRSxxQkFBcUI7S0FDNUI7SUFDRCxlQUFlLEVBQUUsSUFBSTtJQUNyQixhQUFhLEVBQUUsS0FBSztDQUNyQixDQUFDLENBQUM7QUFFSDs7OztHQUlHO0FBQ0gs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QztRQUMvQixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixLQUFLLEVBQUUsUUFBUTtZQUNmLElBQUksRUFBRSxlQUFlO1NBQ3RCLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGtCQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccm91dGVzXFxhZHZhbmNlZFNlYXJjaC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0IHsgcGV0U2VhcmNoU2VydmljZSwgUGV0U2VhcmNoUXVlcnkgfSBmcm9tIFwiLi4vc2VydmljZXMvcGV0U2VhcmNoU2VydmljZVwiO1xuaW1wb3J0IHsgZWxhc3RpY3NlYXJjaFNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvZWxhc3RpY3NlYXJjaFNlcnZpY2VcIjtcbmltcG9ydCB7IG1vY2tFbGFzdGljc2VhcmNoU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9tb2NrRWxhc3RpY3NlYXJjaFNlcnZpY2VcIjtcbmltcG9ydCB7IGF1dGggfSBmcm9tIFwiLi4vbWlkZGxld2FyZS9hdXRoXCI7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwiLi4vdXRpbHMvbG9nZ2VyXCI7XG5pbXBvcnQgcmF0ZUxpbWl0IGZyb20gXCJleHByZXNzLXJhdGUtbGltaXRcIjtcblxuY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcblxuLy8g5qqi5ris5piv5ZCm5L2/55So5qih5pOs5pyN5YuZXG5jb25zdCBVU0VfTU9DS19FTEFTVElDU0VBUkNIID1cbiAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09IFwiZGV2ZWxvcG1lbnRcIiAmJiAhcHJvY2Vzcy5lbnYuRUxBU1RJQ1NFQVJDSF9VUkw7XG5cbi8vIOaQnOWwi+mgu+eOh+mZkOWItlxuY29uc3Qgc2VhcmNoTGltaXRlciA9IHJhdGVMaW1pdCh7XG4gIHdpbmRvd01zOiAxICogNjAgKiAxMDAwLCAvLyAx5YiG6ZCYXG4gIG1heDogMzAsIC8vIOavj+WIhumQmOacgOWkmjMw5qyh5pCc5bCLXG4gIG1lc3NhZ2U6IHtcbiAgICBlcnJvcjogXCLmkJzlsIvpoLvnjofpgY7pq5jvvIzoq4vnqI3lvozlho3oqaZcIixcbiAgICBjb2RlOiBcIlJBVEVfTElNSVRfRVhDRUVERURcIixcbiAgfSxcbiAgc3RhbmRhcmRIZWFkZXJzOiB0cnVlLFxuICBsZWdhY3lIZWFkZXJzOiBmYWxzZSxcbn0pO1xuXG4vLyDlu7rorbDmkJzlsIvpoLvnjofpmZDliLZcbmNvbnN0IHN1Z2dlc3Rpb25MaW1pdGVyID0gcmF0ZUxpbWl0KHtcbiAgd2luZG93TXM6IDEgKiA2MCAqIDEwMDAsIC8vIDHliIbpkJhcbiAgbWF4OiA2MCwgLy8g5q+P5YiG6ZCY5pyA5aSaNjDmrKHlu7rorbDoq4vmsYJcbiAgbWVzc2FnZToge1xuICAgIGVycm9yOiBcIuW7uuitsOiri+axgumgu+eOh+mBjumrmO+8jOiri+eojeW+jOWGjeipplwiLFxuICAgIGNvZGU6IFwiUkFURV9MSU1JVF9FWENFRURFRFwiLFxuICB9LFxuICBzdGFuZGFyZEhlYWRlcnM6IHRydWUsXG4gIGxlZ2FjeUhlYWRlcnM6IGZhbHNlLFxufSk7XG5cbi8qKlxuICogQHJvdXRlIFBPU1QgL2FwaS9hZHZhbmNlZC1zZWFyY2gvcGV0c1xuICogQGRlc2Mg6YCy6ZqO5a+154mp5pCc5bCLXG4gKiBAYWNjZXNzIFB1YmxpY1xuICovXG5yb3V0ZXIucG9zdChcIi9wZXRzXCIsIHNlYXJjaExpbWl0ZXIsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7XG4gICAgICBxdWVyeSA9IFwiXCIsXG4gICAgICB0eXBlLFxuICAgICAgc3RhdHVzLFxuICAgICAgYnJlZWQsXG4gICAgICBsb2NhdGlvbixcbiAgICAgIHNpemUsXG4gICAgICBnZW5kZXIsXG4gICAgICBjb2xvcixcbiAgICAgIHBhZ2UgPSAxLFxuICAgICAgbGltaXQgPSAxMixcbiAgICAgIHNvcnRCeSA9IFwiY3JlYXRlZEF0XCIsXG4gICAgICBzb3J0T3JkZXIgPSBcImRlc2NcIixcbiAgICAgIGZ1enp5ID0gZmFsc2UsXG4gICAgICByYWRpdXMgPSAxMCxcbiAgICAgIGNvb3JkaW5hdGVzLFxuICAgIH0gPSByZXEuYm9keSBhcyBQZXRTZWFyY2hRdWVyeTtcblxuICAgIC8vIOmpl+itieWPg+aVuFxuICAgIGlmIChwYWdlIDwgMSB8fCBsaW1pdCA8IDEgfHwgbGltaXQgPiA1MCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6IFwi54Sh5pWI55qE5YiG6aCB5Y+D5pW4XCIsXG4gICAgICAgIGNvZGU6IFwiSU5WQUxJRF9QQUdJTkFUSU9OXCIsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAocmFkaXVzICYmIChyYWRpdXMgPCAxIHx8IHJhZGl1cyA+IDEwMCkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiBcIuaQnOWwi+WNiuW+keW/hemgiOWcqCAxLTEwMCDlhazph4zkuYvplpNcIixcbiAgICAgICAgY29kZTogXCJJTlZBTElEX1JBRElVU1wiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2VhcmNoUXVlcnk6IFBldFNlYXJjaFF1ZXJ5ID0ge1xuICAgICAgcXVlcnk6IHF1ZXJ5LnRyaW0oKSxcbiAgICAgIHR5cGUsXG4gICAgICBzdGF0dXMsXG4gICAgICBicmVlZCxcbiAgICAgIGxvY2F0aW9uLFxuICAgICAgc2l6ZSxcbiAgICAgIGdlbmRlcixcbiAgICAgIGNvbG9yLFxuICAgICAgcGFnZSxcbiAgICAgIGxpbWl0LFxuICAgICAgc29ydEJ5LFxuICAgICAgc29ydE9yZGVyLFxuICAgICAgZnV6enksXG4gICAgICByYWRpdXMsXG4gICAgICBjb29yZGluYXRlcyxcbiAgICB9O1xuXG4gICAgbGV0IHNlYXJjaFJlc3VsdDtcbiAgICBsZXQgc2VhcmNoVGltZTtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgaWYgKFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0gpIHtcbiAgICAgIC8vIOS9v+eUqOaooeaTrOacjeWLmVxuICAgICAgc2VhcmNoUmVzdWx0ID0gYXdhaXQgbW9ja0VsYXN0aWNzZWFyY2hTZXJ2aWNlLnNlYXJjaFBldHMoc2VhcmNoUXVlcnkpO1xuICAgICAgc2VhcmNoVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOaqouafpSBFbGFzdGljc2VhcmNoIOmAo+aOpVxuICAgICAgaWYgKCFlbGFzdGljc2VhcmNoU2VydmljZS5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKFwiRWxhc3RpY3NlYXJjaCDmnKrpgKPmjqXvvIzkvb/nlKjln7rnpI7mkJzlsItcIik7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMykuanNvbih7XG4gICAgICAgICAgZXJyb3I6IFwi5pCc5bCL5pyN5YuZ5pqr5pmC5LiN5Y+v55So77yM6KuL56iN5b6M5YaN6KmmXCIsXG4gICAgICAgICAgY29kZTogXCJTRUFSQ0hfU0VSVklDRV9VTkFWQUlMQUJMRVwiLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8g5Z+36KGM5pCc5bCLXG4gICAgICBzZWFyY2hSZXN1bHQgPSBhd2FpdCBwZXRTZWFyY2hTZXJ2aWNlLnNlYXJjaFBldHMoc2VhcmNoUXVlcnkpO1xuICAgICAgc2VhcmNoVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIC8vIOiomOmMhOaQnOWwi+WIhuaekFxuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkO1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gcmVxLnNlc3Npb25JRDtcbiAgICAgIGNvbnN0IHVzZXJBZ2VudCA9IHJlcS5nZXQoXCJVc2VyLUFnZW50XCIpO1xuICAgICAgY29uc3QgaXBBZGRyZXNzID0gcmVxLmlwO1xuXG4gICAgICBhd2FpdCBwZXRTZWFyY2hTZXJ2aWNlLnJlY29yZFNlYXJjaEFuYWx5dGljcyhcbiAgICAgICAgcXVlcnksXG4gICAgICAgIHsgdHlwZSwgc3RhdHVzLCBicmVlZCwgbG9jYXRpb24sIHNpemUsIGdlbmRlciwgY29sb3IgfSxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBzZWFyY2hSZXN1bHQudG90YWwsXG4gICAgICAgIHNlc3Npb25JZCxcbiAgICAgICAgdXNlckFnZW50LFxuICAgICAgICBpcEFkZHJlc3MsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIOWbnuWCs+e1kOaenFxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHBldHM6IHNlYXJjaFJlc3VsdC5oaXRzLm1hcCgoaGl0KSA9PiAoe1xuICAgICAgICAgIGlkOiBoaXQuaWQsXG4gICAgICAgICAgLi4uaGl0LnNvdXJjZSxcbiAgICAgICAgICBoaWdobGlnaHRzOiBoaXQuaGlnaGxpZ2h0cyxcbiAgICAgICAgICByZWxldmFuY2VTY29yZTogaGl0LnNjb3JlLFxuICAgICAgICB9KSksXG4gICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICBwYWdlLFxuICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgIHRvdGFsOiBzZWFyY2hSZXN1bHQudG90YWwsXG4gICAgICAgICAgdG90YWxQYWdlczogTWF0aC5jZWlsKHNlYXJjaFJlc3VsdC50b3RhbCAvIGxpbWl0KSxcbiAgICAgICAgICBoYXNOZXh0OiBwYWdlICogbGltaXQgPCBzZWFyY2hSZXN1bHQudG90YWwsXG4gICAgICAgICAgaGFzUHJldjogcGFnZSA+IDEsXG4gICAgICAgIH0sXG4gICAgICAgIHNlYXJjaEluZm86IHtcbiAgICAgICAgICBxdWVyeTogcXVlcnkudHJpbSgpLFxuICAgICAgICAgIGZpbHRlcnM6IHsgdHlwZSwgc3RhdHVzLCBicmVlZCwgbG9jYXRpb24sIHNpemUsIGdlbmRlciwgY29sb3IgfSxcbiAgICAgICAgICBmdXp6eSxcbiAgICAgICAgICBzZWFyY2hUaW1lLFxuICAgICAgICAgIG1heFNjb3JlOiBzZWFyY2hSZXN1bHQubWF4U2NvcmUsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgbW9jazogVVNFX01PQ0tfRUxBU1RJQ1NFQVJDSCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCLpgLLpmo7mkJzlsIvlpLHmlZc6XCIsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBlcnJvcjogXCLmkJzlsIvlpLHmlZfvvIzoq4vnqI3lvozlho3oqaZcIixcbiAgICAgIGNvZGU6IFwiU0VBUkNIX0VSUk9SXCIsXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEByb3V0ZSBHRVQgL2FwaS9hZHZhbmNlZC1zZWFyY2gvc3VnZ2VzdGlvbnNcbiAqIEBkZXNjIOeNsuWPluaQnOWwi+W7uuitsFxuICogQGFjY2VzcyBQdWJsaWNcbiAqL1xucm91dGVyLmdldChcbiAgXCIvc3VnZ2VzdGlvbnNcIixcbiAgc3VnZ2VzdGlvbkxpbWl0ZXIsXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBxOiBxdWVyeSwgbGltaXQgPSA1IH0gPSByZXEucXVlcnk7XG5cbiAgICAgIGlmICghcXVlcnkgfHwgdHlwZW9mIHF1ZXJ5ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6IFwi6KuL5o+Q5L6b5pCc5bCL6Zec6Y215a2XXCIsXG4gICAgICAgICAgY29kZTogXCJNSVNTSU5HX1FVRVJZXCIsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAocXVlcnkubGVuZ3RoIDwgMSkge1xuICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IFtdLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBsaW1pdE51bSA9IE1hdGgubWluKHBhcnNlSW50KGxpbWl0IGFzIHN0cmluZykgfHwgNSwgMTApO1xuXG4gICAgICBsZXQgc3VnZ2VzdGlvbnM7XG5cbiAgICAgIGlmIChVU0VfTU9DS19FTEFTVElDU0VBUkNIKSB7XG4gICAgICAgIC8vIOS9v+eUqOaooeaTrOacjeWLmVxuICAgICAgICBzdWdnZXN0aW9ucyA9IGF3YWl0IG1vY2tFbGFzdGljc2VhcmNoU2VydmljZS5nZXRTZWFyY2hTdWdnZXN0aW9ucyhcbiAgICAgICAgICBxdWVyeSxcbiAgICAgICAgICBsaW1pdE51bSxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIOaqouafpSBFbGFzdGljc2VhcmNoIOmAo+aOpVxuICAgICAgICBpZiAoIWVsYXN0aWNzZWFyY2hTZXJ2aWNlLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IFtdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN1Z2dlc3Rpb25zID0gYXdhaXQgcGV0U2VhcmNoU2VydmljZS5nZXRTZWFyY2hTdWdnZXN0aW9ucyhcbiAgICAgICAgICBxdWVyeSxcbiAgICAgICAgICBsaW1pdE51bSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgc3VnZ2VzdGlvbnM6IHN1Z2dlc3Rpb25zLm1hcCgoc3VnZ2VzdGlvbikgPT4gKHtcbiAgICAgICAgICAgIHRleHQ6IHN1Z2dlc3Rpb24udGV4dCxcbiAgICAgICAgICAgIHR5cGU6IHN1Z2dlc3Rpb24udHlwZSxcbiAgICAgICAgICAgIHNjb3JlOiBzdWdnZXN0aW9uLnNjb3JlLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgfSxcbiAgICAgICAgbW9jazogVVNFX01PQ0tfRUxBU1RJQ1NFQVJDSCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCLnjbLlj5bmkJzlsIvlu7rorbDlpLHmlZc6XCIsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6IFwi542y5Y+W5bu66K2w5aSx5pWXXCIsXG4gICAgICAgIGNvZGU6IFwiU1VHR0VTVElPTl9FUlJPUlwiLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuKTtcblxuLyoqXG4gKiBAcm91dGUgR0VUIC9hcGkvYWR2YW5jZWQtc2VhcmNoL2FuYWx5dGljc1xuICogQGRlc2Mg542y5Y+W5pCc5bCL5YiG5p6Q5pW45pOaXG4gKiBAYWNjZXNzIFByaXZhdGUgKEFkbWluKVxuICovXG5yb3V0ZXIuZ2V0KFwiL2FuYWx5dGljc1wiLCBhdXRoLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8g5qqi5p+l566h55CG5ZOh5qyK6ZmQXG4gICAgaWYgKHJlcS51c2VyPy5yb2xlICE9PSBcImFkbWluXCIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgIGVycm9yOiBcIuasiumZkOS4jei2s1wiLFxuICAgICAgICBjb2RlOiBcIklOU1VGRklDSUVOVF9QRVJNSVNTSU9OU1wiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBkYXlzID0gMzAgfSA9IHJlcS5xdWVyeTtcbiAgICBjb25zdCBkYXlzTnVtID0gTWF0aC5taW4ocGFyc2VJbnQoZGF5cyBhcyBzdHJpbmcpIHx8IDMwLCAzNjUpO1xuXG4gICAgbGV0IGFuYWx5dGljcztcblxuICAgIGlmIChVU0VfTU9DS19FTEFTVElDU0VBUkNIKSB7XG4gICAgICAvLyDkvb/nlKjmqKHmk6zmnI3li5lcbiAgICAgIGFuYWx5dGljcyA9IGF3YWl0IG1vY2tFbGFzdGljc2VhcmNoU2VydmljZS5nZXRTZWFyY2hBbmFseXRpY3MoZGF5c051bSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOaqouafpSBFbGFzdGljc2VhcmNoIOmAo+aOpVxuICAgICAgaWYgKCFlbGFzdGljc2VhcmNoU2VydmljZS5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMykuanNvbih7XG4gICAgICAgICAgZXJyb3I6IFwi5YiG5p6Q5pyN5YuZ5pqr5pmC5LiN5Y+v55SoXCIsXG4gICAgICAgICAgY29kZTogXCJBTkFMWVRJQ1NfU0VSVklDRV9VTkFWQUlMQUJMRVwiLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgYW5hbHl0aWNzID0gYXdhaXQgcGV0U2VhcmNoU2VydmljZS5nZXRTZWFyY2hBbmFseXRpY3MoZGF5c051bSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgYW5hbHl0aWNzLFxuICAgICAgICBwZXJpb2Q6IHtcbiAgICAgICAgICBkYXlzOiBkYXlzTnVtLFxuICAgICAgICAgIGZyb206IG5ldyBEYXRlKFxuICAgICAgICAgICAgRGF0ZS5ub3coKSAtIGRheXNOdW0gKiAyNCAqIDYwICogNjAgKiAxMDAwLFxuICAgICAgICAgICkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICB0bzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG1vY2s6IFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0gsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKFwi542y5Y+W5pCc5bCL5YiG5p6Q5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgZXJyb3I6IFwi542y5Y+W5YiG5p6Q5pW45pOa5aSx5pWXXCIsXG4gICAgICBjb2RlOiBcIkFOQUxZVElDU19FUlJPUlwiLFxuICAgIH0pO1xuICB9XG59KTtcblxuLyoqXG4gKiBAcm91dGUgR0VUIC9hcGkvYWR2YW5jZWQtc2VhcmNoL2hlYWx0aFxuICogQGRlc2Mg5qqi5p+l5pCc5bCL5pyN5YuZ5YGl5bq354uA5oWLXG4gKiBAYWNjZXNzIFB1YmxpY1xuICovXG5yb3V0ZXIuZ2V0KFwiL2hlYWx0aFwiLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgbGV0IGlzQ29ubmVjdGVkLCBtZXRyaWNzO1xuXG4gICAgaWYgKFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0gpIHtcbiAgICAgIC8vIOS9v+eUqOaooeaTrOacjeWLmVxuICAgICAgaXNDb25uZWN0ZWQgPSBhd2FpdCBtb2NrRWxhc3RpY3NlYXJjaFNlcnZpY2UuY2hlY2tDb25uZWN0aW9uKCk7XG4gICAgICBtZXRyaWNzID0gbW9ja0VsYXN0aWNzZWFyY2hTZXJ2aWNlLmdldFBlcmZvcm1hbmNlTWV0cmljcygpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDkvb/nlKjnnJ/lr6YgRWxhc3RpY3NlYXJjaCDmnI3li5lcbiAgICAgIGlzQ29ubmVjdGVkID0gYXdhaXQgZWxhc3RpY3NlYXJjaFNlcnZpY2UuY2hlY2tDb25uZWN0aW9uKCk7XG4gICAgICBtZXRyaWNzID0gZWxhc3RpY3NlYXJjaFNlcnZpY2UuZ2V0UGVyZm9ybWFuY2VNZXRyaWNzKCk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZWxhc3RpY3NlYXJjaDoge1xuICAgICAgICAgIGNvbm5lY3RlZDogaXNDb25uZWN0ZWQsXG4gICAgICAgICAgc3RhdHVzOiBpc0Nvbm5lY3RlZCA/IFwiaGVhbHRoeVwiIDogXCJkaXNjb25uZWN0ZWRcIixcbiAgICAgICAgICBtb2NrOiBVU0VfTU9DS19FTEFTVElDU0VBUkNILFxuICAgICAgICB9LFxuICAgICAgICBwZXJmb3JtYW5jZToge1xuICAgICAgICAgIHRvdGFsUXVlcmllczogbWV0cmljcy50b3RhbFF1ZXJpZXMsXG4gICAgICAgICAgYXZlcmFnZVJlc3BvbnNlVGltZTogTWF0aC5yb3VuZChtZXRyaWNzLmF2ZXJhZ2VSZXNwb25zZVRpbWUpLFxuICAgICAgICAgIHNsb3dRdWVyaWVzOiBtZXRyaWNzLnNsb3dRdWVyaWVzLFxuICAgICAgICAgIGVycm9yUmF0ZTogTWF0aC5yb3VuZChtZXRyaWNzLmVycm9yUmF0ZSAqIDEwMCkgLyAxMDAsXG4gICAgICAgICAgbGFzdFVwZGF0ZWQ6IG1ldHJpY3MubGFzdFVwZGF0ZWQsXG4gICAgICAgIH0sXG4gICAgICAgIGZlYXR1cmVzOiB7XG4gICAgICAgICAgYWR2YW5jZWRTZWFyY2g6IGlzQ29ubmVjdGVkLFxuICAgICAgICAgIGZ1enp5U2VhcmNoOiBpc0Nvbm5lY3RlZCxcbiAgICAgICAgICBzdWdnZXN0aW9uczogaXNDb25uZWN0ZWQsXG4gICAgICAgICAgYW5hbHl0aWNzOiBpc0Nvbm5lY3RlZCxcbiAgICAgICAgICBnZW9TZWFyY2g6IGlzQ29ubmVjdGVkLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCLmqqLmn6XmkJzlsIvmnI3li5nlgaXlurfni4DmhYvlpLHmlZc6XCIsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBlcnJvcjogXCLlgaXlurfmqqLmn6XlpLHmlZdcIixcbiAgICAgIGNvZGU6IFwiSEVBTFRIX0NIRUNLX0VSUk9SXCIsXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEByb3V0ZSBQT1NUIC9hcGkvYWR2YW5jZWQtc2VhcmNoL3JlaW5kZXhcbiAqIEBkZXNjIOmHjeaWsOe0ouW8leaJgOacieWvteeJqeaVuOaTmlxuICogQGFjY2VzcyBQcml2YXRlIChBZG1pbilcbiAqL1xucm91dGVyLnBvc3QoXCIvcmVpbmRleFwiLCBhdXRoLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8g5qqi5p+l566h55CG5ZOh5qyK6ZmQXG4gICAgaWYgKHJlcS51c2VyPy5yb2xlICE9PSBcImFkbWluXCIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgIGVycm9yOiBcIuasiumZkOS4jei2s1wiLFxuICAgICAgICBjb2RlOiBcIklOU1VGRklDSUVOVF9QRVJNSVNTSU9OU1wiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdDtcblxuICAgIGlmIChVU0VfTU9DS19FTEFTVElDU0VBUkNIKSB7XG4gICAgICAvLyDkvb/nlKjmqKHmk6zmnI3li5lcbiAgICAgIHJlc3VsdCA9IGF3YWl0IG1vY2tFbGFzdGljc2VhcmNoU2VydmljZS5yZWluZGV4QWxsUGV0cygpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDmqqLmn6UgRWxhc3RpY3NlYXJjaCDpgKPmjqVcbiAgICAgIGlmICghZWxhc3RpY3NlYXJjaFNlcnZpY2UuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDMpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiBcIuaQnOWwi+acjeWLmeaaq+aZguS4jeWPr+eUqFwiLFxuICAgICAgICAgIGNvZGU6IFwiU0VBUkNIX1NFUlZJQ0VfVU5BVkFJTEFCTEVcIixcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIOS9v+eUqOecn+WvpiBFbGFzdGljc2VhcmNoIOacjeWLmVxuICAgICAgcmVzdWx0ID0gYXdhaXQgcGV0U2VhcmNoU2VydmljZS5yZWluZGV4QWxsUGV0cygpO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKFwi6YeN5paw57Si5byV5a+154mp5pW45pOa5a6M5oiQXCIpO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6IFwi6YeN5paw57Si5byV5Lu75YuZ5bey5a6M5oiQXCIsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIC4uLnJlc3VsdCxcbiAgICAgICAgbW9jazogVVNFX01PQ0tfRUxBU1RJQ1NFQVJDSCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKFwi6YeN5paw57Si5byV5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgZXJyb3I6IFwi6YeN5paw57Si5byV5aSx5pWXXCIsXG4gICAgICBjb2RlOiBcIlJFSU5ERVhfRVJST1JcIixcbiAgICB9KTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==