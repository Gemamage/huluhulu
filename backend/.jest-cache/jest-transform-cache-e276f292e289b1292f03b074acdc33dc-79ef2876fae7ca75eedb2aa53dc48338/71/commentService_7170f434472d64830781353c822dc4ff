8a09c94059343eab629d014a57411e01
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.commentService = exports.CommentService = void 0;
const mongoose_1 = __importDefault(require("mongoose"));
const Comment_1 = require("../models/Comment");
const Pet_1 = require("../models/Pet");
const User_1 = require("../models/User");
const notificationService_1 = require("./notificationService");
const Notification_1 = require("../models/Notification");
class CommentService {
    constructor() {
        this.notificationService = new notificationService_1.NotificationService();
    }
    /**
     * 創建新留言
     */
    async createComment(data) {
        const { petId, userId, content, parentId } = data;
        // 驗證寵物是否存在
        const pet = await Pet_1.Pet.findById(petId);
        if (!pet) {
            throw new Error('寵物不存在');
        }
        // 驗證用戶是否存在
        const user = await User_1.User.findById(userId);
        if (!user) {
            throw new Error('用戶不存在');
        }
        // 如果是回覆留言，驗證父留言是否存在
        if (parentId) {
            const parentComment = await Comment_1.Comment.findById(parentId);
            if (!parentComment) {
                throw new Error('父留言不存在');
            }
            if (parentComment.petId.toString() !== petId) {
                throw new Error('回覆留言必須在同一寵物頁面下');
            }
        }
        // 創建留言
        const comment = new Comment_1.Comment({
            petId: new mongoose_1.default.Types.ObjectId(petId),
            userId: new mongoose_1.default.Types.ObjectId(userId),
            content: content.trim(),
            parentId: parentId ? new mongoose_1.default.Types.ObjectId(parentId) : null,
        });
        await comment.save();
        // 發送通知
        await this.sendCommentNotification(comment, pet);
        const createdComment = await this.getCommentById(comment._id.toString());
        if (!createdComment) {
            throw new Error('創建留言後無法獲取留言詳情');
        }
        return createdComment;
    }
    /**
     * 獲取留言詳情
     */
    async getCommentById(commentId) {
        if (!mongoose_1.default.Types.ObjectId.isValid(commentId)) {
            throw new Error('無效的留言ID');
        }
        return await Comment_1.Comment.findById(commentId)
            .populate('userId', 'username avatar email')
            .populate('petId', 'name images')
            .lean();
    }
    /**
     * 獲取特定寵物的留言列表
     */
    async getCommentsByPet(petId, options = {}) {
        const { page = 1, limit = 20, sortBy = 'createdAt', sortOrder = 'desc' } = options;
        return await this.getComments({
            petId,
            page,
            limit,
            sortBy,
            sortOrder
        });
    }
    /**
     * 獲取留言列表
     */
    async getComments(query) {
        const { petId, userId, parentId, page = 1, limit = 20, sortBy = 'createdAt', sortOrder = 'desc', includeDeleted = false } = query;
        // 構建查詢條件
        const filter = {};
        if (petId)
            filter.petId = new mongoose_1.default.Types.ObjectId(petId);
        if (userId)
            filter.userId = new mongoose_1.default.Types.ObjectId(userId);
        if (parentId !== undefined) {
            filter.parentId = parentId ? new mongoose_1.default.Types.ObjectId(parentId) : null;
        }
        if (includeDeleted) {
            filter.includeDeleted = true;
        }
        // 計算分頁
        const skip = (page - 1) * limit;
        const sortOptions = {};
        sortOptions[sortBy] = sortOrder === 'asc' ? 1 : -1;
        // 執行查詢
        const [comments, total] = await Promise.all([
            Comment_1.Comment.find(filter)
                .populate('userId', 'username avatar email')
                .populate('petId', 'name images')
                .sort(sortOptions)
                .skip(skip)
                .limit(limit)
                .lean(),
            Comment_1.Comment.countDocuments(filter)
        ]);
        return {
            comments,
            total,
            page,
            totalPages: Math.ceil(total / limit)
        };
    }
    /**
     * 獲取留言樹狀結構
     */
    async getCommentTree(petId, page = 1, limit = 20) {
        if (!mongoose_1.default.Types.ObjectId.isValid(petId)) {
            throw new Error('無效的寵物ID');
        }
        // 獲取主留言
        const skip = (page - 1) * limit;
        const [mainComments, total] = await Promise.all([
            Comment_1.Comment.find({
                petId: new mongoose_1.default.Types.ObjectId(petId),
                parentId: null
            })
                .populate('userId', 'username avatar email')
                .sort({ createdAt: -1 })
                .skip(skip)
                .limit(limit)
                .lean(),
            Comment_1.Comment.countDocuments({
                petId: new mongoose_1.default.Types.ObjectId(petId),
                parentId: null
            })
        ]);
        // 獲取每個主留言的回覆
        const commentsWithReplies = await Promise.all(mainComments.map(async (comment) => {
            const replies = await Comment_1.Comment.find({
                parentId: comment._id
            })
                .populate('userId', 'username avatar email')
                .sort({ createdAt: 1 })
                .limit(10) // 限制回覆數量
                .lean();
            const replyCount = await Comment_1.Comment.countDocuments({
                parentId: comment._id
            });
            return {
                ...comment,
                replies,
                replyCount,
                hasMoreReplies: replyCount > 10
            };
        }));
        return {
            comments: commentsWithReplies,
            total,
            page,
            totalPages: Math.ceil(total / limit)
        };
    }
    /**
     * 更新留言
     */
    async updateComment(commentId, userId, data) {
        if (!mongoose_1.default.Types.ObjectId.isValid(commentId)) {
            throw new Error('無效的留言ID');
        }
        const comment = await Comment_1.Comment.findById(commentId);
        if (!comment) {
            throw new Error('留言不存在');
        }
        // 檢查權限
        if (comment.userId.toString() !== userId) {
            throw new Error('無權限修改此留言');
        }
        // 更新留言
        const updatedComment = await Comment_1.Comment.findByIdAndUpdate(commentId, {
            ...data,
            content: data.content?.trim()
        }, { new: true })
            .populate('userId', 'username avatar email')
            .populate('petId', 'name images');
        return updatedComment;
    }
    /**
     * 刪除留言
     */
    async deleteComment(commentId, userId, isAdmin = false) {
        if (!mongoose_1.default.Types.ObjectId.isValid(commentId)) {
            throw new Error('無效的留言ID');
        }
        const comment = await Comment_1.Comment.findById(commentId);
        if (!comment) {
            throw new Error('留言不存在');
        }
        // 檢查權限
        if (!isAdmin && comment.userId.toString() !== userId) {
            throw new Error('無權限刪除此留言');
        }
        // 軟刪除
        await Comment_1.Comment.findByIdAndUpdate(commentId, {
            isDeleted: true,
            deletedAt: new Date(),
            deletedBy: new mongoose_1.default.Types.ObjectId(userId)
        });
        // 同時刪除所有回覆
        await Comment_1.Comment.updateMany({ parentId: new mongoose_1.default.Types.ObjectId(commentId) }, {
            isDeleted: true,
            deletedAt: new Date(),
            deletedBy: new mongoose_1.default.Types.ObjectId(userId)
        });
        return true;
    }
    /**
     * 舉報留言
     */
    async reportComment(commentId, reporterId) {
        if (!mongoose_1.default.Types.ObjectId.isValid(commentId)) {
            throw new Error('無效的留言ID');
        }
        const comment = await Comment_1.Comment.findById(commentId);
        if (!comment) {
            throw new Error('留言不存在');
        }
        // 增加舉報次數
        await Comment_1.Comment.findByIdAndUpdate(commentId, {
            $inc: { reportCount: 1 }
        });
        // 如果舉報次數超過閾值，自動隱藏
        const updatedComment = await Comment_1.Comment.findById(commentId);
        if (updatedComment && updatedComment.reportCount >= 5) {
            await Comment_1.Comment.findByIdAndUpdate(commentId, {
                isHidden: true
            });
        }
        return true;
    }
    /**
     * 獲取用戶留言統計
     */
    async getUserCommentStats(userId) {
        if (!mongoose_1.default.Types.ObjectId.isValid(userId)) {
            throw new Error('無效的用戶ID');
        }
        const userObjectId = new mongoose_1.default.Types.ObjectId(userId);
        const [totalComments, totalReplies, recentComments] = await Promise.all([
            Comment_1.Comment.countDocuments({ userId: userObjectId, parentId: null }),
            Comment_1.Comment.countDocuments({ userId: userObjectId, parentId: { $ne: null } }),
            Comment_1.Comment.find({ userId: userObjectId })
                .populate('petId', 'name images')
                .sort({ createdAt: -1 })
                .limit(5)
                .lean()
        ]);
        return {
            totalComments,
            totalReplies,
            recentComments
        };
    }
    /**
     * 發送留言通知
     */
    async sendCommentNotification(comment, pet) {
        try {
            // 通知寵物主人
            if (pet.userId.toString() !== comment.userId.toString()) {
                await notificationService_1.NotificationService.sendNotification({
                    userId: pet.userId.toString(),
                    type: Notification_1.NotificationType.COMMENT,
                    title: '新留言通知',
                    message: `有人在您的寵物「${pet.name}」頁面留言了`,
                    data: {
                        petId: pet._id.toString(),
                        commentId: comment._id.toString(),
                        commenterId: comment.userId.toString()
                    }
                });
            }
            // 如果是回覆，通知被回覆的用戶
            if (comment.parentId) {
                const parentComment = await Comment_1.Comment.findById(comment.parentId);
                if (parentComment && parentComment.userId.toString() !== comment.userId.toString()) {
                    await notificationService_1.NotificationService.sendNotification({
                        userId: parentComment.userId.toString(),
                        type: Notification_1.NotificationType.REPLY,
                        title: '留言回覆通知',
                        message: `有人回覆了您的留言`,
                        data: {
                            petId: pet._id.toString(),
                            commentId: comment._id.toString(),
                            parentCommentId: parentComment._id.toString(),
                            replierId: comment.userId.toString()
                        }
                    });
                }
            }
        }
        catch (error) {
            console.error('發送留言通知失敗:', error);
        }
    }
}
exports.CommentService = CommentService;
exports.commentService = new CommentService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxjb21tZW50U2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx3REFBZ0M7QUFDaEMsK0NBQXNEO0FBQ3RELHVDQUFvQztBQUNwQyx5Q0FBc0M7QUFDdEMsK0RBQTREO0FBQzVELHlEQUEwRDtBQXdCMUQsTUFBYSxjQUFjO0lBR3pCO1FBQ0UsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUkseUNBQW1CLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUFDLElBQXVCO1FBQ3pDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFFbEQsV0FBVztRQUNYLE1BQU0sR0FBRyxHQUFHLE1BQU0sU0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDVCxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNCLENBQUM7UUFFRCxXQUFXO1FBQ1gsTUFBTSxJQUFJLEdBQUcsTUFBTSxXQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0IsQ0FBQztRQUVELG9CQUFvQjtRQUNwQixJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsTUFBTSxhQUFhLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN2RCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDNUIsQ0FBQztZQUNELElBQUksYUFBYSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxLQUFLLEVBQUUsQ0FBQztnQkFDN0MsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3BDLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTztRQUNQLE1BQU0sT0FBTyxHQUFHLElBQUksaUJBQU8sQ0FBQztZQUMxQixLQUFLLEVBQUUsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1lBQ3pDLE1BQU0sRUFBRSxJQUFJLGtCQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7WUFDM0MsT0FBTyxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDdkIsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7U0FDbEUsQ0FBQyxDQUFDO1FBRUgsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFckIsT0FBTztRQUNQLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVqRCxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3pFLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ25DLENBQUM7UUFDRCxPQUFPLGNBQWMsQ0FBQztJQUN4QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsY0FBYyxDQUFDLFNBQWlCO1FBQ3BDLElBQUksQ0FBQyxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDaEQsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM3QixDQUFDO1FBRUQsT0FBTyxNQUFNLGlCQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQzthQUNyQyxRQUFRLENBQUMsUUFBUSxFQUFFLHVCQUF1QixDQUFDO2FBQzNDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDO2FBQ2hDLElBQUksRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEtBQWEsRUFBRSxVQUtsQyxFQUFFO1FBTUosTUFBTSxFQUFFLElBQUksR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLEVBQUUsRUFBRSxNQUFNLEdBQUcsV0FBVyxFQUFFLFNBQVMsR0FBRyxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFFbkYsT0FBTyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDNUIsS0FBSztZQUNMLElBQUk7WUFDSixLQUFLO1lBQ0wsTUFBTTtZQUNOLFNBQVM7U0FDVixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQW1CO1FBTW5DLE1BQU0sRUFDSixLQUFLLEVBQ0wsTUFBTSxFQUNOLFFBQVEsRUFDUixJQUFJLEdBQUcsQ0FBQyxFQUNSLEtBQUssR0FBRyxFQUFFLEVBQ1YsTUFBTSxHQUFHLFdBQVcsRUFDcEIsU0FBUyxHQUFHLE1BQU0sRUFDbEIsY0FBYyxHQUFHLEtBQUssRUFDdkIsR0FBRyxLQUFLLENBQUM7UUFFVixTQUFTO1FBQ1QsTUFBTSxNQUFNLEdBQVEsRUFBRSxDQUFDO1FBQ3ZCLElBQUksS0FBSztZQUFFLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0QsSUFBSSxNQUFNO1lBQUUsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLGtCQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNoRSxJQUFJLFFBQVEsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUMzQixNQUFNLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUM1RSxDQUFDO1FBQ0QsSUFBSSxjQUFjLEVBQUUsQ0FBQztZQUNuQixNQUFNLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztRQUMvQixDQUFDO1FBRUQsT0FBTztRQUNQLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUNoQyxNQUFNLFdBQVcsR0FBUSxFQUFFLENBQUM7UUFDNUIsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFNBQVMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFbkQsT0FBTztRQUNQLE1BQU0sQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQzFDLGlCQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztpQkFDakIsUUFBUSxDQUFDLFFBQVEsRUFBRSx1QkFBdUIsQ0FBQztpQkFDM0MsUUFBUSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUM7aUJBQ2hDLElBQUksQ0FBQyxXQUFXLENBQUM7aUJBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUM7aUJBQ1YsS0FBSyxDQUFDLEtBQUssQ0FBQztpQkFDWixJQUFJLEVBQUU7WUFDVCxpQkFBTyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUM7U0FDL0IsQ0FBQyxDQUFDO1FBRUgsT0FBTztZQUNMLFFBQVE7WUFDUixLQUFLO1lBQ0wsSUFBSTtZQUNKLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7U0FDckMsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBYSxFQUFFLE9BQWUsQ0FBQyxFQUFFLFFBQWdCLEVBQUU7UUFNdEUsSUFBSSxDQUFDLGtCQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUM1QyxNQUFNLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFFRCxRQUFRO1FBQ1IsTUFBTSxJQUFJLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ2hDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQzlDLGlCQUFPLENBQUMsSUFBSSxDQUFDO2dCQUNYLEtBQUssRUFBRSxJQUFJLGtCQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7Z0JBQ3pDLFFBQVEsRUFBRSxJQUFJO2FBQ2YsQ0FBQztpQkFDQyxRQUFRLENBQUMsUUFBUSxFQUFFLHVCQUF1QixDQUFDO2lCQUMzQyxJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztpQkFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQztpQkFDVixLQUFLLENBQUMsS0FBSyxDQUFDO2lCQUNaLElBQUksRUFBRTtZQUNULGlCQUFPLENBQUMsY0FBYyxDQUFDO2dCQUNyQixLQUFLLEVBQUUsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO2dCQUN6QyxRQUFRLEVBQUUsSUFBSTthQUNmLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxhQUFhO1FBQ2IsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQzNDLFlBQVksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQVksRUFBRSxFQUFFO1lBQ3RDLE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ2pDLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRzthQUN0QixDQUFDO2lCQUNDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsdUJBQXVCLENBQUM7aUJBQzNDLElBQUksQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsQ0FBQztpQkFDdEIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVM7aUJBQ25CLElBQUksRUFBRSxDQUFDO1lBRVYsTUFBTSxVQUFVLEdBQUcsTUFBTSxpQkFBTyxDQUFDLGNBQWMsQ0FBQztnQkFDOUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHO2FBQ3RCLENBQUMsQ0FBQztZQUVILE9BQU87Z0JBQ0wsR0FBRyxPQUFPO2dCQUNWLE9BQU87Z0JBQ1AsVUFBVTtnQkFDVixjQUFjLEVBQUUsVUFBVSxHQUFHLEVBQUU7YUFDaEMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7UUFFRixPQUFPO1lBQ0wsUUFBUSxFQUFFLG1CQUFtQjtZQUM3QixLQUFLO1lBQ0wsSUFBSTtZQUNKLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7U0FDckMsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxhQUFhLENBQ2pCLFNBQWlCLEVBQ2pCLE1BQWMsRUFDZCxJQUF1QjtRQUV2QixJQUFJLENBQUMsa0JBQVEsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1lBQ2hELE1BQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2IsTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMzQixDQUFDO1FBRUQsT0FBTztRQUNQLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsS0FBSyxNQUFNLEVBQUUsQ0FBQztZQUN6QyxNQUFNLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlCLENBQUM7UUFFRCxPQUFPO1FBQ1AsTUFBTSxjQUFjLEdBQUcsTUFBTSxpQkFBTyxDQUFDLGlCQUFpQixDQUNwRCxTQUFTLEVBQ1Q7WUFDRSxHQUFHLElBQUk7WUFDUCxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUU7U0FDOUIsRUFDRCxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FDZDthQUNFLFFBQVEsQ0FBQyxRQUFRLEVBQUUsdUJBQXVCLENBQUM7YUFDM0MsUUFBUSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUVwQyxPQUFPLGNBQWMsQ0FBQztJQUN4QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUFDLFNBQWlCLEVBQUUsTUFBYyxFQUFFLFVBQW1CLEtBQUs7UUFDN0UsSUFBSSxDQUFDLGtCQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUNoRCxNQUFNLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLGlCQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNiLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0IsQ0FBQztRQUVELE9BQU87UUFDUCxJQUFJLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDckQsTUFBTSxJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixDQUFDO1FBRUQsTUFBTTtRQUNOLE1BQU0saUJBQU8sQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLEVBQUU7WUFDekMsU0FBUyxFQUFFLElBQUk7WUFDZixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDckIsU0FBUyxFQUFFLElBQUksa0JBQVEsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztTQUMvQyxDQUFDLENBQUM7UUFFSCxXQUFXO1FBQ1gsTUFBTSxpQkFBTyxDQUFDLFVBQVUsQ0FDdEIsRUFBRSxRQUFRLEVBQUUsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFDcEQ7WUFDRSxTQUFTLEVBQUUsSUFBSTtZQUNmLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtZQUNyQixTQUFTLEVBQUUsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1NBQy9DLENBQ0YsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FBQyxTQUFpQixFQUFFLFVBQWtCO1FBQ3ZELElBQUksQ0FBQyxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDaEQsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM3QixDQUFDO1FBRUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDYixNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNCLENBQUM7UUFFRCxTQUFTO1FBQ1QsTUFBTSxpQkFBTyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRTtZQUN6QyxJQUFJLEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFO1NBQ3pCLENBQUMsQ0FBQztRQUVILGtCQUFrQjtRQUNsQixNQUFNLGNBQWMsR0FBRyxNQUFNLGlCQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pELElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxXQUFXLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDdEQsTUFBTSxpQkFBTyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRTtnQkFDekMsUUFBUSxFQUFFLElBQUk7YUFDZixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsTUFBYztRQUt0QyxJQUFJLENBQUMsa0JBQVEsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1lBQzdDLE1BQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELE1BQU0sWUFBWSxHQUFHLElBQUksa0JBQVEsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXpELE1BQU0sQ0FBQyxhQUFhLEVBQUUsWUFBWSxFQUFFLGNBQWMsQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUN0RSxpQkFBTyxDQUFDLGNBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO1lBQ2hFLGlCQUFPLENBQUMsY0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUN6RSxpQkFBTyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsQ0FBQztpQkFDbkMsUUFBUSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUM7aUJBQ2hDLElBQUksQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO2lCQUN2QixLQUFLLENBQUMsQ0FBQyxDQUFDO2lCQUNSLElBQUksRUFBRTtTQUNWLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxhQUFhO1lBQ2IsWUFBWTtZQUNaLGNBQWM7U0FDZixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ssS0FBSyxDQUFDLHVCQUF1QixDQUFDLE9BQWlCLEVBQUUsR0FBUTtRQUMvRCxJQUFJLENBQUM7WUFDSCxTQUFTO1lBQ1QsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxLQUFLLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQztnQkFDeEQsTUFBTSx5Q0FBbUIsQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDekMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFO29CQUM3QixJQUFJLEVBQUUsK0JBQWdCLENBQUMsT0FBTztvQkFDOUIsS0FBSyxFQUFFLE9BQU87b0JBQ2QsT0FBTyxFQUFFLFdBQVcsR0FBRyxDQUFDLElBQUksUUFBUTtvQkFDcEMsSUFBSSxFQUFFO3dCQUNKLEtBQUssRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTt3QkFDekIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO3dCQUNqQyxXQUFXLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7cUJBQ3ZDO2lCQUNGLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxpQkFBaUI7WUFDakIsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3JCLE1BQU0sYUFBYSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMvRCxJQUFJLGFBQWEsSUFBSSxhQUFhLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxLQUFLLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQztvQkFDbkYsTUFBTSx5Q0FBbUIsQ0FBQyxnQkFBZ0IsQ0FBQzt3QkFDekMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFO3dCQUN2QyxJQUFJLEVBQUUsK0JBQWdCLENBQUMsS0FBSzt3QkFDNUIsS0FBSyxFQUFFLFFBQVE7d0JBQ2YsT0FBTyxFQUFFLFdBQVc7d0JBQ3BCLElBQUksRUFBRTs0QkFDSixLQUFLLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUU7NEJBQ3pCLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTs0QkFDakMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFOzRCQUM3QyxTQUFTLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7eUJBQ3JDO3FCQUNGLENBQUMsQ0FBQztnQkFDTCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEMsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXZZRCx3Q0F1WUM7QUFFWSxRQUFBLGNBQWMsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVXNlclxcRGVza3RvcFxcdHJhZXByb2plY3RcXHRlc3QyXFxwZXQtZmluZGVyLWFwcFxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcY29tbWVudFNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJztcbmltcG9ydCB7IENvbW1lbnQsIElDb21tZW50IH0gZnJvbSAnLi4vbW9kZWxzL0NvbW1lbnQnO1xuaW1wb3J0IHsgUGV0IH0gZnJvbSAnLi4vbW9kZWxzL1BldCc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL1VzZXInO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4vbm90aWZpY2F0aW9uU2VydmljZSc7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25UeXBlIH0gZnJvbSAnLi4vbW9kZWxzL05vdGlmaWNhdGlvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3JlYXRlQ29tbWVudERhdGEge1xuICBwZXRJZDogc3RyaW5nO1xuICB1c2VySWQ6IHN0cmluZztcbiAgY29udGVudDogc3RyaW5nO1xuICBwYXJlbnRJZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBVcGRhdGVDb21tZW50RGF0YSB7XG4gIGNvbnRlbnQ/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbWVudFF1ZXJ5IHtcbiAgcGV0SWQ/OiBzdHJpbmc7XG4gIHVzZXJJZD86IHN0cmluZztcbiAgcGFyZW50SWQ/OiBzdHJpbmcgfCBudWxsO1xuICBwYWdlPzogbnVtYmVyO1xuICBsaW1pdD86IG51bWJlcjtcbiAgc29ydEJ5PzogJ2NyZWF0ZWRBdCcgfCAndXBkYXRlZEF0JztcbiAgc29ydE9yZGVyPzogJ2FzYycgfCAnZGVzYyc7XG4gIGluY2x1ZGVEZWxldGVkPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIENvbW1lbnRTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBub3RpZmljYXRpb25TZXJ2aWNlOiBOb3RpZmljYXRpb25TZXJ2aWNlO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZSA9IG5ldyBOb3RpZmljYXRpb25TZXJ2aWNlKCk7XG4gIH1cblxuICAvKipcbiAgICog5Ym15bu65paw55WZ6KiAXG4gICAqL1xuICBhc3luYyBjcmVhdGVDb21tZW50KGRhdGE6IENyZWF0ZUNvbW1lbnREYXRhKTogUHJvbWlzZTxJQ29tbWVudD4ge1xuICAgIGNvbnN0IHsgcGV0SWQsIHVzZXJJZCwgY29udGVudCwgcGFyZW50SWQgfSA9IGRhdGE7XG5cbiAgICAvLyDpqZforYnlr7XnianmmK/lkKblrZjlnKhcbiAgICBjb25zdCBwZXQgPSBhd2FpdCBQZXQuZmluZEJ5SWQocGV0SWQpO1xuICAgIGlmICghcGV0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+WvteeJqeS4jeWtmOWcqCcpO1xuICAgIH1cblxuICAgIC8vIOmpl+itieeUqOaItuaYr+WQpuWtmOWcqFxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+eUqOaItuS4jeWtmOWcqCcpO1xuICAgIH1cblxuICAgIC8vIOWmguaenOaYr+WbnuimhueVmeiogO+8jOmpl+itieeItueVmeiogOaYr+WQpuWtmOWcqFxuICAgIGlmIChwYXJlbnRJZCkge1xuICAgICAgY29uc3QgcGFyZW50Q29tbWVudCA9IGF3YWl0IENvbW1lbnQuZmluZEJ5SWQocGFyZW50SWQpO1xuICAgICAgaWYgKCFwYXJlbnRDb21tZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcign54i255WZ6KiA5LiN5a2Y5ZyoJyk7XG4gICAgICB9XG4gICAgICBpZiAocGFyZW50Q29tbWVudC5wZXRJZC50b1N0cmluZygpICE9PSBwZXRJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+WbnuimhueVmeiogOW/hemgiOWcqOWQjOS4gOWvteeJqemggemdouS4iycpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIOWJteW7uueVmeiogFxuICAgIGNvbnN0IGNvbW1lbnQgPSBuZXcgQ29tbWVudCh7XG4gICAgICBwZXRJZDogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHBldElkKSxcbiAgICAgIHVzZXJJZDogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHVzZXJJZCksXG4gICAgICBjb250ZW50OiBjb250ZW50LnRyaW0oKSxcbiAgICAgIHBhcmVudElkOiBwYXJlbnRJZCA/IG5ldyBtb25nb29zZS5UeXBlcy5PYmplY3RJZChwYXJlbnRJZCkgOiBudWxsLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgY29tbWVudC5zYXZlKCk7XG5cbiAgICAvLyDnmbzpgIHpgJrnn6VcbiAgICBhd2FpdCB0aGlzLnNlbmRDb21tZW50Tm90aWZpY2F0aW9uKGNvbW1lbnQsIHBldCk7XG5cbiAgICBjb25zdCBjcmVhdGVkQ29tbWVudCA9IGF3YWl0IHRoaXMuZ2V0Q29tbWVudEJ5SWQoY29tbWVudC5faWQudG9TdHJpbmcoKSk7XG4gICAgaWYgKCFjcmVhdGVkQ29tbWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCflibXlu7rnlZnoqIDlvoznhKHms5XnjbLlj5bnlZnoqIDoqbPmg4UnKTtcbiAgICB9XG4gICAgcmV0dXJuIGNyZWF0ZWRDb21tZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPlueVmeiogOips+aDhVxuICAgKi9cbiAgYXN5bmMgZ2V0Q29tbWVudEJ5SWQoY29tbWVudElkOiBzdHJpbmcpOiBQcm9taXNlPElDb21tZW50IHwgbnVsbD4ge1xuICAgIGlmICghbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQuaXNWYWxpZChjb21tZW50SWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+eEoeaViOeahOeVmeiogElEJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IENvbW1lbnQuZmluZEJ5SWQoY29tbWVudElkKVxuICAgICAgLnBvcHVsYXRlKCd1c2VySWQnLCAndXNlcm5hbWUgYXZhdGFyIGVtYWlsJylcbiAgICAgIC5wb3B1bGF0ZSgncGV0SWQnLCAnbmFtZSBpbWFnZXMnKVxuICAgICAgLmxlYW4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnjbLlj5bnibnlrprlr7XniannmoTnlZnoqIDliJfooahcbiAgICovXG4gIGFzeW5jIGdldENvbW1lbnRzQnlQZXQocGV0SWQ6IHN0cmluZywgb3B0aW9uczoge1xuICAgIHBhZ2U/OiBudW1iZXI7XG4gICAgbGltaXQ/OiBudW1iZXI7XG4gICAgc29ydEJ5PzogJ2NyZWF0ZWRBdCcgfCAndXBkYXRlZEF0JztcbiAgICBzb3J0T3JkZXI/OiAnYXNjJyB8ICdkZXNjJztcbiAgfSA9IHt9KTogUHJvbWlzZTx7XG4gICAgY29tbWVudHM6IElDb21tZW50W107XG4gICAgdG90YWw6IG51bWJlcjtcbiAgICBwYWdlOiBudW1iZXI7XG4gICAgdG90YWxQYWdlczogbnVtYmVyO1xuICB9PiB7XG4gICAgY29uc3QgeyBwYWdlID0gMSwgbGltaXQgPSAyMCwgc29ydEJ5ID0gJ2NyZWF0ZWRBdCcsIHNvcnRPcmRlciA9ICdkZXNjJyB9ID0gb3B0aW9ucztcbiAgICBcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRDb21tZW50cyh7XG4gICAgICBwZXRJZCxcbiAgICAgIHBhZ2UsXG4gICAgICBsaW1pdCxcbiAgICAgIHNvcnRCeSxcbiAgICAgIHNvcnRPcmRlclxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPlueVmeiogOWIl+ihqFxuICAgKi9cbiAgYXN5bmMgZ2V0Q29tbWVudHMocXVlcnk6IENvbW1lbnRRdWVyeSk6IFByb21pc2U8e1xuICAgIGNvbW1lbnRzOiBJQ29tbWVudFtdO1xuICAgIHRvdGFsOiBudW1iZXI7XG4gICAgcGFnZTogbnVtYmVyO1xuICAgIHRvdGFsUGFnZXM6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIHBldElkLFxuICAgICAgdXNlcklkLFxuICAgICAgcGFyZW50SWQsXG4gICAgICBwYWdlID0gMSxcbiAgICAgIGxpbWl0ID0gMjAsXG4gICAgICBzb3J0QnkgPSAnY3JlYXRlZEF0JyxcbiAgICAgIHNvcnRPcmRlciA9ICdkZXNjJyxcbiAgICAgIGluY2x1ZGVEZWxldGVkID0gZmFsc2VcbiAgICB9ID0gcXVlcnk7XG5cbiAgICAvLyDmp4vlu7rmn6XoqaLmop3ku7ZcbiAgICBjb25zdCBmaWx0ZXI6IGFueSA9IHt9O1xuICAgIGlmIChwZXRJZCkgZmlsdGVyLnBldElkID0gbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHBldElkKTtcbiAgICBpZiAodXNlcklkKSBmaWx0ZXIudXNlcklkID0gbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHVzZXJJZCk7XG4gICAgaWYgKHBhcmVudElkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGZpbHRlci5wYXJlbnRJZCA9IHBhcmVudElkID8gbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHBhcmVudElkKSA6IG51bGw7XG4gICAgfVxuICAgIGlmIChpbmNsdWRlRGVsZXRlZCkge1xuICAgICAgZmlsdGVyLmluY2x1ZGVEZWxldGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyDoqIjnrpfliIbpoIFcbiAgICBjb25zdCBza2lwID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xuICAgIGNvbnN0IHNvcnRPcHRpb25zOiBhbnkgPSB7fTtcbiAgICBzb3J0T3B0aW9uc1tzb3J0QnldID0gc29ydE9yZGVyID09PSAnYXNjJyA/IDEgOiAtMTtcblxuICAgIC8vIOWft+ihjOafpeipolxuICAgIGNvbnN0IFtjb21tZW50cywgdG90YWxdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgQ29tbWVudC5maW5kKGZpbHRlcilcbiAgICAgICAgLnBvcHVsYXRlKCd1c2VySWQnLCAndXNlcm5hbWUgYXZhdGFyIGVtYWlsJylcbiAgICAgICAgLnBvcHVsYXRlKCdwZXRJZCcsICduYW1lIGltYWdlcycpXG4gICAgICAgIC5zb3J0KHNvcnRPcHRpb25zKVxuICAgICAgICAuc2tpcChza2lwKVxuICAgICAgICAubGltaXQobGltaXQpXG4gICAgICAgIC5sZWFuKCksXG4gICAgICBDb21tZW50LmNvdW50RG9jdW1lbnRzKGZpbHRlcilcbiAgICBdKTtcblxuICAgIHJldHVybiB7XG4gICAgICBjb21tZW50cyxcbiAgICAgIHRvdGFsLFxuICAgICAgcGFnZSxcbiAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbCh0b3RhbCAvIGxpbWl0KVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICog542y5Y+W55WZ6KiA5qi554uA57WQ5qeLXG4gICAqL1xuICBhc3luYyBnZXRDb21tZW50VHJlZShwZXRJZDogc3RyaW5nLCBwYWdlOiBudW1iZXIgPSAxLCBsaW1pdDogbnVtYmVyID0gMjApOiBQcm9taXNlPHtcbiAgICBjb21tZW50czogYW55W107XG4gICAgdG90YWw6IG51bWJlcjtcbiAgICBwYWdlOiBudW1iZXI7XG4gICAgdG90YWxQYWdlczogbnVtYmVyO1xuICB9PiB7XG4gICAgaWYgKCFtb25nb29zZS5UeXBlcy5PYmplY3RJZC5pc1ZhbGlkKHBldElkKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCfnhKHmlYjnmoTlr7XnialJRCcpO1xuICAgIH1cblxuICAgIC8vIOeNsuWPluS4u+eVmeiogFxuICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG4gICAgY29uc3QgW21haW5Db21tZW50cywgdG90YWxdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgQ29tbWVudC5maW5kKHsgXG4gICAgICAgIHBldElkOiBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQocGV0SWQpLCBcbiAgICAgICAgcGFyZW50SWQ6IG51bGwgXG4gICAgICB9KVxuICAgICAgICAucG9wdWxhdGUoJ3VzZXJJZCcsICd1c2VybmFtZSBhdmF0YXIgZW1haWwnKVxuICAgICAgICAuc29ydCh7IGNyZWF0ZWRBdDogLTEgfSlcbiAgICAgICAgLnNraXAoc2tpcClcbiAgICAgICAgLmxpbWl0KGxpbWl0KVxuICAgICAgICAubGVhbigpLFxuICAgICAgQ29tbWVudC5jb3VudERvY3VtZW50cyh7IFxuICAgICAgICBwZXRJZDogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHBldElkKSwgXG4gICAgICAgIHBhcmVudElkOiBudWxsIFxuICAgICAgfSlcbiAgICBdKTtcblxuICAgIC8vIOeNsuWPluavj+WAi+S4u+eVmeiogOeahOWbnuimhlxuICAgIGNvbnN0IGNvbW1lbnRzV2l0aFJlcGxpZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIG1haW5Db21tZW50cy5tYXAoYXN5bmMgKGNvbW1lbnQ6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCByZXBsaWVzID0gYXdhaXQgQ29tbWVudC5maW5kKHsgXG4gICAgICAgICAgcGFyZW50SWQ6IGNvbW1lbnQuX2lkIFxuICAgICAgICB9KVxuICAgICAgICAgIC5wb3B1bGF0ZSgndXNlcklkJywgJ3VzZXJuYW1lIGF2YXRhciBlbWFpbCcpXG4gICAgICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IDEgfSlcbiAgICAgICAgICAubGltaXQoMTApIC8vIOmZkOWItuWbnuimhuaVuOmHj1xuICAgICAgICAgIC5sZWFuKCk7XG5cbiAgICAgICAgY29uc3QgcmVwbHlDb3VudCA9IGF3YWl0IENvbW1lbnQuY291bnREb2N1bWVudHMoeyBcbiAgICAgICAgICBwYXJlbnRJZDogY29tbWVudC5faWQgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4uY29tbWVudCxcbiAgICAgICAgICByZXBsaWVzLFxuICAgICAgICAgIHJlcGx5Q291bnQsXG4gICAgICAgICAgaGFzTW9yZVJlcGxpZXM6IHJlcGx5Q291bnQgPiAxMFxuICAgICAgICB9O1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbW1lbnRzOiBjb21tZW50c1dpdGhSZXBsaWVzLFxuICAgICAgdG90YWwsXG4gICAgICBwYWdlLFxuICAgICAgdG90YWxQYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gbGltaXQpXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDnlZnoqIBcbiAgICovXG4gIGFzeW5jIHVwZGF0ZUNvbW1lbnQoXG4gICAgY29tbWVudElkOiBzdHJpbmcsIFxuICAgIHVzZXJJZDogc3RyaW5nLCBcbiAgICBkYXRhOiBVcGRhdGVDb21tZW50RGF0YVxuICApOiBQcm9taXNlPElDb21tZW50IHwgbnVsbD4ge1xuICAgIGlmICghbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQuaXNWYWxpZChjb21tZW50SWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+eEoeaViOeahOeVmeiogElEJyk7XG4gICAgfVxuXG4gICAgY29uc3QgY29tbWVudCA9IGF3YWl0IENvbW1lbnQuZmluZEJ5SWQoY29tbWVudElkKTtcbiAgICBpZiAoIWNvbW1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign55WZ6KiA5LiN5a2Y5ZyoJyk7XG4gICAgfVxuXG4gICAgLy8g5qqi5p+l5qyK6ZmQXG4gICAgaWYgKGNvbW1lbnQudXNlcklkLnRvU3RyaW5nKCkgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCfnhKHmrIrpmZDkv67mlLnmraTnlZnoqIAnKTtcbiAgICB9XG5cbiAgICAvLyDmm7TmlrDnlZnoqIBcbiAgICBjb25zdCB1cGRhdGVkQ29tbWVudCA9IGF3YWl0IENvbW1lbnQuZmluZEJ5SWRBbmRVcGRhdGUoXG4gICAgICBjb21tZW50SWQsXG4gICAgICB7IFxuICAgICAgICAuLi5kYXRhLFxuICAgICAgICBjb250ZW50OiBkYXRhLmNvbnRlbnQ/LnRyaW0oKVxuICAgICAgfSxcbiAgICAgIHsgbmV3OiB0cnVlIH1cbiAgICApXG4gICAgICAucG9wdWxhdGUoJ3VzZXJJZCcsICd1c2VybmFtZSBhdmF0YXIgZW1haWwnKVxuICAgICAgLnBvcHVsYXRlKCdwZXRJZCcsICduYW1lIGltYWdlcycpO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRDb21tZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIOWIqumZpOeVmeiogFxuICAgKi9cbiAgYXN5bmMgZGVsZXRlQ29tbWVudChjb21tZW50SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcsIGlzQWRtaW46IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmICghbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQuaXNWYWxpZChjb21tZW50SWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+eEoeaViOeahOeVmeiogElEJyk7XG4gICAgfVxuXG4gICAgY29uc3QgY29tbWVudCA9IGF3YWl0IENvbW1lbnQuZmluZEJ5SWQoY29tbWVudElkKTtcbiAgICBpZiAoIWNvbW1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign55WZ6KiA5LiN5a2Y5ZyoJyk7XG4gICAgfVxuXG4gICAgLy8g5qqi5p+l5qyK6ZmQXG4gICAgaWYgKCFpc0FkbWluICYmIGNvbW1lbnQudXNlcklkLnRvU3RyaW5nKCkgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCfnhKHmrIrpmZDliKrpmaTmraTnlZnoqIAnKTtcbiAgICB9XG5cbiAgICAvLyDou5/liKrpmaRcbiAgICBhd2FpdCBDb21tZW50LmZpbmRCeUlkQW5kVXBkYXRlKGNvbW1lbnRJZCwge1xuICAgICAgaXNEZWxldGVkOiB0cnVlLFxuICAgICAgZGVsZXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgZGVsZXRlZEJ5OiBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKVxuICAgIH0pO1xuXG4gICAgLy8g5ZCM5pmC5Yiq6Zmk5omA5pyJ5Zue6KaGXG4gICAgYXdhaXQgQ29tbWVudC51cGRhdGVNYW55KFxuICAgICAgeyBwYXJlbnRJZDogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKGNvbW1lbnRJZCkgfSxcbiAgICAgIHtcbiAgICAgICAgaXNEZWxldGVkOiB0cnVlLFxuICAgICAgICBkZWxldGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIGRlbGV0ZWRCeTogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHVzZXJJZClcbiAgICAgIH1cbiAgICApO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICog6IiJ5aCx55WZ6KiAXG4gICAqL1xuICBhc3luYyByZXBvcnRDb21tZW50KGNvbW1lbnRJZDogc3RyaW5nLCByZXBvcnRlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAoIW1vbmdvb3NlLlR5cGVzLk9iamVjdElkLmlzVmFsaWQoY29tbWVudElkKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCfnhKHmlYjnmoTnlZnoqIBJRCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbW1lbnQgPSBhd2FpdCBDb21tZW50LmZpbmRCeUlkKGNvbW1lbnRJZCk7XG4gICAgaWYgKCFjb21tZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+eVmeiogOS4jeWtmOWcqCcpO1xuICAgIH1cblxuICAgIC8vIOWinuWKoOiIieWgseasoeaVuFxuICAgIGF3YWl0IENvbW1lbnQuZmluZEJ5SWRBbmRVcGRhdGUoY29tbWVudElkLCB7XG4gICAgICAkaW5jOiB7IHJlcG9ydENvdW50OiAxIH1cbiAgICB9KTtcblxuICAgIC8vIOWmguaenOiIieWgseasoeaVuOi2hemBjumWvuWAvO+8jOiHquWLlemaseiXj1xuICAgIGNvbnN0IHVwZGF0ZWRDb21tZW50ID0gYXdhaXQgQ29tbWVudC5maW5kQnlJZChjb21tZW50SWQpO1xuICAgIGlmICh1cGRhdGVkQ29tbWVudCAmJiB1cGRhdGVkQ29tbWVudC5yZXBvcnRDb3VudCA+PSA1KSB7XG4gICAgICBhd2FpdCBDb21tZW50LmZpbmRCeUlkQW5kVXBkYXRlKGNvbW1lbnRJZCwge1xuICAgICAgICBpc0hpZGRlbjogdHJ1ZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICog542y5Y+W55So5oi255WZ6KiA57Wx6KiIXG4gICAqL1xuICBhc3luYyBnZXRVc2VyQ29tbWVudFN0YXRzKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx7XG4gICAgdG90YWxDb21tZW50czogbnVtYmVyO1xuICAgIHRvdGFsUmVwbGllczogbnVtYmVyO1xuICAgIHJlY2VudENvbW1lbnRzOiBJQ29tbWVudFtdO1xuICB9PiB7XG4gICAgaWYgKCFtb25nb29zZS5UeXBlcy5PYmplY3RJZC5pc1ZhbGlkKHVzZXJJZCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign54Sh5pWI55qE55So5oi2SUQnKTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VyT2JqZWN0SWQgPSBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKTtcblxuICAgIGNvbnN0IFt0b3RhbENvbW1lbnRzLCB0b3RhbFJlcGxpZXMsIHJlY2VudENvbW1lbnRzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIENvbW1lbnQuY291bnREb2N1bWVudHMoeyB1c2VySWQ6IHVzZXJPYmplY3RJZCwgcGFyZW50SWQ6IG51bGwgfSksXG4gICAgICBDb21tZW50LmNvdW50RG9jdW1lbnRzKHsgdXNlcklkOiB1c2VyT2JqZWN0SWQsIHBhcmVudElkOiB7ICRuZTogbnVsbCB9IH0pLFxuICAgICAgQ29tbWVudC5maW5kKHsgdXNlcklkOiB1c2VyT2JqZWN0SWQgfSlcbiAgICAgICAgLnBvcHVsYXRlKCdwZXRJZCcsICduYW1lIGltYWdlcycpXG4gICAgICAgIC5zb3J0KHsgY3JlYXRlZEF0OiAtMSB9KVxuICAgICAgICAubGltaXQoNSlcbiAgICAgICAgLmxlYW4oKVxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsQ29tbWVudHMsXG4gICAgICB0b3RhbFJlcGxpZXMsXG4gICAgICByZWNlbnRDb21tZW50c1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICog55m86YCB55WZ6KiA6YCa55+lXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHNlbmRDb21tZW50Tm90aWZpY2F0aW9uKGNvbW1lbnQ6IElDb21tZW50LCBwZXQ6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyDpgJrnn6Xlr7XniankuLvkurpcbiAgICAgIGlmIChwZXQudXNlcklkLnRvU3RyaW5nKCkgIT09IGNvbW1lbnQudXNlcklkLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5zZW5kTm90aWZpY2F0aW9uKHtcbiAgICAgICAgICB1c2VySWQ6IHBldC51c2VySWQudG9TdHJpbmcoKSxcbiAgICAgICAgICB0eXBlOiBOb3RpZmljYXRpb25UeXBlLkNPTU1FTlQsXG4gICAgICAgICAgdGl0bGU6ICfmlrDnlZnoqIDpgJrnn6UnLFxuICAgICAgICAgIG1lc3NhZ2U6IGDmnInkurrlnKjmgqjnmoTlr7XnianjgIwke3BldC5uYW1lfeOAjemggemdoueVmeiogOS6hmAsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgcGV0SWQ6IHBldC5faWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGNvbW1lbnRJZDogY29tbWVudC5faWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGNvbW1lbnRlcklkOiBjb21tZW50LnVzZXJJZC50b1N0cmluZygpXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8g5aaC5p6c5piv5Zue6KaG77yM6YCa55+l6KKr5Zue6KaG55qE55So5oi2XG4gICAgICBpZiAoY29tbWVudC5wYXJlbnRJZCkge1xuICAgICAgICBjb25zdCBwYXJlbnRDb21tZW50ID0gYXdhaXQgQ29tbWVudC5maW5kQnlJZChjb21tZW50LnBhcmVudElkKTtcbiAgICAgICAgaWYgKHBhcmVudENvbW1lbnQgJiYgcGFyZW50Q29tbWVudC51c2VySWQudG9TdHJpbmcoKSAhPT0gY29tbWVudC51c2VySWQudG9TdHJpbmcoKSkge1xuICAgICAgICAgIGF3YWl0IE5vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZE5vdGlmaWNhdGlvbih7XG4gICAgICAgICAgICB1c2VySWQ6IHBhcmVudENvbW1lbnQudXNlcklkLnRvU3RyaW5nKCksXG4gICAgICAgICAgICB0eXBlOiBOb3RpZmljYXRpb25UeXBlLlJFUExZLFxuICAgICAgICAgICAgdGl0bGU6ICfnlZnoqIDlm57opobpgJrnn6UnLFxuICAgICAgICAgICAgbWVzc2FnZTogYOacieS6uuWbnuimhuS6huaCqOeahOeVmeiogGAsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIHBldElkOiBwZXQuX2lkLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgIGNvbW1lbnRJZDogY29tbWVudC5faWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgcGFyZW50Q29tbWVudElkOiBwYXJlbnRDb21tZW50Ll9pZC50b1N0cmluZygpLFxuICAgICAgICAgICAgICByZXBsaWVySWQ6IGNvbW1lbnQudXNlcklkLnRvU3RyaW5nKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfnmbzpgIHnlZnoqIDpgJrnn6XlpLHmlZc6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY29uc3QgY29tbWVudFNlcnZpY2UgPSBuZXcgQ29tbWVudFNlcnZpY2UoKTsiXSwidmVyc2lvbiI6M30=