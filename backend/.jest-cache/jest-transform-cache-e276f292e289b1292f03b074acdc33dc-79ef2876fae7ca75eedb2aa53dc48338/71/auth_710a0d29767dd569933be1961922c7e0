9e2dad182e414db510a0606bb333ce1c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.authRoutes = void 0;
const express_1 = require("express");
const logger_1 = require("../utils/logger");
const errors_1 = require("../utils/errors");
const response_1 = require("../utils/response");
const validation_1 = require("../utils/validation");
const auth_1 = require("../schemas/auth");
const userService_1 = require("../services/userService");
const emailService_1 = require("../services/emailService");
const verificationService_1 = require("../services/verificationService");
const auth_2 = require("../middleware/auth");
const rbac_1 = require("../middleware/rbac");
const error_handler_1 = require("../middleware/error-handler");
const router = (0, express_1.Router)();
exports.authRoutes = router;
const userService = new userService_1.UserService();
// 用戶註冊
router.post('/register', (0, validation_1.validateRequest)(auth_1.userRegistrationSchema), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { email, password, name, phone } = req.body;
    const userData = { email, password, name, phone };
    // 註冊用戶（UserService 內部會檢查電子郵件是否已存在）
    const result = await userService.registerUser(userData);
    logger_1.logger.info('用戶註冊成功', { email, name, userId: result.user._id });
    response_1.ResponseUtil.created(res, {
        user: {
            id: result.user._id,
            email: result.user.email,
            name: result.user.name,
            isEmailVerified: result.user.isEmailVerified,
        },
    }, '註冊成功，請檢查您的電子郵件以驗證帳號');
}));
// 用戶登入
router.post('/login', (0, validation_1.validateRequest)(auth_1.userLoginSchema), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { email, password } = req.body;
    const loginData = { email, password };
    // 用戶登入
    const { user, token } = await userService.loginUser(loginData);
    logger_1.logger.info('用戶登入成功', { email, userId: user._id });
    response_1.ResponseUtil.success(res, {
        user: {
            id: user._id,
            email: user.email,
            name: user.name,
            phone: user.phone,
            avatar: user.avatar,
            role: user.role,
            isEmailVerified: user.isEmailVerified,
            lastLoginAt: user.lastLoginAt,
        },
        token,
    }, '登入成功');
}));
// 用戶登出
router.post('/logout', auth_2.authenticate, (0, error_handler_1.asyncHandler)(async (req, res) => {
    const userId = req.user?._id?.toString();
    // TODO: 實作令牌黑名單機制（可選）
    // 目前採用客戶端刪除令牌的方式
    logger_1.logger.info('用戶登出成功', { userId });
    response_1.ResponseUtil.success(res, null, '登出成功');
}));
// 刷新令牌
router.post('/refresh', auth_2.authenticate, (0, error_handler_1.asyncHandler)(async (req, res) => {
    const userId = req.user?._id?.toString();
    if (!userId) {
        throw errors_1.ErrorFactory.createAuthenticationError('invalid_token');
    }
    // 獲取用戶資料
    const user = await userService.getUserById(userId);
    if (!user) {
        throw errors_1.ErrorFactory.createNotFoundError('用戶', userId);
    }
    // 生成新令牌
    const newToken = user.generateAuthToken();
    logger_1.logger.info('令牌刷新成功', { userId });
    response_1.ResponseUtil.success(res, {
        token: newToken,
        user: {
            id: user._id,
            email: user.email,
            name: user.name,
            phone: user.phone,
            avatar: user.avatar,
            role: user.role,
            isEmailVerified: user.isEmailVerified,
        },
    }, '令牌刷新成功');
}));
// 忘記密碼
router.post('/forgot-password', (0, validation_1.validateRequest)(auth_1.forgotPasswordSchema), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { email } = req.body;
    // 查找用戶
    const user = await userService.getUserByEmail(email);
    if (!user) {
        // 為了安全考量，即使用戶不存在也返回成功訊息
        response_1.ResponseUtil.success(res, null, '如果該電子郵件地址存在於我們的系統中，您將收到密碼重設郵件');
        return;
    }
    // 生成密碼重設令牌
    const resetToken = user.generatePasswordResetToken();
    await user.save();
    // 發送密碼重設郵件
    await emailService_1.EmailService.sendPasswordResetEmail(user.email, resetToken, user.name);
    logger_1.logger.info('密碼重設郵件已發送', { email, userId: user._id });
    response_1.ResponseUtil.success(res, null, '密碼重設郵件已發送，請檢查您的電子郵件');
}));
// 重設密碼
router.post('/reset-password', (0, validation_1.validateRequest)(auth_1.passwordResetSchema), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { token, newPassword } = req.body;
    // 重設密碼
    await userService.resetPassword(token, newPassword);
    logger_1.logger.info('密碼重設成功');
    response_1.ResponseUtil.success(res, null, '密碼重設成功，請使用新密碼登入');
}));
// 獲取當前用戶資訊
router.get('/me', auth_2.authenticate, (0, error_handler_1.asyncHandler)(async (req, res) => {
    const userId = req.user?._id.toString();
    if (!userId) {
        throw errors_1.ErrorFactory.createAuthenticationError('invalid_token');
    }
    // 獲取用戶資訊
    const user = await userService.getUserById(userId);
    if (!user) {
        throw errors_1.ErrorFactory.createNotFoundError('用戶', userId);
    }
    logger_1.logger.info('獲取用戶資訊成功', { userId });
    response_1.ResponseUtil.success(res, {
        user: {
            id: user._id,
            email: user.email,
            name: user.name,
            phone: user.phone,
            avatar: user.avatar,
            role: user.role,
            isEmailVerified: user.isEmailVerified,
            createdAt: user.createdAt,
            updatedAt: user.updatedAt,
            lastLoginAt: user.lastLoginAt,
        },
    });
}));
// 電子郵件驗證
router.get('/verify-email/:token', (0, validation_1.validateParams)(auth_1.verifyEmailParamsSchema), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { token } = req.params;
    // 使用新的驗證服務
    const result = await verificationService_1.VerificationService.verifyEmailToken(token);
    if (result.success) {
        logger_1.logger.info('電子郵件驗證成功', { token });
        response_1.ResponseUtil.success(res, result.user ? {
            user: {
                id: result.user._id,
                email: result.user.email,
                name: result.user.name,
                isEmailVerified: result.user.isEmailVerified,
            },
        } : null, result.message);
    }
    else {
        throw errors_1.ErrorFactory.createValidationError(result.message);
    }
}));
// 重新發送驗證郵件（需要登入）
router.post('/resend-verification', auth_2.authenticate, rbac_1.requireActiveAccount, (0, error_handler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    // 使用新的驗證服務
    const result = await verificationService_1.VerificationService.resendVerificationEmail(user.email);
    if (result.success) {
        logger_1.logger.info('重新發送驗證郵件成功', { userId: user._id, email: user.email });
        response_1.ResponseUtil.success(res, null, result.message);
    }
    else {
        throw errors_1.ErrorFactory.createValidationError(result.message, {
            cooldownRemaining: result.cooldownRemaining,
        });
    }
}));
// 重新發送驗證郵件
router.post('/resend-verification', (0, validation_1.validateRequest)(auth_1.resendVerificationEmailSchema), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { email } = req.body;
    // 使用新的驗證服務
    const result = await verificationService_1.VerificationService.resendVerificationEmail(email);
    if (result.success) {
        logger_1.logger.info('重新發送驗證郵件成功', { email });
        response_1.ResponseUtil.success(res, null, result.message);
    }
    else {
        throw errors_1.ErrorFactory.createValidationError(result.message, {
            cooldownRemaining: result.cooldownRemaining,
        });
    }
}));
// 檢查驗證狀態
router.get('/verification-status', auth_2.authenticate, rbac_1.requireActiveAccount, (0, error_handler_1.asyncHandler)(async (req, res) => {
    const user = req.user;
    const status = await verificationService_1.VerificationService.checkVerificationStatus(user);
    response_1.ResponseUtil.success(res, {
        needsVerification: status.needsVerification,
        hasValidToken: status.hasValidToken,
        tokenExpiry: status.tokenExpiry,
        isEmailVerified: user.isEmailVerified,
    });
}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcYXV0aC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBb0Q7QUFDcEQsNENBQXlDO0FBQ3pDLDRDQUErQztBQUMvQyxnREFBaUQ7QUFDakQsb0RBQXNFO0FBQ3RFLDBDQU95QjtBQUN6Qix5REFBc0Q7QUFDdEQsMkRBQXdEO0FBQ3hELHlFQUFzRTtBQUN0RSw2Q0FBa0Q7QUFDbEQsNkNBQW9GO0FBRXBGLCtEQUEyRDtBQUUzRCxNQUFNLE1BQU0sR0FBRyxJQUFBLGdCQUFNLEdBQUUsQ0FBQztBQWlSTCw0QkFBVTtBQWhSN0IsTUFBTSxXQUFXLEdBQUcsSUFBSSx5QkFBVyxFQUFFLENBQUM7QUFFdEMsT0FBTztBQUNQLE1BQU0sQ0FBQyxJQUFJLENBQ1QsV0FBVyxFQUNYLElBQUEsNEJBQWUsRUFBQyw2QkFBc0IsQ0FBQyxFQUN2QyxJQUFBLDRCQUFZLEVBQUMsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQWlCLEVBQUU7SUFDaEUsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFDbEQsTUFBTSxRQUFRLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUVsRCxtQ0FBbUM7SUFDbkMsTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRXhELGVBQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBRWhFLHVCQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRTtRQUN4QixJQUFJLEVBQUU7WUFDSixFQUFF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U0FBUztBQUNULE1BQU0sQ0FBQyxHQUFHLENBQ1Isc0JBQXNCLEVBQ3RCLG1CQUFZLEVBQ1osMkJBQW9CLEVBQ3BCLElBQUEsNEJBQVksRUFBQyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBaUIsRUFBRTtJQUNoRSxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsSUFBYSxDQUFDO0lBRS9CLE1BQU0sTUFBTSxHQUFHLE1BQU0seUNBQW1CLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFdkUsdUJBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFO1FBQ3hCLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxpQkFBaUI7UUFDM0MsYUFBYSxFQUFFLE1BQU0sQ0FBQyxhQUFhO1FBQ25DLFdBQVcsRUFBRSxNQUFNLENBQUMsV0FBVztRQUMvQixlQUFlLEVBQUUsSUFBSSxDQUFDLGVBQWU7S0FDdEMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccm91dGVzXFxhdXRoLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBFcnJvckZhY3RvcnkgfSBmcm9tICcuLi91dGlscy9lcnJvcnMnO1xuaW1wb3J0IHsgUmVzcG9uc2VVdGlsIH0gZnJvbSAnLi4vdXRpbHMvcmVzcG9uc2UnO1xuaW1wb3J0IHsgdmFsaWRhdGVSZXF1ZXN0LCB2YWxpZGF0ZVBhcmFtcyB9IGZyb20gJy4uL3V0aWxzL3ZhbGlkYXRpb24nO1xuaW1wb3J0IHsgXG4gIHVzZXJSZWdpc3RyYXRpb25TY2hlbWEsXG4gIHVzZXJMb2dpblNjaGVtYSxcbiAgZm9yZ290UGFzc3dvcmRTY2hlbWEsXG4gIHBhc3N3b3JkUmVzZXRTY2hlbWEsXG4gIHZlcmlmeUVtYWlsUGFyYW1zU2NoZW1hLFxuICByZXNlbmRWZXJpZmljYXRpb25FbWFpbFNjaGVtYVxufSBmcm9tICcuLi9zY2hlbWFzL2F1dGgnO1xuaW1wb3J0IHsgVXNlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy91c2VyU2VydmljZSc7XG5pbXBvcnQgeyBFbWFpbFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9lbWFpbFNlcnZpY2UnO1xuaW1wb3J0IHsgVmVyaWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3ZlcmlmaWNhdGlvblNlcnZpY2UnO1xuaW1wb3J0IHsgYXV0aGVudGljYXRlIH0gZnJvbSAnLi4vbWlkZGxld2FyZS9hdXRoJztcbmltcG9ydCB7IHJlcXVpcmVBY3RpdmVBY2NvdW50LCByZXF1aXJlRW1haWxWZXJpZmljYXRpb24gfSBmcm9tICcuLi9taWRkbGV3YXJlL3JiYWMnO1xuaW1wb3J0IHsgSVVzZXIgfSBmcm9tICcuLi9tb2RlbHMvVXNlcic7XG5pbXBvcnQgeyBhc3luY0hhbmRsZXIgfSBmcm9tICcuLi9taWRkbGV3YXJlL2Vycm9yLWhhbmRsZXInO1xuXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcbmNvbnN0IHVzZXJTZXJ2aWNlID0gbmV3IFVzZXJTZXJ2aWNlKCk7XG5cbi8vIOeUqOaItuiou+WGilxucm91dGVyLnBvc3QoXG4gICcvcmVnaXN0ZXInLFxuICB2YWxpZGF0ZVJlcXVlc3QodXNlclJlZ2lzdHJhdGlvblNjaGVtYSksXG4gIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIG5hbWUsIHBob25lIH0gPSByZXEuYm9keTtcbiAgICBjb25zdCB1c2VyRGF0YSA9IHsgZW1haWwsIHBhc3N3b3JkLCBuYW1lLCBwaG9uZSB9O1xuXG4gICAgLy8g6Ki75YaK55So5oi277yIVXNlclNlcnZpY2Ug5YWn6YOo5pyD5qqi5p+l6Zu75a2Q6YO15Lu25piv5ZCm5bey5a2Y5Zyo77yJXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlclNlcnZpY2UucmVnaXN0ZXJVc2VyKHVzZXJEYXRhKTtcblxuICAgIGxvZ2dlci5pbmZvKCfnlKjmiLboqLvlhormiJDlip8nLCB7IGVtYWlsLCBuYW1lLCB1c2VySWQ6IHJlc3VsdC51c2VyLl9pZCB9KTtcblxuICAgIFJlc3BvbnNlVXRpbC5jcmVhdGVkKHJlcywge1xuICAgICAgdXNlcjoge1xuICAgICAgICBpZDogcmVzdWx0LnVzZXIuX2lkLFxuICAgICAgICBlbWFpbDogcmVzdWx0LnVzZXIuZW1haWwsXG4gICAgICAgIG5hbWU6IHJlc3VsdC51c2VyLm5hbWUsXG4gICAgICAgIGlzRW1haWxWZXJpZmllZDogcmVzdWx0LnVzZXIuaXNFbWFpbFZlcmlmaWVkLFxuICAgICAgfSxcbiAgICB9LCAn6Ki75YaK5oiQ5Yqf77yM6KuL5qqi5p+l5oKo55qE6Zu75a2Q6YO15Lu25Lul6amX6K2J5biz6JmfJyk7XG4gIH0pXG4pO1xuXG4vLyDnlKjmiLbnmbvlhaVcbnJvdXRlci5wb3N0KFxuICAnL2xvZ2luJyxcbiAgdmFsaWRhdGVSZXF1ZXN0KHVzZXJMb2dpblNjaGVtYSksXG4gIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQgfSA9IHJlcS5ib2R5O1xuICAgIGNvbnN0IGxvZ2luRGF0YSA9IHsgZW1haWwsIHBhc3N3b3JkIH07XG5cbiAgICAvLyDnlKjmiLbnmbvlhaVcbiAgICBjb25zdCB7IHVzZXIsIHRva2VuIH0gPSBhd2FpdCB1c2VyU2VydmljZS5sb2dpblVzZXIobG9naW5EYXRhKTtcblxuICAgIGxvZ2dlci5pbmZvKCfnlKjmiLbnmbvlhaXmiJDlip8nLCB7IGVtYWlsLCB1c2VySWQ6IHVzZXIuX2lkIH0pO1xuXG4gICAgUmVzcG9uc2VVdGlsLnN1Y2Nlc3MocmVzLCB7XG4gICAgICB1c2VyOiB7XG4gICAgICAgIGlkOiB1c2VyLl9pZCxcbiAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgIG5hbWU6IHVzZXIubmFtZSxcbiAgICAgICAgcGhvbmU6IHVzZXIucGhvbmUsXG4gICAgICAgIGF2YXRhcjogdXNlci5hdmF0YXIsXG4gICAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgICAgaXNFbWFpbFZlcmlmaWVkOiB1c2VyLmlzRW1haWxWZXJpZmllZCxcbiAgICAgICAgbGFzdExvZ2luQXQ6IHVzZXIubGFzdExvZ2luQXQsXG4gICAgICB9LFxuICAgICAgdG9rZW4sXG4gICAgfSwgJ+eZu+WFpeaIkOWKnycpO1xuICB9KVxuKTtcblxuLy8g55So5oi255m75Ye6XG5yb3V0ZXIucG9zdCgnL2xvZ291dCcsIGF1dGhlbnRpY2F0ZSwgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgY29uc3QgdXNlcklkID0gKHJlcS51c2VyIGFzIElVc2VyKT8uX2lkPy50b1N0cmluZygpO1xuICBcbiAgLy8gVE9ETzog5a+m5L2c5Luk54mM6buR5ZCN5Zau5qmf5Yi277yI5Y+v6YG477yJXG4gIC8vIOebruWJjeaOoeeUqOWuouaItuerr+WIqumZpOS7pOeJjOeahOaWueW8j1xuXG4gIGxvZ2dlci5pbmZvKCfnlKjmiLbnmbvlh7rmiJDlip8nLCB7IHVzZXJJZCB9KTtcblxuICBSZXNwb25zZVV0aWwuc3VjY2VzcyhyZXMsIG51bGwsICfnmbvlh7rmiJDlip8nKTtcbn0pKTtcblxuLy8g5Yi35paw5Luk54mMXG5yb3V0ZXIucG9zdCgnL3JlZnJlc2gnLCBhdXRoZW50aWNhdGUsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnN0IHVzZXJJZCA9IChyZXEudXNlciBhcyBJVXNlcik/Ll9pZD8udG9TdHJpbmcoKTtcbiAgXG4gIGlmICghdXNlcklkKSB7XG4gICAgdGhyb3cgRXJyb3JGYWN0b3J5LmNyZWF0ZUF1dGhlbnRpY2F0aW9uRXJyb3IoJ2ludmFsaWRfdG9rZW4nKTtcbiAgfVxuXG4gIC8vIOeNsuWPlueUqOaItuizh+aWmVxuICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0VXNlckJ5SWQodXNlcklkKTtcbiAgaWYgKCF1c2VyKSB7XG4gICAgdGhyb3cgRXJyb3JGYWN0b3J5LmNyZWF0ZU5vdEZvdW5kRXJyb3IoJ+eUqOaIticsIHVzZXJJZCk7XG4gIH1cblxuICAvLyDnlJ/miJDmlrDku6TniYxcbiAgY29uc3QgbmV3VG9rZW4gPSB1c2VyLmdlbmVyYXRlQXV0aFRva2VuKCk7XG5cbiAgbG9nZ2VyLmluZm8oJ+S7pOeJjOWIt+aWsOaIkOWKnycsIHsgdXNlcklkIH0pO1xuXG4gIFJlc3BvbnNlVXRpbC5zdWNjZXNzKHJlcywge1xuICAgIHRva2VuOiBuZXdUb2tlbixcbiAgICB1c2VyOiB7XG4gICAgICBpZDogdXNlci5faWQsXG4gICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICAgIG5hbWU6IHVzZXIubmFtZSxcbiAgICAgIHBob25lOiB1c2VyLnBob25lLFxuICAgICAgYXZhdGFyOiB1c2VyLmF2YXRhcixcbiAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgIGlzRW1haWxWZXJpZmllZDogdXNlci5pc0VtYWlsVmVyaWZpZWQsXG4gICAgfSxcbiAgfSwgJ+S7pOeJjOWIt+aWsOaIkOWKnycpO1xufSkpO1xuXG4vLyDlv5joqJjlr4bnorxcbnJvdXRlci5wb3N0KFxuICAnL2ZvcmdvdC1wYXNzd29yZCcsXG4gIHZhbGlkYXRlUmVxdWVzdChmb3Jnb3RQYXNzd29yZFNjaGVtYSksXG4gIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgeyBlbWFpbCB9ID0gcmVxLmJvZHk7XG5cbiAgICAvLyDmn6Xmib7nlKjmiLZcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICAgIGlmICghdXNlcikge1xuICAgICAgLy8g54K65LqG5a6J5YWo6ICD6YeP77yM5Y2z5L2/55So5oi25LiN5a2Y5Zyo5Lmf6L+U5Zue5oiQ5Yqf6KiK5oGvXG4gICAgICBSZXNwb25zZVV0aWwuc3VjY2VzcyhyZXMsIG51bGwsICflpoLmnpzoqbLpm7vlrZDpg7Xku7blnLDlnYDlrZjlnKjmlrzmiJHlgJHnmoTns7vntbHkuK3vvIzmgqjlsIfmlLbliLDlr4bnorzph43oqK3pg7Xku7YnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyDnlJ/miJDlr4bnorzph43oqK3ku6TniYxcbiAgICBjb25zdCByZXNldFRva2VuID0gdXNlci5nZW5lcmF0ZVBhc3N3b3JkUmVzZXRUb2tlbigpO1xuICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuXG4gICAgLy8g55m86YCB5a+G56K86YeN6Kit6YO15Lu2XG4gICAgYXdhaXQgRW1haWxTZXJ2aWNlLnNlbmRQYXNzd29yZFJlc2V0RW1haWwoXG4gICAgICB1c2VyLmVtYWlsLFxuICAgICAgcmVzZXRUb2tlbixcbiAgICAgIHVzZXIubmFtZVxuICAgICk7XG5cbiAgICBsb2dnZXIuaW5mbygn5a+G56K86YeN6Kit6YO15Lu25bey55m86YCBJywgeyBlbWFpbCwgdXNlcklkOiB1c2VyLl9pZCB9KTtcblxuICAgIFJlc3BvbnNlVXRpbC5zdWNjZXNzKHJlcywgbnVsbCwgJ+WvhueivOmHjeioremDteS7tuW3sueZvOmAge+8jOiri+aqouafpeaCqOeahOmbu+WtkOmDteS7ticpO1xuICB9KVxuKTtcblxuLy8g6YeN6Kit5a+G56K8XG5yb3V0ZXIucG9zdChcbiAgJy9yZXNldC1wYXNzd29yZCcsXG4gIHZhbGlkYXRlUmVxdWVzdChwYXNzd29yZFJlc2V0U2NoZW1hKSxcbiAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCB7IHRva2VuLCBuZXdQYXNzd29yZCB9ID0gcmVxLmJvZHk7XG5cbiAgICAvLyDph43oqK3lr4bnorxcbiAgICBhd2FpdCB1c2VyU2VydmljZS5yZXNldFBhc3N3b3JkKHRva2VuLCBuZXdQYXNzd29yZCk7XG5cbiAgICBsb2dnZXIuaW5mbygn5a+G56K86YeN6Kit5oiQ5YqfJyk7XG5cbiAgICBSZXNwb25zZVV0aWwuc3VjY2VzcyhyZXMsIG51bGwsICflr4bnorzph43oqK3miJDlip/vvIzoq4vkvb/nlKjmlrDlr4bnorznmbvlhaUnKTtcbiAgfSlcbik7XG5cbi8vIOeNsuWPlueVtuWJjeeUqOaItuizh+ioilxucm91dGVyLmdldChcbiAgJy9tZScsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCB1c2VySWQgPSAocmVxLnVzZXIgYXMgSVVzZXIpPy5faWQudG9TdHJpbmcoKTtcbiAgICBcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgdGhyb3cgRXJyb3JGYWN0b3J5LmNyZWF0ZUF1dGhlbnRpY2F0aW9uRXJyb3IoJ2ludmFsaWRfdG9rZW4nKTtcbiAgICB9XG5cbiAgICAvLyDnjbLlj5bnlKjmiLbos4foqIpcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0VXNlckJ5SWQodXNlcklkKTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IEVycm9yRmFjdG9yeS5jcmVhdGVOb3RGb3VuZEVycm9yKCfnlKjmiLYnLCB1c2VySWQpO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKCfnjbLlj5bnlKjmiLbos4foqIrmiJDlip8nLCB7IHVzZXJJZCB9KTtcblxuICAgIFJlc3BvbnNlVXRpbC5zdWNjZXNzKHJlcywge1xuICAgICAgdXNlcjoge1xuICAgICAgICBpZDogdXNlci5faWQsXG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICBuYW1lOiB1c2VyLm5hbWUsXG4gICAgICAgIHBob25lOiB1c2VyLnBob25lLFxuICAgICAgICBhdmF0YXI6IHVzZXIuYXZhdGFyLFxuICAgICAgICByb2xlOiB1c2VyLnJvbGUsXG4gICAgICAgIGlzRW1haWxWZXJpZmllZDogdXNlci5pc0VtYWlsVmVyaWZpZWQsXG4gICAgICAgIGNyZWF0ZWRBdDogdXNlci5jcmVhdGVkQXQsXG4gICAgICAgIHVwZGF0ZWRBdDogdXNlci51cGRhdGVkQXQsXG4gICAgICAgIGxhc3RMb2dpbkF0OiB1c2VyLmxhc3RMb2dpbkF0LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSlcbik7XG5cbi8vIOmbu+WtkOmDteS7tumpl+itiVxucm91dGVyLmdldChcbiAgJy92ZXJpZnktZW1haWwvOnRva2VuJyxcbiAgdmFsaWRhdGVQYXJhbXModmVyaWZ5RW1haWxQYXJhbXNTY2hlbWEpLFxuICBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHsgdG9rZW4gfSA9IHJlcS5wYXJhbXM7XG5cbiAgICAvLyDkvb/nlKjmlrDnmoTpqZforYnmnI3li5lcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBWZXJpZmljYXRpb25TZXJ2aWNlLnZlcmlmeUVtYWlsVG9rZW4odG9rZW4pO1xuXG4gICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBsb2dnZXIuaW5mbygn6Zu75a2Q6YO15Lu26amX6K2J5oiQ5YqfJywgeyB0b2tlbiB9KTtcbiAgICAgIFJlc3BvbnNlVXRpbC5zdWNjZXNzKHJlcywgcmVzdWx0LnVzZXIgPyB7XG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBpZDogcmVzdWx0LnVzZXIuX2lkLFxuICAgICAgICAgIGVtYWlsOiByZXN1bHQudXNlci5lbWFpbCxcbiAgICAgICAgICBuYW1lOiByZXN1bHQudXNlci5uYW1lLFxuICAgICAgICAgIGlzRW1haWxWZXJpZmllZDogcmVzdWx0LnVzZXIuaXNFbWFpbFZlcmlmaWVkLFxuICAgICAgICB9LFxuICAgICAgfSA6IG51bGwsIHJlc3VsdC5tZXNzYWdlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgRXJyb3JGYWN0b3J5LmNyZWF0ZVZhbGlkYXRpb25FcnJvcihyZXN1bHQubWVzc2FnZSk7XG4gICAgfVxuICB9KVxuKTtcblxuLy8g6YeN5paw55m86YCB6amX6K2J6YO15Lu277yI6ZyA6KaB55m75YWl77yJXG5yb3V0ZXIucG9zdChcbiAgJy9yZXNlbmQtdmVyaWZpY2F0aW9uJyxcbiAgYXV0aGVudGljYXRlLFxuICByZXF1aXJlQWN0aXZlQWNjb3VudCxcbiAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCB1c2VyID0gcmVxLnVzZXIgYXMgSVVzZXI7XG4gICAgXG4gICAgLy8g5L2/55So5paw55qE6amX6K2J5pyN5YuZXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgVmVyaWZpY2F0aW9uU2VydmljZS5yZXNlbmRWZXJpZmljYXRpb25FbWFpbCh1c2VyLmVtYWlsKTtcblxuICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgbG9nZ2VyLmluZm8oJ+mHjeaWsOeZvOmAgempl+itiemDteS7tuaIkOWKnycsIHsgdXNlcklkOiB1c2VyLl9pZCwgZW1haWw6IHVzZXIuZW1haWwgfSk7XG4gICAgICBSZXNwb25zZVV0aWwuc3VjY2VzcyhyZXMsIG51bGwsIHJlc3VsdC5tZXNzYWdlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgRXJyb3JGYWN0b3J5LmNyZWF0ZVZhbGlkYXRpb25FcnJvcihyZXN1bHQubWVzc2FnZSwge1xuICAgICAgICBjb29sZG93blJlbWFpbmluZzogcmVzdWx0LmNvb2xkb3duUmVtYWluaW5nLFxuICAgICAgfSk7XG4gICAgfVxuICB9KVxuKTtcblxuLy8g6YeN5paw55m86YCB6amX6K2J6YO15Lu2XG5yb3V0ZXIucG9zdChcbiAgJy9yZXNlbmQtdmVyaWZpY2F0aW9uJyxcbiAgdmFsaWRhdGVSZXF1ZXN0KHJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsU2NoZW1hKSxcbiAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCB7IGVtYWlsIH0gPSByZXEuYm9keTtcblxuICAgIC8vIOS9v+eUqOaWsOeahOmpl+itieacjeWLmVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFZlcmlmaWNhdGlvblNlcnZpY2UucmVzZW5kVmVyaWZpY2F0aW9uRW1haWwoZW1haWwpO1xuXG4gICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBsb2dnZXIuaW5mbygn6YeN5paw55m86YCB6amX6K2J6YO15Lu25oiQ5YqfJywgeyBlbWFpbCB9KTtcbiAgICAgIFJlc3BvbnNlVXRpbC5zdWNjZXNzKHJlcywgbnVsbCwgcmVzdWx0Lm1lc3NhZ2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBFcnJvckZhY3RvcnkuY3JlYXRlVmFsaWRhdGlvbkVycm9yKHJlc3VsdC5tZXNzYWdlLCB7XG4gICAgICAgIGNvb2xkb3duUmVtYWluaW5nOiByZXN1bHQuY29vbGRvd25SZW1haW5pbmcsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pXG4pO1xuXG4vLyDmqqLmn6XpqZforYnni4DmhYtcbnJvdXRlci5nZXQoXG4gICcvdmVyaWZpY2F0aW9uLXN0YXR1cycsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgcmVxdWlyZUFjdGl2ZUFjY291bnQsXG4gIGFzeW5jSGFuZGxlcihhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgdXNlciA9IHJlcS51c2VyIGFzIElVc2VyO1xuICAgIFxuICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IFZlcmlmaWNhdGlvblNlcnZpY2UuY2hlY2tWZXJpZmljYXRpb25TdGF0dXModXNlcik7XG5cbiAgICBSZXNwb25zZVV0aWwuc3VjY2VzcyhyZXMsIHtcbiAgICAgIG5lZWRzVmVyaWZpY2F0aW9uOiBzdGF0dXMubmVlZHNWZXJpZmljYXRpb24sXG4gICAgICBoYXNWYWxpZFRva2VuOiBzdGF0dXMuaGFzVmFsaWRUb2tlbixcbiAgICAgIHRva2VuRXhwaXJ5OiBzdGF0dXMudG9rZW5FeHBpcnksXG4gICAgICBpc0VtYWlsVmVyaWZpZWQ6IHVzZXIuaXNFbWFpbFZlcmlmaWVkLFxuICAgIH0pO1xuICB9KVxuKTtcblxuZXhwb3J0IHsgcm91dGVyIGFzIGF1dGhSb3V0ZXMgfTsiXSwidmVyc2lvbiI6M30=