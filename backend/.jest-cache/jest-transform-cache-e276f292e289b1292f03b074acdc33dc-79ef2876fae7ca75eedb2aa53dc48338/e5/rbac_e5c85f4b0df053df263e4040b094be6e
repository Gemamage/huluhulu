8f5bb81694922bf059cadd47f2c32ad1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ROLE_PERMISSIONS = exports.Permission = void 0;
exports.hasPermission = hasPermission;
exports.hasAnyPermission = hasAnyPermission;
exports.hasAllPermissions = hasAllPermissions;
exports.requirePermission = requirePermission;
exports.requireAnyPermission = requireAnyPermission;
exports.requireAllPermissions = requireAllPermissions;
exports.requireOwnershipOrPermission = requireOwnershipOrPermission;
exports.requireRole = requireRole;
exports.requireActiveAccount = requireActiveAccount;
exports.requireEmailVerification = requireEmailVerification;
exports.requireAuthAndPermission = requireAuthAndPermission;
exports.getUserPermissions = getUserPermissions;
exports.canAccessResource = canAccessResource;
const errors_1 = require("../utils/errors");
// 定義權限枚舉
var Permission;
(function (Permission) {
    // 用戶管理
    Permission["USER_READ"] = "user:read";
    Permission["USER_WRITE"] = "user:write";
    Permission["USER_DELETE"] = "user:delete";
    Permission["USER_ADMIN"] = "user:admin";
    // 寵物管理
    Permission["PET_READ"] = "pet:read";
    Permission["PET_WRITE"] = "pet:write";
    Permission["PET_DELETE"] = "pet:delete";
    Permission["PET_MODERATE"] = "pet:moderate";
    // 案件管理
    Permission["CASE_READ"] = "case:read";
    Permission["CASE_WRITE"] = "case:write";
    Permission["CASE_DELETE"] = "case:delete";
    Permission["CASE_MODERATE"] = "case:moderate";
    // 系統管理
    Permission["SYSTEM_CONFIG"] = "system:config";
    Permission["SYSTEM_LOGS"] = "system:logs";
    Permission["SYSTEM_BACKUP"] = "system:backup";
    // 內容管理
    Permission["CONTENT_MODERATE"] = "content:moderate";
    Permission["CONTENT_DELETE"] = "content:delete";
    // 報告和分析
    Permission["ANALYTICS_READ"] = "analytics:read";
    Permission["REPORTS_GENERATE"] = "reports:generate";
})(Permission || (exports.Permission = Permission = {}));
// 定義角色和對應權限
exports.ROLE_PERMISSIONS = {
    user: [
        Permission.USER_READ,
        Permission.PET_READ,
        Permission.CASE_READ,
        Permission.CASE_WRITE,
    ],
    moderator: [
        Permission.USER_READ,
        Permission.PET_READ,
        Permission.PET_WRITE,
        Permission.PET_MODERATE,
        Permission.CASE_READ,
        Permission.CASE_WRITE,
        Permission.CASE_MODERATE,
        Permission.CONTENT_MODERATE,
    ],
    admin: [
        Permission.USER_READ,
        Permission.USER_WRITE,
        Permission.USER_DELETE,
        Permission.USER_ADMIN,
        Permission.PET_READ,
        Permission.PET_WRITE,
        Permission.PET_DELETE,
        Permission.PET_MODERATE,
        Permission.CASE_READ,
        Permission.CASE_WRITE,
        Permission.CASE_DELETE,
        Permission.CASE_MODERATE,
        Permission.SYSTEM_CONFIG,
        Permission.SYSTEM_LOGS,
        Permission.SYSTEM_BACKUP,
        Permission.CONTENT_MODERATE,
        Permission.CONTENT_DELETE,
        Permission.ANALYTICS_READ,
        Permission.REPORTS_GENERATE,
    ],
};
// 檢查用戶是否有特定權限
function hasPermission(user, permission) {
    const userPermissions = exports.ROLE_PERMISSIONS[user.role] || [];
    return userPermissions.includes(permission);
}
// 檢查用戶是否有任一權限
function hasAnyPermission(user, permissions) {
    return permissions.some((permission) => hasPermission(user, permission));
}
// 檢查用戶是否有所有權限
function hasAllPermissions(user, permissions) {
    return permissions.every((permission) => hasPermission(user, permission));
}
// 權限檢查中介軟體
function requirePermission(permission) {
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError("未授權訪問", 401);
        }
        if (!hasPermission(user, permission)) {
            throw new errors_1.AppError("權限不足", 403);
        }
        next();
    };
}
// 多權限檢查中介軟體（需要任一權限）
function requireAnyPermission(permissions) {
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError("未授權訪問", 401);
        }
        if (!hasAnyPermission(user, permissions)) {
            throw new errors_1.AppError("權限不足", 403);
        }
        next();
    };
}
// 多權限檢查中介軟體（需要所有權限）
function requireAllPermissions(permissions) {
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError("未授權訪問", 401);
        }
        if (!hasAllPermissions(user, permissions)) {
            throw new errors_1.AppError("權限不足", 403);
        }
        next();
    };
}
// 資源擁有者或管理員檢查
function requireOwnershipOrPermission(permission) {
    return (req, res, next) => {
        const user = req.user;
        const resourceUserId = req.params.userId || req.params.id;
        if (!user) {
            throw new errors_1.AppError("未授權訪問", 401);
        }
        // 檢查是否為資源擁有者
        const isOwner = user._id.toString() === resourceUserId;
        // 檢查是否有管理權限
        const hasAdminPermission = hasPermission(user, permission);
        if (!isOwner && !hasAdminPermission) {
            throw new errors_1.AppError("權限不足", 403);
        }
        next();
    };
}
// 角色檢查中介軟體
function requireRole(roles) {
    const allowedRoles = Array.isArray(roles) ? roles : [roles];
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            throw new errors_1.AppError("未授權訪問", 401);
        }
        if (!allowedRoles.includes(user.role)) {
            throw new errors_1.AppError("角色權限不足", 403);
        }
        next();
    };
}
// 帳號狀態檢查中介軟體
function requireActiveAccount(req, res, next) {
    const user = req.user;
    if (!user) {
        throw new errors_1.AppError("未授權訪問", 401);
    }
    if (!user.isActive) {
        throw new errors_1.AppError("帳號已被停用", 403);
    }
    next();
}
// 郵箱驗證檢查中介軟體
function requireEmailVerification(req, res, next) {
    const user = req.user;
    if (!user) {
        throw new errors_1.AppError("未授權訪問", 401);
    }
    if (!user.isEmailVerified) {
        throw new errors_1.AppError("請先驗證您的電子郵件", 403);
    }
    next();
}
// 組合中介軟體：檢查認證、帳號狀態和權限
function requireAuthAndPermission(permission) {
    return [
        requireActiveAccount,
        requireEmailVerification,
        requirePermission(permission),
    ];
}
// 獲取用戶權限列表
function getUserPermissions(user) {
    return exports.ROLE_PERMISSIONS[user.role] || [];
}
// 檢查用戶是否可以訪問資源
function canAccessResource(user, resourceOwnerId, requiredPermission) {
    // 檢查是否為資源擁有者
    if (user._id.toString() === resourceOwnerId) {
        return true;
    }
    // 檢查是否有管理權限
    if (requiredPermission && hasPermission(user, requiredPermission)) {
        return true;
    }
    return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXG1pZGRsZXdhcmVcXHJiYWMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBZ0ZBLHNDQUdDO0FBR0QsNENBS0M7QUFHRCw4Q0FLQztBQUdELDhDQWNDO0FBR0Qsb0RBY0M7QUFHRCxzREFjQztBQUdELG9FQXFCQztBQUdELGtDQWdCQztBQUdELG9EQWdCQztBQUdELDREQWdCQztBQUdELDREQU1DO0FBR0QsZ0RBRUM7QUFHRCw4Q0FnQkM7QUF0UUQsNENBQTJDO0FBRTNDLFNBQVM7QUFDVCxJQUFZLFVBK0JYO0FBL0JELFdBQVksVUFBVTtJQUNwQixPQUFPO0lBQ1AscUNBQXVCLENBQUE7SUFDdkIsdUNBQXlCLENBQUE7SUFDekIseUNBQTJCLENBQUE7SUFDM0IsdUNBQXlCLENBQUE7SUFFekIsT0FBTztJQUNQLG1DQUFxQixDQUFBO0lBQ3JCLHFDQUF1QixDQUFBO0lBQ3ZCLHVDQUF5QixDQUFBO0lBQ3pCLDJDQUE2QixDQUFBO0lBRTdCLE9BQU87SUFDUCxxQ0FBdUIsQ0FBQTtJQUN2Qix1Q0FBeUIsQ0FBQTtJQUN6Qix5Q0FBMkIsQ0FBQTtJQUMzQiw2Q0FBK0IsQ0FBQTtJQUUvQixPQUFPO0lBQ1AsNkNBQStCLENBQUE7SUFDL0IseUNBQTJCLENBQUE7SUFDM0IsNkNBQStCLENBQUE7SUFFL0IsT0FBTztJQUNQLG1EQUFxQyxDQUFBO0lBQ3JDLCtDQUFpQyxDQUFBO0lBRWpDLFFBQVE7SUFDUiwrQ0FBaUMsQ0FBQTtJQUNqQyxtREFBcUMsQ0FBQTtBQUN2QyxDQUFDLEVBL0JXLFVBQVUsMEJBQVYsVUFBVSxRQStCckI7QUFFRCxZQUFZO0FBQ0MsUUFBQSxnQkFBZ0IsR0FBaUM7SUFDNUQsSUFBSSxFQUFFO1FBQ0osVUFBVSxDQUFDLFNBQVM7UUFDcEIsVUFBVSxDQUFDLFFBQVE7UUFDbkIsVUFBVSxDQUFDLFNBQVM7UUFDcEIsVUFBVSxDQUFDLFVBQVU7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LGtCQUFrQixDQUFDLEVBQUUsQ0FBQztRQUNsRSxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXG1pZGRsZXdhcmVcXHJiYWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgeyBJVXNlciB9IGZyb20gXCIuLi9tb2RlbHMvVXNlclwiO1xuaW1wb3J0IHsgQXBwRXJyb3IgfSBmcm9tIFwiLi4vdXRpbHMvZXJyb3JzXCI7XG5cbi8vIOWumue+qeasiumZkOaemuiIiVxuZXhwb3J0IGVudW0gUGVybWlzc2lvbiB7XG4gIC8vIOeUqOaItueuoeeQhlxuICBVU0VSX1JFQUQgPSBcInVzZXI6cmVhZFwiLFxuICBVU0VSX1dSSVRFID0gXCJ1c2VyOndyaXRlXCIsXG4gIFVTRVJfREVMRVRFID0gXCJ1c2VyOmRlbGV0ZVwiLFxuICBVU0VSX0FETUlOID0gXCJ1c2VyOmFkbWluXCIsXG5cbiAgLy8g5a+154mp566h55CGXG4gIFBFVF9SRUFEID0gXCJwZXQ6cmVhZFwiLFxuICBQRVRfV1JJVEUgPSBcInBldDp3cml0ZVwiLFxuICBQRVRfREVMRVRFID0gXCJwZXQ6ZGVsZXRlXCIsXG4gIFBFVF9NT0RFUkFURSA9IFwicGV0Om1vZGVyYXRlXCIsXG5cbiAgLy8g5qGI5Lu2566h55CGXG4gIENBU0VfUkVBRCA9IFwiY2FzZTpyZWFkXCIsXG4gIENBU0VfV1JJVEUgPSBcImNhc2U6d3JpdGVcIixcbiAgQ0FTRV9ERUxFVEUgPSBcImNhc2U6ZGVsZXRlXCIsXG4gIENBU0VfTU9ERVJBVEUgPSBcImNhc2U6bW9kZXJhdGVcIixcblxuICAvLyDns7vntbHnrqHnkIZcbiAgU1lTVEVNX0NPTkZJRyA9IFwic3lzdGVtOmNvbmZpZ1wiLFxuICBTWVNURU1fTE9HUyA9IFwic3lzdGVtOmxvZ3NcIixcbiAgU1lTVEVNX0JBQ0tVUCA9IFwic3lzdGVtOmJhY2t1cFwiLFxuXG4gIC8vIOWFp+WuueeuoeeQhlxuICBDT05URU5UX01PREVSQVRFID0gXCJjb250ZW50Om1vZGVyYXRlXCIsXG4gIENPTlRFTlRfREVMRVRFID0gXCJjb250ZW50OmRlbGV0ZVwiLFxuXG4gIC8vIOWgseWRiuWSjOWIhuaekFxuICBBTkFMWVRJQ1NfUkVBRCA9IFwiYW5hbHl0aWNzOnJlYWRcIixcbiAgUkVQT1JUU19HRU5FUkFURSA9IFwicmVwb3J0czpnZW5lcmF0ZVwiLFxufVxuXG4vLyDlrprnvqnop5LoibLlkozlsI3mh4nmrIrpmZBcbmV4cG9ydCBjb25zdCBST0xFX1BFUk1JU1NJT05TOiBSZWNvcmQ8c3RyaW5nLCBQZXJtaXNzaW9uW10+ID0ge1xuICB1c2VyOiBbXG4gICAgUGVybWlzc2lvbi5VU0VSX1JFQUQsXG4gICAgUGVybWlzc2lvbi5QRVRfUkVBRCxcbiAgICBQZXJtaXNzaW9uLkNBU0VfUkVBRCxcbiAgICBQZXJtaXNzaW9uLkNBU0VfV1JJVEUsXG4gIF0sXG4gIG1vZGVyYXRvcjogW1xuICAgIFBlcm1pc3Npb24uVVNFUl9SRUFELFxuICAgIFBlcm1pc3Npb24uUEVUX1JFQUQsXG4gICAgUGVybWlzc2lvbi5QRVRfV1JJVEUsXG4gICAgUGVybWlzc2lvbi5QRVRfTU9ERVJBVEUsXG4gICAgUGVybWlzc2lvbi5DQVNFX1JFQUQsXG4gICAgUGVybWlzc2lvbi5DQVNFX1dSSVRFLFxuICAgIFBlcm1pc3Npb24uQ0FTRV9NT0RFUkFURSxcbiAgICBQZXJtaXNzaW9uLkNPTlRFTlRfTU9ERVJBVEUsXG4gIF0sXG4gIGFkbWluOiBbXG4gICAgUGVybWlzc2lvbi5VU0VSX1JFQUQsXG4gICAgUGVybWlzc2lvbi5VU0VSX1dSSVRFLFxuICAgIFBlcm1pc3Npb24uVVNFUl9ERUxFVEUsXG4gICAgUGVybWlzc2lvbi5VU0VSX0FETUlOLFxuICAgIFBlcm1pc3Npb24uUEVUX1JFQUQsXG4gICAgUGVybWlzc2lvbi5QRVRfV1JJVEUsXG4gICAgUGVybWlzc2lvbi5QRVRfREVMRVRFLFxuICAgIFBlcm1pc3Npb24uUEVUX01PREVSQVRFLFxuICAgIFBlcm1pc3Npb24uQ0FTRV9SRUFELFxuICAgIFBlcm1pc3Npb24uQ0FTRV9XUklURSxcbiAgICBQZXJtaXNzaW9uLkNBU0VfREVMRVRFLFxuICAgIFBlcm1pc3Npb24uQ0FTRV9NT0RFUkFURSxcbiAgICBQZXJtaXNzaW9uLlNZU1RFTV9DT05GSUcsXG4gICAgUGVybWlzc2lvbi5TWVNURU1fTE9HUyxcbiAgICBQZXJtaXNzaW9uLlNZU1RFTV9CQUNLVVAsXG4gICAgUGVybWlzc2lvbi5DT05URU5UX01PREVSQVRFLFxuICAgIFBlcm1pc3Npb24uQ09OVEVOVF9ERUxFVEUsXG4gICAgUGVybWlzc2lvbi5BTkFMWVRJQ1NfUkVBRCxcbiAgICBQZXJtaXNzaW9uLlJFUE9SVFNfR0VORVJBVEUsXG4gIF0sXG59O1xuXG4vLyDmqqLmn6XnlKjmiLbmmK/lkKbmnInnibnlrprmrIrpmZBcbmV4cG9ydCBmdW5jdGlvbiBoYXNQZXJtaXNzaW9uKHVzZXI6IElVc2VyLCBwZXJtaXNzaW9uOiBQZXJtaXNzaW9uKTogYm9vbGVhbiB7XG4gIGNvbnN0IHVzZXJQZXJtaXNzaW9ucyA9IFJPTEVfUEVSTUlTU0lPTlNbdXNlci5yb2xlXSB8fCBbXTtcbiAgcmV0dXJuIHVzZXJQZXJtaXNzaW9ucy5pbmNsdWRlcyhwZXJtaXNzaW9uKTtcbn1cblxuLy8g5qqi5p+l55So5oi25piv5ZCm5pyJ5Lu75LiA5qyK6ZmQXG5leHBvcnQgZnVuY3Rpb24gaGFzQW55UGVybWlzc2lvbihcbiAgdXNlcjogSVVzZXIsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uW10sXG4pOiBib29sZWFuIHtcbiAgcmV0dXJuIHBlcm1pc3Npb25zLnNvbWUoKHBlcm1pc3Npb24pID0+IGhhc1Blcm1pc3Npb24odXNlciwgcGVybWlzc2lvbikpO1xufVxuXG4vLyDmqqLmn6XnlKjmiLbmmK/lkKbmnInmiYDmnInmrIrpmZBcbmV4cG9ydCBmdW5jdGlvbiBoYXNBbGxQZXJtaXNzaW9ucyhcbiAgdXNlcjogSVVzZXIsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uW10sXG4pOiBib29sZWFuIHtcbiAgcmV0dXJuIHBlcm1pc3Npb25zLmV2ZXJ5KChwZXJtaXNzaW9uKSA9PiBoYXNQZXJtaXNzaW9uKHVzZXIsIHBlcm1pc3Npb24pKTtcbn1cblxuLy8g5qyK6ZmQ5qqi5p+l5Lit5LuL6Luf6auUXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZVBlcm1pc3Npb24ocGVybWlzc2lvbjogUGVybWlzc2lvbikge1xuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgY29uc3QgdXNlciA9IHJlcS51c2VyIGFzIElVc2VyO1xuXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLmnKrmjojmrIroqKrllY9cIiwgNDAxKTtcbiAgICB9XG5cbiAgICBpZiAoIWhhc1Blcm1pc3Npb24odXNlciwgcGVybWlzc2lvbikpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcihcIuasiumZkOS4jei2s1wiLCA0MDMpO1xuICAgIH1cblxuICAgIG5leHQoKTtcbiAgfTtcbn1cblxuLy8g5aSa5qyK6ZmQ5qqi5p+l5Lit5LuL6Luf6auU77yI6ZyA6KaB5Lu75LiA5qyK6ZmQ77yJXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZUFueVBlcm1pc3Npb24ocGVybWlzc2lvbnM6IFBlcm1pc3Npb25bXSkge1xuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgY29uc3QgdXNlciA9IHJlcS51c2VyIGFzIElVc2VyO1xuXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLmnKrmjojmrIroqKrllY9cIiwgNDAxKTtcbiAgICB9XG5cbiAgICBpZiAoIWhhc0FueVBlcm1pc3Npb24odXNlciwgcGVybWlzc2lvbnMpKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLmrIrpmZDkuI3otrNcIiwgNDAzKTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIOWkmuasiumZkOaqouafpeS4reS7i+i7n+mrlO+8iOmcgOimgeaJgOacieasiumZkO+8iVxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVBbGxQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbltdKSB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkID0+IHtcbiAgICBjb25zdCB1c2VyID0gcmVxLnVzZXIgYXMgSVVzZXI7XG5cbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBBcHBFcnJvcihcIuacquaOiOasiuioquWVj1wiLCA0MDEpO1xuICAgIH1cblxuICAgIGlmICghaGFzQWxsUGVybWlzc2lvbnModXNlciwgcGVybWlzc2lvbnMpKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLmrIrpmZDkuI3otrNcIiwgNDAzKTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIOizh+a6kOaTgeacieiAheaIlueuoeeQhuWToeaqouafpVxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVPd25lcnNoaXBPclBlcm1pc3Npb24ocGVybWlzc2lvbjogUGVybWlzc2lvbikge1xuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgY29uc3QgdXNlciA9IHJlcS51c2VyIGFzIElVc2VyO1xuICAgIGNvbnN0IHJlc291cmNlVXNlcklkID0gcmVxLnBhcmFtcy51c2VySWQgfHwgcmVxLnBhcmFtcy5pZDtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IEFwcEVycm9yKFwi5pyq5o6I5qyK6Kiq5ZWPXCIsIDQwMSk7XG4gICAgfVxuXG4gICAgLy8g5qqi5p+l5piv5ZCm54K66LOH5rqQ5pOB5pyJ6ICFXG4gICAgY29uc3QgaXNPd25lciA9IHVzZXIuX2lkLnRvU3RyaW5nKCkgPT09IHJlc291cmNlVXNlcklkO1xuXG4gICAgLy8g5qqi5p+l5piv5ZCm5pyJ566h55CG5qyK6ZmQXG4gICAgY29uc3QgaGFzQWRtaW5QZXJtaXNzaW9uID0gaGFzUGVybWlzc2lvbih1c2VyLCBwZXJtaXNzaW9uKTtcblxuICAgIGlmICghaXNPd25lciAmJiAhaGFzQWRtaW5QZXJtaXNzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLmrIrpmZDkuI3otrNcIiwgNDAzKTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIOinkuiJsuaqouafpeS4reS7i+i7n+mrlFxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVSb2xlKHJvbGVzOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICBjb25zdCBhbGxvd2VkUm9sZXMgPSBBcnJheS5pc0FycmF5KHJvbGVzKSA/IHJvbGVzIDogW3JvbGVzXTtcblxuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgY29uc3QgdXNlciA9IHJlcS51c2VyIGFzIElVc2VyO1xuXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLmnKrmjojmrIroqKrllY9cIiwgNDAxKTtcbiAgICB9XG5cbiAgICBpZiAoIWFsbG93ZWRSb2xlcy5pbmNsdWRlcyh1c2VyLnJvbGUpKSB7XG4gICAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLop5LoibLmrIrpmZDkuI3otrNcIiwgNDAzKTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIOW4s+iZn+eLgOaFi+aqouafpeS4reS7i+i7n+mrlFxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVBY3RpdmVBY2NvdW50KFxuICByZXE6IFJlcXVlc3QsXG4gIHJlczogUmVzcG9uc2UsXG4gIG5leHQ6IE5leHRGdW5jdGlvbixcbik6IHZvaWQge1xuICBjb25zdCB1c2VyID0gcmVxLnVzZXIgYXMgSVVzZXI7XG5cbiAgaWYgKCF1c2VyKSB7XG4gICAgdGhyb3cgbmV3IEFwcEVycm9yKFwi5pyq5o6I5qyK6Kiq5ZWPXCIsIDQwMSk7XG4gIH1cblxuICBpZiAoIXVzZXIuaXNBY3RpdmUpIHtcbiAgICB0aHJvdyBuZXcgQXBwRXJyb3IoXCLluLPomZ/lt7LooqvlgZznlKhcIiwgNDAzKTtcbiAgfVxuXG4gIG5leHQoKTtcbn1cblxuLy8g6YO1566x6amX6K2J5qqi5p+l5Lit5LuL6Luf6auUXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZUVtYWlsVmVyaWZpY2F0aW9uKFxuICByZXE6IFJlcXVlc3QsXG4gIHJlczogUmVzcG9uc2UsXG4gIG5leHQ6IE5leHRGdW5jdGlvbixcbik6IHZvaWQge1xuICBjb25zdCB1c2VyID0gcmVxLnVzZXIgYXMgSVVzZXI7XG5cbiAgaWYgKCF1c2VyKSB7XG4gICAgdGhyb3cgbmV3IEFwcEVycm9yKFwi5pyq5o6I5qyK6Kiq5ZWPXCIsIDQwMSk7XG4gIH1cblxuICBpZiAoIXVzZXIuaXNFbWFpbFZlcmlmaWVkKSB7XG4gICAgdGhyb3cgbmV3IEFwcEVycm9yKFwi6KuL5YWI6amX6K2J5oKo55qE6Zu75a2Q6YO15Lu2XCIsIDQwMyk7XG4gIH1cblxuICBuZXh0KCk7XG59XG5cbi8vIOe1hOWQiOS4reS7i+i7n+mrlO+8muaqouafpeiqjeitieOAgeW4s+iZn+eLgOaFi+WSjOasiumZkFxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVBdXRoQW5kUGVybWlzc2lvbihwZXJtaXNzaW9uOiBQZXJtaXNzaW9uKSB7XG4gIHJldHVybiBbXG4gICAgcmVxdWlyZUFjdGl2ZUFjY291bnQsXG4gICAgcmVxdWlyZUVtYWlsVmVyaWZpY2F0aW9uLFxuICAgIHJlcXVpcmVQZXJtaXNzaW9uKHBlcm1pc3Npb24pLFxuICBdO1xufVxuXG4vLyDnjbLlj5bnlKjmiLbmrIrpmZDliJfooahcbmV4cG9ydCBmdW5jdGlvbiBnZXRVc2VyUGVybWlzc2lvbnModXNlcjogSVVzZXIpOiBQZXJtaXNzaW9uW10ge1xuICByZXR1cm4gUk9MRV9QRVJNSVNTSU9OU1t1c2VyLnJvbGVdIHx8IFtdO1xufVxuXG4vLyDmqqLmn6XnlKjmiLbmmK/lkKblj6/ku6XoqKrllY/os4fmupBcbmV4cG9ydCBmdW5jdGlvbiBjYW5BY2Nlc3NSZXNvdXJjZShcbiAgdXNlcjogSVVzZXIsXG4gIHJlc291cmNlT3duZXJJZDogc3RyaW5nLFxuICByZXF1aXJlZFBlcm1pc3Npb24/OiBQZXJtaXNzaW9uLFxuKTogYm9vbGVhbiB7XG4gIC8vIOaqouafpeaYr+WQpueCuuizh+a6kOaTgeacieiAhVxuICBpZiAodXNlci5faWQudG9TdHJpbmcoKSA9PT0gcmVzb3VyY2VPd25lcklkKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvLyDmqqLmn6XmmK/lkKbmnInnrqHnkIbmrIrpmZBcbiAgaWYgKHJlcXVpcmVkUGVybWlzc2lvbiAmJiBoYXNQZXJtaXNzaW9uKHVzZXIsIHJlcXVpcmVkUGVybWlzc2lvbikpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==