91041bd206812fa6da0cb17884d9d8ca
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cacheService = exports.CacheService = void 0;
// 快取服務 - 提供請求快取和去重功能
const logger_1 = require("../utils/logger");
class CacheService {
    constructor(config) {
        this.cache = new Map();
        this.pendingRequests = new Map();
        this.cleanupTimer = null;
        this.config = {
            defaultTTL: 5 * 60 * 1000, // 5分鐘
            maxSize: 1000, // 最多1000個快取項目
            cleanupInterval: 60 * 1000, // 每分鐘清理一次
            ...config
        };
        // 啟動定期清理
        this.startCleanup();
    }
    /**
     * 獲取快取服務實例（單例模式）
     */
    static getInstance(config) {
        if (!CacheService.instance) {
            CacheService.instance = new CacheService(config);
        }
        return CacheService.instance;
    }
    /**
     * 生成快取鍵
     */
    generateKey(prefix, params) {
        const paramStr = params.map(p => typeof p === 'object' ? JSON.stringify(p) : String(p)).join('|');
        return `${prefix}:${paramStr}`;
    }
    /**
     * 檢查快取項目是否過期
     */
    isExpired(item) {
        return Date.now() - item.timestamp > item.ttl;
    }
    /**
     * 獲取快取資料
     */
    get(key) {
        const item = this.cache.get(key);
        if (!item) {
            return null;
        }
        if (this.isExpired(item)) {
            this.cache.delete(key);
            return null;
        }
        logger_1.logger.debug(`快取命中: ${key}`);
        return item.data;
    }
    /**
     * 設置快取資料
     */
    set(key, data, ttl) {
        // 檢查快取大小限制
        if (this.cache.size >= this.config.maxSize) {
            this.evictOldest();
        }
        const item = {
            data,
            timestamp: Date.now(),
            ttl: ttl || this.config.defaultTTL
        };
        this.cache.set(key, item);
        logger_1.logger.debug(`快取設置: ${key}`);
    }
    /**
     * 刪除快取項目
     */
    delete(key) {
        const deleted = this.cache.delete(key);
        if (deleted) {
            logger_1.logger.debug(`快取刪除: ${key}`);
        }
        return deleted;
    }
    /**
     * 清空所有快取
     */
    clear() {
        this.cache.clear();
        this.pendingRequests.clear();
        logger_1.logger.info('所有快取已清空');
    }
    /**
     * 帶快取的函數執行（包含請求去重）
     */
    async withCache(cacheKey, asyncFunction, ttl) {
        // 檢查快取
        const cached = this.get(cacheKey);
        if (cached !== null) {
            return cached;
        }
        // 檢查是否有相同的請求正在進行（請求去重）
        const pending = this.pendingRequests.get(cacheKey);
        if (pending) {
            logger_1.logger.debug(`請求去重: ${cacheKey}`);
            return pending.promise;
        }
        // 執行新請求
        const promise = asyncFunction();
        this.pendingRequests.set(cacheKey, {
            promise,
            timestamp: Date.now()
        });
        try {
            const result = await promise;
            // 將結果存入快取
            this.set(cacheKey, result, ttl);
            return result;
        }
        catch (error) {
            logger_1.logger.error(`快取函數執行失敗: ${cacheKey}`, error);
            throw error;
        }
        finally {
            // 清除進行中的請求記錄
            this.pendingRequests.delete(cacheKey);
        }
    }
    /**
     * 批量刪除快取（支援模式匹配）
     */
    deletePattern(pattern) {
        let deletedCount = 0;
        const regex = new RegExp(pattern);
        for (const key of this.cache.keys()) {
            if (regex.test(key)) {
                this.cache.delete(key);
                deletedCount++;
            }
        }
        if (deletedCount > 0) {
            logger_1.logger.debug(`批量刪除快取: ${deletedCount} 個項目`);
        }
        return deletedCount;
    }
    /**
     * 移除最舊的快取項目
     */
    evictOldest() {
        let oldestKey = null;
        let oldestTime = Date.now();
        for (const [key, item] of this.cache.entries()) {
            if (item.timestamp < oldestTime) {
                oldestTime = item.timestamp;
                oldestKey = key;
            }
        }
        if (oldestKey) {
            this.cache.delete(oldestKey);
            logger_1.logger.debug(`移除最舊快取: ${oldestKey}`);
        }
    }
    /**
     * 清理過期的快取項目
     */
    cleanup() {
        let cleanedCount = 0;
        const now = Date.now();
        // 清理過期快取
        for (const [key, item] of this.cache.entries()) {
            if (this.isExpired(item)) {
                this.cache.delete(key);
                cleanedCount++;
            }
        }
        // 清理過期的進行中請求（超過5分鐘）
        for (const [key, pending] of this.pendingRequests.entries()) {
            if (now - pending.timestamp > 5 * 60 * 1000) {
                this.pendingRequests.delete(key);
            }
        }
        if (cleanedCount > 0) {
            logger_1.logger.debug(`清理過期快取: ${cleanedCount} 個項目`);
        }
    }
    /**
     * 啟動定期清理
     */
    startCleanup() {
        this.cleanupTimer = setInterval(() => {
            this.cleanup();
        }, this.config.cleanupInterval);
    }
    /**
     * 停止定期清理
     */
    stopCleanup() {
        if (this.cleanupTimer) {
            clearInterval(this.cleanupTimer);
            this.cleanupTimer = null;
        }
    }
    /**
     * 獲取快取統計資訊
     */
    getStats() {
        return {
            cacheSize: this.cache.size,
            pendingRequests: this.pendingRequests.size,
            maxSize: this.config.maxSize,
            defaultTTL: this.config.defaultTTL
        };
    }
}
exports.CacheService = CacheService;
// 預設快取實例
exports.cacheService = CacheService.getInstance();
console.log('✅ CacheService 已載入');
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxjYWNoZVNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUJBQXFCO0FBQ3JCLDRDQUF5QztBQXNCekMsTUFBYSxZQUFZO0lBT3ZCLFlBQW9CLE1BQTZCO1FBTHpDLFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztRQUMxQyxvQkFBZSxHQUFHLElBQUksR0FBRyxFQUErQixDQUFDO1FBRXpELGlCQUFZLEdBQTBCLElBQUksQ0FBQztRQUdqRCxJQUFJLENBQUMsTUFBTSxHQUFHO1lBQ1osVUFBVSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLE1BQU07WUFDakMsT0FBTyxFQUFFLElBQUksRUFBRSxjQUFjO1lBQzdCLGVBQWUsRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLFVBQVU7WUFDdEMsR0FBRyxNQUFNO1NBQ1YsQ0FBQztRQUVGLFNBQVM7UUFDVCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUE2QjtRQUM5QyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzNCLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkQsQ0FBQztRQUNELE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxXQUFXLENBQUMsTUFBYyxFQUFFLE1BQWE7UUFDL0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUM5QixPQUFPLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxD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V0FBVyxFQUFFLENBQUM7QUFFdkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVXNlclxcRGVza3RvcFxcdHJhZXByb2plY3RcXHRlc3QyXFxwZXQtZmluZGVyLWFwcFxcYmFja2VuZFxcc3JjXFxzZXJ2aWNlc1xcY2FjaGVTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOW/q+WPluacjeWLmSAtIOaPkOS+m+iri+axguW/q+WPluWSjOWOu+mHjeWKn+iDvVxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuLy8g5b+r5Y+W6aCF55uu5LuL6Z2iXG5pbnRlcmZhY2UgQ2FjaGVJdGVtPFQ+IHtcbiAgZGF0YTogVDtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIHR0bDogbnVtYmVyOyAvLyDlrZjmtLvmmYLplpPvvIjmr6vnp5LvvIlcbn1cblxuLy8g6YCy6KGM5Lit55qE6KuL5rGC6L+96LmkXG5pbnRlcmZhY2UgUGVuZGluZ1JlcXVlc3Q8VD4ge1xuICBwcm9taXNlOiBQcm9taXNlPFQ+O1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbn1cblxuLy8g5b+r5Y+W6YWN572uXG5pbnRlcmZhY2UgQ2FjaGVDb25maWcge1xuICBkZWZhdWx0VFRMOiBudW1iZXI7IC8vIOmgkOioreW/q+WPluaZgumWk++8iOavq+enku+8iVxuICBtYXhTaXplOiBudW1iZXI7IC8vIOacgOWkp+W/q+WPlumgheebruaVuOmHj1xuICBjbGVhbnVwSW50ZXJ2YWw6IG51bWJlcjsgLy8g5riF55CG6ZaT6ZqU77yI5q+r56eS77yJXG59XG5cbmV4cG9ydCBjbGFzcyBDYWNoZVNlcnZpY2Uge1xuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogQ2FjaGVTZXJ2aWNlO1xuICBwcml2YXRlIGNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIENhY2hlSXRlbTxhbnk+PigpO1xuICBwcml2YXRlIHBlbmRpbmdSZXF1ZXN0cyA9IG5ldyBNYXA8c3RyaW5nLCBQZW5kaW5nUmVxdWVzdDxhbnk+PigpO1xuICBwcml2YXRlIGNvbmZpZzogQ2FjaGVDb25maWc7XG4gIHByaXZhdGUgY2xlYW51cFRpbWVyOiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsO1xuXG4gIHByaXZhdGUgY29uc3RydWN0b3IoY29uZmlnPzogUGFydGlhbDxDYWNoZUNvbmZpZz4pIHtcbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIGRlZmF1bHRUVEw6IDUgKiA2MCAqIDEwMDAsIC8vIDXliIbpkJhcbiAgICAgIG1heFNpemU6IDEwMDAsIC8vIOacgOWkmjEwMDDlgIvlv6vlj5bpoIXnm65cbiAgICAgIGNsZWFudXBJbnRlcnZhbDogNjAgKiAxMDAwLCAvLyDmr4/liIbpkJjmuIXnkIbkuIDmrKFcbiAgICAgIC4uLmNvbmZpZ1xuICAgIH07XG5cbiAgICAvLyDllZ/li5XlrprmnJ/muIXnkIZcbiAgICB0aGlzLnN0YXJ0Q2xlYW51cCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPluW/q+WPluacjeWLmeWvpuS+i++8iOWWruS+i+aooeW8j++8iVxuICAgKi9cbiAgc3RhdGljIGdldEluc3RhbmNlKGNvbmZpZz86IFBhcnRpYWw8Q2FjaGVDb25maWc+KTogQ2FjaGVTZXJ2aWNlIHtcbiAgICBpZiAoIUNhY2hlU2VydmljZS5pbnN0YW5jZSkge1xuICAgICAgQ2FjaGVTZXJ2aWNlLmluc3RhbmNlID0gbmV3IENhY2hlU2VydmljZShjb25maWcpO1xuICAgIH1cbiAgICByZXR1cm4gQ2FjaGVTZXJ2aWNlLmluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIOeUn+aIkOW/q+WPlumNtVxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZUtleShwcmVmaXg6IHN0cmluZywgcGFyYW1zOiBhbnlbXSk6IHN0cmluZyB7XG4gICAgY29uc3QgcGFyYW1TdHIgPSBwYXJhbXMubWFwKHAgPT4gXG4gICAgICB0eXBlb2YgcCA9PT0gJ29iamVjdCcgPyBKU09OLnN0cmluZ2lmeShwKSA6IFN0cmluZyhwKVxuICAgICkuam9pbignfCcpO1xuICAgIHJldHVybiBgJHtwcmVmaXh9OiR7cGFyYW1TdHJ9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiDmqqLmn6Xlv6vlj5bpoIXnm67mmK/lkKbpgY7mnJ9cbiAgICovXG4gIHByaXZhdGUgaXNFeHBpcmVkKGl0ZW06IENhY2hlSXRlbTxhbnk+KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIERhdGUubm93KCkgLSBpdGVtLnRpbWVzdGFtcCA+IGl0ZW0udHRsO1xuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPluW/q+WPluizh+aWmVxuICAgKi9cbiAgZ2V0PFQ+KGtleTogc3RyaW5nKTogVCB8IG51bGwge1xuICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmNhY2hlLmdldChrZXkpO1xuICAgIGlmICghaXRlbSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNFeHBpcmVkKGl0ZW0pKSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgbG9nZ2VyLmRlYnVnKGDlv6vlj5blkb3kuK06ICR7a2V5fWApO1xuICAgIHJldHVybiBpdGVtLmRhdGE7XG4gIH1cblxuICAvKipcbiAgICog6Kit572u5b+r5Y+W6LOH5paZXG4gICAqL1xuICBzZXQ8VD4oa2V5OiBzdHJpbmcsIGRhdGE6IFQsIHR0bD86IG51bWJlcik6IHZvaWQge1xuICAgIC8vIOaqouafpeW/q+WPluWkp+Wwj+mZkOWItlxuICAgIGlmICh0aGlzLmNhY2hlLnNpemUgPj0gdGhpcy5jb25maWcubWF4U2l6ZSkge1xuICAgICAgdGhpcy5ldmljdE9sZGVzdCgpO1xuICAgIH1cblxuICAgIGNvbnN0IGl0ZW06IENhY2hlSXRlbTxUPiA9IHtcbiAgICAgIGRhdGEsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICB0dGw6IHR0bCB8fCB0aGlzLmNvbmZpZy5kZWZhdWx0VFRMXG4gICAgfTtcblxuICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgaXRlbSk7XG4gICAgbG9nZ2VyLmRlYnVnKGDlv6vlj5boqK3nva46ICR7a2V5fWApO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIqumZpOW/q+WPlumgheebrlxuICAgKi9cbiAgZGVsZXRlKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZGVsZXRlZCA9IHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgaWYgKGRlbGV0ZWQpIHtcbiAgICAgIGxvZ2dlci5kZWJ1Zyhg5b+r5Y+W5Yiq6ZmkOiAke2tleX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGRlbGV0ZWQ7XG4gIH1cblxuICAvKipcbiAgICog5riF56m65omA5pyJ5b+r5Y+WXG4gICAqL1xuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMuY2xlYXIoKTtcbiAgICBsb2dnZXIuaW5mbygn5omA5pyJ5b+r5Y+W5bey5riF56m6Jyk7XG4gIH1cblxuICAvKipcbiAgICog5bi25b+r5Y+W55qE5Ye95pW45Z+36KGM77yI5YyF5ZCr6KuL5rGC5Y676YeN77yJXG4gICAqL1xuICBhc3luYyB3aXRoQ2FjaGU8VD4oXG4gICAgY2FjaGVLZXk6IHN0cmluZyxcbiAgICBhc3luY0Z1bmN0aW9uOiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIHR0bD86IG51bWJlclxuICApOiBQcm9taXNlPFQ+IHtcbiAgICAvLyDmqqLmn6Xlv6vlj5ZcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmdldDxUPihjYWNoZUtleSk7XG4gICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICB9XG5cbiAgICAvLyDmqqLmn6XmmK/lkKbmnInnm7jlkIznmoToq4vmsYLmraPlnKjpgLLooYzvvIjoq4vmsYLljrvph43vvIlcbiAgICBjb25zdCBwZW5kaW5nID0gdGhpcy5wZW5kaW5nUmVxdWVzdHMuZ2V0KGNhY2hlS2V5KTtcbiAgICBpZiAocGVuZGluZykge1xuICAgICAgbG9nZ2VyLmRlYnVnKGDoq4vmsYLljrvph406ICR7Y2FjaGVLZXl9YCk7XG4gICAgICByZXR1cm4gcGVuZGluZy5wcm9taXNlO1xuICAgIH1cblxuICAgIC8vIOWft+ihjOaWsOiri+axglxuICAgIGNvbnN0IHByb21pc2UgPSBhc3luY0Z1bmN0aW9uKCk7XG4gICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMuc2V0KGNhY2hlS2V5LCB7XG4gICAgICBwcm9taXNlLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJvbWlzZTtcbiAgICAgIC8vIOWwh+e1kOaenOWtmOWFpeW/q+WPllxuICAgICAgdGhpcy5zZXQoY2FjaGVLZXksIHJlc3VsdCwgdHRsKTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihg5b+r5Y+W5Ye95pW45Z+36KGM5aSx5pWXOiAke2NhY2hlS2V5fWAsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICAvLyDmuIXpmaTpgLLooYzkuK3nmoToq4vmsYLoqJjpjIRcbiAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzLmRlbGV0ZShjYWNoZUtleSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOaJuemHj+WIqumZpOW/q+WPlu+8iOaUr+aPtOaooeW8j+WMuemFje+8iVxuICAgKi9cbiAgZGVsZXRlUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGxldCBkZWxldGVkQ291bnQgPSAwO1xuICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChwYXR0ZXJuKTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLmNhY2hlLmtleXMoKSkge1xuICAgICAgaWYgKHJlZ2V4LnRlc3Qoa2V5KSkge1xuICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgICBkZWxldGVkQ291bnQrKztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZGVsZXRlZENvdW50ID4gMCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGDmibnph4/liKrpmaTlv6vlj5Y6ICR7ZGVsZXRlZENvdW50fSDlgIvpoIXnm65gKTtcbiAgICB9XG4gICAgcmV0dXJuIGRlbGV0ZWRDb3VudDtcbiAgfVxuXG4gIC8qKlxuICAgKiDnp7vpmaTmnIDoiIrnmoTlv6vlj5bpoIXnm65cbiAgICovXG4gIHByaXZhdGUgZXZpY3RPbGRlc3QoKTogdm9pZCB7XG4gICAgbGV0IG9sZGVzdEtleTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG4gICAgbGV0IG9sZGVzdFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCBpdGVtXSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgaWYgKGl0ZW0udGltZXN0YW1wIDwgb2xkZXN0VGltZSkge1xuICAgICAgICBvbGRlc3RUaW1lID0gaXRlbS50aW1lc3RhbXA7XG4gICAgICAgIG9sZGVzdEtleSA9IGtleTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAob2xkZXN0S2V5KSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShvbGRlc3RLZXkpO1xuICAgICAgbG9nZ2VyLmRlYnVnKGDnp7vpmaTmnIDoiIrlv6vlj5Y6ICR7b2xkZXN0S2V5fWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnkIbpgY7mnJ/nmoTlv6vlj5bpoIXnm65cbiAgICovXG4gIHByaXZhdGUgY2xlYW51cCgpOiB2b2lkIHtcbiAgICBsZXQgY2xlYW5lZENvdW50ID0gMDtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgLy8g5riF55CG6YGO5pyf5b+r5Y+WXG4gICAgZm9yIChjb25zdCBba2V5LCBpdGVtXSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgaWYgKHRoaXMuaXNFeHBpcmVkKGl0ZW0pKSB7XG4gICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgICAgIGNsZWFuZWRDb3VudCsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIOa4heeQhumBjuacn+eahOmAsuihjOS4reiri+axgu+8iOi2hemBjjXliIbpkJjvvIlcbiAgICBmb3IgKGNvbnN0IFtrZXksIHBlbmRpbmddIG9mIHRoaXMucGVuZGluZ1JlcXVlc3RzLmVudHJpZXMoKSkge1xuICAgICAgaWYgKG5vdyAtIHBlbmRpbmcudGltZXN0YW1wID4gNSAqIDYwICogMTAwMCkge1xuICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cy5kZWxldGUoa2V5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY2xlYW5lZENvdW50ID4gMCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGDmuIXnkIbpgY7mnJ/lv6vlj5Y6ICR7Y2xlYW5lZENvdW50fSDlgIvpoIXnm65gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5ZWf5YuV5a6a5pyf5riF55CGXG4gICAqL1xuICBwcml2YXRlIHN0YXJ0Q2xlYW51cCgpOiB2b2lkIHtcbiAgICB0aGlzLmNsZWFudXBUaW1lciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHRoaXMuY2xlYW51cCgpO1xuICAgIH0sIHRoaXMuY29uZmlnLmNsZWFudXBJbnRlcnZhbCk7XG4gIH1cblxuICAvKipcbiAgICog5YGc5q2i5a6a5pyf5riF55CGXG4gICAqL1xuICBzdG9wQ2xlYW51cCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jbGVhbnVwVGltZXIpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5jbGVhbnVwVGltZXIpO1xuICAgICAgdGhpcy5jbGVhbnVwVGltZXIgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDnjbLlj5blv6vlj5bntbHoqIjos4foqIpcbiAgICovXG4gIGdldFN0YXRzKCk6IHtcbiAgICBjYWNoZVNpemU6IG51bWJlcjtcbiAgICBwZW5kaW5nUmVxdWVzdHM6IG51bWJlcjtcbiAgICBtYXhTaXplOiBudW1iZXI7XG4gICAgZGVmYXVsdFRUTDogbnVtYmVyO1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgY2FjaGVTaXplOiB0aGlzLmNhY2hlLnNpemUsXG4gICAgICBwZW5kaW5nUmVxdWVzdHM6IHRoaXMucGVuZGluZ1JlcXVlc3RzLnNpemUsXG4gICAgICBtYXhTaXplOiB0aGlzLmNvbmZpZy5tYXhTaXplLFxuICAgICAgZGVmYXVsdFRUTDogdGhpcy5jb25maWcuZGVmYXVsdFRUTFxuICAgIH07XG4gIH1cbn1cblxuLy8g6aCQ6Kit5b+r5Y+W5a+m5L6LXG5leHBvcnQgY29uc3QgY2FjaGVTZXJ2aWNlID0gQ2FjaGVTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG5cbmNvbnNvbGUubG9nKCfinIUgQ2FjaGVTZXJ2aWNlIOW3sui8ieWFpScpOyJdLCJ2ZXJzaW9uIjozfQ==