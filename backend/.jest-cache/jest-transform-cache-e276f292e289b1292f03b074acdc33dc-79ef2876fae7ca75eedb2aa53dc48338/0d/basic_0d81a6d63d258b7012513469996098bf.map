{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\basic.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\basic.ts"],"sourcesContent":["import { Router } from \"express\";\nimport { asyncHandler } from \"../../middleware/error-handler\";\nimport {\n  ValidationError,\n  NotFoundError,\n  ForbiddenError,\n} from \"../../utils/errors\";\nimport { logger } from \"../../utils/logger\";\nimport {\n  createCacheMiddleware,\n  createCacheInvalidationMiddleware,\n  petCacheKeyGenerator,\n  conditionalCacheMiddleware,\n} from \"../../middleware/cacheMiddleware\";\nimport { validateRequest, validateQuery } from \"../../utils/validation\";\nimport { petSchema, petUpdateSchema } from \"../../schemas/pet\";\nimport { petSearchSchema } from \"../../schemas/search\";\nimport { Pet, IPet } from \"../../models/Pet\";\nimport { SearchHistory } from \"../../models/SearchHistory\";\nimport { authenticate } from \"../../middleware/auth\";\nimport {\n  requirePermission,\n  Permission,\n  requireActiveAccount,\n  hasPermission,\n} from \"../../middleware/rbac\";\nimport mongoose from \"mongoose\";\n\nconst router = Router();\n\n/**\n * @route   GET /api/pets\n * @desc    取得寵物列表\n * @access  Public\n */\nrouter.get(\n  \"/\",\n  validateQuery(petSearchSchema),\n  conditionalCacheMiddleware({\n    ttl: 3 * 60 * 1000, // 3分鐘快取\n    keyGenerator: petCacheKeyGenerator,\n    userCondition: (req) => !req.user, // 只對未登入用戶快取\n  }),\n  asyncHandler(async (req, res) => {\n    const {\n      page = 1,\n      limit = 12,\n      status,\n      type,\n      breed,\n      location,\n      search,\n      sortBy = \"createdAt\",\n      sortOrder = \"desc\",\n      radius = 10,\n    } = req.validatedQuery;\n\n    logger.info(\"獲取寵物列表請求\", {\n      page,\n      limit,\n      status,\n      type,\n      breed,\n      location,\n      search,\n      sortBy,\n      sortOrder,\n    });\n\n    // 建立查詢條件\n    const query: any = {};\n\n    // 狀態篩選\n    if (status) {\n      query.status = status;\n    }\n\n    // 寵物類型篩選\n    if (type) {\n      query.type = type;\n    }\n\n    // 品種篩選\n    if (breed) {\n      query.breed = new RegExp(breed, \"i\");\n    }\n\n    // 文字搜尋（名稱、描述、地點）\n    if (search) {\n      query.$or = [\n        { name: new RegExp(search, \"i\") },\n        { description: new RegExp(search, \"i\") },\n        { lastSeenLocation: new RegExp(search, \"i\") },\n        { \"contactInfo.name\": new RegExp(search, \"i\") },\n      ];\n    }\n\n    // 地點篩選\n    if (location) {\n      query.lastSeenLocation = new RegExp(location, \"i\");\n    }\n\n    // 計算分頁\n    const skip = (page - 1) * limit;\n\n    // 排序設定\n    const sortOptions: any = {};\n    sortOptions[sortBy] = sortOrder === \"desc\" ? -1 : 1;\n\n    // 如果按緊急程度排序，優先顯示緊急案件\n    if (sortBy === \"createdAt\") {\n      sortOptions.isUrgent = -1;\n    }\n\n    // 執行查詢\n    const [pets, totalItems] = await Promise.all([\n      Pet.find(query)\n        .sort(sortOptions)\n        .skip(skip)\n        .limit(limit)\n        .populate(\"userId\", \"name email\")\n        .lean(),\n      Pet.countDocuments(query),\n    ]);\n\n    // 記錄搜尋歷史（如果有搜尋條件且用戶已登入）\n    if ((search || location || type || status || breed) && req.user?.id) {\n      const searchQuery = search || location || \"\";\n      const filters = {\n        type,\n        status,\n        location,\n        breed,\n        radius,\n      };\n\n      // 異步記錄搜尋歷史，不影響主要回應\n      SearchHistory.recordSearch(\n        req.user.id,\n        searchQuery,\n        filters,\n        totalItems,\n      ).catch((error) => {\n        logger.error(\"記錄搜尋歷史失敗:\", error);\n      });\n    }\n\n    // 計算分頁資訊\n    const totalPages = Math.ceil(totalItems / limit);\n\n    res.json({\n      success: true,\n      data: {\n        pets,\n        pagination: {\n          currentPage: page,\n          totalPages,\n          totalItems,\n          itemsPerPage: limit,\n          hasNextPage: page < totalPages,\n          hasPrevPage: page > 1,\n        },\n        filters: {\n          status: [\"lost\", \"found\", \"reunited\"],\n          type: [\"dog\", \"cat\", \"bird\", \"rabbit\", \"other\"],\n          size: [\"small\", \"medium\", \"large\"],\n          gender: [\"male\", \"female\", \"unknown\"],\n        },\n      },\n    });\n  }),\n);\n\n/**\n * @route   GET /api/pets/:id\n * @desc    獲取特定寵物資訊\n * @access  Public\n */\nrouter.get(\n  \"/:id\",\n  createCacheMiddleware({\n    ttl: 10 * 60 * 1000, // 10分鐘快取\n    keyGenerator: petCacheKeyGenerator,\n  }),\n  asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n      throw new ValidationError(\"請提供有效的寵物 ID\");\n    }\n\n    logger.info(\"獲取寵物詳細資訊請求\", { petId: id });\n\n    // 查找寵物並增加瀏覽次數\n    const pet = await Pet.findByIdAndUpdate(\n      id,\n      { $inc: { viewCount: 1 } },\n      { new: true },\n    )\n      .populate(\"userId\", \"name email\")\n      .lean();\n\n    if (!pet) {\n      throw new NotFoundError(\"找不到指定的寵物資訊\");\n    }\n\n    res.json({\n      success: true,\n      data: {\n        pet,\n      },\n    });\n  }),\n);\n\n/**\n * @route   POST /api/pets\n * @desc    新增寵物協尋案例\n * @access  Private\n */\nrouter.post(\n  \"/\",\n  authenticate,\n  requireActiveAccount,\n  validateRequest(petSchema),\n  createCacheInvalidationMiddleware({\n    patterns: [\"pets:*\"], // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n    const validatedData = req.validatedData;\n    const userId = req.user!.id;\n\n    logger.info(\"新增寵物協尋案例請求\", {\n      userId,\n      name: validatedData.name,\n      type: validatedData.type,\n      status: validatedData.status,\n      lastSeenLocation: validatedData.lastSeenLocation,\n    });\n\n    // 建立寵物資料\n    const petData = {\n      ...validatedData,\n      userId: new mongoose.Types.ObjectId(userId),\n      viewCount: 0,\n      shareCount: 0,\n    };\n\n    // 儲存到資料庫\n    const pet = new Pet(petData);\n    await pet.save();\n\n    // 填充用戶資訊\n    await pet.populate(\"userId\", \"name email\");\n\n    res.status(201).json({\n      success: true,\n      message: \"寵物協尋案例新增成功\",\n      data: {\n        pet: pet.toJSON(),\n      },\n    });\n  }),\n);\n\n/**\n * @route   PUT /api/pets/:id\n * @desc    更新寵物協尋案例\n * @access  Private\n */\nrouter.put(\n  \"/:id\",\n  authenticate,\n  requireActiveAccount,\n  validateRequest(petSchema),\n  createCacheInvalidationMiddleware({\n    patterns: [\"pets:*\"], // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n    const { id } = req.params;\n    const updateData = req.validatedData;\n    const userId = req.user!.id;\n\n    if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n      throw new ValidationError(\"請提供有效的寵物 ID\");\n    }\n\n    logger.info(\"更新寵物資訊請求\", { petId: id, userId, updateData });\n\n    // 查找寵物並檢查權限\n    const pet = await Pet.findById(id);\n    if (!pet) {\n      throw new NotFoundError(\"找不到指定的寵物資訊\");\n    }\n\n    // 檢查是否為寵物擁有者或管理員\n    if (\n      pet.userId.toString() !== userId &&\n      !hasPermission(req.user!, Permission.PET_WRITE)\n    ) {\n      throw new ForbiddenError(\"您沒有權限修改此寵物資訊\");\n    }\n\n    // 更新寵物資訊\n    const updatedPet = await Pet.findByIdAndUpdate(\n      id,\n      { $set: updateData },\n      { new: true, runValidators: true },\n    ).populate(\"userId\", \"name email\");\n\n    res.json({\n      success: true,\n      message: \"寵物資訊更新成功\",\n      data: {\n        pet: updatedPet,\n      },\n    });\n  }),\n);\n\n/**\n * @route   DELETE /api/pets/:id\n * @desc    刪除寵物協尋案例\n * @access  Private\n */\nrouter.delete(\n  \"/:id\",\n  authenticate,\n  requireActiveAccount,\n  createCacheInvalidationMiddleware({\n    patterns: [\"pets:*\"], // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n    const { id } = req.params;\n    const userId = req.user!.id;\n\n    if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n      throw new ValidationError(\"請提供有效的寵物 ID\");\n    }\n\n    logger.info(\"刪除寵物協尋案例請求\", { petId: id, userId });\n\n    // 查找寵物並檢查權限\n    const pet = await Pet.findById(id);\n    if (!pet) {\n      throw new NotFoundError(\"找不到指定的寵物資訊\");\n    }\n\n    // 檢查是否為寵物擁有者或管理員\n    if (\n      pet.userId.toString() !== userId &&\n      !hasPermission(req.user!, Permission.PET_DELETE)\n    ) {\n      throw new ForbiddenError(\"您沒有權限刪除此寵物資訊\");\n    }\n\n    // 執行刪除（硬刪除）\n    await Pet.findByIdAndDelete(id);\n\n    res.json({\n      success: true,\n      message: \"寵物協尋案例已刪除\",\n    });\n  }),\n);\n\nexport default router;\n"],"version":3}