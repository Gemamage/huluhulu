edab05fa4914fe565ce34ad1e2903b20
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const petSearchService_1 = require("../services/petSearchService");
const elasticsearchService_1 = require("../services/elasticsearchService");
const mockElasticsearchService_1 = require("../services/mockElasticsearchService");
const auth_1 = require("../middleware/auth");
const logger_1 = require("../utils/logger");
const express_rate_limit_1 = __importDefault(require("express-rate-limit"));
const router = express_1.default.Router();
// 檢測是否使用模擬服務
const USE_MOCK_ELASTICSEARCH = process.env.NODE_ENV === 'development' && !process.env.ELASTICSEARCH_URL;
// 搜尋頻率限制
const searchLimiter = (0, express_rate_limit_1.default)({
    windowMs: 1 * 60 * 1000, // 1分鐘
    max: 30, // 每分鐘最多30次搜尋
    message: {
        error: '搜尋頻率過高，請稍後再試',
        code: 'RATE_LIMIT_EXCEEDED'
    },
    standardHeaders: true,
    legacyHeaders: false
});
// 建議搜尋頻率限制
const suggestionLimiter = (0, express_rate_limit_1.default)({
    windowMs: 1 * 60 * 1000, // 1分鐘
    max: 60, // 每分鐘最多60次建議請求
    message: {
        error: '建議請求頻率過高，請稍後再試',
        code: 'RATE_LIMIT_EXCEEDED'
    },
    standardHeaders: true,
    legacyHeaders: false
});
/**
 * @route POST /api/advanced-search/pets
 * @desc 進階寵物搜尋
 * @access Public
 */
router.post('/pets', searchLimiter, async (req, res) => {
    try {
        const { query = '', type, status, breed, location, size, gender, color, page = 1, limit = 12, sortBy = 'createdAt', sortOrder = 'desc', fuzzy = false, radius = 10, coordinates } = req.body;
        // 驗證參數
        if (page < 1 || limit < 1 || limit > 50) {
            return res.status(400).json({
                error: '無效的分頁參數',
                code: 'INVALID_PAGINATION'
            });
        }
        if (radius && (radius < 1 || radius > 100)) {
            return res.status(400).json({
                error: '搜尋半徑必須在 1-100 公里之間',
                code: 'INVALID_RADIUS'
            });
        }
        const searchQuery = {
            query: query.trim(),
            type,
            status,
            breed,
            location,
            size,
            gender,
            color,
            page,
            limit,
            sortBy,
            sortOrder,
            fuzzy,
            radius,
            coordinates
        };
        let searchResult;
        let searchTime;
        const startTime = Date.now();
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            searchResult = await mockElasticsearchService_1.mockElasticsearchService.searchPets(searchQuery);
            searchTime = Date.now() - startTime;
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                logger_1.logger.warn('Elasticsearch 未連接，使用基礎搜尋');
                return res.status(503).json({
                    error: '搜尋服務暫時不可用，請稍後再試',
                    code: 'SEARCH_SERVICE_UNAVAILABLE'
                });
            }
            // 執行搜尋
            searchResult = await petSearchService_1.petSearchService.searchPets(searchQuery);
            searchTime = Date.now() - startTime;
            // 記錄搜尋分析
            const userId = req.user?.id;
            const sessionId = req.sessionID;
            const userAgent = req.get('User-Agent');
            const ipAddress = req.ip;
            await petSearchService_1.petSearchService.recordSearchAnalytics(query, { type, status, breed, location, size, gender, color }, userId, searchResult.total, sessionId, userAgent, ipAddress);
        }
        // 回傳結果
        res.json({
            success: true,
            data: {
                pets: searchResult.hits.map(hit => ({
                    id: hit.id,
                    ...hit.source,
                    highlights: hit.highlights,
                    relevanceScore: hit.score
                })),
                pagination: {
                    page,
                    limit,
                    total: searchResult.total,
                    totalPages: Math.ceil(searchResult.total / limit),
                    hasNext: page * limit < searchResult.total,
                    hasPrev: page > 1
                },
                searchInfo: {
                    query: query.trim(),
                    filters: { type, status, breed, location, size, gender, color },
                    fuzzy,
                    searchTime,
                    maxScore: searchResult.maxScore
                }
            },
            mock: USE_MOCK_ELASTICSEARCH
        });
    }
    catch (error) {
        logger_1.logger.error('進階搜尋失敗:', error);
        res.status(500).json({
            error: '搜尋失敗，請稍後再試',
            code: 'SEARCH_ERROR'
        });
    }
});
/**
 * @route GET /api/advanced-search/suggestions
 * @desc 獲取搜尋建議
 * @access Public
 */
router.get('/suggestions', suggestionLimiter, async (req, res) => {
    try {
        const { q: query, limit = 5 } = req.query;
        if (!query || typeof query !== 'string') {
            return res.status(400).json({
                error: '請提供搜尋關鍵字',
                code: 'MISSING_QUERY'
            });
        }
        if (query.length < 1) {
            return res.json({
                success: true,
                data: {
                    suggestions: []
                }
            });
        }
        const limitNum = Math.min(parseInt(limit) || 5, 10);
        let suggestions;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            suggestions = await mockElasticsearchService_1.mockElasticsearchService.getSearchSuggestions(query, limitNum);
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                return res.json({
                    success: true,
                    data: {
                        suggestions: []
                    }
                });
            }
            suggestions = await petSearchService_1.petSearchService.getSearchSuggestions(query, limitNum);
        }
        res.json({
            success: true,
            data: {
                suggestions: suggestions.map(suggestion => ({
                    text: suggestion.text,
                    type: suggestion.type,
                    score: suggestion.score
                }))
            },
            mock: USE_MOCK_ELASTICSEARCH
        });
    }
    catch (error) {
        logger_1.logger.error('獲取搜尋建議失敗:', error);
        res.status(500).json({
            error: '獲取建議失敗',
            code: 'SUGGESTION_ERROR'
        });
    }
});
/**
 * @route GET /api/advanced-search/analytics
 * @desc 獲取搜尋分析數據
 * @access Private (Admin)
 */
router.get('/analytics', auth_1.auth, async (req, res) => {
    try {
        // 檢查管理員權限
        if (req.user?.role !== 'admin') {
            return res.status(403).json({
                error: '權限不足',
                code: 'INSUFFICIENT_PERMISSIONS'
            });
        }
        const { days = 30 } = req.query;
        const daysNum = Math.min(parseInt(days) || 30, 365);
        let analytics;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            analytics = await mockElasticsearchService_1.mockElasticsearchService.getSearchAnalytics(daysNum);
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                return res.status(503).json({
                    error: '分析服務暫時不可用',
                    code: 'ANALYTICS_SERVICE_UNAVAILABLE'
                });
            }
            analytics = await petSearchService_1.petSearchService.getSearchAnalytics(daysNum);
        }
        res.json({
            success: true,
            data: {
                analytics,
                period: {
                    days: daysNum,
                    from: new Date(Date.now() - daysNum * 24 * 60 * 60 * 1000).toISOString(),
                    to: new Date().toISOString()
                }
            },
            mock: USE_MOCK_ELASTICSEARCH
        });
    }
    catch (error) {
        logger_1.logger.error('獲取搜尋分析失敗:', error);
        res.status(500).json({
            error: '獲取分析數據失敗',
            code: 'ANALYTICS_ERROR'
        });
    }
});
/**
 * @route GET /api/advanced-search/health
 * @desc 檢查搜尋服務健康狀態
 * @access Public
 */
router.get('/health', async (req, res) => {
    try {
        let isConnected, metrics;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            isConnected = await mockElasticsearchService_1.mockElasticsearchService.checkConnection();
            metrics = mockElasticsearchService_1.mockElasticsearchService.getPerformanceMetrics();
        }
        else {
            // 使用真實 Elasticsearch 服務
            isConnected = await elasticsearchService_1.elasticsearchService.checkConnection();
            metrics = elasticsearchService_1.elasticsearchService.getPerformanceMetrics();
        }
        res.json({
            success: true,
            data: {
                elasticsearch: {
                    connected: isConnected,
                    status: isConnected ? 'healthy' : 'disconnected',
                    mock: USE_MOCK_ELASTICSEARCH
                },
                performance: {
                    totalQueries: metrics.totalQueries,
                    averageResponseTime: Math.round(metrics.averageResponseTime),
                    slowQueries: metrics.slowQueries,
                    errorRate: Math.round(metrics.errorRate * 100) / 100,
                    lastUpdated: metrics.lastUpdated
                },
                features: {
                    advancedSearch: isConnected,
                    fuzzySearch: isConnected,
                    suggestions: isConnected,
                    analytics: isConnected,
                    geoSearch: isConnected
                }
            }
        });
    }
    catch (error) {
        logger_1.logger.error('檢查搜尋服務健康狀態失敗:', error);
        res.status(500).json({
            error: '健康檢查失敗',
            code: 'HEALTH_CHECK_ERROR'
        });
    }
});
/**
 * @route POST /api/advanced-search/reindex
 * @desc 重新索引所有寵物數據
 * @access Private (Admin)
 */
router.post('/reindex', auth_1.auth, async (req, res) => {
    try {
        // 檢查管理員權限
        if (req.user?.role !== 'admin') {
            return res.status(403).json({
                error: '權限不足',
                code: 'INSUFFICIENT_PERMISSIONS'
            });
        }
        let result;
        if (USE_MOCK_ELASTICSEARCH) {
            // 使用模擬服務
            result = await mockElasticsearchService_1.mockElasticsearchService.reindexAllPets();
        }
        else {
            // 檢查 Elasticsearch 連接
            if (!elasticsearchService_1.elasticsearchService.isConnected()) {
                return res.status(503).json({
                    error: '搜尋服務暫時不可用',
                    code: 'SEARCH_SERVICE_UNAVAILABLE'
                });
            }
            // 使用真實 Elasticsearch 服務
            result = await petSearchService_1.petSearchService.reindexAllPets();
        }
        logger_1.logger.info('重新索引寵物數據完成');
        res.json({
            success: true,
            message: '重新索引任務已完成',
            data: {
                ...result,
                mock: USE_MOCK_ELASTICSEARCH
            }
        });
    }
    catch (error) {
        logger_1.logger.error('重新索引失敗:', error);
        res.status(500).json({
            error: '重新索引失敗',
            code: 'REINDEX_ERROR'
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcYWR2YW5jZWRTZWFyY2gudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxzREFBOEI7QUFFOUIsbUVBQWdGO0FBQ2hGLDJFQUF3RTtBQUN4RSxtRkFBZ0Y7QUFDaEYsNkNBQTBDO0FBQzFDLDRDQUF5QztBQUN6Qyw0RUFBMkM7QUFFM0MsTUFBTSxNQUFNLEdBQUcsaUJBQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVoQyxhQUFhO0FBQ2IsTUFBTSxzQkFBc0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxhQUFhLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDO0FBRXhHLFNBQVM7QUFDVCxNQUFNLGFBQWEsR0FBRyxJQUFBLDRCQUFTLEVBQUM7SUFDOUIsUUFBUSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLE1BQU07SUFDL0IsR0FBRyxFQUFFLEVBQUUsRUFBRSxhQUFhO0lBQ3RCLE9BQU8sRUFBRTtRQUNQLEtBQUssRUFBRSxjQUFjO1FBQ3JCLElBQUksRUFBRSxxQkFBcUI7S0FDNUI7SUFDRCxlQUFlLEVBQUUsSUFBSTtJQUNyQixhQUFhLEVBQUUsS0FBSztDQUNyQixDQUFDLENBQUM7QUFFSCxXQUFXO0FBQ1gsTUFBTSxpQkFBaUIsR0FBRyxJQUFBLDRCQUFTLEVBQUM7SUFDbEMsUUFBUSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLE1BQU07SUFDL0IsR0FBRyxFQUFFLEVBQUUsRUFBRSxlQUFlO0lBQ3hCLE9BQU8sRUFBRTtRQUNQLEtBQUssRUFBRSxnQkFBZ0I7UUFDdkIsSUFBSSxFQUFFLHFCQUFxQjtLQUM1QjtJQUNELGVBQWUsRUFBRSxJQUFJO0lBQ3JCLGFBQWEsRUFBRSxLQUFLO0NBQ3JCLENBQUMsQ0FBQztBQUVIOzs7O0dBSUc7QUFDSCxN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LENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixLQUFLLEVBQUUsUUFBUTtZQUNmLElBQUksRUFBRSxlQUFlO1NBQ3RCLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGtCQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccm91dGVzXFxhZHZhbmNlZFNlYXJjaC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBwZXRTZWFyY2hTZXJ2aWNlLCBQZXRTZWFyY2hRdWVyeSB9IGZyb20gJy4uL3NlcnZpY2VzL3BldFNlYXJjaFNlcnZpY2UnO1xuaW1wb3J0IHsgZWxhc3RpY3NlYXJjaFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9lbGFzdGljc2VhcmNoU2VydmljZSc7XG5pbXBvcnQgeyBtb2NrRWxhc3RpY3NlYXJjaFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9tb2NrRWxhc3RpY3NlYXJjaFNlcnZpY2UnO1xuaW1wb3J0IHsgYXV0aCB9IGZyb20gJy4uL21pZGRsZXdhcmUvYXV0aCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHJhdGVMaW1pdCBmcm9tICdleHByZXNzLXJhdGUtbGltaXQnO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4vLyDmqqLmuKzmmK/lkKbkvb/nlKjmqKHmk6zmnI3li5lcbmNvbnN0IFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0ggPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50JyAmJiAhcHJvY2Vzcy5lbnYuRUxBU1RJQ1NFQVJDSF9VUkw7XG5cbi8vIOaQnOWwi+mgu+eOh+mZkOWItlxuY29uc3Qgc2VhcmNoTGltaXRlciA9IHJhdGVMaW1pdCh7XG4gIHdpbmRvd01zOiAxICogNjAgKiAxMDAwLCAvLyAx5YiG6ZCYXG4gIG1heDogMzAsIC8vIOavj+WIhumQmOacgOWkmjMw5qyh5pCc5bCLXG4gIG1lc3NhZ2U6IHtcbiAgICBlcnJvcjogJ+aQnOWwi+mgu+eOh+mBjumrmO+8jOiri+eojeW+jOWGjeippicsXG4gICAgY29kZTogJ1JBVEVfTElNSVRfRVhDRUVERUQnXG4gIH0sXG4gIHN0YW5kYXJkSGVhZGVyczogdHJ1ZSxcbiAgbGVnYWN5SGVhZGVyczogZmFsc2Vcbn0pO1xuXG4vLyDlu7rorbDmkJzlsIvpoLvnjofpmZDliLZcbmNvbnN0IHN1Z2dlc3Rpb25MaW1pdGVyID0gcmF0ZUxpbWl0KHtcbiAgd2luZG93TXM6IDEgKiA2MCAqIDEwMDAsIC8vIDHliIbpkJhcbiAgbWF4OiA2MCwgLy8g5q+P5YiG6ZCY5pyA5aSaNjDmrKHlu7rorbDoq4vmsYJcbiAgbWVzc2FnZToge1xuICAgIGVycm9yOiAn5bu66K2w6KuL5rGC6aC7546H6YGO6auY77yM6KuL56iN5b6M5YaN6KmmJyxcbiAgICBjb2RlOiAnUkFURV9MSU1JVF9FWENFRURFRCdcbiAgfSxcbiAgc3RhbmRhcmRIZWFkZXJzOiB0cnVlLFxuICBsZWdhY3lIZWFkZXJzOiBmYWxzZVxufSk7XG5cbi8qKlxuICogQHJvdXRlIFBPU1QgL2FwaS9hZHZhbmNlZC1zZWFyY2gvcGV0c1xuICogQGRlc2Mg6YCy6ZqO5a+154mp5pCc5bCLXG4gKiBAYWNjZXNzIFB1YmxpY1xuICovXG5yb3V0ZXIucG9zdCgnL3BldHMnLCBzZWFyY2hMaW1pdGVyLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qge1xuICAgICAgcXVlcnkgPSAnJyxcbiAgICAgIHR5cGUsXG4gICAgICBzdGF0dXMsXG4gICAgICBicmVlZCxcbiAgICAgIGxvY2F0aW9uLFxuICAgICAgc2l6ZSxcbiAgICAgIGdlbmRlcixcbiAgICAgIGNvbG9yLFxuICAgICAgcGFnZSA9IDEsXG4gICAgICBsaW1pdCA9IDEyLFxuICAgICAgc29ydEJ5ID0gJ2NyZWF0ZWRBdCcsXG4gICAgICBzb3J0T3JkZXIgPSAnZGVzYycsXG4gICAgICBmdXp6eSA9IGZhbHNlLFxuICAgICAgcmFkaXVzID0gMTAsXG4gICAgICBjb29yZGluYXRlc1xuICAgIH0gPSByZXEuYm9keSBhcyBQZXRTZWFyY2hRdWVyeTtcblxuICAgIC8vIOmpl+itieWPg+aVuFxuICAgIGlmIChwYWdlIDwgMSB8fCBsaW1pdCA8IDEgfHwgbGltaXQgPiA1MCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICfnhKHmlYjnmoTliIbpoIHlj4PmlbgnLFxuICAgICAgICBjb2RlOiAnSU5WQUxJRF9QQUdJTkFUSU9OJ1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHJhZGl1cyAmJiAocmFkaXVzIDwgMSB8fCByYWRpdXMgPiAxMDApKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ+aQnOWwi+WNiuW+keW/hemgiOWcqCAxLTEwMCDlhazph4zkuYvplpMnLFxuICAgICAgICBjb2RlOiAnSU5WQUxJRF9SQURJVVMnXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBzZWFyY2hRdWVyeTogUGV0U2VhcmNoUXVlcnkgPSB7XG4gICAgICBxdWVyeTogcXVlcnkudHJpbSgpLFxuICAgICAgdHlwZSxcbiAgICAgIHN0YXR1cyxcbiAgICAgIGJyZWVkLFxuICAgICAgbG9jYXRpb24sXG4gICAgICBzaXplLFxuICAgICAgZ2VuZGVyLFxuICAgICAgY29sb3IsXG4gICAgICBwYWdlLFxuICAgICAgbGltaXQsXG4gICAgICBzb3J0QnksXG4gICAgICBzb3J0T3JkZXIsXG4gICAgICBmdXp6eSxcbiAgICAgIHJhZGl1cyxcbiAgICAgIGNvb3JkaW5hdGVzXG4gICAgfTtcblxuICAgIGxldCBzZWFyY2hSZXN1bHQ7XG4gICAgbGV0IHNlYXJjaFRpbWU7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgIGlmIChVU0VfTU9DS19FTEFTVElDU0VBUkNIKSB7XG4gICAgICAvLyDkvb/nlKjmqKHmk6zmnI3li5lcbiAgICAgIHNlYXJjaFJlc3VsdCA9IGF3YWl0IG1vY2tFbGFzdGljc2VhcmNoU2VydmljZS5zZWFyY2hQZXRzKHNlYXJjaFF1ZXJ5KTtcbiAgICAgIHNlYXJjaFRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDmqqLmn6UgRWxhc3RpY3NlYXJjaCDpgKPmjqVcbiAgICAgIGlmICghZWxhc3RpY3NlYXJjaFNlcnZpY2UuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICBsb2dnZXIud2FybignRWxhc3RpY3NlYXJjaCDmnKrpgKPmjqXvvIzkvb/nlKjln7rnpI7mkJzlsIsnKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAzKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ+aQnOWwi+acjeWLmeaaq+aZguS4jeWPr+eUqO+8jOiri+eojeW+jOWGjeippicsXG4gICAgICAgICAgY29kZTogJ1NFQVJDSF9TRVJWSUNFX1VOQVZBSUxBQkxFJ1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8g5Z+36KGM5pCc5bCLXG4gICAgICBzZWFyY2hSZXN1bHQgPSBhd2FpdCBwZXRTZWFyY2hTZXJ2aWNlLnNlYXJjaFBldHMoc2VhcmNoUXVlcnkpO1xuICAgICAgc2VhcmNoVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIC8vIOiomOmMhOaQnOWwi+WIhuaekFxuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkO1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gcmVxLnNlc3Npb25JRDtcbiAgICAgIGNvbnN0IHVzZXJBZ2VudCA9IHJlcS5nZXQoJ1VzZXItQWdlbnQnKTtcbiAgICAgIGNvbnN0IGlwQWRkcmVzcyA9IHJlcS5pcDtcblxuICAgICAgYXdhaXQgcGV0U2VhcmNoU2VydmljZS5yZWNvcmRTZWFyY2hBbmFseXRpY3MoXG4gICAgICAgIHF1ZXJ5LFxuICAgICAgICB7IHR5cGUsIHN0YXR1cywgYnJlZWQsIGxvY2F0aW9uLCBzaXplLCBnZW5kZXIsIGNvbG9yIH0sXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgc2VhcmNoUmVzdWx0LnRvdGFsLFxuICAgICAgICBzZXNzaW9uSWQsXG4gICAgICAgIHVzZXJBZ2VudCxcbiAgICAgICAgaXBBZGRyZXNzXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIOWbnuWCs+e1kOaenFxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHBldHM6IHNlYXJjaFJlc3VsdC5oaXRzLm1hcChoaXQgPT4gKHtcbiAgICAgICAgICBpZDogaGl0LmlkLFxuICAgICAgICAgIC4uLmhpdC5zb3VyY2UsXG4gICAgICAgICAgaGlnaGxpZ2h0czogaGl0LmhpZ2hsaWdodHMsXG4gICAgICAgICAgcmVsZXZhbmNlU2NvcmU6IGhpdC5zY29yZVxuICAgICAgICB9KSksXG4gICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICBwYWdlLFxuICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgIHRvdGFsOiBzZWFyY2hSZXN1bHQudG90YWwsXG4gICAgICAgICAgdG90YWxQYWdlczogTWF0aC5jZWlsKHNlYXJjaFJlc3VsdC50b3RhbCAvIGxpbWl0KSxcbiAgICAgICAgICBoYXNOZXh0OiBwYWdlICogbGltaXQgPCBzZWFyY2hSZXN1bHQudG90YWwsXG4gICAgICAgICAgaGFzUHJldjogcGFnZSA+IDFcbiAgICAgICAgfSxcbiAgICAgICAgc2VhcmNoSW5mbzoge1xuICAgICAgICAgIHF1ZXJ5OiBxdWVyeS50cmltKCksXG4gICAgICAgICAgZmlsdGVyczogeyB0eXBlLCBzdGF0dXMsIGJyZWVkLCBsb2NhdGlvbiwgc2l6ZSwgZ2VuZGVyLCBjb2xvciB9LFxuICAgICAgICAgIGZ1enp5LFxuICAgICAgICAgIHNlYXJjaFRpbWUsXG4gICAgICAgICAgbWF4U2NvcmU6IHNlYXJjaFJlc3VsdC5tYXhTY29yZVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgbW9jazogVVNFX01PQ0tfRUxBU1RJQ1NFQVJDSFxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCfpgLLpmo7mkJzlsIvlpLHmlZc6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIGVycm9yOiAn5pCc5bCL5aSx5pWX77yM6KuL56iN5b6M5YaN6KmmJyxcbiAgICAgIGNvZGU6ICdTRUFSQ0hfRVJST1InXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEByb3V0ZSBHRVQgL2FwaS9hZHZhbmNlZC1zZWFyY2gvc3VnZ2VzdGlvbnNcbiAqIEBkZXNjIOeNsuWPluaQnOWwi+W7uuitsFxuICogQGFjY2VzcyBQdWJsaWNcbiAqL1xucm91dGVyLmdldCgnL3N1Z2dlc3Rpb25zJywgc3VnZ2VzdGlvbkxpbWl0ZXIsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHE6IHF1ZXJ5LCBsaW1pdCA9IDUgfSA9IHJlcS5xdWVyeTtcblxuICAgIGlmICghcXVlcnkgfHwgdHlwZW9mIHF1ZXJ5ICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICfoq4vmj5DkvpvmkJzlsIvpl5zpjbXlrZcnLFxuICAgICAgICBjb2RlOiAnTUlTU0lOR19RVUVSWSdcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChxdWVyeS5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgc3VnZ2VzdGlvbnM6IFtdXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGxpbWl0TnVtID0gTWF0aC5taW4ocGFyc2VJbnQobGltaXQgYXMgc3RyaW5nKSB8fCA1LCAxMCk7XG5cbiAgICBsZXQgc3VnZ2VzdGlvbnM7XG5cbiAgICBpZiAoVVNFX01PQ0tfRUxBU1RJQ1NFQVJDSCkge1xuICAgICAgLy8g5L2/55So5qih5pOs5pyN5YuZXG4gICAgICBzdWdnZXN0aW9ucyA9IGF3YWl0IG1vY2tFbGFzdGljc2VhcmNoU2VydmljZS5nZXRTZWFyY2hTdWdnZXN0aW9ucyhxdWVyeSwgbGltaXROdW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDmqqLmn6UgRWxhc3RpY3NlYXJjaCDpgKPmjqVcbiAgICAgIGlmICghZWxhc3RpY3NlYXJjaFNlcnZpY2UuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IFtdXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgc3VnZ2VzdGlvbnMgPSBhd2FpdCBwZXRTZWFyY2hTZXJ2aWNlLmdldFNlYXJjaFN1Z2dlc3Rpb25zKHF1ZXJ5LCBsaW1pdE51bSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3VnZ2VzdGlvbnM6IHN1Z2dlc3Rpb25zLm1hcChzdWdnZXN0aW9uID0+ICh7XG4gICAgICAgICAgdGV4dDogc3VnZ2VzdGlvbi50ZXh0LFxuICAgICAgICAgIHR5cGU6IHN1Z2dlc3Rpb24udHlwZSxcbiAgICAgICAgICBzY29yZTogc3VnZ2VzdGlvbi5zY29yZVxuICAgICAgICB9KSlcbiAgICAgIH0sXG4gICAgICBtb2NrOiBVU0VfTU9DS19FTEFTVElDU0VBUkNIXG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ+eNsuWPluaQnOWwi+W7uuitsOWkseaVlzonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgZXJyb3I6ICfnjbLlj5blu7rorbDlpLHmlZcnLFxuICAgICAgY29kZTogJ1NVR0dFU1RJT05fRVJST1InXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEByb3V0ZSBHRVQgL2FwaS9hZHZhbmNlZC1zZWFyY2gvYW5hbHl0aWNzXG4gKiBAZGVzYyDnjbLlj5bmkJzlsIvliIbmnpDmlbjmk5pcbiAqIEBhY2Nlc3MgUHJpdmF0ZSAoQWRtaW4pXG4gKi9cbnJvdXRlci5nZXQoJy9hbmFseXRpY3MnLCBhdXRoLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8g5qqi5p+l566h55CG5ZOh5qyK6ZmQXG4gICAgaWYgKHJlcS51c2VyPy5yb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICBlcnJvcjogJ+asiumZkOS4jei2sycsXG4gICAgICAgIGNvZGU6ICdJTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlMnXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGRheXMgPSAzMCB9ID0gcmVxLnF1ZXJ5O1xuICAgIGNvbnN0IGRheXNOdW0gPSBNYXRoLm1pbihwYXJzZUludChkYXlzIGFzIHN0cmluZykgfHwgMzAsIDM2NSk7XG5cbiAgICBsZXQgYW5hbHl0aWNzO1xuXG4gICAgaWYgKFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0gpIHtcbiAgICAgIC8vIOS9v+eUqOaooeaTrOacjeWLmVxuICAgICAgYW5hbHl0aWNzID0gYXdhaXQgbW9ja0VsYXN0aWNzZWFyY2hTZXJ2aWNlLmdldFNlYXJjaEFuYWx5dGljcyhkYXlzTnVtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8g5qqi5p+lIEVsYXN0aWNzZWFyY2gg6YCj5o6lXG4gICAgICBpZiAoIWVsYXN0aWNzZWFyY2hTZXJ2aWNlLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAzKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ+WIhuaekOacjeWLmeaaq+aZguS4jeWPr+eUqCcsXG4gICAgICAgICAgY29kZTogJ0FOQUxZVElDU19TRVJWSUNFX1VOQVZBSUxBQkxFJ1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgYW5hbHl0aWNzID0gYXdhaXQgcGV0U2VhcmNoU2VydmljZS5nZXRTZWFyY2hBbmFseXRpY3MoZGF5c051bSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgYW5hbHl0aWNzLFxuICAgICAgICBwZXJpb2Q6IHtcbiAgICAgICAgICBkYXlzOiBkYXlzTnVtLFxuICAgICAgICAgIGZyb206IG5ldyBEYXRlKERhdGUubm93KCkgLSBkYXlzTnVtICogMjQgKiA2MCAqIDYwICogMTAwMCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICB0bzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBtb2NrOiBVU0VfTU9DS19FTEFTVElDU0VBUkNIXG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ+eNsuWPluaQnOWwi+WIhuaekOWkseaVlzonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgZXJyb3I6ICfnjbLlj5bliIbmnpDmlbjmk5rlpLHmlZcnLFxuICAgICAgY29kZTogJ0FOQUxZVElDU19FUlJPUidcbiAgICB9KTtcbiAgfVxufSk7XG5cbi8qKlxuICogQHJvdXRlIEdFVCAvYXBpL2FkdmFuY2VkLXNlYXJjaC9oZWFsdGhcbiAqIEBkZXNjIOaqouafpeaQnOWwi+acjeWLmeWBpeW6t+eLgOaFi1xuICogQGFjY2VzcyBQdWJsaWNcbiAqL1xucm91dGVyLmdldCgnL2hlYWx0aCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBsZXQgaXNDb25uZWN0ZWQsIG1ldHJpY3M7XG4gICAgXG4gICAgaWYgKFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0gpIHtcbiAgICAgIC8vIOS9v+eUqOaooeaTrOacjeWLmVxuICAgICAgaXNDb25uZWN0ZWQgPSBhd2FpdCBtb2NrRWxhc3RpY3NlYXJjaFNlcnZpY2UuY2hlY2tDb25uZWN0aW9uKCk7XG4gICAgICBtZXRyaWNzID0gbW9ja0VsYXN0aWNzZWFyY2hTZXJ2aWNlLmdldFBlcmZvcm1hbmNlTWV0cmljcygpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDkvb/nlKjnnJ/lr6YgRWxhc3RpY3NlYXJjaCDmnI3li5lcbiAgICAgIGlzQ29ubmVjdGVkID0gYXdhaXQgZWxhc3RpY3NlYXJjaFNlcnZpY2UuY2hlY2tDb25uZWN0aW9uKCk7XG4gICAgICBtZXRyaWNzID0gZWxhc3RpY3NlYXJjaFNlcnZpY2UuZ2V0UGVyZm9ybWFuY2VNZXRyaWNzKCk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZWxhc3RpY3NlYXJjaDoge1xuICAgICAgICAgIGNvbm5lY3RlZDogaXNDb25uZWN0ZWQsXG4gICAgICAgICAgc3RhdHVzOiBpc0Nvbm5lY3RlZCA/ICdoZWFsdGh5JyA6ICdkaXNjb25uZWN0ZWQnLFxuICAgICAgICAgIG1vY2s6IFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0hcbiAgICAgICAgfSxcbiAgICAgICAgcGVyZm9ybWFuY2U6IHtcbiAgICAgICAgICB0b3RhbFF1ZXJpZXM6IG1ldHJpY3MudG90YWxRdWVyaWVzLFxuICAgICAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IE1hdGgucm91bmQobWV0cmljcy5hdmVyYWdlUmVzcG9uc2VUaW1lKSxcbiAgICAgICAgICBzbG93UXVlcmllczogbWV0cmljcy5zbG93UXVlcmllcyxcbiAgICAgICAgICBlcnJvclJhdGU6IE1hdGgucm91bmQobWV0cmljcy5lcnJvclJhdGUgKiAxMDApIC8gMTAwLFxuICAgICAgICAgIGxhc3RVcGRhdGVkOiBtZXRyaWNzLmxhc3RVcGRhdGVkXG4gICAgICAgIH0sXG4gICAgICAgIGZlYXR1cmVzOiB7XG4gICAgICAgICAgYWR2YW5jZWRTZWFyY2g6IGlzQ29ubmVjdGVkLFxuICAgICAgICAgIGZ1enp5U2VhcmNoOiBpc0Nvbm5lY3RlZCxcbiAgICAgICAgICBzdWdnZXN0aW9uczogaXNDb25uZWN0ZWQsXG4gICAgICAgICAgYW5hbHl0aWNzOiBpc0Nvbm5lY3RlZCxcbiAgICAgICAgICBnZW9TZWFyY2g6IGlzQ29ubmVjdGVkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcign5qqi5p+l5pCc5bCL5pyN5YuZ5YGl5bq354uA5oWL5aSx5pWXOicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBlcnJvcjogJ+WBpeW6t+aqouafpeWkseaVlycsXG4gICAgICBjb2RlOiAnSEVBTFRIX0NIRUNLX0VSUk9SJ1xuICAgIH0pO1xuICB9XG59KTtcblxuLyoqXG4gKiBAcm91dGUgUE9TVCAvYXBpL2FkdmFuY2VkLXNlYXJjaC9yZWluZGV4XG4gKiBAZGVzYyDph43mlrDntKLlvJXmiYDmnInlr7Xnianmlbjmk5pcbiAqIEBhY2Nlc3MgUHJpdmF0ZSAoQWRtaW4pXG4gKi9cbnJvdXRlci5wb3N0KCcvcmVpbmRleCcsIGF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyDmqqLmn6XnrqHnkIblk6HmrIrpmZBcbiAgICBpZiAocmVxLnVzZXI/LnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgIGVycm9yOiAn5qyK6ZmQ5LiN6LazJyxcbiAgICAgICAgY29kZTogJ0lOU1VGRklDSUVOVF9QRVJNSVNTSU9OUydcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGxldCByZXN1bHQ7XG4gICAgXG4gICAgaWYgKFVTRV9NT0NLX0VMQVNUSUNTRUFSQ0gpIHtcbiAgICAgIC8vIOS9v+eUqOaooeaTrOacjeWLmVxuICAgICAgcmVzdWx0ID0gYXdhaXQgbW9ja0VsYXN0aWNzZWFyY2hTZXJ2aWNlLnJlaW5kZXhBbGxQZXRzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOaqouafpSBFbGFzdGljc2VhcmNoIOmAo+aOpVxuICAgICAgaWYgKCFlbGFzdGljc2VhcmNoU2VydmljZS5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMykuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICfmkJzlsIvmnI3li5nmmqvmmYLkuI3lj6/nlKgnLFxuICAgICAgICAgIGNvZGU6ICdTRUFSQ0hfU0VSVklDRV9VTkFWQUlMQUJMRSdcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIOS9v+eUqOecn+WvpiBFbGFzdGljc2VhcmNoIOacjeWLmVxuICAgICAgcmVzdWx0ID0gYXdhaXQgcGV0U2VhcmNoU2VydmljZS5yZWluZGV4QWxsUGV0cygpO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKCfph43mlrDntKLlvJXlr7Xnianmlbjmk5rlrozmiJAnKTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAn6YeN5paw57Si5byV5Lu75YuZ5bey5a6M5oiQJyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgLi4ucmVzdWx0LFxuICAgICAgICBtb2NrOiBVU0VfTU9DS19FTEFTVElDU0VBUkNIXG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ+mHjeaWsOe0ouW8leWkseaVlzonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgZXJyb3I6ICfph43mlrDntKLlvJXlpLHmlZcnLFxuICAgICAgY29kZTogJ1JFSU5ERVhfRVJST1InXG4gICAgfSk7XG4gIH1cbn0pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7Il0sInZlcnNpb24iOjN9