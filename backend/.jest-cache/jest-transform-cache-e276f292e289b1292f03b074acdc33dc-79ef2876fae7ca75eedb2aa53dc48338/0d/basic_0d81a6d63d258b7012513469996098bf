6980666b68e6fbae6fc16ccfd1eead92
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const error_handler_1 = require("../../middleware/error-handler");
const errors_1 = require("../../utils/errors");
const logger_1 = require("../../utils/logger");
const cacheMiddleware_1 = require("../../middleware/cacheMiddleware");
const validation_1 = require("../../utils/validation");
const pet_1 = require("../../schemas/pet");
const search_1 = require("../../schemas/search");
const Pet_1 = require("../../models/Pet");
const SearchHistory_1 = require("../../models/SearchHistory");
const auth_1 = require("../../middleware/auth");
const rbac_1 = require("../../middleware/rbac");
const mongoose_1 = __importDefault(require("mongoose"));
const router = (0, express_1.Router)();
/**
 * @route   GET /api/pets
 * @desc    取得寵物列表
 * @access  Public
 */
router.get("/", (0, validation_1.validateQuery)(search_1.petSearchSchema), (0, cacheMiddleware_1.conditionalCacheMiddleware)({
    ttl: 3 * 60 * 1000, // 3分鐘快取
    keyGenerator: cacheMiddleware_1.petCacheKeyGenerator,
    userCondition: (req) => !req.user, // 只對未登入用戶快取
}), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { page = 1, limit = 12, status, type, breed, location, search, sortBy = "createdAt", sortOrder = "desc", radius = 10, } = req.validatedQuery;
    logger_1.logger.info("獲取寵物列表請求", {
        page,
        limit,
        status,
        type,
        breed,
        location,
        search,
        sortBy,
        sortOrder,
    });
    // 建立查詢條件
    const query = {};
    // 狀態篩選
    if (status) {
        query.status = status;
    }
    // 寵物類型篩選
    if (type) {
        query.type = type;
    }
    // 品種篩選
    if (breed) {
        query.breed = new RegExp(breed, "i");
    }
    // 文字搜尋（名稱、描述、地點）
    if (search) {
        query.$or = [
            { name: new RegExp(search, "i") },
            { description: new RegExp(search, "i") },
            { lastSeenLocation: new RegExp(search, "i") },
            { "contactInfo.name": new RegExp(search, "i") },
        ];
    }
    // 地點篩選
    if (location) {
        query.lastSeenLocation = new RegExp(location, "i");
    }
    // 計算分頁
    const skip = (page - 1) * limit;
    // 排序設定
    const sortOptions = {};
    sortOptions[sortBy] = sortOrder === "desc" ? -1 : 1;
    // 如果按緊急程度排序，優先顯示緊急案件
    if (sortBy === "createdAt") {
        sortOptions.isUrgent = -1;
    }
    // 執行查詢
    const [pets, totalItems] = await Promise.all([
        Pet_1.Pet.find(query)
            .sort(sortOptions)
            .skip(skip)
            .limit(limit)
            .populate("userId", "name email")
            .lean(),
        Pet_1.Pet.countDocuments(query),
    ]);
    // 記錄搜尋歷史（如果有搜尋條件且用戶已登入）
    if ((search || location || type || status || breed) && req.user?.id) {
        const searchQuery = search || location || "";
        const filters = {
            type,
            status,
            location,
            breed,
            radius,
        };
        // 異步記錄搜尋歷史，不影響主要回應
        SearchHistory_1.SearchHistory.recordSearch(req.user.id, searchQuery, filters, totalItems).catch((error) => {
            logger_1.logger.error("記錄搜尋歷史失敗:", error);
        });
    }
    // 計算分頁資訊
    const totalPages = Math.ceil(totalItems / limit);
    res.json({
        success: true,
        data: {
            pets,
            pagination: {
                currentPage: page,
                totalPages,
                totalItems,
                itemsPerPage: limit,
                hasNextPage: page < totalPages,
                hasPrevPage: page > 1,
            },
            filters: {
                status: ["lost", "found", "reunited"],
                type: ["dog", "cat", "bird", "rabbit", "other"],
                size: ["small", "medium", "large"],
                gender: ["male", "female", "unknown"],
            },
        },
    });
}));
/**
 * @route   GET /api/pets/:id
 * @desc    獲取特定寵物資訊
 * @access  Public
 */
router.get("/:id", (0, cacheMiddleware_1.createCacheMiddleware)({
    ttl: 10 * 60 * 1000, // 10分鐘快取
    keyGenerator: cacheMiddleware_1.petCacheKeyGenerator,
}), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { id } = req.params;
    if (!id || !mongoose_1.default.Types.ObjectId.isValid(id)) {
        throw new errors_1.ValidationError("請提供有效的寵物 ID");
    }
    logger_1.logger.info("獲取寵物詳細資訊請求", { petId: id });
    // 查找寵物並增加瀏覽次數
    const pet = await Pet_1.Pet.findByIdAndUpdate(id, { $inc: { viewCount: 1 } }, { new: true })
        .populate("userId", "name email")
        .lean();
    if (!pet) {
        throw new errors_1.NotFoundError("找不到指定的寵物資訊");
    }
    res.json({
        success: true,
        data: {
            pet,
        },
    });
}));
/**
 * @route   POST /api/pets
 * @desc    新增寵物協尋案例
 * @access  Private
 */
router.post("/", auth_1.authenticate, rbac_1.requireActiveAccount, (0, validation_1.validateRequest)(pet_1.petSchema), (0, cacheMiddleware_1.createCacheInvalidationMiddleware)({
    patterns: ["pets:*"], // 清除所有寵物相關快取
}), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const validatedData = req.validatedData;
    const userId = req.user.id;
    logger_1.logger.info("新增寵物協尋案例請求", {
        userId,
        name: validatedData.name,
        type: validatedData.type,
        status: validatedData.status,
        lastSeenLocation: validatedData.lastSeenLocation,
    });
    // 建立寵物資料
    const petData = {
        ...validatedData,
        userId: new mongoose_1.default.Types.ObjectId(userId),
        viewCount: 0,
        shareCount: 0,
    };
    // 儲存到資料庫
    const pet = new Pet_1.Pet(petData);
    await pet.save();
    // 填充用戶資訊
    await pet.populate("userId", "name email");
    res.status(201).json({
        success: true,
        message: "寵物協尋案例新增成功",
        data: {
            pet: pet.toJSON(),
        },
    });
}));
/**
 * @route   PUT /api/pets/:id
 * @desc    更新寵物協尋案例
 * @access  Private
 */
router.put("/:id", auth_1.authenticate, rbac_1.requireActiveAccount, (0, validation_1.validateRequest)(pet_1.petSchema), (0, cacheMiddleware_1.createCacheInvalidationMiddleware)({
    patterns: ["pets:*"], // 清除所有寵物相關快取
}), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { id } = req.params;
    const updateData = req.validatedData;
    const userId = req.user.id;
    if (!id || !mongoose_1.default.Types.ObjectId.isValid(id)) {
        throw new errors_1.ValidationError("請提供有效的寵物 ID");
    }
    logger_1.logger.info("更新寵物資訊請求", { petId: id, userId, updateData });
    // 查找寵物並檢查權限
    const pet = await Pet_1.Pet.findById(id);
    if (!pet) {
        throw new errors_1.NotFoundError("找不到指定的寵物資訊");
    }
    // 檢查是否為寵物擁有者或管理員
    if (pet.userId.toString() !== userId &&
        !(0, rbac_1.hasPermission)(req.user, rbac_1.Permission.PET_WRITE)) {
        throw new errors_1.ForbiddenError("您沒有權限修改此寵物資訊");
    }
    // 更新寵物資訊
    const updatedPet = await Pet_1.Pet.findByIdAndUpdate(id, { $set: updateData }, { new: true, runValidators: true }).populate("userId", "name email");
    res.json({
        success: true,
        message: "寵物資訊更新成功",
        data: {
            pet: updatedPet,
        },
    });
}));
/**
 * @route   DELETE /api/pets/:id
 * @desc    刪除寵物協尋案例
 * @access  Private
 */
router.delete("/:id", auth_1.authenticate, rbac_1.requireActiveAccount, (0, cacheMiddleware_1.createCacheInvalidationMiddleware)({
    patterns: ["pets:*"], // 清除所有寵物相關快取
}), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { id } = req.params;
    const userId = req.user.id;
    if (!id || !mongoose_1.default.Types.ObjectId.isValid(id)) {
        throw new errors_1.ValidationError("請提供有效的寵物 ID");
    }
    logger_1.logger.info("刪除寵物協尋案例請求", { petId: id, userId });
    // 查找寵物並檢查權限
    const pet = await Pet_1.Pet.findById(id);
    if (!pet) {
        throw new errors_1.NotFoundError("找不到指定的寵物資訊");
    }
    // 檢查是否為寵物擁有者或管理員
    if (pet.userId.toString() !== userId &&
        !(0, rbac_1.hasPermission)(req.user, rbac_1.Permission.PET_DELETE)) {
        throw new errors_1.ForbiddenError("您沒有權限刪除此寵物資訊");
    }
    // 執行刪除（硬刪除）
    await Pet_1.Pet.findByIdAndDelete(id);
    res.json({
        success: true,
        message: "寵物協尋案例已刪除",
    });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xccGV0c1xcYmFzaWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxxQ0FBaUM7QUFDakMsa0VBQThEO0FBQzlELCtDQUk0QjtBQUM1QiwrQ0FBNEM7QUFDNUMsc0VBSzBDO0FBQzFDLHVEQUF3RTtBQUN4RSwyQ0FBK0Q7QUFDL0QsaURBQXVEO0FBQ3ZELDBDQUE2QztBQUM3Qyw4REFBMkQ7QUFDM0QsZ0RBQXFEO0FBQ3JELGdEQUsrQjtBQUMvQix3REFBZ0M7QUFFaEMsTUFBTSxNQUFNLEdBQUcsSUFBQSxnQkFBTSxHQUFFLENBQUM7QUFFeEI7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxHQUFHLENBQ1IsR0FBRyxFQUNILElBQUEsMEJBQWEsRUFBQyx3QkFBZSxDQUFDLEVBQzlCLElBQUEsNENBQTBCLEVBQUM7SUFDekIsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLFFBQVE7SUFDNUIsWUFBWSxFQUFFLHNDQUFvQjtJQUNsQyxhQUFhLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxZQUFZO0NBQ2hELENBQUMsRUFDRixJQUFBLDRCQUFZLEVBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUM5QixNQUFNLEVBQ0osSUFBSSxHQUFHLENBQUMsRUFDUixLQUFLLEdBQUcsRUFBRSxFQUNWLE1BQU0sRUFDTixJQUFJLEVBQ0osS0FBSyxFQUNMLFFBQVEsRUFDUixNQUFNLEVBQ04sTUFBTSxHQUFHLFdBQVcsRUFDcEIsU0FBUyxHQUFHLE1BQU0sRUFDbEIsTUFBTSxHQUFHLEVBQUUsR0FDWixHQUFHLEdBQUcsQ0FBQyxjQUFjLENBQUM7SUFFdkIsZUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFDdEIsSUFBSTtRQUNKLEtBQUs7UUFD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RSxDQUFDO1FBQ1QsTUFBTSxJQUFJLHNCQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELGlCQUFpQjtJQUNqQixJQUNFLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEtBQUssTUFBTTtRQUNoQyxDQUFDLElBQUEsb0JBQWEsRUFBQyxHQUFHLENBQUMsSUFBSyxFQUFFLGlCQUFVLENBQUMsVUFBVSxDQUFDLEVBQ2hELENBQUM7UUFDRCxNQUFNLElBQUksdUJBQWMsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsWUFBWTtJQUNaLE1BQU0sU0FBRyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRWhDLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDUCxPQUFPLEVBQUUsSUFBSTtRQUNiLE9BQU8sRUFBRSxXQUFXO0tBQ3JCLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUNILENBQUM7QUFFRixrQkFBZSxNQUFNLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xccGV0c1xcYmFzaWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7IGFzeW5jSGFuZGxlciB9IGZyb20gXCIuLi8uLi9taWRkbGV3YXJlL2Vycm9yLWhhbmRsZXJcIjtcbmltcG9ydCB7XG4gIFZhbGlkYXRpb25FcnJvcixcbiAgTm90Rm91bmRFcnJvcixcbiAgRm9yYmlkZGVuRXJyb3IsXG59IGZyb20gXCIuLi8uLi91dGlscy9lcnJvcnNcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCIuLi8uLi91dGlscy9sb2dnZXJcIjtcbmltcG9ydCB7XG4gIGNyZWF0ZUNhY2hlTWlkZGxld2FyZSxcbiAgY3JlYXRlQ2FjaGVJbnZhbGlkYXRpb25NaWRkbGV3YXJlLFxuICBwZXRDYWNoZUtleUdlbmVyYXRvcixcbiAgY29uZGl0aW9uYWxDYWNoZU1pZGRsZXdhcmUsXG59IGZyb20gXCIuLi8uLi9taWRkbGV3YXJlL2NhY2hlTWlkZGxld2FyZVwiO1xuaW1wb3J0IHsgdmFsaWRhdGVSZXF1ZXN0LCB2YWxpZGF0ZVF1ZXJ5IH0gZnJvbSBcIi4uLy4uL3V0aWxzL3ZhbGlkYXRpb25cIjtcbmltcG9ydCB7IHBldFNjaGVtYSwgcGV0VXBkYXRlU2NoZW1hIH0gZnJvbSBcIi4uLy4uL3NjaGVtYXMvcGV0XCI7XG5pbXBvcnQgeyBwZXRTZWFyY2hTY2hlbWEgfSBmcm9tIFwiLi4vLi4vc2NoZW1hcy9zZWFyY2hcIjtcbmltcG9ydCB7IFBldCwgSVBldCB9IGZyb20gXCIuLi8uLi9tb2RlbHMvUGV0XCI7XG5pbXBvcnQgeyBTZWFyY2hIaXN0b3J5IH0gZnJvbSBcIi4uLy4uL21vZGVscy9TZWFyY2hIaXN0b3J5XCI7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tIFwiLi4vLi4vbWlkZGxld2FyZS9hdXRoXCI7XG5pbXBvcnQge1xuICByZXF1aXJlUGVybWlzc2lvbixcbiAgUGVybWlzc2lvbixcbiAgcmVxdWlyZUFjdGl2ZUFjY291bnQsXG4gIGhhc1Blcm1pc3Npb24sXG59IGZyb20gXCIuLi8uLi9taWRkbGV3YXJlL3JiYWNcIjtcbmltcG9ydCBtb25nb29zZSBmcm9tIFwibW9uZ29vc2VcIjtcblxuY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5cbi8qKlxuICogQHJvdXRlICAgR0VUIC9hcGkvcGV0c1xuICogQGRlc2MgICAg5Y+W5b6X5a+154mp5YiX6KGoXG4gKiBAYWNjZXNzICBQdWJsaWNcbiAqL1xucm91dGVyLmdldChcbiAgXCIvXCIsXG4gIHZhbGlkYXRlUXVlcnkocGV0U2VhcmNoU2NoZW1hKSxcbiAgY29uZGl0aW9uYWxDYWNoZU1pZGRsZXdhcmUoe1xuICAgIHR0bDogMyAqIDYwICogMTAwMCwgLy8gM+WIhumQmOW/q+WPllxuICAgIGtleUdlbmVyYXRvcjogcGV0Q2FjaGVLZXlHZW5lcmF0b3IsXG4gICAgdXNlckNvbmRpdGlvbjogKHJlcSkgPT4gIXJlcS51c2VyLCAvLyDlj6rlsI3mnKrnmbvlhaXnlKjmiLblv6vlj5ZcbiAgfSksXG4gIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7XG4gICAgICBwYWdlID0gMSxcbiAgICAgIGxpbWl0ID0gMTIsXG4gICAgICBzdGF0dXMsXG4gICAgICB0eXBlLFxuICAgICAgYnJlZWQsXG4gICAgICBsb2NhdGlvbixcbiAgICAgIHNlYXJjaCxcbiAgICAgIHNvcnRCeSA9IFwiY3JlYXRlZEF0XCIsXG4gICAgICBzb3J0T3JkZXIgPSBcImRlc2NcIixcbiAgICAgIHJhZGl1cyA9IDEwLFxuICAgIH0gPSByZXEudmFsaWRhdGVkUXVlcnk7XG5cbiAgICBsb2dnZXIuaW5mbyhcIueNsuWPluWvteeJqeWIl+ihqOiri+axglwiLCB7XG4gICAgICBwYWdlLFxuICAgICAgbGltaXQsXG4gICAgICBzdGF0dXMsXG4gICAgICB0eXBlLFxuICAgICAgYnJlZWQsXG4gICAgICBsb2NhdGlvbixcbiAgICAgIHNlYXJjaCxcbiAgICAgIHNvcnRCeSxcbiAgICAgIHNvcnRPcmRlcixcbiAgICB9KTtcblxuICAgIC8vIOW7uueri+afpeipouaineS7tlxuICAgIGNvbnN0IHF1ZXJ5OiBhbnkgPSB7fTtcblxuICAgIC8vIOeLgOaFi+evqemBuFxuICAgIGlmIChzdGF0dXMpIHtcbiAgICAgIHF1ZXJ5LnN0YXR1cyA9IHN0YXR1cztcbiAgICB9XG5cbiAgICAvLyDlr7XnianpoZ7lnovnr6npgbhcbiAgICBpZiAodHlwZSkge1xuICAgICAgcXVlcnkudHlwZSA9IHR5cGU7XG4gICAgfVxuXG4gICAgLy8g5ZOB56iu56+p6YG4XG4gICAgaWYgKGJyZWVkKSB7XG4gICAgICBxdWVyeS5icmVlZCA9IG5ldyBSZWdFeHAoYnJlZWQsIFwiaVwiKTtcbiAgICB9XG5cbiAgICAvLyDmloflrZfmkJzlsIvvvIjlkI3nqLHjgIHmj4/ov7DjgIHlnLDpu57vvIlcbiAgICBpZiAoc2VhcmNoKSB7XG4gICAgICBxdWVyeS4kb3IgPSBbXG4gICAgICAgIHsgbmFtZTogbmV3IFJlZ0V4cChzZWFyY2gsIFwiaVwiKSB9LFxuICAgICAgICB7IGRlc2NyaXB0aW9uOiBuZXcgUmVnRXhwKHNlYXJjaCwgXCJpXCIpIH0sXG4gICAgICAgIHsgbGFzdFNlZW5Mb2NhdGlvbjogbmV3IFJlZ0V4cChzZWFyY2gsIFwiaVwiKSB9LFxuICAgICAgICB7IFwiY29udGFjdEluZm8ubmFtZVwiOiBuZXcgUmVnRXhwKHNlYXJjaCwgXCJpXCIpIH0sXG4gICAgICBdO1xuICAgIH1cblxuICAgIC8vIOWcsOm7nuevqemBuFxuICAgIGlmIChsb2NhdGlvbikge1xuICAgICAgcXVlcnkubGFzdFNlZW5Mb2NhdGlvbiA9IG5ldyBSZWdFeHAobG9jYXRpb24sIFwiaVwiKTtcbiAgICB9XG5cbiAgICAvLyDoqIjnrpfliIbpoIFcbiAgICBjb25zdCBza2lwID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xuXG4gICAgLy8g5o6S5bqP6Kit5a6aXG4gICAgY29uc3Qgc29ydE9wdGlvbnM6IGFueSA9IHt9O1xuICAgIHNvcnRPcHRpb25zW3NvcnRCeV0gPSBzb3J0T3JkZXIgPT09IFwiZGVzY1wiID8gLTEgOiAxO1xuXG4gICAgLy8g5aaC5p6c5oyJ57eK5oCl56iL5bqm5o6S5bqP77yM5YSq5YWI6aGv56S657eK5oCl5qGI5Lu2XG4gICAgaWYgKHNvcnRCeSA9PT0gXCJjcmVhdGVkQXRcIikge1xuICAgICAgc29ydE9wdGlvbnMuaXNVcmdlbnQgPSAtMTtcbiAgICB9XG5cbiAgICAvLyDln7fooYzmn6XoqaJcbiAgICBjb25zdCBbcGV0cywgdG90YWxJdGVtc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBQZXQuZmluZChxdWVyeSlcbiAgICAgICAgLnNvcnQoc29ydE9wdGlvbnMpXG4gICAgICAgIC5za2lwKHNraXApXG4gICAgICAgIC5saW1pdChsaW1pdClcbiAgICAgICAgLnBvcHVsYXRlKFwidXNlcklkXCIsIFwibmFtZSBlbWFpbFwiKVxuICAgICAgICAubGVhbigpLFxuICAgICAgUGV0LmNvdW50RG9jdW1lbnRzKHF1ZXJ5KSxcbiAgICBdKTtcblxuICAgIC8vIOiomOmMhOaQnOWwi+att+WPsu+8iOWmguaenOacieaQnOWwi+aineS7tuS4lOeUqOaItuW3sueZu+WFpe+8iVxuICAgIGlmICgoc2VhcmNoIHx8IGxvY2F0aW9uIHx8IHR5cGUgfHwgc3RhdHVzIHx8IGJyZWVkKSAmJiByZXEudXNlcj8uaWQpIHtcbiAgICAgIGNvbnN0IHNlYXJjaFF1ZXJ5ID0gc2VhcmNoIHx8IGxvY2F0aW9uIHx8IFwiXCI7XG4gICAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgICB0eXBlLFxuICAgICAgICBzdGF0dXMsXG4gICAgICAgIGxvY2F0aW9uLFxuICAgICAgICBicmVlZCxcbiAgICAgICAgcmFkaXVzLFxuICAgICAgfTtcblxuICAgICAgLy8g55Ww5q2l6KiY6YyE5pCc5bCL5q235Y+y77yM5LiN5b2x6Z+/5Li76KaB5Zue5oeJXG4gICAgICBTZWFyY2hIaXN0b3J5LnJlY29yZFNlYXJjaChcbiAgICAgICAgcmVxLnVzZXIuaWQsXG4gICAgICAgIHNlYXJjaFF1ZXJ5LFxuICAgICAgICBmaWx0ZXJzLFxuICAgICAgICB0b3RhbEl0ZW1zLFxuICAgICAgKS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwi6KiY6YyE5pCc5bCL5q235Y+y5aSx5pWXOlwiLCBlcnJvcik7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyDoqIjnrpfliIbpoIHos4foqIpcbiAgICBjb25zdCB0b3RhbFBhZ2VzID0gTWF0aC5jZWlsKHRvdGFsSXRlbXMgLyBsaW1pdCk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBwZXRzLFxuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgY3VycmVudFBhZ2U6IHBhZ2UsXG4gICAgICAgICAgdG90YWxQYWdlcyxcbiAgICAgICAgICB0b3RhbEl0ZW1zLFxuICAgICAgICAgIGl0ZW1zUGVyUGFnZTogbGltaXQsXG4gICAgICAgICAgaGFzTmV4dFBhZ2U6IHBhZ2UgPCB0b3RhbFBhZ2VzLFxuICAgICAgICAgIGhhc1ByZXZQYWdlOiBwYWdlID4gMSxcbiAgICAgICAgfSxcbiAgICAgICAgZmlsdGVyczoge1xuICAgICAgICAgIHN0YXR1czogW1wibG9zdFwiLCBcImZvdW5kXCIsIFwicmV1bml0ZWRcIl0sXG4gICAgICAgICAgdHlwZTogW1wiZG9nXCIsIFwiY2F0XCIsIFwiYmlyZFwiLCBcInJhYmJpdFwiLCBcIm90aGVyXCJdLFxuICAgICAgICAgIHNpemU6IFtcInNtYWxsXCIsIFwibWVkaXVtXCIsIFwibGFyZ2VcIl0sXG4gICAgICAgICAgZ2VuZGVyOiBbXCJtYWxlXCIsIFwiZmVtYWxlXCIsIFwidW5rbm93blwiXSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pLFxuKTtcblxuLyoqXG4gKiBAcm91dGUgICBHRVQgL2FwaS9wZXRzLzppZFxuICogQGRlc2MgICAg542y5Y+W54m55a6a5a+154mp6LOH6KiKXG4gKiBAYWNjZXNzICBQdWJsaWNcbiAqL1xucm91dGVyLmdldChcbiAgXCIvOmlkXCIsXG4gIGNyZWF0ZUNhY2hlTWlkZGxld2FyZSh7XG4gICAgdHRsOiAxMCAqIDYwICogMTAwMCwgLy8gMTDliIbpkJjlv6vlj5ZcbiAgICBrZXlHZW5lcmF0b3I6IHBldENhY2hlS2V5R2VuZXJhdG9yLFxuICB9KSxcbiAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG5cbiAgICBpZiAoIWlkIHx8ICFtb25nb29zZS5UeXBlcy5PYmplY3RJZC5pc1ZhbGlkKGlkKSkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcIuiri+aPkOS+m+acieaViOeahOWvteeJqSBJRFwiKTtcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbyhcIueNsuWPluWvteeJqeips+e0sOizh+ioiuiri+axglwiLCB7IHBldElkOiBpZCB9KTtcblxuICAgIC8vIOafpeaJvuWvteeJqeS4puWinuWKoOeAj+imveasoeaVuFxuICAgIGNvbnN0IHBldCA9IGF3YWl0IFBldC5maW5kQnlJZEFuZFVwZGF0ZShcbiAgICAgIGlkLFxuICAgICAgeyAkaW5jOiB7IHZpZXdDb3VudDogMSB9IH0sXG4gICAgICB7IG5ldzogdHJ1ZSB9LFxuICAgIClcbiAgICAgIC5wb3B1bGF0ZShcInVzZXJJZFwiLCBcIm5hbWUgZW1haWxcIilcbiAgICAgIC5sZWFuKCk7XG5cbiAgICBpZiAoIXBldCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoXCLmib7kuI3liLDmjIflrprnmoTlr7Xnianos4foqIpcIik7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcGV0LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSksXG4pO1xuXG4vKipcbiAqIEByb3V0ZSAgIFBPU1QgL2FwaS9wZXRzXG4gKiBAZGVzYyAgICDmlrDlop7lr7XnianljZTlsIvmoYjkvotcbiAqIEBhY2Nlc3MgIFByaXZhdGVcbiAqL1xucm91dGVyLnBvc3QoXG4gIFwiL1wiLFxuICBhdXRoZW50aWNhdGUsXG4gIHJlcXVpcmVBY3RpdmVBY2NvdW50LFxuICB2YWxpZGF0ZVJlcXVlc3QocGV0U2NoZW1hKSxcbiAgY3JlYXRlQ2FjaGVJbnZhbGlkYXRpb25NaWRkbGV3YXJlKHtcbiAgICBwYXR0ZXJuczogW1wicGV0czoqXCJdLCAvLyDmuIXpmaTmiYDmnInlr7Xniannm7jpl5zlv6vlj5ZcbiAgfSksXG4gIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB2YWxpZGF0ZWREYXRhID0gcmVxLnZhbGlkYXRlZERhdGE7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgbG9nZ2VyLmluZm8oXCLmlrDlop7lr7XnianljZTlsIvmoYjkvovoq4vmsYJcIiwge1xuICAgICAgdXNlcklkLFxuICAgICAgbmFtZTogdmFsaWRhdGVkRGF0YS5uYW1lLFxuICAgICAgdHlwZTogdmFsaWRhdGVkRGF0YS50eXBlLFxuICAgICAgc3RhdHVzOiB2YWxpZGF0ZWREYXRhLnN0YXR1cyxcbiAgICAgIGxhc3RTZWVuTG9jYXRpb246IHZhbGlkYXRlZERhdGEubGFzdFNlZW5Mb2NhdGlvbixcbiAgICB9KTtcblxuICAgIC8vIOW7uueri+WvteeJqeizh+aWmVxuICAgIGNvbnN0IHBldERhdGEgPSB7XG4gICAgICAuLi52YWxpZGF0ZWREYXRhLFxuICAgICAgdXNlcklkOiBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKSxcbiAgICAgIHZpZXdDb3VudDogMCxcbiAgICAgIHNoYXJlQ291bnQ6IDAsXG4gICAgfTtcblxuICAgIC8vIOWEsuWtmOWIsOizh+aWmeW6q1xuICAgIGNvbnN0IHBldCA9IG5ldyBQZXQocGV0RGF0YSk7XG4gICAgYXdhaXQgcGV0LnNhdmUoKTtcblxuICAgIC8vIOWhq+WFheeUqOaItuizh+ioilxuICAgIGF3YWl0IHBldC5wb3B1bGF0ZShcInVzZXJJZFwiLCBcIm5hbWUgZW1haWxcIik7XG5cbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgbWVzc2FnZTogXCLlr7XnianljZTlsIvmoYjkvovmlrDlop7miJDlip9cIixcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcGV0OiBwZXQudG9KU09OKCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9KSxcbik7XG5cbi8qKlxuICogQHJvdXRlICAgUFVUIC9hcGkvcGV0cy86aWRcbiAqIEBkZXNjICAgIOabtOaWsOWvteeJqeWNlOWwi+ahiOS+i1xuICogQGFjY2VzcyAgUHJpdmF0ZVxuICovXG5yb3V0ZXIucHV0KFxuICBcIi86aWRcIixcbiAgYXV0aGVudGljYXRlLFxuICByZXF1aXJlQWN0aXZlQWNjb3VudCxcbiAgdmFsaWRhdGVSZXF1ZXN0KHBldFNjaGVtYSksXG4gIGNyZWF0ZUNhY2hlSW52YWxpZGF0aW9uTWlkZGxld2FyZSh7XG4gICAgcGF0dGVybnM6IFtcInBldHM6KlwiXSwgLy8g5riF6Zmk5omA5pyJ5a+154mp55u46Zec5b+r5Y+WXG4gIH0pLFxuICBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1cGRhdGVEYXRhID0gcmVxLnZhbGlkYXRlZERhdGE7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgaWYgKCFpZCB8fCAhbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQuaXNWYWxpZChpZCkpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXCLoq4vmj5DkvpvmnInmlYjnmoTlr7XniakgSURcIik7XG4gICAgfVxuXG4gICAgbG9nZ2VyLmluZm8oXCLmm7TmlrDlr7Xnianos4foqIroq4vmsYJcIiwgeyBwZXRJZDogaWQsIHVzZXJJZCwgdXBkYXRlRGF0YSB9KTtcblxuICAgIC8vIOafpeaJvuWvteeJqeS4puaqouafpeasiumZkFxuICAgIGNvbnN0IHBldCA9IGF3YWl0IFBldC5maW5kQnlJZChpZCk7XG4gICAgaWYgKCFwZXQpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKFwi5om+5LiN5Yiw5oyH5a6a55qE5a+154mp6LOH6KiKXCIpO1xuICAgIH1cblxuICAgIC8vIOaqouafpeaYr+WQpueCuuWvteeJqeaTgeacieiAheaIlueuoeeQhuWToVxuICAgIGlmIChcbiAgICAgIHBldC51c2VySWQudG9TdHJpbmcoKSAhPT0gdXNlcklkICYmXG4gICAgICAhaGFzUGVybWlzc2lvbihyZXEudXNlciEsIFBlcm1pc3Npb24uUEVUX1dSSVRFKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkVycm9yKFwi5oKo5rKS5pyJ5qyK6ZmQ5L+u5pS55q2k5a+154mp6LOH6KiKXCIpO1xuICAgIH1cblxuICAgIC8vIOabtOaWsOWvteeJqeizh+ioilxuICAgIGNvbnN0IHVwZGF0ZWRQZXQgPSBhd2FpdCBQZXQuZmluZEJ5SWRBbmRVcGRhdGUoXG4gICAgICBpZCxcbiAgICAgIHsgJHNldDogdXBkYXRlRGF0YSB9LFxuICAgICAgeyBuZXc6IHRydWUsIHJ1blZhbGlkYXRvcnM6IHRydWUgfSxcbiAgICApLnBvcHVsYXRlKFwidXNlcklkXCIsIFwibmFtZSBlbWFpbFwiKTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiBcIuWvteeJqeizh+ioiuabtOaWsOaIkOWKn1wiLFxuICAgICAgZGF0YToge1xuICAgICAgICBwZXQ6IHVwZGF0ZWRQZXQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9KSxcbik7XG5cbi8qKlxuICogQHJvdXRlICAgREVMRVRFIC9hcGkvcGV0cy86aWRcbiAqIEBkZXNjICAgIOWIqumZpOWvteeJqeWNlOWwi+ahiOS+i1xuICogQGFjY2VzcyAgUHJpdmF0ZVxuICovXG5yb3V0ZXIuZGVsZXRlKFxuICBcIi86aWRcIixcbiAgYXV0aGVudGljYXRlLFxuICByZXF1aXJlQWN0aXZlQWNjb3VudCxcbiAgY3JlYXRlQ2FjaGVJbnZhbGlkYXRpb25NaWRkbGV3YXJlKHtcbiAgICBwYXR0ZXJuczogW1wicGV0czoqXCJdLCAvLyDmuIXpmaTmiYDmnInlr7Xniannm7jpl5zlv6vlj5ZcbiAgfSksXG4gIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgIGlmICghaWQgfHwgIW1vbmdvb3NlLlR5cGVzLk9iamVjdElkLmlzVmFsaWQoaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFwi6KuL5o+Q5L6b5pyJ5pWI55qE5a+154mpIElEXCIpO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKFwi5Yiq6Zmk5a+154mp5Y2U5bCL5qGI5L6L6KuL5rGCXCIsIHsgcGV0SWQ6IGlkLCB1c2VySWQgfSk7XG5cbiAgICAvLyDmn6Xmib7lr7XniankuKbmqqLmn6XmrIrpmZBcbiAgICBjb25zdCBwZXQgPSBhd2FpdCBQZXQuZmluZEJ5SWQoaWQpO1xuICAgIGlmICghcGV0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcihcIuaJvuS4jeWIsOaMh+WumueahOWvteeJqeizh+ioilwiKTtcbiAgICB9XG5cbiAgICAvLyDmqqLmn6XmmK/lkKbngrrlr7Xnianmk4HmnInogIXmiJbnrqHnkIblk6FcbiAgICBpZiAoXG4gICAgICBwZXQudXNlcklkLnRvU3RyaW5nKCkgIT09IHVzZXJJZCAmJlxuICAgICAgIWhhc1Blcm1pc3Npb24ocmVxLnVzZXIhLCBQZXJtaXNzaW9uLlBFVF9ERUxFVEUpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXJyb3IoXCLmgqjmspLmnInmrIrpmZDliKrpmaTmraTlr7Xnianos4foqIpcIik7XG4gICAgfVxuXG4gICAgLy8g5Z+36KGM5Yiq6Zmk77yI56Gs5Yiq6Zmk77yJXG4gICAgYXdhaXQgUGV0LmZpbmRCeUlkQW5kRGVsZXRlKGlkKTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiBcIuWvteeJqeWNlOWwi+ahiOS+i+W3suWIqumZpFwiLFxuICAgIH0pO1xuICB9KSxcbik7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==