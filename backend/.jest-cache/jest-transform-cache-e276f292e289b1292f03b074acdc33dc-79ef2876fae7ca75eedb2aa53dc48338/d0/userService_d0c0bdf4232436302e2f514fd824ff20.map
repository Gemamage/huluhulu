{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\services\\userService.ts","mappings":";;;;;;AACA,mEAAgE;AAChE,4CAAsF;AACtF,4CAAyC;AACzC,wDAAgC;AA2ChC;;GAEG;AACH,MAAa,WAAW;IAGtB;QACE,IAAI,CAAC,cAAc,GAAG,IAAI,+BAAc,EAAE,CAAC;IAC7C,CAAC;IACD;;OAEG;IACH,KAAK,CAAC,YAAY,CAAC,QAA0B;QAI3C,IAAI,CAAC;YACH,cAAc;YACd,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC;YACzF,IAAI,YAAY,EAAE,CAAC;gBACjB,MAAM,IAAI,wBAAe,CAAC,WAAW,CAAC,CAAC;YACzC,CAAC;YAED,UAAU;YACV,MAAM,WAAW,GAAG;gBAClB,KAAK,EAAE,QAAQ,CAAC,KAAK,CAAC,WAAW,EAAE;gBACnC,QAAQ,EAAE,QAAQ,CAAC,QAAQ;gBAC3B,IAAI,EAAE,QAAQ,CAAC,IAAI,CAAC,IAAI,EAAE;gBAC1B,KAAK,EAAE,QAAQ,CAAC,KAAK,EAAE,IAAI,EAAE;aAC9B,CAAC;YAEF,QAAQ;YACR,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;YAE3D,aAAa;YACb,IAAI,CAAC,8BAA8B,EAAE,CAAC;YAEtC,OAAO;YACP,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAElB,SAAS;YACT,MAAM,SAAS,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAE3C,eAAM,CAAC,IAAI,CAAC,QAAQ,EAAE;gBACpB,MAAM,EAAE,IAAI,CAAC,GAAG;gBAChB,KAAK,EAAE,IAAI,CAAC,KAAK;gBACjB,IAAI,EAAE,IAAI,CAAC,IAAI;aAChB,CAAC,CAAC;YAEH,mBAAmB;YACnB,2EAA2E;YAE3E,OAAO;gBACL,IAAI;gBACJ,KAAK,EAAE,SAAS;aACjB,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,EAAE,KAAK,EAAE,QAAQ,CAAC,KAAK,EAAE,IAAI,EAAE,QAAQ,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;YAC5F,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,SAAS,CAAC,SAAwB;QAItC,IAAI,CAAC;YACH,aAAa;YACb,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,SAAS,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC;YAElF,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,4BAAmB,CAAC,WAAW,CAAC,CAAC;YAC7C,CAAC;YAED,WAAW;YACX,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACnB,MAAM,IAAI,4BAAmB,CAAC,UAAU,CAAC,CAAC;YAC5C,CAAC;YAED,OAAO;YACP,MAAM,eAAe,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;YACvE,IAAI,CAAC,eAAe,EAAE,CAAC;gBACrB,MAAM,IAAI,4BAAmB,CAAC,WAAW,CAAC,CAAC;YAC7C,CAAC;YAED,WAAW;YACX,IAAI,CAAC,WAAW,GAAG,IAAI,IAAI,EAAE,CAAC;YAC9B,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAElB,SAAS;YACT,MAAM,KAAK,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAEvC,eAAM,CAAC,IAAI,CAAC,QAAQ,EAAE;gBACpB,MAAM,EAAE,IAAI,CAAC,GAAG;gBAChB,KAAK,EAAE,IAAI,CAAC,KAAK;gBACjB,WAAW,EAAE,IAAI,CAAC,WAAW;aAC9B,CAAC,CAAC;YAEH,OAAO;gBACL,IAAI;gBACJ,KAAK;aACN,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,SAAS,CAAC,KAAK,EAAE,CAAC,CAAC;YAC1D,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,WAAW,CAAC,MAAc;QAC9B,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YACxD,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc,CAAC,KAAa;QAChC,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC;YACxE,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,cAAc,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;YAC/C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,UAAU,CAAC,MAAc,EAAE,UAA0B;QACzD,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YACxD,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,SAAS;YACT,IAAI,UAAU,CAAC,IAAI,KAAK,SAAS,EAAE,CAAC;gBAClC,IAAI,CAAC,IAAI,GAAG,UAAU,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;YACrC,CAAC;YACD,IAAI,UAAU,CAAC,KAAK,KAAK,SAAS,EAAE,CAAC;gBACnC,IAAI,CAAC,KAAK,GAAG,UAAU,CAAC,KAAK,EAAE,IAAI,EAAE,CAAC;YACxC,CAAC;YACD,IAAI,UAAU,CAAC,MAAM,KAAK,SAAS,EAAE,CAAC;gBACpC,IAAI,CAAC,MAAM,GAAG,UAAU,CAAC,MAAM,CAAC;YAClC,CAAC;YAED,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAElB,eAAM,CAAC,IAAI,CAAC,UAAU,EAAE;gBACtB,MAAM,EAAE,IAAI,CAAC,GAAG;gBAChB,aAAa,EAAE,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;aACvC,CAAC,CAAC;YAEH,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YACxD,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc,CAClB,MAAc,EACd,eAAuB,EACvB,WAAmB;QAEnB,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YACxD,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,SAAS;YACT,MAAM,sBAAsB,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,eAAe,CAAC,CAAC;YAC3E,IAAI,CAAC,sBAAsB,EAAE,CAAC;gBAC5B,MAAM,IAAI,4BAAmB,CAAC,QAAQ,CAAC,CAAC;YAC1C,CAAC;YAED,QAAQ;YACR,IAAI,CAAC,QAAQ,GAAG,WAAW,CAAC;YAC5B,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAElB,eAAM,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;QAChD,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC5C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,aAAa,CAAC,KAAa,EAAE,WAAmB;QACpD,IAAI,CAAC;YACH,gBAAgB;YAChB,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,kCAAkC,CAAC,KAAK,CAAC,CAAC;YAEjF,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,wBAAe,CAAC,cAAc,CAAC,CAAC;YAC5C,CAAC;YAED,eAAe;YACf,IAAI,CAAC,QAAQ,GAAG,WAAW,CAAC;YAC5B,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;YAC/B,IAAI,CAAC,oBAAoB,GAAG,IAAI,CAAC;YAEjC,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAElB,eAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;QAC9C,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YAClC,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,WAAW,CAAC,MAAc,EAAE,KAAa;QAC7C,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YACxD,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;gBACzB,MAAM,IAAI,wBAAe,CAAC,YAAY,CAAC,CAAC;YAC1C,CAAC;YAED,IAAI,CAAC,IAAI,CAAC,sBAAsB,IAAI,IAAI,CAAC,sBAAsB,KAAK,KAAK,EAAE,CAAC;gBAC1E,MAAM,IAAI,wBAAe,CAAC,YAAY,CAAC,CAAC;YAC1C,CAAC;YAED,WAAW;YACX,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;YAC5B,IAAI,CAAC,sBAAsB,GAAG,IAAI,CAAC;YACnC,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAElB,eAAM,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;QACtC,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;YACnD,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,kBAAkB,CAAC,KAAa;QACpC,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,4BAA4B,CAAC,KAAK,CAAC,CAAC;YAC3E,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,wBAAe,CAAC,YAAY,CAAC,CAAC;YAC1C,CAAC;YAED,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;gBACzB,MAAM,IAAI,wBAAe,CAAC,YAAY,CAAC,CAAC;YAC1C,CAAC;YAED,WAAW;YACX,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;YAC5B,IAAI,CAAC,sBAAsB,GAAG,IAAI,CAAC;YACnC,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAElB,eAAM,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;QAChD,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;YAC3C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc,CAAC,MAAc;QACjC,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YACxD,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,MAAM,IAAI,CAAC,cAAc,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;YAE7C,eAAM,CAAC,IAAI,CAAC,OAAO,EAAE,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;QAC7C,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,QAAQ,CAAC,UAA4B,EAAE;QAO3C,IAAI,CAAC;YACH,MAAM,EACJ,IAAI,GAAG,CAAC,EACR,KAAK,GAAG,EAAE,EACV,MAAM,EACN,QAAQ,EACR,eAAe,EACf,IAAI,EACJ,MAAM,GAAG,WAAW,EACpB,SAAS,GAAG,MAAM,GACnB,GAAG,OAAO,CAAC;YAEZ,SAAS;YACT,MAAM,KAAK,GAAQ,EAAE,CAAC;YAEtB,IAAI,MAAM,EAAE,CAAC;gBACX,KAAK,CAAC,GAAG,GAAG;oBACV,EAAE,IAAI,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,EAAE,EAAE;oBAC3C,EAAE,KAAK,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,EAAE,EAAE;iBAC7C,CAAC;YACJ,CAAC;YAED,IAAI,QAAQ,KAAK,SAAS,EAAE,CAAC;gBAC3B,KAAK,CAAC,QAAQ,GAAG,QAAQ,CAAC;YAC5B,CAAC;YAED,IAAI,eAAe,KAAK,SAAS,EAAE,CAAC;gBAClC,KAAK,CAAC,eAAe,GAAG,eAAe,CAAC;YAC1C,CAAC;YAED,IAAI,IAAI,EAAE,CAAC;gBACT,KAAK,CAAC,IAAI,GAAG,IAAI,CAAC;YACpB,CAAC;YAED,OAAO;YACP,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,kBAAkB,CAAC,KAAK,EAAE;gBAC3E,IAAI;gBACJ,KAAK;gBACL,MAAM;gBACN,SAAS;aACV,CAAC,CAAC;YAEH,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;YAE5C,OAAO;gBACL,KAAK;gBACL,KAAK;gBACL,IAAI;gBACJ,KAAK;gBACL,UAAU;aACX,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE,CAAC,CAAC;YAC7C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED,sBAAsB;IAEtB;;OAEG;IACH,KAAK,CAAC,gBAAgB,CAAC,UAA4B,EAAE;QAOnD,IAAI,CAAC;YACH,MAAM,EACJ,IAAI,GAAG,CAAC,EACR,KAAK,GAAG,EAAE,EACV,MAAM,EACN,IAAI,EACJ,QAAQ,EACR,eAAe,GAChB,GAAG,OAAO,CAAC;YAEZ,SAAS;YACT,MAAM,MAAM,GAAQ,EAAE,CAAC;YAEvB,IAAI,MAAM,EAAE,CAAC;gBACX,MAAM,CAAC,GAAG,GAAG;oBACX,EAAE,IAAI,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,EAAE,EAAE;oBAC3C,EAAE,KAAK,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,EAAE,EAAE;iBAC7C,CAAC;YACJ,CAAC;YAED,IAAI,IAAI;gBAAE,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC;YAC7B,IAAI,QAAQ,KAAK,SAAS;gBAAE,MAAM,CAAC,QAAQ,GAAG,QAAQ,CAAC;YACvD,IAAI,eAAe,KAAK,SAAS;gBAAE,MAAM,CAAC,eAAe,GAAG,eAAe,CAAC;YAE5E,OAAO;YACP,MAAM,IAAI,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC;YAChD,MAAM,YAAY,GAAG,uGAAuG,CAAC;YAE7H,MAAM,CAAC,KAAK,EAAE,KAAK,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;gBACvC,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,EAAE,YAAY,EAAE;oBACvD,IAAI,EAAE,EAAE,SAAS,EAAE,CAAC,CAAC,EAAE;oBACvB,IAAI;oBACJ,KAAK,EAAE,MAAM,CAAC,KAAK,CAAC;iBACrB,CAAC;gBACF,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,CAAC;aAC3C,CAAC,CAAC;YAEH,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;YAEpD,OAAO;gBACL,KAAK;gBACL,KAAK;gBACL,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC;gBAClB,KAAK,EAAE,MAAM,CAAC,KAAK,CAAC;gBACpB,UAAU;aACX,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,aAAa,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE,CAAC,CAAC;YAChD,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,gBAAgB,CAAC,MAAc;QACnC,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,MAAM,YAAY,GAAG,uGAAuG,CAAC;YAC7H,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,kBAAkB,CAAC,MAAM,EAAE,YAAY,CAAC,CAAC;YAEhF,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,aAAa,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC/C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,eAAe,CACnB,MAAc,EACd,UAA+B,EAC/B,SAAgB;QAEhB,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,aAAa;YACb,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YAC9D,IAAI,CAAC,UAAU,EAAE,CAAC;gBAChB,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,kBAAkB;YAClB,IAAI,UAAU,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,SAAS,CAAC,GAAG,CAAC,QAAQ,EAAE,EAAE,CAAC;gBAC3D,IAAI,UAAU,CAAC,IAAI,KAAK,SAAS,IAAI,UAAU,CAAC,QAAQ,KAAK,SAAS,EAAE,CAAC;oBACvE,MAAM,IAAI,wBAAe,CAAC,gBAAgB,CAAC,CAAC;gBAC9C,CAAC;YACH,CAAC;YAED,mBAAmB;YACnB,IAAI,UAAU,CAAC,IAAI,KAAK,OAAO,IAAI,SAAS,CAAC,IAAI,KAAK,OAAO,EAAE,CAAC;gBAC9D,MAAM,IAAI,wBAAe,CAAC,kBAAkB,CAAC,CAAC;YAChD,CAAC;YAED,SAAS;YACT,MAAM,YAAY,GAAQ,EAAE,CAAC;YAC7B,IAAI,UAAU,CAAC,IAAI,KAAK,SAAS;gBAAE,YAAY,CAAC,IAAI,GAAG,UAAU,CAAC,IAAI,CAAC;YACvE,IAAI,UAAU,CAAC,KAAK,KAAK,SAAS;gBAAE,YAAY,CAAC,KAAK,GAAG,UAAU,CAAC,KAAK,CAAC;YAC1E,IAAI,UAAU,CAAC,IAAI,KAAK,SAAS;gBAAE,YAAY,CAAC,IAAI,GAAG,UAAU,CAAC,IAAI,CAAC;YACvE,IAAI,UAAU,CAAC,QAAQ,KAAK,SAAS;gBAAE,YAAY,CAAC,QAAQ,GAAG,UAAU,CAAC,QAAQ,CAAC;YAEnF,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,oBAAoB,CAAC,MAAM,EAAE,YAAY,CAAC,CAAC;YAEzF,IAAI,CAAC,WAAW,EAAE,CAAC;gBACjB,MAAM,IAAI,sBAAa,CAAC,YAAY,CAAC,CAAC;YACxC,CAAC;YAED,eAAM,CAAC,IAAI,CAAC,aAAa,EAAE;gBACzB,OAAO,EAAE,SAAS,CAAC,GAAG;gBACtB,YAAY,EAAE,MAAM;gBACpB,UAAU,EAAE,YAAY;aACzB,CAAC,CAAC;YAEH,OAAO,WAAW,CAAC;QACrB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,aAAa,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,CAAC,CAAC;YAC3D,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,eAAe,CAAC,MAAc,EAAE,SAAgB;QACpD,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,aAAa;YACb,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YAC9D,IAAI,CAAC,UAAU,EAAE,CAAC;gBAChB,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,YAAY;YACZ,IAAI,UAAU,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,SAAS,CAAC,GAAG,CAAC,QAAQ,EAAE,EAAE,CAAC;gBAC3D,MAAM,IAAI,wBAAe,CAAC,WAAW,CAAC,CAAC;YACzC,CAAC;YAED,iBAAiB;YACjB,IAAI,UAAU,CAAC,IAAI,KAAK,OAAO,IAAI,SAAS,CAAC,IAAI,KAAK,OAAO,EAAE,CAAC;gBAC9D,MAAM,IAAI,wBAAe,CAAC,kBAAkB,CAAC,CAAC;YAChD,CAAC;YAED,gBAAgB;YAChB,MAAM,IAAI,CAAC,cAAc,CAAC,UAAU,CAAC,MAAM,EAAE,UAAU,CAAC,KAAK,CAAC,CAAC;YAE/D,eAAM,CAAC,IAAI,CAAC,WAAW,EAAE;gBACvB,OAAO,EAAE,SAAS,CAAC,GAAG;gBACtB,YAAY,EAAE,MAAM;gBACpB,eAAe,EAAE,UAAU,CAAC,KAAK;aAClC,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,WAAW,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC7C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,sBAAsB,CAAC,MAAc,EAAE,SAAgB;QAC3D,IAAI,CAAC;YACH,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,MAAM,IAAI,wBAAe,CAAC,UAAU,CAAC,CAAC;YACxC,CAAC;YAED,aAAa;YACb,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YAC9D,IAAI,CAAC,UAAU,EAAE,CAAC;gBAChB,MAAM,IAAI,sBAAa,CAAC,OAAO,CAAC,CAAC;YACnC,CAAC;YAED,SAAS;YACT,MAAM,YAAY,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;YAE1D,SAAS;YACT,MAAM,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,EAAE,YAAY,CAAC,CAAC;YAE/D,eAAM,CAAC,IAAI,CAAC,aAAa,EAAE;gBACzB,OAAO,EAAE,SAAS,CAAC,GAAG;gBACtB,YAAY,EAAE,MAAM;aACrB,CAAC,CAAC;YAEH,OAAO,YAAY,CAAC;QACtB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,aAAa,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC/C,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,mBAAmB;QASvB,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;YAExD,OAAO;gBACL,KAAK,EAAE,KAAK;aACb,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YACpC,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,oBAAoB;QACxB,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,oBAAoB,EAAE,CAAC;YAEhE,eAAM,CAAC,IAAI,CAAC,YAAY,EAAE,EAAE,YAAY,EAAE,MAAM,CAAC,YAAY,EAAE,CAAC,CAAC;YACjE,OAAO,MAAM,CAAC;QAChB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,YAAY,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YACtC,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;CACF;AAloBD,kCAkoBC","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\services\\userService.ts"],"sourcesContent":["import { IUser } from '../models/User';\nimport { UserRepository } from '../repositories/userRepository';\nimport { ValidationError, AuthenticationError, NotFoundError } from '../utils/errors';\nimport { logger } from '../utils/logger';\nimport mongoose from 'mongoose';\n\n// 用戶註冊資料介面\nexport interface RegisterUserData {\n  email: string;\n  password: string;\n  name: string;\n  phone?: string;\n}\n\n// 用戶登入資料介面\nexport interface LoginUserData {\n  email: string;\n  password: string;\n}\n\n// 用戶更新資料介面\nexport interface UpdateUserData {\n  name?: string;\n  phone?: string;\n  avatar?: string;\n}\n\n// 管理員更新用戶資料介面\nexport interface AdminUpdateUserData {\n  name?: string;\n  phone?: string;\n  role?: 'user' | 'moderator' | 'admin';\n  isActive?: boolean;\n}\n\n// 用戶查詢選項介面\nexport interface UserQueryOptions {\n  page?: number;\n  limit?: number;\n  search?: string;\n  isActive?: boolean;\n  isEmailVerified?: boolean;\n  role?: 'user' | 'moderator' | 'admin';\n  sortBy?: string;\n  sortOrder?: 'asc' | 'desc';\n}\n\n/**\n * 用戶服務類別\n */\nexport class UserService {\n  private userRepository: UserRepository;\n\n  constructor() {\n    this.userRepository = new UserRepository();\n  }\n  /**\n   * 用戶註冊\n   */\n  async registerUser(userData: RegisterUserData): Promise<{\n    user: IUser;\n    token: string;\n  }> {\n    try {\n      // 檢查電子郵件是否已存在\n      const existingUser = await this.userRepository.findByEmail(userData.email.toLowerCase());\n      if (existingUser) {\n        throw new ValidationError('此電子郵件已被註冊');\n      }\n      \n      // 建立新用戶資料\n      const newUserData = {\n        email: userData.email.toLowerCase(),\n        password: userData.password,\n        name: userData.name.trim(),\n        phone: userData.phone?.trim(),\n      };\n      \n      // 建立新用戶\n      const user = await this.userRepository.create(newUserData);\n      \n      // 生成電子郵件驗證令牌\n      user.generateEmailVerificationToken();\n      \n      // 儲存用戶\n      await user.save();\n      \n      // 生成認證令牌\n      const authToken = user.generateAuthToken();\n      \n      logger.info('用戶註冊成功', {\n        userId: user._id,\n        email: user.email,\n        name: user.name,\n      });\n      \n      // TODO: 發送電子郵件驗證郵件\n      // await emailService.sendVerificationEmail(user.email, verificationToken);\n      \n      return {\n        user,\n        token: authToken,\n      };\n    } catch (error) {\n      logger.error('用戶註冊失敗', { error, userData: { email: userData.email, name: userData.name } });\n      throw error;\n    }\n  }\n  \n  /**\n   * 用戶登入\n   */\n  async loginUser(loginData: LoginUserData): Promise<{\n    user: IUser;\n    token: string;\n  }> {\n    try {\n      // 查找用戶（包含密碼）\n      const user = await this.userRepository.findByEmail(loginData.email.toLowerCase());\n      \n      if (!user) {\n        throw new AuthenticationError('電子郵件或密碼錯誤');\n      }\n      \n      // 檢查用戶是否啟用\n      if (!user.isActive) {\n        throw new AuthenticationError('用戶帳號已被停用');\n      }\n      \n      // 驗證密碼\n      const isPasswordValid = await user.comparePassword(loginData.password);\n      if (!isPasswordValid) {\n        throw new AuthenticationError('電子郵件或密碼錯誤');\n      }\n      \n      // 更新最後登入時間\n      user.lastLoginAt = new Date();\n      await user.save();\n      \n      // 生成認證令牌\n      const token = user.generateAuthToken();\n      \n      logger.info('用戶登入成功', {\n        userId: user._id,\n        email: user.email,\n        lastLoginAt: user.lastLoginAt,\n      });\n      \n      return {\n        user,\n        token,\n      };\n    } catch (error) {\n      logger.error('用戶登入失敗', { error, email: loginData.email });\n      throw error;\n    }\n  }\n  \n  /**\n   * 根據 ID 獲取用戶\n   */\n  async getUserById(userId: string): Promise<IUser> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n      \n      const user = await this.userRepository.findById(userId);\n      if (!user) {\n        throw new NotFoundError('用戶不存在');\n      }\n      \n      return user;\n    } catch (error) {\n      logger.error('獲取用戶失敗', { error, userId });\n      throw error;\n    }\n  }\n  \n  /**\n   * 根據電子郵件獲取用戶\n   */\n  async getUserByEmail(email: string): Promise<IUser | null> {\n    try {\n      const user = await this.userRepository.findByEmail(email.toLowerCase());\n      return user;\n    } catch (error) {\n      logger.error('根據電子郵件獲取用戶失敗', { error, email });\n      throw error;\n    }\n  }\n  \n  /**\n   * 更新用戶資料\n   */\n  async updateUser(userId: string, updateData: UpdateUserData): Promise<IUser> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n      \n      const user = await this.userRepository.findById(userId);\n      if (!user) {\n        throw new NotFoundError('用戶不存在');\n      }\n      \n      // 更新用戶資料\n      if (updateData.name !== undefined) {\n        user.name = updateData.name.trim();\n      }\n      if (updateData.phone !== undefined) {\n        user.phone = updateData.phone?.trim();\n      }\n      if (updateData.avatar !== undefined) {\n        user.avatar = updateData.avatar;\n      }\n      \n      await user.save();\n      \n      logger.info('用戶資料更新成功', {\n        userId: user._id,\n        updatedFields: Object.keys(updateData),\n      });\n      \n      return user;\n    } catch (error) {\n      logger.error('更新用戶資料失敗', { error, userId, updateData });\n      throw error;\n    }\n  }\n  \n  /**\n   * 更改用戶密碼\n   */\n  async changePassword(\n    userId: string,\n    currentPassword: string,\n    newPassword: string\n  ): Promise<void> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n      \n      const user = await this.userRepository.findById(userId);\n      if (!user) {\n        throw new NotFoundError('用戶不存在');\n      }\n      \n      // 驗證當前密碼\n      const isCurrentPasswordValid = await user.comparePassword(currentPassword);\n      if (!isCurrentPasswordValid) {\n        throw new AuthenticationError('當前密碼錯誤');\n      }\n      \n      // 設定新密碼\n      user.password = newPassword;\n      await user.save();\n      \n      logger.info('用戶密碼更改成功', { userId: user._id });\n    } catch (error) {\n      logger.error('更改用戶密碼失敗', { error, userId });\n      throw error;\n    }\n  }\n  \n  /**\n   * 重設密碼\n   */\n  async resetPassword(token: string, newPassword: string): Promise<void> {\n    try {\n      // 查找具有有效重設令牌的用戶\n      const user = await this.userRepository.findByPasswordResetTokenWithExpiry(token);\n      \n      if (!user) {\n        throw new ValidationError('密碼重設令牌無效或已過期');\n      }\n      \n      // 設定新密碼並清除重設令牌\n      user.password = newPassword;\n      user.passwordResetToken = null;\n      user.passwordResetExpires = null;\n      \n      await user.save();\n      \n      logger.info('密碼重設成功', { userId: user._id });\n    } catch (error) {\n      logger.error('密碼重設失敗', { error });\n      throw error;\n    }\n  }\n  \n  /**\n   * 驗證電子郵件\n   */\n  async verifyEmail(userId: string, token: string): Promise<void> {\n    try {\n      const user = await this.userRepository.findById(userId);\n      if (!user) {\n        throw new NotFoundError('用戶不存在');\n      }\n\n      if (user.isEmailVerified) {\n        throw new ValidationError('電子郵件已經驗證過了');\n      }\n\n      if (!user.emailVerificationToken || user.emailVerificationToken !== token) {\n        throw new ValidationError('驗證令牌無效或已過期');\n      }\n\n      // 更新用戶驗證狀態\n      user.isEmailVerified = true;\n      user.emailVerificationToken = null;\n      await user.save();\n\n      logger.info('電子郵件驗證成功', { userId });\n    } catch (error) {\n      logger.error('電子郵件驗證失敗', { error, userId, token });\n      throw error;\n    }\n  }\n\n  /**\n   * 通過令牌驗證電子郵件\n   */\n  async verifyEmailByToken(token: string): Promise<void> {\n    try {\n      const user = await this.userRepository.findByEmailVerificationToken(token);\n      if (!user) {\n        throw new ValidationError('驗證令牌無效或已過期');\n      }\n\n      if (user.isEmailVerified) {\n        throw new ValidationError('電子郵件已經驗證過了');\n      }\n\n      // 更新用戶驗證狀態\n      user.isEmailVerified = true;\n      user.emailVerificationToken = null;\n      await user.save();\n\n      logger.info('電子郵件驗證成功', { userId: user._id });\n    } catch (error) {\n      logger.error('電子郵件驗證失敗', { error, token });\n      throw error;\n    }\n  }\n  \n  /**\n   * 停用用戶\n   */\n  async deactivateUser(userId: string): Promise<void> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n      \n      const user = await this.userRepository.findById(userId);\n      if (!user) {\n        throw new NotFoundError('用戶不存在');\n      }\n      \n      await this.userRepository.deactivate(userId);\n      \n      logger.info('用戶已停用', { userId: user._id });\n    } catch (error) {\n      logger.error('停用用戶失敗', { error, userId });\n      throw error;\n    }\n  }\n  \n  /**\n   * 獲取用戶列表（分頁）\n   */\n  async getUsers(options: UserQueryOptions = {}): Promise<{\n    users: IUser[];\n    total: number;\n    page: number;\n    limit: number;\n    totalPages: number;\n  }> {\n    try {\n      const {\n        page = 1,\n        limit = 10,\n        search,\n        isActive,\n        isEmailVerified,\n        role,\n        sortBy = 'createdAt',\n        sortOrder = 'desc',\n      } = options;\n      \n      // 建立查詢條件\n      const query: any = {};\n      \n      if (search) {\n        query.$or = [\n          { name: { $regex: search, $options: 'i' } },\n          { email: { $regex: search, $options: 'i' } },\n        ];\n      }\n      \n      if (isActive !== undefined) {\n        query.isActive = isActive;\n      }\n      \n      if (isEmailVerified !== undefined) {\n        query.isEmailVerified = isEmailVerified;\n      }\n      \n      if (role) {\n        query.role = role;\n      }\n      \n      // 執行查詢\n      const { users, total } = await this.userRepository.findWithPagination(query, {\n        page,\n        limit,\n        sortBy,\n        sortOrder,\n      });\n      \n      const totalPages = Math.ceil(total / limit);\n      \n      return {\n        users,\n        total,\n        page,\n        limit,\n        totalPages,\n      };\n    } catch (error) {\n      logger.error('獲取用戶列表失敗', { error, options });\n      throw error;\n    }\n  }\n\n  // ===== 管理員功能方法 =====\n\n  /**\n   * 管理員獲取用戶列表（帶篩選和分頁）\n   */\n  async getAdminUserList(options: UserQueryOptions = {}): Promise<{\n    users: IUser[];\n    total: number;\n    page: number;\n    limit: number;\n    totalPages: number;\n  }> {\n    try {\n      const {\n        page = 1,\n        limit = 20,\n        search,\n        role,\n        isActive,\n        isEmailVerified,\n      } = options;\n\n      // 構建查詢條件\n      const filter: any = {};\n      \n      if (search) {\n        filter.$or = [\n          { name: { $regex: search, $options: 'i' } },\n          { email: { $regex: search, $options: 'i' } },\n        ];\n      }\n      \n      if (role) filter.role = role;\n      if (isActive !== undefined) filter.isActive = isActive;\n      if (isEmailVerified !== undefined) filter.isEmailVerified = isEmailVerified;\n\n      // 執行查詢\n      const skip = (Number(page) - 1) * Number(limit);\n      const selectFields = '-password -passwordResetToken -passwordResetExpires -emailVerificationToken -emailVerificationExpires';\n      \n      const [users, total] = await Promise.all([\n        this.userRepository.findWithSelect(filter, selectFields, {\n          sort: { createdAt: -1 },\n          skip,\n          limit: Number(limit),\n        }),\n        this.userRepository.countDocuments(filter),\n      ]);\n\n      const totalPages = Math.ceil(total / Number(limit));\n\n      return {\n        users,\n        total,\n        page: Number(page),\n        limit: Number(limit),\n        totalPages,\n      };\n    } catch (error) {\n      logger.error('管理員獲取用戶列表失敗', { error, options });\n      throw error;\n    }\n  }\n\n  /**\n   * 管理員獲取單個用戶詳情\n   */\n  async getAdminUserById(userId: string): Promise<IUser> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n\n      const selectFields = '-password -passwordResetToken -passwordResetExpires -emailVerificationToken -emailVerificationExpires';\n      const user = await this.userRepository.findByIdWithSelect(userId, selectFields);\n      \n      if (!user) {\n        throw new NotFoundError('用戶不存在');\n      }\n\n      return user;\n    } catch (error) {\n      logger.error('管理員獲取用戶詳情失敗', { error, userId });\n      throw error;\n    }\n  }\n\n  /**\n   * 管理員更新用戶資料\n   */\n  async adminUpdateUser(\n    userId: string,\n    updateData: AdminUpdateUserData,\n    adminUser: IUser\n  ): Promise<IUser> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n\n      // 檢查目標用戶是否存在\n      const targetUser = await this.userRepository.findById(userId);\n      if (!targetUser) {\n        throw new NotFoundError('用戶不存在');\n      }\n\n      // 防止管理員修改自己的角色或狀態\n      if (targetUser._id.toString() === adminUser._id.toString()) {\n        if (updateData.role !== undefined || updateData.isActive !== undefined) {\n          throw new ValidationError('不能修改自己的角色或帳號狀態');\n        }\n      }\n\n      // 只有超級管理員可以設置管理員角色\n      if (updateData.role === 'admin' && adminUser.role !== 'admin') {\n        throw new ValidationError('只有超級管理員可以設置管理員角色');\n      }\n\n      // 更新用戶資料\n      const updateFields: any = {};\n      if (updateData.name !== undefined) updateFields.name = updateData.name;\n      if (updateData.phone !== undefined) updateFields.phone = updateData.phone;\n      if (updateData.role !== undefined) updateFields.role = updateData.role;\n      if (updateData.isActive !== undefined) updateFields.isActive = updateData.isActive;\n\n      const updatedUser = await this.userRepository.updateWithValidation(userId, updateFields);\n      \n      if (!updatedUser) {\n        throw new NotFoundError('更新失敗，用戶不存在');\n      }\n\n      logger.info('管理員更新用戶資料成功', {\n        adminId: adminUser._id,\n        targetUserId: userId,\n        updateData: updateFields,\n      });\n\n      return updatedUser;\n    } catch (error) {\n      logger.error('管理員更新用戶資料失敗', { error, userId, updateData });\n      throw error;\n    }\n  }\n\n  /**\n   * 管理員刪除用戶（軟刪除）\n   */\n  async adminDeleteUser(userId: string, adminUser: IUser): Promise<void> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n\n      // 檢查目標用戶是否存在\n      const targetUser = await this.userRepository.findById(userId);\n      if (!targetUser) {\n        throw new NotFoundError('用戶不存在');\n      }\n\n      // 防止管理員刪除自己\n      if (targetUser._id.toString() === adminUser._id.toString()) {\n        throw new ValidationError('不能刪除自己的帳號');\n      }\n\n      // 只有超級管理員可以刪除管理員\n      if (targetUser.role === 'admin' && adminUser.role !== 'admin') {\n        throw new ValidationError('只有超級管理員可以刪除管理員帳號');\n      }\n\n      // 軟刪除：將用戶標記為非活躍\n      await this.userRepository.softDelete(userId, targetUser.email);\n\n      logger.info('管理員刪除用戶成功', {\n        adminId: adminUser._id,\n        targetUserId: userId,\n        targetUserEmail: targetUser.email,\n      });\n    } catch (error) {\n      logger.error('管理員刪除用戶失敗', { error, userId });\n      throw error;\n    }\n  }\n\n  /**\n   * 管理員重設用戶密碼\n   */\n  async adminResetUserPassword(userId: string, adminUser: IUser): Promise<string> {\n    try {\n      if (!mongoose.Types.ObjectId.isValid(userId)) {\n        throw new ValidationError('無效的用戶 ID');\n      }\n\n      // 檢查目標用戶是否存在\n      const targetUser = await this.userRepository.findById(userId);\n      if (!targetUser) {\n        throw new NotFoundError('用戶不存在');\n      }\n\n      // 生成臨時密碼\n      const tempPassword = Math.random().toString(36).slice(-8);\n      \n      // 更新用戶密碼\n      await this.userRepository.updatePassword(userId, tempPassword);\n\n      logger.info('管理員重設用戶密碼成功', {\n        adminId: adminUser._id,\n        targetUserId: userId,\n      });\n\n      return tempPassword;\n    } catch (error) {\n      logger.error('管理員重設用戶密碼失敗', { error, userId });\n      throw error;\n    }\n  }\n\n  /**\n   * 獲取系統統計\n   */\n  async getSystemStatistics(): Promise<{\n    users: {\n      total: number;\n      active: number;\n      verified: number;\n      admins: number;\n      recent: number;\n    };\n  }> {\n    try {\n      const stats = await this.userRepository.getStatistics();\n      \n      return {\n        users: stats,\n      };\n    } catch (error) {\n      logger.error('獲取系統統計失敗', { error });\n      throw error;\n    }\n  }\n\n  /**\n   * 清理過期驗證令牌\n   */\n  async cleanupExpiredTokens(): Promise<{ deletedCount: number }> {\n    try {\n      const result = await this.userRepository.cleanupExpiredTokens();\n      \n      logger.info('清理過期驗證令牌成功', { deletedCount: result.deletedCount });\n      return result;\n    } catch (error) {\n      logger.error('清理過期驗證令牌失敗', { error });\n      throw error;\n    }\n  }\n}"],"version":3}