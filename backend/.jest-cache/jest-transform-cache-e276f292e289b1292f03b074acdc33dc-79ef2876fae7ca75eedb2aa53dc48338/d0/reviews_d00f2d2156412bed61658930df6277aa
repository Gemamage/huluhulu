928f021f42b7810ebd682d0fac71f545
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const reviewService_1 = require("../services/reviewService");
const auth_1 = require("../middleware/auth");
const express_validator_1 = require("express-validator");
const router = express_1.default.Router();
/**
 * 創建評價
 */
router.post('/', auth_1.authenticate, [
    (0, express_validator_1.body)('targetUserId').isMongoId().withMessage('無效的目標用戶ID'),
    (0, express_validator_1.body)('rating').isInt({ min: 1, max: 5 }).withMessage('評分必須在1-5之間'),
    (0, express_validator_1.body)('content').optional().trim().isLength({ max: 500 }).withMessage('評價內容不能超過500字'),
    (0, express_validator_1.body)('petId').optional().isMongoId().withMessage('無效的寵物ID')
], async (req, res) => {
    try {
        const { targetUserId, rating, content, petId } = req.body;
        const reviewerId = req.user.id;
        const review = await reviewService_1.reviewService.createReview({
            reviewerId,
            targetUserId,
            rating,
            content,
            petId
        });
        res.status(201).json({
            success: true,
            data: review,
            message: '評價創建成功'
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '創建評價失敗'
        });
    }
});
/**
 * 獲取用戶評價列表
 */
router.get('/users/:userId', [
    (0, express_validator_1.param)('userId').isMongoId().withMessage('無效的用戶ID'),
    (0, express_validator_1.query)('page').optional().isInt({ min: 1 }).withMessage('頁碼必須是正整數'),
    (0, express_validator_1.query)('limit').optional().isInt({ min: 1, max: 50 }).withMessage('每頁數量必須在1-50之間'),
    (0, express_validator_1.query)('rating').optional().isInt({ min: 1, max: 5 }).withMessage('評分篩選必須在1-5之間')
], async (req, res) => {
    try {
        const { userId } = req.params;
        const { page = 1, limit = 20, rating } = req.query;
        if (!userId) {
            return res.status(400).json({
                success: false,
                message: '缺少用戶ID參數'
            });
        }
        const result = await reviewService_1.reviewService.getReviewsByUser(userId, {
            page: Number(page),
            limit: Number(limit),
            rating: rating ? Number(rating) : undefined
        });
        return res.json({
            success: true,
            data: result
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '獲取評價列表失敗'
        });
    }
});
/**
 * 獲取用戶評價統計
 */
router.get('/users/:userId/stats', [
    (0, express_validator_1.param)('userId').isMongoId().withMessage('無效的用戶ID')
], async (req, res) => {
    try {
        const { userId } = req.params;
        if (!userId) {
            return res.status(400).json({
                success: false,
                message: '缺少用戶ID參數'
            });
        }
        const stats = await reviewService_1.reviewService.getReviewStats(userId);
        return res.json({
            success: true,
            data: stats
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '獲取評價統計失敗'
        });
    }
});
/**
 * 更新評價
 */
router.put('/:reviewId', auth_1.authenticate, [
    (0, express_validator_1.param)('reviewId').isMongoId().withMessage('無效的評價ID'),
    (0, express_validator_1.body)('rating').optional().isInt({ min: 1, max: 5 }).withMessage('評分必須在1-5之間'),
    (0, express_validator_1.body)('content').optional().trim().isLength({ max: 500 }).withMessage('評價內容不能超過500字')
], async (req, res) => {
    try {
        const { reviewId } = req.params;
        const { rating, content } = req.body;
        const userId = req.user.id;
        if (!reviewId) {
            return res.status(400).json({
                success: false,
                message: '缺少評價ID參數'
            });
        }
        const review = await reviewService_1.reviewService.updateReview(reviewId, userId, {
            rating,
            content
        });
        if (!review) {
            return res.status(404).json({
                success: false,
                message: '評價不存在或無權限修改'
            });
        }
        return res.json({
            success: true,
            data: review,
            message: '評價更新成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '更新評價失敗'
        });
    }
});
/**
 * 刪除評價
 */
router.delete('/:reviewId', auth_1.authenticate, [
    (0, express_validator_1.param)('reviewId').isMongoId().withMessage('無效的評價ID')
], async (req, res) => {
    try {
        const { reviewId } = req.params;
        const userId = req.user.id;
        if (!reviewId) {
            return res.status(400).json({
                success: false,
                message: '缺少評價ID參數'
            });
        }
        const success = await reviewService_1.reviewService.deleteReview(reviewId, userId);
        if (!success) {
            return res.status(404).json({
                success: false,
                message: '評價不存在或無權限刪除'
            });
        }
        return res.json({
            success: true,
            message: '評價刪除成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '刪除評價失敗'
        });
    }
});
/**
 * 舉報評價
 */
router.post('/:reviewId/report', auth_1.authenticate, [
    (0, express_validator_1.param)('reviewId').isMongoId().withMessage('無效的評價ID'),
    (0, express_validator_1.body)('reason').trim().isLength({ min: 1, max: 200 }).withMessage('舉報原因長度必須在1-200字之間')
], async (req, res) => {
    try {
        const { reviewId } = req.params;
        const { reason } = req.body;
        const userId = req.user.id;
        if (!reviewId) {
            return res.status(400).json({
                success: false,
                message: '缺少評價ID參數'
            });
        }
        await reviewService_1.reviewService.reportReview(reviewId, userId, reason);
        return res.json({
            success: true,
            message: '檢舉成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '檢舉失敗'
        });
    }
});
/**
 * 檢查是否可以評價用戶
 */
router.get('/can-review/:targetUserId', auth_1.authenticate, [
    (0, express_validator_1.param)('targetUserId').isMongoId().withMessage('無效的目標用戶ID')
], async (req, res) => {
    try {
        const { targetUserId } = req.params;
        const reviewerId = req.user.id;
        if (!targetUserId) {
            return res.status(400).json({
                success: false,
                message: '缺少目標用戶ID參數'
            });
        }
        const canReview = await reviewService_1.reviewService.canReview(reviewerId, targetUserId);
        return res.json({
            success: true,
            data: { canReview }
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '檢查評價權限失敗'
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xccmV2aWV3cy50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLHNEQUE4QjtBQUU5Qiw2REFBMEQ7QUFDMUQsNkNBQWtEO0FBQ2xELHlEQUF1RDtBQUV2RCxNQUFNLE1BQU0sR0FBRyxpQkFBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRWhDOztHQUVHO0FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQ2IsbUJBQVksRUFDWjtJQUNFLElBQUEsd0JBQUksRUFBQyxjQUFjLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDO0lBQ3pELElBQUEsd0JBQUksRUFBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUM7SUFDbEUsSUFBQSx3QkFBSSxFQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUM7SUFDcEYsSUFBQSx3QkFBSSxFQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUM7Q0FDNUQsRUFDRCxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzFELE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFLLENBQUMsRUFBRSxDQUFDO1FBRWhDLE1BQU0sTUFBTSxH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LFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUUxRSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDZCxPQUFPLEVBQUUsSUFBSTtZQUNiLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRTtTQUNwQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLElBQUksVUFBVTtTQUNyQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUNGLENBQUM7QUFFRixrQkFBZSxNQUFNLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xccmV2aWV3cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyByZXZpZXdTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcmV2aWV3U2VydmljZSc7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tICcuLi9taWRkbGV3YXJlL2F1dGgnO1xuaW1wb3J0IHsgYm9keSwgcGFyYW0sIHF1ZXJ5IH0gZnJvbSAnZXhwcmVzcy12YWxpZGF0b3InO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4vKipcbiAqIOWJteW7uuipleWDuVxuICovXG5yb3V0ZXIucG9zdCgnLycsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIGJvZHkoJ3RhcmdldFVzZXJJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTnm67mqJnnlKjmiLZJRCcpLFxuICAgIGJvZHkoJ3JhdGluZycpLmlzSW50KHsgbWluOiAxLCBtYXg6IDUgfSkud2l0aE1lc3NhZ2UoJ+ipleWIhuW/hemgiOWcqDEtNeS5i+mWkycpLFxuICAgIGJvZHkoJ2NvbnRlbnQnKS5vcHRpb25hbCgpLnRyaW0oKS5pc0xlbmd0aCh7IG1heDogNTAwIH0pLndpdGhNZXNzYWdlKCfoqZXlg7nlhaflrrnkuI3og73otoXpgY41MDDlrZcnKSxcbiAgICBib2R5KCdwZXRJZCcpLm9wdGlvbmFsKCkuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOWvteeJqUlEJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHRhcmdldFVzZXJJZCwgcmF0aW5nLCBjb250ZW50LCBwZXRJZCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCByZXZpZXdlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgICBjb25zdCByZXZpZXcgPSBhd2FpdCByZXZpZXdTZXJ2aWNlLmNyZWF0ZVJldmlldyh7XG4gICAgICAgIHJldmlld2VySWQsXG4gICAgICAgIHRhcmdldFVzZXJJZCxcbiAgICAgICAgcmF0aW5nLFxuICAgICAgICBjb250ZW50LFxuICAgICAgICBwZXRJZFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmV2aWV3LFxuICAgICAgICBtZXNzYWdlOiAn6KmV5YO55Ym15bu65oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAn5Ym15bu66KmV5YO55aSx5pWXJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG4vKipcbiAqIOeNsuWPlueUqOaItuipleWDueWIl+ihqFxuICovXG5yb3V0ZXIuZ2V0KCcvdXNlcnMvOnVzZXJJZCcsXG4gIFtcbiAgICBwYXJhbSgndXNlcklkJykuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOeUqOaItklEJyksXG4gICAgcXVlcnkoJ3BhZ2UnKS5vcHRpb25hbCgpLmlzSW50KHsgbWluOiAxIH0pLndpdGhNZXNzYWdlKCfpoIHnorzlv4XpoIjmmK/mraPmlbTmlbgnKSxcbiAgICBxdWVyeSgnbGltaXQnKS5vcHRpb25hbCgpLmlzSW50KHsgbWluOiAxLCBtYXg6IDUwIH0pLndpdGhNZXNzYWdlKCfmr4/poIHmlbjph4/lv4XpoIjlnKgxLTUw5LmL6ZaTJyksXG4gICAgcXVlcnkoJ3JhdGluZycpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEsIG1heDogNSB9KS53aXRoTWVzc2FnZSgn6KmV5YiG56+p6YG45b+F6aCI5ZyoMS015LmL6ZaTJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHVzZXJJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgcGFnZSA9IDEsXG4gICAgICAgIGxpbWl0ID0gMjAsXG4gICAgICAgIHJhdGluZ1xuICAgICAgfSA9IHJlcS5xdWVyeTtcblxuICAgICAgaWYgKCF1c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR55So5oi2SUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXZpZXdTZXJ2aWNlLmdldFJldmlld3NCeVVzZXIodXNlcklkLCB7XG4gICAgICAgIHBhZ2U6IE51bWJlcihwYWdlKSxcbiAgICAgICAgbGltaXQ6IE51bWJlcihsaW1pdCksXG4gICAgICAgIHJhdGluZzogcmF0aW5nID8gTnVtYmVyKHJhdGluZykgOiB1bmRlZmluZWRcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiByZXN1bHRcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIHx8ICfnjbLlj5boqZXlg7nliJfooajlpLHmlZcnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8qKlxuICog542y5Y+W55So5oi26KmV5YO557Wx6KiIXG4gKi9cbnJvdXRlci5nZXQoJy91c2Vycy86dXNlcklkL3N0YXRzJyxcbiAgW1xuICAgIHBhcmFtKCd1c2VySWQnKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE55So5oi2SUQnKVxuICBdLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSByZXEucGFyYW1zO1xuXG4gICAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6ICfnvLrlsJHnlKjmiLZJROWPg+aVuCdcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgcmV2aWV3U2VydmljZS5nZXRSZXZpZXdTdGF0cyh1c2VySWQpO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBzdGF0c1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+eNsuWPluipleWDuee1seioiOWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDmm7TmlrDoqZXlg7lcbiAqL1xucm91dGVyLnB1dCgnLzpyZXZpZXdJZCcsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIHBhcmFtKCdyZXZpZXdJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoToqZXlg7lJRCcpLFxuICAgIGJvZHkoJ3JhdGluZycpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEsIG1heDogNSB9KS53aXRoTWVzc2FnZSgn6KmV5YiG5b+F6aCI5ZyoMS015LmL6ZaTJyksXG4gICAgYm9keSgnY29udGVudCcpLm9wdGlvbmFsKCkudHJpbSgpLmlzTGVuZ3RoKHsgbWF4OiA1MDAgfSkud2l0aE1lc3NhZ2UoJ+ipleWDueWFp+WuueS4jeiDvei2hemBjjUwMOWtlycpXG4gIF0sXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZXZpZXdJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHsgcmF0aW5nLCBjb250ZW50IH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgICAgaWYgKCFyZXZpZXdJZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6ICfnvLrlsJHoqZXlg7lJROWPg+aVuCdcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJldmlldyA9IGF3YWl0IHJldmlld1NlcnZpY2UudXBkYXRlUmV2aWV3KHJldmlld0lkLCB1c2VySWQsIHtcbiAgICAgICAgcmF0aW5nLFxuICAgICAgICBjb250ZW50XG4gICAgICB9KTtcblxuICAgICAgaWYgKCFyZXZpZXcpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn6KmV5YO55LiN5a2Y5Zyo5oiW54Sh5qyK6ZmQ5L+u5pS5J1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmV2aWV3LFxuICAgICAgICBtZXNzYWdlOiAn6KmV5YO55pu05paw5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+abtOaWsOipleWDueWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDliKrpmaToqZXlg7lcbiAqL1xucm91dGVyLmRlbGV0ZSgnLzpyZXZpZXdJZCcsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIHBhcmFtKCdyZXZpZXdJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoToqZXlg7lJRCcpXG4gIF0sXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZXZpZXdJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgICAgaWYgKCFyZXZpZXdJZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6ICfnvLrlsJHoqZXlg7lJROWPg+aVuCdcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCByZXZpZXdTZXJ2aWNlLmRlbGV0ZVJldmlldyhyZXZpZXdJZCwgdXNlcklkKTtcbiAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6ICfoqZXlg7nkuI3lrZjlnKjmiJbnhKHmrIrpmZDliKrpmaQnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAn6KmV5YO55Yiq6Zmk5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+WIqumZpOipleWDueWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDoiInloLHoqZXlg7lcbiAqL1xucm91dGVyLnBvc3QoJy86cmV2aWV3SWQvcmVwb3J0JyxcbiAgYXV0aGVudGljYXRlLFxuICBbXG4gICAgcGFyYW0oJ3Jldmlld0lkJykuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOipleWDuUlEJyksXG4gICAgYm9keSgncmVhc29uJykudHJpbSgpLmlzTGVuZ3RoKHsgbWluOiAxLCBtYXg6IDIwMCB9KS53aXRoTWVzc2FnZSgn6IiJ5aCx5Y6f5Zug6ZW35bqm5b+F6aCI5ZyoMS0yMDDlrZfkuYvplpMnKVxuICBdLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgcmV2aWV3SWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCB7IHJlYXNvbiB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICAgIGlmICghcmV2aWV3SWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR6KmV5YO5SUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCByZXZpZXdTZXJ2aWNlLnJlcG9ydFJldmlldyhyZXZpZXdJZCwgdXNlcklkLCByZWFzb24pO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAn5qqi6IiJ5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+aqouiIieWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDmqqLmn6XmmK/lkKblj6/ku6XoqZXlg7nnlKjmiLZcbiAqL1xucm91dGVyLmdldCgnL2Nhbi1yZXZpZXcvOnRhcmdldFVzZXJJZCcsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIHBhcmFtKCd0YXJnZXRVc2VySWQnKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE55uu5qiZ55So5oi2SUQnKVxuICBdLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdGFyZ2V0VXNlcklkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgcmV2aWV3ZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgICAgaWYgKCF0YXJnZXRVc2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR55uu5qiZ55So5oi2SUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjYW5SZXZpZXcgPSBhd2FpdCByZXZpZXdTZXJ2aWNlLmNhblJldmlldyhyZXZpZXdlcklkLCB0YXJnZXRVc2VySWQpO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7IGNhblJldmlldyB9XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAn5qqi5p+l6KmV5YO55qyK6ZmQ5aSx5pWXJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7Il0sInZlcnNpb24iOjN9