d162d7fe4721460531c71a53475713f5
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const messageService_1 = require("../services/messageService");
const auth_1 = require("../middleware/auth");
const express_validator_1 = require("express-validator");
const router = express_1.default.Router();
/**
 * 發送私訊
 */
router.post('/', auth_1.authenticate, [
    (0, express_validator_1.body)('receiverId').isMongoId().withMessage('無效的接收者ID'),
    (0, express_validator_1.body)('content').trim().isLength({ min: 1, max: 1000 }).withMessage('訊息內容長度必須在1-1000字之間'),
    (0, express_validator_1.body)('petId').optional().isMongoId().withMessage('無效的寵物ID')
], async (req, res) => {
    try {
        const { receiverId, content, petId } = req.body;
        const senderId = req.user.id;
        const message = await messageService_1.messageService.sendMessage({
            senderId,
            receiverId,
            content,
            petId
        });
        res.status(201).json({
            success: true,
            data: message,
            message: '訊息發送成功'
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '發送訊息失敗'
        });
    }
});
/**
 * 獲取對話列表
 */
router.get('/conversations', auth_1.authenticate, [
    (0, express_validator_1.query)('page').optional().isInt({ min: 1 }).withMessage('頁碼必須是正整數'),
    (0, express_validator_1.query)('limit').optional().isInt({ min: 1, max: 50 }).withMessage('每頁數量必須在1-50之間')
], async (req, res) => {
    try {
        const userId = req.user.id;
        const { page = 1, limit = 20 } = req.query;
        const result = await messageService_1.messageService.getConversations(userId, {
            page: Number(page),
            limit: Number(limit)
        });
        res.json({
            success: true,
            data: result
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '獲取對話列表失敗'
        });
    }
});
/**
 * 獲取對話中的訊息
 */
router.get('/conversations/:otherUserId', auth_1.authenticate, [
    (0, express_validator_1.param)('otherUserId').isMongoId().withMessage('無效的用戶ID'),
    (0, express_validator_1.query)('page').optional().isInt({ min: 1 }).withMessage('頁碼必須是正整數'),
    (0, express_validator_1.query)('limit').optional().isInt({ min: 1, max: 100 }).withMessage('每頁數量必須在1-100之間')
], async (req, res) => {
    try {
        const { otherUserId } = req.params;
        const userId = req.user.id;
        const { page = 1, limit = 50 } = req.query;
        if (!otherUserId) {
            return res.status(400).json({
                success: false,
                message: '缺少用戶ID參數'
            });
        }
        const result = await messageService_1.messageService.getMessages(userId, otherUserId, {
            page: Number(page),
            limit: Number(limit)
        });
        return res.json({
            success: true,
            data: result
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '獲取訊息失敗'
        });
    }
});
/**
 * 標記訊息為已讀
 */
router.put('/conversations/:otherUserId/read', auth_1.authenticate, [
    (0, express_validator_1.param)('otherUserId').isMongoId().withMessage('無效的用戶ID')
], async (req, res) => {
    try {
        const { otherUserId } = req.params;
        const userId = req.user.id;
        if (!otherUserId) {
            return res.status(400).json({
                success: false,
                message: '缺少用戶ID參數'
            });
        }
        await messageService_1.messageService.markAsRead(userId, otherUserId);
        return res.json({
            success: true,
            message: '訊息已標記為已讀'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '標記已讀失敗'
        });
    }
});
/**
 * 刪除對話
 */
router.delete('/conversations/:otherUserId', auth_1.authenticate, [
    (0, express_validator_1.param)('otherUserId').isMongoId().withMessage('無效的用戶ID')
], async (req, res) => {
    try {
        const { otherUserId } = req.params;
        const userId = req.user.id;
        if (!otherUserId) {
            return res.status(400).json({
                success: false,
                message: '缺少用戶ID參數'
            });
        }
        await messageService_1.messageService.deleteConversation(userId, otherUserId);
        return res.json({
            success: true,
            message: '對話刪除成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '刪除對話失敗'
        });
    }
});
/**
 * 獲取未讀訊息數量
 */
router.get('/unread-count', auth_1.authenticate, async (req, res) => {
    try {
        const userId = req.user.id;
        const count = await messageService_1.messageService.getUnreadCount(userId);
        res.json({
            success: true,
            data: { count }
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '獲取未讀數量失敗'
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xcbWVzc2FnZXMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxzREFBOEI7QUFFOUIsK0RBQTREO0FBQzVELDZDQUFrRDtBQUNsRCx5REFBdUQ7QUFFdkQsTUFBTSxNQUFNLEdBQUcsaUJBQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVoQzs7R0FFRztBQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUNiLG1CQUFZLEVBQ1o7SUFDRSxJQUFBLHdCQUFJLEVBQUMsWUFBWSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQztJQUN0RCxJQUFBLHdCQUFJLEVBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUM7SUFDeEYsSUFBQSx3QkFBSSxFQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUM7Q0FDNUQsRUFDRCxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDaEQsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLElBQUssQ0FBQyxFQUFFLENBQUM7UUFFOUIsTUFBTSxPQUFPLEdBQUcsTUFBTSwrQkFBYyxDQUFDLFdBQVcsQ0FBQztZQUMvQyxRQUFRO1lBQ1IsVUFBVTtZQUNWLE9BQU87WUFDUCxLQUFLO1NBQ04sQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDbkIsT0FBTyxFQUFFLElBQUk7WUFDYixJQUFJLEVBQUUsT0FBTztZQUNiLE9BQU8sRUFBRSxRQUFRO1NBQ2xCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ25CLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLElBQUksUUFBUTtTQUNuQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUNGLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQ3pCLG1CQUFZLEVBQ1o7SUFDRSxJQUFBLHlCQUFLLEVBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQztJQUNsRSxJQUFBLHlCQUFLLEVBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDO0NBQ2xGLEVBQ0QsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSyxDQUFDLEVBQUUsQ0FBQztRQUM1QixNQUFNLEVBQ0osSUFBSSxHQUFHLENBQUMsRUFDUixLQUFLLEdBQUcsRUFBRSxFQUNYLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztRQUVkLE1BQU0sTUFBTSxHQUFHLE1BQU0sK0JBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUU7WUFDM0QsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDbEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUM7U0FDckIsQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNQLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLE1BQU07U0FDYixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixPQUFPLEVBQUUsS0FBSztZQUNkLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxJQUFJLFVBQVU7U0FDckMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FDRixDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUN0QyxtQkFBWSxFQUNaO0lBQ0UsSUFBQSx5QkFBSyxFQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUM7SUFDdkQsSUFBQSx5QkFBSyxFQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUM7SUFDbEUsSUFBQSx5QkFBSyxFQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDO0NBQ3BGLEVBQ0QsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUNuQyxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSyxDQUFDLEVBQUUsQ0FBQztRQUM1QixNQUFNLEVBQ0osSUFBSSxHQUFHLENBQUMsRUFDUixLQUFLLEdBQUcsRUFBRSxFQUNYLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztRQUVkLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNqQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMxQixPQUFPLEVBQUUsS0FBSztnQkFDZCxPQUFPLEVBQUUsVUFBVTthQUNwQixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSwrQkFBYyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFO1lBQ25FLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2xCLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDO1NBQ3JCLENBQUMsQ0FBQztRQUVILE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztZQUNkLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLE1BQU07U0FDYixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLElBQUksUUFBUTtTQUNuQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUNGLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLEVBQzNDLG1CQUFZLEVBQ1o7SUFDRSxJQUFBLHlCQUFLLEVBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQztDQUN4RCxFQUNELEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxFQUFFLFdBQVcsRUFBRSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDbkMsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUssQ0FBQyxFQUFFLENBQUM7UUFFNUIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSxLQUFLO2dCQUNkLE9BQU8sRUFBRSxVQUFVO2FBQ3BCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLCtCQUFjLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQztRQUVyRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDZCxPQUFPLEVBQUUsSUFBSTtZQUNiLE9BQU8sRUFBRSxVQUFVO1NBQ3BCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUIsT0FBTyxFQUFFLEtBQUs7WUFDZCxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sSUFBSSxRQUFRO1NBQ25DLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQ0YsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sQ0FBQyw2QkFBNkIsRUFDekMsbUJBQVksRUFDWjtJQUNFLElBQUEseUJBQUssRUFBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDO0NBQ3hELEVBQ0QsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUNuQyxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSyxDQUFDLEVBQUUsQ0FBQztRQUU1QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsT0FBTyxFQUFFLFVBQVU7YUFDcEIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sK0JBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFN0QsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ2QsT0FBTyxFQUFFLElBQUk7WUFDYixPQUFPLEVBQUUsUUFBUTtTQUNsQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLElBQUksUUFBUTtTQUNuQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUNGLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUN4QixtQkFBWSxFQUNaLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUssQ0FBQyxFQUFFLENBQUM7UUFDNUIsTUFBTSxLQUFLLEdBQUcsTUFBTSwrQkFBYyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUxRCxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ1AsT0FBTyxFQUFFLElBQUk7WUFDYixJQUFJLEVBQUUsRUFBRSxLQUFLLEVBQUU7U0FDaEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDcEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDbkIsT0FBTyxFQUFFLEtBQUs7WUFDZCxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sSUFBSSxVQUFVO1NBQ3JDLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQ0YsQ0FBQztBQUVGLGtCQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccm91dGVzXFxtZXNzYWdlcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBtZXNzYWdlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL21lc3NhZ2VTZXJ2aWNlJztcbmltcG9ydCB7IGF1dGhlbnRpY2F0ZSB9IGZyb20gJy4uL21pZGRsZXdhcmUvYXV0aCc7XG5pbXBvcnQgeyBib2R5LCBwYXJhbSwgcXVlcnkgfSBmcm9tICdleHByZXNzLXZhbGlkYXRvcic7XG5cbmNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cbi8qKlxuICog55m86YCB56eB6KiKXG4gKi9cbnJvdXRlci5wb3N0KCcvJyxcbiAgYXV0aGVudGljYXRlLFxuICBbXG4gICAgYm9keSgncmVjZWl2ZXJJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTmjqXmlLbogIVJRCcpLFxuICAgIGJvZHkoJ2NvbnRlbnQnKS50cmltKCkuaXNMZW5ndGgoeyBtaW46IDEsIG1heDogMTAwMCB9KS53aXRoTWVzc2FnZSgn6KiK5oGv5YWn5a656ZW35bqm5b+F6aCI5ZyoMS0xMDAw5a2X5LmL6ZaTJyksXG4gICAgYm9keSgncGV0SWQnKS5vcHRpb25hbCgpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTlr7XnialJRCcpXG4gIF0sXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZWNlaXZlcklkLCBjb250ZW50LCBwZXRJZCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBzZW5kZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IG1lc3NhZ2VTZXJ2aWNlLnNlbmRNZXNzYWdlKHtcbiAgICAgICAgc2VuZGVySWQsXG4gICAgICAgIHJlY2VpdmVySWQsXG4gICAgICAgIGNvbnRlbnQsXG4gICAgICAgIHBldElkXG4gICAgICB9KTtcblxuICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBtZXNzYWdlLFxuICAgICAgICBtZXNzYWdlOiAn6KiK5oGv55m86YCB5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAn55m86YCB6KiK5oGv5aSx5pWXJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG4vKipcbiAqIOeNsuWPluWwjeipseWIl+ihqFxuICovXG5yb3V0ZXIuZ2V0KCcvY29udmVyc2F0aW9ucycsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIHF1ZXJ5KCdwYWdlJykub3B0aW9uYWwoKS5pc0ludCh7IG1pbjogMSB9KS53aXRoTWVzc2FnZSgn6aCB56K85b+F6aCI5piv5q2j5pW05pW4JyksXG4gICAgcXVlcnkoJ2xpbWl0Jykub3B0aW9uYWwoKS5pc0ludCh7IG1pbjogMSwgbWF4OiA1MCB9KS53aXRoTWVzc2FnZSgn5q+P6aCB5pW46YeP5b+F6aCI5ZyoMS01MOS5i+mWkycpXG4gIF0sXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgICAgY29uc3Qge1xuICAgICAgICBwYWdlID0gMSxcbiAgICAgICAgbGltaXQgPSAyMFxuICAgICAgfSA9IHJlcS5xdWVyeTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbWVzc2FnZVNlcnZpY2UuZ2V0Q29udmVyc2F0aW9ucyh1c2VySWQsIHtcbiAgICAgICAgcGFnZTogTnVtYmVyKHBhZ2UpLFxuICAgICAgICBsaW1pdDogTnVtYmVyKGxpbWl0KVxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmVzdWx0XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIHx8ICfnjbLlj5blsI3oqbHliJfooajlpLHmlZcnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8qKlxuICog542y5Y+W5bCN6Kmx5Lit55qE6KiK5oGvXG4gKi9cbnJvdXRlci5nZXQoJy9jb252ZXJzYXRpb25zLzpvdGhlclVzZXJJZCcsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIHBhcmFtKCdvdGhlclVzZXJJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTnlKjmiLZJRCcpLFxuICAgIHF1ZXJ5KCdwYWdlJykub3B0aW9uYWwoKS5pc0ludCh7IG1pbjogMSB9KS53aXRoTWVzc2FnZSgn6aCB56K85b+F6aCI5piv5q2j5pW05pW4JyksXG4gICAgcXVlcnkoJ2xpbWl0Jykub3B0aW9uYWwoKS5pc0ludCh7IG1pbjogMSwgbWF4OiAxMDAgfSkud2l0aE1lc3NhZ2UoJ+avj+mggeaVuOmHj+W/hemgiOWcqDEtMTAw5LmL6ZaTJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IG90aGVyVXNlcklkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgICAgY29uc3Qge1xuICAgICAgICBwYWdlID0gMSxcbiAgICAgICAgbGltaXQgPSA1MFxuICAgICAgfSA9IHJlcS5xdWVyeTtcblxuICAgICAgaWYgKCFvdGhlclVzZXJJZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6ICfnvLrlsJHnlKjmiLZJROWPg+aVuCdcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG1lc3NhZ2VTZXJ2aWNlLmdldE1lc3NhZ2VzKHVzZXJJZCwgb3RoZXJVc2VySWQsIHtcbiAgICAgICAgcGFnZTogTnVtYmVyKHBhZ2UpLFxuICAgICAgICBsaW1pdDogTnVtYmVyKGxpbWl0KVxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHJlc3VsdFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+eNsuWPluioiuaBr+WkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDmqJnoqJjoqIrmga/ngrrlt7LoroBcbiAqL1xucm91dGVyLnB1dCgnL2NvbnZlcnNhdGlvbnMvOm90aGVyVXNlcklkL3JlYWQnLFxuICBhdXRoZW50aWNhdGUsXG4gIFtcbiAgICBwYXJhbSgnb3RoZXJVc2VySWQnKS5pc01vbmdvSWQoKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE55So5oi2SUQnKVxuICBdLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgb3RoZXJVc2VySWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICAgIGlmICghb3RoZXJVc2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR55So5oi2SUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCBtZXNzYWdlU2VydmljZS5tYXJrQXNSZWFkKHVzZXJJZCwgb3RoZXJVc2VySWQpO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAn6KiK5oGv5bey5qiZ6KiY54K65bey6K6AJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+aomeiomOW3suiugOWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDliKrpmaTlsI3oqbFcbiAqL1xucm91dGVyLmRlbGV0ZSgnL2NvbnZlcnNhdGlvbnMvOm90aGVyVXNlcklkJyxcbiAgYXV0aGVudGljYXRlLFxuICBbXG4gICAgcGFyYW0oJ290aGVyVXNlcklkJykuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOeUqOaItklEJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IG90aGVyVXNlcklkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgICBpZiAoIW90aGVyVXNlcklkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogJ+e8uuWwkeeUqOaItklE5Y+D5pW4J1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgbWVzc2FnZVNlcnZpY2UuZGVsZXRlQ29udmVyc2F0aW9uKHVzZXJJZCwgb3RoZXJVc2VySWQpO1xuXG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAn5bCN6Kmx5Yiq6Zmk5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+WIqumZpOWwjeipseWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDnjbLlj5bmnKroroDoqIrmga/mlbjph49cbiAqL1xucm91dGVyLmdldCgnL3VucmVhZC1jb3VudCcsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgICBjb25zdCBjb3VudCA9IGF3YWl0IG1lc3NhZ2VTZXJ2aWNlLmdldFVucmVhZENvdW50KHVzZXJJZCk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogeyBjb3VudCB9XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIHx8ICfnjbLlj5bmnKroroDmlbjph4/lpLHmlZcnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjsiXSwidmVyc2lvbiI6M30=