{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\sharing.ts","mappings":";;;;;AAAA,qCAAiC;AACjC,kEAA8D;AAC9D,+CAAoE;AACpE,+CAA4C;AAC5C,sEAE0C;AAC1C,0CAAuC;AACvC,wDAAgC;AAEhC,MAAM,MAAM,GAAG,IAAA,gBAAM,GAAE,CAAC;AAExB;;;;GAIG;AACH,MAAM,CAAC,IAAI,CAAC,YAAY,EACtB,IAAA,mDAAiC,EAAC;IAChC,QAAQ,EAAE,CAAC,QAAQ,CAAC,CAAC,aAAa;CACnC,CAAC,EACF,IAAA,4BAAY,EAAC,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;IAChC,MAAM,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAE1B,IAAI,CAAC,EAAE,IAAI,CAAC,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE,CAAC;QAChD,MAAM,IAAI,wBAAe,CAAC,aAAa,CAAC,CAAC;IAC3C,CAAC;IAED,eAAM,CAAC,IAAI,CAAC,YAAY,EAAE,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC,CAAC;IAEzC,cAAc;IACd,MAAM,GAAG,GAAG,MAAM,SAAG,CAAC,iBAAiB,CACrC,EAAE,EACF,EAAE,IAAI,EAAE,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,EAC3B,EAAE,GAAG,EAAE,IAAI,EAAE,CACd,CAAC,IAAI,EAAE,CAAC;IAET,IAAI,CAAC,GAAG,EAAE,CAAC;QACT,MAAM,IAAI,sBAAa,CAAC,YAAY,CAAC,CAAC;IACxC,CAAC;IAED,WAAW;IACX,MAAM,QAAQ,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,YAAY,IAAI,uBAAuB,SAAS,EAAE,EAAE,CAAC;IAErF,SAAS;IACT,MAAM,SAAS,GAAG,QAAQ,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,KAAK,GAAG,CAAC,gBAAgB,SAAS,QAAQ,EAAE,CAAC;IAEpH,GAAG,CAAC,IAAI,CAAC;QACP,OAAO,EAAE,IAAI;QACb,OAAO,EAAE,SAAS;QAClB,IAAI,EAAE;YACJ,QAAQ;YACR,SAAS;YACT,UAAU,EAAE,GAAG,CAAC,UAAU,GAAG,CAAC;YAC9B,WAAW,EAAE;gBACX,QAAQ,EAAE,gDAAgD,kBAAkB,CAAC,QAAQ,CAAC,EAAE;gBACxF,OAAO,EAAE,yCAAyC,kBAAkB,CAAC,SAAS,CAAC,EAAE;gBACjF,IAAI,EAAE,mDAAmD,kBAAkB,CAAC,QAAQ,CAAC,EAAE;gBACvF,QAAQ,EAAE,uBAAuB,kBAAkB,CAAC,SAAS,CAAC,EAAE;aACjE;SACF;KACF,CAAC,CAAC;AACL,CAAC,CAAC,CAAC,CAAC;AAEJ,kBAAe,MAAM,CAAC","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\sharing.ts"],"sourcesContent":["import { Router } from 'express';\nimport { asyncHandler } from '../../middleware/error-handler';\nimport { ValidationError, NotFoundError } from '../../utils/errors';\nimport { logger } from '../../utils/logger';\nimport { \n  createCacheInvalidationMiddleware\n} from '../../middleware/cacheMiddleware';\nimport { Pet } from '../../models/Pet';\nimport mongoose from 'mongoose';\n\nconst router = Router();\n\n/**\n * @route   POST /api/pets/:id/share\n * @desc    分享寵物協尋案例\n * @access  Public\n */\nrouter.post('/:id/share', \n  createCacheInvalidationMiddleware({\n    patterns: ['pets:*'] // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n  const { id } = req.params;\n\n  if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n    throw new ValidationError('請提供有效的寵物 ID');\n  }\n\n  logger.info('分享寵物協尋案例請求', { petId: id });\n\n  // 查找寵物並增加分享次數\n  const pet = await Pet.findByIdAndUpdate(\n    id,\n    { $inc: { shareCount: 1 } },\n    { new: true }\n  ).lean();\n\n  if (!pet) {\n    throw new NotFoundError('找不到指定的寵物資訊');\n  }\n\n  // 生成分享 URL\n  const shareUrl = `${process.env.FRONTEND_URL || 'http://localhost:3000'}/pets/${id}`;\n  \n  // 生成分享文字\n  const shareText = `幫忙協尋 ${pet.name}！${pet.type === 'lost' ? '走失' : '發現'}於 ${pet.lastSeenLocation}。詳情請見：${shareUrl}`;\n\n  res.json({\n    success: true,\n    message: '分享連結已生成',\n    data: {\n      shareUrl,\n      shareText,\n      shareCount: pet.shareCount + 1,\n      socialMedia: {\n        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`,\n        twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`,\n        line: `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(shareUrl)}`,\n        whatsapp: `https://wa.me/?text=${encodeURIComponent(shareText)}`\n      }\n    },\n  });\n}));\n\nexport default router;"],"version":3}