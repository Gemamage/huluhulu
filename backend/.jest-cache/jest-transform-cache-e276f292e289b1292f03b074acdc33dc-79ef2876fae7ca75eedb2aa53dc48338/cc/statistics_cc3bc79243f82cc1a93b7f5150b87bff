e0817c11abc7b8a448c8c0bc736eb02a
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NotificationStatisticsService = void 0;
const Notification_1 = require("../../models/Notification");
const logger_1 = require("../../utils/logger");
const mongoose_1 = __importDefault(require("mongoose"));
const aiMatching_1 = require("./aiMatching");
const geofence_1 = require("./geofence");
const reminders_1 = require("./reminders");
class NotificationStatisticsService {
    /**
     * 獲取智能通知統計
     */
    static async getSmartNotificationStats() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
        // 獲取今日通知總數
        const totalNotifications = await Notification_1.Notification.countDocuments({
            createdAt: {
                $gte: today,
                $lt: tomorrow
            }
        });
        // 獲取各服務狀態
        const aiMatchingStatus = aiMatching_1.AIMatchingService.getStatus();
        const geofenceStats = geofence_1.GeofenceService.getStats();
        const reminderStats = await reminders_1.ReminderService.getStats();
        return {
            aiMatching: {
                enabled: aiMatchingStatus.enabled,
                running: aiMatchingStatus.running,
                lastRun: aiMatchingStatus.lastRun || undefined,
                matchesFound: 0 // 可以從統計中獲取
            },
            geofence: {
                enabled: geofenceStats.enabled,
                running: geofenceStats.running,
                activeAreas: geofenceStats.activeAreas,
                totalAreas: geofenceStats.totalAreas
            },
            reminders: {
                enabled: reminderStats.enabled,
                running: reminderStats.running,
                sentToday: reminderStats.sentToday
            },
            totalNotifications
        };
    }
    /**
     * 獲取智能通知統計（用戶特定）
     */
    static async getSmartNotificationStatistics(options) {
        const { userId, startDate, endDate } = options;
        // 設定日期範圍
        const start = startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000); // 預設 30 天前
        const end = endDate || new Date();
        // 統計通知數量
        const notificationStats = await Notification_1.Notification.aggregate([
            {
                $match: {
                    userId: new mongoose_1.default.Types.ObjectId(userId),
                    createdAt: { $gte: start, $lte: end }
                }
            },
            {
                $group: {
                    _id: '$type',
                    count: { $sum: 1 }
                }
            }
        ]);
        const stats = notificationStats.reduce((acc, stat) => {
            acc[stat._id] = stat.count;
            return acc;
        }, {});
        // 統計用戶的地理圍欄
        const userGeofences = await geofence_1.GeofenceService.getUserGeofences(userId);
        // 獲取 AI 配對狀態
        const aiMatchingStatus = aiMatching_1.AIMatchingService.getStatus();
        const geofenceStats = geofence_1.GeofenceService.getStats();
        const reminderStats = await reminders_1.ReminderService.getStats();
        return {
            aiMatching: {
                enabled: aiMatchingStatus.enabled,
                matchesFound: stats['AI_MATCH_SUGGESTION'] || 0,
                lastRun: aiMatchingStatus.lastRun || undefined
            },
            geofencing: {
                enabled: geofenceStats.enabled,
                activeAreas: userGeofences.length
            },
            reminders: {
                enabled: reminderStats.enabled,
                sentCount: stats['REMINDER'] || 0
            },
            totalNotifications: Object.values(stats).reduce((sum, count) => sum + count, 0)
        };
    }
    /**
     * 獲取通知類型統計
     */
    static async getNotificationTypeStats(options) {
        const { userId, startDate, endDate } = options;
        const start = startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        const end = endDate || new Date();
        const matchConditions = {
            createdAt: { $gte: start, $lte: end }
        };
        if (userId) {
            matchConditions.userId = new mongoose_1.default.Types.ObjectId(userId);
        }
        const stats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: '$type',
                    count: { $sum: 1 }
                }
            },
            { $sort: { count: -1 } }
        ]);
        return stats.reduce((acc, stat) => {
            acc[stat._id] = stat.count;
            return acc;
        }, {});
    }
    /**
     * 獲取通知趨勢統計
     */
    static async getNotificationTrends(options) {
        const { userId, days = 30 } = options;
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
        const endDate = new Date();
        const matchConditions = {
            createdAt: { $gte: startDate, $lte: endDate }
        };
        if (userId) {
            matchConditions.userId = new mongoose_1.default.Types.ObjectId(userId);
        }
        // 每日統計
        const dailyStats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: {
                        year: { $year: '$createdAt' },
                        month: { $month: '$createdAt' },
                        day: { $dayOfMonth: '$createdAt' }
                    },
                    count: { $sum: 1 }
                }
            },
            { $sort: { '_id.year': 1, '_id.month': 1, '_id.day': 1 } }
        ]);
        // 每週統計
        const weeklyStats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: {
                        year: { $year: '$createdAt' },
                        week: { $week: '$createdAt' }
                    },
                    count: { $sum: 1 }
                }
            },
            { $sort: { '_id.year': 1, '_id.week': 1 } }
        ]);
        return {
            daily: dailyStats.map(stat => ({
                date: `${stat._id.year}-${String(stat._id.month).padStart(2, '0')}-${String(stat._id.day).padStart(2, '0')}`,
                count: stat.count
            })),
            weekly: weeklyStats.map(stat => ({
                week: `${stat._id.year}-W${String(stat._id.week).padStart(2, '0')}`,
                count: stat.count
            }))
        };
    }
    /**
     * 獲取通知效果統計
     */
    static async getNotificationEffectivenessStats(options) {
        const { userId, startDate, endDate } = options;
        const start = startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        const end = endDate || new Date();
        const matchConditions = {
            createdAt: { $gte: start, $lte: end }
        };
        if (userId) {
            matchConditions.userId = new mongoose_1.default.Types.ObjectId(userId);
        }
        const stats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: '$type',
                    totalSent: { $sum: 1 },
                    totalRead: { $sum: { $cond: [{ $eq: ['$isRead', true] }, 1, 0] } },
                    totalClicked: { $sum: { $cond: [{ $ne: ['$clickedAt', null] }, 1, 0] } }
                }
            }
        ]);
        let totalSent = 0;
        let totalRead = 0;
        let totalClicked = 0;
        const typeEffectiveness = {};
        for (const stat of stats) {
            totalSent += stat.totalSent;
            totalRead += stat.totalRead;
            totalClicked += stat.totalClicked;
            typeEffectiveness[stat._id] = {
                sent: stat.totalSent,
                read: stat.totalRead,
                clicked: stat.totalClicked,
                readRate: stat.totalSent > 0 ? (stat.totalRead / stat.totalSent) * 100 : 0,
                clickRate: stat.totalSent > 0 ? (stat.totalClicked / stat.totalSent) * 100 : 0
            };
        }
        return {
            totalSent,
            totalRead,
            totalClicked,
            readRate: totalSent > 0 ? (totalRead / totalSent) * 100 : 0,
            clickRate: totalSent > 0 ? (totalClicked / totalSent) * 100 : 0,
            typeEffectiveness
        };
    }
    /**
     * 清理過期統計數據
     */
    static async cleanupOldStats(daysToKeep = 90) {
        const cutoffDate = new Date(Date.now() - daysToKeep * 24 * 60 * 60 * 1000);
        const result = await Notification_1.Notification.deleteMany({
            createdAt: { $lt: cutoffDate },
            isRead: true // 只刪除已讀的舊通知
        });
        logger_1.logger.info('清理過期統計數據完成', {
            deletedCount: result.deletedCount,
            cutoffDate,
            daysToKeep
        });
        return {
            deletedCount: result.deletedCount || 0
        };
    }
}
exports.NotificationStatisticsService = NotificationStatisticsService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxub3RpZmljYXRpb25zXFxzdGF0aXN0aWNzLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDREQUF5RDtBQUN6RCwrQ0FBNEM7QUFDNUMsd0RBQWdDO0FBQ2hDLDZDQUFpRDtBQUNqRCx5Q0FBNkM7QUFDN0MsMkNBQThDO0FBd0M5QyxNQUFhLDZCQUE2QjtJQUN4Qzs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMseUJBQXlCO1FBQ3BDLE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDekIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFakUsV0FBVztRQUNYLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSwyQkFBWSxDQUFDLGNBQWMsQ0FBQztZQUMzRCxTQUFTLEVBQUU7Z0JBQ1QsSUFBSSxFQUFFLEtBQUs7Z0JBQ1gsR0FBRyxFQUFFLFFBQVE7YUFDZDtTQUNGLENBQUMsQ0FBQztRQUVILFVBQVU7UUFDVixNQUFNLGdCQUFnQixHQUFHLDhCQUFpQixDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3ZELE1BQU0sYUFBYSxHQUFHLDBCQUFlLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakQsTUFBTSxhQUFhLEdBQUcsTUFBTSwyQkFBZSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXZELE9BQU87WUFDTCxVQUFVLEVBQUU7Z0JBQ1YsT0FBTyxFQUFFLGdCQUFnQixDQUFDLE9BQU87Z0JBQ2pDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxPQUFPO2dCQUNqQyxPQUFP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YUFDL0UsQ0FBQztRQUNKLENBQUM7UUFFRCxPQUFPO1lBQ0wsU0FBUztZQUNULFNBQVM7WUFDVCxZQUFZO1lBQ1osUUFBUSxFQUFFLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzRCxTQUFTLEVBQUUsU0FBUyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9ELGlCQUFpQjtTQUNsQixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsYUFBcUIsRUFBRTtRQUdsRCxNQUFNLFVBQVUsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsVUFBVSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRTNFLE1BQU0sTUFBTSxHQUFHLE1BQU0sMkJBQVksQ0FBQyxVQUFVLENBQUM7WUFDM0MsU0FBUyxFQUFFLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRTtZQUM5QixNQUFNLEVBQUUsSUFBSSxDQUFDLFlBQVk7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsZUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDeEIsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZO1lBQ2pDLFVBQVU7WUFDVixVQUFVO1NBQ1gsQ0FBQyxDQUFDO1FBRUgsT0FBTztZQUNMLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWSxJQUFJLENBQUM7U0FDdkMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQW5URCxzRUFtVEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxub3RpZmljYXRpb25zXFxzdGF0aXN0aWNzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5vdGlmaWNhdGlvbiB9IGZyb20gJy4uLy4uL21vZGVscy9Ob3RpZmljYXRpb24nO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vdXRpbHMvbG9nZ2VyJztcbmltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5pbXBvcnQgeyBBSU1hdGNoaW5nU2VydmljZSB9IGZyb20gJy4vYWlNYXRjaGluZyc7XG5pbXBvcnQgeyBHZW9mZW5jZVNlcnZpY2UgfSBmcm9tICcuL2dlb2ZlbmNlJztcbmltcG9ydCB7IFJlbWluZGVyU2VydmljZSB9IGZyb20gJy4vcmVtaW5kZXJzJztcblxuZXhwb3J0IGludGVyZmFjZSBTbWFydE5vdGlmaWNhdGlvblN0YXRzIHtcbiAgYWlNYXRjaGluZzoge1xuICAgIGVuYWJsZWQ6IGJvb2xlYW47XG4gICAgcnVubmluZzogYm9vbGVhbjtcbiAgICBsYXN0UnVuPzogRGF0ZTtcbiAgICBtYXRjaGVzRm91bmQ6IG51bWJlcjtcbiAgfTtcbiAgZ2VvZmVuY2U6IHtcbiAgICBlbmFibGVkOiBib29sZWFuO1xuICAgIHJ1bm5pbmc6IGJvb2xlYW47XG4gICAgYWN0aXZlQXJlYXM6IG51bWJlcjtcbiAgICB0b3RhbEFyZWFzOiBudW1iZXI7XG4gIH07XG4gIHJlbWluZGVyczoge1xuICAgIGVuYWJsZWQ6IGJvb2xlYW47XG4gICAgcnVubmluZzogYm9vbGVhbjtcbiAgICBzZW50VG9kYXk6IG51bWJlcjtcbiAgfTtcbiAgdG90YWxOb3RpZmljYXRpb25zOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlck5vdGlmaWNhdGlvblN0YXRzIHtcbiAgYWlNYXRjaGluZzoge1xuICAgIGVuYWJsZWQ6IGJvb2xlYW47XG4gICAgbWF0Y2hlc0ZvdW5kOiBudW1iZXI7XG4gICAgbGFzdFJ1bj86IERhdGU7XG4gIH07XG4gIGdlb2ZlbmNpbmc6IHtcbiAgICBlbmFibGVkOiBib29sZWFuO1xuICAgIGFjdGl2ZUFyZWFzOiBudW1iZXI7XG4gIH07XG4gIHJlbWluZGVyczoge1xuICAgIGVuYWJsZWQ6IGJvb2xlYW47XG4gICAgc2VudENvdW50OiBudW1iZXI7XG4gIH07XG4gIHRvdGFsTm90aWZpY2F0aW9uczogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgTm90aWZpY2F0aW9uU3RhdGlzdGljc1NlcnZpY2Uge1xuICAvKipcbiAgICog542y5Y+W5pm66IO96YCa55+l57Wx6KiIXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0U21hcnROb3RpZmljYXRpb25TdGF0cygpOiBQcm9taXNlPFNtYXJ0Tm90aWZpY2F0aW9uU3RhdHM+IHtcbiAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgdG9kYXkuc2V0SG91cnMoMCwgMCwgMCwgMCk7XG4gICAgY29uc3QgdG9tb3Jyb3cgPSBuZXcgRGF0ZSh0b2RheS5nZXRUaW1lKCkgKyAyNCAqIDYwICogNjAgKiAxMDAwKTtcblxuICAgIC8vIOeNsuWPluS7iuaXpemAmuefpee4veaVuFxuICAgIGNvbnN0IHRvdGFsTm90aWZpY2F0aW9ucyA9IGF3YWl0IE5vdGlmaWNhdGlvbi5jb3VudERvY3VtZW50cyh7XG4gICAgICBjcmVhdGVkQXQ6IHtcbiAgICAgICAgJGd0ZTogdG9kYXksXG4gICAgICAgICRsdDogdG9tb3Jyb3dcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIOeNsuWPluWQhOacjeWLmeeLgOaFi1xuICAgIGNvbnN0IGFpTWF0Y2hpbmdTdGF0dXMgPSBBSU1hdGNoaW5nU2VydmljZS5nZXRTdGF0dXMoKTtcbiAgICBjb25zdCBnZW9mZW5jZVN0YXRzID0gR2VvZmVuY2VTZXJ2aWNlLmdldFN0YXRzKCk7XG4gICAgY29uc3QgcmVtaW5kZXJTdGF0cyA9IGF3YWl0IFJlbWluZGVyU2VydmljZS5nZXRTdGF0cygpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGFpTWF0Y2hpbmc6IHtcbiAgICAgICAgZW5hYmxlZDogYWlNYXRjaGluZ1N0YXR1cy5lbmFibGVkLFxuICAgICAgICBydW5uaW5nOiBhaU1hdGNoaW5nU3RhdHVzLnJ1bm5pbmcsXG4gICAgICAgIGxhc3RSdW46IGFpTWF0Y2hpbmdTdGF0dXMubGFzdFJ1biB8fCB1bmRlZmluZWQsXG4gICAgICAgIG1hdGNoZXNGb3VuZDogMCAvLyDlj6/ku6Xlvp7ntbHoqIjkuK3njbLlj5ZcbiAgICAgIH0sXG4gICAgICBnZW9mZW5jZToge1xuICAgICAgICBlbmFibGVkOiBnZW9mZW5jZVN0YXRzLmVuYWJsZWQsXG4gICAgICAgIHJ1bm5pbmc6IGdlb2ZlbmNlU3RhdHMucnVubmluZyxcbiAgICAgICAgYWN0aXZlQXJlYXM6IGdlb2ZlbmNlU3RhdHMuYWN0aXZlQXJlYXMsXG4gICAgICAgIHRvdGFsQXJlYXM6IGdlb2ZlbmNlU3RhdHMudG90YWxBcmVhc1xuICAgICAgfSxcbiAgICAgIHJlbWluZGVyczoge1xuICAgICAgICBlbmFibGVkOiByZW1pbmRlclN0YXRzLmVuYWJsZWQsXG4gICAgICAgIHJ1bm5pbmc6IHJlbWluZGVyU3RhdHMucnVubmluZyxcbiAgICAgICAgc2VudFRvZGF5OiByZW1pbmRlclN0YXRzLnNlbnRUb2RheVxuICAgICAgfSxcbiAgICAgIHRvdGFsTm90aWZpY2F0aW9uc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICog542y5Y+W5pm66IO96YCa55+l57Wx6KiI77yI55So5oi254m55a6a77yJXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0U21hcnROb3RpZmljYXRpb25TdGF0aXN0aWNzKG9wdGlvbnM6IHtcbiAgICB1c2VySWQ6IHN0cmluZztcbiAgICBzdGFydERhdGU/OiBEYXRlO1xuICAgIGVuZERhdGU/OiBEYXRlO1xuICB9KTogUHJvbWlzZTxVc2VyTm90aWZpY2F0aW9uU3RhdHM+IHtcbiAgICBjb25zdCB7IHVzZXJJZCwgc3RhcnREYXRlLCBlbmREYXRlIH0gPSBvcHRpb25zO1xuICAgIFxuICAgIC8vIOioreWumuaXpeacn+evhOWcjVxuICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnREYXRlIHx8IG5ldyBEYXRlKERhdGUubm93KCkgLSAzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyDpoJDoqK0gMzAg5aSp5YmNXG4gICAgY29uc3QgZW5kID0gZW5kRGF0ZSB8fCBuZXcgRGF0ZSgpO1xuXG4gICAgLy8g57Wx6KiI6YCa55+l5pW46YePXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uU3RhdHMgPSBhd2FpdCBOb3RpZmljYXRpb24uYWdncmVnYXRlKFtcbiAgICAgIHtcbiAgICAgICAgJG1hdGNoOiB7XG4gICAgICAgICAgdXNlcklkOiBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKSxcbiAgICAgICAgICBjcmVhdGVkQXQ6IHsgJGd0ZTogc3RhcnQsICRsdGU6IGVuZCB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgICRncm91cDoge1xuICAgICAgICAgIF9pZDogJyR0eXBlJyxcbiAgICAgICAgICBjb3VudDogeyAkc3VtOiAxIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIF0pO1xuXG4gICAgY29uc3Qgc3RhdHMgPSBub3RpZmljYXRpb25TdGF0cy5yZWR1Y2UoKGFjYywgc3RhdCkgPT4ge1xuICAgICAgYWNjW3N0YXQuX2lkXSA9IHN0YXQuY291bnQ7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4pO1xuXG4gICAgLy8g57Wx6KiI55So5oi255qE5Zyw55CG5ZyN5qyEXG4gICAgY29uc3QgdXNlckdlb2ZlbmNlcyA9IGF3YWl0IEdlb2ZlbmNlU2VydmljZS5nZXRVc2VyR2VvZmVuY2VzKHVzZXJJZCk7XG5cbiAgICAvLyDnjbLlj5YgQUkg6YWN5bCN54uA5oWLXG4gICAgY29uc3QgYWlNYXRjaGluZ1N0YXR1cyA9IEFJTWF0Y2hpbmdTZXJ2aWNlLmdldFN0YXR1cygpO1xuICAgIGNvbnN0IGdlb2ZlbmNlU3RhdHMgPSBHZW9mZW5jZVNlcnZpY2UuZ2V0U3RhdHMoKTtcbiAgICBjb25zdCByZW1pbmRlclN0YXRzID0gYXdhaXQgUmVtaW5kZXJTZXJ2aWNlLmdldFN0YXRzKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgYWlNYXRjaGluZzoge1xuICAgICAgICBlbmFibGVkOiBhaU1hdGNoaW5nU3RhdHVzLmVuYWJsZWQsXG4gICAgICAgIG1hdGNoZXNGb3VuZDogc3RhdHNbJ0FJX01BVENIX1NVR0dFU1RJT04nXSB8fCAwLFxuICAgICAgICBsYXN0UnVuOiBhaU1hdGNoaW5nU3RhdHVzLmxhc3RSdW4gfHwgdW5kZWZpbmVkXG4gICAgICB9LFxuICAgICAgZ2VvZmVuY2luZzoge1xuICAgICAgICBlbmFibGVkOiBnZW9mZW5jZVN0YXRzLmVuYWJsZWQsXG4gICAgICAgIGFjdGl2ZUFyZWFzOiB1c2VyR2VvZmVuY2VzLmxlbmd0aFxuICAgICAgfSxcbiAgICAgIHJlbWluZGVyczoge1xuICAgICAgICBlbmFibGVkOiByZW1pbmRlclN0YXRzLmVuYWJsZWQsXG4gICAgICAgIHNlbnRDb3VudDogc3RhdHNbJ1JFTUlOREVSJ10gfHwgMFxuICAgICAgfSxcbiAgICAgIHRvdGFsTm90aWZpY2F0aW9uczogT2JqZWN0LnZhbHVlcyhzdGF0cykucmVkdWNlKChzdW06IG51bWJlciwgY291bnQ6IHVua25vd24pID0+IHN1bSArIChjb3VudCBhcyBudW1iZXIpLCAwKVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICog542y5Y+W6YCa55+l6aGe5Z6L57Wx6KiIXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0Tm90aWZpY2F0aW9uVHlwZVN0YXRzKG9wdGlvbnM6IHtcbiAgICB1c2VySWQ/OiBzdHJpbmc7XG4gICAgc3RhcnREYXRlPzogRGF0ZTtcbiAgICBlbmREYXRlPzogRGF0ZTtcbiAgfSk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgbnVtYmVyPj4ge1xuICAgIGNvbnN0IHsgdXNlcklkLCBzdGFydERhdGUsIGVuZERhdGUgfSA9IG9wdGlvbnM7XG4gICAgXG4gICAgY29uc3Qgc3RhcnQgPSBzdGFydERhdGUgfHwgbmV3IERhdGUoRGF0ZS5ub3coKSAtIDMwICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgY29uc3QgZW5kID0gZW5kRGF0ZSB8fCBuZXcgRGF0ZSgpO1xuXG4gICAgY29uc3QgbWF0Y2hDb25kaXRpb25zOiBhbnkgPSB7XG4gICAgICBjcmVhdGVkQXQ6IHsgJGd0ZTogc3RhcnQsICRsdGU6IGVuZCB9XG4gICAgfTtcblxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIG1hdGNoQ29uZGl0aW9ucy51c2VySWQgPSBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IE5vdGlmaWNhdGlvbi5hZ2dyZWdhdGUoW1xuICAgICAgeyAkbWF0Y2g6IG1hdGNoQ29uZGl0aW9ucyB9LFxuICAgICAge1xuICAgICAgICAkZ3JvdXA6IHtcbiAgICAgICAgICBfaWQ6ICckdHlwZScsXG4gICAgICAgICAgY291bnQ6IHsgJHN1bTogMSB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7ICRzb3J0OiB7IGNvdW50OiAtMSB9IH1cbiAgICBdKTtcblxuICAgIHJldHVybiBzdGF0cy5yZWR1Y2UoKGFjYywgc3RhdCkgPT4ge1xuICAgICAgYWNjW3N0YXQuX2lkXSA9IHN0YXQuY291bnQ7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4pO1xuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPlumAmuefpei2qOWLoue1seioiFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGdldE5vdGlmaWNhdGlvblRyZW5kcyhvcHRpb25zOiB7XG4gICAgdXNlcklkPzogc3RyaW5nO1xuICAgIGRheXM/OiBudW1iZXI7XG4gIH0pOiBQcm9taXNlPHtcbiAgICBkYWlseTogQXJyYXk8eyBkYXRlOiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfT47XG4gICAgd2Vla2x5OiBBcnJheTx7IHdlZWs6IHN0cmluZzsgY291bnQ6IG51bWJlciB9PjtcbiAgfT4ge1xuICAgIGNvbnN0IHsgdXNlcklkLCBkYXlzID0gMzAgfSA9IG9wdGlvbnM7XG4gICAgXG4gICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIGRheXMgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUoKTtcblxuICAgIGNvbnN0IG1hdGNoQ29uZGl0aW9uczogYW55ID0ge1xuICAgICAgY3JlYXRlZEF0OiB7ICRndGU6IHN0YXJ0RGF0ZSwgJGx0ZTogZW5kRGF0ZSB9XG4gICAgfTtcblxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIG1hdGNoQ29uZGl0aW9ucy51c2VySWQgPSBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKTtcbiAgICB9XG5cbiAgICAvLyDmr4/ml6XntbHoqIhcbiAgICBjb25zdCBkYWlseVN0YXRzID0gYXdhaXQgTm90aWZpY2F0aW9uLmFnZ3JlZ2F0ZShbXG4gICAgICB7ICRtYXRjaDogbWF0Y2hDb25kaXRpb25zIH0sXG4gICAgICB7XG4gICAgICAgICRncm91cDoge1xuICAgICAgICAgIF9pZDoge1xuICAgICAgICAgICAgeWVhcjogeyAkeWVhcjogJyRjcmVhdGVkQXQnIH0sXG4gICAgICAgICAgICBtb250aDogeyAkbW9udGg6ICckY3JlYXRlZEF0JyB9LFxuICAgICAgICAgICAgZGF5OiB7ICRkYXlPZk1vbnRoOiAnJGNyZWF0ZWRBdCcgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgY291bnQ6IHsgJHN1bTogMSB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7ICRzb3J0OiB7ICdfaWQueWVhcic6IDEsICdfaWQubW9udGgnOiAxLCAnX2lkLmRheSc6IDEgfSB9XG4gICAgXSk7XG5cbiAgICAvLyDmr4/pgLHntbHoqIhcbiAgICBjb25zdCB3ZWVrbHlTdGF0cyA9IGF3YWl0IE5vdGlmaWNhdGlvbi5hZ2dyZWdhdGUoW1xuICAgICAgeyAkbWF0Y2g6IG1hdGNoQ29uZGl0aW9ucyB9LFxuICAgICAge1xuICAgICAgICAkZ3JvdXA6IHtcbiAgICAgICAgICBfaWQ6IHtcbiAgICAgICAgICAgIHllYXI6IHsgJHllYXI6ICckY3JlYXRlZEF0JyB9LFxuICAgICAgICAgICAgd2VlazogeyAkd2VlazogJyRjcmVhdGVkQXQnIH1cbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvdW50OiB7ICRzdW06IDEgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgeyAkc29ydDogeyAnX2lkLnllYXInOiAxLCAnX2lkLndlZWsnOiAxIH0gfVxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRhaWx5OiBkYWlseVN0YXRzLm1hcChzdGF0ID0+ICh7XG4gICAgICAgIGRhdGU6IGAke3N0YXQuX2lkLnllYXJ9LSR7U3RyaW5nKHN0YXQuX2lkLm1vbnRoKS5wYWRTdGFydCgyLCAnMCcpfS0ke1N0cmluZyhzdGF0Ll9pZC5kYXkpLnBhZFN0YXJ0KDIsICcwJyl9YCxcbiAgICAgICAgY291bnQ6IHN0YXQuY291bnRcbiAgICAgIH0pKSxcbiAgICAgIHdlZWtseTogd2Vla2x5U3RhdHMubWFwKHN0YXQgPT4gKHtcbiAgICAgICAgd2VlazogYCR7c3RhdC5faWQueWVhcn0tVyR7U3RyaW5nKHN0YXQuX2lkLndlZWspLnBhZFN0YXJ0KDIsICcwJyl9YCxcbiAgICAgICAgY291bnQ6IHN0YXQuY291bnRcbiAgICAgIH0pKVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICog542y5Y+W6YCa55+l5pWI5p6c57Wx6KiIXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0Tm90aWZpY2F0aW9uRWZmZWN0aXZlbmVzc1N0YXRzKG9wdGlvbnM6IHtcbiAgICB1c2VySWQ/OiBzdHJpbmc7XG4gICAgc3RhcnREYXRlPzogRGF0ZTtcbiAgICBlbmREYXRlPzogRGF0ZTtcbiAgfSk6IFByb21pc2U8e1xuICAgIHRvdGFsU2VudDogbnVtYmVyO1xuICAgIHRvdGFsUmVhZDogbnVtYmVyO1xuICAgIHRvdGFsQ2xpY2tlZDogbnVtYmVyO1xuICAgIHJlYWRSYXRlOiBudW1iZXI7XG4gICAgY2xpY2tSYXRlOiBudW1iZXI7XG4gICAgdHlwZUVmZmVjdGl2ZW5lc3M6IFJlY29yZDxzdHJpbmcsIHtcbiAgICAgIHNlbnQ6IG51bWJlcjtcbiAgICAgIHJlYWQ6IG51bWJlcjtcbiAgICAgIGNsaWNrZWQ6IG51bWJlcjtcbiAgICAgIHJlYWRSYXRlOiBudW1iZXI7XG4gICAgICBjbGlja1JhdGU6IG51bWJlcjtcbiAgICB9PjtcbiAgfT4ge1xuICAgIGNvbnN0IHsgdXNlcklkLCBzdGFydERhdGUsIGVuZERhdGUgfSA9IG9wdGlvbnM7XG4gICAgXG4gICAgY29uc3Qgc3RhcnQgPSBzdGFydERhdGUgfHwgbmV3IERhdGUoRGF0ZS5ub3coKSAtIDMwICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgY29uc3QgZW5kID0gZW5kRGF0ZSB8fCBuZXcgRGF0ZSgpO1xuXG4gICAgY29uc3QgbWF0Y2hDb25kaXRpb25zOiBhbnkgPSB7XG4gICAgICBjcmVhdGVkQXQ6IHsgJGd0ZTogc3RhcnQsICRsdGU6IGVuZCB9XG4gICAgfTtcblxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIG1hdGNoQ29uZGl0aW9ucy51c2VySWQgPSBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IE5vdGlmaWNhdGlvbi5hZ2dyZWdhdGUoW1xuICAgICAgeyAkbWF0Y2g6IG1hdGNoQ29uZGl0aW9ucyB9LFxuICAgICAge1xuICAgICAgICAkZ3JvdXA6IHtcbiAgICAgICAgICBfaWQ6ICckdHlwZScsXG4gICAgICAgICAgdG90YWxTZW50OiB7ICRzdW06IDEgfSxcbiAgICAgICAgICB0b3RhbFJlYWQ6IHsgJHN1bTogeyAkY29uZDogW3sgJGVxOiBbJyRpc1JlYWQnLCB0cnVlXSB9LCAxLCAwXSB9IH0sXG4gICAgICAgICAgdG90YWxDbGlja2VkOiB7ICRzdW06IHsgJGNvbmQ6IFt7ICRuZTogWyckY2xpY2tlZEF0JywgbnVsbF0gfSwgMSwgMF0gfSB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBdKTtcblxuICAgIGxldCB0b3RhbFNlbnQgPSAwO1xuICAgIGxldCB0b3RhbFJlYWQgPSAwO1xuICAgIGxldCB0b3RhbENsaWNrZWQgPSAwO1xuICAgIGNvbnN0IHR5cGVFZmZlY3RpdmVuZXNzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHN0YXQgb2Ygc3RhdHMpIHtcbiAgICAgIHRvdGFsU2VudCArPSBzdGF0LnRvdGFsU2VudDtcbiAgICAgIHRvdGFsUmVhZCArPSBzdGF0LnRvdGFsUmVhZDtcbiAgICAgIHRvdGFsQ2xpY2tlZCArPSBzdGF0LnRvdGFsQ2xpY2tlZDtcblxuICAgICAgdHlwZUVmZmVjdGl2ZW5lc3Nbc3RhdC5faWRdID0ge1xuICAgICAgICBzZW50OiBzdGF0LnRvdGFsU2VudCxcbiAgICAgICAgcmVhZDogc3RhdC50b3RhbFJlYWQsXG4gICAgICAgIGNsaWNrZWQ6IHN0YXQudG90YWxDbGlja2VkLFxuICAgICAgICByZWFkUmF0ZTogc3RhdC50b3RhbFNlbnQgPiAwID8gKHN0YXQudG90YWxSZWFkIC8gc3RhdC50b3RhbFNlbnQpICogMTAwIDogMCxcbiAgICAgICAgY2xpY2tSYXRlOiBzdGF0LnRvdGFsU2VudCA+IDAgPyAoc3RhdC50b3RhbENsaWNrZWQgLyBzdGF0LnRvdGFsU2VudCkgKiAxMDAgOiAwXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbFNlbnQsXG4gICAgICB0b3RhbFJlYWQsXG4gICAgICB0b3RhbENsaWNrZWQsXG4gICAgICByZWFkUmF0ZTogdG90YWxTZW50ID4gMCA/ICh0b3RhbFJlYWQgLyB0b3RhbFNlbnQpICogMTAwIDogMCxcbiAgICAgIGNsaWNrUmF0ZTogdG90YWxTZW50ID4gMCA/ICh0b3RhbENsaWNrZWQgLyB0b3RhbFNlbnQpICogMTAwIDogMCxcbiAgICAgIHR5cGVFZmZlY3RpdmVuZXNzXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnkIbpgY7mnJ/ntbHoqIjmlbjmk5pcbiAgICovXG4gIHN0YXRpYyBhc3luYyBjbGVhbnVwT2xkU3RhdHMoZGF5c1RvS2VlcDogbnVtYmVyID0gOTApOiBQcm9taXNlPHtcbiAgICBkZWxldGVkQ291bnQ6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IGN1dG9mZkRhdGUgPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gZGF5c1RvS2VlcCAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgIFxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IE5vdGlmaWNhdGlvbi5kZWxldGVNYW55KHtcbiAgICAgIGNyZWF0ZWRBdDogeyAkbHQ6IGN1dG9mZkRhdGUgfSxcbiAgICAgIGlzUmVhZDogdHJ1ZSAvLyDlj6rliKrpmaTlt7LoroDnmoToiIrpgJrnn6VcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKCfmuIXnkIbpgY7mnJ/ntbHoqIjmlbjmk5rlrozmiJAnLCB7XG4gICAgICBkZWxldGVkQ291bnQ6IHJlc3VsdC5kZWxldGVkQ291bnQsXG4gICAgICBjdXRvZmZEYXRlLFxuICAgICAgZGF5c1RvS2VlcFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRlbGV0ZWRDb3VudDogcmVzdWx0LmRlbGV0ZWRDb3VudCB8fCAwXG4gICAgfTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==