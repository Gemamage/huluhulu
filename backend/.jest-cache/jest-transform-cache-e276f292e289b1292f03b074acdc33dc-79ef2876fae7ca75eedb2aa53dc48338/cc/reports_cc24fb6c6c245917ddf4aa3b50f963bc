184c4d134bacb71b8fce216b94cb7d75
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const reportService_1 = require("../services/reportService");
const auth_1 = require("../middleware/auth");
const express_validator_1 = require("express-validator");
const router = express_1.default.Router();
/**
 * 創建舉報
 */
router.post('/', auth_1.authenticate, [
    (0, express_validator_1.body)('contentType').isIn(['user', 'comment', 'review', 'message', 'pet']).withMessage('無效的內容類型'),
    (0, express_validator_1.body)('contentId').isMongoId().withMessage('無效的內容ID'),
    (0, express_validator_1.body)('reason').trim().isLength({ min: 1, max: 500 }).withMessage('舉報原因長度必須在1-500字之間'),
    (0, express_validator_1.body)('category').optional().isIn(['spam', 'harassment', 'inappropriate', 'fake', 'other']).withMessage('無效的舉報類別')
], async (req, res) => {
    try {
        const { contentType, contentId, reason, category } = req.body;
        const reporterId = req.user.id;
        const report = await reportService_1.reportService.createReport({
            reporterId,
            contentType,
            contentId,
            reason,
            category
        });
        res.status(201).json({
            success: true,
            data: report,
            message: '舉報提交成功'
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '提交舉報失敗'
        });
    }
});
/**
 * 獲取用戶的舉報歷史
 */
router.get('/my-reports', auth_1.authenticate, [
    (0, express_validator_1.query)('page').optional().isInt({ min: 1 }).withMessage('頁碼必須是正整數'),
    (0, express_validator_1.query)('limit').optional().isInt({ min: 1, max: 50 }).withMessage('每頁數量必須在1-50之間'),
    (0, express_validator_1.query)('status').optional().isIn(['pending', 'investigating', 'resolved', 'dismissed']).withMessage('無效的狀態')
], async (req, res) => {
    try {
        const userId = req.user.id;
        const { page = 1, limit = 20, status } = req.query;
        const result = await reportService_1.reportService.getReportsByUser(userId, {
            page: Number(page),
            limit: Number(limit),
            status: status
        });
        res.json({
            success: true,
            data: result
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '獲取舉報歷史失敗'
        });
    }
});
// ==================== 管理員專用路由 ====================
/**
 * 獲取所有舉報（管理員）
 */
router.get('/admin/all', auth_1.authenticate, [
    (0, express_validator_1.query)('page').optional().isInt({ min: 1 }).withMessage('頁碼必須是正整數'),
    (0, express_validator_1.query)('limit').optional().isInt({ min: 1, max: 100 }).withMessage('每頁數量必須在1-100之間'),
    (0, express_validator_1.query)('status').optional().isIn(['pending', 'investigating', 'resolved', 'dismissed']).withMessage('無效的狀態'),
    (0, express_validator_1.query)('priority').optional().isIn(['low', 'medium', 'high', 'urgent']).withMessage('無效的優先級'),
    (0, express_validator_1.query)('contentType').optional().isIn(['user', 'comment', 'review', 'message', 'pet']).withMessage('無效的內容類型'),
    (0, express_validator_1.query)('assignedTo').optional().isMongoId().withMessage('無效的指派對象ID')
], async (req, res) => {
    try {
        const { page = 1, limit = 20, status, priority, contentType, assignedTo, sortBy = 'createdAt', sortOrder = 'desc' } = req.query;
        const result = await reportService_1.reportService.getReports({
            status: status,
            priority: priority,
            contentType: contentType,
            assignedTo: assignedTo,
            page: Number(page),
            limit: Number(limit),
            sortBy: sortBy,
            sortOrder: sortOrder
        });
        res.json({
            success: true,
            data: result
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '獲取舉報列表失敗'
        });
    }
});
/**
 * 更新舉報狀態（管理員）
 */
router.put('/admin/:reportId', auth_1.authenticate, [
    (0, express_validator_1.param)('reportId').isMongoId().withMessage('無效的舉報ID'),
    (0, express_validator_1.body)('status').optional().isIn(['pending', 'investigating', 'resolved', 'dismissed']).withMessage('無效的狀態'),
    (0, express_validator_1.body)('priority').optional().isIn(['low', 'medium', 'high', 'urgent']).withMessage('無效的優先級'),
    (0, express_validator_1.body)('assignedTo').optional().isMongoId().withMessage('無效的指派對象ID'),
    (0, express_validator_1.body)('resolution').optional().trim().isLength({ max: 1000 }).withMessage('處理結果不能超過1000字')
], async (req, res) => {
    try {
        const { reportId } = req.params;
        const { status, priority, assignedTo, resolution } = req.body;
        const adminId = req.user.id;
        if (!reportId) {
            return res.status(400).json({
                success: false,
                message: '缺少舉報ID參數'
            });
        }
        const report = await reportService_1.reportService.updateReport(reportId, adminId, {
            status,
            priority,
            assignedTo,
            resolution
        });
        if (!report) {
            return res.status(404).json({
                success: false,
                message: '舉報不存在'
            });
        }
        return res.json({
            success: true,
            data: report,
            message: '舉報更新成功'
        });
    }
    catch (error) {
        return res.status(400).json({
            success: false,
            message: error.message || '更新舉報失敗'
        });
    }
});
/**
 * 批量處理舉報（管理員）
 */
router.put('/admin/batch', auth_1.authenticate, [
    (0, express_validator_1.body)('reportIds').isArray({ min: 1 }).withMessage('舉報ID列表不能為空'),
    (0, express_validator_1.body)('reportIds.*').isMongoId().withMessage('無效的舉報ID'),
    (0, express_validator_1.body)('status').optional().isIn(['pending', 'investigating', 'resolved', 'dismissed']).withMessage('無效的狀態'),
    (0, express_validator_1.body)('priority').optional().isIn(['low', 'medium', 'high', 'urgent']).withMessage('無效的優先級'),
    (0, express_validator_1.body)('assignedTo').optional().isMongoId().withMessage('無效的指派對象ID')
], async (req, res) => {
    try {
        const { reportIds, status, priority, assignedTo } = req.body;
        const adminId = req.user.id;
        const updatedCount = await reportService_1.reportService.batchUpdateReports(reportIds, adminId, {
            status,
            priority,
            assignedTo
        });
        res.json({
            success: true,
            data: { updatedCount },
            message: `成功更新 ${updatedCount} 個舉報`
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '批量更新舉報失敗'
        });
    }
});
/**
 * 獲取舉報統計（管理員）
 */
router.get('/admin/stats', auth_1.authenticate, [
    (0, express_validator_1.query)('timeRange').optional().isIn(['day', 'week', 'month', 'year']).withMessage('無效的時間範圍')
], async (req, res) => {
    try {
        const { timeRange } = req.query;
        const stats = await reportService_1.reportService.getReportStats(timeRange);
        res.json({
            success: true,
            data: stats
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '獲取舉報統計失敗'
        });
    }
});
/**
 * 自動處理舉報（管理員）
 */
router.post('/admin/auto-process', auth_1.authenticate, async (req, res) => {
    try {
        const result = await reportService_1.reportService.autoProcessReports();
        res.json({
            success: true,
            data: result,
            message: `自動處理完成，處理了 ${result.processed} 個舉報`
        });
    }
    catch (error) {
        res.status(400).json({
            success: false,
            message: error.message || '自動處理舉報失敗'
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xccmVwb3J0cy50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLHNEQUE4QjtBQUU5Qiw2REFBMEQ7QUFDMUQsNkNBQWtEO0FBQ2xELHlEQUF1RDtBQUV2RCxNQUFNLE1BQU0sR0FBRyxpQkFBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRWhDOztHQUVHO0FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQ2IsbUJBQVksRUFDWjtJQUNFLElBQUEsd0JBQUksRUFBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDO0lBQ2hHLElBQUEsd0JBQUksRUFBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDO0lBQ3BELElBQUEsd0JBQUksRUFBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQztJQUNyRixJQUFBLHdCQUFJLEVBQUMsVUFBVSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQztDQUNsSCxFQUNELEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJ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amVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xccmVwb3J0cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyByZXBvcnRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcmVwb3J0U2VydmljZSc7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tICcuLi9taWRkbGV3YXJlL2F1dGgnO1xuaW1wb3J0IHsgYm9keSwgcGFyYW0sIHF1ZXJ5IH0gZnJvbSAnZXhwcmVzcy12YWxpZGF0b3InO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4vKipcbiAqIOWJteW7uuiIieWgsVxuICovXG5yb3V0ZXIucG9zdCgnLycsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIGJvZHkoJ2NvbnRlbnRUeXBlJykuaXNJbihbJ3VzZXInLCAnY29tbWVudCcsICdyZXZpZXcnLCAnbWVzc2FnZScsICdwZXQnXSkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOWFp+WuuemhnuWeiycpLFxuICAgIGJvZHkoJ2NvbnRlbnRJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTlhaflrrlJRCcpLFxuICAgIGJvZHkoJ3JlYXNvbicpLnRyaW0oKS5pc0xlbmd0aCh7IG1pbjogMSwgbWF4OiA1MDAgfSkud2l0aE1lc3NhZ2UoJ+iIieWgseWOn+WboOmVt+W6puW/hemgiOWcqDEtNTAw5a2X5LmL6ZaTJyksXG4gICAgYm9keSgnY2F0ZWdvcnknKS5vcHRpb25hbCgpLmlzSW4oWydzcGFtJywgJ2hhcmFzc21lbnQnLCAnaW5hcHByb3ByaWF0ZScsICdmYWtlJywgJ290aGVyJ10pLndpdGhNZXNzYWdlKCfnhKHmlYjnmoToiInloLHpoZ7liKUnKVxuICBdLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgY29udGVudFR5cGUsIGNvbnRlbnRJZCwgcmVhc29uLCBjYXRlZ29yeSB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCByZXBvcnRlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgICBjb25zdCByZXBvcnQgPSBhd2FpdCByZXBvcnRTZXJ2aWNlLmNyZWF0ZVJlcG9ydCh7XG4gICAgICAgIHJlcG9ydGVySWQsXG4gICAgICAgIGNvbnRlbnRUeXBlLFxuICAgICAgICBjb250ZW50SWQsXG4gICAgICAgIHJlYXNvbixcbiAgICAgICAgY2F0ZWdvcnlcbiAgICAgIH0pO1xuXG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHJlcG9ydCxcbiAgICAgICAgbWVzc2FnZTogJ+iIieWgseaPkOS6pOaIkOWKnydcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+aPkOS6pOiIieWgseWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDnjbLlj5bnlKjmiLbnmoToiInloLHmrbflj7JcbiAqL1xucm91dGVyLmdldCgnL215LXJlcG9ydHMnLFxuICBhdXRoZW50aWNhdGUsXG4gIFtcbiAgICBxdWVyeSgncGFnZScpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEgfSkud2l0aE1lc3NhZ2UoJ+mggeeivOW/hemgiOaYr+ato+aVtOaVuCcpLFxuICAgIHF1ZXJ5KCdsaW1pdCcpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEsIG1heDogNTAgfSkud2l0aE1lc3NhZ2UoJ+avj+mggeaVuOmHj+W/hemgiOWcqDEtNTDkuYvplpMnKSxcbiAgICBxdWVyeSgnc3RhdHVzJykub3B0aW9uYWwoKS5pc0luKFsncGVuZGluZycsICdpbnZlc3RpZ2F0aW5nJywgJ3Jlc29sdmVkJywgJ2Rpc21pc3NlZCddKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE54uA5oWLJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHBhZ2UgPSAxLFxuICAgICAgICBsaW1pdCA9IDIwLFxuICAgICAgICBzdGF0dXNcbiAgICAgIH0gPSByZXEucXVlcnk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9ydFNlcnZpY2UuZ2V0UmVwb3J0c0J5VXNlcih1c2VySWQsIHtcbiAgICAgICAgcGFnZTogTnVtYmVyKHBhZ2UpLFxuICAgICAgICBsaW1pdDogTnVtYmVyKGxpbWl0KSxcbiAgICAgICAgc3RhdHVzOiBzdGF0dXMgYXMgc3RyaW5nXG4gICAgICB9KTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiByZXN1bHRcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+eNsuWPluiIieWgseatt+WPsuWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLy8gPT09PT09PT09PT09PT09PT09PT0g566h55CG5ZOh5bCI55So6Lev55SxID09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICog542y5Y+W5omA5pyJ6IiJ5aCx77yI566h55CG5ZOh77yJXG4gKi9cbnJvdXRlci5nZXQoJy9hZG1pbi9hbGwnLFxuICBhdXRoZW50aWNhdGUsXG4gIFtcbiAgICBxdWVyeSgncGFnZScpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEgfSkud2l0aE1lc3NhZ2UoJ+mggeeivOW/hemgiOaYr+ato+aVtOaVuCcpLFxuICAgIHF1ZXJ5KCdsaW1pdCcpLm9wdGlvbmFsKCkuaXNJbnQoeyBtaW46IDEsIG1heDogMTAwIH0pLndpdGhNZXNzYWdlKCfmr4/poIHmlbjph4/lv4XpoIjlnKgxLTEwMOS5i+mWkycpLFxuICAgIHF1ZXJ5KCdzdGF0dXMnKS5vcHRpb25hbCgpLmlzSW4oWydwZW5kaW5nJywgJ2ludmVzdGlnYXRpbmcnLCAncmVzb2x2ZWQnLCAnZGlzbWlzc2VkJ10pLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTni4DmhYsnKSxcbiAgICBxdWVyeSgncHJpb3JpdHknKS5vcHRpb25hbCgpLmlzSW4oWydsb3cnLCAnbWVkaXVtJywgJ2hpZ2gnLCAndXJnZW50J10pLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTlhKrlhYjntJonKSxcbiAgICBxdWVyeSgnY29udGVudFR5cGUnKS5vcHRpb25hbCgpLmlzSW4oWyd1c2VyJywgJ2NvbW1lbnQnLCAncmV2aWV3JywgJ21lc3NhZ2UnLCAncGV0J10pLndpdGhNZXNzYWdlKCfnhKHmlYjnmoTlhaflrrnpoZ7lnosnKSxcbiAgICBxdWVyeSgnYXNzaWduZWRUbycpLm9wdGlvbmFsKCkuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOaMh+a0vuWwjeixoUlEJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHBhZ2UgPSAxLFxuICAgICAgICBsaW1pdCA9IDIwLFxuICAgICAgICBzdGF0dXMsXG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICBjb250ZW50VHlwZSxcbiAgICAgICAgYXNzaWduZWRUbyxcbiAgICAgICAgc29ydEJ5ID0gJ2NyZWF0ZWRBdCcsXG4gICAgICAgIHNvcnRPcmRlciA9ICdkZXNjJ1xuICAgICAgfSA9IHJlcS5xdWVyeTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3J0U2VydmljZS5nZXRSZXBvcnRzKHtcbiAgICAgICAgc3RhdHVzOiBzdGF0dXMgYXMgc3RyaW5nLFxuICAgICAgICBwcmlvcml0eTogcHJpb3JpdHkgYXMgc3RyaW5nLFxuICAgICAgICBjb250ZW50VHlwZTogY29udGVudFR5cGUgYXMgc3RyaW5nLFxuICAgICAgICBhc3NpZ25lZFRvOiBhc3NpZ25lZFRvIGFzIHN0cmluZyxcbiAgICAgICAgcGFnZTogTnVtYmVyKHBhZ2UpLFxuICAgICAgICBsaW1pdDogTnVtYmVyKGxpbWl0KSxcbiAgICAgICAgc29ydEJ5OiBzb3J0QnkgYXMgJ2NyZWF0ZWRBdCcgfCAncHJpb3JpdHknIHwgJ3N0YXR1cycsXG4gICAgICAgIHNvcnRPcmRlcjogc29ydE9yZGVyIGFzICdhc2MnIHwgJ2Rlc2MnXG4gICAgICB9KTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiByZXN1bHRcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+eNsuWPluiIieWgseWIl+ihqOWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDmm7TmlrDoiInloLHni4DmhYvvvIjnrqHnkIblk6HvvIlcbiAqL1xucm91dGVyLnB1dCgnL2FkbWluLzpyZXBvcnRJZCcsXG4gIGF1dGhlbnRpY2F0ZSxcbiAgW1xuICAgIHBhcmFtKCdyZXBvcnRJZCcpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoToiInloLFJRCcpLFxuICAgIGJvZHkoJ3N0YXR1cycpLm9wdGlvbmFsKCkuaXNJbihbJ3BlbmRpbmcnLCAnaW52ZXN0aWdhdGluZycsICdyZXNvbHZlZCcsICdkaXNtaXNzZWQnXSkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOeLgOaFiycpLFxuICAgIGJvZHkoJ3ByaW9yaXR5Jykub3B0aW9uYWwoKS5pc0luKFsnbG93JywgJ21lZGl1bScsICdoaWdoJywgJ3VyZ2VudCddKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE5YSq5YWI57SaJyksXG4gICAgYm9keSgnYXNzaWduZWRUbycpLm9wdGlvbmFsKCkuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOaMh+a0vuWwjeixoUlEJyksXG4gICAgYm9keSgncmVzb2x1dGlvbicpLm9wdGlvbmFsKCkudHJpbSgpLmlzTGVuZ3RoKHsgbWF4OiAxMDAwIH0pLndpdGhNZXNzYWdlKCfomZXnkIbntZDmnpzkuI3og73otoXpgY4xMDAw5a2XJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHJlcG9ydElkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgeyBzdGF0dXMsIHByaW9yaXR5LCBhc3NpZ25lZFRvLCByZXNvbHV0aW9uIH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IGFkbWluSWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICAgIGlmICghcmVwb3J0SWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn57y65bCR6IiJ5aCxSUTlj4PmlbgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXBvcnQgPSBhd2FpdCByZXBvcnRTZXJ2aWNlLnVwZGF0ZVJlcG9ydChyZXBvcnRJZCwgYWRtaW5JZCwge1xuICAgICAgICBzdGF0dXMsXG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICBhc3NpZ25lZFRvLFxuICAgICAgICByZXNvbHV0aW9uXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFyZXBvcnQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAn6IiJ5aCx5LiN5a2Y5ZyoJ1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmVwb3J0LFxuICAgICAgICBtZXNzYWdlOiAn6IiJ5aCx5pu05paw5oiQ5YqfJ1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ+abtOaWsOiIieWgseWkseaVlydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuKTtcblxuLyoqXG4gKiDmibnph4/omZXnkIboiInloLHvvIjnrqHnkIblk6HvvIlcbiAqL1xucm91dGVyLnB1dCgnL2FkbWluL2JhdGNoJyxcbiAgYXV0aGVudGljYXRlLFxuICBbXG4gICAgYm9keSgncmVwb3J0SWRzJykuaXNBcnJheSh7IG1pbjogMSB9KS53aXRoTWVzc2FnZSgn6IiJ5aCxSUTliJfooajkuI3og73ngrrnqbonKSxcbiAgICBib2R5KCdyZXBvcnRJZHMuKicpLmlzTW9uZ29JZCgpLndpdGhNZXNzYWdlKCfnhKHmlYjnmoToiInloLFJRCcpLFxuICAgIGJvZHkoJ3N0YXR1cycpLm9wdGlvbmFsKCkuaXNJbihbJ3BlbmRpbmcnLCAnaW52ZXN0aWdhdGluZycsICdyZXNvbHZlZCcsICdkaXNtaXNzZWQnXSkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOeLgOaFiycpLFxuICAgIGJvZHkoJ3ByaW9yaXR5Jykub3B0aW9uYWwoKS5pc0luKFsnbG93JywgJ21lZGl1bScsICdoaWdoJywgJ3VyZ2VudCddKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE5YSq5YWI57SaJyksXG4gICAgYm9keSgnYXNzaWduZWRUbycpLm9wdGlvbmFsKCkuaXNNb25nb0lkKCkud2l0aE1lc3NhZ2UoJ+eEoeaViOeahOaMh+a0vuWwjeixoUlEJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHJlcG9ydElkcywgc3RhdHVzLCBwcmlvcml0eSwgYXNzaWduZWRUbyB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBhZG1pbklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgICBjb25zdCB1cGRhdGVkQ291bnQgPSBhd2FpdCByZXBvcnRTZXJ2aWNlLmJhdGNoVXBkYXRlUmVwb3J0cyhyZXBvcnRJZHMsIGFkbWluSWQsIHtcbiAgICAgICAgc3RhdHVzLFxuICAgICAgICBwcmlvcml0eSxcbiAgICAgICAgYXNzaWduZWRUb1xuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogeyB1cGRhdGVkQ291bnQgfSxcbiAgICAgICAgbWVzc2FnZTogYOaIkOWKn+abtOaWsCAke3VwZGF0ZWRDb3VudH0g5YCL6IiJ5aCxYFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAn5om56YeP5pu05paw6IiJ5aCx5aSx5pWXJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG4vKipcbiAqIOeNsuWPluiIieWgsee1seioiO+8iOeuoeeQhuWToe+8iVxuICovXG5yb3V0ZXIuZ2V0KCcvYWRtaW4vc3RhdHMnLFxuICBhdXRoZW50aWNhdGUsXG4gIFtcbiAgICBxdWVyeSgndGltZVJhbmdlJykub3B0aW9uYWwoKS5pc0luKFsnZGF5JywgJ3dlZWsnLCAnbW9udGgnLCAneWVhciddKS53aXRoTWVzc2FnZSgn54Sh5pWI55qE5pmC6ZaT56+E5ZyNJylcbiAgXSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHRpbWVSYW5nZSB9ID0gcmVxLnF1ZXJ5O1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCByZXBvcnRTZXJ2aWNlLmdldFJlcG9ydFN0YXRzKHRpbWVSYW5nZSBhcyBhbnkpO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHN0YXRzXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIHx8ICfnjbLlj5boiInloLHntbHoqIjlpLHmlZcnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbik7XG5cbi8qKlxuICog6Ieq5YuV6JmV55CG6IiJ5aCx77yI566h55CG5ZOh77yJXG4gKi9cbnJvdXRlci5wb3N0KCcvYWRtaW4vYXV0by1wcm9jZXNzJyxcbiAgYXV0aGVudGljYXRlLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9ydFNlcnZpY2UuYXV0b1Byb2Nlc3NSZXBvcnRzKCk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmVzdWx0LFxuICAgICAgICBtZXNzYWdlOiBg6Ieq5YuV6JmV55CG5a6M5oiQ77yM6JmV55CG5LqGICR7cmVzdWx0LnByb2Nlc3NlZH0g5YCL6IiJ5aCxYFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAn6Ieq5YuV6JmV55CG6IiJ5aCx5aSx5pWXJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7Il0sInZlcnNpb24iOjN9