352d67702e2b9d3ff8734c379be48b75
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const error_handler_1 = require("../../middleware/error-handler");
const errors_1 = require("../../utils/errors");
const logger_1 = require("../../utils/logger");
const cacheMiddleware_1 = require("../../middleware/cacheMiddleware");
const validation_1 = require("../../utils/validation");
const search_1 = require("../../schemas/search");
const Pet_1 = require("../../models/Pet");
const mongoose_1 = __importDefault(require("mongoose"));
const router = (0, express_1.Router)();
/**
 * @route   GET /api/pets/:id/similar
 * @desc    搜尋相似的寵物
 * @access  Public
 */
router.get('/:id/similar', (0, validation_1.validateQuery)(search_1.petSearchSchema), (0, cacheMiddleware_1.createCacheMiddleware)({
    ttl: 15 * 60 * 1000, // 15分鐘快取
    keyGenerator: cacheMiddleware_1.petCacheKeyGenerator
}), (0, error_handler_1.asyncHandler)(async (req, res) => {
    const { id } = req.params;
    const { limit = 6, radius = 10 } = req.validatedQuery;
    if (!id || !mongoose_1.default.Types.ObjectId.isValid(id)) {
        throw new errors_1.ValidationError('請提供有效的寵物 ID');
    }
    logger_1.logger.info('搜尋相似寵物請求', { petId: id, limit, radius });
    // 獲取原始寵物資訊
    const originalPet = await Pet_1.Pet.findById(id).lean();
    if (!originalPet) {
        throw new errors_1.ValidationError('找不到指定的寵物資訊');
    }
    // 建立相似性查詢條件
    const similarityQuery = {
        _id: { $ne: new mongoose_1.default.Types.ObjectId(id) }, // 排除自己
        status: { $ne: 'reunited' } // 排除已團聚的案例
    };
    // 優先條件：相同類型
    if (originalPet.type) {
        similarityQuery.type = originalPet.type;
    }
    // 次要條件：相同品種（如果有）
    const breedQuery = { ...similarityQuery };
    if (originalPet.breed) {
        breedQuery.breed = new RegExp(originalPet.breed, 'i');
    }
    // 第三條件：相同顏色（如果有）
    const colorQuery = { ...similarityQuery };
    if (originalPet.color) {
        colorQuery.color = new RegExp(originalPet.color, 'i');
    }
    // 地理位置條件（如果有）
    const locationQuery = { ...similarityQuery };
    if (originalPet.lastSeenLocation) {
        locationQuery.lastSeenLocation = new RegExp(originalPet.lastSeenLocation, 'i');
    }
    // 執行多個查詢以獲得不同層級的相似性
    const [breedMatches, colorMatches, locationMatches, typeMatches] = await Promise.all([
        // 品種相同的寵物
        originalPet.breed ? Pet_1.Pet.find(breedQuery)
            .sort({ createdAt: -1 })
            .limit(Math.ceil(limit / 2))
            .populate('userId', 'name')
            .lean() : [],
        // 顏色相同的寵物
        originalPet.color ? Pet_1.Pet.find(colorQuery)
            .sort({ createdAt: -1 })
            .limit(Math.ceil(limit / 3))
            .populate('userId', 'name')
            .lean() : [],
        // 地點相近的寵物
        originalPet.lastSeenLocation ? Pet_1.Pet.find(locationQuery)
            .sort({ createdAt: -1 })
            .limit(Math.ceil(limit / 3))
            .populate('userId', 'name')
            .lean() : [],
        // 同類型的寵物（作為後備）
        Pet_1.Pet.find(similarityQuery)
            .sort({ createdAt: -1 })
            .limit(limit)
            .populate('userId', 'name')
            .lean()
    ]);
    // 合併結果並去重
    const allMatches = [...breedMatches, ...colorMatches, ...locationMatches, ...typeMatches];
    const uniqueMatches = allMatches.filter((pet, index, self) => index === self.findIndex(p => p._id.toString() === pet._id.toString()));
    // 按相似度排序（品種 > 顏色 > 地點 > 類型）
    const sortedMatches = uniqueMatches.sort((a, b) => {
        let scoreA = 0;
        let scoreB = 0;
        // 品種匹配得分最高
        if (originalPet.breed && a.breed &&
            a.breed.toLowerCase().includes(originalPet.breed.toLowerCase())) {
            scoreA += 4;
        }
        if (originalPet.breed && b.breed &&
            b.breed.toLowerCase().includes(originalPet.breed.toLowerCase())) {
            scoreB += 4;
        }
        // 顏色匹配
        if (originalPet.color && a.color &&
            a.color.toLowerCase().includes(originalPet.color.toLowerCase())) {
            scoreA += 3;
        }
        if (originalPet.color && b.color &&
            b.color.toLowerCase().includes(originalPet.color.toLowerCase())) {
            scoreB += 3;
        }
        // 地點匹配
        if (originalPet.lastSeenLocation && a.lastSeenLocation &&
            a.lastSeenLocation.toLowerCase().includes(originalPet.lastSeenLocation.toLowerCase())) {
            scoreA += 2;
        }
        if (originalPet.lastSeenLocation && b.lastSeenLocation &&
            b.lastSeenLocation.toLowerCase().includes(originalPet.lastSeenLocation.toLowerCase())) {
            scoreB += 2;
        }
        // 類型匹配
        if (a.type === originalPet.type)
            scoreA += 1;
        if (b.type === originalPet.type)
            scoreB += 1;
        return scoreB - scoreA; // 降序排列
    });
    // 限制結果數量
    const finalResults = sortedMatches.slice(0, limit);
    res.json({
        success: true,
        data: {
            originalPet: {
                id: originalPet._id,
                name: originalPet.name,
                type: originalPet.type,
                breed: originalPet.breed,
                color: originalPet.color,
                lastSeenLocation: originalPet.lastSeenLocation
            },
            similarPets: finalResults,
            totalFound: finalResults.length,
            searchCriteria: {
                type: originalPet.type,
                breed: originalPet.breed,
                color: originalPet.color,
                location: originalPet.lastSeenLocation,
                radius
            }
        },
    });
}));
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHJvdXRlc1xccGV0c1xcc2VhcmNoLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQWlDO0FBQ2pDLGtFQUE4RDtBQUM5RCwrQ0FBcUQ7QUFDckQsK0NBQTRDO0FBQzVDLHNFQUcwQztBQUMxQyx1REFBdUQ7QUFDdkQsaURBQXVEO0FBQ3ZELDBDQUF1QztBQUN2Qyx3REFBZ0M7QUFFaEMsTUFBTSxNQUFNLEdBQUcsSUFBQSxnQkFBTSxHQUFFLENBQUM7QUFFeEI7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUN2QixJQUFBLDBCQUFhLEVBQUMsd0JBQWUsQ0FBQyxFQUM5QixJQUFBLHVDQUFxQixFQUFDO0lBQ3BCLEdBQUcsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxTQUFTO0lBQzlCLFlBQVksRUFBRSxzQ0FBb0I7Q0FDbkMsQ0FBQyxFQUNGLElBQUEsNEJBQVksRUFBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ2hDLE1BQU0sRUFBRSxFQUFFLEVBQUUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO0lBQzFCLE1BQU0sRUFDSixLQUFLLEdBQUcsQ0FBQyxFQUNULE1BQU0sR0FBRyxFQUFFLEVBQ1osR0FBRyxHQUFHLENBQUMsY0FBYyxDQUFDO0lBRXZCLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDaEQsTUFBTSxJQUFJLHdCQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELGVBQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUV0RCxX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OlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xccm91dGVzXFxwZXRzXFxzZWFyY2gudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBhc3luY0hhbmRsZXIgfSBmcm9tICcuLi8uLi9taWRkbGV3YXJlL2Vycm9yLWhhbmRsZXInO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnLi4vLi4vdXRpbHMvZXJyb3JzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBcbiAgY3JlYXRlQ2FjaGVNaWRkbGV3YXJlLFxuICBwZXRDYWNoZUtleUdlbmVyYXRvclxufSBmcm9tICcuLi8uLi9taWRkbGV3YXJlL2NhY2hlTWlkZGxld2FyZSc7XG5pbXBvcnQgeyB2YWxpZGF0ZVF1ZXJ5IH0gZnJvbSAnLi4vLi4vdXRpbHMvdmFsaWRhdGlvbic7XG5pbXBvcnQgeyBwZXRTZWFyY2hTY2hlbWEgfSBmcm9tICcuLi8uLi9zY2hlbWFzL3NlYXJjaCc7XG5pbXBvcnQgeyBQZXQgfSBmcm9tICcuLi8uLi9tb2RlbHMvUGV0JztcbmltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5cbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4vKipcbiAqIEByb3V0ZSAgIEdFVCAvYXBpL3BldHMvOmlkL3NpbWlsYXJcbiAqIEBkZXNjICAgIOaQnOWwi+ebuOS8vOeahOWvteeJqVxuICogQGFjY2VzcyAgUHVibGljXG4gKi9cbnJvdXRlci5nZXQoJy86aWQvc2ltaWxhcicsIFxuICB2YWxpZGF0ZVF1ZXJ5KHBldFNlYXJjaFNjaGVtYSksXG4gIGNyZWF0ZUNhY2hlTWlkZGxld2FyZSh7XG4gICAgdHRsOiAxNSAqIDYwICogMTAwMCwgLy8gMTXliIbpkJjlv6vlj5ZcbiAgICBrZXlHZW5lcmF0b3I6IHBldENhY2hlS2V5R2VuZXJhdG9yXG4gIH0pLFxuICBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gIGNvbnN0IHtcbiAgICBsaW1pdCA9IDYsXG4gICAgcmFkaXVzID0gMTBcbiAgfSA9IHJlcS52YWxpZGF0ZWRRdWVyeTtcblxuICBpZiAoIWlkIHx8ICFtb25nb29zZS5UeXBlcy5PYmplY3RJZC5pc1ZhbGlkKGlkKSkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ+iri+aPkOS+m+acieaViOeahOWvteeJqSBJRCcpO1xuICB9XG5cbiAgbG9nZ2VyLmluZm8oJ+aQnOWwi+ebuOS8vOWvteeJqeiri+axgicsIHsgcGV0SWQ6IGlkLCBsaW1pdCwgcmFkaXVzIH0pO1xuXG4gIC8vIOeNsuWPluWOn+Wni+WvteeJqeizh+ioilxuICBjb25zdCBvcmlnaW5hbFBldCA9IGF3YWl0IFBldC5maW5kQnlJZChpZCkubGVhbigpO1xuICBpZiAoIW9yaWdpbmFsUGV0KSB7XG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcign5om+5LiN5Yiw5oyH5a6a55qE5a+154mp6LOH6KiKJyk7XG4gIH1cblxuICAvLyDlu7rnq4vnm7jkvLzmgKfmn6XoqaLmop3ku7ZcbiAgY29uc3Qgc2ltaWxhcml0eVF1ZXJ5OiBhbnkgPSB7XG4gICAgX2lkOiB7ICRuZTogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKGlkKSB9LCAvLyDmjpLpmaToh6rlt7FcbiAgICBzdGF0dXM6IHsgJG5lOiAncmV1bml0ZWQnIH0gLy8g5o6S6Zmk5bey5ZyY6IGa55qE5qGI5L6LXG4gIH07XG5cbiAgLy8g5YSq5YWI5qKd5Lu277ya55u45ZCM6aGe5Z6LXG4gIGlmIChvcmlnaW5hbFBldC50eXBlKSB7XG4gICAgc2ltaWxhcml0eVF1ZXJ5LnR5cGUgPSBvcmlnaW5hbFBldC50eXBlO1xuICB9XG5cbiAgLy8g5qyh6KaB5qKd5Lu277ya55u45ZCM5ZOB56iu77yI5aaC5p6c5pyJ77yJXG4gIGNvbnN0IGJyZWVkUXVlcnkgPSB7IC4uLnNpbWlsYXJpdHlRdWVyeSB9O1xuICBpZiAob3JpZ2luYWxQZXQuYnJlZWQpIHtcbiAgICBicmVlZFF1ZXJ5LmJyZWVkID0gbmV3IFJlZ0V4cChvcmlnaW5hbFBldC5icmVlZCwgJ2knKTtcbiAgfVxuXG4gIC8vIOesrOS4ieaineS7tu+8muebuOWQjOmhj+iJsu+8iOWmguaenOacie+8iVxuICBjb25zdCBjb2xvclF1ZXJ5ID0geyAuLi5zaW1pbGFyaXR5UXVlcnkgfTtcbiAgaWYgKG9yaWdpbmFsUGV0LmNvbG9yKSB7XG4gICAgY29sb3JRdWVyeS5jb2xvciA9IG5ldyBSZWdFeHAob3JpZ2luYWxQZXQuY29sb3IsICdpJyk7XG4gIH1cblxuICAvLyDlnLDnkIbkvY3nva7mop3ku7bvvIjlpoLmnpzmnInvvIlcbiAgY29uc3QgbG9jYXRpb25RdWVyeSA9IHsgLi4uc2ltaWxhcml0eVF1ZXJ5IH07XG4gIGlmIChvcmlnaW5hbFBldC5sYXN0U2VlbkxvY2F0aW9uKSB7XG4gICAgbG9jYXRpb25RdWVyeS5sYXN0U2VlbkxvY2F0aW9uID0gbmV3IFJlZ0V4cChvcmlnaW5hbFBldC5sYXN0U2VlbkxvY2F0aW9uLCAnaScpO1xuICB9XG5cbiAgLy8g5Z+36KGM5aSa5YCL5p+l6Kmi5Lul542y5b6X5LiN5ZCM5bGk57Sa55qE55u45Ly85oCnXG4gIGNvbnN0IFticmVlZE1hdGNoZXMsIGNvbG9yTWF0Y2hlcywgbG9jYXRpb25NYXRjaGVzLCB0eXBlTWF0Y2hlc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgLy8g5ZOB56iu55u45ZCM55qE5a+154mpXG4gICAgb3JpZ2luYWxQZXQuYnJlZWQgPyBQZXQuZmluZChicmVlZFF1ZXJ5KVxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXG4gICAgICAubGltaXQoTWF0aC5jZWlsKGxpbWl0IC8gMikpXG4gICAgICAucG9wdWxhdGUoJ3VzZXJJZCcsICduYW1lJylcbiAgICAgIC5sZWFuKCkgOiBbXSxcbiAgICBcbiAgICAvLyDpoY/oibLnm7jlkIznmoTlr7XnialcbiAgICBvcmlnaW5hbFBldC5jb2xvciA/IFBldC5maW5kKGNvbG9yUXVlcnkpXG4gICAgICAuc29ydCh7IGNyZWF0ZWRBdDogLTEgfSlcbiAgICAgIC5saW1pdChNYXRoLmNlaWwobGltaXQgLyAzKSlcbiAgICAgIC5wb3B1bGF0ZSgndXNlcklkJywgJ25hbWUnKVxuICAgICAgLmxlYW4oKSA6IFtdLFxuICAgIFxuICAgIC8vIOWcsOm7nuebuOi/keeahOWvteeJqVxuICAgIG9yaWdpbmFsUGV0Lmxhc3RTZWVuTG9jYXRpb24gPyBQZXQuZmluZChsb2NhdGlvblF1ZXJ5KVxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXG4gICAgICAubGltaXQoTWF0aC5jZWlsKGxpbWl0IC8gMykpXG4gICAgICAucG9wdWxhdGUoJ3VzZXJJZCcsICduYW1lJylcbiAgICAgIC5sZWFuKCkgOiBbXSxcbiAgICBcbiAgICAvLyDlkIzpoZ7lnovnmoTlr7XnianvvIjkvZzngrrlvozlgpnvvIlcbiAgICBQZXQuZmluZChzaW1pbGFyaXR5UXVlcnkpXG4gICAgICAuc29ydCh7IGNyZWF0ZWRBdDogLTEgfSlcbiAgICAgIC5saW1pdChsaW1pdClcbiAgICAgIC5wb3B1bGF0ZSgndXNlcklkJywgJ25hbWUnKVxuICAgICAgLmxlYW4oKVxuICBdKTtcblxuICAvLyDlkIjkvbXntZDmnpzkuKbljrvph41cbiAgY29uc3QgYWxsTWF0Y2hlcyA9IFsuLi5icmVlZE1hdGNoZXMsIC4uLmNvbG9yTWF0Y2hlcywgLi4ubG9jYXRpb25NYXRjaGVzLCAuLi50eXBlTWF0Y2hlc107XG4gIGNvbnN0IHVuaXF1ZU1hdGNoZXMgPSBhbGxNYXRjaGVzLmZpbHRlcigocGV0LCBpbmRleCwgc2VsZikgPT4gXG4gICAgaW5kZXggPT09IHNlbGYuZmluZEluZGV4KHAgPT4gcC5faWQudG9TdHJpbmcoKSA9PT0gcGV0Ll9pZC50b1N0cmluZygpKVxuICApO1xuXG4gIC8vIOaMieebuOS8vOW6puaOkuW6j++8iOWTgeeoriA+IOmhj+iJsiA+IOWcsOm7niA+IOmhnuWei++8iVxuICBjb25zdCBzb3J0ZWRNYXRjaGVzID0gdW5pcXVlTWF0Y2hlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgbGV0IHNjb3JlQSA9IDA7XG4gICAgbGV0IHNjb3JlQiA9IDA7XG5cbiAgICAvLyDlk4HnqK7ljLnphY3lvpfliIbmnIDpq5hcbiAgICBpZiAob3JpZ2luYWxQZXQuYnJlZWQgJiYgYS5icmVlZCAmJiBcbiAgICAgICAgYS5icmVlZC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKG9yaWdpbmFsUGV0LmJyZWVkLnRvTG93ZXJDYXNlKCkpKSB7XG4gICAgICBzY29yZUEgKz0gNDtcbiAgICB9XG4gICAgaWYgKG9yaWdpbmFsUGV0LmJyZWVkICYmIGIuYnJlZWQgJiYgXG4gICAgICAgIGIuYnJlZWQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhvcmlnaW5hbFBldC5icmVlZC50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgc2NvcmVCICs9IDQ7XG4gICAgfVxuXG4gICAgLy8g6aGP6Imy5Yy56YWNXG4gICAgaWYgKG9yaWdpbmFsUGV0LmNvbG9yICYmIGEuY29sb3IgJiYgXG4gICAgICAgIGEuY29sb3IudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhvcmlnaW5hbFBldC5jb2xvci50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgc2NvcmVBICs9IDM7XG4gICAgfVxuICAgIGlmIChvcmlnaW5hbFBldC5jb2xvciAmJiBiLmNvbG9yICYmIFxuICAgICAgICBiLmNvbG9yLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMob3JpZ2luYWxQZXQuY29sb3IudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgIHNjb3JlQiArPSAzO1xuICAgIH1cblxuICAgIC8vIOWcsOm7nuWMuemFjVxuICAgIGlmIChvcmlnaW5hbFBldC5sYXN0U2VlbkxvY2F0aW9uICYmIGEubGFzdFNlZW5Mb2NhdGlvbiAmJiBcbiAgICAgICAgYS5sYXN0U2VlbkxvY2F0aW9uLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMob3JpZ2luYWxQZXQubGFzdFNlZW5Mb2NhdGlvbi50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgc2NvcmVBICs9IDI7XG4gICAgfVxuICAgIGlmIChvcmlnaW5hbFBldC5sYXN0U2VlbkxvY2F0aW9uICYmIGIubGFzdFNlZW5Mb2NhdGlvbiAmJiBcbiAgICAgICAgYi5sYXN0U2VlbkxvY2F0aW9uLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMob3JpZ2luYWxQZXQubGFzdFNlZW5Mb2NhdGlvbi50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgc2NvcmVCICs9IDI7XG4gICAgfVxuXG4gICAgLy8g6aGe5Z6L5Yy56YWNXG4gICAgaWYgKGEudHlwZSA9PT0gb3JpZ2luYWxQZXQudHlwZSkgc2NvcmVBICs9IDE7XG4gICAgaWYgKGIudHlwZSA9PT0gb3JpZ2luYWxQZXQudHlwZSkgc2NvcmVCICs9IDE7XG5cbiAgICByZXR1cm4gc2NvcmVCIC0gc2NvcmVBOyAvLyDpmY3luo/mjpLliJdcbiAgfSk7XG5cbiAgLy8g6ZmQ5Yi257WQ5p6c5pW46YePXG4gIGNvbnN0IGZpbmFsUmVzdWx0cyA9IHNvcnRlZE1hdGNoZXMuc2xpY2UoMCwgbGltaXQpO1xuXG4gIHJlcy5qc29uKHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGRhdGE6IHtcbiAgICAgIG9yaWdpbmFsUGV0OiB7XG4gICAgICAgIGlkOiBvcmlnaW5hbFBldC5faWQsXG4gICAgICAgIG5hbWU6IG9yaWdpbmFsUGV0Lm5hbWUsXG4gICAgICAgIHR5cGU6IG9yaWdpbmFsUGV0LnR5cGUsXG4gICAgICAgIGJyZWVkOiBvcmlnaW5hbFBldC5icmVlZCxcbiAgICAgICAgY29sb3I6IG9yaWdpbmFsUGV0LmNvbG9yLFxuICAgICAgICBsYXN0U2VlbkxvY2F0aW9uOiBvcmlnaW5hbFBldC5sYXN0U2VlbkxvY2F0aW9uXG4gICAgICB9LFxuICAgICAgc2ltaWxhclBldHM6IGZpbmFsUmVzdWx0cyxcbiAgICAgIHRvdGFsRm91bmQ6IGZpbmFsUmVzdWx0cy5sZW5ndGgsXG4gICAgICBzZWFyY2hDcml0ZXJpYToge1xuICAgICAgICB0eXBlOiBvcmlnaW5hbFBldC50eXBlLFxuICAgICAgICBicmVlZDogb3JpZ2luYWxQZXQuYnJlZWQsXG4gICAgICAgIGNvbG9yOiBvcmlnaW5hbFBldC5jb2xvcixcbiAgICAgICAgbG9jYXRpb246IG9yaWdpbmFsUGV0Lmxhc3RTZWVuTG9jYXRpb24sXG4gICAgICAgIHJhZGl1c1xuICAgICAgfVxuICAgIH0sXG4gIH0pO1xufSkpO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7Il0sInZlcnNpb24iOjN9