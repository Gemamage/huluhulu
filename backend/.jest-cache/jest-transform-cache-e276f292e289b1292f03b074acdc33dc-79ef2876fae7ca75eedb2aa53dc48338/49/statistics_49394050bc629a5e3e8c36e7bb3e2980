57f216934bade9e14ab26803a4d4709c
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NotificationStatisticsService = void 0;
const Notification_1 = require("../../models/Notification");
const logger_1 = require("../../utils/logger");
const mongoose_1 = __importDefault(require("mongoose"));
const aiMatching_1 = require("./aiMatching");
const geofence_1 = require("./geofence");
const reminders_1 = require("./reminders");
class NotificationStatisticsService {
    /**
     * 獲取智能通知統計
     */
    static async getSmartNotificationStats() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
        // 獲取今日通知總數
        const totalNotifications = await Notification_1.Notification.countDocuments({
            createdAt: {
                $gte: today,
                $lt: tomorrow,
            },
        });
        // 獲取各服務狀態
        const aiMatchingStatus = aiMatching_1.AIMatchingService.getStatus();
        const geofenceStats = geofence_1.GeofenceService.getStats();
        const reminderStats = await reminders_1.ReminderService.getStats();
        return {
            aiMatching: {
                enabled: aiMatchingStatus.enabled,
                running: aiMatchingStatus.running,
                lastRun: aiMatchingStatus.lastRun || undefined,
                matchesFound: 0, // 可以從統計中獲取
            },
            geofence: {
                enabled: geofenceStats.enabled,
                running: geofenceStats.running,
                activeAreas: geofenceStats.activeAreas,
                totalAreas: geofenceStats.totalAreas,
            },
            reminders: {
                enabled: reminderStats.enabled,
                running: reminderStats.running,
                sentToday: reminderStats.sentToday,
            },
            totalNotifications,
        };
    }
    /**
     * 獲取智能通知統計（用戶特定）
     */
    static async getSmartNotificationStatistics(options) {
        const { userId, startDate, endDate } = options;
        // 設定日期範圍
        const start = startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000); // 預設 30 天前
        const end = endDate || new Date();
        // 統計通知數量
        const notificationStats = await Notification_1.Notification.aggregate([
            {
                $match: {
                    userId: new mongoose_1.default.Types.ObjectId(userId),
                    createdAt: { $gte: start, $lte: end },
                },
            },
            {
                $group: {
                    _id: "$type",
                    count: { $sum: 1 },
                },
            },
        ]);
        const stats = notificationStats.reduce((acc, stat) => {
            acc[stat._id] = stat.count;
            return acc;
        }, {});
        // 統計用戶的地理圍欄
        const userGeofences = await geofence_1.GeofenceService.getUserGeofences(userId);
        // 獲取 AI 配對狀態
        const aiMatchingStatus = aiMatching_1.AIMatchingService.getStatus();
        const geofenceStats = geofence_1.GeofenceService.getStats();
        const reminderStats = await reminders_1.ReminderService.getStats();
        return {
            aiMatching: {
                enabled: aiMatchingStatus.enabled,
                matchesFound: stats["AI_MATCH_SUGGESTION"] || 0,
                lastRun: aiMatchingStatus.lastRun || undefined,
            },
            geofencing: {
                enabled: geofenceStats.enabled,
                activeAreas: userGeofences.length,
            },
            reminders: {
                enabled: reminderStats.enabled,
                sentCount: stats["REMINDER"] || 0,
            },
            totalNotifications: Object.values(stats).reduce((sum, count) => sum + count, 0),
        };
    }
    /**
     * 獲取通知類型統計
     */
    static async getNotificationTypeStats(options) {
        const { userId, startDate, endDate } = options;
        const start = startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        const end = endDate || new Date();
        const matchConditions = {
            createdAt: { $gte: start, $lte: end },
        };
        if (userId) {
            matchConditions.userId = new mongoose_1.default.Types.ObjectId(userId);
        }
        const stats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: "$type",
                    count: { $sum: 1 },
                },
            },
            { $sort: { count: -1 } },
        ]);
        return stats.reduce((acc, stat) => {
            acc[stat._id] = stat.count;
            return acc;
        }, {});
    }
    /**
     * 獲取通知趨勢統計
     */
    static async getNotificationTrends(options) {
        const { userId, days = 30 } = options;
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
        const endDate = new Date();
        const matchConditions = {
            createdAt: { $gte: startDate, $lte: endDate },
        };
        if (userId) {
            matchConditions.userId = new mongoose_1.default.Types.ObjectId(userId);
        }
        // 每日統計
        const dailyStats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: {
                        year: { $year: "$createdAt" },
                        month: { $month: "$createdAt" },
                        day: { $dayOfMonth: "$createdAt" },
                    },
                    count: { $sum: 1 },
                },
            },
            { $sort: { "_id.year": 1, "_id.month": 1, "_id.day": 1 } },
        ]);
        // 每週統計
        const weeklyStats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: {
                        year: { $year: "$createdAt" },
                        week: { $week: "$createdAt" },
                    },
                    count: { $sum: 1 },
                },
            },
            { $sort: { "_id.year": 1, "_id.week": 1 } },
        ]);
        return {
            daily: dailyStats.map((stat) => ({
                date: `${stat._id.year}-${String(stat._id.month).padStart(2, "0")}-${String(stat._id.day).padStart(2, "0")}`,
                count: stat.count,
            })),
            weekly: weeklyStats.map((stat) => ({
                week: `${stat._id.year}-W${String(stat._id.week).padStart(2, "0")}`,
                count: stat.count,
            })),
        };
    }
    /**
     * 獲取通知效果統計
     */
    static async getNotificationEffectivenessStats(options) {
        const { userId, startDate, endDate } = options;
        const start = startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        const end = endDate || new Date();
        const matchConditions = {
            createdAt: { $gte: start, $lte: end },
        };
        if (userId) {
            matchConditions.userId = new mongoose_1.default.Types.ObjectId(userId);
        }
        const stats = await Notification_1.Notification.aggregate([
            { $match: matchConditions },
            {
                $group: {
                    _id: "$type",
                    totalSent: { $sum: 1 },
                    totalRead: { $sum: { $cond: [{ $eq: ["$isRead", true] }, 1, 0] } },
                    totalClicked: {
                        $sum: { $cond: [{ $ne: ["$clickedAt", null] }, 1, 0] },
                    },
                },
            },
        ]);
        let totalSent = 0;
        let totalRead = 0;
        let totalClicked = 0;
        const typeEffectiveness = {};
        for (const stat of stats) {
            totalSent += stat.totalSent;
            totalRead += stat.totalRead;
            totalClicked += stat.totalClicked;
            typeEffectiveness[stat._id] = {
                sent: stat.totalSent,
                read: stat.totalRead,
                clicked: stat.totalClicked,
                readRate: stat.totalSent > 0 ? (stat.totalRead / stat.totalSent) * 100 : 0,
                clickRate: stat.totalSent > 0 ? (stat.totalClicked / stat.totalSent) * 100 : 0,
            };
        }
        return {
            totalSent,
            totalRead,
            totalClicked,
            readRate: totalSent > 0 ? (totalRead / totalSent) * 100 : 0,
            clickRate: totalSent > 0 ? (totalClicked / totalSent) * 100 : 0,
            typeEffectiveness,
        };
    }
    /**
     * 清理過期統計數據
     */
    static async cleanupOldStats(daysToKeep = 90) {
        const cutoffDate = new Date(Date.now() - daysToKeep * 24 * 60 * 60 * 1000);
        const result = await Notification_1.Notification.deleteMany({
            createdAt: { $lt: cutoffDate },
            isRead: true, // 只刪除已讀的舊通知
        });
        logger_1.logger.info("清理過期統計數據完成", {
            deletedCount: result.deletedCount,
            cutoffDate,
            daysToKeep,
        });
        return {
            deletedCount: result.deletedCount || 0,
        };
    }
}
exports.NotificationStatisticsService = NotificationStatisticsService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxub3RpZmljYXRpb25zXFxzdGF0aXN0aWNzLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDREQUF5RDtBQUN6RCwrQ0FBNEM7QUFDNUMsd0RBQWdDO0FBQ2hDLDZDQUFpRDtBQUNqRCx5Q0FBNkM7QUFDN0MsMkNBQThDO0FBd0M5QyxNQUFhLDZCQUE2QjtJQUN4Qzs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMseUJBQXlCO1FBQ3BDLE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDekIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFakUsV0FBVztRQUNYLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSwyQkFBWSxDQUFDLGNBQWMsQ0FBQztZQUMzRCxTQUFTLEVBQUU7Z0JBQ1QsSUFBSSxFQUFFLEtBQUs7Z0JBQ1gsR0FBRyxFQUFFLFFBQVE7YUFDZDtTQUNGLENBQUMsQ0FBQztRQUVILFVBQVU7UUFDVixNQUFNLGdCQUFnQixHQUFHLDhCQUFpQixDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3ZELE1BQU0sYUFBYSxHQUFHLDBCQUFlLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakQsTUFBTSxhQUFhLEdBQUcsTUFBTSwyQkFBZSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXZELE9BQU87WUFDTCxVQUFVLEVBQUU7Z0JBQ1YsT0FBTyxFQUFFLGdCQUFnQixDQUFDLE9BQU87Z0JBQ2pDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxPQUFPO2dCQUNqQyxPQUFP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QUFDLENBQUMsQ0FBQzthQUN0RSxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU87WUFDTCxTQUFTO1lBQ1QsU0FBUztZQUNULFlBQVk7WUFDWixRQUFRLEVBQUUsU0FBUyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzNELFNBQVMsRUFBRSxTQUFTLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0QsaUJBQWlCO1NBQ2xCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxhQUFxQixFQUFFO1FBR2xELE1BQU0sVUFBVSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxVQUFVLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFM0UsTUFBTSxNQUFNLEdBQUcsTUFBTSwyQkFBWSxDQUFDLFVBQVUsQ0FBQztZQUMzQyxTQUFTLEVBQUUsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFO1lBQzlCLE1BQU0sRUFBRSxJQUFJLEVBQUUsWUFBWTtTQUMzQixDQUFDLENBQUM7UUFFSCxlQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN4QixZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVk7WUFDakMsVUFBVTtZQUNWLFVBQVU7U0FDWCxDQUFDLENBQUM7UUFFSCxPQUFPO1lBQ0wsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZLElBQUksQ0FBQztTQUN2QyxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBblVELHNFQW1VQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xcc2VydmljZXNcXG5vdGlmaWNhdGlvbnNcXHN0YXRpc3RpY3MudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTm90aWZpY2F0aW9uIH0gZnJvbSBcIi4uLy4uL21vZGVscy9Ob3RpZmljYXRpb25cIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCIuLi8uLi91dGlscy9sb2dnZXJcIjtcbmltcG9ydCBtb25nb29zZSBmcm9tIFwibW9uZ29vc2VcIjtcbmltcG9ydCB7IEFJTWF0Y2hpbmdTZXJ2aWNlIH0gZnJvbSBcIi4vYWlNYXRjaGluZ1wiO1xuaW1wb3J0IHsgR2VvZmVuY2VTZXJ2aWNlIH0gZnJvbSBcIi4vZ2VvZmVuY2VcIjtcbmltcG9ydCB7IFJlbWluZGVyU2VydmljZSB9IGZyb20gXCIuL3JlbWluZGVyc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNtYXJ0Tm90aWZpY2F0aW9uU3RhdHMge1xuICBhaU1hdGNoaW5nOiB7XG4gICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICBydW5uaW5nOiBib29sZWFuO1xuICAgIGxhc3RSdW4/OiBEYXRlO1xuICAgIG1hdGNoZXNGb3VuZDogbnVtYmVyO1xuICB9O1xuICBnZW9mZW5jZToge1xuICAgIGVuYWJsZWQ6IGJvb2xlYW47XG4gICAgcnVubmluZzogYm9vbGVhbjtcbiAgICBhY3RpdmVBcmVhczogbnVtYmVyO1xuICAgIHRvdGFsQXJlYXM6IG51bWJlcjtcbiAgfTtcbiAgcmVtaW5kZXJzOiB7XG4gICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICBydW5uaW5nOiBib29sZWFuO1xuICAgIHNlbnRUb2RheTogbnVtYmVyO1xuICB9O1xuICB0b3RhbE5vdGlmaWNhdGlvbnM6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBVc2VyTm90aWZpY2F0aW9uU3RhdHMge1xuICBhaU1hdGNoaW5nOiB7XG4gICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICBtYXRjaGVzRm91bmQ6IG51bWJlcjtcbiAgICBsYXN0UnVuPzogRGF0ZTtcbiAgfTtcbiAgZ2VvZmVuY2luZzoge1xuICAgIGVuYWJsZWQ6IGJvb2xlYW47XG4gICAgYWN0aXZlQXJlYXM6IG51bWJlcjtcbiAgfTtcbiAgcmVtaW5kZXJzOiB7XG4gICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICBzZW50Q291bnQ6IG51bWJlcjtcbiAgfTtcbiAgdG90YWxOb3RpZmljYXRpb25zOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBOb3RpZmljYXRpb25TdGF0aXN0aWNzU2VydmljZSB7XG4gIC8qKlxuICAgKiDnjbLlj5bmmbrog73pgJrnn6XntbHoqIhcbiAgICovXG4gIHN0YXRpYyBhc3luYyBnZXRTbWFydE5vdGlmaWNhdGlvblN0YXRzKCk6IFByb21pc2U8U21hcnROb3RpZmljYXRpb25TdGF0cz4ge1xuICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgICB0b2RheS5zZXRIb3VycygwLCAwLCAwLCAwKTtcbiAgICBjb25zdCB0b21vcnJvdyA9IG5ldyBEYXRlKHRvZGF5LmdldFRpbWUoKSArIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuXG4gICAgLy8g542y5Y+W5LuK5pel6YCa55+l57i95pW4XG4gICAgY29uc3QgdG90YWxOb3RpZmljYXRpb25zID0gYXdhaXQgTm90aWZpY2F0aW9uLmNvdW50RG9jdW1lbnRzKHtcbiAgICAgIGNyZWF0ZWRBdDoge1xuICAgICAgICAkZ3RlOiB0b2RheSxcbiAgICAgICAgJGx0OiB0b21vcnJvdyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyDnjbLlj5blkITmnI3li5nni4DmhYtcbiAgICBjb25zdCBhaU1hdGNoaW5nU3RhdHVzID0gQUlNYXRjaGluZ1NlcnZpY2UuZ2V0U3RhdHVzKCk7XG4gICAgY29uc3QgZ2VvZmVuY2VTdGF0cyA9IEdlb2ZlbmNlU2VydmljZS5nZXRTdGF0cygpO1xuICAgIGNvbnN0IHJlbWluZGVyU3RhdHMgPSBhd2FpdCBSZW1pbmRlclNlcnZpY2UuZ2V0U3RhdHMoKTtcblxuICAgIHJldHVybiB7XG4gICAgICBhaU1hdGNoaW5nOiB7XG4gICAgICAgIGVuYWJsZWQ6IGFpTWF0Y2hpbmdTdGF0dXMuZW5hYmxlZCxcbiAgICAgICAgcnVubmluZzogYWlNYXRjaGluZ1N0YXR1cy5ydW5uaW5nLFxuICAgICAgICBsYXN0UnVuOiBhaU1hdGNoaW5nU3RhdHVzLmxhc3RSdW4gfHwgdW5kZWZpbmVkLFxuICAgICAgICBtYXRjaGVzRm91bmQ6IDAsIC8vIOWPr+S7peW+nue1seioiOS4reeNsuWPllxuICAgICAgfSxcbiAgICAgIGdlb2ZlbmNlOiB7XG4gICAgICAgIGVuYWJsZWQ6IGdlb2ZlbmNlU3RhdHMuZW5hYmxlZCxcbiAgICAgICAgcnVubmluZzogZ2VvZmVuY2VTdGF0cy5ydW5uaW5nLFxuICAgICAgICBhY3RpdmVBcmVhczogZ2VvZmVuY2VTdGF0cy5hY3RpdmVBcmVhcyxcbiAgICAgICAgdG90YWxBcmVhczogZ2VvZmVuY2VTdGF0cy50b3RhbEFyZWFzLFxuICAgICAgfSxcbiAgICAgIHJlbWluZGVyczoge1xuICAgICAgICBlbmFibGVkOiByZW1pbmRlclN0YXRzLmVuYWJsZWQsXG4gICAgICAgIHJ1bm5pbmc6IHJlbWluZGVyU3RhdHMucnVubmluZyxcbiAgICAgICAgc2VudFRvZGF5OiByZW1pbmRlclN0YXRzLnNlbnRUb2RheSxcbiAgICAgIH0sXG4gICAgICB0b3RhbE5vdGlmaWNhdGlvbnMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnjbLlj5bmmbrog73pgJrnn6XntbHoqIjvvIjnlKjmiLbnibnlrprvvIlcbiAgICovXG4gIHN0YXRpYyBhc3luYyBnZXRTbWFydE5vdGlmaWNhdGlvblN0YXRpc3RpY3Mob3B0aW9uczoge1xuICAgIHVzZXJJZDogc3RyaW5nO1xuICAgIHN0YXJ0RGF0ZT86IERhdGU7XG4gICAgZW5kRGF0ZT86IERhdGU7XG4gIH0pOiBQcm9taXNlPFVzZXJOb3RpZmljYXRpb25TdGF0cz4ge1xuICAgIGNvbnN0IHsgdXNlcklkLCBzdGFydERhdGUsIGVuZERhdGUgfSA9IG9wdGlvbnM7XG5cbiAgICAvLyDoqK3lrprml6XmnJ/nr4TlnI1cbiAgICBjb25zdCBzdGFydCA9IHN0YXJ0RGF0ZSB8fCBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMzAgKiAyNCAqIDYwICogNjAgKiAxMDAwKTsgLy8g6aCQ6KitIDMwIOWkqeWJjVxuICAgIGNvbnN0IGVuZCA9IGVuZERhdGUgfHwgbmV3IERhdGUoKTtcblxuICAgIC8vIOe1seioiOmAmuefpeaVuOmHj1xuICAgIGNvbnN0IG5vdGlmaWNhdGlvblN0YXRzID0gYXdhaXQgTm90aWZpY2F0aW9uLmFnZ3JlZ2F0ZShbXG4gICAgICB7XG4gICAgICAgICRtYXRjaDoge1xuICAgICAgICAgIHVzZXJJZDogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKHVzZXJJZCksXG4gICAgICAgICAgY3JlYXRlZEF0OiB7ICRndGU6IHN0YXJ0LCAkbHRlOiBlbmQgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgICRncm91cDoge1xuICAgICAgICAgIF9pZDogXCIkdHlwZVwiLFxuICAgICAgICAgIGNvdW50OiB7ICRzdW06IDEgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSk7XG5cbiAgICBjb25zdCBzdGF0cyA9IG5vdGlmaWNhdGlvblN0YXRzLnJlZHVjZShcbiAgICAgIChhY2MsIHN0YXQpID0+IHtcbiAgICAgICAgYWNjW3N0YXQuX2lkXSA9IHN0YXQuY291bnQ7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge30gYXMgUmVjb3JkPHN0cmluZywgbnVtYmVyPixcbiAgICApO1xuXG4gICAgLy8g57Wx6KiI55So5oi255qE5Zyw55CG5ZyN5qyEXG4gICAgY29uc3QgdXNlckdlb2ZlbmNlcyA9IGF3YWl0IEdlb2ZlbmNlU2VydmljZS5nZXRVc2VyR2VvZmVuY2VzKHVzZXJJZCk7XG5cbiAgICAvLyDnjbLlj5YgQUkg6YWN5bCN54uA5oWLXG4gICAgY29uc3QgYWlNYXRjaGluZ1N0YXR1cyA9IEFJTWF0Y2hpbmdTZXJ2aWNlLmdldFN0YXR1cygpO1xuICAgIGNvbnN0IGdlb2ZlbmNlU3RhdHMgPSBHZW9mZW5jZVNlcnZpY2UuZ2V0U3RhdHMoKTtcbiAgICBjb25zdCByZW1pbmRlclN0YXRzID0gYXdhaXQgUmVtaW5kZXJTZXJ2aWNlLmdldFN0YXRzKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgYWlNYXRjaGluZzoge1xuICAgICAgICBlbmFibGVkOiBhaU1hdGNoaW5nU3RhdHVzLmVuYWJsZWQsXG4gICAgICAgIG1hdGNoZXNGb3VuZDogc3RhdHNbXCJBSV9NQVRDSF9TVUdHRVNUSU9OXCJdIHx8IDAsXG4gICAgICAgIGxhc3RSdW46IGFpTWF0Y2hpbmdTdGF0dXMubGFzdFJ1biB8fCB1bmRlZmluZWQsXG4gICAgICB9LFxuICAgICAgZ2VvZmVuY2luZzoge1xuICAgICAgICBlbmFibGVkOiBnZW9mZW5jZVN0YXRzLmVuYWJsZWQsXG4gICAgICAgIGFjdGl2ZUFyZWFzOiB1c2VyR2VvZmVuY2VzLmxlbmd0aCxcbiAgICAgIH0sXG4gICAgICByZW1pbmRlcnM6IHtcbiAgICAgICAgZW5hYmxlZDogcmVtaW5kZXJTdGF0cy5lbmFibGVkLFxuICAgICAgICBzZW50Q291bnQ6IHN0YXRzW1wiUkVNSU5ERVJcIl0gfHwgMCxcbiAgICAgIH0sXG4gICAgICB0b3RhbE5vdGlmaWNhdGlvbnM6IE9iamVjdC52YWx1ZXMoc3RhdHMpLnJlZHVjZShcbiAgICAgICAgKHN1bTogbnVtYmVyLCBjb3VudDogdW5rbm93bikgPT4gc3VtICsgKGNvdW50IGFzIG51bWJlciksXG4gICAgICAgIDAsXG4gICAgICApLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICog542y5Y+W6YCa55+l6aGe5Z6L57Wx6KiIXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0Tm90aWZpY2F0aW9uVHlwZVN0YXRzKG9wdGlvbnM6IHtcbiAgICB1c2VySWQ/OiBzdHJpbmc7XG4gICAgc3RhcnREYXRlPzogRGF0ZTtcbiAgICBlbmREYXRlPzogRGF0ZTtcbiAgfSk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgbnVtYmVyPj4ge1xuICAgIGNvbnN0IHsgdXNlcklkLCBzdGFydERhdGUsIGVuZERhdGUgfSA9IG9wdGlvbnM7XG5cbiAgICBjb25zdCBzdGFydCA9IHN0YXJ0RGF0ZSB8fCBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMzAgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICBjb25zdCBlbmQgPSBlbmREYXRlIHx8IG5ldyBEYXRlKCk7XG5cbiAgICBjb25zdCBtYXRjaENvbmRpdGlvbnM6IGFueSA9IHtcbiAgICAgIGNyZWF0ZWRBdDogeyAkZ3RlOiBzdGFydCwgJGx0ZTogZW5kIH0sXG4gICAgfTtcblxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIG1hdGNoQ29uZGl0aW9ucy51c2VySWQgPSBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IE5vdGlmaWNhdGlvbi5hZ2dyZWdhdGUoW1xuICAgICAgeyAkbWF0Y2g6IG1hdGNoQ29uZGl0aW9ucyB9LFxuICAgICAge1xuICAgICAgICAkZ3JvdXA6IHtcbiAgICAgICAgICBfaWQ6IFwiJHR5cGVcIixcbiAgICAgICAgICBjb3VudDogeyAkc3VtOiAxIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgeyAkc29ydDogeyBjb3VudDogLTEgfSB9LFxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHN0YXRzLnJlZHVjZShcbiAgICAgIChhY2MsIHN0YXQpID0+IHtcbiAgICAgICAgYWNjW3N0YXQuX2lkXSA9IHN0YXQuY291bnQ7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge30gYXMgUmVjb3JkPHN0cmluZywgbnVtYmVyPixcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPlumAmuefpei2qOWLoue1seioiFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGdldE5vdGlmaWNhdGlvblRyZW5kcyhvcHRpb25zOiB7XG4gICAgdXNlcklkPzogc3RyaW5nO1xuICAgIGRheXM/OiBudW1iZXI7XG4gIH0pOiBQcm9taXNlPHtcbiAgICBkYWlseTogQXJyYXk8eyBkYXRlOiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfT47XG4gICAgd2Vla2x5OiBBcnJheTx7IHdlZWs6IHN0cmluZzsgY291bnQ6IG51bWJlciB9PjtcbiAgfT4ge1xuICAgIGNvbnN0IHsgdXNlcklkLCBkYXlzID0gMzAgfSA9IG9wdGlvbnM7XG5cbiAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gZGF5cyAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgY29uc3QgbWF0Y2hDb25kaXRpb25zOiBhbnkgPSB7XG4gICAgICBjcmVhdGVkQXQ6IHsgJGd0ZTogc3RhcnREYXRlLCAkbHRlOiBlbmREYXRlIH0sXG4gICAgfTtcblxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIG1hdGNoQ29uZGl0aW9ucy51c2VySWQgPSBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQodXNlcklkKTtcbiAgICB9XG5cbiAgICAvLyDmr4/ml6XntbHoqIhcbiAgICBjb25zdCBkYWlseVN0YXRzID0gYXdhaXQgTm90aWZpY2F0aW9uLmFnZ3JlZ2F0ZShbXG4gICAgICB7ICRtYXRjaDogbWF0Y2hDb25kaXRpb25zIH0sXG4gICAgICB7XG4gICAgICAgICRncm91cDoge1xuICAgICAgICAgIF9pZDoge1xuICAgICAgICAgICAgeWVhcjogeyAkeWVhcjogXCIkY3JlYXRlZEF0XCIgfSxcbiAgICAgICAgICAgIG1vbnRoOiB7ICRtb250aDogXCIkY3JlYXRlZEF0XCIgfSxcbiAgICAgICAgICAgIGRheTogeyAkZGF5T2ZNb250aDogXCIkY3JlYXRlZEF0XCIgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvdW50OiB7ICRzdW06IDEgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7ICRzb3J0OiB7IFwiX2lkLnllYXJcIjogMSwgXCJfaWQubW9udGhcIjogMSwgXCJfaWQuZGF5XCI6IDEgfSB9LFxuICAgIF0pO1xuXG4gICAgLy8g5q+P6YCx57Wx6KiIXG4gICAgY29uc3Qgd2Vla2x5U3RhdHMgPSBhd2FpdCBOb3RpZmljYXRpb24uYWdncmVnYXRlKFtcbiAgICAgIHsgJG1hdGNoOiBtYXRjaENvbmRpdGlvbnMgfSxcbiAgICAgIHtcbiAgICAgICAgJGdyb3VwOiB7XG4gICAgICAgICAgX2lkOiB7XG4gICAgICAgICAgICB5ZWFyOiB7ICR5ZWFyOiBcIiRjcmVhdGVkQXRcIiB9LFxuICAgICAgICAgICAgd2VlazogeyAkd2VlazogXCIkY3JlYXRlZEF0XCIgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvdW50OiB7ICRzdW06IDEgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7ICRzb3J0OiB7IFwiX2lkLnllYXJcIjogMSwgXCJfaWQud2Vla1wiOiAxIH0gfSxcbiAgICBdKTtcblxuICAgIHJldHVybiB7XG4gICAgICBkYWlseTogZGFpbHlTdGF0cy5tYXAoKHN0YXQpID0+ICh7XG4gICAgICAgIGRhdGU6IGAke3N0YXQuX2lkLnllYXJ9LSR7U3RyaW5nKHN0YXQuX2lkLm1vbnRoKS5wYWRTdGFydCgyLCBcIjBcIil9LSR7U3RyaW5nKHN0YXQuX2lkLmRheSkucGFkU3RhcnQoMiwgXCIwXCIpfWAsXG4gICAgICAgIGNvdW50OiBzdGF0LmNvdW50LFxuICAgICAgfSkpLFxuICAgICAgd2Vla2x5OiB3ZWVrbHlTdGF0cy5tYXAoKHN0YXQpID0+ICh7XG4gICAgICAgIHdlZWs6IGAke3N0YXQuX2lkLnllYXJ9LVcke1N0cmluZyhzdGF0Ll9pZC53ZWVrKS5wYWRTdGFydCgyLCBcIjBcIil9YCxcbiAgICAgICAgY291bnQ6IHN0YXQuY291bnQsXG4gICAgICB9KSksXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnjbLlj5bpgJrnn6XmlYjmnpzntbHoqIhcbiAgICovXG4gIHN0YXRpYyBhc3luYyBnZXROb3RpZmljYXRpb25FZmZlY3RpdmVuZXNzU3RhdHMob3B0aW9uczoge1xuICAgIHVzZXJJZD86IHN0cmluZztcbiAgICBzdGFydERhdGU/OiBEYXRlO1xuICAgIGVuZERhdGU/OiBEYXRlO1xuICB9KTogUHJvbWlzZTx7XG4gICAgdG90YWxTZW50OiBudW1iZXI7XG4gICAgdG90YWxSZWFkOiBudW1iZXI7XG4gICAgdG90YWxDbGlja2VkOiBudW1iZXI7XG4gICAgcmVhZFJhdGU6IG51bWJlcjtcbiAgICBjbGlja1JhdGU6IG51bWJlcjtcbiAgICB0eXBlRWZmZWN0aXZlbmVzczogUmVjb3JkPFxuICAgICAgc3RyaW5nLFxuICAgICAge1xuICAgICAgICBzZW50OiBudW1iZXI7XG4gICAgICAgIHJlYWQ6IG51bWJlcjtcbiAgICAgICAgY2xpY2tlZDogbnVtYmVyO1xuICAgICAgICByZWFkUmF0ZTogbnVtYmVyO1xuICAgICAgICBjbGlja1JhdGU6IG51bWJlcjtcbiAgICAgIH1cbiAgICA+O1xuICB9PiB7XG4gICAgY29uc3QgeyB1c2VySWQsIHN0YXJ0RGF0ZSwgZW5kRGF0ZSB9ID0gb3B0aW9ucztcblxuICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnREYXRlIHx8IG5ldyBEYXRlKERhdGUubm93KCkgLSAzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgIGNvbnN0IGVuZCA9IGVuZERhdGUgfHwgbmV3IERhdGUoKTtcblxuICAgIGNvbnN0IG1hdGNoQ29uZGl0aW9uczogYW55ID0ge1xuICAgICAgY3JlYXRlZEF0OiB7ICRndGU6IHN0YXJ0LCAkbHRlOiBlbmQgfSxcbiAgICB9O1xuXG4gICAgaWYgKHVzZXJJZCkge1xuICAgICAgbWF0Y2hDb25kaXRpb25zLnVzZXJJZCA9IG5ldyBtb25nb29zZS5UeXBlcy5PYmplY3RJZCh1c2VySWQpO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgTm90aWZpY2F0aW9uLmFnZ3JlZ2F0ZShbXG4gICAgICB7ICRtYXRjaDogbWF0Y2hDb25kaXRpb25zIH0sXG4gICAgICB7XG4gICAgICAgICRncm91cDoge1xuICAgICAgICAgIF9pZDogXCIkdHlwZVwiLFxuICAgICAgICAgIHRvdGFsU2VudDogeyAkc3VtOiAxIH0sXG4gICAgICAgICAgdG90YWxSZWFkOiB7ICRzdW06IHsgJGNvbmQ6IFt7ICRlcTogW1wiJGlzUmVhZFwiLCB0cnVlXSB9LCAxLCAwXSB9IH0sXG4gICAgICAgICAgdG90YWxDbGlja2VkOiB7XG4gICAgICAgICAgICAkc3VtOiB7ICRjb25kOiBbeyAkbmU6IFtcIiRjbGlja2VkQXRcIiwgbnVsbF0gfSwgMSwgMF0gfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICBdKTtcblxuICAgIGxldCB0b3RhbFNlbnQgPSAwO1xuICAgIGxldCB0b3RhbFJlYWQgPSAwO1xuICAgIGxldCB0b3RhbENsaWNrZWQgPSAwO1xuICAgIGNvbnN0IHR5cGVFZmZlY3RpdmVuZXNzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHN0YXQgb2Ygc3RhdHMpIHtcbiAgICAgIHRvdGFsU2VudCArPSBzdGF0LnRvdGFsU2VudDtcbiAgICAgIHRvdGFsUmVhZCArPSBzdGF0LnRvdGFsUmVhZDtcbiAgICAgIHRvdGFsQ2xpY2tlZCArPSBzdGF0LnRvdGFsQ2xpY2tlZDtcblxuICAgICAgdHlwZUVmZmVjdGl2ZW5lc3Nbc3RhdC5faWRdID0ge1xuICAgICAgICBzZW50OiBzdGF0LnRvdGFsU2VudCxcbiAgICAgICAgcmVhZDogc3RhdC50b3RhbFJlYWQsXG4gICAgICAgIGNsaWNrZWQ6IHN0YXQudG90YWxDbGlja2VkLFxuICAgICAgICByZWFkUmF0ZTpcbiAgICAgICAgICBzdGF0LnRvdGFsU2VudCA+IDAgPyAoc3RhdC50b3RhbFJlYWQgLyBzdGF0LnRvdGFsU2VudCkgKiAxMDAgOiAwLFxuICAgICAgICBjbGlja1JhdGU6XG4gICAgICAgICAgc3RhdC50b3RhbFNlbnQgPiAwID8gKHN0YXQudG90YWxDbGlja2VkIC8gc3RhdC50b3RhbFNlbnQpICogMTAwIDogMCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsU2VudCxcbiAgICAgIHRvdGFsUmVhZCxcbiAgICAgIHRvdGFsQ2xpY2tlZCxcbiAgICAgIHJlYWRSYXRlOiB0b3RhbFNlbnQgPiAwID8gKHRvdGFsUmVhZCAvIHRvdGFsU2VudCkgKiAxMDAgOiAwLFxuICAgICAgY2xpY2tSYXRlOiB0b3RhbFNlbnQgPiAwID8gKHRvdGFsQ2xpY2tlZCAvIHRvdGFsU2VudCkgKiAxMDAgOiAwLFxuICAgICAgdHlwZUVmZmVjdGl2ZW5lc3MsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnkIbpgY7mnJ/ntbHoqIjmlbjmk5pcbiAgICovXG4gIHN0YXRpYyBhc3luYyBjbGVhbnVwT2xkU3RhdHMoZGF5c1RvS2VlcDogbnVtYmVyID0gOTApOiBQcm9taXNlPHtcbiAgICBkZWxldGVkQ291bnQ6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IGN1dG9mZkRhdGUgPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gZGF5c1RvS2VlcCAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgTm90aWZpY2F0aW9uLmRlbGV0ZU1hbnkoe1xuICAgICAgY3JlYXRlZEF0OiB7ICRsdDogY3V0b2ZmRGF0ZSB9LFxuICAgICAgaXNSZWFkOiB0cnVlLCAvLyDlj6rliKrpmaTlt7LoroDnmoToiIrpgJrnn6VcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKFwi5riF55CG6YGO5pyf57Wx6KiI5pW45pOa5a6M5oiQXCIsIHtcbiAgICAgIGRlbGV0ZWRDb3VudDogcmVzdWx0LmRlbGV0ZWRDb3VudCxcbiAgICAgIGN1dG9mZkRhdGUsXG4gICAgICBkYXlzVG9LZWVwLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRlbGV0ZWRDb3VudDogcmVzdWx0LmRlbGV0ZWRDb3VudCB8fCAwLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==