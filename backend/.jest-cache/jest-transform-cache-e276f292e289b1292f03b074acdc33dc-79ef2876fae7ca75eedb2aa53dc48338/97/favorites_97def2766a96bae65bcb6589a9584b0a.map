{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\favorites.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\routes\\pets\\favorites.ts"],"sourcesContent":["import { Router } from \"express\";\nimport { asyncHandler } from \"../../middleware/error-handler\";\nimport { ValidationError, NotFoundError } from \"../../utils/errors\";\nimport { logger } from \"../../utils/logger\";\nimport {\n  createCacheMiddleware,\n  createCacheInvalidationMiddleware,\n  petCacheKeyGenerator,\n} from \"../../middleware/cacheMiddleware\";\nimport { validateQuery } from \"../../utils/validation\";\nimport { petSearchSchema } from \"../../schemas/search\";\nimport { Pet } from \"../../models/Pet\";\nimport { authenticate } from \"../../middleware/auth\";\nimport { requireActiveAccount } from \"../../middleware/rbac\";\nimport mongoose from \"mongoose\";\n\nconst router = Router();\n\n/**\n * @route   POST /api/pets/:id/favorite\n * @desc    收藏寵物\n * @access  Private\n */\nrouter.post(\n  \"/:id/favorite\",\n  authenticate,\n  requireActiveAccount,\n  createCacheInvalidationMiddleware({\n    patterns: [\"pets:*\"], // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n    const { id } = req.params;\n    const userId = req.user!.id;\n\n    if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n      throw new ValidationError(\"請提供有效的寵物 ID\");\n    }\n\n    logger.info(\"收藏寵物請求\", { petId: id, userId });\n\n    // 查找寵物\n    const pet = await Pet.findById(id);\n    if (!pet) {\n      throw new NotFoundError(\"找不到指定的寵物資訊\");\n    }\n\n    // 檢查是否已經收藏\n    const userObjectId = new mongoose.Types.ObjectId(userId);\n    const isAlreadyFavorited = pet.favoritedBy.some(\n      (favUserId) => favUserId.toString() === userId,\n    );\n\n    if (isAlreadyFavorited) {\n      return res.json({\n        success: true,\n        message: \"您已經收藏過這隻寵物了\",\n        data: {\n          isFavorited: true,\n          favoriteCount: pet.favoritedBy.length,\n        },\n      });\n    }\n\n    // 添加到收藏列表\n    await Pet.findByIdAndUpdate(\n      id,\n      { $addToSet: { favoritedBy: userObjectId } },\n      { new: true },\n    );\n\n    res.json({\n      success: true,\n      message: \"寵物已加入收藏\",\n      data: {\n        isFavorited: true,\n        favoriteCount: pet.favoritedBy.length + 1,\n      },\n    });\n  }),\n);\n\n/**\n * @route   DELETE /api/pets/:id/favorite\n * @desc    取消收藏寵物\n * @access  Private\n */\nrouter.delete(\n  \"/:id/favorite\",\n  authenticate,\n  requireActiveAccount,\n  createCacheInvalidationMiddleware({\n    patterns: [\"pets:*\"], // 清除所有寵物相關快取\n  }),\n  asyncHandler(async (req, res) => {\n    const { id } = req.params;\n    const userId = req.user!.id;\n\n    if (!id || !mongoose.Types.ObjectId.isValid(id)) {\n      throw new ValidationError(\"請提供有效的寵物 ID\");\n    }\n\n    logger.info(\"取消收藏寵物請求\", { petId: id, userId });\n\n    // 查找寵物\n    const pet = await Pet.findById(id);\n    if (!pet) {\n      throw new NotFoundError(\"找不到指定的寵物資訊\");\n    }\n\n    // 檢查是否已經收藏\n    const userObjectId = new mongoose.Types.ObjectId(userId);\n    const isAlreadyFavorited = pet.favoritedBy.some(\n      (favUserId) => favUserId.toString() === userId,\n    );\n\n    if (!isAlreadyFavorited) {\n      return res.json({\n        success: true,\n        message: \"您尚未收藏這隻寵物\",\n        data: {\n          isFavorited: false,\n          favoriteCount: pet.favoritedBy.length,\n        },\n      });\n    }\n\n    // 從收藏列表移除\n    await Pet.findByIdAndUpdate(\n      id,\n      { $pull: { favoritedBy: userObjectId } },\n      { new: true },\n    );\n\n    res.json({\n      success: true,\n      message: \"已取消收藏\",\n      data: {\n        isFavorited: false,\n        favoriteCount: Math.max(0, pet.favoritedBy.length - 1),\n      },\n    });\n  }),\n);\n\n/**\n * @route   GET /api/pets/favorites\n * @desc    獲取用戶收藏的寵物列表\n * @access  Private\n */\nrouter.get(\n  \"/favorites\",\n  authenticate,\n  requireActiveAccount,\n  validateQuery(petSearchSchema),\n  createCacheMiddleware({\n    ttl: 5 * 60 * 1000, // 5分鐘快取\n    keyGenerator: petCacheKeyGenerator,\n  }),\n  asyncHandler(async (req, res) => {\n    const userId = req.user!.id;\n    const {\n      page = 1,\n      limit = 12,\n      status,\n      type,\n      sortBy = \"createdAt\",\n      sortOrder = \"desc\",\n    } = req.validatedQuery;\n\n    logger.info(\"獲取用戶收藏寵物列表請求\", {\n      userId,\n      page,\n      limit,\n      status,\n      type,\n      sortBy,\n      sortOrder,\n    });\n\n    // 建立查詢條件\n    const query: any = {\n      favoritedBy: new mongoose.Types.ObjectId(userId),\n    };\n\n    if (status) {\n      query.status = status;\n    }\n\n    if (type) {\n      query.type = type;\n    }\n\n    // 計算分頁\n    const skip = (page - 1) * limit;\n\n    // 排序設定\n    const sortOptions: any = {};\n    sortOptions[sortBy] = sortOrder === \"desc\" ? -1 : 1;\n\n    // 執行查詢\n    const [pets, totalItems] = await Promise.all([\n      Pet.find(query)\n        .sort(sortOptions)\n        .skip(skip)\n        .limit(limit)\n        .populate(\"userId\", \"name email\")\n        .lean(),\n      Pet.countDocuments(query),\n    ]);\n\n    // 計算分頁資訊\n    const totalPages = Math.ceil(totalItems / limit);\n\n    res.json({\n      success: true,\n      data: {\n        pets,\n        pagination: {\n          currentPage: page,\n          totalPages,\n          totalItems,\n          itemsPerPage: limit,\n          hasNextPage: page < totalPages,\n          hasPrevPage: page > 1,\n        },\n      },\n    });\n  }),\n);\n\nexport default router;\n"],"version":3}