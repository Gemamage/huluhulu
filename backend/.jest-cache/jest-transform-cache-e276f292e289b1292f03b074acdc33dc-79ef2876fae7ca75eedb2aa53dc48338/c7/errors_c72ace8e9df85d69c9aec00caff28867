e3ba054f8e26a6fd201ea4d70e4475d4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.formatErrorForLogging = exports.formatErrorResponse = exports.isOperationalError = exports.ErrorFactory = exports.DatabaseError = exports.ExternalServiceError = exports.BusinessRuleError = exports.ServiceUnavailableError = exports.InternalServerError = exports.RateLimitError = exports.ConflictError = exports.NotFoundError = exports.ForbiddenError = exports.AuthorizationError = exports.AuthenticationError = exports.ValidationError = exports.AppError = exports.ErrorCode = void 0;
/**
 * 錯誤代碼枚舉
 */
var ErrorCode;
(function (ErrorCode) {
    // 通用錯誤
    ErrorCode["INTERNAL_SERVER_ERROR"] = "INTERNAL_SERVER_ERROR";
    ErrorCode["SERVICE_UNAVAILABLE"] = "SERVICE_UNAVAILABLE";
    // 驗證錯誤
    ErrorCode["VALIDATION_ERROR"] = "VALIDATION_ERROR";
    ErrorCode["INVALID_INPUT"] = "INVALID_INPUT";
    ErrorCode["MISSING_REQUIRED_FIELD"] = "MISSING_REQUIRED_FIELD";
    // 認證錯誤
    ErrorCode["AUTHENTICATION_FAILED"] = "AUTHENTICATION_FAILED";
    ErrorCode["INVALID_TOKEN"] = "INVALID_TOKEN";
    ErrorCode["TOKEN_EXPIRED"] = "TOKEN_EXPIRED";
    ErrorCode["INVALID_CREDENTIALS"] = "INVALID_CREDENTIALS";
    // 授權錯誤
    ErrorCode["INSUFFICIENT_PERMISSIONS"] = "INSUFFICIENT_PERMISSIONS";
    ErrorCode["ACCESS_DENIED"] = "ACCESS_DENIED";
    // 資源錯誤
    ErrorCode["RESOURCE_NOT_FOUND"] = "RESOURCE_NOT_FOUND";
    ErrorCode["RESOURCE_ALREADY_EXISTS"] = "RESOURCE_ALREADY_EXISTS";
    ErrorCode["RESOURCE_CONFLICT"] = "RESOURCE_CONFLICT";
    // 業務邏輯錯誤
    ErrorCode["BUSINESS_RULE_VIOLATION"] = "BUSINESS_RULE_VIOLATION";
    ErrorCode["OPERATION_NOT_ALLOWED"] = "OPERATION_NOT_ALLOWED";
    // 外部服務錯誤
    ErrorCode["EXTERNAL_SERVICE_ERROR"] = "EXTERNAL_SERVICE_ERROR";
    ErrorCode["DATABASE_ERROR"] = "DATABASE_ERROR";
    // 速率限制
    ErrorCode["RATE_LIMIT_EXCEEDED"] = "RATE_LIMIT_EXCEEDED";
})(ErrorCode || (exports.ErrorCode = ErrorCode = {}));
/**
 * 自定義錯誤類別
 */
class AppError extends Error {
    constructor(message, statusCode = 500, errorCode = ErrorCode.INTERNAL_SERVER_ERROR, details, isOperational = true) {
        super(message);
        this.statusCode = statusCode;
        this.errorCode = errorCode;
        this.details = details;
        this.isOperational = isOperational;
        this.timestamp = new Date().toISOString();
        // 確保錯誤堆疊追蹤正確
        Error.captureStackTrace(this, this.constructor);
    }
    /**
     * 轉換為 JSON 格式
     */
    toJSON() {
        return {
            message: this.message,
            statusCode: this.statusCode,
            errorCode: this.errorCode,
            details: this.details,
            timestamp: this.timestamp,
            isOperational: this.isOperational,
        };
    }
}
exports.AppError = AppError;
/**
 * 驗證錯誤
 */
class ValidationError extends AppError {
    constructor(message = '輸入資料驗證失敗', details) {
        super(message, 400, ErrorCode.VALIDATION_ERROR, details);
    }
}
exports.ValidationError = ValidationError;
/**
 * 認證錯誤
 */
class AuthenticationError extends AppError {
    constructor(message = '認證失敗', errorCode = ErrorCode.AUTHENTICATION_FAILED) {
        super(message, 401, errorCode);
    }
}
exports.AuthenticationError = AuthenticationError;
/**
 * 授權錯誤
 */
class AuthorizationError extends AppError {
    constructor(message = '權限不足', errorCode = ErrorCode.INSUFFICIENT_PERMISSIONS) {
        super(message, 403, errorCode);
    }
}
exports.AuthorizationError = AuthorizationError;
/**
 * 禁止訪問錯誤（AuthorizationError 的別名）
 */
class ForbiddenError extends AuthorizationError {
    constructor(message = '禁止訪問') {
        super(message, ErrorCode.ACCESS_DENIED);
    }
}
exports.ForbiddenError = ForbiddenError;
/**
 * 資源未找到錯誤
 */
class NotFoundError extends AppError {
    constructor(message = '資源未找到', details) {
        super(message, 404, ErrorCode.RESOURCE_NOT_FOUND, details);
    }
}
exports.NotFoundError = NotFoundError;
/**
 * 衝突錯誤
 */
class ConflictError extends AppError {
    constructor(message = '資源衝突', details) {
        super(message, 409, ErrorCode.RESOURCE_CONFLICT, details);
    }
}
exports.ConflictError = ConflictError;
/**
 * 速率限制錯誤
 */
class RateLimitError extends AppError {
    constructor(message = '請求過於頻繁', details) {
        super(message, 429, ErrorCode.RATE_LIMIT_EXCEEDED, details);
    }
}
exports.RateLimitError = RateLimitError;
/**
 * 內部伺服器錯誤
 */
class InternalServerError extends AppError {
    constructor(message = '內部伺服器錯誤', details) {
        super(message, 500, ErrorCode.INTERNAL_SERVER_ERROR, details, false);
    }
}
exports.InternalServerError = InternalServerError;
/**
 * 服務不可用錯誤
 */
class ServiceUnavailableError extends AppError {
    constructor(message = '服務暫時不可用', details) {
        super(message, 503, ErrorCode.SERVICE_UNAVAILABLE, details, false);
    }
}
exports.ServiceUnavailableError = ServiceUnavailableError;
/**
 * 業務邏輯錯誤
 */
class BusinessRuleError extends AppError {
    constructor(message, details) {
        super(message, 400, ErrorCode.BUSINESS_RULE_VIOLATION, details);
    }
}
exports.BusinessRuleError = BusinessRuleError;
/**
 * 外部服務錯誤
 */
class ExternalServiceError extends AppError {
    constructor(message = '外部服務錯誤', details) {
        super(message, 502, ErrorCode.EXTERNAL_SERVICE_ERROR, details, false);
    }
}
exports.ExternalServiceError = ExternalServiceError;
/**
 * 資料庫錯誤
 */
class DatabaseError extends AppError {
    constructor(message = '資料庫操作失敗', details) {
        super(message, 500, ErrorCode.DATABASE_ERROR, details, false);
    }
}
exports.DatabaseError = DatabaseError;
/**
 * 錯誤工廠函數
 */
class ErrorFactory {
    /**
     * 創建驗證錯誤
     */
    static createValidationError(message = '輸入資料驗證失敗', field, value, constraint) {
        const details = [];
        if (field) {
            details.push({ field, value, constraint });
        }
        return new ValidationError(message, details);
    }
    /**
     * 創建認證錯誤
     */
    static createAuthenticationError(type = 'invalid_credentials') {
        const messages = {
            invalid_credentials: '用戶名或密碼錯誤',
            invalid_token: '無效的認證令牌',
            token_expired: '認證令牌已過期',
        };
        const errorCodes = {
            invalid_credentials: ErrorCode.INVALID_CREDENTIALS,
            invalid_token: ErrorCode.INVALID_TOKEN,
            token_expired: ErrorCode.TOKEN_EXPIRED,
        };
        return new AuthenticationError(messages[type], errorCodes[type]);
    }
    /**
     * 創建資源未找到錯誤
     */
    static createNotFoundError(resource, identifier) {
        const message = identifier
            ? `${resource} (${identifier}) 未找到`
            : `${resource} 未找到`;
        const details = [{
                resource,
                identifier,
            }];
        return new NotFoundError(message, details);
    }
    /**
     * 創建衝突錯誤
     */
    static createConflictError(resource, field, value) {
        const message = `${resource} 的 ${field} 已存在`;
        const details = [{
                resource,
                field,
                value,
                constraint: 'unique',
            }];
        return new ConflictError(message, details);
    }
    /**
     * 創建速率限制錯誤
     */
    static createRateLimitError(message = '請求過於頻繁，請稍後再試', details) {
        return new RateLimitError(message, details);
    }
    /**
     * 從 Mongoose 錯誤創建 AppError
     */
    static fromMongooseError(error) {
        if (error.name === 'ValidationError') {
            const details = Object.values(error.errors).map((err) => ({
                field: err.path,
                value: err.value,
                constraint: err.kind,
                message: err.message,
            }));
            return new ValidationError('資料驗證失敗', details);
        }
        if (error.name === 'MongoServerError' && error.code === 11000) {
            const field = Object.keys(error.keyValue)[0];
            const value = error.keyValue[field];
            return ErrorFactory.createConflictError('資源', field, value);
        }
        if (error.name === 'CastError') {
            const details = [{
                    field: error.path,
                    value: error.value,
                    constraint: 'type',
                    message: '無效的資料格式',
                }];
            return new ValidationError('無效的資料格式', details);
        }
        return new DatabaseError(error.message);
    }
    /**
     * 從 Zod 錯誤創建 ValidationError
     */
    static fromZodError(error) {
        const details = error.errors.map((err) => ({
            field: err.path.join('.'),
            value: err.received,
            constraint: err.code,
            message: err.message,
        }));
        return new ValidationError('輸入資料驗證失敗', details);
    }
}
exports.ErrorFactory = ErrorFactory;
/**
 * 檢查錯誤是否為操作性錯誤
 */
const isOperationalError = (error) => {
    if (error instanceof AppError) {
        return error.isOperational;
    }
    return false;
};
exports.isOperationalError = isOperationalError;
/**
 * 格式化錯誤響應
 */
const formatErrorResponse = (error, includeStack = false) => {
    const response = {
        success: false,
        error: {
            message: error.message,
            code: error.errorCode,
            statusCode: error.statusCode,
            timestamp: error.timestamp,
        },
    };
    if (error.details && error.details.length > 0) {
        response.error.details = error.details;
    }
    if (includeStack && error.stack) {
        response.error.stack = error.stack;
    }
    return response;
};
exports.formatErrorResponse = formatErrorResponse;
/**
 * 錯誤日誌格式化
 */
const formatErrorForLogging = (error, context) => {
    const logData = {
        message: error.message,
        name: error.name,
        stack: error.stack,
    };
    if (error instanceof AppError) {
        logData.errorCode = error.errorCode;
        logData.statusCode = error.statusCode;
        logData.isOperational = error.isOperational;
        logData.details = error.details;
    }
    if (context) {
        logData.context = context;
    }
    return logData;
};
exports.formatErrorForLogging = formatErrorForLogging;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHV0aWxzXFxlcnJvcnMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUE7O0dBRUc7QUFDSCxJQUFZLFNBbUNYO0FBbkNELFdBQVksU0FBUztJQUNuQixPQUFPO0lBQ1AsNERBQStDLENBQUE7SUFDL0Msd0RBQTJDLENBQUE7SUFFM0MsT0FBTztJQUNQLGtEQUFxQyxDQUFBO0lBQ3JDLDRDQUErQixDQUFBO0lBQy9CLDhEQUFpRCxDQUFBO0lBRWpELE9BQU87SUFDUCw0REFBK0MsQ0FBQTtJQUMvQyw0Q0FBK0IsQ0FBQTtJQUMvQiw0Q0FBK0IsQ0FBQTtJQUMvQix3REFBMkMsQ0FBQTtJQUUzQyxPQUFPO0lBQ1Asa0VBQXFELENBQUE7SUFDckQsNENBQStCLENBQUE7SUFFL0IsT0FBTztJQUNQLHNEQUF5QyxDQUFBO0lBQ3pDLGdFQUFtRCxDQUFBO0lBQ25ELG9EQUF1QyxDQUFBO0lBRXZDLFNBQVM7SUFDVCxnRUFBbUQsQ0FBQTtJQUNuRCw0REFBK0MsQ0FBQTtJQUUvQyxTQUFTO0lBQ1QsOERBQWlELENBQUE7SUFDakQsOENBQWlDLENBQUE7SUFFakMsT0FBTztJQUNQLHdEQUEyQyxDQUFBO0FBQzdDLENBQUMsRUFuQ1csU0FBUyx5QkFBVCxTQUFTLFFBbUNwQjtBQWFEOztHQUVHO0FBQ0gsTUFBYSxRQUFTLFNBQVEsS0FBSztJQU9qQyxZQUNFLE9BQWUsRUFDZixhQUFxQixHQUFHLEVBQ3hCLFlBQXVCLFNBQVMsQ0FBQyxxQkFBcUIsRUFDdEQsT0FBd0IsRUFDeEIsZ0JBQXlCLElBQUk7UUFFN0IsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWYsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxD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QUFVLENBQUM7UUFDdEMsT0FBTyxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQzVDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztJQUNsQyxDQUFDO0lBRUQsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUNaLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQzVCLENBQUM7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDLENBQUM7QUF0QlcsUUFBQSxxQkFBcUIseUJBc0JoQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERlc2t0b3BcXHRyYWVwcm9qZWN0XFx0ZXN0MlxccGV0LWZpbmRlci1hcHBcXGJhY2tlbmRcXHNyY1xcdXRpbHNcXGVycm9ycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIOmMr+iqpOS7o+eivOaemuiIiVxuICovXG5leHBvcnQgZW51bSBFcnJvckNvZGUge1xuICAvLyDpgJrnlKjpjK/oqqRcbiAgSU5URVJOQUxfU0VSVkVSX0VSUk9SID0gJ0lOVEVSTkFMX1NFUlZFUl9FUlJPUicsXG4gIFNFUlZJQ0VfVU5BVkFJTEFCTEUgPSAnU0VSVklDRV9VTkFWQUlMQUJMRScsXG4gIFxuICAvLyDpqZforYnpjK/oqqRcbiAgVkFMSURBVElPTl9FUlJPUiA9ICdWQUxJREFUSU9OX0VSUk9SJyxcbiAgSU5WQUxJRF9JTlBVVCA9ICdJTlZBTElEX0lOUFVUJyxcbiAgTUlTU0lOR19SRVFVSVJFRF9GSUVMRCA9ICdNSVNTSU5HX1JFUVVJUkVEX0ZJRUxEJyxcbiAgXG4gIC8vIOiqjeitiemMr+iqpFxuICBBVVRIRU5USUNBVElPTl9GQUlMRUQgPSAnQVVUSEVOVElDQVRJT05fRkFJTEVEJyxcbiAgSU5WQUxJRF9UT0tFTiA9ICdJTlZBTElEX1RPS0VOJyxcbiAgVE9LRU5fRVhQSVJFRCA9ICdUT0tFTl9FWFBJUkVEJyxcbiAgSU5WQUxJRF9DUkVERU5USUFMUyA9ICdJTlZBTElEX0NSRURFTlRJQUxTJyxcbiAgXG4gIC8vIOaOiOasiumMr+iqpFxuICBJTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlMgPSAnSU5TVUZGSUNJRU5UX1BFUk1JU1NJT05TJyxcbiAgQUNDRVNTX0RFTklFRCA9ICdBQ0NFU1NfREVOSUVEJyxcbiAgXG4gIC8vIOizh+a6kOmMr+iqpFxuICBSRVNPVVJDRV9OT1RfRk9VTkQgPSAnUkVTT1VSQ0VfTk9UX0ZPVU5EJyxcbiAgUkVTT1VSQ0VfQUxSRUFEWV9FWElTVFMgPSAnUkVTT1VSQ0VfQUxSRUFEWV9FWElTVFMnLFxuICBSRVNPVVJDRV9DT05GTElDVCA9ICdSRVNPVVJDRV9DT05GTElDVCcsXG4gIFxuICAvLyDmpa3li5npgo/ovK/pjK/oqqRcbiAgQlVTSU5FU1NfUlVMRV9WSU9MQVRJT04gPSAnQlVTSU5FU1NfUlVMRV9WSU9MQVRJT04nLFxuICBPUEVSQVRJT05fTk9UX0FMTE9XRUQgPSAnT1BFUkFUSU9OX05PVF9BTExPV0VEJyxcbiAgXG4gIC8vIOWklumDqOacjeWLmemMr+iqpFxuICBFWFRFUk5BTF9TRVJWSUNFX0VSUk9SID0gJ0VYVEVSTkFMX1NFUlZJQ0VfRVJST1InLFxuICBEQVRBQkFTRV9FUlJPUiA9ICdEQVRBQkFTRV9FUlJPUicsXG4gIFxuICAvLyDpgJ/njofpmZDliLZcbiAgUkFURV9MSU1JVF9FWENFRURFRCA9ICdSQVRFX0xJTUlUX0VYQ0VFREVEJyxcbn1cblxuLyoqXG4gKiDpjK/oqqToqbPmg4Xku4vpnaJcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFcnJvckRldGFpbHMge1xuICBmaWVsZD86IHN0cmluZztcbiAgdmFsdWU/OiBhbnk7XG4gIGNvbnN0cmFpbnQ/OiBzdHJpbmc7XG4gIGNvZGU/OiBzdHJpbmc7XG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn1cblxuLyoqXG4gKiDoh6rlrprnvqnpjK/oqqTpoZ7liKVcbiAqL1xuZXhwb3J0IGNsYXNzIEFwcEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhdHVzQ29kZTogbnVtYmVyO1xuICBwdWJsaWMgcmVhZG9ubHkgaXNPcGVyYXRpb25hbDogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IGVycm9yQ29kZTogRXJyb3JDb2RlO1xuICBwdWJsaWMgcmVhZG9ubHkgZGV0YWlscz86IEVycm9yRGV0YWlsc1tdO1xuICBwdWJsaWMgcmVhZG9ubHkgdGltZXN0YW1wOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICAgIHN0YXR1c0NvZGU6IG51bWJlciA9IDUwMCxcbiAgICBlcnJvckNvZGU6IEVycm9yQ29kZSA9IEVycm9yQ29kZS5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgZGV0YWlscz86IEVycm9yRGV0YWlsc1tdLFxuICAgIGlzT3BlcmF0aW9uYWw6IGJvb2xlYW4gPSB0cnVlXG4gICkge1xuICAgIHN1cGVyKG1lc3NhZ2UpO1xuICAgIFxuICAgIHRoaXMuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7XG4gICAgdGhpcy5lcnJvckNvZGUgPSBlcnJvckNvZGU7XG4gICAgdGhpcy5kZXRhaWxzID0gZGV0YWlscztcbiAgICB0aGlzLmlzT3BlcmF0aW9uYWwgPSBpc09wZXJhdGlvbmFsO1xuICAgIHRoaXMudGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIFxuICAgIC8vIOeiuuS/nemMr+iqpOWghueWiui/vei5pOato+eiulxuICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIHRoaXMuY29uc3RydWN0b3IpO1xuICB9XG5cbiAgLyoqXG4gICAqIOi9ieaPm+eCuiBKU09OIOagvOW8j1xuICAgKi9cbiAgdG9KU09OKCkge1xuICAgIHJldHVybiB7XG4gICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsXG4gICAgICBzdGF0dXNDb2RlOiB0aGlzLnN0YXR1c0NvZGUsXG4gICAgICBlcnJvckNvZGU6IHRoaXMuZXJyb3JDb2RlLFxuICAgICAgZGV0YWlsczogdGhpcy5kZXRhaWxzLFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcCxcbiAgICAgIGlzT3BlcmF0aW9uYWw6IHRoaXMuaXNPcGVyYXRpb25hbCxcbiAgICB9O1xuICB9XG59XG5cbi8qKlxuICog6amX6K2J6Yyv6KqkXG4gKi9cbmV4cG9ydCBjbGFzcyBWYWxpZGF0aW9uRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICfovLjlhaXos4fmlpnpqZforYnlpLHmlZcnLFxuICAgIGRldGFpbHM/OiBFcnJvckRldGFpbHNbXVxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlLCA0MDAsIEVycm9yQ29kZS5WQUxJREFUSU9OX0VSUk9SLCBkZXRhaWxzKTtcbiAgfVxufVxuXG4vKipcbiAqIOiqjeitiemMr+iqpFxuICovXG5leHBvcnQgY2xhc3MgQXV0aGVudGljYXRpb25FcnJvciBleHRlbmRzIEFwcEVycm9yIHtcbiAgY29uc3RydWN0b3IoXG4gICAgbWVzc2FnZTogc3RyaW5nID0gJ+iqjeitieWkseaVlycsXG4gICAgZXJyb3JDb2RlOiBFcnJvckNvZGUgPSBFcnJvckNvZGUuQVVUSEVOVElDQVRJT05fRkFJTEVEXG4gICkge1xuICAgIHN1cGVyKG1lc3NhZ2UsIDQwMSwgZXJyb3JDb2RlKTtcbiAgfVxufVxuXG4vKipcbiAqIOaOiOasiumMr+iqpFxuICovXG5leHBvcnQgY2xhc3MgQXV0aG9yaXphdGlvbkVycm9yIGV4dGVuZHMgQXBwRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihcbiAgICBtZXNzYWdlOiBzdHJpbmcgPSAn5qyK6ZmQ5LiN6LazJyxcbiAgICBlcnJvckNvZGU6IEVycm9yQ29kZSA9IEVycm9yQ29kZS5JTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlNcbiAgKSB7XG4gICAgc3VwZXIobWVzc2FnZSwgNDAzLCBlcnJvckNvZGUpO1xuICB9XG59XG5cbi8qKlxuICog56aB5q2i6Kiq5ZWP6Yyv6Kqk77yIQXV0aG9yaXphdGlvbkVycm9yIOeahOWIpeWQje+8iVxuICovXG5leHBvcnQgY2xhc3MgRm9yYmlkZGVuRXJyb3IgZXh0ZW5kcyBBdXRob3JpemF0aW9uRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcgPSAn56aB5q2i6Kiq5ZWPJykge1xuICAgIHN1cGVyKG1lc3NhZ2UsIEVycm9yQ29kZS5BQ0NFU1NfREVOSUVEKTtcbiAgfVxufVxuXG4vKipcbiAqIOizh+a6kOacquaJvuWIsOmMr+iqpFxuICovXG5leHBvcnQgY2xhc3MgTm90Rm91bmRFcnJvciBleHRlbmRzIEFwcEVycm9yIHtcbiAgY29uc3RydWN0b3IoXG4gICAgbWVzc2FnZTogc3RyaW5nID0gJ+izh+a6kOacquaJvuWIsCcsXG4gICAgZGV0YWlscz86IEVycm9yRGV0YWlsc1tdXG4gICkge1xuICAgIHN1cGVyKG1lc3NhZ2UsIDQwNCwgRXJyb3JDb2RlLlJFU09VUkNFX05PVF9GT1VORCwgZGV0YWlscyk7XG4gIH1cbn1cblxuLyoqXG4gKiDooZ3nqoHpjK/oqqRcbiAqL1xuZXhwb3J0IGNsYXNzIENvbmZsaWN0RXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICfos4fmupDooZ3nqoEnLFxuICAgIGRldGFpbHM/OiBFcnJvckRldGFpbHNbXVxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlLCA0MDksIEVycm9yQ29kZS5SRVNPVVJDRV9DT05GTElDVCwgZGV0YWlscyk7XG4gIH1cbn1cblxuLyoqXG4gKiDpgJ/njofpmZDliLbpjK/oqqRcbiAqL1xuZXhwb3J0IGNsYXNzIFJhdGVMaW1pdEVycm9yIGV4dGVuZHMgQXBwRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihcbiAgICBtZXNzYWdlOiBzdHJpbmcgPSAn6KuL5rGC6YGO5pa86aC757mBJyxcbiAgICBkZXRhaWxzPzogRXJyb3JEZXRhaWxzW11cbiAgKSB7XG4gICAgc3VwZXIobWVzc2FnZSwgNDI5LCBFcnJvckNvZGUuUkFURV9MSU1JVF9FWENFRURFRCwgZGV0YWlscyk7XG4gIH1cbn1cblxuLyoqXG4gKiDlhafpg6jkvLrmnI3lmajpjK/oqqRcbiAqL1xuZXhwb3J0IGNsYXNzIEludGVybmFsU2VydmVyRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICflhafpg6jkvLrmnI3lmajpjK/oqqQnLFxuICAgIGRldGFpbHM/OiBFcnJvckRldGFpbHNbXVxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlLCA1MDAsIEVycm9yQ29kZS5JTlRFUk5BTF9TRVJWRVJfRVJST1IsIGRldGFpbHMsIGZhbHNlKTtcbiAgfVxufVxuXG4vKipcbiAqIOacjeWLmeS4jeWPr+eUqOmMr+iqpFxuICovXG5leHBvcnQgY2xhc3MgU2VydmljZVVuYXZhaWxhYmxlRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICfmnI3li5nmmqvmmYLkuI3lj6/nlKgnLFxuICAgIGRldGFpbHM/OiBFcnJvckRldGFpbHNbXVxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlLCA1MDMsIEVycm9yQ29kZS5TRVJWSUNFX1VOQVZBSUxBQkxFLCBkZXRhaWxzLCBmYWxzZSk7XG4gIH1cbn1cblxuLyoqXG4gKiDmpa3li5npgo/ovK/pjK/oqqRcbiAqL1xuZXhwb3J0IGNsYXNzIEJ1c2luZXNzUnVsZUVycm9yIGV4dGVuZHMgQXBwRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgZGV0YWlscz86IEVycm9yRGV0YWlsc1tdXG4gICkge1xuICAgIHN1cGVyKG1lc3NhZ2UsIDQwMCwgRXJyb3JDb2RlLkJVU0lORVNTX1JVTEVfVklPTEFUSU9OLCBkZXRhaWxzKTtcbiAgfVxufVxuXG4vKipcbiAqIOWklumDqOacjeWLmemMr+iqpFxuICovXG5leHBvcnQgY2xhc3MgRXh0ZXJuYWxTZXJ2aWNlRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICflpJbpg6jmnI3li5npjK/oqqQnLFxuICAgIGRldGFpbHM/OiBFcnJvckRldGFpbHNbXVxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlLCA1MDIsIEVycm9yQ29kZS5FWFRFUk5BTF9TRVJWSUNFX0VSUk9SLCBkZXRhaWxzLCBmYWxzZSk7XG4gIH1cbn1cblxuLyoqXG4gKiDos4fmlpnluqvpjK/oqqRcbiAqL1xuZXhwb3J0IGNsYXNzIERhdGFiYXNlRXJyb3IgZXh0ZW5kcyBBcHBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICfos4fmlpnluqvmk43kvZzlpLHmlZcnLFxuICAgIGRldGFpbHM/OiBFcnJvckRldGFpbHNbXVxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlLCA1MDAsIEVycm9yQ29kZS5EQVRBQkFTRV9FUlJPUiwgZGV0YWlscywgZmFsc2UpO1xuICB9XG59XG5cbi8qKlxuICog6Yyv6Kqk5bel5bug5Ye95pW4XG4gKi9cbmV4cG9ydCBjbGFzcyBFcnJvckZhY3Rvcnkge1xuICAvKipcbiAgICog5Ym15bu66amX6K2J6Yyv6KqkXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlVmFsaWRhdGlvbkVycm9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICfovLjlhaXos4fmlpnpqZforYnlpLHmlZcnLFxuICAgIGZpZWxkPzogc3RyaW5nLFxuICAgIHZhbHVlPzogYW55LFxuICAgIGNvbnN0cmFpbnQ/OiBzdHJpbmdcbiAgKTogVmFsaWRhdGlvbkVycm9yIHtcbiAgICBjb25zdCBkZXRhaWxzOiBFcnJvckRldGFpbHNbXSA9IFtdO1xuICAgIGlmIChmaWVsZCkge1xuICAgICAgZGV0YWlscy5wdXNoKHsgZmllbGQsIHZhbHVlLCBjb25zdHJhaW50IH0pO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFZhbGlkYXRpb25FcnJvcihtZXNzYWdlLCBkZXRhaWxzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlibXlu7roqo3orYnpjK/oqqRcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVBdXRoZW50aWNhdGlvbkVycm9yKFxuICAgIHR5cGU6ICdpbnZhbGlkX2NyZWRlbnRpYWxzJyB8ICdpbnZhbGlkX3Rva2VuJyB8ICd0b2tlbl9leHBpcmVkJyA9ICdpbnZhbGlkX2NyZWRlbnRpYWxzJ1xuICApOiBBdXRoZW50aWNhdGlvbkVycm9yIHtcbiAgICBjb25zdCBtZXNzYWdlcyA9IHtcbiAgICAgIGludmFsaWRfY3JlZGVudGlhbHM6ICfnlKjmiLblkI3miJblr4bnorzpjK/oqqQnLFxuICAgICAgaW52YWxpZF90b2tlbjogJ+eEoeaViOeahOiqjeitieS7pOeJjCcsXG4gICAgICB0b2tlbl9leHBpcmVkOiAn6KqN6K2J5Luk54mM5bey6YGO5pyfJyxcbiAgICB9O1xuICAgIFxuICAgIGNvbnN0IGVycm9yQ29kZXMgPSB7XG4gICAgICBpbnZhbGlkX2NyZWRlbnRpYWxzOiBFcnJvckNvZGUuSU5WQUxJRF9DUkVERU5USUFMUyxcbiAgICAgIGludmFsaWRfdG9rZW46IEVycm9yQ29kZS5JTlZBTElEX1RPS0VOLFxuICAgICAgdG9rZW5fZXhwaXJlZDogRXJyb3JDb2RlLlRPS0VOX0VYUElSRUQsXG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgQXV0aGVudGljYXRpb25FcnJvcihtZXNzYWdlc1t0eXBlXSwgZXJyb3JDb2Rlc1t0eXBlXSk7XG4gIH1cblxuICAvKipcbiAgICog5Ym15bu66LOH5rqQ5pyq5om+5Yiw6Yyv6KqkXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlTm90Rm91bmRFcnJvcihcbiAgICByZXNvdXJjZTogc3RyaW5nLFxuICAgIGlkZW50aWZpZXI/OiBzdHJpbmcgfCBudW1iZXJcbiAgKTogTm90Rm91bmRFcnJvciB7XG4gICAgY29uc3QgbWVzc2FnZSA9IGlkZW50aWZpZXIgXG4gICAgICA/IGAke3Jlc291cmNlfSAoJHtpZGVudGlmaWVyfSkg5pyq5om+5YiwYFxuICAgICAgOiBgJHtyZXNvdXJjZX0g5pyq5om+5YiwYDtcbiAgICBcbiAgICBjb25zdCBkZXRhaWxzOiBFcnJvckRldGFpbHNbXSA9IFt7XG4gICAgICByZXNvdXJjZSxcbiAgICAgIGlkZW50aWZpZXIsXG4gICAgfV07XG5cbiAgICByZXR1cm4gbmV3IE5vdEZvdW5kRXJyb3IobWVzc2FnZSwgZGV0YWlscyk7XG4gIH1cblxuICAvKipcbiAgICog5Ym15bu66KGd56qB6Yyv6KqkXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlQ29uZmxpY3RFcnJvcihcbiAgICByZXNvdXJjZTogc3RyaW5nLFxuICAgIGZpZWxkOiBzdHJpbmcsXG4gICAgdmFsdWU6IGFueVxuICApOiBDb25mbGljdEVycm9yIHtcbiAgICBjb25zdCBtZXNzYWdlID0gYCR7cmVzb3VyY2V9IOeahCAke2ZpZWxkfSDlt7LlrZjlnKhgO1xuICAgIGNvbnN0IGRldGFpbHM6IEVycm9yRGV0YWlsc1tdID0gW3tcbiAgICAgIHJlc291cmNlLFxuICAgICAgZmllbGQsXG4gICAgICB2YWx1ZSxcbiAgICAgIGNvbnN0cmFpbnQ6ICd1bmlxdWUnLFxuICAgIH1dO1xuXG4gICAgcmV0dXJuIG5ldyBDb25mbGljdEVycm9yKG1lc3NhZ2UsIGRldGFpbHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWJteW7uumAn+eOh+mZkOWItumMr+iqpFxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZVJhdGVMaW1pdEVycm9yKFxuICAgIG1lc3NhZ2U6IHN0cmluZyA9ICfoq4vmsYLpgY7mlrzpoLvnuYHvvIzoq4vnqI3lvozlho3oqaYnLFxuICAgIGRldGFpbHM/OiBFcnJvckRldGFpbHNbXVxuICApOiBSYXRlTGltaXRFcnJvciB7XG4gICAgcmV0dXJuIG5ldyBSYXRlTGltaXRFcnJvcihtZXNzYWdlLCBkZXRhaWxzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlvp4gTW9uZ29vc2Ug6Yyv6Kqk5Ym15bu6IEFwcEVycm9yXG4gICAqL1xuICBzdGF0aWMgZnJvbU1vbmdvb3NlRXJyb3IoZXJyb3I6IGFueSk6IEFwcEVycm9yIHtcbiAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ1ZhbGlkYXRpb25FcnJvcicpIHtcbiAgICAgIGNvbnN0IGRldGFpbHM6IEVycm9yRGV0YWlsc1tdID0gT2JqZWN0LnZhbHVlcyhlcnJvci5lcnJvcnMpLm1hcCgoZXJyOiBhbnkpID0+ICh7XG4gICAgICAgIGZpZWxkOiBlcnIucGF0aCxcbiAgICAgICAgdmFsdWU6IGVyci52YWx1ZSxcbiAgICAgICAgY29uc3RyYWludDogZXJyLmtpbmQsXG4gICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgfSkpO1xuICAgICAgcmV0dXJuIG5ldyBWYWxpZGF0aW9uRXJyb3IoJ+izh+aWmempl+itieWkseaVlycsIGRldGFpbHMpO1xuICAgIH1cblxuICAgIGlmIChlcnJvci5uYW1lID09PSAnTW9uZ29TZXJ2ZXJFcnJvcicgJiYgZXJyb3IuY29kZSA9PT0gMTEwMDApIHtcbiAgICAgIGNvbnN0IGZpZWxkID0gT2JqZWN0LmtleXMoZXJyb3Iua2V5VmFsdWUpWzBdO1xuICAgICAgY29uc3QgdmFsdWUgPSBlcnJvci5rZXlWYWx1ZVtmaWVsZF07XG4gICAgICByZXR1cm4gRXJyb3JGYWN0b3J5LmNyZWF0ZUNvbmZsaWN0RXJyb3IoJ+izh+a6kCcsIGZpZWxkLCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdDYXN0RXJyb3InKSB7XG4gICAgICBjb25zdCBkZXRhaWxzOiBFcnJvckRldGFpbHNbXSA9IFt7XG4gICAgICAgIGZpZWxkOiBlcnJvci5wYXRoLFxuICAgICAgICB2YWx1ZTogZXJyb3IudmFsdWUsXG4gICAgICAgIGNvbnN0cmFpbnQ6ICd0eXBlJyxcbiAgICAgICAgbWVzc2FnZTogJ+eEoeaViOeahOizh+aWmeagvOW8jycsXG4gICAgICB9XTtcbiAgICAgIHJldHVybiBuZXcgVmFsaWRhdGlvbkVycm9yKCfnhKHmlYjnmoTos4fmlpnmoLzlvI8nLCBkZXRhaWxzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IERhdGFiYXNlRXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gIH1cblxuICAvKipcbiAgICog5b6eIFpvZCDpjK/oqqTlibXlu7ogVmFsaWRhdGlvbkVycm9yXG4gICAqL1xuICBzdGF0aWMgZnJvbVpvZEVycm9yKGVycm9yOiBhbnkpOiBWYWxpZGF0aW9uRXJyb3Ige1xuICAgIGNvbnN0IGRldGFpbHM6IEVycm9yRGV0YWlsc1tdID0gZXJyb3IuZXJyb3JzLm1hcCgoZXJyOiBhbnkpID0+ICh7XG4gICAgICBmaWVsZDogZXJyLnBhdGguam9pbignLicpLFxuICAgICAgdmFsdWU6IGVyci5yZWNlaXZlZCxcbiAgICAgIGNvbnN0cmFpbnQ6IGVyci5jb2RlLFxuICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgfSkpO1xuICAgIHJldHVybiBuZXcgVmFsaWRhdGlvbkVycm9yKCfovLjlhaXos4fmlpnpqZforYnlpLHmlZcnLCBkZXRhaWxzKTtcbiAgfVxufVxuXG4vKipcbiAqIOaqouafpemMr+iqpOaYr+WQpueCuuaTjeS9nOaAp+mMr+iqpFxuICovXG5leHBvcnQgY29uc3QgaXNPcGVyYXRpb25hbEVycm9yID0gKGVycm9yOiBFcnJvcik6IGJvb2xlYW4gPT4ge1xuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBBcHBFcnJvcikge1xuICAgIHJldHVybiBlcnJvci5pc09wZXJhdGlvbmFsO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn07XG5cbi8qKlxuICog5qC85byP5YyW6Yyv6Kqk6Z+/5oeJXG4gKi9cbmV4cG9ydCBjb25zdCBmb3JtYXRFcnJvclJlc3BvbnNlID0gKFxuICBlcnJvcjogQXBwRXJyb3IsXG4gIGluY2x1ZGVTdGFjazogYm9vbGVhbiA9IGZhbHNlXG4pID0+IHtcbiAgY29uc3QgcmVzcG9uc2U6IGFueSA9IHtcbiAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICBlcnJvcjoge1xuICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgIGNvZGU6IGVycm9yLmVycm9yQ29kZSxcbiAgICAgIHN0YXR1c0NvZGU6IGVycm9yLnN0YXR1c0NvZGUsXG4gICAgICB0aW1lc3RhbXA6IGVycm9yLnRpbWVzdGFtcCxcbiAgICB9LFxuICB9O1xuXG4gIGlmIChlcnJvci5kZXRhaWxzICYmIGVycm9yLmRldGFpbHMubGVuZ3RoID4gMCkge1xuICAgIHJlc3BvbnNlLmVycm9yLmRldGFpbHMgPSBlcnJvci5kZXRhaWxzO1xuICB9XG5cbiAgaWYgKGluY2x1ZGVTdGFjayAmJiBlcnJvci5zdGFjaykge1xuICAgIHJlc3BvbnNlLmVycm9yLnN0YWNrID0gZXJyb3Iuc3RhY2s7XG4gIH1cblxuICByZXR1cm4gcmVzcG9uc2U7XG59O1xuXG4vKipcbiAqIOmMr+iqpOaXpeiqjOagvOW8j+WMllxuICovXG5leHBvcnQgY29uc3QgZm9ybWF0RXJyb3JGb3JMb2dnaW5nID0gKFxuICBlcnJvcjogRXJyb3IsXG4gIGNvbnRleHQ/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4pID0+IHtcbiAgY29uc3QgbG9nRGF0YTogYW55ID0ge1xuICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgbmFtZTogZXJyb3IubmFtZSxcbiAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gIH07XG5cbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgQXBwRXJyb3IpIHtcbiAgICBsb2dEYXRhLmVycm9yQ29kZSA9IGVycm9yLmVycm9yQ29kZTtcbiAgICBsb2dEYXRhLnN0YXR1c0NvZGUgPSBlcnJvci5zdGF0dXNDb2RlO1xuICAgIGxvZ0RhdGEuaXNPcGVyYXRpb25hbCA9IGVycm9yLmlzT3BlcmF0aW9uYWw7XG4gICAgbG9nRGF0YS5kZXRhaWxzID0gZXJyb3IuZGV0YWlscztcbiAgfVxuXG4gIGlmIChjb250ZXh0KSB7XG4gICAgbG9nRGF0YS5jb250ZXh0ID0gY29udGV4dDtcbiAgfVxuXG4gIHJldHVybiBsb2dEYXRhO1xufTsiXSwidmVyc2lvbiI6M30=