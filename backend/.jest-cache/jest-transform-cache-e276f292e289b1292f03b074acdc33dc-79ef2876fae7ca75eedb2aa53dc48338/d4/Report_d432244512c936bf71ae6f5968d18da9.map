{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\models\\Report.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\models\\Report.ts"],"sourcesContent":["import mongoose, { Document, Schema } from 'mongoose';\n\n// 舉報介面定義\nexport interface IReport extends Document {\n  _id: mongoose.Types.ObjectId;\n  reporterId: mongoose.Types.ObjectId; // 舉報者\n  reportedUserId?: mongoose.Types.ObjectId; // 被舉報的用戶\n  reportedContentId?: mongoose.Types.ObjectId; // 被舉報的內容ID\n  contentType: 'user' | 'comment' | 'review' | 'message' | 'pet'; // 舉報內容類型\n  reportType: string; // 舉報類型\n  reason: string; // 舉報原因\n  description?: string; // 詳細描述\n  evidence?: string[]; // 證據圖片URLs\n  status: 'pending' | 'investigating' | 'resolved' | 'dismissed'; // 處理狀態\n  priority: 'low' | 'medium' | 'high' | 'urgent'; // 優先級\n  assignedTo?: mongoose.Types.ObjectId; // 分配給的管理員\n  resolution?: string; // 處理結果\n  resolvedAt?: Date;\n  resolvedBy?: mongoose.Types.ObjectId;\n  isDeleted: boolean;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\n// 舉報統計介面定義\nexport interface IReportStats extends Document {\n  _id: mongoose.Types.ObjectId;\n  userId?: mongoose.Types.ObjectId; // 被舉報用戶的統計\n  contentId?: mongoose.Types.ObjectId; // 被舉報內容的統計\n  contentType: string;\n  totalReports: number;\n  reportTypes: Array<{\n    type: string;\n    count: number;\n  }>;\n  statusDistribution: {\n    pending: number;\n    investigating: number;\n    resolved: number;\n    dismissed: number;\n  };\n  lastReportedAt: Date;\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n}\n\n// 舉報 Schema\nconst reportSchema = new Schema<IReport>({\n  reporterId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    required: [true, '舉報者ID為必填項目'],\n    index: true,\n  },\n  reportedUserId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    default: null,\n    index: true,\n  },\n  reportedContentId: {\n    type: Schema.Types.ObjectId,\n    default: null,\n    index: true,\n  },\n  contentType: {\n    type: String,\n    enum: ['user', 'comment', 'review', 'message', 'pet'],\n    required: [true, '內容類型為必填項目'],\n    index: true,\n  },\n  reportType: {\n    type: String,\n    required: [true, '舉報類型為必填項目'],\n    enum: [\n      '不當內容',\n      '騷擾行為',\n      '虛假信息',\n      '垃圾訊息',\n      '詐騙行為',\n      '侵犯隱私',\n      '仇恨言論',\n      '暴力威脅',\n      '侵犯版權',\n      '其他'\n    ],\n    index: true,\n  },\n  reason: {\n    type: String,\n    required: [true, '舉報原因為必填項目'],\n    trim: true,\n    maxlength: [200, '舉報原因不能超過 200 個字符'],\n  },\n  description: {\n    type: String,\n    trim: true,\n    maxlength: [1000, '詳細描述不能超過 1000 個字符'],\n    default: '',\n  },\n  evidence: [{\n    type: String,\n    validate: {\n      validator: function(url: string) {\n        return /^https?:\\/\\/.+/.test(url);\n      },\n      message: '證據必須是有效的URL',\n    },\n  }],\n  status: {\n    type: String,\n    enum: ['pending', 'investigating', 'resolved', 'dismissed'],\n    default: 'pending',\n    required: true,\n    index: true,\n  },\n  priority: {\n    type: String,\n    enum: ['low', 'medium', 'high', 'urgent'],\n    default: 'medium',\n    required: true,\n    index: true,\n  },\n  assignedTo: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    default: null,\n    index: true,\n  },\n  resolution: {\n    type: String,\n    trim: true,\n    maxlength: [1000, '處理結果不能超過 1000 個字符'],\n    default: '',\n  },\n  resolvedAt: {\n    type: Date,\n    default: null,\n  },\n  resolvedBy: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    default: null,\n  },\n  isDeleted: {\n    type: Boolean,\n    default: false,\n    index: true,\n  },\n}, {\n  timestamps: true,\n  toJSON: {\n    transform: function(doc, ret) {\n      ret.id = ret._id;\n      delete (ret as any)._id;\n      delete (ret as any).__v;\n      return ret;\n    },\n  },\n});\n\n// 舉報統計 Schema\nconst reportStatsSchema = new Schema<IReportStats>({\n  userId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    default: null,\n    index: true,\n  },\n  contentId: {\n    type: Schema.Types.ObjectId,\n    default: null,\n    index: true,\n  },\n  contentType: {\n    type: String,\n    required: true,\n    index: true,\n  },\n  totalReports: {\n    type: Number,\n    default: 0,\n    min: 0,\n  },\n  reportTypes: [{\n    type: {\n      type: String,\n      required: true,\n    },\n    count: {\n      type: Number,\n      required: true,\n      min: 1,\n    },\n  }],\n  statusDistribution: {\n    pending: { type: Number, default: 0, min: 0 },\n    investigating: { type: Number, default: 0, min: 0 },\n    resolved: { type: Number, default: 0, min: 0 },\n    dismissed: { type: Number, default: 0, min: 0 },\n  },\n  lastReportedAt: {\n    type: Date,\n    default: Date.now,\n  },\n  riskLevel: {\n    type: String,\n    enum: ['low', 'medium', 'high', 'critical'],\n    default: 'low',\n    index: true,\n  },\n}, {\n  timestamps: true,\n  toJSON: {\n    transform: function(doc, ret) {\n      ret.id = ret._id;\n      delete (ret as any)._id;\n      delete (ret as any).__v;\n      return ret;\n    },\n  },\n});\n\n// 複合索引\nreportSchema.index({ reporterId: 1, reportedUserId: 1, contentType: 1 });\nreportSchema.index({ reportedContentId: 1, contentType: 1 });\nreportSchema.index({ status: 1, priority: 1, createdAt: -1 });\nreportSchema.index({ assignedTo: 1, status: 1 });\nreportSchema.index({ createdAt: -1, status: 1 });\n\n// 防止重複舉報同一內容\nreportSchema.index({ \n  reporterId: 1, \n  reportedContentId: 1, \n  contentType: 1 \n}, { \n  unique: true,\n  partialFilterExpression: { \n    reportedContentId: { $ne: null },\n    isDeleted: false \n  }\n});\n\n// 注意：查詢時需要手動添加 { isDeleted: false } 條件\n\n// 自動設置優先級的中介軟體\nreportSchema.pre('save', function(next) {\n  if (this.isNew) {\n    // 根據舉報類型自動設置優先級\n    const highPriorityTypes = ['暴力威脅', '騷擾行為', '詐騙行為'];\n    const urgentTypes = ['仇恨言論'];\n    \n    if (urgentTypes.includes(this.reportType)) {\n      this.priority = 'urgent';\n    } else if (highPriorityTypes.includes(this.reportType)) {\n      this.priority = 'high';\n    }\n  }\n  next();\n});\n\n// 狀態變更時的中介軟體\nreportSchema.pre('findOneAndUpdate', function(next) {\n  const update = this.getUpdate() as any;\n  if (update.status === 'resolved' || update.status === 'dismissed') {\n    update.resolvedAt = new Date();\n  }\n  next();\n});\n\nexport const Report = mongoose.model<IReport>('Report', reportSchema);\nexport const ReportStats = mongoose.model<IReportStats>('ReportStats', reportStatsSchema);"],"version":3}