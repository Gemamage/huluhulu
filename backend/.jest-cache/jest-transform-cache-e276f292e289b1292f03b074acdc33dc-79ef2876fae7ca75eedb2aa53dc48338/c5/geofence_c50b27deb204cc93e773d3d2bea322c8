874b99b7bf894520a61e4cd2ce7066e3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GeofenceService = void 0;
const notificationService_1 = require("../notificationService");
const matchingService_1 = require("../matchingService");
const Pet_1 = require("../../models/Pet");
const Notification_1 = require("../../models/Notification");
const logger_1 = require("../../utils/logger");
class GeofenceService {
    /**
     * 初始化地理圍欄服務
     */
    static async initialize(config) {
        if (config) {
            this.config = { ...this.config, ...config };
        }
        // 載入現有的地理圍欄
        await this.loadGeofenceAreas();
        this.start();
        logger_1.logger.info('地理圍欄服務已初始化', { config: this.config });
    }
    /**
     * 啟動地理圍欄任務
     */
    static start() {
        if (!this.config.enabled || this.interval)
            return;
        const intervalMs = this.config.checkInterval * 60 * 1000;
        this.interval = setInterval(async () => {
            try {
                await this.processGeofenceNotifications();
            }
            catch (error) {
                logger_1.logger.error('地理圍欄通知任務失敗', { error });
            }
        }, intervalMs);
        logger_1.logger.info('地理圍欄通知任務已啟動', {
            interval: this.config.checkInterval
        });
    }
    /**
     * 停止地理圍欄任務
     */
    static stop() {
        if (this.interval) {
            clearInterval(this.interval);
            this.interval = null;
            logger_1.logger.info('地理圍欄通知任務已停止');
        }
    }
    /**
     * 處理地理圍欄通知
     */
    static async processGeofenceNotifications() {
        try {
            // 檢查每個活躍的地理圍欄
            for (const [areaId, area] of this.geofenceAreas) {
                if (!area.isActive)
                    continue;
                try {
                    await this.checkGeofenceArea(area);
                }
                catch (error) {
                    logger_1.logger.error('檢查地理圍欄失敗', {
                        areaId,
                        error
                    });
                }
            }
        }
        catch (error) {
            logger_1.logger.error('地理圍欄處理失敗', { error });
        }
    }
    /**
     * 檢查地理圍欄區域
     */
    static async checkGeofenceArea(area) {
        const targetPet = await Pet_1.Pet.findById(area.petId);
        if (!targetPet) {
            // 寵物不存在，移除地理圍欄
            this.geofenceAreas.delete(area.petId);
            return;
        }
        // 如果寵物已找到，停用地理圍欄
        if (targetPet.status === 'reunited') {
            area.isActive = false;
            return;
        }
        // 查找圍欄內的相關寵物
        const targetStatus = targetPet.status === 'lost' ? 'found' : 'lost';
        const recentThreshold = new Date(Date.now() - 24 * 60 * 60 * 1000); // 24小時內
        const nearbyPets = await Pet_1.Pet.find({
            _id: { $ne: area.petId },
            status: targetStatus,
            createdAt: { $gte: recentThreshold },
            location: {
                $geoWithin: {
                    $centerSphere: [
                        area.center,
                        area.radius / 6371 // 轉換為弧度
                    ]
                }
            }
        }).populate('owner');
        if (nearbyPets.length > 0) {
            await this.sendGeofenceNotification(area, targetPet, nearbyPets);
        }
    }
    /**
     * 發送地理圍欄通知
     */
    static async sendGeofenceNotification(area, targetPet, nearbyPets) {
        const distances = nearbyPets.map(pet => {
            const distance = matchingService_1.MatchingService.calculateDistance(area.center, 
            // 暫時跳過地理坐標檢查，因為 Pet 模型中沒有 location.coordinates 字段
            // TODO: 添加地理坐標字段到 Pet 模型
            [0, 0] // 暫時使用默認坐標
            );
            return { pet, distance };
        }).sort((a, b) => a.distance - b.distance);
        const closestPet = distances[0];
        if (closestPet) {
            await notificationService_1.NotificationService.sendNotification({
                userId: area.userId,
                type: 'GEOFENCE_ALERT',
                title: '📍 地理圍欄警報',
                message: `在您設定的 ${area.radius}km 範圍內發現了 ${nearbyPets.length} 隻${targetPet.status === 'lost' ? '拾獲' : '失蹤'}的寵物，最近距離 ${Math.round(closestPet.distance * 100) / 100}km`,
                data: {
                    petId: targetPet._id.toString(),
                    geofenceId: area.petId,
                    nearbyCount: nearbyPets.length,
                    closestDistance: Math.round(closestPet.distance * 100) / 100,
                    nearbyPets: distances.slice(0, 3).map(d => ({
                        petId: d.pet._id.toString(),
                        name: d.pet.name,
                        distance: Math.round(d.distance * 100) / 100
                    }))
                },
                priority: Notification_1.NotificationPriority.HIGH
            });
        }
    }
    /**
     * 創建地理圍欄
     */
    static async createGeofence(data) {
        const { userId, petId, latitude, longitude, radius, name } = data;
        const center = [longitude, latitude];
        const geofenceArea = {
            center,
            radius: radius || this.config.defaultRadius,
            userId,
            petId,
            name: name || `${petId} 的地理圍欄`,
            isActive: true,
            createdAt: new Date()
        };
        this.geofenceAreas.set(petId, geofenceArea);
        // 保存到資料庫（可選）
        await this.saveGeofenceArea(geofenceArea);
        logger_1.logger.info('地理圍欄已創建', {
            userId,
            petId,
            center,
            radius: geofenceArea.radius
        });
        return geofenceArea;
    }
    /**
     * 移除地理圍欄
     */
    static async removeGeofence(userId, geofenceId) {
        const geofence = this.geofenceAreas.get(geofenceId);
        if (!geofence || geofence.userId !== userId) {
            throw new Error('地理圍欄不存在或無權限');
        }
        const removed = this.geofenceAreas.delete(geofenceId);
        if (removed) {
            // 從資料庫移除（可選）
            await this.deleteGeofenceArea(geofenceId);
            logger_1.logger.info('地理圍欄已移除', { userId, geofenceId });
        }
        return removed;
    }
    /**
     * 獲取用戶的地理圍欄列表
     */
    static async getUserGeofences(userId) {
        const userGeofences = [];
        for (const [petId, geofence] of this.geofenceAreas.entries()) {
            if (geofence.userId === userId && geofence.isActive) {
                userGeofences.push(geofence);
            }
        }
        return userGeofences;
    }
    /**
     * 載入地理圍欄區域
     */
    static async loadGeofenceAreas() {
        // 這裡可以從資料庫載入已保存的地理圍欄
        // 暫時使用記憶體存儲
        logger_1.logger.info('地理圍欄區域已載入');
    }
    /**
     * 保存地理圍欄區域
     */
    static async saveGeofenceArea(area) {
        // 這裡可以保存到資料庫
        // 暫時跳過
    }
    /**
     * 刪除地理圍欄區域
     */
    static async deleteGeofenceArea(petId) {
        // 這裡可以從資料庫刪除
        // 暫時跳過
    }
    /**
     * 獲取配置
     */
    static getConfig() {
        return { ...this.config };
    }
    /**
     * 更新配置
     */
    static updateConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
        // 如果啟用狀態改變，重新啟動或停止服務
        if (newConfig.enabled !== undefined) {
            this.stop();
            if (newConfig.enabled) {
                this.start();
            }
        }
        logger_1.logger.info('地理圍欄配置已更新', { config: this.config });
        return { ...this.config };
    }
    /**
     * 獲取統計信息
     */
    static getStats() {
        const activeAreas = Array.from(this.geofenceAreas.values())
            .filter(area => area.isActive).length;
        return {
            enabled: this.config.enabled,
            running: this.interval !== null,
            totalAreas: this.geofenceAreas.size,
            activeAreas,
            config: { ...this.config }
        };
    }
}
exports.GeofenceService = GeofenceService;
GeofenceService.config = {
    enabled: true,
    defaultRadius: 10, // 10km
    checkInterval: 15 // 15 minutes
};
GeofenceService.geofenceAreas = new Map();
GeofenceService.interval = null;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxub3RpZmljYXRpb25zXFxnZW9mZW5jZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxnRUFBNkQ7QUFDN0Qsd0RBQXFEO0FBQ3JELDBDQUE2QztBQUU3Qyw0REFBbUY7QUFDbkYsK0NBQTRDO0FBa0I1QyxNQUFhLGVBQWU7SUFVMUI7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFnQztRQUN0RCxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ1gsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDO1FBQzlDLENBQUM7UUFFRCxZQUFZO1FBQ1osTUFBTSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUUvQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDYixlQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSztRQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsUUFBUTtZQUFFLE9BQU87UUFFbEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztRQUV6RCxJQUFJLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNyQyxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztZQUM1QyxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixlQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksRUFB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QixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDZixDQUFDO1FBQ0gsQ0FBQztRQUVELGVBQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsUUFBUTtRQU9iLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUN4RCxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBRXhDLE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPO1lBQzVCLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxLQUFLLElBQUk7WUFDL0IsVUFBVSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSTtZQUNuQyxXQUFXO1lBQ1gsTUFBTSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFO1NBQzNCLENBQUM7SUFDSixDQUFDOztBQW5USCwwQ0FvVEM7QUFuVGdCLHNCQUFNLEdBQW1CO0lBQ3RDLE9BQU8sRUFBRSxJQUFJO0lBQ2IsYUFBYSxFQUFFLEVBQUUsRUFBRSxPQUFPO0lBQzFCLGFBQWEsRUFBRSxFQUFFLENBQUMsYUFBYTtDQUNoQyxDQUFDO0FBRWEsNkJBQWEsR0FBOEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUNyRCx3QkFBUSxHQUEwQixJQUFJLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxVc2VyXFxEZXNrdG9wXFx0cmFlcHJvamVjdFxcdGVzdDJcXHBldC1maW5kZXItYXBwXFxiYWNrZW5kXFxzcmNcXHNlcnZpY2VzXFxub3RpZmljYXRpb25zXFxnZW9mZW5jZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOb3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vbm90aWZpY2F0aW9uU2VydmljZSc7XG5pbXBvcnQgeyBNYXRjaGluZ1NlcnZpY2UgfSBmcm9tICcuLi9tYXRjaGluZ1NlcnZpY2UnO1xuaW1wb3J0IHsgUGV0LCBJUGV0IH0gZnJvbSAnLi4vLi4vbW9kZWxzL1BldCc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vLi4vbW9kZWxzL1VzZXInO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uVHlwZSwgTm90aWZpY2F0aW9uUHJpb3JpdHkgfSBmcm9tICcuLi8uLi9tb2RlbHMvTm90aWZpY2F0aW9uJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2VvZmVuY2VBcmVhIHtcbiAgY2VudGVyOiBbbnVtYmVyLCBudW1iZXJdOyAvLyBbbG9uZ2l0dWRlLCBsYXRpdHVkZV1cbiAgcmFkaXVzOiBudW1iZXI7IC8vIGluIGtpbG9tZXRlcnNcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHBldElkOiBzdHJpbmc7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIGlzQWN0aXZlOiBib29sZWFuO1xuICBjcmVhdGVkQXQ6IERhdGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2VvZmVuY2VDb25maWcge1xuICBlbmFibGVkOiBib29sZWFuO1xuICBkZWZhdWx0UmFkaXVzOiBudW1iZXI7IC8vIGluIGtpbG9tZXRlcnNcbiAgY2hlY2tJbnRlcnZhbDogbnVtYmVyOyAvLyBpbiBtaW51dGVzXG59XG5cbmV4cG9ydCBjbGFzcyBHZW9mZW5jZVNlcnZpY2Uge1xuICBwcml2YXRlIHN0YXRpYyBjb25maWc6IEdlb2ZlbmNlQ29uZmlnID0ge1xuICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgZGVmYXVsdFJhZGl1czogMTAsIC8vIDEwa21cbiAgICBjaGVja0ludGVydmFsOiAxNSAvLyAxNSBtaW51dGVzXG4gIH07XG4gIFxuICBwcml2YXRlIHN0YXRpYyBnZW9mZW5jZUFyZWFzOiBNYXA8c3RyaW5nLCBHZW9mZW5jZUFyZWE+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHN0YXRpYyBpbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcblxuICAvKipcbiAgICog5Yid5aeL5YyW5Zyw55CG5ZyN5qyE5pyN5YuZXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgaW5pdGlhbGl6ZShjb25maWc/OiBQYXJ0aWFsPEdlb2ZlbmNlQ29uZmlnPik6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmIChjb25maWcpIHtcbiAgICAgIHRoaXMuY29uZmlnID0geyAuLi50aGlzLmNvbmZpZywgLi4uY29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8g6LyJ5YWl54++5pyJ55qE5Zyw55CG5ZyN5qyEXG4gICAgYXdhaXQgdGhpcy5sb2FkR2VvZmVuY2VBcmVhcygpO1xuXG4gICAgdGhpcy5zdGFydCgpO1xuICAgIGxvZ2dlci5pbmZvKCflnLDnkIblnI3mrITmnI3li5nlt7LliJ3lp4vljJYnLCB7IGNvbmZpZzogdGhpcy5jb25maWcgfSk7XG4gIH1cblxuICAvKipcbiAgICog5ZWf5YuV5Zyw55CG5ZyN5qyE5Lu75YuZXG4gICAqL1xuICBzdGF0aWMgc3RhcnQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmNvbmZpZy5lbmFibGVkIHx8IHRoaXMuaW50ZXJ2YWwpIHJldHVybjtcblxuICAgIGNvbnN0IGludGVydmFsTXMgPSB0aGlzLmNvbmZpZy5jaGVja0ludGVydmFsICogNjAgKiAxMDAwO1xuICAgIFxuICAgIHRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb2Nlc3NHZW9mZW5jZU5vdGlmaWNhdGlvbnMoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcign5Zyw55CG5ZyN5qyE6YCa55+l5Lu75YuZ5aSx5pWXJywgeyBlcnJvciB9KTtcbiAgICAgIH1cbiAgICB9LCBpbnRlcnZhbE1zKTtcblxuICAgIGxvZ2dlci5pbmZvKCflnLDnkIblnI3mrITpgJrnn6Xku7vli5nlt7LllZ/li5UnLCB7IFxuICAgICAgaW50ZXJ2YWw6IHRoaXMuY29uZmlnLmNoZWNrSW50ZXJ2YWwgXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog5YGc5q2i5Zyw55CG5ZyN5qyE5Lu75YuZXG4gICAqL1xuICBzdGF0aWMgc3RvcCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pbnRlcnZhbCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmludGVydmFsKTtcbiAgICAgIHRoaXMuaW50ZXJ2YWwgPSBudWxsO1xuICAgICAgbG9nZ2VyLmluZm8oJ+WcsOeQhuWcjeashOmAmuefpeS7u+WLmeW3suWBnOatoicpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDomZXnkIblnLDnkIblnI3mrITpgJrnn6VcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGFzeW5jIHByb2Nlc3NHZW9mZW5jZU5vdGlmaWNhdGlvbnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIOaqouafpeavj+WAi+a0u+i6jeeahOWcsOeQhuWcjeashFxuICAgICAgZm9yIChjb25zdCBbYXJlYUlkLCBhcmVhXSBvZiB0aGlzLmdlb2ZlbmNlQXJlYXMpIHtcbiAgICAgICAgaWYgKCFhcmVhLmlzQWN0aXZlKSBjb250aW51ZTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuY2hlY2tHZW9mZW5jZUFyZWEoYXJlYSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCfmqqLmn6XlnLDnkIblnI3mrITlpLHmlZcnLCB7IFxuICAgICAgICAgICAgYXJlYUlkLCBcbiAgICAgICAgICAgIGVycm9yIFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcign5Zyw55CG5ZyN5qyE6JmV55CG5aSx5pWXJywgeyBlcnJvciB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5qqi5p+l5Zyw55CG5ZyN5qyE5Y2A5Z+fXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBhc3luYyBjaGVja0dlb2ZlbmNlQXJlYShhcmVhOiBHZW9mZW5jZUFyZWEpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB0YXJnZXRQZXQgPSBhd2FpdCBQZXQuZmluZEJ5SWQoYXJlYS5wZXRJZCk7XG4gICAgaWYgKCF0YXJnZXRQZXQpIHtcbiAgICAgIC8vIOWvteeJqeS4jeWtmOWcqO+8jOenu+mZpOWcsOeQhuWcjeashFxuICAgICAgdGhpcy5nZW9mZW5jZUFyZWFzLmRlbGV0ZShhcmVhLnBldElkKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyDlpoLmnpzlr7Xnianlt7Lmib7liLDvvIzlgZznlKjlnLDnkIblnI3mrIRcbiAgICBpZiAodGFyZ2V0UGV0LnN0YXR1cyA9PT0gJ3JldW5pdGVkJykge1xuICAgICAgYXJlYS5pc0FjdGl2ZSA9IGZhbHNlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIOafpeaJvuWcjeashOWFp+eahOebuOmXnOWvteeJqVxuICAgIGNvbnN0IHRhcmdldFN0YXR1cyA9IHRhcmdldFBldC5zdGF0dXMgPT09ICdsb3N0JyA/ICdmb3VuZCcgOiAnbG9zdCc7XG4gICAgY29uc3QgcmVjZW50VGhyZXNob2xkID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyAyNOWwj+aZguWFp1xuXG4gICAgY29uc3QgbmVhcmJ5UGV0cyA9IGF3YWl0IFBldC5maW5kKHtcbiAgICAgIF9pZDogeyAkbmU6IGFyZWEucGV0SWQgfSxcbiAgICAgIHN0YXR1czogdGFyZ2V0U3RhdHVzLFxuICAgICAgY3JlYXRlZEF0OiB7ICRndGU6IHJlY2VudFRocmVzaG9sZCB9LFxuICAgICAgbG9jYXRpb246IHtcbiAgICAgICAgJGdlb1dpdGhpbjoge1xuICAgICAgICAgICRjZW50ZXJTcGhlcmU6IFtcbiAgICAgICAgICAgIGFyZWEuY2VudGVyLFxuICAgICAgICAgICAgYXJlYS5yYWRpdXMgLyA2MzcxIC8vIOi9ieaPm+eCuuW8p+W6plxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pLnBvcHVsYXRlKCdvd25lcicpO1xuXG4gICAgaWYgKG5lYXJieVBldHMubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgdGhpcy5zZW5kR2VvZmVuY2VOb3RpZmljYXRpb24oYXJlYSwgdGFyZ2V0UGV0LCBuZWFyYnlQZXRzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog55m86YCB5Zyw55CG5ZyN5qyE6YCa55+lXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBhc3luYyBzZW5kR2VvZmVuY2VOb3RpZmljYXRpb24oXG4gICAgYXJlYTogR2VvZmVuY2VBcmVhLFxuICAgIHRhcmdldFBldDogSVBldCxcbiAgICBuZWFyYnlQZXRzOiBJUGV0W11cbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZGlzdGFuY2VzID0gbmVhcmJ5UGV0cy5tYXAocGV0ID0+IHtcbiAgICAgIGNvbnN0IGRpc3RhbmNlID0gTWF0Y2hpbmdTZXJ2aWNlLmNhbGN1bGF0ZURpc3RhbmNlKFxuICAgICAgICBhcmVhLmNlbnRlcixcbiAgICAgICAgLy8g5pqr5pmC6Lez6YGO5Zyw55CG5Z2Q5qiZ5qqi5p+l77yM5Zug54K6IFBldCDmqKHlnovkuK3mspLmnIkgbG9jYXRpb24uY29vcmRpbmF0ZXMg5a2X5q61XG4gICAgICAgIC8vIFRPRE86IOa3u+WKoOWcsOeQhuWdkOaomeWtl+auteWIsCBQZXQg5qih5Z6LXG4gICAgICAgIFswLCAwXSAvLyDmmqvmmYLkvb/nlKjpu5joqo3lnZDmqJlcbiAgICAgICk7XG4gICAgICByZXR1cm4geyBwZXQsIGRpc3RhbmNlIH07XG4gICAgfSkuc29ydCgoYSwgYikgPT4gYS5kaXN0YW5jZSAtIGIuZGlzdGFuY2UpO1xuXG4gICAgY29uc3QgY2xvc2VzdFBldCA9IGRpc3RhbmNlc1swXTtcblxuICAgIGlmIChjbG9zZXN0UGV0KSB7XG4gICAgICBhd2FpdCBOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmROb3RpZmljYXRpb24oe1xuICAgICAgICB1c2VySWQ6IGFyZWEudXNlcklkLFxuICAgICAgICB0eXBlOiAnR0VPRkVOQ0VfQUxFUlQnIGFzIE5vdGlmaWNhdGlvblR5cGUsXG4gICAgICAgIHRpdGxlOiAn8J+TjSDlnLDnkIblnI3mrITorabloLEnLFxuICAgICAgICBtZXNzYWdlOiBg5Zyo5oKo6Kit5a6a55qEICR7YXJlYS5yYWRpdXN9a20g56+E5ZyN5YWn55m854++5LqGICR7bmVhcmJ5UGV0cy5sZW5ndGh9IOmauyR7dGFyZ2V0UGV0LnN0YXR1cyA9PT0gJ2xvc3QnID8gJ+aLvueNsicgOiAn5aSx6LmkJ33nmoTlr7XnianvvIzmnIDov5Hot53pm6IgJHtNYXRoLnJvdW5kKGNsb3Nlc3RQZXQuZGlzdGFuY2UgKiAxMDApIC8gMTAwfWttYCxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHBldElkOiB0YXJnZXRQZXQuX2lkLnRvU3RyaW5nKCksXG4gICAgICAgICAgZ2VvZmVuY2VJZDogYXJlYS5wZXRJZCxcbiAgICAgICAgICBuZWFyYnlDb3VudDogbmVhcmJ5UGV0cy5sZW5ndGgsXG4gICAgICAgICAgY2xvc2VzdERpc3RhbmNlOiBNYXRoLnJvdW5kKGNsb3Nlc3RQZXQuZGlzdGFuY2UgKiAxMDApIC8gMTAwLFxuICAgICAgICAgIG5lYXJieVBldHM6IGRpc3RhbmNlcy5zbGljZSgwLCAzKS5tYXAoZCA9PiAoe1xuICAgICAgICAgICAgcGV0SWQ6IGQucGV0Ll9pZC50b1N0cmluZygpLFxuICAgICAgICAgICAgbmFtZTogZC5wZXQubmFtZSxcbiAgICAgICAgICAgIGRpc3RhbmNlOiBNYXRoLnJvdW5kKGQuZGlzdGFuY2UgKiAxMDApIC8gMTAwXG4gICAgICAgICAgfSkpXG4gICAgICAgIH0sXG4gICAgICAgIHByaW9yaXR5OiBOb3RpZmljYXRpb25Qcmlvcml0eS5ISUdIXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5Ym15bu65Zyw55CG5ZyN5qyEXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgY3JlYXRlR2VvZmVuY2UoZGF0YToge1xuICAgIHVzZXJJZDogc3RyaW5nO1xuICAgIHBldElkOiBzdHJpbmc7XG4gICAgbGF0aXR1ZGU6IG51bWJlcjtcbiAgICBsb25naXR1ZGU6IG51bWJlcjtcbiAgICByYWRpdXM/OiBudW1iZXI7XG4gICAgbmFtZT86IHN0cmluZztcbiAgfSk6IFByb21pc2U8R2VvZmVuY2VBcmVhPiB7XG4gICAgY29uc3QgeyB1c2VySWQsIHBldElkLCBsYXRpdHVkZSwgbG9uZ2l0dWRlLCByYWRpdXMsIG5hbWUgfSA9IGRhdGE7XG4gICAgY29uc3QgY2VudGVyOiBbbnVtYmVyLCBudW1iZXJdID0gW2xvbmdpdHVkZSwgbGF0aXR1ZGVdO1xuICAgIFxuICAgIGNvbnN0IGdlb2ZlbmNlQXJlYTogR2VvZmVuY2VBcmVhID0ge1xuICAgICAgY2VudGVyLFxuICAgICAgcmFkaXVzOiByYWRpdXMgfHwgdGhpcy5jb25maWcuZGVmYXVsdFJhZGl1cyxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHBldElkLFxuICAgICAgbmFtZTogbmFtZSB8fCBgJHtwZXRJZH0g55qE5Zyw55CG5ZyN5qyEYCxcbiAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpXG4gICAgfTtcblxuICAgIHRoaXMuZ2VvZmVuY2VBcmVhcy5zZXQocGV0SWQsIGdlb2ZlbmNlQXJlYSk7XG4gICAgXG4gICAgLy8g5L+d5a2Y5Yiw6LOH5paZ5bqr77yI5Y+v6YG477yJXG4gICAgYXdhaXQgdGhpcy5zYXZlR2VvZmVuY2VBcmVhKGdlb2ZlbmNlQXJlYSk7XG5cbiAgICBsb2dnZXIuaW5mbygn5Zyw55CG5ZyN5qyE5bey5Ym15bu6JywgeyBcbiAgICAgIHVzZXJJZCwgXG4gICAgICBwZXRJZCwgXG4gICAgICBjZW50ZXIsIFxuICAgICAgcmFkaXVzOiBnZW9mZW5jZUFyZWEucmFkaXVzIFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGdlb2ZlbmNlQXJlYTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnp7vpmaTlnLDnkIblnI3mrIRcbiAgICovXG4gIHN0YXRpYyBhc3luYyByZW1vdmVHZW9mZW5jZSh1c2VySWQ6IHN0cmluZywgZ2VvZmVuY2VJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZ2VvZmVuY2UgPSB0aGlzLmdlb2ZlbmNlQXJlYXMuZ2V0KGdlb2ZlbmNlSWQpO1xuICAgIFxuICAgIGlmICghZ2VvZmVuY2UgfHwgZ2VvZmVuY2UudXNlcklkICE9PSB1c2VySWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign5Zyw55CG5ZyN5qyE5LiN5a2Y5Zyo5oiW54Sh5qyK6ZmQJyk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IHJlbW92ZWQgPSB0aGlzLmdlb2ZlbmNlQXJlYXMuZGVsZXRlKGdlb2ZlbmNlSWQpO1xuICAgIFxuICAgIGlmIChyZW1vdmVkKSB7XG4gICAgICAvLyDlvp7os4fmlpnluqvnp7vpmaTvvIjlj6/pgbjvvIlcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlR2VvZmVuY2VBcmVhKGdlb2ZlbmNlSWQpO1xuICAgICAgbG9nZ2VyLmluZm8oJ+WcsOeQhuWcjeashOW3suenu+mZpCcsIHsgdXNlcklkLCBnZW9mZW5jZUlkIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZW1vdmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPlueUqOaItueahOWcsOeQhuWcjeashOWIl+ihqFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGdldFVzZXJHZW9mZW5jZXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPEdlb2ZlbmNlQXJlYVtdPiB7XG4gICAgY29uc3QgdXNlckdlb2ZlbmNlczogR2VvZmVuY2VBcmVhW10gPSBbXTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IFtwZXRJZCwgZ2VvZmVuY2VdIG9mIHRoaXMuZ2VvZmVuY2VBcmVhcy5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChnZW9mZW5jZS51c2VySWQgPT09IHVzZXJJZCAmJiBnZW9mZW5jZS5pc0FjdGl2ZSkge1xuICAgICAgICB1c2VyR2VvZmVuY2VzLnB1c2goZ2VvZmVuY2UpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdXNlckdlb2ZlbmNlcztcbiAgfVxuXG4gIC8qKlxuICAgKiDovInlhaXlnLDnkIblnI3mrITljYDln59cbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGFzeW5jIGxvYWRHZW9mZW5jZUFyZWFzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIOmAmeijoeWPr+S7peW+nuizh+aWmeW6q+i8ieWFpeW3suS/neWtmOeahOWcsOeQhuWcjeashFxuICAgIC8vIOaaq+aZguS9v+eUqOiomOaGtumrlOWtmOWEslxuICAgIGxvZ2dlci5pbmZvKCflnLDnkIblnI3mrITljYDln5/lt7LovInlhaUnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDkv53lrZjlnLDnkIblnI3mrITljYDln59cbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGFzeW5jIHNhdmVHZW9mZW5jZUFyZWEoYXJlYTogR2VvZmVuY2VBcmVhKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8g6YCZ6KOh5Y+v5Lul5L+d5a2Y5Yiw6LOH5paZ5bqrXG4gICAgLy8g5pqr5pmC6Lez6YGOXG4gIH1cblxuICAvKipcbiAgICog5Yiq6Zmk5Zyw55CG5ZyN5qyE5Y2A5Z+fXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBhc3luYyBkZWxldGVHZW9mZW5jZUFyZWEocGV0SWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIOmAmeijoeWPr+S7peW+nuizh+aWmeW6q+WIqumZpFxuICAgIC8vIOaaq+aZgui3s+mBjlxuICB9XG5cbiAgLyoqXG4gICAqIOeNsuWPlumFjee9rlxuICAgKi9cbiAgc3RhdGljIGdldENvbmZpZygpOiBHZW9mZW5jZUNvbmZpZyB7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5jb25maWcgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDphY3nva5cbiAgICovXG4gIHN0YXRpYyB1cGRhdGVDb25maWcobmV3Q29uZmlnOiBQYXJ0aWFsPEdlb2ZlbmNlQ29uZmlnPik6IEdlb2ZlbmNlQ29uZmlnIHtcbiAgICB0aGlzLmNvbmZpZyA9IHsgLi4udGhpcy5jb25maWcsIC4uLm5ld0NvbmZpZyB9O1xuICAgIFxuICAgIC8vIOWmguaenOWVn+eUqOeLgOaFi+aUueiuiu+8jOmHjeaWsOWVn+WLleaIluWBnOatouacjeWLmVxuICAgIGlmIChuZXdDb25maWcuZW5hYmxlZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLnN0b3AoKTtcbiAgICAgIGlmIChuZXdDb25maWcuZW5hYmxlZCkge1xuICAgICAgICB0aGlzLnN0YXJ0KCk7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGxvZ2dlci5pbmZvKCflnLDnkIblnI3mrITphY3nva7lt7Lmm7TmlrAnLCB7IGNvbmZpZzogdGhpcy5jb25maWcgfSk7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5jb25maWcgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnjbLlj5bntbHoqIjkv6Hmga9cbiAgICovXG4gIHN0YXRpYyBnZXRTdGF0cygpOiB7XG4gICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICBydW5uaW5nOiBib29sZWFuO1xuICAgIHRvdGFsQXJlYXM6IG51bWJlcjtcbiAgICBhY3RpdmVBcmVhczogbnVtYmVyO1xuICAgIGNvbmZpZzogR2VvZmVuY2VDb25maWc7XG4gIH0ge1xuICAgIGNvbnN0IGFjdGl2ZUFyZWFzID0gQXJyYXkuZnJvbSh0aGlzLmdlb2ZlbmNlQXJlYXMudmFsdWVzKCkpXG4gICAgICAuZmlsdGVyKGFyZWEgPT4gYXJlYS5pc0FjdGl2ZSkubGVuZ3RoO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGVuYWJsZWQ6IHRoaXMuY29uZmlnLmVuYWJsZWQsXG4gICAgICBydW5uaW5nOiB0aGlzLmludGVydmFsICE9PSBudWxsLFxuICAgICAgdG90YWxBcmVhczogdGhpcy5nZW9mZW5jZUFyZWFzLnNpemUsXG4gICAgICBhY3RpdmVBcmVhcyxcbiAgICAgIGNvbmZpZzogeyAuLi50aGlzLmNvbmZpZyB9XG4gICAgfTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==