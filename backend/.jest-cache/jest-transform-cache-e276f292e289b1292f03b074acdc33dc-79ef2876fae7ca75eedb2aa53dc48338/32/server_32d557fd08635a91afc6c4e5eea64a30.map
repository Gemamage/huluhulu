{"file":"C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\server.ts","mappings":"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","names":[],"sources":["C:\\Users\\User\\Desktop\\traeproject\\test2\\pet-finder-app\\backend\\src\\server.ts"],"sourcesContent":["import express from \"express\";\nimport cors from \"cors\";\nimport helmet from \"helmet\";\nimport compression from \"compression\";\nimport morgan from \"morgan\";\nimport rateLimit from \"express-rate-limit\";\nimport session from \"express-session\";\nimport MongoStore from \"connect-mongo\";\nimport passport from \"passport\";\nimport { createServer } from \"http\";\n\nimport { config } from \"./config/environment\";\nimport { connectDatabase } from \"./config/database-dev\";\nimport { logger } from \"./utils/logger\";\nimport { errorHandler } from \"./middleware/error-handler\";\nimport { notFoundHandler } from \"./middleware/not-found\";\nimport { swaggerSetup } from \"./config/swagger\";\n\n// 服務導入\nimport { SocketService } from \"./services/socketService\";\nimport { NotificationService } from \"./services/notificationService\";\nimport { SmartNotificationService } from \"./services/smartNotificationService\";\nimport { elasticsearchService } from \"./services/elasticsearchService\";\nimport { petSearchService } from \"./services/petSearchService\";\nimport { mockElasticsearchService } from \"./services/mockElasticsearchService\";\n\n// Passport 配置\nimport \"./config/passport\";\n\n// 路由導入\nimport { authRoutes } from \"./routes/auth\";\nimport { userRoutes } from \"./routes/users\";\nimport { petRoutes } from \"./routes/pets\";\nimport { searchRoutes } from \"./routes/search\";\nimport { default as uploadRoutes } from \"./routes/upload\";\nimport { oauthRoutes } from \"./routes/oauth\";\nimport { privacyRoutes } from \"./routes/privacy\";\nimport { adminRoutes } from \"./routes/admin\";\nimport { aiRoutes } from \"./routes/ai\";\nimport notificationRoutes from \"./routes/notifications\";\nimport { smartNotificationRoutes } from \"./routes/smartNotifications\";\n\nimport advancedSearchRoutes from \"./routes/advancedSearch\";\n\n// 建立 Express 應用程式和 HTTP 伺服器\nconst app = express();\nconst httpServer = createServer(app);\n\n// 初始化 Socket 服務\nconst io = SocketService.initialize(httpServer);\n\n// 安全性中介軟體\napp.use(\n  helmet({\n    crossOriginEmbedderPolicy: false,\n    contentSecurityPolicy: {\n      directives: {\n        defaultSrc: [\"'self'\"],\n        styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n        scriptSrc: [\n          \"'self'\",\n          \"*.dify.dev\",\n          \"*.dify.ai\",\n          \"*.udify.app\",\n          \"udify.app\",\n          \"https://www.gstatic.com\",\n        ],\n        imgSrc: [\"'self'\", \"data:\", \"https:\"],\n        connectSrc: [\n          \"'self'\",\n          \"*.dify.dev\",\n          \"*.dify.ai\",\n          \"*.udify.app\",\n          \"udify.app\",\n        ],\n        frameSrc: [\n          \"'self'\",\n          \"*.dify.dev\",\n          \"*.dify.ai\",\n          \"*.udify.app\",\n          \"udify.app\",\n        ],\n      },\n    },\n  }),\n);\n\n// CORS 設定\napp.use(\n  cors({\n    origin: config.cors.allowedOrigins,\n    credentials: true,\n    methods: [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"PATCH\", \"OPTIONS\"],\n    allowedHeaders: [\"Content-Type\", \"Authorization\"],\n  }),\n);\n\n// 壓縮回應\napp.use(compression());\n\n// 請求日誌\nif (config.env !== \"test\") {\n  app.use(\n    morgan(\"combined\", {\n      stream: {\n        write: (message: string) => logger.info(message.trim()),\n      },\n    }),\n  );\n}\n\n// 速率限制\nconst limiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 分鐘\n  max: config.env === \"production\" ? 100 : 1000, // 限制請求次數\n  message: {\n    error: \"請求過於頻繁，請稍後再試\",\n    retryAfter: \"15 分鐘\",\n  },\n  standardHeaders: true,\n  legacyHeaders: false,\n});\napp.use(\"/api\", limiter);\n\n// 解析請求體\napp.use(express.json({ limit: \"10mb\" }));\napp.use(express.urlencoded({ extended: true, limit: \"10mb\" }));\n\n// Session 配置\nconst sessionConfig: any = {\n  secret: config.session.secret,\n  resave: false,\n  saveUninitialized: false,\n  cookie: {\n    secure: config.env === \"production\", // HTTPS only in production\n    httpOnly: true,\n    maxAge: 24 * 60 * 60 * 1000, // 24 小時\n  },\n};\n\n// 在開發模式下使用內存存儲，避免 MongoDB 依賴\nif (config.env !== \"development\") {\n  sessionConfig.store = MongoStore.create({\n    mongoUrl: config.database.uri,\n    touchAfter: 24 * 3600, // 24 小時內只更新一次\n  });\n}\n\napp.use(session(sessionConfig));\n\n// Passport 中介軟體\napp.use(passport.initialize());\napp.use(passport.session());\n\n// API 文件\nif (config.env !== \"production\") {\n  swaggerSetup(app);\n}\n\n// 根路徑歡迎頁面\napp.get(\"/\", (_req, res) => {\n  res.status(200).json({\n    message: \"歡迎使用呼嚕寵物協尋網站 API\",\n    version: process.env.npm_package_version || \"1.0.0\",\n    environment: config.env,\n    timestamp: new Date().toISOString(),\n    endpoints: {\n      health: \"/health\",\n      apiDocs: config.env !== \"production\" ? \"/api-docs\" : null,\n      api: \"/api\",\n    },\n    description: \"這是一個專為寵物協尋設計的後端 API 服務\",\n  });\n});\n\n// 健康檢查端點\napp.get(\"/health\", (_req, res) => {\n  res.status(200).json({\n    status: \"OK\",\n    timestamp: new Date().toISOString(),\n    environment: config.env,\n    version: process.env.npm_package_version || \"1.0.0\",\n  });\n});\n\n// API 路由\napp.use(\"/api/auth\", authRoutes);\napp.use(\"/api/oauth\", oauthRoutes);\napp.use(\"/api/users\", userRoutes);\napp.use(\"/api/pets\", petRoutes);\napp.use(\"/api/search\", searchRoutes);\napp.use(\"/api/advanced-search\", advancedSearchRoutes);\napp.use(\"/api/upload\", uploadRoutes);\napp.use(\"/api/privacy\", privacyRoutes);\napp.use(\"/api/admin\", adminRoutes);\napp.use(\"/api/ai\", aiRoutes);\napp.use(\"/api/notifications\", notificationRoutes);\napp.use(\"/api/smart-notifications\", smartNotificationRoutes);\n\n\n// 404 處理\napp.use(notFoundHandler);\n\n// 錯誤處理\napp.use(errorHandler);\n\n// 啟動伺服器\nconst startServer = async (): Promise<void> => {\n  try {\n    // 連接資料庫\n    await connectDatabase();\n    logger.info(\"資料庫連接成功\");\n\n    // 初始化搜尋服務\n    const useElasticsearch =\n      process.env.ELASTICSEARCH_URL && process.env.NODE_ENV !== \"development\";\n\n    if (useElasticsearch) {\n      try {\n        const elasticsearchConnected = await elasticsearchService.connect();\n        if (elasticsearchConnected) {\n          logger.info(\"Elasticsearch 服務已啟動\");\n\n          // 初始化搜尋索引\n          await petSearchService.initializePetIndex();\n          await petSearchService.initializeSearchAnalyticsIndex();\n          logger.info(\"搜尋索引初始化完成\");\n        } else {\n          logger.warn(\"Elasticsearch 連接失敗，切換到模擬服務\");\n          await mockElasticsearchService.initializeIndex();\n          logger.info(\"模擬搜尋服務初始化完成\");\n        }\n      } catch (error) {\n        logger.error(\"Elasticsearch 初始化失敗，切換到模擬服務:\", error);\n        await mockElasticsearchService.initializeIndex();\n        logger.info(\"模擬搜尋服務初始化完成\");\n      }\n    } else {\n      await mockElasticsearchService.initializeIndex();\n      logger.info(\"開發模式：使用模擬搜尋服務\");\n    }\n\n    // 啟動伺服器\n    const server = httpServer.listen(config.port, () => {\n      logger.info(`伺服器運行在 http://localhost:${config.port}`);\n      logger.info(`環境: ${config.env}`);\n      logger.info(\"Socket.IO 服務已啟動\");\n\n      if (config.env !== \"production\") {\n        logger.info(`API 文件: http://localhost:${config.port}/api-docs`);\n      }\n    });\n\n    // 啟動通知服務的定期任務\n    NotificationService.startScheduledTasks();\n    logger.info(\"通知服務定期任務已啟動\");\n\n    // 初始化智能通知服務\n    await SmartNotificationService.initialize();\n    logger.info(\"智能通知服務已初始化\");\n\n    // 優雅關閉\n    const gracefulShutdown = async (signal: string) => {\n      logger.info(`收到 ${signal} 信號，開始優雅關閉...`);\n\n      try {\n        // 停止通知服務定期任務\n        NotificationService.stopScheduledTasks();\n\n        // 停止智能通知服務\n        await SmartNotificationService.stop();\n        logger.info(\"智能通知服務已停止\");\n\n        // 關閉搜尋服務連接\n        if (\n          process.env.ELASTICSEARCH_URL &&\n          process.env.NODE_ENV !== \"development\"\n        ) {\n          await elasticsearchService.close();\n          logger.info(\"Elasticsearch 連接已關閉\");\n        } else {\n          logger.info(\"模擬搜尋服務已清理\");\n        }\n      } catch (error) {\n        logger.error(\"停止服務時發生錯誤:\", error);\n      }\n\n      // 關閉 Socket.IO 連接\n      io.close(() => {\n        logger.info(\"Socket.IO 伺服器已關閉\");\n      });\n\n      server.close(() => {\n        logger.info(\"HTTP 伺服器已關閉\");\n        process.exit(0);\n      });\n\n      // 強制關閉\n      setTimeout(() => {\n        logger.error(\"強制關閉伺服器\");\n        process.exit(1);\n      }, 10000);\n    };\n\n    process.on(\"SIGTERM\", () => gracefulShutdown(\"SIGTERM\"));\n    process.on(\"SIGINT\", () => gracefulShutdown(\"SIGINT\"));\n  } catch (error) {\n    logger.error(\"伺服器啟動失敗:\", error);\n    process.exit(1);\n  }\n};\n\n// 處理未捕獲的異常\nprocess.on(\"uncaughtException\", (error) => {\n  logger.error(\"未捕獲的異常:\", error);\n  process.exit(1);\n});\n\nprocess.on(\"unhandledRejection\", (reason, promise) => {\n  logger.error(\"未處理的 Promise 拒絕:\", { reason, promise });\n  process.exit(1);\n});\n\n// 啟動應用程式\nif (require.main === module) {\n  startServer();\n}\n\nexport { app, httpServer, io };\n"],"version":3}